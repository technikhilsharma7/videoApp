var DyteClient=function(){var sE,oc,oe,Ms,Ns,$l,Ar,cc,dc,lc,us,uc,hc,qr,bn,pc,fc,mc,uf,Hl,WE,jl,JE,gc,xa,mr,gi,of,Et,Ls,_i,vi,Ti,Ei,Cn,_c,xs,Pn,yi,vc,Us,Ua,hu,Gl,zE,ql,YE,iE,qt,at,ye,An,Bs,nE,Kl,XE,Wl,QE,Tc,hf,de,Si,aE,Fs,oE,Ba,In,Fa,Ft,Ot,Dt,wi,Kr,Ri,Va,cE,ot,kn,Ec,On,zl,ZE,yc,pf,Re,bi,dE,Sc,Ci,Dn,wc,ff,Yl,ey,Xl,ty,Ql,ry,Rc,mf,Zl,sy,Mn,Vs,hs,ja,bc,me,Te,lE,Ga,Wr,ct,Pt,uE,qa,Ir,_s,Nn,hE,dt,Ln,Pi,yt,Nt,Ai,xn,pE,Rt,Un,ps,Cc,Bn,je,Qe,Pc,gf,eu,Ac,fE,Kt,Ii,Qt,Ka,Wa,Ja,Wt,dr,mE,ki,gE,Zt,le,Fn,Vt,Vn,$t,$s,zn,_E,Ic,_f,za,vE,kr,Ya,Xa,kc,vf,TE,Qa,pu,Hs,Za,eo,EE,Oc,Oi,to,Dc,Tf,yE,Di,po,$n,Mc,Nc,ru,ro,Mt,Lc,xc,Ef,SE,bt,Hn,wE,so,fu,jn,RE,Mi,Gn,qc,io,Ni,Li,te,Jr,qn,no,Ht,ao,oo,Uc,Bc,Fc,gr,Or,zr,fs,Kn,co,xi,Vc,Ui,js,Gs,$c,yf,Bi,Wn,ar,ms,gs,qs,ou,iy,Hc,Jn,lo,df,Ct,jc,cu,ny,bE;"use strict";var NV=Object.defineProperty;var LV=(N,P,ht)=>P in N?NV(N,P,{enumerable:!0,configurable:!0,writable:!0,value:ht}):N[P]=ht;var f=(N,P,ht)=>(LV(N,typeof P!="symbol"?P+"":P,ht),ht),lf=(N,P,ht)=>{if(!P.has(N))throw TypeError("Cannot "+ht)};var d=(N,P,ht)=>(lf(N,P,"read from private field"),ht?ht.call(N):P.get(N)),S=(N,P,ht)=>{if(P.has(N))throw TypeError("Cannot add the same private member more than once");P instanceof WeakSet?P.add(N):P.set(N,ht)},R=(N,P,ht,zs)=>(lf(N,P,"write to private field"),zs?zs.call(N,ht):P.set(N,ht),ht);var be=(N,P,ht)=>(lf(N,P,"access private method"),ht);var N;(function(r){r[r.MAJOR_EVENT=0]="MAJOR_EVENT",r[r.MINOR_EVENT=1]="MINOR_EVENT"})(N||(N={}));var P;(function(r){r.PRECALL_TEST_BEGIN="precall_begin",r.PRECALL_TEST_COMPLETE="precall_end",r.CALL_JOIN_BEGIN="call_join",r.NET_QUALITY_TEST_BEGIN="net_quality_test_begin",r.NET_QUALITY_TEST_END="net_quality_test_end",r.WEBSOCKET_CONNECTED="websocket_connected",r.TRANSPORT_CONNECTED="transport_connected",r.AUDIO_ON="audio_on",r.AUDIO_OFF="audio_off",r.VIDEO_ON="video_on",r.VIDEO_OFF="video_off",r.PARTICIPANT_ROLE="participant_role",r.PING_STAT="ping_stat",r.DISCONNECT="disconnect",r.RECONNECT_ATTEMPT="reconnect_attempt",r.SCREENSHARE_START_REQUESTED="screenshare_start_requested",r.SCREENSHARE_STARTED="screenshare_started",r.SCREENSHARE_STOPPED="screenshare_stopped",r.TAB_CHANGE="tab_change",r.BROWSER_BACKGROUNDED="browser_backgrounded",r.BROWSER_FOREGROUNDED="browser_foregrounded",r.DOMINANT_SPEAKER="dominant_speaker",r.AUDIO_DEVICES_UPDATES="audio_devices_updates",r.VIDEO_DEVICES_UPDATES="video_devices_updates",r.SPEAKER_DEVICES_UPDATES="speaker_devices_updates",r.SELECTED_MICROHPONE_UPDATE="selected_microphone_update",r.SELECTED_CAMERA_UPDATE="selected_camera_update",r.SELECTED_SPEAKER_UPDATE="selected_speaker_update",r.MEDIA_PERMISSION="camera_permission",r.LEGACY_SWITCH="legacy_switch",r.AUDIO_PLAY_FAILED="audio_play_failed",r.VIDEO_PLAY_FAILED="video_play_failed",r.AUDIO_TRACK_MUTED="audio_track_muted",r.VIDEO_TRACK_MUTED="video_track_muted",r.IVS_PLAYER_REBUFFERING="ivs_player_rebuffering",r.IVS_PLAYER_AUDIO_BLOCKED="ivs_player_audio_blocked",r.IVS_PLAYER_PLAYBACK_BLOCKED="ivs_player_playback_blocked",r.IVS_PLAYER_ERROR="ivs_player_error",r.IVS_PLAYER_RECOVERABLE_ERROR="ivs_player_recoverable_error",r.IVS_PLAYER_WORKER_ERROR="ivs_player_worker_error",r.IVS_PLAYER_NETWORK_UNAVAILABLE="ivs_player_network_unavailable",r.LIVESTREAM_LATENCY="livestream_latency",r.IVS_PLAYER_ANALYTICS_EVENT="ivs_player_analytics_event",r.IVS_PLAYER_PLAYBACK_RATE_CHANGED="ivs_player_playback_rate_changed",r.IVS_PLAYER_QUALITY_CHANGED="ivs_player_quality_changed",r.IVS_PLAYER_INITIALIZED="ivs_player_initialized"})(P||(P={}));const ht=new Map([[P.PRECALL_TEST_BEGIN,N.MINOR_EVENT],[P.PRECALL_TEST_COMPLETE,N.MINOR_EVENT],[P.CALL_JOIN_BEGIN,N.MAJOR_EVENT],[P.NET_QUALITY_TEST_BEGIN,N.MINOR_EVENT],[P.NET_QUALITY_TEST_END,N.MINOR_EVENT],[P.WEBSOCKET_CONNECTED,N.MINOR_EVENT],[P.TRANSPORT_CONNECTED,N.MAJOR_EVENT],[P.AUDIO_ON,N.MINOR_EVENT],[P.AUDIO_OFF,N.MINOR_EVENT],[P.VIDEO_ON,N.MINOR_EVENT],[P.VIDEO_OFF,N.MINOR_EVENT],[P.PARTICIPANT_ROLE,N.MINOR_EVENT],[P.PING_STAT,N.MAJOR_EVENT],[P.DISCONNECT,N.MAJOR_EVENT],[P.RECONNECT_ATTEMPT,N.MAJOR_EVENT],[P.SCREENSHARE_START_REQUESTED,N.MINOR_EVENT],[P.SCREENSHARE_STARTED,N.MINOR_EVENT],[P.SCREENSHARE_STOPPED,N.MINOR_EVENT],[P.TAB_CHANGE,N.MINOR_EVENT],[P.BROWSER_BACKGROUNDED,N.MINOR_EVENT],[P.BROWSER_FOREGROUNDED,N.MINOR_EVENT],[P.DOMINANT_SPEAKER,N.MINOR_EVENT],[P.AUDIO_DEVICES_UPDATES,N.MINOR_EVENT],[P.VIDEO_DEVICES_UPDATES,N.MINOR_EVENT],[P.SPEAKER_DEVICES_UPDATES,N.MINOR_EVENT],[P.SELECTED_MICROHPONE_UPDATE,N.MINOR_EVENT],[P.SELECTED_CAMERA_UPDATE,N.MINOR_EVENT],[P.SELECTED_SPEAKER_UPDATE,N.MINOR_EVENT],[P.MEDIA_PERMISSION,N.MINOR_EVENT],[P.LEGACY_SWITCH,N.MINOR_EVENT],[P.AUDIO_PLAY_FAILED,N.MINOR_EVENT],[P.VIDEO_PLAY_FAILED,N.MINOR_EVENT],[P.AUDIO_TRACK_MUTED,N.MINOR_EVENT],[P.VIDEO_TRACK_MUTED,N.MINOR_EVENT],[P.IVS_PLAYER_REBUFFERING,N.MAJOR_EVENT],[P.IVS_PLAYER_AUDIO_BLOCKED,N.MAJOR_EVENT],[P.IVS_PLAYER_PLAYBACK_BLOCKED,N.MAJOR_EVENT],[P.IVS_PLAYER_ERROR,N.MAJOR_EVENT],[P.IVS_PLAYER_RECOVERABLE_ERROR,N.MAJOR_EVENT],[P.IVS_PLAYER_WORKER_ERROR,N.MAJOR_EVENT],[P.IVS_PLAYER_NETWORK_UNAVAILABLE,N.MAJOR_EVENT],[P.LIVESTREAM_LATENCY,N.MAJOR_EVENT],[P.IVS_PLAYER_ANALYTICS_EVENT,N.MINOR_EVENT],[P.IVS_PLAYER_PLAYBACK_RATE_CHANGED,N.MINOR_EVENT],[P.IVS_PLAYER_QUALITY_CHANGED,N.MINOR_EVENT],[P.IVS_PLAYER_INITIALIZED,N.MINOR_EVENT]]);var zs=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function ay(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Jt={},oy={get exports(){return Jt},set exports(r){Jt=r}},Yn=typeof Reflect=="object"?Reflect:null,Sf=Yn&&typeof Yn.apply=="function"?Yn.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},Kc;Yn&&typeof Yn.ownKeys=="function"?Kc=Yn.ownKeys:Object.getOwnPropertySymbols?Kc=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Kc=function(e){return Object.getOwnPropertyNames(e)};function cy(r){console&&console.warn&&console.warn(r)}var wf=Number.isNaN||function(e){return e!==e};function ke(){ke.init.call(this)}oy.exports=ke,Jt.once=hy,ke.EventEmitter=ke,ke.prototype._events=void 0,ke.prototype._eventsCount=0,ke.prototype._maxListeners=void 0;var Rf=10;function Wc(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(ke,"defaultMaxListeners",{enumerable:!0,get:function(){return Rf},set:function(r){if(typeof r!="number"||r<0||wf(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Rf=r}}),ke.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},ke.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||wf(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function bf(r){return r._maxListeners===void 0?ke.defaultMaxListeners:r._maxListeners}ke.prototype.getMaxListeners=function(){return bf(this)},ke.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=n[e];if(c===void 0)return!1;if(typeof c=="function")Sf(c,this,t);else for(var l=c.length,u=kf(c,l),s=0;s<l;++s)Sf(u[s],this,t);return!0};function Cf(r,e,t,s){var i,n,a;if(Wc(t),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),n=r._events),a=n[e]),a===void 0)a=n[e]=t,++r._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),i=bf(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=a.length,cy(o)}return r}ke.prototype.addListener=function(e,t){return Cf(this,e,t,!1)},ke.prototype.on=ke.prototype.addListener,ke.prototype.prependListener=function(e,t){return Cf(this,e,t,!0)};function dy(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Pf(r,e,t){var s={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=dy.bind(s);return i.listener=t,s.wrapFn=i,i}ke.prototype.once=function(e,t){return Wc(t),this.on(e,Pf(this,e,t)),this},ke.prototype.prependOnceListener=function(e,t){return Wc(t),this.prependListener(e,Pf(this,e,t)),this},ke.prototype.removeListener=function(e,t){var s,i,n,a,o;if(Wc(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,n=a;break}if(n<0)return this;n===0?s.shift():ly(s,n),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this},ke.prototype.off=ke.prototype.removeListener,ke.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var n=Object.keys(s),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Af(r,e,t){var s=r._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?uy(i):kf(i,i.length)}ke.prototype.listeners=function(e){return Af(this,e,!0)},ke.prototype.rawListeners=function(e){return Af(this,e,!1)},ke.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):If.call(r,e)},ke.prototype.listenerCount=If;function If(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}ke.prototype.eventNames=function(){return this._eventsCount>0?Kc(this._events):[]};function kf(r,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=r[s];return t}function ly(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function uy(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function hy(r,e){return new Promise(function(t,s){function i(a){r.removeListener(e,n),s(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}Of(r,e,n,{once:!0}),e!=="error"&&py(r,i,{once:!0})})}function py(r,e,t){typeof r.on=="function"&&Of(r,"error",e,t)}function Of(r,e,t,s){if(typeof r.on=="function")s.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(n){s.once&&r.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var Df;(function(r){r.CHROMIUM="chromum",r.FIREFOX="firefox",r.SAFARI="safari"})(Df||(Df={}));var fo;(function(r){r.DEV="dev",r.STAGING="staging",r.PRODUCTION="production"})(fo||(fo={}));var vr;(function(r){r.AUDIO="AUDIO",r.VIDEO="VIDEO",r.SPEAKER="SPEAKER"})(vr||(vr={}));var Ys;(function(r){r[r.INIT=0]="INIT",r[r.ACCEPTED=1]="ACCEPTED",r[r.DENIED=2]="DENIED",r[r.SYS_DENIED=3]="SYS_DENIED",r[r.FAILED=4]="FAILED",r[r.NOTFOUND=5]="NOTFOUND",r[r.NOT_APPLICABLE=6]="NOT_APPLICABLE"})(Ys||(Ys={}));class fy{constructor(){f(this,"events");this.events=[]}add(e){this.events.push(e)}flush(){return{entries:this.events.splice(0,25)}}}class my extends Jt{constructor({logger:t,peerId:s,env:i}){super();f(this,"logger");f(this,"peerId");f(this,"eventStore");f(this,"apiEndpoint");this.logger=t,this.peerId=s,i===fo.PRODUCTION?this.apiEndpoint="https://collector.prod.da.dyte.io/api/v1/message":this.apiEndpoint="https://collector.non-prod.da.dyte.io/api/v1/message",this.eventStore=new fy}async sendEventsChunkToServer(t){var i;const s={payload:t,peerId:this.peerId};try{return await fetch(this.apiEndpoint,{method:"POST",body:JSON.stringify(s)}),!0}catch(n){return this.logger.error("callStats::sendEventsChunkToServer::catch",{error:n}),(i=t.entries)==null||i.forEach(a=>{this.eventStore.add(a)}),!1}}callEvent(t){t.timestamp=new Date,this.eventStore.add(t),this.emit(t.event,t.metaData),ht.get(t.event)===N.MAJOR_EVENT&&this.flush()}async flush(){var s;const t=this.eventStore.flush();return(s=t==null?void 0:t.entries)!=null&&s.length?(await this.sendEventsChunkToServer(t),!0):!1}}class vs{constructor(e){f(this,"pc1");f(this,"pc2");f(this,"constrainVideoBitrateKbps");f(this,"constrainOfferToRemoveVideoFec",!1);f(this,"iceCandidateFilter");const t=new RTCPeerConnection(e),s=new RTCPeerConnection(e);this.pc1=t,this.pc2=s,this.iceCandidateFilter=vs.noFilter,this.pc1.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc2)),this.pc2.addEventListener("icecandidate",this.onIceCandidate.bind(this,this.pc1))}static parseCandidate(e){const t="candidate:",s=e.indexOf(t)+t.length,i=e.substr(s).split(" ");return{type:i[7],protocol:i[2],address:i[4]}}static isNotHostCandidate(e){return e.type!=="host"}static isHost(e){return e.type==="host"}static isRelay(e){return e.type==="relay"}static isReflexive(e){return e.type==="srflx"}static noFilter(e){return!0}onIceCandidate(e,t){if(t.candidate){const s=vs.parseCandidate(t.candidate.candidate);this.iceCandidateFilter(s)&&e.addIceCandidate(t.candidate)}}setIceCandidateFilter(e){this.iceCandidateFilter=e}constrainVideoBitrate(e){this.constrainVideoBitrateKbps=e}disableVideoFec(){this.constrainOfferToRemoveVideoFec=!0}gotOffer(e){this.constrainOfferToRemoveVideoFec&&(e.sdp=e.sdp.replace(/(m=video 1 [^\r]+)(116 117)(\r\n)/g,`$1\r
`),e.sdp=e.sdp.replace(/a=rtpmap:116 red\/90000\r\n/g,""),e.sdp=e.sdp.replace(/a=rtpmap:117 ulpfec\/90000\r\n/g,""),e.sdp=e.sdp.replace(/a=rtpmap:98 rtx\/90000\r\n/g,""),e.sdp=e.sdp.replace(/a=fmtp:98 apt=116\r\n/g,"")),this.pc1.setLocalDescription(e),this.pc2.setRemoteDescription(e),this.pc2.createAnswer().then(this.gotAnswer.bind(this),this.reportFatal.bind(this))}gotAnswer(e){this.constrainVideoBitrateKbps&&(e.sdp=e.sdp.replace(/a=mid:video\r\n/g,`a=mid:video\r
b=AS:${this.constrainVideoBitrateKbps}\r
`)),this.pc2.setLocalDescription(e),this.pc1.setRemoteDescription(e)}establishConnection(){this.pc1.createOffer().then(this.gotOffer.bind(this),this.reportFatal.bind(this))}reportFatal(e){console.error("Error:",e)}async getRoundTripTime(){const[e,t]=await Promise.all([this.pc1.getStats(),this.pc2.getStats()]);let s,i;if(e.forEach(n=>{n.type==="candidate-pair"&&n.nominated===!0&&n.bytesSent>0&&(s=n)}),t.forEach(n=>{n.type==="candidate-pair"&&n.nominated===!0&&n.bytesReceived>0&&(i=n)}),s&&i)try{if(s.currentRoundTripTime&&i.currentRoundTripTime)return{rtt:s.currentRoundTripTime,backendRTT:i.currentRoundTripTime};const n=(i.lastPacketReceivedTimestamp-s.lastPacketSentTimestamp)/1e3;return{rtt:n,backendRTT:n}}catch(n){return}}close(){this.pc1.close(),this.pc2.close()}}class Mf extends Jt{constructor(t){super();f(this,"call");f(this,"timeOut");this.call=new vs(t)}start(t=1e4){this.call.establishConnection(),this.timeOut=setTimeout(this.testFailed.bind(this),t)}testComplete(t){clearTimeout(this.timeOut),this.call.close(),this.emit("done",t)}testFailed(t){console.warn("Test failed, ",t),this.call.close(),this.emit("failed",t)}}const gy=8,_y=1/1e3;class vy extends Mf{constructor(t){super(t);f(this,"senderChannel");f(this,"recieveChannel");f(this,"startTime");f(this,"lastBitrateMeasureTime");f(this,"sentPayloadBytes",0);f(this,"recievedPayloadBytes",0);f(this,"lastReceivedPayloadBytes",0);f(this,"stopSending",!1);f(this,"testProgress",0);f(this,"samplePacket","");f(this,"finalBitrateSum",0);f(this,"bitRateSampels",0);f(this,"maxNumberOfPacketsToSend",0);f(this,"bytesToKeepBuffered",0);f(this,"testDurationSeconds",5);this.call.setIceCandidateFilter(vs.isNotHostCandidate),this.senderChannel=this.call.pc1.createDataChannel(null);for(let s=0;s<262144;s+=1)this.samplePacket+="h";this.maxNumberOfPacketsToSend=1,this.bytesToKeepBuffered=1024*this.maxNumberOfPacketsToSend,this.testDurationSeconds=4,this.senderChannel.addEventListener("open",this.sendingStep.bind(this)),this.call.pc2.addEventListener("datachannel",this.onRecieverChannel.bind(this))}sendingStep(){const t=new Date;this.startTime||(this.startTime=t,this.lastBitrateMeasureTime=t);for(let i=0;i!==this.maxNumberOfPacketsToSend&&!(this.senderChannel.bufferedAmount>=this.bytesToKeepBuffered);i+=1){this.sentPayloadBytes+=this.samplePacket.length;try{this.senderChannel.send(this.samplePacket)}catch(n){}}const s=t.getTime()-this.startTime.getTime();s>=1e3*this.testDurationSeconds?(this.stopSending=!0,this.testProgress=100):(this.testProgress=s/(10*this.testDurationSeconds),setTimeout(this.sendingStep.bind(this),1))}onMessageRecieved(t){this.recievedPayloadBytes+=t.data.length;const s=new Date,i=s.getTime()-this.lastBitrateMeasureTime.getTime();if(i>=1e3){const a=(this.recievedPayloadBytes-this.lastReceivedPayloadBytes)*gy/(i/1e3);this.finalBitrateSum+=a,this.bitRateSampels+=1,this.lastReceivedPayloadBytes=this.recievedPayloadBytes,this.lastBitrateMeasureTime=s}if(this.stopSending&&this.sentPayloadBytes===this.recievedPayloadBytes){const n=this.finalBitrateSum/this.bitRateSampels;this.testComplete({throughput:Math.round(n*_y)})}}testComplete(t){this.call.getRoundTripTime().then(({rtt:s,backendRTT:i})=>super.testComplete({RTT:s,backendRTT:i,throughput:t.throughput}))}onRecieverChannel(t){this.recieveChannel=t.channel,this.recieveChannel.addEventListener("message",this.onMessageRecieved.bind(this))}}class mu extends Mf{constructor(t,s=vs.noFilter){super(t);f(this,"ch1");f(this,"ch2");this.call.setIceCandidateFilter(s);const i=this.call.pc1.createDataChannel(null);this.ch1=i,i.addEventListener("open",()=>{i.send("hello")}),i.addEventListener("message",this.onCh1Recieve.bind(this)),this.call.pc2.addEventListener("datachannel",this.dataChannelHandler.bind(this))}onCh1Recieve(t){t.data!=="world"?this.hangup("Invalid data transmitted."):this.testComplete({connectivity:!0})}onCh2Recieve(t){if(t.data!=="hello")this.hangup("Invalid data transmitted.");else try{this.ch2.send("world")}catch(s){}}dataChannelHandler(t){const s=t.channel;this.ch2=s,s.addEventListener("message",this.onCh2Recieve.bind(this))}hangup(t){this.testFailed(t)}}class Ty extends mu{constructor(e){super(e,vs.isHost)}}class Ey extends mu{constructor(e){super(e,vs.isRelay)}}class yy extends mu{constructor(e){super(e,vs.isReflexive)}}class Sy{constructor(){f(this,"ipInformation",null)}async getIPDetails({peerId:e}){var t;if(!this.ipInformation){try{const n=await(await fetch("https://media-location.dyte.io")).json();if(((t=n.loc)==null?void 0:t.length)>5)return this.ipInformation=n,n;throw Error("Insufficient data")}catch(i){}const s=await fetch(`https://location-service.dyte.io/?token=3c493932b0624c&peerId=${e}`,{method:"POST"});this.ipInformation=await s.json()}return this.ipInformation}}const gu=new Sy,Nf=[{urls:"turn:turn.dyte.in:443?transport=tcp",username:"dyte",credential:"dytein",credentialType:"password"},{urls:"turn:turn.dyte.in:3478?transport=udp",username:"dyte",credential:"dytein",credentialType:"password"}];function wy(r){const[e,t]=r.split(",");return{coords:{latitude:Number(e),longitude:Number(t)}}}class Lf{constructor(){f(this,"transport");f(this,"candidatePair");f(this,"outboundVideoRtp",new Map);f(this,"inboundVideoRtp",new Map);f(this,"outboundAudioRtp",new Map);f(this,"inboundAudioRtp",new Map);f(this,"remoteInboundRtp",new Map);f(this,"producerStreamMap",new Map);f(this,"consumerStreamMap",new Map);f(this,"staleProducerStreamMap",!1);f(this,"staleConsumerStreamMap",!1)}}class xf{constructor(){f(this,"outboundProducerMap",new Map);f(this,"inboundConsumerMap",new Map);f(this,"consumerPeerIdMap",new Map);f(this,"overallProducingTransportsStatsMap",{});f(this,"overallConsumingTransportsStatsMap",{});f(this,"overallConsumersStatsMap",{});f(this,"overallProducersStatsMap",{});f(this,"consumerIdsWithFreezedVideo",new Set);f(this,"consumerIdsWithFreezedAudio",new Set);f(this,"producerIdsWithFreezedVideo",new Set);f(this,"producerIdsWithFreezedAudio",new Set);f(this,"freezedProducingTransportIds",new Set);f(this,"freezedConsumingTransportIds",new Set);f(this,"ipDetails");f(this,"callStatsInstance")}async registerProducer(e){await this.generateProducerStreamMap(e),e.observer.on("close",this.deregisterProducer.bind(this,e))}processInboundConsumerVideoStats(e,t,s){var n,a;const i=((a=(n=this==null?void 0:this.callStatsInstance)==null?void 0:n.consumerSharedMediaStatesMap)==null?void 0:a.get(e))||{};t.totalVideoPacketsReceived===s.packetsReceived?(this.consumerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","pause",e))):(t.totalVideoPacketsReceived=s.packetsReceived,this.consumerIdsWithFreezedVideo.has(e)&&(this.consumerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callstats::measurements::consumerVideoDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_video_status","resume",e))))}processInboundConsumerAudioStats(e,t,s){var n,a;const i=((a=(n=this==null?void 0:this.callStatsInstance)==null?void 0:n.consumerSharedMediaStatesMap)==null?void 0:a.get(e))||{};t.totalAudioPacketsReceived===s.packetsReceived?(this.consumerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioFreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","pause",e))):(t.totalAudioPacketsReceived=s.packetsReceived,this.consumerIdsWithFreezedAudio.has(e)&&(this.consumerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::consumerAudioDefreezed",{consumerId:e}),this.callStatsInstance.eventHandler.emit("consumer_audio_status","resume",e))))}processOutboundProducerVideoStats(e,t,s){var n;const i=((n=this==null?void 0:this.callStatsInstance)==null?void 0:n.currentUserMediaStates)||{};t.totalVideoPacketsSent===s.packetsSent?(this.producerIdsWithFreezedVideo.add(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","pause",e))):(t.totalVideoPacketsSent=s.packetsSent,this.producerIdsWithFreezedVideo.has(e)&&(this.producerIdsWithFreezedVideo.delete(e),this.callStatsInstance&&i.video&&(this.callStatsInstance.logger.debug("callStats::measurements::producerVideoDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_video_status","resume",e))))}processOutboundProducerAudioStats(e,t,s){var n;const i=((n=this==null?void 0:this.callStatsInstance)==null?void 0:n.currentUserMediaStates)||{};t.totalAudioPacketsSent===s.packetsSent?(this.producerIdsWithFreezedAudio.add(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioFreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","pause",e))):(t.totalAudioPacketsSent=s.packetsSent,this.producerIdsWithFreezedAudio.has(e)&&(this.producerIdsWithFreezedAudio.delete(e),this.callStatsInstance&&i.audio&&(this.callStatsInstance.logger.debug("callStats::measurements::producerAudioDefreezed",{producerId:e}),this.callStatsInstance.eventHandler.emit("producer_audio_status","resume",e))))}processProducingTransportStats(e,t,s){var l;const i=((l=this==null?void 0:this.callStatsInstance)==null?void 0:l.currentUserMediaStates)||{},{audio:n,video:a,screen:o}=i,c=n||a||o;t.totalPacketsSent===s.packetsSent?(this.freezedProducingTransportIds.add(e),this.callStatsInstance&&c&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","pause",e))):(t.totalPacketsSent=s.packetsSent,this.freezedProducingTransportIds.has(e)&&(this.freezedProducingTransportIds.delete(e),this.callStatsInstance&&c&&(this.callStatsInstance.logger.debug("callStats::measurements::producingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("producing_transport_status","resume",e))))}processConsumingTransportStats(e,t,s){var a,o;const n=!!Array.from(((o=(a=this==null?void 0:this.callStatsInstance)==null?void 0:a.consumerSharedMediaStatesMap)==null?void 0:o.values())||[]).reduce((c,l)=>c||l.audio||l.video||l.screen,!1);t.totalPacketsReceived===s.packetsSent?(this.freezedConsumingTransportIds.add(e),this.callStatsInstance&&n&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportFreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","pause",e))):(t.totalPacketsReceived=s.packetsSent,this.freezedConsumingTransportIds.has(e)&&(this.freezedConsumingTransportIds.delete(e),this.callStatsInstance&&n&&(this.callStatsInstance.logger.debug("callStats::measurements::consumingTransportDefreezed",{transportId:e}),this.callStatsInstance.eventHandler.emit("consuming_transport_status","resume",e))))}async registerConsumer(e){await this.generateConsumerStreamMap(e),this.consumerPeerIdMap.set(e.id,{producerId:e.producerId,peerId:e.appData.peerId,appData:e.appData}),e.observer.on("close",this.deregisterConsumer.bind(this,e))}async generateProducerStreamMap(e,t=!1){const s=await e.getStats(),i=t?this.getProducerStatsFromReport(this.parseRTCReport(s,["outbound-rtp","remote-inbound-rtp"],!1,e.id))[0]:void 0;for(const n of s.values())switch(n.type){case"outbound-rtp":{this.outboundProducerMap.set(n.id,e.id);break}}return i}async generateConsumerStreamMap(e,t=!1){const s=await e.getStats(),i=t?this.getConsumerStatsFromReport(this.parseRTCReport(s,["inbound-rtp"],!1,e.id))[0]:void 0;for(const n of s.values())switch(n.type){case"inbound-rtp":{this.inboundConsumerMap.set(n.id,e.id);break}}return i}deregisterProducer(e){this.outboundProducerMap.forEach((t,s)=>{t===e.id&&this.outboundProducerMap.delete(s)})}deregisterConsumer(e){this.inboundConsumerMap.forEach((t,s)=>{t===e.id&&this.inboundConsumerMap.delete(s)}),this.consumerPeerIdMap.delete(e.id)}parseRTCReport(e,t=[],s=!1,i=void 0,n=void 0){const a=e,o=new Lf,c=t.length?new Set(t):void 0;for(const l of a.values()){if(c){if(c.size===0)break;if(c.has(l.type))s&&c.delete(l.type);else continue}switch(l.type){case"candidate-pair":{if(l.nominated===!0||l.selected===!0){const u=l,h={bytesReceived:u.bytesReceived,bytesSent:u.bytesSent,currentRoundTripTime:u.currentRoundTripTime,totalRoundTripTime:u.totalRoundTripTime,availableOutgoingBitrate:u.availableOutgoingBitrate};o.candidatePair=h;break}break}case"transport":{const u=l;n&&(n.producing&&(this.overallProducingTransportsStatsMap[n.id]||(this.overallProducingTransportsStatsMap[n.id]={totalPacketsSent:0})),n.consuming&&(this.overallConsumingTransportsStatsMap[n.id]||(this.overallConsumingTransportsStatsMap[n.id]={totalPacketsReceived:0})));const h={bytesReceived:u.bytesReceived,bytesSent:u.bytesSent,packetsSent:u.packetsSent,packetsReceived:u.packetsReceived,dtlsCipher:u.dtlsCipher,dtlsState:u.dtlsState,iceRole:u.iceRole};if(o.transport=h,n){if(n.producing){const p=this.overallProducingTransportsStatsMap[n.id];this.processProducingTransportStats(n.id,p,h)}if(n.consuming){const p=this.overallConsumingTransportsStatsMap[n.id];this.processConsumingTransportStats(n.id,p,h)}}break}case"remote-inbound-rtp":{const u=l,h={jitter:u.jitter,fractionLost:u.fractionLost,roundTripTime:u.roundTripTime,roundTripTimeMeasurements:u.roundTripTimeMeasurements,totalRoundTripTime:u.totalRoundTripTime,packetsLost:u.packetsLost};o.remoteInboundRtp.set(u.localId,h);break}case"outbound-rtp":{const u=l,h=i||this.outboundProducerMap.get(l.id);this.overallProducersStatsMap[h]||(this.overallProducersStatsMap[h]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const p=this.overallProducersStatsMap[h];if(["video","audio"].includes(u.mediaType)){if(!this.outboundProducerMap.has(l.id)){o.staleProducerStreamMap=!0,c&&c.delete("outbound-rtp");break}o.producerStreamMap.has(h)||o.producerStreamMap.set(h,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const m={bytesSent:u.bytesSent,packetsSent:u.packetsSent,nackCount:u.nackCount};if(u.mediaType==="video"){if(u.decoderImplementation==="unknown")break;const v=u,y={frameHeight:v.frameHeight,frameWidth:v.frameWidth,framesEncoded:v.framesEncoded,framesDropped:v.framesDropped,framesPerSecond:v.framesPerSecond,framesSent:v.framesSent,keyFramesEncoded:v.keyFramesEncoded,firCount:v.firCount,encoderImplementation:v.encoderImplementation,hugeFramesSent:v.hugeFramesSent,pliCount:v.pliCount,qpSum:v.qpSum,qualityLimitationDurations:v.qualityLimitationDurations,qualityLimitationReason:v.qualityLimitationReason,qualityLimitationResolutionChanges:v.qualityLimitationResolutionChanges,totalEncodeTime:v.targetBitrate,totalPacketSendDelay:v.totalPacketSendDelay,retransmittedBytesSent:v.retransmittedBytesSent,retransmittedPacketsSent:v.retransmittedPacketsSent,...m};o.outboundVideoRtp.set(l.id,y),o.producerStreamMap.get(h).outboundVideoRtpId.push(l.id),this.processOutboundProducerVideoStats(h,p,y)}else if(u.mediaType==="audio"){const v=u,y={retransmittedBytesSent:v.retransmittedBytesSent,retransmittedPacketsSent:v.retransmittedPacketsSent,...m};o.outboundAudioRtp.set(l.id,y),o.producerStreamMap.get(h).outboundAudioRtpId.push(l.id),this.processOutboundProducerAudioStats(h,p,y)}}break}case"inbound-rtp":{const u=l,h=i||this.inboundConsumerMap.get(l.id);if(u.ssrc===1234)break;this.overallConsumersStatsMap[h]||(this.overallConsumersStatsMap[h]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const p=this.overallConsumersStatsMap[h];if(["video","audio"].includes(u.mediaType)){if(!this.inboundConsumerMap.has(l.id)){o.staleConsumerStreamMap=!0,c&&c.delete("inbound-rtp");break}o.consumerStreamMap.has(h)||o.consumerStreamMap.set(h,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const m={bytesReceived:u.bytesReceived,packetsReceived:u.packetsReceived,packetsLost:u.packetsLost,jitter:u.jitter,nackCount:u.nackCount};if(u.mediaType==="video"){if(u.decoderImplementation==="unknown")break;const v=u,y={frameHeight:v.frameHeight,frameWidth:v.frameWidth,framesDecoded:v.framesDecoded,framesDropped:v.framesDropped,framesPerSecond:v.framesPerSecond,framesReceived:v.framesReceived,keyFramesDecoded:v.keyFramesDecoded,firCount:v.firCount,decoderImplementation:v.decoderImplementation,...m};o.inboundVideoRtp.set(l.id,y),o.consumerStreamMap.get(h).inboundVideoRtpId.push(l.id),this.processInboundConsumerVideoStats(h,p,y)}else if(u.mediaType==="audio"){const v=u,y={audioLevel:v.audioLevel,concealedSampels:v.concealedSampels,concealmentEvents:v.concealmentEvents,jitterBufferDelay:v.jitterBufferDelay,jitterBufferEmittedCount:v.jitterBufferEmittedCount,totalAudioEnergy:v.totalAudioEnergy,totalSamplesDuration:v.totalSamplesDuration,totalSamplesReceived:v.totalSamplesReceived,...m};o.inboundAudioRtp.set(l.id,y),o.consumerStreamMap.get(h).inboundAudioRtpId.push(l.id),this.processInboundConsumerAudioStats(h,p,y)}}break}}}if(o.outboundVideoRtp.forEach((l,u)=>{l.remoteData=o.remoteInboundRtp.get(u)}),o.outboundAudioRtp.forEach((l,u)=>{l.remoteData=o.remoteInboundRtp.get(u)}),o.candidatePair&&(o.transport?(o.transport.totalRoundTripTime=o.candidatePair.totalRoundTripTime,o.transport.availableOutgoingBitrate=o.candidatePair.availableOutgoingBitrate,o.transport.roundTripTime=o.candidatePair.currentRoundTripTime):o.transport={bytesReceived:o.candidatePair.bytesReceived,bytesSent:o.candidatePair.bytesSent,totalRoundTripTime:o.candidatePair.totalRoundTripTime,availableOutgoingBitrate:o.candidatePair.availableOutgoingBitrate,roundTripTime:o.candidatePair.currentRoundTripTime}),o.transport&&!o.transport.roundTripTime){let l=0,u=0;o.remoteInboundRtp.forEach((h,p)=>{h.roundTripTime&&h.roundTripTime>l&&(l=h.roundTripTime,u=h.totalRoundTripTime)}),o.transport.roundTripTime=l,o.transport.totalRoundTripTime=u}return o}async getProducersReport(e){const t=e.map(s=>this.generateProducerStreamMap(s,!0));return t.length>0?Promise.all(t):void 0}async getConsumersReport(e){const t=e.map(s=>this.generateConsumerStreamMap(s,!0));return t.length>0?Promise.all(t):void 0}async getTransportReport(e){return e.getStats()}async getProcessedStats(e,t,s){const i=await this.getTransportReport(e),n={producing:s,consuming:t,id:e.id},a=i,o=this.parseRTCReport(a,["transport","candidate-pair","inbound-rtp","outbound-rtp","remote-inbound-rtp"],!1,void 0,n);if(!o)return;const c={stats:o.transport,transportId:e.id,consuming:t,producing:s},l=o.staleProducerStreamMap?void 0:this.getProducerStatsFromReport(o),u=o.staleConsumerStreamMap?void 0:this.getConsumerStatsFromReport(o);return{transportReport:c,producerReport:l,consumerReport:u}}getProducerStatsFromReport(e){const t=[];try{e.producerStreamMap.forEach((s,i)=>{var n,a;t.push({producerId:i,videoStats:s.outboundVideoRtpId.map(o=>e.outboundVideoRtp.get(o)),audioStats:s.outboundAudioRtpId.map(o=>e.outboundAudioRtp.get(o)),appData:((a=(n=this.callStatsInstance.producers)==null?void 0:n.get(i))==null?void 0:a.appData)||null})})}catch(s){this.callStatsInstance.logger.error("callStats::measurements::getProducerStatsFromReport",{error:{reason:s.reason,message:s.message}})}return t}getConsumerStatsFromReport(e){const t=[];try{e.consumerStreamMap.forEach((s,i)=>{const{peerId:n,producerId:a,appData:o}=this.consumerPeerIdMap.get(i);t.push({consumerId:i,peerId:n,producerId:a,appData:o,videoStats:s.inboundVideoRtpId.map(c=>e.inboundVideoRtp.get(c)),audioStats:s.inboundAudioRtpId.map(c=>e.inboundAudioRtp.get(c))})})}catch(s){console.error("getConsumersReport: ",s,e)}return t}async getUserLocation(){return new Promise((t,s)=>{try{navigator.geolocation?navigator.geolocation.getCurrentPosition(i=>{t(i)}):s()}catch(i){s(i)}})}async getConnectivity(e){try{const t={iceServers:e||Nf},s=new Promise((l,u)=>{try{const h=new Ty(t);h.addListener("done",l),h.addListener("failed",()=>{l({connectivity:!1})}),h.start(2e3)}catch(h){u(h)}}),i=new Promise((l,u)=>{try{const h=new Ey(t);h.addListener("done",l),h.addListener("failed",()=>{l({connectivity:!1})}),h.start(2e3)}catch(h){u(h)}}),n=new Promise((l,u)=>{try{const h=new yy(t);h.addListener("done",l),h.addListener("failed",()=>{l({connectivity:!1})}),h.start(2e3)}catch(h){u(h)}}),[a,o,c]=await Promise.all([s,i,n]);return{host:a==null?void 0:a.connectivity,relay:o==null?void 0:o.connectivity,reflexive:c==null?void 0:c.connectivity}}catch(t){return{host:!1,relay:!1,reflexive:!1}}}async getThroughput(e){try{const s=await new Promise((i,n)=>{try{const a={iceServers:e||Nf},o=new vy(a);o.addListener("done",i),o.addListener("failed",n),o.start(1e4)}catch(a){n(a)}});return{throughput:s.throughput,fractionalLoss:0,RTT:s.RTT,jitter:0,backendRTT:s.backendRTT}}catch(t){return}}async getIPDetails(){var e;try{return this.ipDetails||(this.ipDetails=await gu.getIPDetails({peerId:(e=this.callStatsInstance)==null?void 0:e.peerId})),this.ipDetails}catch(t){return}}async getNetworkQuality(e){const[t,s]=await Promise.all([this.getConnectivity(e),this.getThroughput(e)]);return{connectivity:t,throughput:s==null?void 0:s.throughput,fractionalLoss:s==null?void 0:s.fractionalLoss,RTT:s==null?void 0:s.RTT,jitter:s==null?void 0:s.jitter,backendRTT:s==null?void 0:s.backendRTT}}async getNetworkInfo(e){var a;const[t,s,i]=await Promise.all([this.getConnectivity(e),this.getThroughput(e),this.getIPDetails()]);return{ipDetails:i,effectiveNetworkType:(a=navigator.connection)==null?void 0:a.effectiveType,location:i.loc?wy(i.loc):void 0,turnConnectivity:t?t.host||t.relay||t.reflexive:!1,connectivity:t,throughput:s==null?void 0:s.throughput,fractionalLoss:s==null?void 0:s.fractionalLoss,RTT:s==null?void 0:s.RTT,jitter:s==null?void 0:s.jitter,backendRTT:s==null?void 0:s.backendRTT}}}class Ry extends xf{}class Uf extends xf{constructor(){super(...arguments);f(this,"producerMap",new Map);f(this,"consumerMap",new Map)}async registerProducer(t){this.producerMap.set(t.id,t),await this.generateProducerStreamMap(t),t.observer.on("close",this.deregisterProducer.bind(this,t))}async registerConsumer(t){this.consumerMap.set(t.id,t),await this.generateConsumerStreamMap(t),this.consumerPeerIdMap.set(t.id,{producerId:t.producerId,peerId:t.appData.peerId,appData:t.appData}),t.observer.on("close",this.deregisterConsumer.bind(this,t))}async generateConsumerStreamMap(t,s=!1){const i=await t.getStats(),n=this.parseRTCReport(i,["inbound-rtp"],!1,t.id),a=[...n.consumerStreamMap.values()][0],o=s?this.getConsumerStatsFromParsedConsumerStats(n,a,t.id):void 0;for(const c of i.values())switch(c.type){case"inbound-rtp":{this.inboundConsumerMap.set(c.id,t.id);break}}return o}deregisterProducer(t){this.producerMap.delete(t.id),this.outboundProducerMap.forEach((s,i)=>{s===t.id&&this.outboundProducerMap.delete(i)})}deregisterConsumer(t){this.consumerMap.delete(t.id),this.inboundConsumerMap.forEach((s,i)=>{s===t.id&&this.inboundConsumerMap.delete(i)}),this.consumerPeerIdMap.delete(t.id)}parseRTCReport(t,s=[],i=!1,n=void 0,a=void 0){const o=t,c=new Lf,l=s.length?new Set(s):void 0;for(const u of o.values()){if(l){if(l.size===0)break;if(l.has(u.type))i&&l.delete(u.type);else continue}switch(u.type){case"candidate-pair":{if(u.nominated===!0||u.selected===!0){const h=u,p={bytesReceived:h.bytesReceived,bytesSent:h.bytesSent,currentRoundTripTime:h.currentRoundTripTime,totalRoundTripTime:h.totalRoundTripTime,availableOutgoingBitrate:h.availableOutgoingBitrate};c.candidatePair=p;break}break}case"transport":{const h=u;a&&(a.producing&&(this.overallProducingTransportsStatsMap[a.id]||(this.overallProducingTransportsStatsMap[a.id]={totalPacketsSent:0})),a.consuming&&(this.overallConsumingTransportsStatsMap[a.id]||(this.overallConsumingTransportsStatsMap[a.id]={totalPacketsReceived:0})));const p={bytesReceived:h.bytesReceived,bytesSent:h.bytesSent,packetsSent:h.packetsSent,packetsReceived:h.packetsReceived,dtlsCipher:h.dtlsCipher,dtlsState:h.dtlsState,iceRole:h.iceRole};if(c.transport=p,a){if(a.producing){const m=this.overallProducingTransportsStatsMap[a.id];this.processProducingTransportStats(a.id,m,p)}if(a.consuming){const m=this.overallConsumingTransportsStatsMap[a.id];this.processConsumingTransportStats(a.id,m,p)}}break}case"remote-inbound-rtp":{const h=u,p={jitter:h.jitter,fractionLost:h.fractionLost,roundTripTime:h.roundTripTime,roundTripTimeMeasurements:h.roundTripTimeMeasurements,totalRoundTripTime:h.totalRoundTripTime,packetsLost:h.packetsLost};c.remoteInboundRtp.set(h.localId,p);break}case"outbound-rtp":{const h=u,p=n||this.outboundProducerMap.get(u.id);this.overallProducersStatsMap[p]||(this.overallProducersStatsMap[p]={totalVideoPacketsSent:0,totalAudioPacketsSent:0});const m=this.overallProducersStatsMap[p];if(["video","audio"].includes(h.mediaType)){if(!this.outboundProducerMap.has(u.id)){c.staleProducerStreamMap=!0,l&&l.delete("outbound-rtp");break}c.producerStreamMap.has(p)||c.producerStreamMap.set(p,{outboundVideoRtpId:[],outboundAudioRtpId:[]});const v={bytesSent:h.bytesSent,packetsSent:h.packetsSent,nackCount:h.nackCount};if(h.mediaType==="video"){if(h.decoderImplementation==="unknown")break;const y=h,C={frameHeight:y.frameHeight,frameWidth:y.frameWidth,framesEncoded:y.framesEncoded,framesDropped:y.framesDropped?y.framesDropped:y.droppedFrames,framesPerSecond:y.framesPerSecond?y.framesPerSecond:y.framerateMean,framesSent:y.framesSent,keyFramesEncoded:y.keyFramesEncoded,firCount:y.firCount,encoderImplementation:y.encoderImplementation,hugeFramesSent:y.hugeFramesSent,pliCount:y.pliCount,qpSum:y.qpSum,qualityLimitationReason:y.qualityLimitationReason,qualityLimitationDurations:y.qualityLimitationDurations,qualityLimitationResolutionChanges:y.qualityLimitationResolutionChanges,totalEncodeTime:y.totalEncodeTime,totalPacketSendDelay:y.totalEncodeTime,retransmittedBytesSent:y.retransmittedBytesSent,retransmittedPacketsSent:y.retransmittedPacketsSent,...v};c.outboundVideoRtp.set(u.id,C),c.producerStreamMap.get(p).outboundVideoRtpId.push(u.id),this.processOutboundProducerVideoStats(p,m,C)}else if(h.mediaType==="audio"){const y=h,C={retransmittedBytesSent:y.retransmittedBytesSent,retransmittedPacketsSent:y.retransmittedPacketsSent,...v};c.outboundAudioRtp.set(u.id,C),c.producerStreamMap.get(p).outboundAudioRtpId.push(u.id),this.processOutboundProducerAudioStats(p,m,C)}}break}case"inbound-rtp":{const h=u,p=n||this.inboundConsumerMap.get(u.id);this.overallConsumersStatsMap[p]||(this.overallConsumersStatsMap[p]={totalVideoPacketsReceived:0,totalAudioPacketsReceived:0});const m=this.overallConsumersStatsMap[p];if(["video","audio"].includes(h.mediaType)){if(!this.inboundConsumerMap.has(u.id)){c.staleConsumerStreamMap=!0,l&&l.delete("inbound-rtp");break}c.consumerStreamMap.has(p)||c.consumerStreamMap.set(p,{inboundVideoRtpId:[],inboundAudioRtpId:[]});const v={bytesReceived:h.bytesReceived,packetsReceived:h.packetsReceived,packetsLost:h.packetsLost,jitter:h.jitter,nackCount:h.nackCount};if(h.mediaType==="video"){if(h.decoderImplementation==="unknown")break;const y=h,C={frameHeight:y.frameHeight,frameWidth:y.frameWidth,framesDecoded:y.framesDecoded,framesDropped:y.framesDropped?y.framesDropped:y.droppedFrames,framesPerSecond:y.framesPerSecond?y.framesPerSecond:y.framerateMean,framesReceived:y.framesReceived,keyFramesDecoded:y.keyFramesDecoded,firCount:y.firCount,decoderImplementation:y.decoderImplementation,...v};c.inboundVideoRtp.set(u.id,C),c.consumerStreamMap.get(p).inboundVideoRtpId.push(u.id),this.processInboundConsumerVideoStats(p,m,C)}else if(h.mediaType==="audio"){const y=h,C={audioLevel:y.audioLevel,concealedSampels:y.concealedSampels,concealmentEvents:y.concealmentEvents,jitterBufferDelay:y.jitterBufferDelay,jitterBufferEmittedCount:y.jitterBufferEmittedCount,totalAudioEnergy:y.totalAudioEnergy,totalSamplesDuration:y.totalSamplesDuration,totalSamplesReceived:y.totalSamplesReceived,...v};c.inboundAudioRtp.set(u.id,C),c.consumerStreamMap.get(p).inboundAudioRtpId.push(u.id),this.processInboundConsumerAudioStats(p,m,C)}}break}}}if(c.outboundVideoRtp.forEach((u,h)=>{u.remoteData=c.remoteInboundRtp.get(h)}),c.outboundAudioRtp.forEach((u,h)=>{u.remoteData=c.remoteInboundRtp.get(h)}),c.candidatePair&&(c.transport?(c.transport.bytesReceived=c.candidatePair.bytesReceived,c.transport.bytesSent=c.candidatePair.bytesSent,c.transport.totalRoundTripTime=c.candidatePair.totalRoundTripTime,c.transport.availableOutgoingBitrate=c.candidatePair.availableOutgoingBitrate,c.transport.roundTripTime=c.candidatePair.currentRoundTripTime):c.transport={bytesReceived:c.candidatePair.bytesReceived,bytesSent:c.candidatePair.bytesSent,totalRoundTripTime:c.candidatePair.totalRoundTripTime,availableOutgoingBitrate:c.candidatePair.availableOutgoingBitrate,roundTripTime:c.candidatePair.currentRoundTripTime}),c.transport&&!c.transport.roundTripTime){let u=0,h=0;c.remoteInboundRtp.forEach((p,m)=>{p.roundTripTime&&p.roundTripTime>u&&(u=p.roundTripTime,h=p.totalRoundTripTime)}),c.transport.roundTripTime=u,c.transport.totalRoundTripTime=h}return c}getProducerStatsFromReport(t){const s=[];try{t.producerStreamMap.forEach((i,n)=>{const a=this.producerMap.get(n),o=a.track.getSettings(),c=i.outboundVideoRtpId.map(u=>{const h=t.outboundVideoRtp.get(u);return h.frameHeight||(h.frameHeight=o.height,h.frameWidth=o.width,h.framesPerSecond=o.frameRate),h}),l={producerId:n,appData:a.appData,videoStats:c,audioStats:i.outboundAudioRtpId.map(u=>t.outboundAudioRtp.get(u))};s.push(l)})}catch(i){console.error("getProducersReport: ",i,t)}return s}getConsumerStatsFromParsedConsumerStats(t,s,i){let n;try{const{peerId:a,producerId:o,appData:c}=this.consumerPeerIdMap.get(i),l=s==null?void 0:s.inboundVideoRtpId.map(u=>{const p=this.consumerMap.get(i).track.getSettings(),m=t.inboundVideoRtp.get(u);return m.frameHeight||(m.frameHeight=p.height,m.frameWidth=p.width,m.framesPerSecond=p.frameRate),m});n={consumerId:i,peerId:a,producerId:o,appData:c,videoStats:l,audioStats:s==null?void 0:s.inboundAudioRtpId.map(u=>t.inboundAudioRtp.get(u))}}catch(a){console.error("getConsumerStatsFromParsedConsumerStats: ",a,t)}return n}getConsumerStatsFromReport(t){const s=[];try{t.consumerStreamMap.forEach((i,n)=>{s.push(this.getConsumerStatsFromParsedConsumerStats(t,i,n))})}catch(i){console.error("getConsumerStatsFromReport: ",i,t)}return s}}class by extends Uf{}function Jc(r,e,t,s){if(typeof t=="function"&&s instanceof e)t.call(null,s,r);else throw s}function Bf(r,e,t){const s=r.value;return r.value=function(...i){try{const n=s.apply(this,i);return n&&n instanceof Promise?n.catch(a=>{Jc(this,e,t,a)}):n}catch(n){Jc(this,e,t,n)}return null},r}const X=(r,e)=>(t,s,i)=>{const n=i.value;return i.value=function(...a){try{const o=n.apply(this,a);return o&&o instanceof Promise?o.catch(c=>{Jc(this,r,e,c)}):o}catch(o){Jc(this,r,e,o)}return null},i},Cy=(r,e)=>(t,s,i)=>{if(i)return Bf(i,r,e);for(const n of Reflect.ownKeys(t.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(t.prototype,n);a.value instanceof Function&&Object.defineProperty(t.prototype,n,Bf(a,r,e))}};var J=globalThis&&globalThis.__decorate||function(r,e,t,s){var i=arguments.length,n=i<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(r,e,t,s);else for(var o=r.length-1;o>=0;o--)(a=r[o])&&(n=(i<3?a(n):i>3?a(e,t,n):a(e,t))||n);return i>3&&n&&Object.defineProperty(e,t,n),n};const z=console;let j=class{constructor(e="https://api.testingv3.dyte.in",t="Blink",s=fo.PRODUCTION,i,n,a){f(this,"eventHandler");f(this,"measurements");f(this,"producingTransport");f(this,"consumingTransport");f(this,"producers",new Map);f(this,"consumers",new Map);f(this,"iceServers");f(this,"connectionInfoPromise");f(this,"pingStatsTimeout");f(this,"logger");f(this,"env");f(this,"peerId");f(this,"consumerSharedMediaStatesMap",new Map);f(this,"currentUserMediaStates",{});switch(this.env=s,this.logger=n,this.peerId=a,this.eventHandler=new my({logger:n,peerId:a,env:s}),this.logger.debug("callStats::engineName: ",{engineName:t}),t){case"Blink":this.measurements=new Ry;break;case"Gecko":this.measurements=new Uf;break;case"WebKit":this.measurements=new by;break;default:throw Error(`Unknown engineName! ${t}`)}this.measurements.callStatsInstance=this,this.registerProducer=this.registerProducer.bind(this),this.registerConsumer=this.registerConsumer.bind(this)}registerIceServers(e){this.iceServers=e}registerConsumer(e){var t;this.consumerSharedMediaStatesMap.has(e.id)||this.consumerSharedMediaStatesMap.set(e.id,{}),this.consumers.set(e.id,e),this.measurements.registerConsumer(e),this.logger.debug("callStats::registerConsumer",{consumerId:e.id,consumerkind:e.kind,isScreenShare:!!((t=e.appData)!=null&&t.screenShare)}),e.observer.on("close",this.deRegisterConsumer.bind(this,e))}registerProducer(e){var t;this.producers.set(e.id,e),this.measurements.registerProducer(e),this.logger.debug("callStats::registerProducer",{producerId:e.id,producerKind:e.kind,isScreenShare:!!((t=e.appData)!=null&&t.screenShare)}),e.observer.on("close",this.deRegisterProducer.bind(this,e))}sendConsumerSharedMediaStateEvent(e,t){this.consumerSharedMediaStatesMap.has(e)||this.consumerSharedMediaStatesMap.set(e,{});const s=this.consumerSharedMediaStatesMap.get(e);this.consumerSharedMediaStatesMap.set(e,Object.assign(s,t))}registerProducingTransport(e){var s;this.producingTransport=e,e.observer.on("close",this.disconnectProducingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectProducingTransport.bind(this,e)),Array.from(((s=e._producers)==null?void 0:s.values())||[]).forEach(i=>{this.registerProducer(i)}),e.observer.on("newproducer",this.registerProducer)}registerConsumingTransport(e){var s;this.consumingTransport=e,e.observer.on("close",this.disconnectConsumingTransport.bind(this,e)),e.observer.on("disconnect",this.disconnectConsumingTransport.bind(this,e)),Array.from(((s=e._consumers)==null?void 0:s.values())||[]).forEach(i=>{this.registerConsumer(i)}),e.observer.on("newconsumer",this.registerConsumer)}deRegisterConsumer(e){this.consumers.delete(e.id)}deRegisterProducer(e){this.producers.delete(e.id)}disconnectConsumingTransport(){this.consumingTransport=void 0}disconnectProducingTransport(){this.producingTransport=void 0}callEvent(e){this.eventHandler.callEvent(e)}sendPreCallTestBeginEvent(){this.connectionInfoPromise=this.measurements.getNetworkInfo(this.iceServers),this.eventHandler.callEvent({event:P.PRECALL_TEST_BEGIN,timestamp:new Date}),this.connectionInfoPromise&&this.connectionInfoPromise.then(e=>{this.eventHandler.callEvent({event:P.PRECALL_TEST_COMPLETE,metaData:{connectionInfo:e},timestamp:new Date})})}sendScreenShareToggleEvent(e,t){this.currentUserMediaStates.screen=e,this.eventHandler.callEvent({event:e?P.SCREENSHARE_STARTED:P.SCREENSHARE_STOPPED,metaData:{ssrc:t},timestamp:new Date})}sendScreenShareRequestedEvent(){this.eventHandler.callEvent({event:P.SCREENSHARE_START_REQUESTED,timestamp:new Date})}sendActiveSpeakerEvent(e){this.eventHandler.callEvent({event:P.DOMINANT_SPEAKER,metaData:{peerId:e},timestamp:new Date})}devices(e,t){this.eventHandler.callEvent({event:e===vr.AUDIO&&P.AUDIO_DEVICES_UPDATES||e===vr.VIDEO&&P.VIDEO_DEVICES_UPDATES||e===vr.SPEAKER&&P.SPEAKER_DEVICES_UPDATES,metaData:{deviceList:t},timestamp:new Date})}selectedDevice(e,t){this.eventHandler.callEvent({event:e===vr.AUDIO&&P.SELECTED_MICROHPONE_UPDATE||e===vr.VIDEO&&P.SELECTED_CAMERA_UPDATE||e===vr.SPEAKER&&P.SELECTED_SPEAKER_UPDATE,metaData:{device:t},timestamp:new Date})}mediaPermission(e,t){this.eventHandler.callEvent({event:P.MEDIA_PERMISSION,metaData:{deviceType:e,permission:t},timestamp:new Date})}mediaPlaybackFailed(e){this.eventHandler.callEvent({event:e===vr.AUDIO&&P.AUDIO_PLAY_FAILED||e===vr.VIDEO&&P.VIDEO_PLAY_FAILED,metaData:{deviceType:e},timestamp:new Date})}mediaTrackMuted(e){this.eventHandler.callEvent({event:e===vr.AUDIO&&P.AUDIO_TRACK_MUTED||e===vr.VIDEO&&P.VIDEO_TRACK_MUTED,metaData:{deviceType:e},timestamp:new Date})}tabChanged(e){this.eventHandler.callEvent({event:P.TAB_CHANGE,metaData:{isMeetingsTabActive:e},timestamp:new Date})}browserBackgrounded(){this.eventHandler.callEvent({event:P.BROWSER_BACKGROUNDED,timestamp:new Date})}browserForegrounded(){this.eventHandler.callEvent({event:P.BROWSER_FOREGROUNDED,timestamp:new Date})}legacySwitch(e){this.eventHandler.callEvent({event:P.LEGACY_SWITCH,metadata:{on:e},timestamp:new Date})}async getPreCallTestResults(){return this.connectionInfoPromise}sendCallJoinBeginEvent(e){e={...e,meetingEnv:this.env},e.deviceInfo={...e.deviceInfo,userAgent:navigator.userAgent,cpus:navigator.hardwareConcurrency,memory:navigator.deviceMemory},this.eventHandler.callEvent({event:P.CALL_JOIN_BEGIN,metaData:{peerMetaData:e},timestamp:new Date})}sendNetworkQualityTestBeginEvent(e){this.eventHandler.callEvent({event:P.NET_QUALITY_TEST_BEGIN,timestamp:new Date}),new Promise(async(s,i)=>{const n=[];try{for(const a of e)try{if(a.iceServers&&a.iceServers.length>0){const o=await this.measurements.getNetworkQuality(a.iceServers);n.push({...a,networkResults:o})}}catch(o){console.warn("Error handling ",o)}s({regionData:n})}catch(a){console.warn("Error in callstats, ",a),i(a)}}).then(s=>{this.eventHandler.callEvent({event:P.NET_QUALITY_TEST_END,timestamp:new Date,metaData:s})})}sendWebSocketConnectedEvent(){this.eventHandler.callEvent({event:P.WEBSOCKET_CONNECTED,timestamp:new Date})}sendTransportConnectedEvent(){this.eventHandler.callEvent({event:P.TRANSPORT_CONNECTED,timestamp:new Date})}sendAudioToggleEvent(e){this.currentUserMediaStates.audio=e;let t;e?t=P.AUDIO_ON:t=P.AUDIO_OFF,this.eventHandler.callEvent({event:t,timestamp:new Date})}sendVideoToggleEvent(e){this.currentUserMediaStates.video=e;let t;e?t=P.VIDEO_ON:t=P.VIDEO_OFF,this.eventHandler.callEvent({event:t,timestamp:new Date})}sendParticipantRoleToggleEvent(e){this.eventHandler.callEvent({event:P.PARTICIPANT_ROLE,timestamp:new Date,metaData:e})}startPingStats(e=7e3){this.sendPingStatsEvent(!1),this.pingStatsTimeout=setInterval(this.sendPingStatsEvent.bind(this),e)}stopPingStats(){clearInterval(this.pingStatsTimeout)}async sendPingStatsEvent(e=!0){let t,s;if(this.producingTransport&&(t=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),!t||!(t!=null&&t.producerReport))){this.logger.debug("callStats::sendPingStatsEvent::staleProducingTransport",{disclaimer:"Stale producer? Regenerating Stream Maps!"});const n=await this.measurements.getProducersReport([...this.producers.values()]);t&&n?t.producerReport=n:(t=await this.measurements.getProcessedStats(this.producingTransport,!1,!0),(!t||!(t!=null&&t.producerReport))&&this.logger.debug("callStats::sendPingStatsEvent::noProducingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}if(this.consumingTransport&&(s=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),!s||!s.consumerReport)){this.logger.debug("callStats::sendPingStatsEvent::staleConsumingTransport",{disclaimer:"Stale consumer? Regenerating Stream Maps!"});const n=await this.measurements.getConsumersReport([...this.consumers.values()]);s&&n?s.consumerReport=n:(s=await this.measurements.getProcessedStats(this.consumingTransport,!0,!1),(!s||!s.consumerReport)&&this.logger.debug("callStats::sendPingStatsEvent::noConsumingTransportReport",{disclaimer:"Stream maps invalid despite regenerating!"}))}const i={producingTransportStats:t?t==null?void 0:t.transportReport:void 0,consumingTransportStats:s?s==null?void 0:s.transportReport:void 0,producerStats:[].concat((t==null?void 0:t.producerReport)||[]).concat((s==null?void 0:s.producerReport)||[]),consumerStats:[].concat((s==null?void 0:s.consumerReport)||[]).concat((t==null?void 0:t.consumerReport)||[])};if(e&&i.producerStats.length===0&&i.consumerStats.length===0){await this.eventHandler.flush();return}this.eventHandler.callEvent({event:P.PING_STAT,metaData:i,timestamp:new Date})}sendIVSPlayerRebufferEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_REBUFFERING,timestamp:new Date})}sendIVSPlayerAudioBlockEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_AUDIO_BLOCKED,timestamp:new Date})}sendIVSPlayerPlaybackBlockedEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_PLAYBACK_BLOCKED,timestamp:new Date})}sendIVSPlayerNetworkUnavailableEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_NETWORK_UNAVAILABLE,timestamp:new Date})}sendIVSPlayerInitializedEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_INITIALIZED,timestamp:new Date})}sendIVSPlayerWorkerErrorEvent(){this.eventHandler.callEvent({event:P.IVS_PLAYER_WORKER_ERROR,timestamp:new Date})}sendIVSPlayerErrorEvent(e){this.eventHandler.callEvent({event:P.IVS_PLAYER_ERROR,timestamp:new Date,metaData:e})}sendIVSPlayerRecoverableErrorEvent(e){this.eventHandler.callEvent({event:P.IVS_PLAYER_RECOVERABLE_ERROR,timestamp:new Date,metaData:e})}sendIVSPlayerAnalyticsEvent(e){this.eventHandler.callEvent({event:P.IVS_PLAYER_ANALYTICS_EVENT,timestamp:new Date,metaData:e})}sendIVSPlayerPlaybackRateChangedEvent(e){this.eventHandler.callEvent({event:P.IVS_PLAYER_PLAYBACK_RATE_CHANGED,timestamp:new Date,metaData:{updatedPlaybackRate:e}})}sendIVSPlayerQualityChanged(e){this.eventHandler.callEvent({event:P.IVS_PLAYER_QUALITY_CHANGED,timestamp:new Date,metaData:e})}sendPlayerLiveLatency(e){this.eventHandler.callEvent({event:P.LIVESTREAM_LATENCY,timestamp:new Date,metaData:{latency:e}})}sendDisconnectEvent(){this.eventHandler.callEvent({event:P.DISCONNECT,timestamp:new Date})}sendReconnectEvent(){this.eventHandler.callEvent({event:P.RECONNECT_ATTEMPT,timestamp:new Date})}};J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"registerIceServers",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"registerConsumer",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"registerProducer",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendConsumerSharedMediaStateEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"registerProducingTransport",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"registerConsumingTransport",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"deRegisterConsumer",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"deRegisterProducer",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"disconnectConsumingTransport",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"disconnectProducingTransport",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendPreCallTestBeginEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendScreenShareToggleEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendScreenShareRequestedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendActiveSpeakerEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"devices",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"selectedDevice",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"mediaPermission",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"mediaPlaybackFailed",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"mediaTrackMuted",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"tabChanged",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"browserBackgrounded",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"browserForegrounded",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"legacySwitch",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"getPreCallTestResults",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendCallJoinBeginEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendNetworkQualityTestBeginEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendWebSocketConnectedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendTransportConnectedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendAudioToggleEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendVideoToggleEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendParticipantRoleToggleEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"startPingStats",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"stopPingStats",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendPingStatsEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerRebufferEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerAudioBlockEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerPlaybackBlockedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerNetworkUnavailableEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerInitializedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerWorkerErrorEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerErrorEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerRecoverableErrorEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerAnalyticsEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerPlaybackRateChangedEvent",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendIVSPlayerQualityChanged",null),J([X(TypeError,(r,e)=>z.error(e,r))],j.prototype,"sendPlayerLiveLatency",null),j=J([Cy(TypeError,(r,e)=>z.error(e,r))],j);const Py=j;class Ay extends Jt{constructor(){super(...arguments);f(this,"stats");f(this,"roomURL");f(this,"peerId");f(this,"backend");f(this,"iceServers");f(this,"initialized",!1);f(this,"stalled",!1);f(this,"ipInformation");f(this,"logger")}async initialize({peerId:t,engineName:s,env:i=fo.PRODUCTION,iceServers:n,apiBase:a="https://api.cluster.dyte.in",flags:o,logger:c=console}){var l,u,h;try{this.peerId=t,this.logger=c,this.ipInformation=await gu.getIPDetails({peerId:t}),this.backend=new Py(a,s,i,o,c,t),this.iceServers=n,(l=this.backend)==null||l.registerIceServers(this.iceServers),this.initialized=!0,(h=(u=this.backend)==null?void 0:u.eventHandler)==null||h.emit("initialized",this.ipInformation),this.emit("initialized",this.ipInformation),this.startPreCallTest()}catch(p){this.logger.error("callStats::CallStatsIntegration: ",{error:{reason:p.reason}}),this.stallCallStats()}}setRoomName(t){this.roomURL=t}configureSendTransport(t){var s;(s=this.backend)==null||s.registerProducingTransport(t)}configureRecvTransport(t){var s;(s=this.backend)==null||s.registerConsumingTransport(t)}async candidateRegionalNetworkQualityTest(t){var s;try{(s=this.backend)==null||s.sendNetworkQualityTestBeginEvent(t)}catch(i){this.logger.error("callStats::sendNetworkQualityTestBeginEvent",{error:{reason:i.reason}})}}async roomJoined(t){var s,i;(s=this.backend)==null||s.sendCallJoinBeginEvent(t),this.backend,(i=this.backend)==null||i.startPingStats()}audioOff(){var t;(t=this.backend)==null||t.sendAudioToggleEvent(!1)}audioOn(){var t;(t=this.backend)==null||t.sendAudioToggleEvent(!0)}videoOff(){var t;(t=this.backend)==null||t.sendVideoToggleEvent(!1)}videoOn(){var t;(t=this.backend)==null||t.sendVideoToggleEvent(!0)}callEnded(){var t,s;(t=this.backend)==null||t.stopPingStats(),(s=this.backend)==null||s.sendDisconnectEvent()}screenShareStart(t){var s;(s=this.backend)==null||s.sendScreenShareToggleEvent(!0,t)}consumerSharedMediaState(t,s){var i;(i=this.backend)==null||i.sendConsumerSharedMediaStateEvent(t,s)}screenShareStop(t){var s;(s=this.backend)==null||s.sendScreenShareToggleEvent(!1,t)}screenShareRequested(){var t;(t=this.backend)==null||t.sendScreenShareRequestedEvent()}activeSpeaker(t){var s;t===this.peerId&&((s=this.backend)==null||s.sendActiveSpeakerEvent(t))}devices(t,s){var i;(i=this.backend)==null||i.devices(t,s)}selectedDevice(t,s){var i;(i=this.backend)==null||i.selectedDevice(t,s)}mediaPermission(t,s){var i;(i=this.backend)==null||i.mediaPermission(t,s)}mediaPlaybackFailed(t){var s;(s=this.backend)==null||s.mediaPlaybackFailed(t)}mediaTrackMuted(t){var s;(s=this.backend)==null||s.mediaTrackMuted(t)}tabChanged(t=!1){var s;(s=this.backend)==null||s.tabChanged(t)}browserBackgrounded(){var t;(t=this.backend)==null||t.browserBackgrounded()}browserForegrounded(){var t;(t=this.backend)==null||t.browserForegrounded()}legacySwitch(t){var s;(s=this.backend)==null||s.legacySwitch(t)}async startPreCallTest(){var t;(t=this.backend)==null||t.sendPreCallTestBeginEvent()}onPreCallTestResults(t){var s;return(s=this.backend)==null||s.eventHandler.once("precall_end",t),t}onReceivingConsumerAudioStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("consumer_audio_status",t)}onReceivingConsumerVideoStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("consumer_video_status",t)}onReceivingProducerAudioStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("producer_audio_status",t)}onReceivingProducerVideoStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("producer_video_status",t)}onReceivingProducingTransportStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("producing_transport_status",t)}onReceivingConsumingTransportStatus(t){var s;(s=this.backend)==null||s.eventHandler.on("consuming_transport_status",t)}onSafeInitialization(t){if(this.initialized)t(this.ipInformation,!1);else if(!this.stalled){const s=i=>{t(i,!0)};return this.once("initialized",s),s}return()=>{}}removeInitializationListener(t){this.removeListener("initialized",t)}stallCallStats(){this.stalled=!0,this.removeAllListeners("initialized")}ivsPlayerEvent(t,s){var i,n,a,o,c,l,u,h,p,m,v;switch(t){case"PlayerRebuffering":(i=this.backend)==null||i.sendIVSPlayerRebufferEvent();break;case"PlayerAudioBlocked":(n=this.backend)==null||n.sendIVSPlayerAudioBlockEvent();break;case"PlayerPlaybackBlocked":(a=this.backend)==null||a.sendIVSPlayerPlaybackBlockedEvent();break;case"PlayerNetworkUnavailable":(o=this.backend)==null||o.sendIVSPlayerNetworkUnavailableEvent();break;case"PlayerInitialized":(c=this.backend)==null||c.sendIVSPlayerInitializedEvent();break;case"PlayerWorkerError":(l=this.backend)==null||l.sendIVSPlayerWorkerErrorEvent();break;case"PlayerError":(u=this.backend)==null||u.sendIVSPlayerErrorEvent(s);break;case"PlayerRecoverableError":(h=this.backend)==null||h.sendIVSPlayerRecoverableErrorEvent(s);break;case"PlayerAnalyticsEvent":(p=this.backend)==null||p.sendIVSPlayerAnalyticsEvent(s);break;case"PlayerPlaybackRateChanged":(m=this.backend)==null||m.sendIVSPlayerPlaybackRateChangedEvent(s);break;case"PlayerQualityChanged":(v=this.backend)==null||v.sendIVSPlayerQualityChanged(s);break}}livestreamLatency(t){var s;(s=this.backend)==null||s.sendPlayerLiveLatency(t)}}const L=new Ay;L.setMaxListeners(30);function Iy(r){const{length:e}=this,t=r>=0?r:e+r;return t<0||t>=e?void 0:this[t]}Array.prototype.at||Object.assign(Array.prototype,{at:Iy});function ky(r){const{length:e}=this,t=r>=0?r:e+r;return t<0||t>=e?void 0:this[t]}String.prototype.at||Object.assign(String.prototype,{at:ky});var zc,Oy=new Uint8Array(16);function Dy(){if(!zc&&(zc=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!zc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return zc(Oy)}const My=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function _u(r){return typeof r=="string"&&My.test(r)}for(var Lt=[],vu=0;vu<256;++vu)Lt.push((vu+256).toString(16).substr(1));function Ny(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=(Lt[r[e+0]]+Lt[r[e+1]]+Lt[r[e+2]]+Lt[r[e+3]]+"-"+Lt[r[e+4]]+Lt[r[e+5]]+"-"+Lt[r[e+6]]+Lt[r[e+7]]+"-"+Lt[r[e+8]]+Lt[r[e+9]]+"-"+Lt[r[e+10]]+Lt[r[e+11]]+Lt[r[e+12]]+Lt[r[e+13]]+Lt[r[e+14]]+Lt[r[e+15]]).toLowerCase();if(!_u(t))throw TypeError("Stringified UUID is invalid");return t}function Yc(r,e,t){r=r||{};var s=r.random||(r.rng||Dy)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){t=t||0;for(var i=0;i<16;++i)e[t+i]=s[i];return e}return Ny(s)}var mo;(function(r){r.skip="SKIP",r.onAccept="ON_ACCEPT",r.skipOnPrivilegedUserEntry="SKIP_ON_PRIVILEGED_USER_ENTRY",r.skipOnAccept="SKIP_ON_ACCEPT"})(mo||(mo={}));var $i;(function(r){r.none="NONE",r.recorder="RECORDER",r.livestreamer="LIVESTREAMER"})($i||($i={}));var Xc;(function(r){r.groupCall="GROUP_CALL",r.webinar="WEBINAR",r.audioRoom="AUDIO_ROOM",r.livestream="LIVESTREAM",r.chat="CHAT"})(Xc||(Xc={}));var Ff;(function(r){r.SKIP="skip",r.SKIP_ON_PRIVILEGED_USER_ENTRY="skipOnPrivilegedUserEntry",r.ON_ACCEPT="skipOnAccept",r.SKIP_ON_ACCEPT="skipOnAccept"})(Ff||(Ff={})),Xc.groupCall,mo.skipOnAccept,$i.none,Xc.groupCall,$i.none,mo.skipOnAccept;var Tu={},Ly={get exports(){return Tu},set exports(r){Tu=r}},Qc={},xy={get exports(){return Qc},set exports(r){Qc=r}},Vf=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}},Uy=Vf,Xs=Object.prototype.toString;function Eu(r){return Array.isArray(r)}function yu(r){return typeof r=="undefined"}function By(r){return r!==null&&!yu(r)&&r.constructor!==null&&!yu(r.constructor)&&typeof r.constructor.isBuffer=="function"&&r.constructor.isBuffer(r)}function $f(r){return Xs.call(r)==="[object ArrayBuffer]"}function Fy(r){return Xs.call(r)==="[object FormData]"}function Vy(r){var e;return typeof ArrayBuffer!="undefined"&&ArrayBuffer.isView?e=ArrayBuffer.isView(r):e=r&&r.buffer&&$f(r.buffer),e}function $y(r){return typeof r=="string"}function Hy(r){return typeof r=="number"}function Hf(r){return r!==null&&typeof r=="object"}function Zc(r){if(Xs.call(r)!=="[object Object]")return!1;var e=Object.getPrototypeOf(r);return e===null||e===Object.prototype}function jy(r){return Xs.call(r)==="[object Date]"}function Gy(r){return Xs.call(r)==="[object File]"}function qy(r){return Xs.call(r)==="[object Blob]"}function jf(r){return Xs.call(r)==="[object Function]"}function Ky(r){return Hf(r)&&jf(r.pipe)}function Wy(r){return Xs.call(r)==="[object URLSearchParams]"}function Jy(r){return r.trim?r.trim():r.replace(/^\s+|\s+$/g,"")}function zy(){return typeof navigator!="undefined"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof window!="undefined"&&typeof document!="undefined"}function Su(r,e){if(!(r===null||typeof r=="undefined"))if(typeof r!="object"&&(r=[r]),Eu(r))for(var t=0,s=r.length;t<s;t++)e.call(null,r[t],t,r);else for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&e.call(null,r[i],i,r)}function wu(){var r={};function e(i,n){Zc(r[n])&&Zc(i)?r[n]=wu(r[n],i):Zc(i)?r[n]=wu({},i):Eu(i)?r[n]=i.slice():r[n]=i}for(var t=0,s=arguments.length;t<s;t++)Su(arguments[t],e);return r}function Yy(r,e,t){return Su(e,function(i,n){t&&typeof i=="function"?r[n]=Uy(i,t):r[n]=i}),r}function Xy(r){return r.charCodeAt(0)===65279&&(r=r.slice(1)),r}var er={isArray:Eu,isArrayBuffer:$f,isBuffer:By,isFormData:Fy,isArrayBufferView:Vy,isString:$y,isNumber:Hy,isObject:Hf,isPlainObject:Zc,isUndefined:yu,isDate:jy,isFile:Gy,isBlob:qy,isFunction:jf,isStream:Ky,isURLSearchParams:Wy,isStandardBrowserEnv:zy,forEach:Su,merge:wu,extend:Yy,trim:Jy,stripBOM:Xy},Xn=er;function Gf(r){return encodeURIComponent(r).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var qf=function(e,t,s){if(!t)return e;var i;if(s)i=s(t);else if(Xn.isURLSearchParams(t))i=t.toString();else{var n=[];Xn.forEach(t,function(c,l){c===null||typeof c=="undefined"||(Xn.isArray(c)?l=l+"[]":c=[c],Xn.forEach(c,function(h){Xn.isDate(h)?h=h.toISOString():Xn.isObject(h)&&(h=JSON.stringify(h)),n.push(Gf(l)+"="+Gf(h))}))}),i=n.join("&")}if(i){var a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+i}return e},Qy=er;function ed(){this.handlers=[]}ed.prototype.use=function(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:s?s.synchronous:!1,runWhen:s?s.runWhen:null}),this.handlers.length-1},ed.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},ed.prototype.forEach=function(e){Qy.forEach(this.handlers,function(s){s!==null&&e(s)})};var Zy=ed,eS=er,tS=function(e,t){eS.forEach(e,function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])})},Kf=function(e,t,s,i,n){return e.config=t,s&&(e.code=s),e.request=i,e.response=n,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},e},Ru,Wf;function Jf(){if(Wf)return Ru;Wf=1;var r=Kf;return Ru=function(t,s,i,n,a){var o=new Error(t);return r(o,s,i,n,a)},Ru}var bu,zf;function rS(){if(zf)return bu;zf=1;var r=Jf();return bu=function(t,s,i){var n=i.config.validateStatus;!i.status||!n||n(i.status)?t(i):s(r("Request failed with status code "+i.status,i.config,null,i.request,i))},bu}var Cu,Yf;function sS(){if(Yf)return Cu;Yf=1;var r=er;return Cu=r.isStandardBrowserEnv()?function(){return{write:function(s,i,n,a,o,c){var l=[];l.push(s+"="+encodeURIComponent(i)),r.isNumber(n)&&l.push("expires="+new Date(n).toGMTString()),r.isString(a)&&l.push("path="+a),r.isString(o)&&l.push("domain="+o),c===!0&&l.push("secure"),document.cookie=l.join("; ")},read:function(s){var i=document.cookie.match(new RegExp("(^|;\\s*)("+s+")=([^;]*)"));return i?decodeURIComponent(i[3]):null},remove:function(s){this.write(s,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}(),Cu}var Pu,Xf;function iS(){return Xf||(Xf=1,Pu=function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}),Pu}var Au,Qf;function nS(){return Qf||(Qf=1,Au=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}),Au}var Iu,Zf;function aS(){if(Zf)return Iu;Zf=1;var r=iS(),e=nS();return Iu=function(s,i){return s&&!r(i)?e(s,i):i},Iu}var ku,em;function oS(){if(em)return ku;em=1;var r=er,e=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return ku=function(s){var i={},n,a,o;return s&&r.forEach(s.split(`
`),function(l){if(o=l.indexOf(":"),n=r.trim(l.substr(0,o)).toLowerCase(),a=r.trim(l.substr(o+1)),n){if(i[n]&&e.indexOf(n)>=0)return;n==="set-cookie"?i[n]=(i[n]?i[n]:[]).concat([a]):i[n]=i[n]?i[n]+", "+a:a}}),i},ku}var Ou,tm;function cS(){if(tm)return Ou;tm=1;var r=er;return Ou=r.isStandardBrowserEnv()?function(){var t=/(msie|trident)/i.test(navigator.userAgent),s=document.createElement("a"),i;function n(a){var o=a;return t&&(s.setAttribute("href",o),o=s.href),s.setAttribute("href",o),{href:s.href,protocol:s.protocol?s.protocol.replace(/:$/,""):"",host:s.host,search:s.search?s.search.replace(/^\?/,""):"",hash:s.hash?s.hash.replace(/^#/,""):"",hostname:s.hostname,port:s.port,pathname:s.pathname.charAt(0)==="/"?s.pathname:"/"+s.pathname}}return i=n(window.location.href),function(o){var c=r.isString(o)?n(o):o;return c.protocol===i.protocol&&c.host===i.host}}():function(){return function(){return!0}}(),Ou}var Du,rm;function td(){if(rm)return Du;rm=1;function r(e){this.message=e}return r.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},r.prototype.__CANCEL__=!0,Du=r,Du}var Mu,sm;function im(){if(sm)return Mu;sm=1;var r=er,e=rS(),t=sS(),s=qf,i=aS(),n=oS(),a=cS(),o=Jf(),c=rd(),l=td();return Mu=function(h){return new Promise(function(m,v){var y=h.data,C=h.headers,k=h.responseType,D;function V(){h.cancelToken&&h.cancelToken.unsubscribe(D),h.signal&&h.signal.removeEventListener("abort",D)}r.isFormData(y)&&delete C["Content-Type"];var M=new XMLHttpRequest;if(h.auth){var Pe=h.auth.username||"",W=h.auth.password?unescape(encodeURIComponent(h.auth.password)):"";C.Authorization="Basic "+btoa(Pe+":"+W)}var Se=i(h.baseURL,h.url);M.open(h.method.toUpperCase(),s(Se,h.params,h.paramsSerializer),!0),M.timeout=h.timeout;function lt(){if(M){var Ge="getAllResponseHeaders"in M?n(M.getAllResponseHeaders()):null,Ie=!k||k==="text"||k==="json"?M.responseText:M.response,ut={data:Ie,status:M.status,statusText:M.statusText,headers:Ge,config:h,request:M};e(function(_r){m(_r),V()},function(_r){v(_r),V()},ut),M=null}}if("onloadend"in M?M.onloadend=lt:M.onreadystatechange=function(){!M||M.readyState!==4||M.status===0&&!(M.responseURL&&M.responseURL.indexOf("file:")===0)||setTimeout(lt)},M.onabort=function(){M&&(v(o("Request aborted",h,"ECONNABORTED",M)),M=null)},M.onerror=function(){v(o("Network Error",h,null,M)),M=null},M.ontimeout=function(){var Ie=h.timeout?"timeout of "+h.timeout+"ms exceeded":"timeout exceeded",ut=h.transitional||c.transitional;h.timeoutErrorMessage&&(Ie=h.timeoutErrorMessage),v(o(Ie,h,ut.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",M)),M=null},r.isStandardBrowserEnv()){var or=(h.withCredentials||a(Se))&&h.xsrfCookieName?t.read(h.xsrfCookieName):void 0;or&&(C[h.xsrfHeaderName]=or)}"setRequestHeader"in M&&r.forEach(C,function(Ie,ut){typeof y=="undefined"&&ut.toLowerCase()==="content-type"?delete C[ut]:M.setRequestHeader(ut,Ie)}),r.isUndefined(h.withCredentials)||(M.withCredentials=!!h.withCredentials),k&&k!=="json"&&(M.responseType=h.responseType),typeof h.onDownloadProgress=="function"&&M.addEventListener("progress",h.onDownloadProgress),typeof h.onUploadProgress=="function"&&M.upload&&M.upload.addEventListener("progress",h.onUploadProgress),(h.cancelToken||h.signal)&&(D=function(Ge){M&&(v(!Ge||Ge&&Ge.type?new l("canceled"):Ge),M.abort(),M=null)},h.cancelToken&&h.cancelToken.subscribe(D),h.signal&&(h.signal.aborted?D():h.signal.addEventListener("abort",D))),y||(y=null),M.send(y)})},Mu}var Nu,nm;function rd(){if(nm)return Nu;nm=1;var r=er,e=tS,t=Kf,s={"Content-Type":"application/x-www-form-urlencoded"};function i(c,l){!r.isUndefined(c)&&r.isUndefined(c["Content-Type"])&&(c["Content-Type"]=l)}function n(){var c;return(typeof XMLHttpRequest!="undefined"||typeof process!="undefined"&&Object.prototype.toString.call(process)==="[object process]")&&(c=im()),c}function a(c,l,u){if(r.isString(c))try{return(l||JSON.parse)(c),r.trim(c)}catch(h){if(h.name!=="SyntaxError")throw h}return(u||JSON.stringify)(c)}var o={transitional:{silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},adapter:n(),transformRequest:[function(l,u){return e(u,"Accept"),e(u,"Content-Type"),r.isFormData(l)||r.isArrayBuffer(l)||r.isBuffer(l)||r.isStream(l)||r.isFile(l)||r.isBlob(l)?l:r.isArrayBufferView(l)?l.buffer:r.isURLSearchParams(l)?(i(u,"application/x-www-form-urlencoded;charset=utf-8"),l.toString()):r.isObject(l)||u&&u["Content-Type"]==="application/json"?(i(u,"application/json"),a(l)):l}],transformResponse:[function(l){var u=this.transitional||o.transitional,h=u&&u.silentJSONParsing,p=u&&u.forcedJSONParsing,m=!h&&this.responseType==="json";if(m||p&&r.isString(l)&&l.length)try{return JSON.parse(l)}catch(v){if(m)throw v.name==="SyntaxError"?t(v,this,"E_JSON_PARSE"):v}return l}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(l){return l>=200&&l<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};return r.forEach(["delete","get","head"],function(l){o.headers[l]={}}),r.forEach(["post","put","patch"],function(l){o.headers[l]=r.merge(s)}),Nu=o,Nu}var dS=er,lS=rd(),uS=function(e,t,s){var i=this||lS;return dS.forEach(s,function(a){e=a.call(i,e,t)}),e},Lu,am;function om(){return am||(am=1,Lu=function(e){return!!(e&&e.__CANCEL__)}),Lu}var cm=er,xu=uS,hS=om(),pS=rd(),fS=td();function Uu(r){if(r.cancelToken&&r.cancelToken.throwIfRequested(),r.signal&&r.signal.aborted)throw new fS("canceled")}var mS=function(e){Uu(e),e.headers=e.headers||{},e.data=xu.call(e,e.data,e.headers,e.transformRequest),e.headers=cm.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),cm.forEach(["delete","get","head","post","put","patch","common"],function(i){delete e.headers[i]});var t=e.adapter||pS.adapter;return t(e).then(function(i){return Uu(e),i.data=xu.call(e,i.data,i.headers,e.transformResponse),i},function(i){return hS(i)||(Uu(e),i&&i.response&&(i.response.data=xu.call(e,i.response.data,i.response.headers,e.transformResponse))),Promise.reject(i)})},lr=er,dm=function(e,t){t=t||{};var s={};function i(u,h){return lr.isPlainObject(u)&&lr.isPlainObject(h)?lr.merge(u,h):lr.isPlainObject(h)?lr.merge({},h):lr.isArray(h)?h.slice():h}function n(u){if(lr.isUndefined(t[u])){if(!lr.isUndefined(e[u]))return i(void 0,e[u])}else return i(e[u],t[u])}function a(u){if(!lr.isUndefined(t[u]))return i(void 0,t[u])}function o(u){if(lr.isUndefined(t[u])){if(!lr.isUndefined(e[u]))return i(void 0,e[u])}else return i(void 0,t[u])}function c(u){if(u in t)return i(e[u],t[u]);if(u in e)return i(void 0,e[u])}var l={url:a,method:a,data:a,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:c};return lr.forEach(Object.keys(e).concat(Object.keys(t)),function(h){var p=l[h]||n,m=p(h);lr.isUndefined(m)&&p!==c||(s[h]=m)}),s},Bu,lm;function um(){return lm||(lm=1,Bu={version:"0.25.0"}),Bu}var gS=um().version,Fu={};["object","boolean","number","function","string","symbol"].forEach(function(r,e){Fu[r]=function(s){return typeof s===r||"a"+(e<1?"n ":" ")+r}});var hm={};Fu.transitional=function(e,t,s){function i(n,a){return"[Axios v"+gS+"] Transitional option '"+n+"'"+a+(s?". "+s:"")}return function(n,a,o){if(e===!1)throw new Error(i(a," has been removed"+(t?" in "+t:"")));return t&&!hm[a]&&(hm[a]=!0,console.warn(i(a," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(n,a,o):!0}};function _S(r,e,t){if(typeof r!="object")throw new TypeError("options must be an object");for(var s=Object.keys(r),i=s.length;i-- >0;){var n=s[i],a=e[n];if(a){var o=r[n],c=o===void 0||a(o,n,r);if(c!==!0)throw new TypeError("option "+n+" must be "+c);continue}if(t!==!0)throw Error("Unknown option "+n)}}var vS={assertOptions:_S,validators:Fu},pm=er,TS=qf,fm=Zy,mm=mS,sd=dm,gm=vS,Qn=gm.validators;function go(r){this.defaults=r,this.interceptors={request:new fm,response:new fm}}go.prototype.request=function(e,t){if(typeof e=="string"?(t=t||{},t.url=e):t=e||{},!t.url)throw new Error("Provided config url is not valid");t=sd(this.defaults,t),t.method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var s=t.transitional;s!==void 0&&gm.assertOptions(s,{silentJSONParsing:Qn.transitional(Qn.boolean),forcedJSONParsing:Qn.transitional(Qn.boolean),clarifyTimeoutError:Qn.transitional(Qn.boolean)},!1);var i=[],n=!0;this.interceptors.request.forEach(function(m){typeof m.runWhen=="function"&&m.runWhen(t)===!1||(n=n&&m.synchronous,i.unshift(m.fulfilled,m.rejected))});var a=[];this.interceptors.response.forEach(function(m){a.push(m.fulfilled,m.rejected)});var o;if(!n){var c=[mm,void 0];for(Array.prototype.unshift.apply(c,i),c=c.concat(a),o=Promise.resolve(t);c.length;)o=o.then(c.shift(),c.shift());return o}for(var l=t;i.length;){var u=i.shift(),h=i.shift();try{l=u(l)}catch(p){h(p);break}}try{o=mm(l)}catch(p){return Promise.reject(p)}for(;a.length;)o=o.then(a.shift(),a.shift());return o},go.prototype.getUri=function(e){if(!e.url)throw new Error("Provided config url is not valid");return e=sd(this.defaults,e),TS(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},pm.forEach(["delete","get","head","options"],function(e){go.prototype[e]=function(t,s){return this.request(sd(s||{},{method:e,url:t,data:(s||{}).data}))}}),pm.forEach(["post","put","patch"],function(e){go.prototype[e]=function(t,s,i){return this.request(sd(i||{},{method:e,url:t,data:s}))}});var ES=go,Vu,_m;function yS(){if(_m)return Vu;_m=1;var r=td();function e(t){if(typeof t!="function")throw new TypeError("executor must be a function.");var s;this.promise=new Promise(function(a){s=a});var i=this;this.promise.then(function(n){if(i._listeners){var a,o=i._listeners.length;for(a=0;a<o;a++)i._listeners[a](n);i._listeners=null}}),this.promise.then=function(n){var a,o=new Promise(function(c){i.subscribe(c),a=c}).then(n);return o.cancel=function(){i.unsubscribe(a)},o},t(function(a){i.reason||(i.reason=new r(a),s(i.reason))})}return e.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},e.prototype.subscribe=function(s){if(this.reason){s(this.reason);return}this._listeners?this._listeners.push(s):this._listeners=[s]},e.prototype.unsubscribe=function(s){if(this._listeners){var i=this._listeners.indexOf(s);i!==-1&&this._listeners.splice(i,1)}},e.source=function(){var s,i=new e(function(a){s=a});return{token:i,cancel:s}},Vu=e,Vu}var $u,vm;function SS(){return vm||(vm=1,$u=function(e){return function(s){return e.apply(null,s)}}),$u}var Hu,Tm;function wS(){if(Tm)return Hu;Tm=1;var r=er;return Hu=function(t){return r.isObject(t)&&t.isAxiosError===!0},Hu}var Em=er,RS=Vf,id=ES,bS=dm,CS=rd();function ym(r){var e=new id(r),t=RS(id.prototype.request,e);return Em.extend(t,id.prototype,e),Em.extend(t,e),t.create=function(i){return ym(bS(r,i))},t}var Yr=ym(CS);Yr.Axios=id,Yr.Cancel=td(),Yr.CancelToken=yS(),Yr.isCancel=om(),Yr.VERSION=um().version,Yr.all=function(e){return Promise.all(e)},Yr.spread=SS(),Yr.isAxiosError=wS(),xy.exports=Yr,Qc.default=Yr,function(r){r.exports=Qc}(Ly);const nd=ay(Tu);let Sm="hXgU8Wc8pwuGNq9ms5q9Hh";typeof process!="undefined"&&(sE=process==null?void 0:process.env)!=null&&sE.FLAGSMITH_ENVIRONMENT_KEY&&(Sm=process.env.FLAGSMITH_ENVIRONMENT_KEY);function PS(r=[]){const e={};return r.forEach(t=>{e[t.feature.name]={enabled:t.enabled,value:t.feature_state_value}}),e}class AS{constructor(e=Sm){f(this,"flags",{});f(this,"environmentKey",null);this.environmentKey=e,this.identify=this.identify.bind(this),this.getValue=this.getValue.bind(this),this.hasFeature=this.hasFeature.bind(this),this.getAllFlags=this.getAllFlags.bind(this)}async identify(e,t={},s=!1,i=5e3){const n=JSON.parse(JSON.stringify(t)),a=Object.entries(n).map(o=>({trait_key:o[0],trait_value:o[1]}));try{const o="_"+(Math.random()+1).toString(36).substring(2),c=await nd.post("https://edge.api.flagsmith.com/api/v1/identities/",{identifier:e+(s?o:""),traits:a},{headers:{"Content-Type":"application/json","X-Environment-Key":this.environmentKey},timeout:i});this.flags=PS(c.data.flags||[])}catch(o){}return this.flags}getValue(e){return this.flags&&this.flags[e]&&this.flags[e].value}hasFeature(e){return this.flags&&this.flags[e]&&this.flags[e].enabled}getAllFlags(){return this.flags}}const x=new AS,wm=[-2,-1,0,1,2],IS=[0,1,2,3,4];function kS(r){r=r.trim();let e="0",t="0",s="0";return r.length==4?(e="0x"+r[1]+r[1],t="0x"+r[2]+r[2],s="0x"+r[3]+r[3]):r.length>6&&(e="0x"+r[1]+r[2],t="0x"+r[3]+r[4],s="0x"+r[5]+r[6]),[+e,+t,+s]}const OS=(r,e,t)=>{let s,i,n;if(e==0)s=i=n=t;else{const a=(l,u,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?l+(u-l)*6*h:h<.5?u:h<.6666666666666666?l+(u-l)*(.6666666666666666-h)*6:l),o=t<.5?t*(1+e):t+e-t*e,c=2*t-o;s=a(c,o,r+1/3),i=a(c,o,r),n=a(c,o,r-1/3)}return[Math.round(s*255),Math.round(i*255),Math.round(n*255)]},DS=(r,e,t)=>{r/=255,e/=255,t/=255;const s=Math.max(r,e,t),i=Math.min(r,e,t);let n,a;const o=(s+i)/2;if(s==i)n=a=0;else{const c=s-i;switch(a=o>.5?c/(2-s-i):c/(s+i),s){case r:n=(e-t)/c+(e<t?6:0);break;case e:n=(t-r)/c+2;break;case t:n=(r-e)/c+4;break}n/=6}return[n,a,o]},MS=(r,e,t)=>{const s=i=>i.toString(16).padStart(2,"0");return`#${s(r)}${s(e)}${s(t)}`},Rm=(r,e=wm,t=.4)=>{const s=[],[i,n,a]=kS(r),[o,c,l]=DS(i,n,a),u=Math.round(l*100);u>70?t=.8:u>60?t=.9:u<10?t=.075:u<42&&(t=.3);const h=e.findIndex(C=>C===0);if(h===-1)throw new Error("Invalid reducer provided, it must contain atleast one zero");const p=5-h,m=h+1,v=(100-u)/p,y=u/m;for(const C of e){let k;C<0?k=u+C*y*t:C>0?k=u+C*v*t:k=u;const[D,V,M]=OS(o,c,k/100);s.push(MS(D,V,M))}return s},NS=r=>{const[e,t,s,i,n]=Rm(r,wm);return{300:e,400:t,500:s,600:i,700:n}},LS=r=>{const[e,t,s,i,n]=Rm(r,IS);return{1e3:e,900:t,800:s,700:i,600:n}};function xS(){this.__data__=[],this.size=0}function bm(r,e){return r===e||r!==r&&e!==e}function ad(r,e){for(var t=r.length;t--;)if(bm(r[t][0],e))return t;return-1}var US=Array.prototype,BS=US.splice;function FS(r){var e=this.__data__,t=ad(e,r);if(t<0)return!1;var s=e.length-1;return t==s?e.pop():BS.call(e,t,1),--this.size,!0}function VS(r){var e=this.__data__,t=ad(e,r);return t<0?void 0:e[t][1]}function $S(r){return ad(this.__data__,r)>-1}function HS(r,e){var t=this.__data__,s=ad(t,r);return s<0?(++this.size,t.push([r,e])):t[s][1]=e,this}function Ts(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var s=r[e];this.set(s[0],s[1])}}Ts.prototype.clear=xS,Ts.prototype.delete=FS,Ts.prototype.get=VS,Ts.prototype.has=$S,Ts.prototype.set=HS;function jS(){this.__data__=new Ts,this.size=0}function GS(r){var e=this.__data__,t=e.delete(r);return this.size=e.size,t}function qS(r){return this.__data__.get(r)}function KS(r){return this.__data__.has(r)}var WS=typeof global=="object"&&global&&global.Object===Object&&global;const Cm=WS;var JS=typeof self=="object"&&self&&self.Object===Object&&self,zS=Cm||JS||Function("return this")();const Dr=zS;var YS=Dr.Symbol;const Zn=YS;var Pm=Object.prototype,XS=Pm.hasOwnProperty,QS=Pm.toString,_o=Zn?Zn.toStringTag:void 0;function ZS(r){var e=XS.call(r,_o),t=r[_o];try{r[_o]=void 0;var s=!0}catch(n){}var i=QS.call(r);return s&&(e?r[_o]=t:delete r[_o]),i}var ew=Object.prototype,tw=ew.toString;function rw(r){return tw.call(r)}var sw="[object Null]",iw="[object Undefined]",Am=Zn?Zn.toStringTag:void 0;function ea(r){return r==null?r===void 0?iw:sw:Am&&Am in Object(r)?ZS(r):rw(r)}function Qs(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var nw="[object AsyncFunction]",aw="[object Function]",ow="[object GeneratorFunction]",cw="[object Proxy]";function Im(r){if(!Qs(r))return!1;var e=ea(r);return e==aw||e==ow||e==nw||e==cw}var dw=Dr["__core-js_shared__"];const ju=dw;var km=function(){var r=/[^.]+$/.exec(ju&&ju.keys&&ju.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}();function lw(r){return!!km&&km in r}var uw=Function.prototype,hw=uw.toString;function Hi(r){if(r!=null){try{return hw.call(r)}catch(e){}try{return r+""}catch(e){}}return""}var pw=/[\\^$.*+?()[\]{}|]/g,fw=/^\[object .+?Constructor\]$/,mw=Function.prototype,gw=Object.prototype,_w=mw.toString,vw=gw.hasOwnProperty,Tw=RegExp("^"+_w.call(vw).replace(pw,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Ew(r){if(!Qs(r)||lw(r))return!1;var e=Im(r)?Tw:fw;return e.test(Hi(r))}function yw(r,e){return r==null?void 0:r[e]}function ji(r,e){var t=yw(r,e);return Ew(t)?t:void 0}var Sw=ji(Dr,"Map");const vo=Sw;var ww=ji(Object,"create");const To=ww;function Rw(){this.__data__=To?To(null):{},this.size=0}function bw(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e}var Cw="__lodash_hash_undefined__",Pw=Object.prototype,Aw=Pw.hasOwnProperty;function Iw(r){var e=this.__data__;if(To){var t=e[r];return t===Cw?void 0:t}return Aw.call(e,r)?e[r]:void 0}var kw=Object.prototype,Ow=kw.hasOwnProperty;function Dw(r){var e=this.__data__;return To?e[r]!==void 0:Ow.call(e,r)}var Mw="__lodash_hash_undefined__";function Nw(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=To&&e===void 0?Mw:e,this}function Gi(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var s=r[e];this.set(s[0],s[1])}}Gi.prototype.clear=Rw,Gi.prototype.delete=bw,Gi.prototype.get=Iw,Gi.prototype.has=Dw,Gi.prototype.set=Nw;function Lw(){this.size=0,this.__data__={hash:new Gi,map:new(vo||Ts),string:new Gi}}function xw(r){var e=typeof r;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?r!=="__proto__":r===null}function od(r,e){var t=r.__data__;return xw(e)?t[typeof e=="string"?"string":"hash"]:t.map}function Uw(r){var e=od(this,r).delete(r);return this.size-=e?1:0,e}function Bw(r){return od(this,r).get(r)}function Fw(r){return od(this,r).has(r)}function Vw(r,e){var t=od(this,r),s=t.size;return t.set(r,e),this.size+=t.size==s?0:1,this}function Zs(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var s=r[e];this.set(s[0],s[1])}}Zs.prototype.clear=Lw,Zs.prototype.delete=Uw,Zs.prototype.get=Bw,Zs.prototype.has=Fw,Zs.prototype.set=Vw;var $w=200;function Hw(r,e){var t=this.__data__;if(t instanceof Ts){var s=t.__data__;if(!vo||s.length<$w-1)return s.push([r,e]),this.size=++t.size,this;t=this.__data__=new Zs(s)}return t.set(r,e),this.size=t.size,this}function ta(r){var e=this.__data__=new Ts(r);this.size=e.size}ta.prototype.clear=jS,ta.prototype.delete=GS,ta.prototype.get=qS,ta.prototype.has=KS,ta.prototype.set=Hw;function jw(r,e){for(var t=-1,s=r==null?0:r.length;++t<s&&e(r[t],t,r)!==!1;);return r}var Gw=function(){try{var r=ji(Object,"defineProperty");return r({},"",{}),r}catch(e){}}();const Om=Gw;function Dm(r,e,t){e=="__proto__"&&Om?Om(r,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):r[e]=t}var qw=Object.prototype,Kw=qw.hasOwnProperty;function Mm(r,e,t){var s=r[e];(!(Kw.call(r,e)&&bm(s,t))||t===void 0&&!(e in r))&&Dm(r,e,t)}function cd(r,e,t,s){var i=!t;t||(t={});for(var n=-1,a=e.length;++n<a;){var o=e[n],c=s?s(t[o],r[o],o,t,r):void 0;c===void 0&&(c=r[o]),i?Dm(t,o,c):Mm(t,o,c)}return t}function Ww(r,e){for(var t=-1,s=Array(r);++t<r;)s[t]=e(t);return s}function ra(r){return r!=null&&typeof r=="object"}var Jw="[object Arguments]";function Nm(r){return ra(r)&&ea(r)==Jw}var Lm=Object.prototype,zw=Lm.hasOwnProperty,Yw=Lm.propertyIsEnumerable,Xw=Nm(function(){return arguments}())?Nm:function(r){return ra(r)&&zw.call(r,"callee")&&!Yw.call(r,"callee")};const xm=Xw;var Qw=Array.isArray;const dd=Qw;function Zw(){return!1}var Um=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Bm=Um&&typeof module=="object"&&module&&!module.nodeType&&module,eR=Bm&&Bm.exports===Um,Fm=eR?Dr.Buffer:void 0,tR=Fm?Fm.isBuffer:void 0,rR=tR||Zw;const Gu=rR;var sR=9007199254740991,iR=/^(?:0|[1-9]\d*)$/;function nR(r,e){var t=typeof r;return e=e==null?sR:e,!!e&&(t=="number"||t!="symbol"&&iR.test(r))&&r>-1&&r%1==0&&r<e}var aR=9007199254740991;function Vm(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=aR}var oR="[object Arguments]",cR="[object Array]",dR="[object Boolean]",lR="[object Date]",uR="[object Error]",hR="[object Function]",pR="[object Map]",fR="[object Number]",mR="[object Object]",gR="[object RegExp]",_R="[object Set]",vR="[object String]",TR="[object WeakMap]",ER="[object ArrayBuffer]",yR="[object DataView]",SR="[object Float32Array]",wR="[object Float64Array]",RR="[object Int8Array]",bR="[object Int16Array]",CR="[object Int32Array]",PR="[object Uint8Array]",AR="[object Uint8ClampedArray]",IR="[object Uint16Array]",kR="[object Uint32Array]",Fe={};Fe[SR]=Fe[wR]=Fe[RR]=Fe[bR]=Fe[CR]=Fe[PR]=Fe[AR]=Fe[IR]=Fe[kR]=!0,Fe[oR]=Fe[cR]=Fe[ER]=Fe[dR]=Fe[yR]=Fe[lR]=Fe[uR]=Fe[hR]=Fe[pR]=Fe[fR]=Fe[mR]=Fe[gR]=Fe[_R]=Fe[vR]=Fe[TR]=!1;function OR(r){return ra(r)&&Vm(r.length)&&!!Fe[ea(r)]}function qu(r){return function(e){return r(e)}}var $m=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Eo=$m&&typeof module=="object"&&module&&!module.nodeType&&module,DR=Eo&&Eo.exports===$m,Ku=DR&&Cm.process,MR=function(){try{var r=Eo&&Eo.require&&Eo.require("util").types;return r||Ku&&Ku.binding&&Ku.binding("util")}catch(e){}}();const sa=MR;var Hm=sa&&sa.isTypedArray,NR=Hm?qu(Hm):OR;const jm=NR;var LR=Object.prototype,xR=LR.hasOwnProperty;function Gm(r,e){var t=dd(r),s=!t&&xm(r),i=!t&&!s&&Gu(r),n=!t&&!s&&!i&&jm(r),a=t||s||i||n,o=a?Ww(r.length,String):[],c=o.length;for(var l in r)(e||xR.call(r,l))&&!(a&&(l=="length"||i&&(l=="offset"||l=="parent")||n&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||nR(l,c)))&&o.push(l);return o}var UR=Object.prototype;function ld(r){var e=r&&r.constructor,t=typeof e=="function"&&e.prototype||UR;return r===t}function qm(r,e){return function(t){return r(e(t))}}var BR=qm(Object.keys,Object);const FR=BR;var VR=Object.prototype,$R=VR.hasOwnProperty;function Km(r){if(!ld(r))return FR(r);var e=[];for(var t in Object(r))$R.call(r,t)&&t!="constructor"&&e.push(t);return e}function Wu(r){return r!=null&&Vm(r.length)&&!Im(r)}function Ju(r){return Wu(r)?Gm(r):Km(r)}function HR(r,e){return r&&cd(e,Ju(e),r)}function jR(r){var e=[];if(r!=null)for(var t in Object(r))e.push(t);return e}var GR=Object.prototype,qR=GR.hasOwnProperty;function KR(r){if(!Qs(r))return jR(r);var e=ld(r),t=[];for(var s in r)s=="constructor"&&(e||!qR.call(r,s))||t.push(s);return t}function zu(r){return Wu(r)?Gm(r,!0):KR(r)}function WR(r,e){return r&&cd(e,zu(e),r)}var Wm=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Jm=Wm&&typeof module=="object"&&module&&!module.nodeType&&module,JR=Jm&&Jm.exports===Wm,zm=JR?Dr.Buffer:void 0,Ym=zm?zm.allocUnsafe:void 0;function zR(r,e){if(e)return r.slice();var t=r.length,s=Ym?Ym(t):new r.constructor(t);return r.copy(s),s}function YR(r,e){var t=-1,s=r.length;for(e||(e=Array(s));++t<s;)e[t]=r[t];return e}function XR(r,e){for(var t=-1,s=r==null?0:r.length,i=0,n=[];++t<s;){var a=r[t];e(a,t,r)&&(n[i++]=a)}return n}function Xm(){return[]}var QR=Object.prototype,ZR=QR.propertyIsEnumerable,Qm=Object.getOwnPropertySymbols,eb=Qm?function(r){return r==null?[]:(r=Object(r),XR(Qm(r),function(e){return ZR.call(r,e)}))}:Xm;const Yu=eb;function tb(r,e){return cd(r,Yu(r),e)}function Zm(r,e){for(var t=-1,s=e.length,i=r.length;++t<s;)r[i+t]=e[t];return r}var rb=qm(Object.getPrototypeOf,Object);const eg=rb;var sb=Object.getOwnPropertySymbols,ib=sb?function(r){for(var e=[];r;)Zm(e,Yu(r)),r=eg(r);return e}:Xm;const tg=ib;function nb(r,e){return cd(r,tg(r),e)}function rg(r,e,t){var s=e(r);return dd(r)?s:Zm(s,t(r))}function ab(r){return rg(r,Ju,Yu)}function ob(r){return rg(r,zu,tg)}var cb=ji(Dr,"DataView");const Xu=cb;var db=ji(Dr,"Promise");const Qu=db;var lb=ji(Dr,"Set");const Zu=lb;var ub=ji(Dr,"WeakMap");const eh=ub;var sg="[object Map]",hb="[object Object]",ig="[object Promise]",ng="[object Set]",ag="[object WeakMap]",og="[object DataView]",pb=Hi(Xu),fb=Hi(vo),mb=Hi(Qu),gb=Hi(Zu),_b=Hi(eh),qi=ea;(Xu&&qi(new Xu(new ArrayBuffer(1)))!=og||vo&&qi(new vo)!=sg||Qu&&qi(Qu.resolve())!=ig||Zu&&qi(new Zu)!=ng||eh&&qi(new eh)!=ag)&&(qi=function(r){var e=ea(r),t=e==hb?r.constructor:void 0,s=t?Hi(t):"";if(s)switch(s){case pb:return og;case fb:return sg;case mb:return ig;case gb:return ng;case _b:return ag}return e});const ud=qi;var vb=Object.prototype,Tb=vb.hasOwnProperty;function Eb(r){var e=r.length,t=new r.constructor(e);return e&&typeof r[0]=="string"&&Tb.call(r,"index")&&(t.index=r.index,t.input=r.input),t}var yb=Dr.Uint8Array;const cg=yb;function th(r){var e=new r.constructor(r.byteLength);return new cg(e).set(new cg(r)),e}function Sb(r,e){var t=e?th(r.buffer):r.buffer;return new r.constructor(t,r.byteOffset,r.byteLength)}var wb=/\w*$/;function Rb(r){var e=new r.constructor(r.source,wb.exec(r));return e.lastIndex=r.lastIndex,e}var dg=Zn?Zn.prototype:void 0,lg=dg?dg.valueOf:void 0;function bb(r){return lg?Object(lg.call(r)):{}}function Cb(r,e){var t=e?th(r.buffer):r.buffer;return new r.constructor(t,r.byteOffset,r.length)}var Pb="[object Boolean]",Ab="[object Date]",Ib="[object Map]",kb="[object Number]",Ob="[object RegExp]",Db="[object Set]",Mb="[object String]",Nb="[object Symbol]",Lb="[object ArrayBuffer]",xb="[object DataView]",Ub="[object Float32Array]",Bb="[object Float64Array]",Fb="[object Int8Array]",Vb="[object Int16Array]",$b="[object Int32Array]",Hb="[object Uint8Array]",jb="[object Uint8ClampedArray]",Gb="[object Uint16Array]",qb="[object Uint32Array]";function Kb(r,e,t){var s=r.constructor;switch(e){case Lb:return th(r);case Pb:case Ab:return new s(+r);case xb:return Sb(r,t);case Ub:case Bb:case Fb:case Vb:case $b:case Hb:case jb:case Gb:case qb:return Cb(r,t);case Ib:return new s;case kb:case Mb:return new s(r);case Ob:return Rb(r);case Db:return new s;case Nb:return bb(r)}}var ug=Object.create,Wb=function(){function r(){}return function(e){if(!Qs(e))return{};if(ug)return ug(e);r.prototype=e;var t=new r;return r.prototype=void 0,t}}();const Jb=Wb;function zb(r){return typeof r.constructor=="function"&&!ld(r)?Jb(eg(r)):{}}var Yb="[object Map]";function Xb(r){return ra(r)&&ud(r)==Yb}var hg=sa&&sa.isMap,Qb=hg?qu(hg):Xb;const Zb=Qb;var eC="[object Set]";function tC(r){return ra(r)&&ud(r)==eC}var pg=sa&&sa.isSet,rC=pg?qu(pg):tC;const sC=rC;var iC=1,nC=2,aC=4,fg="[object Arguments]",oC="[object Array]",cC="[object Boolean]",dC="[object Date]",lC="[object Error]",mg="[object Function]",uC="[object GeneratorFunction]",hC="[object Map]",pC="[object Number]",gg="[object Object]",fC="[object RegExp]",mC="[object Set]",gC="[object String]",_C="[object Symbol]",vC="[object WeakMap]",TC="[object ArrayBuffer]",EC="[object DataView]",yC="[object Float32Array]",SC="[object Float64Array]",wC="[object Int8Array]",RC="[object Int16Array]",bC="[object Int32Array]",CC="[object Uint8Array]",PC="[object Uint8ClampedArray]",AC="[object Uint16Array]",IC="[object Uint32Array]",Le={};Le[fg]=Le[oC]=Le[TC]=Le[EC]=Le[cC]=Le[dC]=Le[yC]=Le[SC]=Le[wC]=Le[RC]=Le[bC]=Le[hC]=Le[pC]=Le[gg]=Le[fC]=Le[mC]=Le[gC]=Le[_C]=Le[CC]=Le[PC]=Le[AC]=Le[IC]=!0,Le[lC]=Le[mg]=Le[vC]=!1;function hd(r,e,t,s,i,n){var a,o=e&iC,c=e&nC,l=e&aC;if(t&&(a=i?t(r,s,i,n):t(r)),a!==void 0)return a;if(!Qs(r))return r;var u=dd(r);if(u){if(a=Eb(r),!o)return YR(r,a)}else{var h=ud(r),p=h==mg||h==uC;if(Gu(r))return zR(r,o);if(h==gg||h==fg||p&&!i){if(a=c||p?{}:zb(r),!o)return c?nb(r,WR(a,r)):tb(r,HR(a,r))}else{if(!Le[h])return i?r:{};a=Kb(r,h,o)}}n||(n=new ta);var m=n.get(r);if(m)return m;n.set(r,a),sC(r)?r.forEach(function(C){a.add(hd(C,e,t,C,r,n))}):Zb(r)&&r.forEach(function(C,k){a.set(k,hd(C,e,t,k,r,n))});var v=l?c?ob:ab:c?zu:Ju,y=u?void 0:v(r);return jw(y||r,function(C,k){y&&(k=C,C=r[k]),Mm(a,k,hd(C,e,t,k,r,n))}),a}var kC=1,OC=4;function rh(r){return hd(r,kC|OC)}var DC="[object Symbol]";function MC(r){return typeof r=="symbol"||ra(r)&&ea(r)==DC}var NC="Expected a function";function pd(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError(NC);var t=function(){var s=arguments,i=e?e.apply(this,s):s[0],n=t.cache;if(n.has(i))return n.get(i);var a=r.apply(this,s);return t.cache=n.set(i,a)||n,a};return t.cache=new(pd.Cache||Zs),t}pd.Cache=Zs;var xt;(function(r){r.GroupCall="GROUP_CALL",r.Webinar="WEBINAR",r.AudioRoom="AUDIO_ROOM",r.Livestream="LIVESTREAM",r.Chat="CHAT"})(xt||(xt={}));var fd;(function(r){r.Skip="SKIP",r.OnPrivilegedUserEntry="ON_PRIVILEGED_USER_ENTRY",r.SkipOnAccept="SKIP_ON_ACCEPT"})(fd||(fd={}));var At;(function(r){r.Allowed="ALLOWED",r.NotAllowed="NOT_ALLOWED",r.CanRequest="CAN_REQUEST"})(At||(At={}));var md;(function(r){r.Allowed="ALLOWED",r.NotAllowed="NOT_ALLOWED"})(md||(md={}));var _g;(function(r){r.FULL_ACCESS="FULL_ACCESS",r.VIEW_ONLY="VIEW_ONLY"})(_g||(_g={}));const LC={border_radius:"rounded",border_width:"thin",spacing_base:4,theme:"dark",colors:{brand:NS("#2160FD"),background:LS("#141414"),danger:"#FF2D2D",text:"#EEEEEE",text_on_brand:"#EEEEEE",success:"#62A504",video_bg:"#191919",warning:"#FFCD07"}};function vg(){return rh(LC)}const xC={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:fd.Skip,plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:At.Allowed,can_consume:md.Allowed},audio:{can_produce:At.Allowed},screenshare:{can_produce:At.Allowed,can_consume:md.Allowed}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},hidden_participant:!1,is_recorder:!1,recorder_type:$i.none,show_participant_list:!0,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1}},ui:{oldTheme:{setup_screen:{is_enabled:!1},alone_here:{is_enabled:!1},waiting_room:{is_enabled:!1,enable_preview:!0},control_bar:{is_enabled:!0,elements:{plugins:!0,screenshare:!0,invite:!1,participants:!0,chat:!0,reactions:!1,polls:!0,fullscreen:!0,layout:!0}},header:{is_enabled:!0,elements:{timer:!0,title:!0,participant_count:!0,change_layout:!0}},pip_mode:!0,auto_tune:!0,colors:{primary:"#2160FD",secondary:"#1A1A1A",text:"#EEEEEE",background:"#1A1A1A",textPrimary:"#EEEEEE",videoBackground:"#1A1A1A"},dimensions:{mode:"fillParent"},grid:{multi:{maxVideoCount:6,videoFit:"cover"},single:{maxVideoCount:6,videoFit:"cover"},defaultView:"MULTI"},controls:{pip_toggle:!1},plugins:[]},design_tokens:vg(),config_diff:{}},config:{view_type:xt.GroupCall,media:{video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"hybrid"};function UC(){return rh(xC)}$i.none,mo.skip;const BC={permissions:{can_accept_production_requests:!1,can_edit_display_name:!0,accept_waiting_requests:!1,disable_participant_audio:!1,disable_participant_screensharing:!1,disable_participant_video:!1,can_spotlight:!1,kick_participant:!1,pin_participant:!1,can_record:!1,can_livestream:!1,waiting_room_type:fd.Skip,plugins:{can_close:!0,can_start:!0,can_edit_config:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},media:{video:{can_produce:At.Allowed},audio:{can_produce:At.Allowed},screenshare:{can_produce:At.Allowed}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},hidden_participant:!1,is_recorder:!1,recorder_type:$i.none,show_participant_list:!0,can_change_participant_permissions:!1,connected_meetings:{can_alter_connected_meetings:!1,can_switch_connected_meetings:!1,can_switch_to_parent_meeting:!1}},ui:{design_tokens:vg(),config_diff:{}},config:{view_type:xt.GroupCall,media:{video:{quality:"vga",frame_rate:24},screenshare:{quality:"hd",frame_rate:5}},max_video_streams:{mobile:6,desktop:6},max_screenshare_count:1},version:"2.0.0"};function sh(){return rh(BC)}var Tr={},FC={get exports(){return Tr},set exports(r){Tr=r}},ih,Tg;function VC(){if(Tg)return ih;Tg=1;var r=1e3,e=r*60,t=e*60,s=t*24,i=s*7,n=s*365.25;ih=function(u,h){h=h||{};var p=typeof u;if(p==="string"&&u.length>0)return a(u);if(p==="number"&&isFinite(u))return h.long?c(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function a(u){if(u=String(u),!(u.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(h){var p=parseFloat(h[1]),m=(h[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return p*n;case"weeks":case"week":case"w":return p*i;case"days":case"day":case"d":return p*s;case"hours":case"hour":case"hrs":case"hr":case"h":return p*t;case"minutes":case"minute":case"mins":case"min":case"m":return p*e;case"seconds":case"second":case"secs":case"sec":case"s":return p*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function o(u){var h=Math.abs(u);return h>=s?Math.round(u/s)+"d":h>=t?Math.round(u/t)+"h":h>=e?Math.round(u/e)+"m":h>=r?Math.round(u/r)+"s":u+"ms"}function c(u){var h=Math.abs(u);return h>=s?l(u,h,s,"day"):h>=t?l(u,h,t,"hour"):h>=e?l(u,h,e,"minute"):h>=r?l(u,h,r,"second"):u+" ms"}function l(u,h,p,m){var v=h>=p*1.5;return Math.round(u/p)+" "+m+(v?"s":"")}return ih}function $C(r){t.debug=t,t.default=t,t.coerce=c,t.disable=n,t.enable=i,t.enabled=a,t.humanize=VC(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let p=0;p<u.length;p++)h=(h<<5)-h+u.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,p=null,m,v;function y(...C){if(!y.enabled)return;const k=y,D=Number(new Date),V=D-(h||D);k.diff=V,k.prev=h,k.curr=D,h=D,C[0]=t.coerce(C[0]),typeof C[0]!="string"&&C.unshift("%O");let M=0;C[0]=C[0].replace(/%([a-zA-Z%])/g,(W,Se)=>{if(W==="%%")return"%";M++;const lt=t.formatters[Se];if(typeof lt=="function"){const or=C[M];W=lt.call(k,or),C.splice(M,1),M--}return W}),t.formatArgs.call(k,C),(k.log||t.log).apply(k,C)}return y.namespace=u,y.useColors=t.useColors(),y.color=t.selectColor(u),y.extend=s,y.destroy=t.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(m!==t.namespaces&&(m=t.namespaces,v=t.enabled(u)),v),set:C=>{p=C}}),typeof t.init=="function"&&t.init(y),y}function s(u,h){const p=t(this.namespace+(typeof h=="undefined"?":":h)+u);return p.log=this.log,p}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h;const p=(typeof u=="string"?u:"").split(/[\s,]+/),m=p.length;for(h=0;h<m;h++)p[h]&&(u=p[h].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.slice(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function n(){const u=[...t.names.map(o),...t.skips.map(o).map(h=>"-"+h)].join(",");return t.enable(""),u}function a(u){if(u[u.length-1]==="*")return!0;let h,p;for(h=0,p=t.skips.length;h<p;h++)if(t.skips[h].test(u))return!1;for(h=0,p=t.names.length;h<p;h++)if(t.names[h].test(u))return!0;return!1}function o(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var HC=$C;(function(r,e){e.formatArgs=s,e.save=i,e.load=n,e.useColors=t,e.storage=a(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function t(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+r.exports.humanize(this.diff),!this.useColors)return;const l="color: "+this.color;c.splice(1,0,l,"color: inherit");let u=0,h=0;c[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(u++,p==="%c"&&(h=u))}),c.splice(h,0,l)}e.log=console.debug||console.log||(()=>{});function i(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch(l){}}function n(){let c;try{c=e.storage.getItem("debug")}catch(l){}return!c&&typeof process!="undefined"&&"env"in process&&(c=process.env.DEBUG),c}function a(){try{return localStorage}catch(c){}}r.exports=HC(e);const{formatters:o}=r.exports;o.j=function(c){try{return JSON.stringify(c)}catch(l){return"[UnexpectedJSONParseError]: "+l.message}}})(FC,Tr);const jC={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},Eg={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},Ze={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},zt={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},ei={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class O{static getFirstMatch(e,t){const s=t.match(e);return s&&s.length>0&&s[1]||""}static getSecondMatch(e,t){const s=t.match(e);return s&&s.length>1&&s[2]||""}static matchAndReturnConst(e,t,s){if(e.test(t))return s}static getWindowsVersionName(e){switch(e){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(e){const t=e.split(".").splice(0,2).map(s=>parseInt(s,10)||0);if(t.push(0),t[0]===10)switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(e){const t=e.split(".").splice(0,2).map(s=>parseInt(s,10)||0);if(t.push(0),!(t[0]===1&&t[1]<5)){if(t[0]===1&&t[1]<6)return"Cupcake";if(t[0]===1&&t[1]>=6)return"Donut";if(t[0]===2&&t[1]<2)return"Eclair";if(t[0]===2&&t[1]===2)return"Froyo";if(t[0]===2&&t[1]>2)return"Gingerbread";if(t[0]===3)return"Honeycomb";if(t[0]===4&&t[1]<1)return"Ice Cream Sandwich";if(t[0]===4&&t[1]<4)return"Jelly Bean";if(t[0]===4&&t[1]>=4)return"KitKat";if(t[0]===5)return"Lollipop";if(t[0]===6)return"Marshmallow";if(t[0]===7)return"Nougat";if(t[0]===8)return"Oreo";if(t[0]===9)return"Pie"}}static getVersionPrecision(e){return e.split(".").length}static compareVersions(e,t,s=!1){const i=O.getVersionPrecision(e),n=O.getVersionPrecision(t);let a=Math.max(i,n),o=0;const c=O.map([e,t],l=>{const u=a-O.getVersionPrecision(l),h=l+new Array(u+1).join(".0");return O.map(h.split("."),p=>new Array(20-p.length).join("0")+p).reverse()});for(s&&(o=a-Math.min(i,n)),a-=1;a>=o;){if(c[0][a]>c[1][a])return 1;if(c[0][a]===c[1][a]){if(a===o)return 0;a-=1}else if(c[0][a]<c[1][a])return-1}}static map(e,t){const s=[];let i;if(Array.prototype.map)return Array.prototype.map.call(e,t);for(i=0;i<e.length;i+=1)s.push(t(e[i]));return s}static find(e,t){let s,i;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(s=0,i=e.length;s<i;s+=1){const n=e[s];if(t(n,s))return n}}static assign(e,...t){const s=e;let i,n;if(Object.assign)return Object.assign(e,...t);for(i=0,n=t.length;i<n;i+=1){const a=t[i];typeof a=="object"&&a!==null&&Object.keys(a).forEach(c=>{s[c]=a[c]})}return e}static getBrowserAlias(e){return jC[e]}static getBrowserTypeByAlias(e){return Eg[e]||""}}const Me=/version\/(\d+(\.?_?\d+)+)/i,GC=[{test:[/googlebot/i],describe(r){const e={name:"Googlebot"},t=O.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/opera/i],describe(r){const e={name:"Opera"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/opr\/|opios/i],describe(r){const e={name:"Opera"},t=O.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/SamsungBrowser/i],describe(r){const e={name:"Samsung Internet for Android"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/Whale/i],describe(r){const e={name:"NAVER Whale Browser"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/MZBrowser/i],describe(r){const e={name:"MZ Browser"},t=O.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/focus/i],describe(r){const e={name:"Focus"},t=O.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/swing/i],describe(r){const e={name:"Swing"},t=O.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/coast/i],describe(r){const e={name:"Opera Coast"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(r){const e={name:"Opera Touch"},t=O.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/yabrowser/i],describe(r){const e={name:"Yandex Browser"},t=O.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/ucbrowser/i],describe(r){const e={name:"UC Browser"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/Maxthon|mxios/i],describe(r){const e={name:"Maxthon"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/epiphany/i],describe(r){const e={name:"Epiphany"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/puffin/i],describe(r){const e={name:"Puffin"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/sleipnir/i],describe(r){const e={name:"Sleipnir"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/k-meleon/i],describe(r){const e={name:"K-Meleon"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/micromessenger/i],describe(r){const e={name:"WeChat"},t=O.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/qqbrowser/i],describe(r){const e={name:/qqbrowserlite/i.test(r)?"QQ Browser Lite":"QQ Browser"},t=O.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/msie|trident/i],describe(r){const e={name:"Internet Explorer"},t=O.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/\sedg\//i],describe(r){const e={name:"Microsoft Edge"},t=O.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/edg([ea]|ios)/i],describe(r){const e={name:"Microsoft Edge"},t=O.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/vivaldi/i],describe(r){const e={name:"Vivaldi"},t=O.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/seamonkey/i],describe(r){const e={name:"SeaMonkey"},t=O.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/sailfish/i],describe(r){const e={name:"Sailfish"},t=O.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,r);return t&&(e.version=t),e}},{test:[/silk/i],describe(r){const e={name:"Amazon Silk"},t=O.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/phantom/i],describe(r){const e={name:"PhantomJS"},t=O.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/slimerjs/i],describe(r){const e={name:"SlimerJS"},t=O.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(r){const e={name:"BlackBerry"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/(web|hpw)[o0]s/i],describe(r){const e={name:"WebOS Browser"},t=O.getFirstMatch(Me,r)||O.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/bada/i],describe(r){const e={name:"Bada"},t=O.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/tizen/i],describe(r){const e={name:"Tizen"},t=O.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/qupzilla/i],describe(r){const e={name:"QupZilla"},t=O.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/firefox|iceweasel|fxios/i],describe(r){const e={name:"Firefox"},t=O.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/electron/i],describe(r){const e={name:"Electron"},t=O.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/MiuiBrowser/i],describe(r){const e={name:"Miui"},t=O.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/chromium/i],describe(r){const e={name:"Chromium"},t=O.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,r)||O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/chrome|crios|crmo/i],describe(r){const e={name:"Chrome"},t=O.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/GSA/i],describe(r){const e={name:"Google Search"},t=O.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test(r){const e=!r.test(/like android/i),t=r.test(/android/i);return e&&t},describe(r){const e={name:"Android Browser"},t=O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/playstation 4/i],describe(r){const e={name:"PlayStation 4"},t=O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/safari|applewebkit/i],describe(r){const e={name:"Safari"},t=O.getFirstMatch(Me,r);return t&&(e.version=t),e}},{test:[/.*/i],describe(r){const e=/^(.*)\/(.*) /,t=/^(.*)\/(.*)[ \t]\((.*)/,i=r.search("\\(")!==-1?t:e;return{name:O.getFirstMatch(i,r),version:O.getSecondMatch(i,r)}}}],qC=[{test:[/Roku\/DVP/],describe(r){const e=O.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,r);return{name:zt.Roku,version:e}}},{test:[/windows phone/i],describe(r){const e=O.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,r);return{name:zt.WindowsPhone,version:e}}},{test:[/windows /i],describe(r){const e=O.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,r),t=O.getWindowsVersionName(e);return{name:zt.Windows,version:e,versionName:t}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(r){const e={name:zt.iOS},t=O.getSecondMatch(/(Version\/)(\d[\d.]+)/,r);return t&&(e.version=t),e}},{test:[/macintosh/i],describe(r){const e=O.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,r).replace(/[_\s]/g,"."),t=O.getMacOSVersionName(e),s={name:zt.MacOS,version:e};return t&&(s.versionName=t),s}},{test:[/(ipod|iphone|ipad)/i],describe(r){const e=O.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,r).replace(/[_\s]/g,".");return{name:zt.iOS,version:e}}},{test(r){const e=!r.test(/like android/i),t=r.test(/android/i);return e&&t},describe(r){const e=O.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,r),t=O.getAndroidVersionName(e),s={name:zt.Android,version:e};return t&&(s.versionName=t),s}},{test:[/(web|hpw)[o0]s/i],describe(r){const e=O.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,r),t={name:zt.WebOS};return e&&e.length&&(t.version=e),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(r){const e=O.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,r)||O.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,r)||O.getFirstMatch(/\bbb(\d+)/i,r);return{name:zt.BlackBerry,version:e}}},{test:[/bada/i],describe(r){const e=O.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,r);return{name:zt.Bada,version:e}}},{test:[/tizen/i],describe(r){const e=O.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,r);return{name:zt.Tizen,version:e}}},{test:[/linux/i],describe(){return{name:zt.Linux}}},{test:[/CrOS/],describe(){return{name:zt.ChromeOS}}},{test:[/PlayStation 4/],describe(r){const e=O.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,r);return{name:zt.PlayStation4,version:e}}}],KC=[{test:[/googlebot/i],describe(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe(r){const e=O.getFirstMatch(/(can-l01)/i,r)&&"Nova",t={type:Ze.mobile,vendor:"Huawei"};return e&&(t.model=e),t}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe(){return{type:Ze.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe(){return{type:Ze.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(){return{type:Ze.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe(){return{type:Ze.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe(){return{type:Ze.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe(){return{type:Ze.tablet}}},{test(r){const e=r.test(/ipod|iphone/i),t=r.test(/like (ipod|iphone)/i);return e&&!t},describe(r){const e=O.getFirstMatch(/(ipod|iphone)/i,r);return{type:Ze.mobile,vendor:"Apple",model:e}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe(){return{type:Ze.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe(){return{type:Ze.mobile}}},{test(r){return r.getBrowserName(!0)==="blackberry"},describe(){return{type:Ze.mobile,vendor:"BlackBerry"}}},{test(r){return r.getBrowserName(!0)==="bada"},describe(){return{type:Ze.mobile}}},{test(r){return r.getBrowserName()==="windows phone"},describe(){return{type:Ze.mobile,vendor:"Microsoft"}}},{test(r){const e=Number(String(r.getOSVersion()).split(".")[0]);return r.getOSName(!0)==="android"&&e>=3},describe(){return{type:Ze.tablet}}},{test(r){return r.getOSName(!0)==="android"},describe(){return{type:Ze.mobile}}},{test(r){return r.getOSName(!0)==="macos"},describe(){return{type:Ze.desktop,vendor:"Apple"}}},{test(r){return r.getOSName(!0)==="windows"},describe(){return{type:Ze.desktop}}},{test(r){return r.getOSName(!0)==="linux"},describe(){return{type:Ze.desktop}}},{test(r){return r.getOSName(!0)==="playstation 4"},describe(){return{type:Ze.tv}}},{test(r){return r.getOSName(!0)==="roku"},describe(){return{type:Ze.tv}}}],WC=[{test(r){return r.getBrowserName(!0)==="microsoft edge"},describe(r){if(/\sedg\//i.test(r))return{name:ei.Blink};const t=O.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,r);return{name:ei.EdgeHTML,version:t}}},{test:[/trident/i],describe(r){const e={name:ei.Trident},t=O.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test(r){return r.test(/presto/i)},describe(r){const e={name:ei.Presto},t=O.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test(r){const e=r.test(/gecko/i),t=r.test(/like gecko/i);return e&&!t},describe(r){const e={name:ei.Gecko},t=O.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}},{test:[/(apple)?webkit\/537\.36/i],describe(){return{name:ei.Blink}}},{test:[/(apple)?webkit/i],describe(r){const e={name:ei.WebKit},t=O.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,r);return t&&(e.version=t),e}}];class yg{constructor(e,t=!1){if(e==null||e==="")throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},t!==!0&&this.parse()}getUA(){return this._ua}test(e){return e.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const e=O.find(GC,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(s=>this.test(s));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.browser=e.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const e=O.find(qC,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(s=>this.test(s));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.os=e.describe(this.getUA())),this.parsedResult.os}getOSName(e){const{name:t}=this.getOS();return e?String(t).toLowerCase()||"":t||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(e=!1){const{type:t}=this.getPlatform();return e?String(t).toLowerCase()||"":t||""}parsePlatform(){this.parsedResult.platform={};const e=O.find(KC,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(s=>this.test(s));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.platform=e.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const e=O.find(WC,t=>{if(typeof t.test=="function")return t.test(this);if(t.test instanceof Array)return t.test.some(s=>this.test(s));throw new Error("Browser's test function is not valid")});return e&&(this.parsedResult.engine=e.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return O.assign({},this.parsedResult)}satisfies(e){const t={};let s=0;const i={};let n=0;if(Object.keys(e).forEach(o=>{const c=e[o];typeof c=="string"?(i[o]=c,n+=1):typeof c=="object"&&(t[o]=c,s+=1)}),s>0){const o=Object.keys(t),c=O.find(o,u=>this.isOS(u));if(c){const u=this.satisfies(t[c]);if(u!==void 0)return u}const l=O.find(o,u=>this.isPlatform(u));if(l){const u=this.satisfies(t[l]);if(u!==void 0)return u}}if(n>0){const o=Object.keys(i),c=O.find(o,l=>this.isBrowser(l,!0));if(c!==void 0)return this.compareVersion(i[c])}}isBrowser(e,t=!1){const s=this.getBrowserName().toLowerCase();let i=e.toLowerCase();const n=O.getBrowserTypeByAlias(i);return t&&n&&(i=n.toLowerCase()),i===s}compareVersion(e){let t=[0],s=e,i=!1;const n=this.getBrowserVersion();if(typeof n=="string")return e[0]===">"||e[0]==="<"?(s=e.substr(1),e[1]==="="?(i=!0,s=e.substr(2)):t=[],e[0]===">"?t.push(1):t.push(-1)):e[0]==="="?s=e.substr(1):e[0]==="~"&&(i=!0,s=e.substr(1)),t.indexOf(O.compareVersions(n,s,i))>-1}isOS(e){return this.getOSName(!0)===String(e).toLowerCase()}isPlatform(e){return this.getPlatformType(!0)===String(e).toLowerCase()}isEngine(e){return this.getEngineName(!0)===String(e).toLowerCase()}is(e,t=!1){return this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)}some(e=[]){return e.some(t=>this.is(t))}}/*!
 * Bowser - a browser detector
 * https://github.com/lancedikson/bowser
 * MIT License | (c) Dustin Diaz 2012-2015
 * MIT License | (c) Denis Demchenko 2015-2019
 */class nh{static getParser(e,t=!1){if(typeof e!="string")throw new Error("UserAgent should be a string");return new yg(e,t)}static parse(e){return new yg(e).getResult()}static get BROWSER_MAP(){return Eg}static get ENGINE_MAP(){return ei}static get OS_MAP(){return zt}static get PLATFORMS_MAP(){return Ze}}const ia="mediasoup-client";let tr=class{constructor(e){e?(this._debug=Tr(`${ia}:${e}`),this._warn=Tr(`${ia}:WARN:${e}`),this._error=Tr(`${ia}:ERROR:${e}`)):(this._debug=Tr(ia),this._warn=Tr(`${ia}:WARN`),this._error=Tr(`${ia}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};const JC=new tr("EnhancedEventEmitter");let Er=class extends Jt.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){const s=super.listenerCount(e);try{return super.emit(e,...t)}catch(i){return JC.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,i),Boolean(s)}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}},rr=class VE extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,VE):this.stack=new Error(e).stack}},$e=class $E extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,$E):this.stack=new Error(e).stack}};function pt(r,e){return typeof r=="undefined"?e:JSON.parse(JSON.stringify(r))}function ah(){return Math.round(Math.random()*1e7)}var oh={};(function(r){const e=Tr("h264-profile-level-id");e.log=console.info.bind(console);const t=1,s=2,i=3,n=4,a=5;r.ProfileConstrainedBaseline=t,r.ProfileBaseline=s,r.ProfileMain=i,r.ProfileConstrainedHigh=n,r.ProfileHigh=a;const o=0,c=10,l=11,u=12,h=13,p=20,m=21,v=22,y=30,C=31,k=32,D=40,V=41,M=42,Pe=50,W=51,Se=52;r.Level1_b=o,r.Level1=c,r.Level1_1=l,r.Level1_2=u,r.Level1_3=h,r.Level2=p,r.Level2_1=m,r.Level2_2=v,r.Level3=y,r.Level3_1=C,r.Level3_2=k,r.Level4=D,r.Level4_1=V,r.Level4_2=M,r.Level5=Pe,r.Level5_1=W,r.Level5_2=Se;class lt{constructor(F,qe){this.profile=F,this.level=qe}}r.ProfileLevelId=lt;const or=new lt(t,C),Ge=16;class Ie{constructor(F){this._mask=~_r("x",F),this._maskedValue=_r("1",F)}isMatch(F){return this._maskedValue===(F&this._mask)}}class ut{constructor(F,qe,cr){this.profile_idc=F,this.profile_iop=qe,this.profile=cr}}const Ks=[new ut(66,new Ie("x1xx0000"),t),new ut(77,new Ie("1xxx0000"),t),new ut(88,new Ie("11xx0000"),t),new ut(66,new Ie("x0xx0000"),s),new ut(88,new Ie("10xx0000"),s),new ut(77,new Ie("0x0x0000"),i),new ut(100,new Ie("00000000"),a),new ut(100,new Ie("00001100"),n)];r.parseProfileLevelId=function(se){if(typeof se!="string"||se.length!==6)return null;const F=parseInt(se,16);if(F===0)return null;const qe=F&255,cr=F>>8&255,uo=F>>16&255;let Ws;switch(qe){case l:{Ws=cr&Ge?o:l;break}case c:case u:case h:case p:case m:case v:case y:case C:case k:case D:case V:case M:case Pe:case W:case Se:{Ws=qe;break}default:return e("parseProfileLevelId() | unrecognized level_idc:%s",qe),null}for(const Vi of Ks)if(uo===Vi.profile_idc&&Vi.profile_iop.isMatch(cr))return new lt(Vi.profile,Ws);return e("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},r.profileLevelIdToString=function(se){if(se.level==o)switch(se.profile){case t:return"42f00b";case s:return"42100b";case i:return"4d100b";default:return e("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",se.profile),null}let F;switch(se.profile){case t:{F="42e0";break}case s:{F="4200";break}case i:{F="4d00";break}case n:{F="640c";break}case a:{F="6400";break}default:return e("profileLevelIdToString() | unrecognized profile:%s",se.profile),null}let qe=se.level.toString(16);return qe.length===1&&(qe=`0${qe}`),`${F}${qe}`},r.parseSdpProfileLevelId=function(se={}){const F=se["profile-level-id"];return F?r.parseProfileLevelId(F):or},r.isSameProfile=function(se={},F={}){const qe=r.parseSdpProfileLevelId(se),cr=r.parseSdpProfileLevelId(F);return Boolean(qe&&cr&&qe.profile===cr.profile)},r.generateProfileLevelIdForAnswer=function(se={},F={}){if(!se["profile-level-id"]&&!F["profile-level-id"])return e("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const qe=r.parseSdpProfileLevelId(se),cr=r.parseSdpProfileLevelId(F);if(!qe)throw new TypeError("invalid local_profile_level_id");if(!cr)throw new TypeError("invalid remote_profile_level_id");if(qe.profile!==cr.profile)throw new TypeError("H264 Profile mismatch");const uo=De(se)&&De(F),Ws=qe.level,Vi=cr.level,uu=lu(Ws,Vi),Gc=uo?Ws:uu;return e("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",qe.profile,Gc),r.profileLevelIdToString(new lt(qe.profile,Gc))};function _r(se,F){return(F[0]===se)<<7|(F[1]===se)<<6|(F[2]===se)<<5|(F[3]===se)<<4|(F[4]===se)<<3|(F[5]===se)<<2|(F[6]===se)<<1|(F[7]===se)<<0}function du(se,F){return se===o?F!==c&&F!==o:F===o?se!==c:se<F}function lu(se,F){return du(se,F)?se:F}function De(se={}){const F=se["level-asymmetry-allowed"];return F===1||F==="1"}})(oh);const zC="probator",YC=1234,XC=127;function ch(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(const e of r.codecs)QC(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const e of r.headerExtensions)ZC(e)}function QC(r){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(r.kind=t[1].toLowerCase(),r.preferredPayloadType&&typeof r.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const s of Object.keys(r.parameters)){let i=r.parameters[s];if(i===void 0&&(r.parameters[s]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${s}s, value:${i}]`);if(s==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const s of r.rtcpFeedback)Sg(s)}function Sg(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}function ZC(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}function dh(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(const e of r.codecs)eP(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const e of r.headerExtensions)tP(e);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(const e of r.encodings)rP(e);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),sP(r.rtcp)}function eP(r){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const i of r.rtcpFeedback)Sg(i)}function tP(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const e of Object.keys(r.parameters)){let t=r.parameters[e];if(t===void 0&&(r.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}function rP(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function sP(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}function iP(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");nP(r.numStreams)}function nP(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}function wg(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof r.ordered=="boolean"?e=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}function aP(r,e){const t={codecs:[],headerExtensions:[]};for(const s of e.codecs||[]){if(yo(s))continue;const i=(r.codecs||[]).find(a=>bg(a,s,{strict:!0,modify:!0}));if(!i)continue;const n={mimeType:i.mimeType,kind:i.kind,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:s.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters,remoteParameters:s.parameters,rtcpFeedback:uP(i,s)};t.codecs.push(n)}for(const s of t.codecs){const i=r.codecs.find(a=>yo(a)&&a.parameters.apt===s.localPayloadType),n=e.codecs.find(a=>yo(a)&&a.parameters.apt===s.remotePayloadType);i&&n&&(s.localRtxPayloadType=i.preferredPayloadType,s.remoteRtxPayloadType=n.preferredPayloadType)}for(const s of e.headerExtensions){const i=r.headerExtensions.find(a=>lP(a,s));if(!i)continue;const n={kind:s.kind,uri:s.uri,sendId:i.preferredId,recvId:s.preferredId,encrypt:i.preferredEncrypt,direction:"sendrecv"};switch(s.direction){case"sendrecv":n.direction="sendrecv";break;case"recvonly":n.direction="sendonly";break;case"sendonly":n.direction="recvonly";break;case"inactive":n.direction="inactive";break}t.headerExtensions.push(n)}return t}function oP(r){const e={codecs:[],headerExtensions:[]};for(const t of r.codecs){const s={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(s),!t.remoteRtxPayloadType)continue;const i={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(i)}for(const t of r.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;const s={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(s)}return e}function yr(r,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of e.codecs){if(s.kind!==r)continue;const i={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.localParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(i),s.localRtxPayloadType){const n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;const i={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(i)}return t}function Xr(r,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of e.codecs){if(s.kind!==r)continue;const i={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.remoteParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(i),s.localRtxPayloadType){const n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;const i={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(i)}if(t.headerExtensions.some(s=>s.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="goog-remb");else if(t.headerExtensions.some(s=>s.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc");else for(const s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return t}function Mr(r,e){const t=[];if(!e)t.push(r[0]),yo(r[1])&&t.push(r[1]);else{for(let s=0;s<r.length;++s)if(bg(r[s],e)){t.push(r[s]),yo(r[s+1])&&t.push(r[s+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}function cP(r){r=pt(r,{}),dh(r);const e={mid:zC,codecs:[],headerExtensions:[],encodings:[{ssrc:YC}],rtcp:{cname:"probator"}};return e.codecs.push(r.codecs[0]),e.codecs[0].payloadType=XC,e.headerExtensions=r.headerExtensions,e}function Rg(r,e){return e.codecs.some(t=>t.kind===r)}function dP(r,e){if(dh(r),r.codecs.length===0)return!1;const t=r.codecs[0];return e.codecs.some(s=>s.remotePayloadType===t.payloadType)}function yo(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function bg(r,e,{strict:t=!1,modify:s=!1}={}){const i=r.mimeType.toLowerCase(),n=e.mimeType.toLowerCase();if(i!==n||r.clockRate!==e.clockRate||r.channels!==e.channels)return!1;switch(i){case"video/h264":{if(t){const a=r.parameters["packetization-mode"]||0,o=e.parameters["packetization-mode"]||0;if(a!==o||!oh.isSameProfile(r.parameters,e.parameters))return!1;let c;try{c=oh.generateProfileLevelIdForAnswer(r.parameters,e.parameters)}catch(l){return!1}s&&(c?(r.parameters["profile-level-id"]=c,e.parameters["profile-level-id"]=c):(delete r.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){const a=r.parameters["profile-id"]||0,o=e.parameters["profile-id"]||0;if(a!==o)return!1}break}}return!0}function lP(r,e){return!(r.kind&&e.kind&&r.kind!==e.kind||r.uri!==e.uri)}function uP(r,e){const t=[];for(const s of r.rtcpFeedback||[]){const i=(e.rtcpFeedback||[]).find(n=>n.type===s.type&&(n.parameter===s.parameter||!n.parameter&&!s.parameter));i&&t.push(i)}return t}var Ki={},gd={},hP=zs&&zs.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(gd,"__esModule",{value:!0}),gd.Logger=void 0;const na=hP(Tr),aa="awaitqueue";let pP=class{constructor(e){e?(this._debug=(0,na.default)(`${aa}:${e}`),this._warn=(0,na.default)(`${aa}:WARN:${e}`),this._error=(0,na.default)(`${aa}:ERROR:${e}`)):(this._debug=(0,na.default)(aa),this._warn=(0,na.default)(`${aa}:WARN`),this._error=(0,na.default)(`${aa}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};gd.Logger=pP,Object.defineProperty(Ki,"__esModule",{value:!0});var Cg=Ki.AwaitQueue=Ki.AwaitQueueRemovedTaskError=Ki.AwaitQueueStoppedError=void 0;const fP=gd,ti=new fP.Logger;let mP=class HE extends Error{constructor(e){super(e!=null?e:"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,HE)}};Ki.AwaitQueueStoppedError=mP;let Pg=class jE extends Error{constructor(e){super(e!=null?e:"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,jE)}};Ki.AwaitQueueRemovedTaskError=Pg;let gP=class{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(e,t){if(t=t!=null?t:e.name,ti.debug(`push() [name:${t}]`),typeof e!="function")throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch(s){}return new Promise((s,i)=>{const n={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),ti.debug(`resolving task [name:${n.name}]`),s(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),ti.debug(`rejecting task [name:${n.name}]: %s`,String(a)),i(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){ti.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())ti.debug(`stop() | stopping task [name:${e.name}]`);this.stopping=!1}remove(e){ti.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];if(!t){ti.debug(`stop() | no task with given idx [taskIdx:${e}]`);return}t.reject(new Pg)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map(s=>({idx:t++,task:s.task,name:s.name,enqueuedTime:s.executedAt?s.executedAt-s.enqueuedAt:e-s.enqueuedAt,executionTime:s.executedAt?e-s.executedAt:0}))}async execute(e){if(ti.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=await e.task();e.resolve(t)}catch(t){e.reject(t)}}};Cg=Ki.AwaitQueue=gP;/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let Ag;var lh=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window!="undefined"?window:zs):r=>(Ag||(Ag=Promise.resolve())).then(r).catch(e=>setTimeout(()=>{throw e},0));const Qr=new tr("Producer");let _P=class extends Er{constructor({id:e,localId:t,rtpSender:s,track:i,rtpParameters:n,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:c,appData:l}){super(),this._closed=!1,this._observer=new Er,Qr.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=s,this._track=i,this._kind=i.kind,this._rtpParameters=n,this._paused=o?!i.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=o,this._zeroRtpOnPause=c,this._appData=l||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Qr.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Qr.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new $e("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(Qr.debug("pause()"),this._closed){Qr.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(Qr.debug("resume()"),this._closed){Qr.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(Qr.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch(t){}throw new $e("closed")}else if(e&&e.readyState==="ended")throw new $e("track ended");if(e===this._track){Qr.debug("replaceTrack() | same track, ignored");return}await new Promise((t,s)=>{this.safeEmit("@replacetrack",e,t,s)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new $e("closed");if(this._kind!=="video")throw new rr("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,s)=>{this.safeEmit("@setmaxspatiallayer",e,t,s)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new $e("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,s)=>{this.safeEmit("@setrtpencodingparameters",e,t,s)})}onTrackEnded(){Qr.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch(e){}}};const Zr=new tr("Consumer");let vP=class extends Er{constructor({id:e,localId:t,producerId:s,rtpReceiver:i,track:n,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new Er,Zr.debug("constructor()"),this._id=e,this._localId=t,this._producerId=s,this._rtpReceiver=i,this._track=n,this._rtpParameters=a,this._paused=!n.enabled,this._appData=o||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Zr.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Zr.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new $e("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(Zr.debug("pause()"),this._closed){Zr.error("pause() | Consumer closed");return}if(this._paused){Zr.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(Zr.debug("resume()"),this._closed){Zr.error("resume() | Consumer closed");return}if(!this._paused){Zr.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){Zr.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch(e){}}};const Es=new tr("DataProducer");class TP extends Er{constructor({id:e,dataChannel:t,sctpStreamParameters:s,appData:i}){super(),this._closed=!1,this._observer=new Er,Es.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=s,this._appData=i||{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Es.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Es.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Es.debug("send()"),this._closed)throw new $e("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Es.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Es.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Es.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Es.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||Es.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}const Wi=new tr("DataConsumer");class EP extends Er{constructor({id:e,dataProducerId:t,dataChannel:s,sctpStreamParameters:i,appData:n}){super(),this._closed=!1,this._observer=new Er,Wi.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=s,this._sctpStreamParameters=i,this._appData=n||{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Wi.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Wi.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Wi.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Wi.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Wi.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Wi.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}const St=new tr("Transport");class yP{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,s)=>{this.resolve=t,this.reject=s})}}let SP=class extends Er{constructor({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:u,appData:h,handlerFactory:p,extendedRtpCapabilities:m,canProduceByKind:v}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new Cg,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new Er,St.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=m,this._canProduceByKind=v,this._maxSctpMessageSize=a?a.maxMessageSize:null,l=pt(l,{}),delete l.iceServers,delete l.iceTransportPolicy,delete l.bundlePolicy,delete l.rtcpMuxPolicy,delete l.sdpSemantics,this._handler=p(),this._handler.run({direction:e,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:u,extendedRtpCapabilities:m}),this._appData=h||{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}get producers(){return this._producers}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){St.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new $e("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(St.debug("restartIce()"),this._closed)throw new $e("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(St.debug("updateIceServers()"),this._closed)throw new $e("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:s,codec:i,stopTracks:n=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,appData:c={}}={}){if(St.debug("produce() [track:%o]",e),this._closed)throw new $e("closed");if(e){if(this._direction!=="send")throw new rr("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new $e("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new rr(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let l;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?l=void 0:t&&(l=t.map(m=>{const v={active:!0};return m.active===!1&&(v.active=!1),typeof m.dtx=="boolean"&&(v.dtx=m.dtx),typeof m.scalabilityMode=="string"&&(v.scalabilityMode=m.scalabilityMode),typeof m.scaleResolutionDownBy=="number"&&(v.scaleResolutionDownBy=m.scaleResolutionDownBy),typeof m.maxBitrate=="number"&&(v.maxBitrate=m.maxBitrate),typeof m.maxFramerate=="number"&&(v.maxFramerate=m.maxFramerate),typeof m.adaptivePtime=="boolean"&&(v.adaptivePtime=m.adaptivePtime),typeof m.priority=="string"&&(v.priority=m.priority),typeof m.networkPriority=="string"&&(v.networkPriority=m.networkPriority),v}));const{localId:u,rtpParameters:h,rtpSender:p}=await this._handler.send({track:e,encodings:l,codecOptions:s,codec:i});try{dh(h);const{id:m}=await new Promise((y,C)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:h,appData:c},y,C)}),v=new _P({id:m,localId:u,rtpSender:p,track:e,rtpParameters:h,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:c});return this._producers.set(v.id,v),this.handleProducer(v),this._observer.safeEmit("newproducer",v),v}catch(m){throw this._handler.stopSending(u).catch(()=>{}),m}},"transport.produce()").catch(l=>{if(n)try{e.stop()}catch(u){}throw l})}async consume({id:e,producerId:t,kind:s,rtpParameters:i,streamId:n,appData:a={}}){if(St.debug("consume()"),i=pt(i,void 0),this._closed)throw new $e("closed");if(this._direction!=="recv")throw new rr("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind '${s}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object");if(!dP(i,this._extendedRtpCapabilities))throw new rr("cannot consume this Producer");const c=new yP({id:e,producerId:t,kind:s,rtpParameters:i,streamId:n,appData:a});return this._pendingConsumerTasks.push(c),lh(()=>{if(this._closed)throw new $e("closed");this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),c.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:s,label:i="",protocol:n="",appData:a={}}={}){if(St.debug("produceData()"),this._closed)throw new $e("closed");if(this._direction!=="send")throw new rr("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new rr("SCTP not enabled by remote Transport");return(t||s)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:o,sctpStreamParameters:c}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n});wg(c);const{id:l}=await new Promise((h,p)=>{this.safeEmit("producedata",{sctpStreamParameters:c,label:i,protocol:n,appData:a},h,p)}),u=new TP({id:l,dataChannel:o,sctpStreamParameters:c,appData:a});return this._dataProducers.set(u.id,u),this.handleDataProducer(u),this._observer.safeEmit("newdataproducer",u),u},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:s,label:i="",protocol:n="",appData:a={}}){if(St.debug("consumeData()"),s=pt(s,void 0),this._closed)throw new $e("closed");if(this._direction!=="recv")throw new rr("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new rr("SCTP not enabled by remote Transport");return wg(s),this._awaitQueue.push(async()=>{const{dataChannel:o}=await this._handler.receiveDataChannel({sctpStreamParameters:s,label:i,protocol:n}),c=new EP({id:e,dataProducerId:t,dataChannel:o,sctpStreamParameters:s,appData:a});return this._dataConsumers.set(c.id,c),this.handleDataConsumer(c),this._observer.safeEmit("newdataconsumer",c),c},"transport.consumeData()")}async createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){St.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const s=[];for(const i of e){const{id:n,kind:a,rtpParameters:o,streamId:c}=i.consumerOptions;s.push({trackId:n,kind:a,rtpParameters:o,streamId:c})}try{const i=await this._handler.receive(s);for(let n=0;n<i.length;n++){const a=e[n],o=i[n],{id:c,producerId:l,kind:u,rtpParameters:h,appData:p}=a.consumerOptions,{localId:m,rtpReceiver:v,track:y}=o,C=new vP({id:c,localId:m,producerId:l,rtpReceiver:v,track:y,rtpParameters:h,appData:p});this._consumers.set(C.id,C),this.handleConsumer(C),!this._probatorConsumerCreated&&!t&&u==="video"&&(t=C),this._observer.safeEmit("newconsumer",C),a.resolve(C)}}catch(i){for(const n of e)n.reject(i)}if(t)try{const i=cP(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:i}]),St.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(i){St.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",i)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){St.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(s=>s.localId);await this._handler.pauseReceiving(t)}catch(t){St.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){St.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(s=>s.localId);await this._handler.resumeReceiving(t)}catch(t){St.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){St.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){St.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},s,i)=>{if(this._closed){i(new $e("closed"));return}this.safeEmit("connect",{dtlsParameters:t},s,i)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(St.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>this._handler.stopSending(e.localId),"producer @close event").catch(t=>St.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,s)=>{this._awaitQueue.push(async()=>this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(s)}),e.on("@resume",(t,s)=>{this._awaitQueue.push(async()=>this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(s)}),e.on("@replacetrack",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(s).catch(i)}),e.on("@setmaxspatiallayer",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(s).catch(i)}),e.on("@setrtpencodingparameters",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(s).catch(i)}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new $e("closed"));this._handler.getSenderStats(e.localId).then(t).catch(s)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),lh(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),lh(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new $e("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(s)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}};const Ut=new tr("Device");function wP(){var r,e,t,s;if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(typeof RTCPeerConnection=="undefined"){Ut.warn("this._detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver!="undefined"?(Ut.debug("this._detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(Ut.debug("this._detectDevice() | ReactNative PlanB handler chosen"),"ReactNative")}else if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){let i=navigator.userAgent;i=i==null?void 0:i.replace("motorola edge","motorola x");const n=nh.getParser(i),a=n.getEngine();if(n.satisfies({chrome:">=111",chromium:">=111","microsoft edge":">=111"}))return"Chrome111";if(n.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(n.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(n.satisfies({firefox:">=60"}))return"Firefox60";if(n.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}}))return"Safari12";if(n.satisfies({safari:">=12.0"})&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(((e=(r=n.parsedResult)===null||r===void 0?void 0:r.os)===null||e===void 0?void 0:e.name)==="iOS"&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(n.satisfies({"microsoft edge":">=11"})&&n.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(a.name&&a.name.toLowerCase()==="blink"){const o=i.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(o){const c=Number(o[1]);return c>=111?"Chrome111":c>=74?"Chrome74":"Chrome70"}else return"Chrome111"}else{if(((s=(t=n.parsedResult)===null||t===void 0?void 0:t.os)===null||s===void 0?void 0:s.name)==="iOS"&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(a.name&&a.name.toLowerCase()==="webkit"&&a.version&&parseFloat(a.version)>605)return"Safari12";Ut.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",n.getBrowserName(),n.getBrowserVersion());return}}else{Ut.warn("this._detectDevice() | unknown device");return}}class RP{constructor({handlerName:e,handlerFactory:t,Handler:s}={}){if(this._loaded=!1,this._observer=new Er,Ut.debug("constructor()"),s)if(Ut.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof s=="string")e=s;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)Ut.debug("constructor() | handler given: %s",e);else if(e=wP(),e)Ut.debug("constructor() | detected handler: %s",e);else throw new rr("device not supported");this.switchDevice(e)}const i=this._handlerFactory();this._handlerName=i.name,i.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new $e("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new $e("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){Ut.debug("load() [routerRtpCapabilities:%o]",e),e=pt(e,void 0);let t;try{if(this._loaded)throw new $e("already loaded");ch(e),t=this._handlerFactory();const s=await t.getNativeRtpCapabilities();Ut.debug("load() | got native RTP capabilities:%o",s),ch(s),this._extendedRtpCapabilities=aP(s,e),Ut.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=Rg("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=Rg("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=oP(this._extendedRtpCapabilities),ch(this._recvRtpCapabilities),Ut.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),Ut.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),iP(this._sctpCapabilities),Ut.debug("load() succeeded"),this._loaded=!0,t.close()}catch(s){throw t&&t.close(),s}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new $e("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:u}){return Ut.debug("createSendTransport()"),this.createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:u})}createRecvTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:u}){return Ut.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:u})}createTransport({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:u,appData:h}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof s!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(h&&typeof h!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new $e("not loaded");const p=new SP({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:u,appData:h,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",p),p}}var Ig={},_d={},bP={get exports(){return _d},set exports(r){_d=r}},kg=bP.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(kg).forEach(function(r){var e=kg[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})}),function(r){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,c,l,u){if(u&&!l)c[u]=e(o[1]);else for(var h=0;h<l.length;h+=1)o[h+1]!=null&&(c[l[h]]=e(o[h+1]))},s=function(o,c,l){var u=o.name&&o.names;o.push&&!c[o.push]?c[o.push]=[]:u&&!c[o.name]&&(c[o.name]={});var h=o.push?{}:u?c[o.name]:c;t(l.match(o.reg),h,o.names,o.name),o.push&&c[o.push].push(h)},i=_d,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(o){var c={},l=[],u=c;return o.split(/(\r\n|\r|\n)/).filter(n).forEach(function(h){var p=h[0],m=h.slice(2);p==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var v=0;v<(i[p]||[]).length;v+=1){var y=i[p][v];if(y.reg.test(m))return s(y,u,m)}}),c.media=l,c};var a=function(o,c){var l=c.split(/=(.+)/,2);return l.length===2?o[l[0]]=e(l[1]):l.length===1&&c.length>1&&(o[l[0]]=void 0),o};r.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(o){return o.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(o){for(var c=[],l=o.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},r.parseImageAttributes=function(o){return o.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(a,{})})},r.parseSimulcastStreamList=function(o){return o.split(";").map(function(c){return c.split(",").map(function(l){var u,h=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),h=!0),{scid:u,paused:h}})})}}(Ig);var uh=_d,CP=/%[sdv%]/g,PP=function(r){var e=1,t=arguments,s=t.length;return r.replace(CP,function(i){if(e>=s)return i;var n=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},So=function(r,e,t){var s=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[r+"="+s];if(e.names)for(var n=0;n<e.names.length;n+=1){var a=e.names[n];e.name?i.push(t[e.name][a]):i.push(t[e.names[n]])}else i.push(t[e.name]);return PP.apply(null,i)},AP=["v","o","s","i","u","e","p","c","b","t","r","z","a"],IP=["i","c","b","a"],kP=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var t=e.outerOrder||AP,s=e.innerOrder||IP,i=[];return t.forEach(function(n){uh[n].forEach(function(a){a.name in r&&r[a.name]!=null?i.push(So(n,a,r)):a.push in r&&r[a.push]!=null&&r[a.push].forEach(function(o){i.push(So(n,a,o))})})}),r.media.forEach(function(n){i.push(So("m",uh.m[0],n)),s.forEach(function(a){uh[a].forEach(function(o){o.name in n&&n[o.name]!=null?i.push(So(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(c){i.push(So(a,o,c))})})})}),i.join(`\r
`)+`\r
`},Ji=Ig,OP=kP,Nr=OP,ie=Ji.parse,Og=Ji.parseParams;Ji.parseFmtpConfig,Ji.parsePayloads,Ji.parseRemoteCandidates,Ji.parseImageAttributes;var Dg=Ji.parseSimulcastStreamList;function wo({sdpObject:r}){const e=new Map,t=[];let s=!1,i=!1;for(const a of r.media){const o=a.type;switch(o){case"audio":{if(s)continue;s=!0;break}case"video":{if(i)continue;i=!0;break}default:continue}for(const c of a.rtp){const l={kind:o,mimeType:`${o}/${c.codec}`,preferredPayloadType:c.payload,clockRate:c.rate,channels:c.encoding,parameters:{},rtcpFeedback:[]};e.set(l.preferredPayloadType,l)}for(const c of a.fmtp||[]){const l=Og(c.config),u=e.get(c.payload);u&&(l&&l.hasOwnProperty("profile-level-id")&&(l["profile-level-id"]=String(l["profile-level-id"])),u.parameters=l)}for(const c of a.rtcpFb||[]){const l={type:c.type,parameter:c.subtype};if(l.parameter||delete l.parameter,c.payload!=="*"){const u=e.get(c.payload);if(!u)continue;u.rtcpFeedback.push(l)}else for(const u of e.values())u.kind===o&&!/.+\/rtx$/i.test(u.mimeType)&&u.rtcpFeedback.push(l)}for(const c of a.ext||[]){if(c["encrypt-uri"])continue;const l={kind:o,uri:c.uri,preferredId:c.value};t.push(l)}}return{codecs:Array.from(e.values()),headerExtensions:t}}function Ro({sdpObject:r}){const e=(r.media||[]).find(n=>n.iceUfrag&&n.port!==0);if(!e)throw new Error("no active media section found");const t=e.fingerprint||r.fingerprint;let s;switch(e.setup){case"active":s="client";break;case"passive":s="server";break;case"actpass":s="auto";break}return{role:s,fingerprints:[{algorithm:t.type,value:t.hash}]}}function bo({offerMediaObject:r}){const e=(r.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}function Co({offerRtpParameters:r,answerMediaObject:e}){for(const t of r.codecs){const s=t.mimeType.toLowerCase();if(s!=="audio/opus"||!(e.rtp||[]).find(o=>o.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let n=e.fmtp.find(o=>o.payload===t.payloadType);n||(n={payload:t.payloadType,config:""},e.fmtp.push(n));const a=Og(n.config);switch(s){case"audio/opus":{const o=t.parameters["sprop-stereo"];o!==void 0&&(a.stereo=o?1:0);break}}n.config="";for(const o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}function ri({offerMediaObject:r}){const e=new Set;for(const i of r.ssrcs||[]){const n=i.id;e.add(n)}if(e.size===0)throw new Error("no a=ssrc lines found");const t=new Map;for(const i of r.ssrcGroups||[]){if(i.semantics!=="FID")continue;let[n,a]=i.ssrcs.split(/\s+/);n=Number(n),a=Number(a),e.has(n)&&(e.delete(n),e.delete(a),t.set(n,a))}for(const i of e)t.set(i,null);const s=[];for(const[i,n]of t){const a={ssrc:i};n&&(a.rtx={ssrc:n}),s.push(a)}return s}function vd({offerMediaObject:r,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");const t=(r.ssrcs||[]).find(h=>h.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");const[s,i]=t.value.split(" "),n=t.id;let a;(r.ssrcGroups||[]).some(h=>{if(h.semantics!=="FID")return!1;const p=h.ssrcs.split(/\s+/);return Number(p[0])===n?(a=Number(p[1]),!0):!1});const o=r.ssrcs.find(h=>h.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");const c=o.value,l=[],u=[];for(let h=0;h<e;++h)l.push(n+h),a&&u.push(a+h);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:l.join(" ")});for(let h=0;h<l.length;++h){const p=l[h];r.ssrcs.push({id:p,attribute:"cname",value:c}),r.ssrcs.push({id:p,attribute:"msid",value:`${s} ${i}`})}for(let h=0;h<u.length;++h){const p=l[h],m=u[h];r.ssrcs.push({id:m,attribute:"cname",value:c}),r.ssrcs.push({id:m,attribute:"msid",value:`${s} ${i}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${p} ${m}`})}}let oa=class extends Er{constructor(){super()}};class Mg{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:i=!1}){if(this._mediaObject={},this._planB=i,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const n of t){const a={};a.component=1,a.foundation=n.foundation,a.ip=n.ip,a.port=n.port,a.priority=n.priority,a.transport=n.protocol,a.type=n.type,n.tcpType&&(a.tcptype=n.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}s&&this.setDtlsRole(s.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}muxSimulcastStreams(e){if(this._mediaObject.simulcast&&this._mediaObject.simulcast.list1){const t={};e.forEach(n=>{n.rid&&(t[n.rid]=n)});const s=this._mediaObject.simulcast.list1,i=Dg(s);i.forEach(n=>{n.forEach(a=>{var o;a.paused=!(!((o=t[a.scid])===null||o===void 0)&&o.active)})}),this._mediaObject.simulcast.list1=i.map(n=>n.map(a=>`${a.paused?"~":""}${a.scid}`).join(",")).join(";")}}}class Ng extends Mg{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1,offerMediaObject:o,offerRtpParameters:c,answerRtpParameters:l,codecOptions:u,extmapAllowMixed:h=!1,forceGoogConference:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const m of l.codecs){const v={payload:m.payloadType,codec:hh(m),rate:m.clockRate};m.channels>1&&(v.encoding=m.channels),this._mediaObject.rtp.push(v);const y=pt(m.parameters,{});if(u){const{opusStereo:k,opusFec:D,opusDtx:V,opusMaxPlaybackRate:M,opusMaxAverageBitrate:Pe,opusPtime:W,videoGoogleStartBitrate:Se,videoGoogleMaxBitrate:lt,videoGoogleMinBitrate:or}=u,Ge=c.codecs.find(Ie=>Ie.payloadType===m.payloadType);switch(m.mimeType.toLowerCase()){case"audio/opus":{k!==void 0&&(Ge.parameters["sprop-stereo"]=k?1:0,y.stereo=k?1:0),D!==void 0&&(Ge.parameters.useinbandfec=D?1:0,y.useinbandfec=D?1:0),V!==void 0&&(Ge.parameters.usedtx=V?1:0,y.usedtx=V?1:0),M!==void 0&&(y.maxplaybackrate=M),Pe!==void 0&&(y.maxaveragebitrate=Pe),W!==void 0&&(Ge.parameters.ptime=W,y.ptime=W);break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{Se!==void 0&&(y["x-google-start-bitrate"]=Se),lt!==void 0&&(y["x-google-max-bitrate"]=lt),or!==void 0&&(y["x-google-min-bitrate"]=or);break}}}const C={payload:m.payloadType,config:""};for(const k of Object.keys(y))C.config&&(C.config+=";"),C.config+=`${k}=${y[k]}`;C.config&&this._mediaObject.fmtp.push(C);for(const k of m.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:m.payloadType,type:k.type,subtype:k.parameter})}this._mediaObject.payloads=l.codecs.map(m=>m.payloadType).join(" "),this._mediaObject.ext=[];for(const m of l.headerExtensions)(o.ext||[]).some(y=>y.uri===m.uri)&&this._mediaObject.ext.push({uri:m.uri,value:m.id});if(h&&o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const m of o.rids||[])m.direction==="send"&&this._mediaObject.rids.push({id:m.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const m of o.rids||[])m.direction==="send"&&this._mediaObject.rids.push({id:m.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",(this._planB||p)&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";break}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(e){var t;if(!this._mediaObject.simulcast||!this._mediaObject.simulcast.list1)return;const s={};for(const a of e)a.rid&&(s[a.rid]=a);const i=this._mediaObject.simulcast.list1,n=Dg(i);for(const a of n)for(const o of a)o.paused=!(!((t=s[o.scid])===null||t===void 0)&&t.active);this._mediaObject.simulcast.list1=n.map(a=>a.map(o=>`${o.paused?"~":""}${o.scid}`).join(",")).join(";")}}class Lg extends Mg{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1,mid:o,kind:c,offerRtpParameters:l,streamId:u,trackId:h,oldDataChannelSpec:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=c,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),c){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${u||"-"} ${h}`);for(const C of l.codecs){const k={payload:C.payloadType,codec:hh(C),rate:C.clockRate};C.channels>1&&(k.encoding=C.channels),this._mediaObject.rtp.push(k);const D={payload:C.payloadType,config:""};for(const V of Object.keys(C.parameters))D.config&&(D.config+=";"),D.config+=`${V}=${C.parameters[V]}`;D.config&&this._mediaObject.fmtp.push(D);for(const V of C.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:C.payloadType,type:V.type,subtype:V.parameter})}this._mediaObject.payloads=l.codecs.map(C=>C.payloadType).join(" "),this._mediaObject.ext=[];for(const C of l.headerExtensions)this._mediaObject.ext.push({uri:C.uri,value:C.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const m=l.encodings[0],v=m.ssrc,y=m.rtx&&m.rtx.ssrc?m.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],l.rtcp.cname&&this._mediaObject.ssrcs.push({id:v,attribute:"cname",value:l.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:v,attribute:"msid",value:`${u||"-"} ${h}`}),y&&(l.rtcp.cname&&this._mediaObject.ssrcs.push({id:y,attribute:"cname",value:l.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:y,attribute:"msid",value:`${u||"-"} ${h}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${v} ${y}`}));break}case"application":{p?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:s}){const i=e.encodings[0],n=i.ssrc,a=i.rtx&&i.rtx.ssrc?i.rtx.ssrc:void 0,o=this._mediaObject.payloads.split(" ");for(const c of e.codecs){if(o.includes(String(c.payloadType)))continue;const l={payload:c.payloadType,codec:hh(c),rate:c.clockRate};c.channels>1&&(l.encoding=c.channels),this._mediaObject.rtp.push(l);const u={payload:c.payloadType,config:""};for(const h of Object.keys(c.parameters))u.config&&(u.config+=";"),u.config+=`${h}=${c.parameters[h]}`;u.config&&this._mediaObject.fmtp.push(u);for(const h of c.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:c.payloadType,type:h.type,subtype:h.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(c=>!this._mediaObject.payloads.includes(c.payloadType)).map(c=>c.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${s}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${s}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],s=t.ssrc,i=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(n=>n.id!==s&&n.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(n=>n.ssrcs!==`${s} ${i}`))}}function hh(r){const t=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}const ph=new tr("RemoteSdp");class Po{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=s,this._sctpParameters=i,this._plainRtpParameters=n,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),s){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:s.fingerprints[o-1].algorithm,hash:s.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(e){ph.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){ph.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:s,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a=!1,forceGoogConference:o=!1}){const c=new Ng({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:s,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a,forceGoogConference:o});t?this._replaceMediaSection(c,t):this._midToIndex.has(c.mid)?this._replaceMediaSection(c):this._addMediaSection(c)}receive({mid:e,kind:t,offerRtpParameters:s,streamId:i,trackId:n}){const a=this._midToIndex.get(e);let o;if(a!==void 0&&(o=this._mediaSections[a]),o)o.planBReceive({offerRtpParameters:s,streamId:i,trackId:n}),this._replaceMediaSection(o);else{o=new Lg({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:s,streamId:i,trackId:n});const c=this._mediaSections.find(l=>l.closed);c?this._replaceMediaSection(o,c.mid):this._addMediaSection(o)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){const t=this._findMediaSection(e);return e===this._firstMid?(ph.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e),!1):(t.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(e,t){const s=this._midToIndex.get(e);if(s===void 0)throw new Error(`no media section found with mid '${e}'`);const i=this._mediaSections[s];if(i===void 0)throw new Error(`no media section found with idx '${s}'`);i.muxSimulcastStreams(t),this._replaceMediaSection(i)}planBStopReceiving({mid:e,offerRtpParameters:t}){const s=this._findMediaSection(e);s.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(s)}sendSctpAssociation({offerMediaObject:e}){const t=new Ng({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new Lg({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,Nr(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){const s=this._midToIndex.get(t);if(s===void 0)throw new Error(`no media section found for reuseMid '${t}'`);const i=this._mediaSections[s];this._mediaSections[s]=e,this._midToIndex.delete(i.mid),this._midToIndex.set(e.mid,s),this._sdpObject.media[s]=e.getObject(),this._regenerateBundleMids()}else{const s=this._midToIndex.get(e.mid);if(s===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[s]=e,this._sdpObject.media[s]=e.getObject()}}_findMediaSection(e){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}const DP=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Ao(r){const e=DP.exec(r||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}const ce=new tr("Chrome70"),xg={OS:1024,MIS:1024};class fh extends oa{static createFactory(){return()=>new fh}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome70"}close(){if(ce.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}async getNativeRtpCapabilities(){ce.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(n){}const s=ie(t.sdp);return wo({sdpObject:s})}catch(t){try{e.close()}catch(s){}throw t}}async getNativeSctpCapabilities(){return ce.debug("getNativeSctpCapabilities()"),{numStreams:xg}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){ce.debug("run()"),this._direction=e,this._remoteSdp=new Po({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._sendingRemoteRtpParametersByKind={audio:Xr("audio",u),video:Xr("video",u)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},l),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(ce.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}async updateIceServers(e){ce.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(ce.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});ce.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};ce.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};ce.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();ce.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){var n;this.assertSendDirection(),ce.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=pt(this._sendingRtpParametersByKind[e.kind],{});a.codecs=Mr(a.codecs,i);const o=pt(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=Mr(o.codecs,i);const c=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let u=await this._pc.createOffer(),h=ie(u.sdp),p;this._transportReady||await this.setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:h}),t&&t.length>1&&(ce.debug("send() | enabling legacy simulcast"),h=ie(u.sdp),p=h.media[c.idx],vd({offerMediaObject:p,numStreams:t.length}),u={type:"offer",sdp:Nr(h)});let m=!1;const v=Ao((t||[{}])[0].scalabilityMode);if(t&&t.length===1&&v.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(ce.debug("send() | enabling legacy simulcast for VP9 SVC"),m=!0,h=ie(u.sdp),p=h.media[c.idx],vd({offerMediaObject:p,numStreams:v.spatialLayers}),u={type:"offer",sdp:Nr(h)}),ce.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u),t){ce.debug("send() | applying given encodings");const k=l.sender.getParameters();for(let D=0;D<(k.encodings||[]).length;++D){const V=k.encodings[D],M=t[D];if(!M)break;k.encodings[D]=Object.assign(V,M)}await l.sender.setParameters(k)}const y=l.mid;if(a.mid=y,h=ie(this._pc.localDescription.sdp),p=h.media[c.idx],a.rtcp.cname=bo({offerMediaObject:p}),a.encodings=ri({offerMediaObject:p}),t)for(let k=0;k<a.encodings.length;++k)t[k]&&Object.assign(a.encodings[k],t[k]);if(m&&(a.encodings=[a.encodings[0]]),a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const k of a.encodings)k.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:p,reuseMid:c.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s});const C={type:"answer",sdp:this._remoteSdp.getSdp()};return ce.debug("send() | calling pc.setRemoteDescription() [answer:%o]",C),await this._pc.setRemoteDescription(C),this._mapMidTransceiver.set(y,l),{localId:y,rtpParameters:a,rtpSender:l.sender}}async stopSending(e){this.assertSendDirection(),ce.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch(a){}const i=await this._pc.createOffer();ce.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};ce.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?ce.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):ce.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),ce.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{c<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();ce.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};ce.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),ce.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{i.encodings[c]={...o,...t}}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();ce.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};ce.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){var a;this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:s,protocol:n};ce.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%xg.MIS,!this._hasDataChannelMediaSection){const u=await this._pc.createOffer(),h=ie(u.sdp),p=h.media.find(v=>v.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:h}),ce.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u),this._remoteSdp.sendSctpAssociation({offerMediaObject:p});const m={type:"answer",sdp:this._remoteSdp.getSdp()};ce.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){var t;this.assertRecvDirection();const s=[],i=new Map;for(const c of e){const{trackId:l,kind:u,rtpParameters:h,streamId:p}=c;ce.debug("receive() [trackId:%s, kind:%s]",l,u);const m=h.mid||String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:u,offerRtpParameters:h,streamId:p||h.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};ce.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ie(a.sdp);for(const c of e){const{trackId:l,rtpParameters:u}=c,h=i.get(l),p=o.media.find(m=>String(m.mid)===h);Co({offerRtpParameters:u,answerMediaObject:p})}a={type:"answer",sdp:Nr(o)},this._transportReady||await this.setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),ce.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const c of e){const{trackId:l}=c,u=i.get(l),h=this._pc.getTransceivers().find(p=>p.mid===u);if(!h)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(u,h),s.push({localId:u,track:h.receiver.track,rtpReceiver:h.receiver})}return s}async stopReceiving(e){this.assertRecvDirection();for(const i of e){ce.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};ce.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();ce.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var i;this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:c,protocol:s};ce.debug("receiveDataChannel() [options:%o]",l);const u=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const h={type:"offer",sdp:this._remoteSdp.getSdp()};ce.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",h),await this._pc.setRemoteDescription(h);const p=await this._pc.createAnswer();if(!this._transportReady){const m=ie(p.sdp);await this.setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:m})}ce.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setLocalDescription(p),this._hasDataChannelMediaSection=!0}return{dataChannel:u}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie(this._pc.localDescription.sdp));const s=Ro({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}const $=new tr("Chrome74"),Ug={OS:1024,MIS:1024};let MP=class GE extends oa{static createFactory(){return()=>new GE}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome74"}close(){if($.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}async getNativeRtpCapabilities(){$.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(n){}const s=ie(t.sdp);return wo({sdpObject:s})}catch(t){try{e.close()}catch(s){}throw t}}async getNativeSctpCapabilities(){return $.debug("getNativeSctpCapabilities()"),{numStreams:Ug}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){$.debug("run()"),this._direction=e,this._remoteSdp=new Po({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._sendingRemoteRtpParametersByKind={audio:Xr("audio",u),video:Xr("video",u)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},l),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):($.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}async updateIceServers(e){$.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if($.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});$.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();$.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){var n,a;this.assertSendDirection(),$.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((D,V)=>{D.rid=`r${V}`});const o=pt(this._sendingRtpParametersByKind[e.kind],{});o.codecs=Mr(o.codecs,i);const c=pt(this._sendingRemoteRtpParametersByKind[e.kind],{});c.codecs=Mr(c.codecs,i);const l=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let h=await this._pc.createOffer(),p=ie(h.sdp),m;this._transportReady||await this.setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:p});let v=!1;const y=Ao((t||[{}])[0].scalabilityMode);t&&t.length===1&&y.spatialLayers>1&&o.codecs[0].mimeType.toLowerCase()==="video/vp9"&&($.debug("send() | enabling legacy simulcast for VP9 SVC"),v=!0,p=ie(h.sdp),m=p.media[l.idx],vd({offerMediaObject:m,numStreams:y.spatialLayers}),h={type:"offer",sdp:Nr(p)}),$.debug("send() | calling pc.setLocalDescription() [offer:%o]",h),await this._pc.setLocalDescription(h);const C=u.mid;if(o.mid=C,p=ie(this._pc.localDescription.sdp),m=p.media[l.idx],o.rtcp.cname=bo({offerMediaObject:m}),!t)o.encodings=ri({offerMediaObject:m});else if(t.length===1){let D=ri({offerMediaObject:m});Object.assign(D[0],t[0]),v&&(D=[D[0]]),o.encodings=D}else o.encodings=t;if(o.encodings.length>1&&(o.codecs[0].mimeType.toLowerCase()==="video/vp8"||o.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const D of o.encodings)D.scalabilityMode?D.scalabilityMode=`L1T${y.temporalLayers}`:D.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:m,reuseMid:l.reuseMid,offerRtpParameters:o,answerRtpParameters:c,codecOptions:s,extmapAllowMixed:!0,forceGoogConference:(a=s==null?void 0:s.forceGoogConference)!==null&&a!==void 0?a:!1});const k={type:"answer",sdp:this._remoteSdp.getSdp()};return $.debug("send() | calling pc.setRemoteDescription() [answer:%o]",k),await this._pc.setRemoteDescription(k),this._mapMidTransceiver.set(C,u),{localId:C,rtpParameters:o,rtpSender:u.sender}}async stopSending(e){this.assertSendDirection(),$.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch(a){}const i=await this._pc.createOffer();$.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertSendDirection(),$.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();$.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertSendDirection(),$.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();$.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertSendDirection(),t?$.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):$.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),$.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{c<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();$.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),$.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{i.encodings[c]={...o,...t}}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();$.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){var a;this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};$.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ug.MIS,!this._hasDataChannelMediaSection){const u=await this._pc.createOffer(),h=ie(u.sdp),p=h.media.find(v=>v.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:h}),$.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u),this._remoteSdp.sendSctpAssociation({offerMediaObject:p});const m={type:"answer",sdp:this._remoteSdp.getSdp()};$.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){var t;this.assertRecvDirection();const s=[],i=new Map;for(const c of e){const{trackId:l,kind:u,rtpParameters:h,streamId:p}=c;$.debug("receive() [trackId:%s, kind:%s]",l,u);const m=h.mid||String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:u,offerRtpParameters:h,streamId:p||h.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ie(a.sdp);for(const c of e){const{trackId:l,rtpParameters:u}=c,h=i.get(l),p=o.media.find(m=>String(m.mid)===h);Co({offerRtpParameters:u,answerMediaObject:p})}a={type:"answer",sdp:Nr(o)},this._transportReady||await this.setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),$.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const c of e){const{trackId:l}=c,u=i.get(l),h=this._pc.getTransceivers().find(p=>p.mid===u);if(h)this._mapMidTransceiver.set(u,h),s.push({localId:u,track:h.receiver.track,rtpReceiver:h.receiver});else throw new Error("new RTCRtpTransceiver not found")}return s}async stopReceiving(e){this.assertRecvDirection();for(const i of e){$.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();$.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertRecvDirection();for(const i of e){$.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();$.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertRecvDirection();for(const i of e){$.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();$.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var i;this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c,protocol:s};$.debug("receiveDataChannel() [options:%o]",l);const u=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const h={type:"offer",sdp:this._remoteSdp.getSdp()};$.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",h),await this._pc.setRemoteDescription(h);const p=await this._pc.createAnswer();if(!this._transportReady){const m=ie(p.sdp);await this.setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:m})}$.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setLocalDescription(p),this._hasDataChannelMediaSection=!0}return{dataChannel:u}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie(this._pc.localDescription.sdp));const s=Ro({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};const G=new tr("Chrome111"),Bg={OS:1024,MIS:1024};class mh extends oa{static createFactory(){return()=>new mh}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome111"}close(){if(G.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}async getNativeRtpCapabilities(){G.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(n){}const s=ie(t.sdp);return wo({sdpObject:s})}catch(t){try{e.close()}catch(s){}throw t}}async getNativeSctpCapabilities(){return G.debug("getNativeSctpCapabilities()"),{numStreams:Bg}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){G.debug("run()"),this._direction=e,this._remoteSdp=new Po({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._sendingRemoteRtpParametersByKind={audio:Xr("audio",u),video:Xr("video",u)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},l),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(G.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}))}async updateIceServers(e){G.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(G.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});G.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();G.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){var n;if(this.assertSendDirection(),G.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){t.forEach((k,D)=>{k.rid=`r${D}`});let y=1,C=1;for(const k of t){const D=k.scalabilityMode?Ao(k.scalabilityMode).temporalLayers:3;D>C&&(C=D)}for(const k of t)k.rid=`r${y++}`,k.scalabilityMode=`L1T${C}`}const a=pt(this._sendingRtpParametersByKind[e.kind],{});a.codecs=Mr(a.codecs,i);const o=pt(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=Mr(o.codecs,i);const c=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),u=await this._pc.createOffer();let h=ie(u.sdp);this._transportReady||await this.setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:h}),G.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u);const p=l.mid;a.mid=p,h=ie(this._pc.localDescription.sdp);const m=h.media[c.idx];if(a.rtcp.cname=bo({offerMediaObject:m}),!t)a.encodings=ri({offerMediaObject:m});else if(t.length===1){const y=ri({offerMediaObject:m});Object.assign(y[0],t[0]),a.encodings=y}else a.encodings=t;this._remoteSdp.send({offerMediaObject:m,reuseMid:c.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});const v={type:"answer",sdp:this._remoteSdp.getSdp()};return G.debug("send() | calling pc.setRemoteDescription() [answer:%o]",v),await this._pc.setRemoteDescription(v),this._mapMidTransceiver.set(p,l),{localId:p,rtpParameters:a,rtpSender:l.sender}}async stopSending(e){this.assertSendDirection(),G.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch(a){}const i=await this._pc.createOffer();G.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertSendDirection(),G.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();G.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertSendDirection(),G.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const s=await this._pc.createOffer();G.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertSendDirection(),t?G.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):G.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),G.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{c<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();G.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),G.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{i.encodings[c]={...o,...t}}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();G.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){var a;this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};G.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Bg.MIS,!this._hasDataChannelMediaSection){const u=await this._pc.createOffer(),h=ie(u.sdp),p=h.media.find(v=>v.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:h}),G.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u),this._remoteSdp.sendSctpAssociation({offerMediaObject:p});const m={type:"answer",sdp:this._remoteSdp.getSdp()};G.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){var t;this.assertRecvDirection();const s=[],i=new Map;for(const c of e){const{trackId:l,kind:u,rtpParameters:h,streamId:p}=c;G.debug("receive() [trackId:%s, kind:%s]",l,u);const m=h.mid||String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:u,offerRtpParameters:h,streamId:p||h.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ie(a.sdp);for(const c of e){const{trackId:l,rtpParameters:u}=c,h=i.get(l),p=o.media.find(m=>String(m.mid)===h);Co({offerRtpParameters:u,answerMediaObject:p})}a={type:"answer",sdp:Nr(o)},this._transportReady||await this.setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),G.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const c of e){const{trackId:l}=c,u=i.get(l),h=this._pc.getTransceivers().find(p=>p.mid===u);if(h)this._mapMidTransceiver.set(u,h),s.push({localId:u,track:h.receiver.track,rtpReceiver:h.receiver});else throw new Error("new RTCRtpTransceiver not found")}return s}async stopReceiving(e){this.assertRecvDirection();for(const i of e){G.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();G.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertRecvDirection();for(const i of e){G.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();G.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertRecvDirection();for(const i of e){G.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();G.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var i;this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c,protocol:s};G.debug("receiveDataChannel() [options:%o]",l);const u=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const h={type:"offer",sdp:this._remoteSdp.getSdp()};G.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",h),await this._pc.setRemoteDescription(h);const p=await this._pc.createAnswer();if(!this._transportReady){const m=ie(p.sdp);await this.setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:m})}G.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setLocalDescription(p),this._hasDataChannelMediaSection=!0}return{dataChannel:u}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie(this._pc.localDescription.sdp));const s=Ro({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}function NP(){const r=RTCRtpReceiver.getCapabilities(),e=pt(r,{});for(const t of e.codecs){if(t.channels=t.numChannels,delete t.numChannels,t.mimeType=t.mimeType||`${t.kind}/${t.name}`,t.parameters){const s=t.parameters;s.apt&&(s.apt=Number(s.apt)),s["packetization-mode"]&&(s["packetization-mode"]=Number(s["packetization-mode"]))}for(const s of t.rtcpFeedback||[])s.parameter||(s.parameter="")}return e}function Fg(r){const e=pt(r,{});e.mid&&(e.muxId=e.mid,delete e.mid);for(const t of e.codecs)t.channels&&(t.numChannels=t.channels,delete t.channels),t.mimeType&&!t.name&&(t.name=t.mimeType.split("/")[1]),delete t.mimeType;return e}const Ce=new tr("Edge11");class gh extends oa{static createFactory(){return()=>new gh}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return"Edge11"}close(){Ce.debug("close()");try{this._iceGatherer.close()}catch(e){}try{this._iceTransport.stop()}catch(e){}try{this._dtlsTransport.stop()}catch(e){}for(const e of this._rtpSenders.values())try{e.stop()}catch(t){}for(const e of this._rtpReceivers.values())try{e.stop()}catch(t){}this.emit("@close")}async getNativeRtpCapabilities(){return Ce.debug("getNativeRtpCapabilities()"),NP()}async getNativeSctpCapabilities(){return Ce.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){Ce.debug("run()"),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._remoteIceParameters=t,this._remoteIceCandidates=s,this._remoteDtlsParameters=i,this._cname=`CNAME-${ah()}`,this.setIceGatherer({iceServers:a,iceTransportPolicy:o}),this.setIceTransport(),this.setDtlsTransport()}async updateIceServers(e){throw new rr("not supported")}async restartIce(e){if(Ce.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){Ce.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){Ce.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),Ce.debug("send() | calling new RTCRtpSender()");const n=new RTCRtpSender(e,this._dtlsTransport),a=pt(this._sendingRtpParametersByKind[e.kind],{});a.codecs=Mr(a.codecs,i);const o=a.codecs.some(u=>/.+\/rtx$/i.test(u.mimeType));t||(t=[{}]);for(const u of t)u.ssrc=ah(),o&&(u.rtx={ssrc:ah()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const c=Fg(a);Ce.debug("send() | calling rtpSender.send() [params:%o]",c),await n.send(c);const l=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(l,n),{localId:l,rtpParameters:a,rtpSender:n}}async stopSending(e){Ce.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{Ce.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(s){throw Ce.warn("stopSending() | rtpSender.stop() failed:%o",s),s}}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){t?Ce.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Ce.debug("replaceTrack() [localId:%s, no track]",e);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");s.setTrack(t)}async setMaxSpatialLayer(e,t){Ce.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");const i=s.getParameters();i.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await s.setParameters(i)}async setRtpEncodingParameters(e,t){Ce.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._rtpSenders.get(e);if(!s)throw new Error("RTCRtpSender not found");const i=s.getParameters();i.encodings.forEach((n,a)=>{i.encodings[a]={...n,...t}}),await s.setParameters(i)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new rr("not implemented")}async receive(e){const t=[];for(const s of e){const{trackId:i,kind:n}=s;Ce.debug("receive() [trackId:%s, kind:%s]",i,n)}this._transportReady||await this.setupTransport({localDtlsRole:"server"});for(const s of e){const{trackId:i,kind:n,rtpParameters:a}=s;Ce.debug("receive() | calling new RTCRtpReceiver()");const o=new RTCRtpReceiver(this._dtlsTransport,n);o.addEventListener("error",u=>{Ce.error('rtpReceiver "error" event [event:%o]',u)});const c=Fg(a);Ce.debug("receive() | calling rtpReceiver.receive() [params:%o]",c),await o.receive(c);const l=i;this._rtpReceivers.set(l,o),t.push({localId:l,track:o.track,rtpReceiver:o})}return t}async stopReceiving(e){for(const t of e){Ce.debug("stopReceiving() [localId:%s]",t);const s=this._rtpReceivers.get(t);if(!s)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(t);try{Ce.debug("stopReceiving() | calling rtpReceiver.stop()"),s.stop()}catch(i){Ce.warn("stopReceiving() | rtpReceiver.stop() failed:%o",i)}}}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new rr("not implemented")}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const s=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});s.addEventListener("error",i=>{Ce.error('iceGatherer "error" event [event:%o]',i)});try{s.gather()}catch(i){Ce.debug("setIceGatherer() | iceGatherer.gather() failed: %s",i.toString())}this._iceGatherer=s}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}),e.addEventListener("candidatepairchange",t=>{Ce.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{Ce.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{Ce.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{Ce.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}async setupTransport({localDtlsRole:e}){Ce.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await new Promise((s,i)=>{this.safeEmit("@connect",{dtlsParameters:t},s,i)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const s of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(s);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(s=>s.algorithm==="sha-256"||s.algorithm==="sha-384"||s.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}const K=new tr("Firefox60"),Vg={OS:16,MIS:2048};let LP=class qE extends oa{static createFactory(){return()=>new qE}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Firefox60"}close(){if(K.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}async getNativeRtpCapabilities(){K.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const i=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const n=e.addTransceiver(i,{direction:"sendrecv"}),a=n.sender.getParameters(),o=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];a.encodings=o,await n.sender.setParameters(a);const c=await e.createOffer();try{t.remove()}catch(h){}try{i.stop()}catch(h){}try{e.close()}catch(h){}const l=ie(c.sdp);return wo({sdpObject:l})}catch(n){try{t.remove()}catch(a){}try{i.stop()}catch(a){}try{e.close()}catch(a){}throw n}}async getNativeSctpCapabilities(){return K.debug("getNativeSctpCapabilities()"),{numStreams:Vg}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){K.debug("run()"),this._direction=e,this._remoteSdp=new Po({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._sendingRemoteRtpParametersByKind={audio:Xr("audio",u),video:Xr("video",u)},this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...c},l),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(K.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}async updateIceServers(e){throw new rr("not supported")}async restartIce(e){if(K.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});K.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();K.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){this.assertSendDirection(),K.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=pt(t,[]),t.length>1&&(t.forEach((v,y)=>{v.rid=`r${y}`}),t.reverse()));const n=pt(this._sendingRtpParametersByKind[e.kind],{});n.codecs=Mr(n.codecs,i);const a=pt(this._sendingRemoteRtpParametersByKind[e.kind],{});a.codecs=Mr(a.codecs,i);const o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const v=o.sender.getParameters();v.encodings=t,await o.sender.setParameters(v)}const c=await this._pc.createOffer();let l=ie(c.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:l});const u=Ao((t||[{}])[0].scalabilityMode);K.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const h=o.mid;n.mid=h,l=ie(this._pc.localDescription.sdp);const p=l.media[l.media.length-1];if(n.rtcp.cname=bo({offerMediaObject:p}),!t)n.encodings=ri({offerMediaObject:p});else if(t.length===1){const v=ri({offerMediaObject:p});Object.assign(v[0],t[0]),n.encodings=v}else n.encodings=t.reverse();if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const v of n.encodings)v.scalabilityMode?v.scalabilityMode=`L1T${u.temporalLayers}`:v.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:p,offerRtpParameters:n,answerRtpParameters:a,codecOptions:s,extmapAllowMixed:!0});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return K.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(h,o),{localId:h,rtpParameters:n,rtpSender:o.sender}}async stopSending(e){K.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const s=await this._pc.createOffer();K.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertSendDirection(),K.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();K.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertSendDirection(),K.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();K.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertSendDirection(),t?K.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):K.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),K.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated transceiver not found");const i=s.sender.getParameters();t=i.encodings.length-1-t,i.encodings.forEach((o,c)=>{c>=t?o.active=!0:o.active=!1}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();K.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),K.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{i.encodings[c]={...o,...t}}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();K.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};K.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(i,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Vg.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),u=ie(l.sdp),h=u.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:u}),K.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const p={type:"answer",sdp:this._remoteSdp.getSdp()};K.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p),this._hasDataChannelMediaSection=!0}const c={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:o,sctpStreamParameters:c}}async receive(e){this.assertRecvDirection();const t=[],s=new Map;for(const o of e){const{trackId:c,kind:l,rtpParameters:u,streamId:h}=o;K.debug("receive() [trackId:%s, kind:%s]",c,l);const p=u.mid||String(this._mapMidTransceiver.size);s.set(c,p),this._remoteSdp.receive({mid:p,kind:l,offerRtpParameters:u,streamId:h||u.rtcp.cname,trackId:c})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=ie(n.sdp);for(const o of e){const{trackId:c,rtpParameters:l}=o,u=s.get(c),h=a.media.find(p=>String(p.mid)===u);Co({offerRtpParameters:l,answerMediaObject:h}),n={type:"answer",sdp:Nr(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),K.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{trackId:c}=o,l=s.get(c),u=this._pc.getTransceivers().find(h=>h.mid===l);if(!u)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(l,u),t.push({localId:l,track:u.receiver.track,rtpReceiver:u.receiver})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){K.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();K.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertRecvDirection();for(const i of e){K.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();K.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertRecvDirection();for(const i of e){K.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();K.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o}=e,c={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:a,maxRetransmits:o,protocol:s};K.debug("receiveDataChannel() [options:%o]",c);const l=this._pc.createDataChannel(t,c);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const u={type:"offer",sdp:this._remoteSdp.getSdp()};K.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",u),await this._pc.setRemoteDescription(u);const h=await this._pc.createAnswer();if(!this._transportReady){const p=ie(h.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:p})}K.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie(this._pc.localDescription.sdp));const s=Ro({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};const H=new tr("Safari12"),$g={OS:1024,MIS:1024};let xP=class KE extends oa{static createFactory(){return()=>new KE}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari12"}close(){if(H.debug("close()"),this._pc)try{this._pc.close()}catch(e){}this.emit("@close")}async getNativeRtpCapabilities(){H.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(n){}const s=ie(t.sdp);return wo({sdpObject:s})}catch(t){try{e.close()}catch(s){}throw t}}async getNativeSctpCapabilities(){return H.debug("getNativeSctpCapabilities()"),{numStreams:$g}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:u}){H.debug("run()"),this._direction=e,this._remoteSdp=new Po({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:yr("audio",u),video:yr("video",u)},this._sendingRemoteRtpParametersByKind={audio:Xr("audio",u),video:Xr("video",u)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...c},l),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(H.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}async updateIceServers(e){H.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(H.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});H.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const s={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();H.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){var n;this.assertSendDirection(),H.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=pt(this._sendingRtpParametersByKind[e.kind],{});a.codecs=Mr(a.codecs,i);const o=pt(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=Mr(o.codecs,i);const c=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let u=await this._pc.createOffer(),h=ie(u.sdp),p;this._transportReady||await this.setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:h});const m=Ao((t||[{}])[0].scalabilityMode);t&&t.length>1&&(H.debug("send() | enabling legacy simulcast"),h=ie(u.sdp),p=h.media[c.idx],vd({offerMediaObject:p,numStreams:t.length}),u={type:"offer",sdp:Nr(h)}),H.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u);const v=l.mid;if(a.mid=v,h=ie(this._pc.localDescription.sdp),p=h.media[c.idx],a.rtcp.cname=bo({offerMediaObject:p}),a.encodings=ri({offerMediaObject:p}),t)for(let C=0;C<a.encodings.length;++C)t[C]&&Object.assign(a.encodings[C],t[C]);if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const C of a.encodings)C.scalabilityMode?C.scalabilityMode=`L1T${m.temporalLayers}`:C.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:p,reuseMid:c.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s});const y={type:"answer",sdp:this._remoteSdp.getSdp()};return H.debug("send() | calling pc.setRemoteDescription() [answer:%o]",y),await this._pc.setRemoteDescription(y),this._mapMidTransceiver.set(v,l),{localId:v,rtpParameters:a,rtpSender:l.sender}}async stopSending(e){this.assertSendDirection(),H.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch(a){}const i=await this._pc.createOffer();H.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertSendDirection(),H.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const s=await this._pc.createOffer();H.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertSendDirection(),H.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const s=await this._pc.createOffer();H.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);const i={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertSendDirection(),t?H.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):H.debug("replaceTrack() [localId:%s, no track]",e);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),H.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{c<=t?o.active=!0:o.active=!1}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();H.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),H.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");const i=s.sender.getParameters();i.encodings.forEach((o,c)=>{i.encodings[c]={...o,...t}}),await s.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();H.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){var a;this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};H.debug("sendDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%$g.MIS,!this._hasDataChannelMediaSection){const u=await this._pc.createOffer(),h=ie(u.sdp),p=h.media.find(v=>v.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:h}),H.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u),this._remoteSdp.sendSctpAssociation({offerMediaObject:p});const m={type:"answer",sdp:this._remoteSdp.getSdp()};H.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){var t;this.assertRecvDirection();const s=[],i=new Map;for(const c of e){const{trackId:l,kind:u,rtpParameters:h,streamId:p}=c;H.debug("receive() [trackId:%s, kind:%s]",l,u);const m=h.mid||String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:u,offerRtpParameters:h,streamId:p||h.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ie(a.sdp);for(const c of e){const{trackId:l,rtpParameters:u}=c,h=i.get(l),p=o.media.find(m=>String(m.mid)===h);Co({offerRtpParameters:u,answerMediaObject:p})}a={type:"answer",sdp:Nr(o)},this._transportReady||await this.setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),H.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const c of e){const{trackId:l}=c,u=i.get(l),h=this._pc.getTransceivers().find(p=>p.mid===u);if(!h)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(u,h),s.push({localId:u,track:h.receiver.track,rtpReceiver:h.receiver})}return s}async stopReceiving(e){this.assertRecvDirection();for(const i of e){H.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();H.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertRecvDirection();for(const i of e){H.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();H.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this.assertRecvDirection();for(const i of e){H.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const s=await this._pc.createAnswer();H.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var i;this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:c,protocol:s};H.debug("receiveDataChannel() [options:%o]",l);const u=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const h={type:"offer",sdp:this._remoteSdp.getSdp()};H.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",h),await this._pc.setRemoteDescription(h);const p=await this._pc.createAnswer();if(!this._transportReady){const m=ie(p.sdp);await this.setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:m})}H.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setLocalDescription(p),this._hasDataChannelMediaSection=!0}return{dataChannel:u}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie(this._pc.localDescription.sdp));const s=Ro({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}},Hg=class extends RP{constructor({handlerName:e,handlerFactory:t,Handler:s}={}){super({handlerName:e,handlerFactory:t,Handler:s})}switchDevice(e){switch(e){case"Chrome111":this._handlerFactory=mh.createFactory();break;case"Chrome74":this._handlerFactory=MP.createFactory();break;case"Chrome70":this._handlerFactory=fh.createFactory();break;case"Firefox60":this._handlerFactory=LP.createFactory();break;case"Safari12":this._handlerFactory=xP.createFactory();break;case"Edge11":this._handlerFactory=gh.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}};const Io="chrome",jg="opera",Gg="firefox",qg="iexplorer",Kg="safari",Wg="nwjs",Jg="electron",zg="react-native",_h="unknown",Td={Chrome:Io,Chromium:Io,Opera:jg,Firefox:Gg,"Internet Explorer":qg,Safari:Kg};function UP(){const{userAgent:r}=navigator,e={name:_h,version:void 0};if(r.match(/Chrome/)&&!r.match(/Edge/))if(r.match(/Edg(A?)/)){const t=r.match(/Chrome\/([\d.]+)/)[1];Number.parseInt(t,10)>72&&(e.name=Io,e.version=t)}else e.name=Io,e.version=r.match(/Chrome\/([\d.]+)/)[1];return e}function BP(){const{userAgent:r}=navigator;if(r.match(/Electron/)){const e=r.match(/Electron\/([\d.]+)/)[1];return{name:Jg,version:e}}return null}function FP(){const{userAgent:r}=navigator;if(r.match(/JitsiMeetNW/)){const e=r.match(/JitsiMeetNW\/([\d.]+)/)[1];return{name:Wg,version:e}}}function VP(){const r=navigator.userAgent.match(/\b(react[ \t_-]*native)(?:\/(\S+))?/i);let e;if(r||navigator.product==="ReactNative")return r&&r.length>2&&(r[1],e=r[2]),e||(e="unknown"),{name:zg,version:e}}function $P(r){let e;const t=[VP,BP,FP];for(let i=0;i<t.length;i+=1)if(e=t[i](),e)return e;const s=r.getBrowserName();return s in Td?{name:Td[s],version:r.getBrowserVersion()}:(e=UP(),e||{name:_h,version:void 0})}class HP{constructor(){f(this,"_bowser");f(this,"_name");f(this,"_version");f(this,"getDeviceInfo",()=>({isMobile:this.isMobile(),browserName:this._bowser.getBrowserName(),osName:this._bowser.getOSName(),browserVersion:this._bowser.getBrowserVersion(),osVersionName:this._bowser.getOSVersion(),engineName:this._bowser.getEngineName()}))}init(e){let t,s;if(this._bowser=nh.getParser(navigator.userAgent),typeof e=="undefined"){const i=$P(this._bowser);t=i.name,s=i.version}else e.name in Td?(t=Td[e.name],s=e.version):(t=_h,s=void 0);this._name=t,this._version=s}getName(){return this._name}isChrome(){return this._name===Io}isOpera(){return this._name===jg}isFirefox(){return this._name===Gg}isIExplorer(){return this._name===qg}isSafari(){return this._name===Kg}isNWJS(){return this._name===Wg}isElectron(){return this._name===Jg}isReactNative(){return this._name===zg||navigator.isReactNative===!0}getVersion(){return this._version}isMobile(){return this._bowser.getPlatformType()==="mobile"}_checkCondition(e){if(this._version)return this._bowser.satisfies(e)}isVersionGreaterThan(e){return this._checkCondition({[this._name]:`>${e}`})}isVersionLessThan(e){return this._checkCondition({[this._name]:`<${e}`})}isVersionEqualTo(e){return this._checkCondition({[this._name]:`~${e}`})}}const jP=72;class GP extends HP{doesVideoMuteByStreamRemove(){return this.isChromiumBased()||this.isWebKitBased()}supportsP2P(){return!this.usesUnifiedPlan()}isChromiumBased(){return this.isChrome()||this.isElectron()||this.isNWJS()||this.isOpera()}isWebKitBased(){return this._bowser.isEngine("webkit")&&typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getUserMedia!="undefined"&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(RTCRtpTransceiver.prototype).indexOf("currentDirection")>-1}isSupported(){return this.isChromiumBased()&&this._getChromiumBasedVersion()>=jP||this.isFirefox()||this.isReactNative()||this.isWebKitBased()}isUserInteractionRequiredForUnmute(){return this.isFirefox()&&this.isVersionLessThan("68")}supportsVideoMuteOnConnInterrupted(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsBandwidthStatistics(){return!this.isFirefox()&&!this.isWebKitBased()}supportsCodecPreferences(){return this.usesUnifiedPlan()&&typeof window.RTCRtpTransceiver!="undefined"&&Object.keys(window.RTCRtpTransceiver.prototype).indexOf("setCodecPreferences")>-1&&Object.keys(RTCRtpSender.prototype).indexOf("getCapabilities")>-1&&!this.isWebKitBased()}supportsDeviceChangeEvent(){return navigator.mediaDevices&&typeof navigator.mediaDevices.ondevicechange!="undefined"&&typeof navigator.mediaDevices.addEventListener!="undefined"}supportsLocalCandidateRttStatistics(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}supportsPerformanceObserver(){return typeof window.PerformanceObserver!="undefined"&&PerformanceObserver.supportedEntryTypes.indexOf("longtask")>-1}supportsReceiverStats(){return typeof window.RTCRtpReceiver!="undefined"&&Object.keys(RTCRtpReceiver.prototype).indexOf("getSynchronizationSources")>-1}supportsRTTStatistics(){return!this.isFirefox()}usesPlanB(){return!this.usesUnifiedPlan()}usesSdpMungingForSimulcast(){return this.isChromiumBased()||this.isReactNative()||this.isWebKitBased()}usesUnifiedPlan(){return!!(this.isFirefox()||this.isWebKitBased())}usesNewGumFlow(){return!!(this.isChromiumBased()||this.isFirefox()||this.isWebKitBased())}usesAdapter(){return this.usesNewGumFlow()}usesRidsForSimulcast(){return!1}supportsGetDisplayMedia(){return typeof navigator.getDisplayMedia!="undefined"||typeof navigator.mediaDevices!="undefined"&&typeof navigator.mediaDevices.getDisplayMedia!="undefined"}supportsInsertableStreams(){if(!(typeof window.RTCRtpSender!="undefined"&&(window.RTCRtpSender.prototype.createEncodedStreams||window.RTCRtpSender.prototype.createEncodedVideoStreams)))return!1;const e=new ReadableStream;try{return window.postMessage(e,"*",[e]),!0}catch(t){return!1}}supportsAudioRed(){return Boolean(window.RTCRtpSender&&window.RTCRtpSender.getCapabilities&&window.RTCRtpSender.getCapabilities("audio").codecs.some(e=>e.mimeType==="audio/red")&&window.RTCRtpReceiver&&window.RTCRtpReceiver.getCapabilities&&window.RTCRtpReceiver.getCapabilities("audio").codecs.some(e=>e.mimeType==="audio/red"))}supportsSdpSemantics(){return this.isChromiumBased()}_getChromiumBasedVersion(){if(this.isChromiumBased()){if(this.isNWJS())return Number.parseInt(process.versions.chromium,10);const e=navigator.userAgent;if(e.match(/Chrome/))return Number.parseInt(e.match(/Chrome\/([\d.]+)/)[1],10)}return-1}isIOSMobile(){return this.isMobile&&this._bowser.getOSName()==="iOS"}}const he=new GP,Yg={qvga:{width:{ideal:320},height:{ideal:240}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}},hd_cropped:{width:{ideal:900},height:{ideal:720}}},Xg={},qP=[{rid:"r0",scalabilityMode:"L1T2"},{rid:"r1",scalabilityMode:"L1T2"}],KP=[{active:!1,adaptivePtime:!1,networkPriority:"low",priority:"low"},{active:!1,adaptivePtime:!1,networkPriority:"low",priority:"low"},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:25e5}],WP=[{active:!1,priority:"low"},{active:!1,priority:"low"},{active:!0,priority:"low"}],Qg={320:[{rid:"q",maxBitrate:25e4,maxFramerate:30,scalabilityMode:"L1T3"}],640:[{rid:"q",scaleResolutionDownBy:2,maxBitrate:25e4,maxFramerate:30,scalabilityMode:"L1T3"},{rid:"h",maxBitrate:75e4,maxFramerate:30,scalabilityMode:"L1T3"}],1280:[{rid:"q",scaleResolutionDownBy:4,maxBitrate:25e4,maxFramerate:30,scalabilityMode:"L1T3"},{rid:"h",scaleResolutionDownBy:2,maxBitrate:75e4,maxFramerate:30,scalabilityMode:"L1T3"},{rid:"f",maxBitrate:15e5,maxFramerate:30,scalabilityMode:"L1T3"}]},JP=[{scalabilityMode:"L3T3_KEY"}];var B=(r=>(r.WEBCAM="webcam",r.MIC="mic",r.SCREENSHARE_VIDEO="screenshare_video",r.SCREENSHARE_AUDIO="screenshare_audio",r))(B||{});function zP(r){return r.replace(/([-_]\w)/g,e=>e[1].toUpperCase())}function Sr(r){if(!r||typeof r!="object")return r;if(Array.isArray(r))return r.map(t=>Sr(t));const e={};return Object.keys(r).forEach(t=>{const s=_u(t)?t:zP(t);e[s]=Sr(r[t])}),e}function YP(r){return r.replace(/[A-Z]/g,e=>`_${e.toLowerCase()}`)}function Zg(r){if(!r||typeof r!="object")return r;if(Array.isArray(r))return r.map(t=>Zg(t));const e={};return Object.keys(r).forEach(t=>{const s=_u(t)?t:YP(t);e[s]=r[t]}),e}function vh(r,e={}){return r==null?{}:(Object.getOwnPropertyNames(r).forEach(t=>{if(typeof r[t]!="function"){if(typeof r[t]=="object"){vh(r[t],e[t]={});return}e[t]=r[t]}}),e)}var Th=(r=>(r.PARTICIPANT="PARTICIPANT",r.PEER="PEER",r.CLIENT="CLIENT",r))(Th||{});const U={INTERNAL_CALL_STATS:"internal_call_stats",SIMULCAST:"simulcast",CHAT_SOCKET_SERVER:"chat_socket_server",POLL_SOCKET_SERVER:"poll_socket_server",PLUGIN_SOCKET_SERVER:"plugin_socket_server",NR_OTEL_WEB:"nr_otel_web",CONNECTED_MEETINGS:"connected_meetings",FEAT_SPOTLIGHT:"feat_spotlight",ICE_RESTART_ON_FAILED_STATE:"ice_restart_on_failed_state",ICE_RESTART_ON_DISCONNECTED_STATE:"ice_restart_on_disconnected_state",ENABLE_ICE_STATE_LOGGING:"enable_ice_state_logging",REMOVE_OPERATIONAL_MIC:"web_core_remove_operational_mic",SUPPRESS_PEER_MUTE_UNMUTE_EMITS:"web_core_suppress_peer_mute_unmute_emits",SKIP_OTEL_TRACES:"skip_otel_traces",NEW_LOCAL_MEDIA_HANDLER:"new_local_media_handler",CALLSTATS_INGESTION_LAYER:"callstats_ingestion_layer",USE_USERIDS_IN_CHAT:"use_userids_in_chat",CUSTOM_PING_PONG:"custom_ping_pong",ENABLE_HIVE_SIMULCAST:"enable_hive_simulcast",ENABLE_HIVE_TRANSPORT_RECONNECTION_ON_ICE_FAILED:"enable_hive_transport_reconnection_on_ice_failed",ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY:"enable_hive_fail_recovery",BYPASS_LOG_EXCLUSION_LIST:"bypass_log_exclusion_list",LOG_LEVEL:"log_level",V1_PLUGINS:"v1_plugins",SCREENSHARE_DTX:"screenshare_dtx",SCREENSHARE_PRIORITY:"screenshare_priority",SCREENSHARE_MIN_BITRATE:"screenshare_minbitrate",SCREENSHARE_MAX_DIMENSIONS:"screenshare_maxdimensions",SCREENSHARE_SIMULCAST:"screenshare_simulcast",DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE:"disable_webcam_layers_on_screenshare",SCREENSHARE_FORCE_GOOG_CONFERENCE:"screenshare_force_goog_conference",LIVESTREAM:"feat_livestream",FETCH_RETRY:"fetch_retry",DEVICE_REMOVE_EXP:"device_remove_exp",DISABLE_WEBCAM_SIMULCAST:"webcore_disable_webcam_simulcast",OVERRIDE_WEBCAM_SIMULCAST:"override_webcam_simulcast",SOCKET_POLLING:"socket_polling",NS_NETWORK_SCORE:"ns_network_score",FEAT_PAGINATED_CHAT:"feat_paginated_chat",VAL_MIN_FRAMERATE:"val_min_framerate",EXTENSION_HACK:"extension_hack",VAL_MAX_FRAMERATE_EXT:"val_max_framerate_ext",VAL_MIN_FRAMERATE_EXT:"val_min_framerate_ext",SCREEENSHARE_ERR_HACK:"screenshare_err_hack",TROUBLESHOOTING:"feat_troubleshooting",VIDEO_CONSTRAINTS:"video_constraints",SCREENSHARE_CONSTRAINTS:"screenshare_constraints",FEAT_CHAT_SDK:"feat_chat_sdk"},_e={roomName:void 0,authToken:void 0,peerId:void 0,apiBase:void 0,defaults:{audio:!0,video:!0},modules:void 0,organizationId:void 0,overrides:{}};function XP(r){var e,t,s,i,n,a,o;(e=_e.roomName)!=null||(_e.roomName=r==null?void 0:r.roomName),(t=_e.authToken)!=null||(_e.authToken=r==null?void 0:r.authToken),(s=_e.peerId)!=null||(_e.peerId=r==null?void 0:r.peerId),(i=_e.apiBase)!=null||(_e.apiBase=r==null?void 0:r.apiBase),(n=_e.modules)!=null||(_e.modules=r==null?void 0:r.modules),(a=_e.organizationId)!=null||(_e.organizationId=r==null?void 0:r.organizationId),_e.defaults={..._e.defaults,...(o=r==null?void 0:r.defaults)!=null?o:{}}}const ca="1.16.0",Ed="web-core",QP=UC(),sr=Sr(QP.config.media);class e_{constructor(e){S(this,oc,void 0);f(this,"getScreenShareConstraints",()=>{var s,i;const{displaySurface:e}=(s=_e.defaults.screenShare)!=null?s:{};let t={width:{max:1920},height:{max:1080},frameRate:{ideal:parseInt((i=x.getValue(U.VAL_MIN_FRAMERATE))!=null?i:"5",10),max:5}};if(x.hasFeature(U.SCREENSHARE_CONSTRAINTS)){const n=x.getValue(U.SCREENSHARE_CONSTRAINTS);t=JSON.parse(n)}return e!==void 0&&["monitor","browser","window"].includes(e)&&(t={...t,displaySurface:e}),{audio:!0,video:t}});f(this,"getAudioConstraints",e=>{const t={};return he.isFirefox()||he.isWebKitBased()?(t.audio={deviceId:e,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},t):(t.audio={},t.audio.optional=[e?{sourceId:e}:{sourceId:"default"},{echoCancellation:!0},{googEchoCancellation:!0},{googAutoGainControl:!0},{googNoiseSuppression:!0},{googHighpassFilter:!0}],t)});f(this,"getVideoConstraints",e=>{const t={},{quality:s}=d(this,oc).video;let i=Yg[s];if(i.frameRate={ideal:24},he.isChromiumBased()&&(i.frameRate.max=30),x.hasFeature(U.VIDEO_CONSTRAINTS)){const n=x.getValue(U.VIDEO_CONSTRAINTS);i=JSON.parse(n)}return t.video=i,e?t.video.deviceId={exact:e}:t.video.facingMode="user",t});R(this,oc,e!=null?e:sr)}}oc=new WeakMap;var ZP=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof window=="object"?window:typeof global=="object"?global:{},zi="1.4.1",t_=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function eA(r){var e=new Set([r]),t=new Set,s=r.match(t_);if(!s)return function(){return!1};var i={major:+s[1],minor:+s[2],patch:+s[3],prerelease:s[4]};if(i.prerelease!=null)return function(c){return c===r};function n(o){return t.add(o),!1}function a(o){return e.add(o),!0}return function(c){if(e.has(c))return!0;if(t.has(c))return!1;var l=c.match(t_);if(!l)return n(c);var u={major:+l[1],minor:+l[2],patch:+l[3],prerelease:l[4]};return u.prerelease!=null||i.major!==u.major?n(c):i.major===0?i.minor===u.minor&&i.patch<=u.patch?a(c):n(c):i.minor<=u.minor?a(c):n(c)}}var tA=eA(zi),rA=zi.split(".")[0],ko=Symbol.for("opentelemetry.js.api."+rA),Oo=ZP;function Do(r,e,t,s){var i;s===void 0&&(s=!1);var n=Oo[ko]=(i=Oo[ko])!==null&&i!==void 0?i:{version:zi};if(!s&&n[r]){var a=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+r);return t.error(a.stack||a.message),!1}if(n.version!==zi){var a=new Error("@opentelemetry/api: Registration of version v"+n.version+" for "+r+" does not match previously registered API v"+zi);return t.error(a.stack||a.message),!1}return n[r]=e,t.debug("@opentelemetry/api: Registered a global for "+r+" v"+zi+"."),!0}function Yi(r){var e,t,s=(e=Oo[ko])===null||e===void 0?void 0:e.version;if(!(!s||!tA(s)))return(t=Oo[ko])===null||t===void 0?void 0:t[r]}function Mo(r,e){e.debug("@opentelemetry/api: Unregistering a global for "+r+" v"+zi+".");var t=Oo[ko];t&&delete t[r]}var sA=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},iA=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},nA=function(){function r(e){this._namespace=e.namespace||"DiagComponentLogger"}return r.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return No("debug",this._namespace,e)},r.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return No("error",this._namespace,e)},r.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return No("info",this._namespace,e)},r.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return No("warn",this._namespace,e)},r.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return No("verbose",this._namespace,e)},r}();function No(r,e,t){var s=Yi("diag");if(s)return t.unshift(e),s[r].apply(s,iA([],sA(t),!1))}var et;(function(r){r[r.NONE=0]="NONE",r[r.ERROR=30]="ERROR",r[r.WARN=50]="WARN",r[r.INFO=60]="INFO",r[r.DEBUG=70]="DEBUG",r[r.VERBOSE=80]="VERBOSE",r[r.ALL=9999]="ALL"})(et||(et={}));function aA(r,e){r<et.NONE?r=et.NONE:r>et.ALL&&(r=et.ALL),e=e||{};function t(s,i){var n=e[s];return typeof n=="function"&&r>=i?n.bind(e):function(){}}return{error:t("error",et.ERROR),warn:t("warn",et.WARN),info:t("info",et.INFO),debug:t("debug",et.DEBUG),verbose:t("verbose",et.VERBOSE)}}var oA=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},cA=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},dA="diag",es=function(){function r(){function e(i){return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var o=Yi("diag");if(o)return o[i].apply(o,cA([],oA(n),!1))}}var t=this,s=function(i,n){var a,o,c;if(n===void 0&&(n={logLevel:et.INFO}),i===t){var l=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error((a=l.stack)!==null&&a!==void 0?a:l.message),!1}typeof n=="number"&&(n={logLevel:n});var u=Yi("diag"),h=aA((o=n.logLevel)!==null&&o!==void 0?o:et.INFO,i);if(u&&!n.suppressOverrideMessage){var p=(c=new Error().stack)!==null&&c!==void 0?c:"<failed to generate stacktrace>";u.warn("Current logger will be overwritten from "+p),h.warn("Current logger will overwrite one already registered from "+p)}return Do("diag",h,t,!0)};t.setLogger=s,t.disable=function(){Mo(dA,t)},t.createComponentLogger=function(i){return new nA(i)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return r.instance=function(){return this._instance||(this._instance=new r),this._instance},r}(),lA=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},uA=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},hA=function(){function r(e){this._entries=e?new Map(e):new Map}return r.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},r.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=lA(e,2),s=t[0],i=t[1];return[s,i]})},r.prototype.setEntry=function(e,t){var s=new r(this._entries);return s._entries.set(e,t),s},r.prototype.removeEntry=function(e){var t=new r(this._entries);return t._entries.delete(e),t},r.prototype.removeEntries=function(){for(var e,t,s=[],i=0;i<arguments.length;i++)s[i]=arguments[i];var n=new r(this._entries);try{for(var a=uA(s),o=a.next();!o.done;o=a.next()){var c=o.value;n._entries.delete(c)}}catch(l){e={error:l}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}return n},r.prototype.clear=function(){return new r},r}(),pA=Symbol("BaggageEntryMetadata"),fA=es.instance();function mA(r){return r===void 0&&(r={}),new hA(new Map(Object.entries(r)))}function gA(r){return typeof r!="string"&&(fA.error("Cannot create baggage metadata from unknown type: "+typeof r),r=""),{__TYPE__:pA,toString:function(){return r}}}function Eh(r){return Symbol.for(r)}var _A=function(){function r(e){var t=this;t._currentContext=e?new Map(e):new Map,t.getValue=function(s){return t._currentContext.get(s)},t.setValue=function(s,i){var n=new r(t._currentContext);return n._currentContext.set(s,i),n},t.deleteValue=function(s){var i=new r(t._currentContext);return i._currentContext.delete(s),i}}return r}(),wr=new _A,da=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),vA=function(){function r(){}return r.prototype.createHistogram=function(e,t){return PA},r.prototype.createCounter=function(e,t){return CA},r.prototype.createUpDownCounter=function(e,t){return AA},r.prototype.createObservableGauge=function(e,t){return kA},r.prototype.createObservableCounter=function(e,t){return IA},r.prototype.createObservableUpDownCounter=function(e,t){return OA},r.prototype.addBatchObservableCallback=function(e,t){},r.prototype.removeBatchObservableCallback=function(e){},r}(),yh=function(){function r(){}return r}(),TA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.add=function(t,s){},e}(yh),EA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.add=function(t,s){},e}(yh),yA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e.prototype.record=function(t,s){},e}(yh),Sh=function(){function r(){}return r.prototype.addCallback=function(e){},r.prototype.removeCallback=function(e){},r}(),SA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(Sh),wA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(Sh),RA=function(r){da(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(Sh),bA=new vA,CA=new TA,PA=new yA,AA=new EA,IA=new SA,kA=new wA,OA=new RA,DA={get:function(r,e){if(r!=null)return r[e]},keys:function(r){return r==null?[]:Object.keys(r)}},MA={set:function(r,e,t){r!=null&&(r[e]=t)}},NA=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},LA=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},xA=function(){function r(){}return r.prototype.active=function(){return wr},r.prototype.with=function(e,t,s){for(var i=[],n=3;n<arguments.length;n++)i[n-3]=arguments[n];return t.call.apply(t,LA([s],NA(i),!1))},r.prototype.bind=function(e,t){return t},r.prototype.enable=function(){return this},r.prototype.disable=function(){return this},r}(),UA=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},BA=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},wh="context",FA=new xA,yd=function(){function r(){}return r.getInstance=function(){return this._instance||(this._instance=new r),this._instance},r.prototype.setGlobalContextManager=function(e){return Do(wh,e,es.instance())},r.prototype.active=function(){return this._getContextManager().active()},r.prototype.with=function(e,t,s){for(var i,n=[],a=3;a<arguments.length;a++)n[a-3]=arguments[a];return(i=this._getContextManager()).with.apply(i,BA([e,t,s],UA(n),!1))},r.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},r.prototype._getContextManager=function(){return Yi(wh)||FA},r.prototype.disable=function(){this._getContextManager().disable(),Mo(wh,es.instance())},r}(),ys;(function(r){r[r.NONE=0]="NONE",r[r.SAMPLED=1]="SAMPLED"})(ys||(ys={}));var r_="0000000000000000",s_="00000000000000000000000000000000",i_={traceId:s_,spanId:r_,traceFlags:ys.NONE},Lo=function(){function r(e){e===void 0&&(e=i_),this._spanContext=e}return r.prototype.spanContext=function(){return this._spanContext},r.prototype.setAttribute=function(e,t){return this},r.prototype.setAttributes=function(e){return this},r.prototype.addEvent=function(e,t){return this},r.prototype.setStatus=function(e){return this},r.prototype.updateName=function(e){return this},r.prototype.end=function(e){},r.prototype.isRecording=function(){return!1},r.prototype.recordException=function(e,t){},r}(),Rh=Eh("OpenTelemetry Context Key SPAN");function bh(r){return r.getValue(Rh)||void 0}function VA(){return bh(yd.getInstance().active())}function Ch(r,e){return r.setValue(Rh,e)}function $A(r){return r.deleteValue(Rh)}function HA(r,e){return Ch(r,new Lo(e))}function n_(r){var e;return(e=bh(r))===null||e===void 0?void 0:e.spanContext()}var jA=/^([0-9a-f]{32})$/i,GA=/^[0-9a-f]{16}$/i;function a_(r){return jA.test(r)&&r!==s_}function qA(r){return GA.test(r)&&r!==r_}function Sd(r){return a_(r.traceId)&&qA(r.spanId)}function KA(r){return new Lo(r)}var Ph=yd.getInstance(),o_=function(){function r(){}return r.prototype.startSpan=function(e,t,s){s===void 0&&(s=Ph.active());var i=Boolean(t==null?void 0:t.root);if(i)return new Lo;var n=s&&n_(s);return WA(n)&&Sd(n)?new Lo(n):new Lo},r.prototype.startActiveSpan=function(e,t,s,i){var n,a,o;if(!(arguments.length<2)){arguments.length===2?o=t:arguments.length===3?(n=t,o=s):(n=t,a=s,o=i);var c=a!=null?a:Ph.active(),l=this.startSpan(e,n,c),u=Ch(c,l);return Ph.with(u,o,void 0,l)}},r}();function WA(r){return typeof r=="object"&&typeof r.spanId=="string"&&typeof r.traceId=="string"&&typeof r.traceFlags=="number"}var JA=new o_,zA=function(){function r(e,t,s,i){this._provider=e,this.name=t,this.version=s,this.options=i}return r.prototype.startSpan=function(e,t,s){return this._getTracer().startSpan(e,t,s)},r.prototype.startActiveSpan=function(e,t,s,i){var n=this._getTracer();return Reflect.apply(n.startActiveSpan,n,arguments)},r.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):JA},r}(),YA=function(){function r(){}return r.prototype.getTracer=function(e,t,s){return new o_},r}(),XA=new YA,c_=function(){function r(){}return r.prototype.getTracer=function(e,t,s){var i;return(i=this.getDelegateTracer(e,t,s))!==null&&i!==void 0?i:new zA(this,e,t,s)},r.prototype.getDelegate=function(){var e;return(e=this._delegate)!==null&&e!==void 0?e:XA},r.prototype.setDelegate=function(e){this._delegate=e},r.prototype.getDelegateTracer=function(e,t,s){var i;return(i=this._delegate)===null||i===void 0?void 0:i.getTracer(e,t,s)},r}(),wd;(function(r){r[r.NOT_RECORD=0]="NOT_RECORD",r[r.RECORD=1]="RECORD",r[r.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"})(wd||(wd={}));var Ah;(function(r){r[r.INTERNAL=0]="INTERNAL",r[r.SERVER=1]="SERVER",r[r.CLIENT=2]="CLIENT",r[r.PRODUCER=3]="PRODUCER",r[r.CONSUMER=4]="CONSUMER"})(Ah||(Ah={}));var Ih;(function(r){r[r.UNSET=0]="UNSET",r[r.OK=1]="OK",r[r.ERROR=2]="ERROR"})(Ih||(Ih={}));var Xi=yd.getInstance(),ue=es.instance(),QA=function(){function r(){}return r.prototype.getMeter=function(e,t,s){return bA},r}(),ZA=new QA,kh="metrics",eI=function(){function r(){}return r.getInstance=function(){return this._instance||(this._instance=new r),this._instance},r.prototype.setGlobalMeterProvider=function(e){return Do(kh,e,es.instance())},r.prototype.getMeterProvider=function(){return Yi(kh)||ZA},r.prototype.getMeter=function(e,t,s){return this.getMeterProvider().getMeter(e,t,s)},r.prototype.disable=function(){Mo(kh,es.instance())},r}(),tI=eI.getInstance(),rI=function(){function r(){}return r.prototype.inject=function(e,t){},r.prototype.extract=function(e,t){return e},r.prototype.fields=function(){return[]},r}(),Oh=Eh("OpenTelemetry Baggage Key");function d_(r){return r.getValue(Oh)||void 0}function sI(){return d_(yd.getInstance().active())}function iI(r,e){return r.setValue(Oh,e)}function nI(r){return r.deleteValue(Oh)}var Dh="propagation",aI=new rI,oI=function(){function r(){this.createBaggage=mA,this.getBaggage=d_,this.getActiveBaggage=sI,this.setBaggage=iI,this.deleteBaggage=nI}return r.getInstance=function(){return this._instance||(this._instance=new r),this._instance},r.prototype.setGlobalPropagator=function(e){return Do(Dh,e,es.instance())},r.prototype.inject=function(e,t,s){return s===void 0&&(s=MA),this._getGlobalPropagator().inject(e,t,s)},r.prototype.extract=function(e,t,s){return s===void 0&&(s=DA),this._getGlobalPropagator().extract(e,t,s)},r.prototype.fields=function(){return this._getGlobalPropagator().fields()},r.prototype.disable=function(){Mo(Dh,es.instance())},r.prototype._getGlobalPropagator=function(){return Yi(Dh)||aI},r}(),la=oI.getInstance(),Mh="trace",cI=function(){function r(){this._proxyTracerProvider=new c_,this.wrapSpanContext=KA,this.isSpanContextValid=Sd,this.deleteSpan=$A,this.getSpan=bh,this.getActiveSpan=VA,this.getSpanContext=n_,this.setSpan=Ch,this.setSpanContext=HA}return r.getInstance=function(){return this._instance||(this._instance=new r),this._instance},r.prototype.setGlobalTracerProvider=function(e){var t=Do(Mh,this._proxyTracerProvider,es.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},r.prototype.getTracerProvider=function(){return Yi(Mh)||this._proxyTracerProvider},r.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},r.prototype.disable=function(){Mo(Mh,es.instance()),this._proxyTracerProvider=new c_},r}(),Lr=cI.getInstance();const Rd={context:Xi,diag:ue,metrics:tI,propagation:la,trace:Lr};var l_=Eh("OpenTelemetry SDK Context Key SUPPRESS_TRACING");function dI(r){return r.setValue(l_,!0)}function Nh(r){return r.getValue(l_)===!0}var lI="=",Lh=";",bd=",",xh="baggage",uI=180,hI=4096,pI=8192,fI=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n};function mI(r){return r.reduce(function(e,t){var s=""+e+(e!==""?bd:"")+t;return s.length>pI?e:s},"")}function gI(r){return r.getAllEntries().map(function(e){var t=fI(e,2),s=t[0],i=t[1],n=encodeURIComponent(s)+"="+encodeURIComponent(i.value);return i.metadata!==void 0&&(n+=Lh+i.metadata.toString()),n})}function u_(r){var e=r.split(Lh);if(!(e.length<=0)){var t=e.shift();if(t){var s=t.split(lI);if(s.length===2){var i=decodeURIComponent(s[0].trim()),n=decodeURIComponent(s[1].trim()),a;return e.length>0&&(a=gA(e.join(Lh))),{key:i,value:n,metadata:a}}}}}function h_(r){return typeof r!="string"||r.length===0?{}:r.split(bd).map(function(e){return u_(e)}).filter(function(e){return e!==void 0&&e.value.length>0}).reduce(function(e,t){return e[t.key]=t.value,e},{})}var _I=function(){function r(){}return r.prototype.inject=function(e,t,s){var i=la.getBaggage(e);if(!(!i||Nh(e))){var n=gI(i).filter(function(o){return o.length<=hI}).slice(0,uI),a=mI(n);a.length>0&&s.set(t,xh,a)}},r.prototype.extract=function(e,t,s){var i=s.get(t,xh),n=Array.isArray(i)?i.join(bd):i;if(!n)return e;var a={};if(n.length===0)return e;var o=n.split(bd);return o.forEach(function(c){var l=u_(c);if(l){var u={value:l.value};l.metadata&&(u.metadata=l.metadata),a[l.key]=u}}),Object.entries(a).length===0?e:la.setBaggage(e,la.createBaggage(a))},r.prototype.fields=function(){return[xh]},r}(),p_=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},vI=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n};function Cd(r){var e,t,s={};if(typeof r!="object"||r==null)return s;try{for(var i=p_(Object.entries(r)),n=i.next();!n.done;n=i.next()){var a=vI(n.value,2),o=a[0],c=a[1];if(!TI(o)){ue.warn("Invalid attribute key: "+o);continue}if(!f_(c)){ue.warn("Invalid attribute value set for key: "+o);continue}Array.isArray(c)?s[o]=c.slice():s[o]=c}}catch(l){e={error:l}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return s}function TI(r){return typeof r=="string"&&r.length>0}function f_(r){return r==null?!0:Array.isArray(r)?EI(r):m_(r)}function EI(r){var e,t,s;try{for(var i=p_(r),n=i.next();!n.done;n=i.next()){var a=n.value;if(a!=null){if(!s){if(m_(a)){s=typeof a;continue}return!1}if(typeof a!==s)return!1}}}catch(o){e={error:o}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return!0}function m_(r){switch(typeof r){case"number":case"boolean":case"string":return!0}return!1}function yI(){return function(r){ue.error(SI(r))}}function SI(r){return typeof r=="string"?r:JSON.stringify(wI(r))}function wI(r){for(var e={},t=r;t!==null;)Object.getOwnPropertyNames(t).forEach(function(s){if(!e[s]){var i=t[s];i&&(e[s]=String(i))}}),t=Object.getPrototypeOf(t);return e}var RI=yI();function Pd(r){try{RI(r)}catch(e){}}var ts;(function(r){r.AlwaysOff="always_off",r.AlwaysOn="always_on",r.ParentBasedAlwaysOff="parentbased_always_off",r.ParentBasedAlwaysOn="parentbased_always_on",r.ParentBasedTraceIdRatio="parentbased_traceidratio",r.TraceIdRatio="traceidratio"})(ts||(ts={}));var g_=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof window=="object"?window:typeof global=="object"?global:{},bI=",",CI=["OTEL_SDK_DISABLED"];function PI(r){return CI.indexOf(r)>-1}var AI=["OTEL_BSP_EXPORT_TIMEOUT","OTEL_BSP_MAX_EXPORT_BATCH_SIZE","OTEL_BSP_MAX_QUEUE_SIZE","OTEL_BSP_SCHEDULE_DELAY","OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_EVENT_COUNT_LIMIT","OTEL_SPAN_LINK_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT","OTEL_EXPORTER_OTLP_TIMEOUT","OTEL_EXPORTER_OTLP_TRACES_TIMEOUT","OTEL_EXPORTER_OTLP_METRICS_TIMEOUT","OTEL_EXPORTER_JAEGER_AGENT_PORT"];function II(r){return AI.indexOf(r)>-1}var kI=["OTEL_NO_PATCH_MODULES","OTEL_PROPAGATORS"];function OI(r){return kI.indexOf(r)>-1}var Uh=1/0,Bh=128,DI=128,MI=128,__={OTEL_SDK_DISABLED:!1,CONTAINER_NAME:"",ECS_CONTAINER_METADATA_URI_V4:"",ECS_CONTAINER_METADATA_URI:"",HOSTNAME:"",KUBERNETES_SERVICE_HOST:"",NAMESPACE:"",OTEL_BSP_EXPORT_TIMEOUT:3e4,OTEL_BSP_MAX_EXPORT_BATCH_SIZE:512,OTEL_BSP_MAX_QUEUE_SIZE:2048,OTEL_BSP_SCHEDULE_DELAY:5e3,OTEL_EXPORTER_JAEGER_AGENT_HOST:"",OTEL_EXPORTER_JAEGER_AGENT_PORT:6832,OTEL_EXPORTER_JAEGER_ENDPOINT:"",OTEL_EXPORTER_JAEGER_PASSWORD:"",OTEL_EXPORTER_JAEGER_USER:"",OTEL_EXPORTER_OTLP_ENDPOINT:"",OTEL_EXPORTER_OTLP_TRACES_ENDPOINT:"",OTEL_EXPORTER_OTLP_METRICS_ENDPOINT:"",OTEL_EXPORTER_OTLP_HEADERS:"",OTEL_EXPORTER_OTLP_TRACES_HEADERS:"",OTEL_EXPORTER_OTLP_METRICS_HEADERS:"",OTEL_EXPORTER_OTLP_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_TRACES_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_METRICS_TIMEOUT:1e4,OTEL_EXPORTER_ZIPKIN_ENDPOINT:"http://localhost:9411/api/v2/spans",OTEL_LOG_LEVEL:et.INFO,OTEL_NO_PATCH_MODULES:[],OTEL_PROPAGATORS:["tracecontext","baggage"],OTEL_RESOURCE_ATTRIBUTES:"",OTEL_SERVICE_NAME:"",OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT:Uh,OTEL_ATTRIBUTE_COUNT_LIMIT:Bh,OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT:Uh,OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT:Bh,OTEL_SPAN_EVENT_COUNT_LIMIT:128,OTEL_SPAN_LINK_COUNT_LIMIT:128,OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT:DI,OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT:MI,OTEL_TRACES_EXPORTER:"",OTEL_TRACES_SAMPLER:ts.ParentBasedAlwaysOn,OTEL_TRACES_SAMPLER_ARG:"",OTEL_EXPORTER_OTLP_INSECURE:"",OTEL_EXPORTER_OTLP_TRACES_INSECURE:"",OTEL_EXPORTER_OTLP_METRICS_INSECURE:"",OTEL_EXPORTER_OTLP_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CERTIFICATE:"",OTEL_EXPORTER_OTLP_COMPRESSION:"",OTEL_EXPORTER_OTLP_TRACES_COMPRESSION:"",OTEL_EXPORTER_OTLP_METRICS_COMPRESSION:"",OTEL_EXPORTER_OTLP_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_TRACES_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE:"cumulative"};function NI(r,e,t){if(typeof t[r]!="undefined"){var s=String(t[r]);e[r]=s.toLowerCase()==="true"}}function LI(r,e,t,s,i){if(s===void 0&&(s=-1/0),i===void 0&&(i=1/0),typeof t[r]!="undefined"){var n=Number(t[r]);isNaN(n)||(n<s?e[r]=s:n>i?e[r]=i:e[r]=n)}}function xI(r,e,t,s){s===void 0&&(s=bI);var i=t[r];typeof i=="string"&&(e[r]=i.split(s).map(function(n){return n.trim()}))}var UI={ALL:et.ALL,VERBOSE:et.VERBOSE,DEBUG:et.DEBUG,INFO:et.INFO,WARN:et.WARN,ERROR:et.ERROR,NONE:et.NONE};function BI(r,e,t){var s=t[r];if(typeof s=="string"){var i=UI[s.toUpperCase()];i!=null&&(e[r]=i)}}function Fh(r){var e={};for(var t in __){var s=t;switch(s){case"OTEL_LOG_LEVEL":BI(s,e,r);break;default:if(PI(s))NI(s,e,r);else if(II(s))LI(s,e,r);else if(OI(s))xI(s,e,r);else{var i=r[s];typeof i!="undefined"&&i!==null&&(e[s]=String(i))}}}return e}function FI(){return typeof process!="undefined"&&process&&process.env?Fh(process.env):Fh(g_)}function tt(){var r=Fh(g_);return Object.assign({},__,r)}function xo(r){for(var e=r.length,t="",s=0;s<e;s+=2){var i=r.substring(s,s+2),n=parseInt(i,16);t+=String.fromCharCode(n)}return btoa(t)}var ua=performance,VI="1.10.0",Qi={AWS_LAMBDA_INVOKED_ARN:"aws.lambda.invoked_arn",DB_SYSTEM:"db.system",DB_CONNECTION_STRING:"db.connection_string",DB_USER:"db.user",DB_JDBC_DRIVER_CLASSNAME:"db.jdbc.driver_classname",DB_NAME:"db.name",DB_STATEMENT:"db.statement",DB_OPERATION:"db.operation",DB_MSSQL_INSTANCE_NAME:"db.mssql.instance_name",DB_CASSANDRA_KEYSPACE:"db.cassandra.keyspace",DB_CASSANDRA_PAGE_SIZE:"db.cassandra.page_size",DB_CASSANDRA_CONSISTENCY_LEVEL:"db.cassandra.consistency_level",DB_CASSANDRA_TABLE:"db.cassandra.table",DB_CASSANDRA_IDEMPOTENCE:"db.cassandra.idempotence",DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT:"db.cassandra.speculative_execution_count",DB_CASSANDRA_COORDINATOR_ID:"db.cassandra.coordinator.id",DB_CASSANDRA_COORDINATOR_DC:"db.cassandra.coordinator.dc",DB_HBASE_NAMESPACE:"db.hbase.namespace",DB_REDIS_DATABASE_INDEX:"db.redis.database_index",DB_MONGODB_COLLECTION:"db.mongodb.collection",DB_SQL_TABLE:"db.sql.table",EXCEPTION_TYPE:"exception.type",EXCEPTION_MESSAGE:"exception.message",EXCEPTION_STACKTRACE:"exception.stacktrace",EXCEPTION_ESCAPED:"exception.escaped",FAAS_TRIGGER:"faas.trigger",FAAS_EXECUTION:"faas.execution",FAAS_DOCUMENT_COLLECTION:"faas.document.collection",FAAS_DOCUMENT_OPERATION:"faas.document.operation",FAAS_DOCUMENT_TIME:"faas.document.time",FAAS_DOCUMENT_NAME:"faas.document.name",FAAS_TIME:"faas.time",FAAS_CRON:"faas.cron",FAAS_COLDSTART:"faas.coldstart",FAAS_INVOKED_NAME:"faas.invoked_name",FAAS_INVOKED_PROVIDER:"faas.invoked_provider",FAAS_INVOKED_REGION:"faas.invoked_region",NET_TRANSPORT:"net.transport",NET_PEER_IP:"net.peer.ip",NET_PEER_PORT:"net.peer.port",NET_PEER_NAME:"net.peer.name",NET_HOST_IP:"net.host.ip",NET_HOST_PORT:"net.host.port",NET_HOST_NAME:"net.host.name",NET_HOST_CONNECTION_TYPE:"net.host.connection.type",NET_HOST_CONNECTION_SUBTYPE:"net.host.connection.subtype",NET_HOST_CARRIER_NAME:"net.host.carrier.name",NET_HOST_CARRIER_MCC:"net.host.carrier.mcc",NET_HOST_CARRIER_MNC:"net.host.carrier.mnc",NET_HOST_CARRIER_ICC:"net.host.carrier.icc",PEER_SERVICE:"peer.service",ENDUSER_ID:"enduser.id",ENDUSER_ROLE:"enduser.role",ENDUSER_SCOPE:"enduser.scope",THREAD_ID:"thread.id",THREAD_NAME:"thread.name",CODE_FUNCTION:"code.function",CODE_NAMESPACE:"code.namespace",CODE_FILEPATH:"code.filepath",CODE_LINENO:"code.lineno",HTTP_METHOD:"http.method",HTTP_URL:"http.url",HTTP_TARGET:"http.target",HTTP_HOST:"http.host",HTTP_SCHEME:"http.scheme",HTTP_STATUS_CODE:"http.status_code",HTTP_FLAVOR:"http.flavor",HTTP_USER_AGENT:"http.user_agent",HTTP_REQUEST_CONTENT_LENGTH:"http.request_content_length",HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED:"http.request_content_length_uncompressed",HTTP_RESPONSE_CONTENT_LENGTH:"http.response_content_length",HTTP_RESPONSE_CONTENT_LENGTH_UNCOMPRESSED:"http.response_content_length_uncompressed",HTTP_SERVER_NAME:"http.server_name",HTTP_ROUTE:"http.route",HTTP_CLIENT_IP:"http.client_ip",AWS_DYNAMODB_TABLE_NAMES:"aws.dynamodb.table_names",AWS_DYNAMODB_CONSUMED_CAPACITY:"aws.dynamodb.consumed_capacity",AWS_DYNAMODB_ITEM_COLLECTION_METRICS:"aws.dynamodb.item_collection_metrics",AWS_DYNAMODB_PROVISIONED_READ_CAPACITY:"aws.dynamodb.provisioned_read_capacity",AWS_DYNAMODB_PROVISIONED_WRITE_CAPACITY:"aws.dynamodb.provisioned_write_capacity",AWS_DYNAMODB_CONSISTENT_READ:"aws.dynamodb.consistent_read",AWS_DYNAMODB_PROJECTION:"aws.dynamodb.projection",AWS_DYNAMODB_LIMIT:"aws.dynamodb.limit",AWS_DYNAMODB_ATTRIBUTES_TO_GET:"aws.dynamodb.attributes_to_get",AWS_DYNAMODB_INDEX_NAME:"aws.dynamodb.index_name",AWS_DYNAMODB_SELECT:"aws.dynamodb.select",AWS_DYNAMODB_GLOBAL_SECONDARY_INDEXES:"aws.dynamodb.global_secondary_indexes",AWS_DYNAMODB_LOCAL_SECONDARY_INDEXES:"aws.dynamodb.local_secondary_indexes",AWS_DYNAMODB_EXCLUSIVE_START_TABLE:"aws.dynamodb.exclusive_start_table",AWS_DYNAMODB_TABLE_COUNT:"aws.dynamodb.table_count",AWS_DYNAMODB_SCAN_FORWARD:"aws.dynamodb.scan_forward",AWS_DYNAMODB_SEGMENT:"aws.dynamodb.segment",AWS_DYNAMODB_TOTAL_SEGMENTS:"aws.dynamodb.total_segments",AWS_DYNAMODB_COUNT:"aws.dynamodb.count",AWS_DYNAMODB_SCANNED_COUNT:"aws.dynamodb.scanned_count",AWS_DYNAMODB_ATTRIBUTE_DEFINITIONS:"aws.dynamodb.attribute_definitions",AWS_DYNAMODB_GLOBAL_SECONDARY_INDEX_UPDATES:"aws.dynamodb.global_secondary_index_updates",MESSAGING_SYSTEM:"messaging.system",MESSAGING_DESTINATION:"messaging.destination",MESSAGING_DESTINATION_KIND:"messaging.destination_kind",MESSAGING_TEMP_DESTINATION:"messaging.temp_destination",MESSAGING_PROTOCOL:"messaging.protocol",MESSAGING_PROTOCOL_VERSION:"messaging.protocol_version",MESSAGING_URL:"messaging.url",MESSAGING_MESSAGE_ID:"messaging.message_id",MESSAGING_CONVERSATION_ID:"messaging.conversation_id",MESSAGING_MESSAGE_PAYLOAD_SIZE_BYTES:"messaging.message_payload_size_bytes",MESSAGING_MESSAGE_PAYLOAD_COMPRESSED_SIZE_BYTES:"messaging.message_payload_compressed_size_bytes",MESSAGING_OPERATION:"messaging.operation",MESSAGING_CONSUMER_ID:"messaging.consumer_id",MESSAGING_RABBITMQ_ROUTING_KEY:"messaging.rabbitmq.routing_key",MESSAGING_KAFKA_MESSAGE_KEY:"messaging.kafka.message_key",MESSAGING_KAFKA_CONSUMER_GROUP:"messaging.kafka.consumer_group",MESSAGING_KAFKA_CLIENT_ID:"messaging.kafka.client_id",MESSAGING_KAFKA_PARTITION:"messaging.kafka.partition",MESSAGING_KAFKA_TOMBSTONE:"messaging.kafka.tombstone",RPC_SYSTEM:"rpc.system",RPC_SERVICE:"rpc.service",RPC_METHOD:"rpc.method",RPC_GRPC_STATUS_CODE:"rpc.grpc.status_code",RPC_JSONRPC_VERSION:"rpc.jsonrpc.version",RPC_JSONRPC_REQUEST_ID:"rpc.jsonrpc.request_id",RPC_JSONRPC_ERROR_CODE:"rpc.jsonrpc.error_code",RPC_JSONRPC_ERROR_MESSAGE:"rpc.jsonrpc.error_message",MESSAGE_TYPE:"message.type",MESSAGE_ID:"message.id",MESSAGE_COMPRESSED_SIZE:"message.compressed_size",MESSAGE_UNCOMPRESSED_SIZE:"message.uncompressed_size"},xr={CLOUD_PROVIDER:"cloud.provider",CLOUD_ACCOUNT_ID:"cloud.account.id",CLOUD_REGION:"cloud.region",CLOUD_AVAILABILITY_ZONE:"cloud.availability_zone",CLOUD_PLATFORM:"cloud.platform",AWS_ECS_CONTAINER_ARN:"aws.ecs.container.arn",AWS_ECS_CLUSTER_ARN:"aws.ecs.cluster.arn",AWS_ECS_LAUNCHTYPE:"aws.ecs.launchtype",AWS_ECS_TASK_ARN:"aws.ecs.task.arn",AWS_ECS_TASK_FAMILY:"aws.ecs.task.family",AWS_ECS_TASK_REVISION:"aws.ecs.task.revision",AWS_EKS_CLUSTER_ARN:"aws.eks.cluster.arn",AWS_LOG_GROUP_NAMES:"aws.log.group.names",AWS_LOG_GROUP_ARNS:"aws.log.group.arns",AWS_LOG_STREAM_NAMES:"aws.log.stream.names",AWS_LOG_STREAM_ARNS:"aws.log.stream.arns",CONTAINER_NAME:"container.name",CONTAINER_ID:"container.id",CONTAINER_RUNTIME:"container.runtime",CONTAINER_IMAGE_NAME:"container.image.name",CONTAINER_IMAGE_TAG:"container.image.tag",DEPLOYMENT_ENVIRONMENT:"deployment.environment",DEVICE_ID:"device.id",DEVICE_MODEL_IDENTIFIER:"device.model.identifier",DEVICE_MODEL_NAME:"device.model.name",FAAS_NAME:"faas.name",FAAS_ID:"faas.id",FAAS_VERSION:"faas.version",FAAS_INSTANCE:"faas.instance",FAAS_MAX_MEMORY:"faas.max_memory",HOST_ID:"host.id",HOST_NAME:"host.name",HOST_TYPE:"host.type",HOST_ARCH:"host.arch",HOST_IMAGE_NAME:"host.image.name",HOST_IMAGE_ID:"host.image.id",HOST_IMAGE_VERSION:"host.image.version",K8S_CLUSTER_NAME:"k8s.cluster.name",K8S_NODE_NAME:"k8s.node.name",K8S_NODE_UID:"k8s.node.uid",K8S_NAMESPACE_NAME:"k8s.namespace.name",K8S_POD_UID:"k8s.pod.uid",K8S_POD_NAME:"k8s.pod.name",K8S_CONTAINER_NAME:"k8s.container.name",K8S_REPLICASET_UID:"k8s.replicaset.uid",K8S_REPLICASET_NAME:"k8s.replicaset.name",K8S_DEPLOYMENT_UID:"k8s.deployment.uid",K8S_DEPLOYMENT_NAME:"k8s.deployment.name",K8S_STATEFULSET_UID:"k8s.statefulset.uid",K8S_STATEFULSET_NAME:"k8s.statefulset.name",K8S_DAEMONSET_UID:"k8s.daemonset.uid",K8S_DAEMONSET_NAME:"k8s.daemonset.name",K8S_JOB_UID:"k8s.job.uid",K8S_JOB_NAME:"k8s.job.name",K8S_CRONJOB_UID:"k8s.cronjob.uid",K8S_CRONJOB_NAME:"k8s.cronjob.name",OS_TYPE:"os.type",OS_DESCRIPTION:"os.description",OS_NAME:"os.name",OS_VERSION:"os.version",PROCESS_PID:"process.pid",PROCESS_EXECUTABLE_NAME:"process.executable.name",PROCESS_EXECUTABLE_PATH:"process.executable.path",PROCESS_COMMAND:"process.command",PROCESS_COMMAND_LINE:"process.command_line",PROCESS_COMMAND_ARGS:"process.command_args",PROCESS_OWNER:"process.owner",PROCESS_RUNTIME_NAME:"process.runtime.name",PROCESS_RUNTIME_VERSION:"process.runtime.version",PROCESS_RUNTIME_DESCRIPTION:"process.runtime.description",SERVICE_NAME:"service.name",SERVICE_NAMESPACE:"service.namespace",SERVICE_INSTANCE_ID:"service.instance.id",SERVICE_VERSION:"service.version",TELEMETRY_SDK_NAME:"telemetry.sdk.name",TELEMETRY_SDK_LANGUAGE:"telemetry.sdk.language",TELEMETRY_SDK_VERSION:"telemetry.sdk.version",TELEMETRY_AUTO_VERSION:"telemetry.auto.version",WEBENGINE_NAME:"webengine.name",WEBENGINE_VERSION:"webengine.version",WEBENGINE_DESCRIPTION:"webengine.description"},$I={CPP:"cpp",DOTNET:"dotnet",ERLANG:"erlang",GO:"go",JAVA:"java",NODEJS:"nodejs",PHP:"php",PYTHON:"python",RUBY:"ruby",WEBJS:"webjs"},ha,Vh=(ha={},ha[xr.TELEMETRY_SDK_NAME]="opentelemetry",ha[xr.PROCESS_RUNTIME_NAME]="browser",ha[xr.TELEMETRY_SDK_LANGUAGE]=$I.WEBJS,ha[xr.TELEMETRY_SDK_VERSION]=VI,ha);function xV(r){}var HI=9,jI=6,GI=Math.pow(10,jI),Ad=Math.pow(10,HI);function pa(r){var e=r/1e3,t=Math.trunc(e),s=Math.round(r%1e3*GI);return[t,s]}function v_(){var r=ua.timeOrigin;if(typeof r!="number"){var e=ua;r=e.timing&&e.timing.fetchStart}return r}function qI(r){var e=pa(v_()),t=pa(typeof r=="number"?r:ua.now());return y_(e,t)}function KI(r,e){var t=e[0]-r[0],s=e[1]-r[1];return s<0&&(t-=1,s+=Ad),[t,s]}function $h(r){return r[0]*Ad+r[1]}function T_(r){return Array.isArray(r)&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"}function E_(r){return T_(r)||typeof r=="number"||r instanceof Date}function y_(r,e){var t=[r[0]+e[0],r[1]+e[1]];return t[1]>=Ad&&(t[1]-=Ad,t[0]+=1),t}var Zi;(function(r){r[r.SUCCESS=0]="SUCCESS",r[r.FAILED=1]="FAILED"})(Zi||(Zi={}));var WI=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},JI=function(){function r(e){e===void 0&&(e={});var t;this._propagators=(t=e.propagators)!==null&&t!==void 0?t:[],this._fields=Array.from(new Set(this._propagators.map(function(s){return typeof s.fields=="function"?s.fields():[]}).reduce(function(s,i){return s.concat(i)},[])))}return r.prototype.inject=function(e,t,s){var i,n;try{for(var a=WI(this._propagators),o=a.next();!o.done;o=a.next()){var c=o.value;try{c.inject(e,t,s)}catch(l){ue.warn("Failed to inject with "+c.constructor.name+". Err: "+l.message)}}}catch(l){i={error:l}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}},r.prototype.extract=function(e,t,s){return this._propagators.reduce(function(i,n){try{return n.extract(i,t,s)}catch(a){ue.warn("Failed to inject with "+n.constructor.name+". Err: "+a.message)}return i},e)},r.prototype.fields=function(){return this._fields.slice()},r}(),Hh="[_0-9a-z-*/]",zI="[a-z]"+Hh+"{0,255}",YI="[a-z0-9]"+Hh+"{0,240}@[a-z]"+Hh+"{0,13}",XI=new RegExp("^(?:"+zI+"|"+YI+")$"),QI=/^[ -~]{0,255}[!-~]$/,ZI=/,|=/;function ek(r){return XI.test(r)}function tk(r){return QI.test(r)&&!ZI.test(r)}var S_=32,rk=512,w_=",",R_="=",sk=function(){function r(e){this._internalState=new Map,e&&this._parse(e)}return r.prototype.set=function(e,t){var s=this._clone();return s._internalState.has(e)&&s._internalState.delete(e),s._internalState.set(e,t),s},r.prototype.unset=function(e){var t=this._clone();return t._internalState.delete(e),t},r.prototype.get=function(e){return this._internalState.get(e)},r.prototype.serialize=function(){var e=this;return this._keys().reduce(function(t,s){return t.push(s+R_+e.get(s)),t},[]).join(w_)},r.prototype._parse=function(e){e.length>rk||(this._internalState=e.split(w_).reverse().reduce(function(t,s){var i=s.trim(),n=i.indexOf(R_);if(n!==-1){var a=i.slice(0,n),o=i.slice(n+1,s.length);ek(a)&&tk(o)&&t.set(a,o)}return t},new Map),this._internalState.size>S_&&(this._internalState=new Map(Array.from(this._internalState.entries()).reverse().slice(0,S_))))},r.prototype._keys=function(){return Array.from(this._internalState.keys()).reverse()},r.prototype._clone=function(){var e=new r;return e._internalState=new Map(this._internalState),e},r}(),jh="traceparent",Gh="tracestate",ik="00",nk="(?!ff)[\\da-f]{2}",ak="(?![0]{32})[\\da-f]{32}",ok="(?![0]{16})[\\da-f]{16}",ck="[\\da-f]{2}",dk=new RegExp("^\\s?("+nk+")-("+ak+")-("+ok+")-("+ck+")(-.*)?\\s?$");function lk(r){var e=dk.exec(r);return!e||e[1]==="00"&&e[5]?null:{traceId:e[2],spanId:e[3],traceFlags:parseInt(e[4],16)}}var uk=function(){function r(){}return r.prototype.inject=function(e,t,s){var i=Lr.getSpanContext(e);if(!(!i||Nh(e)||!Sd(i))){var n=ik+"-"+i.traceId+"-"+i.spanId+"-0"+Number(i.traceFlags||ys.NONE).toString(16);s.set(t,jh,n),i.traceState&&s.set(t,Gh,i.traceState.serialize())}},r.prototype.extract=function(e,t,s){var i=s.get(t,jh);if(!i)return e;var n=Array.isArray(i)?i[0]:i;if(typeof n!="string")return e;var a=lk(n);if(!a)return e;a.isRemote=!0;var o=s.get(t,Gh);if(o){var c=Array.isArray(o)?o.join(","):o;a.traceState=new sk(typeof c=="string"?c:void 0)}return Lr.setSpanContext(e,a)},r.prototype.fields=function(){return[jh,Gh]},r}(),hk="[object Object]",pk="[object Null]",fk="[object Undefined]",mk=Function.prototype,b_=mk.toString,gk=b_.call(Object),_k=vk(Object.getPrototypeOf,Object),C_=Object.prototype,P_=C_.hasOwnProperty,en=Symbol?Symbol.toStringTag:void 0,A_=C_.toString;function vk(r,e){return function(t){return r(e(t))}}function I_(r){if(!Tk(r)||Ek(r)!==hk)return!1;var e=_k(r);if(e===null)return!0;var t=P_.call(e,"constructor")&&e.constructor;return typeof t=="function"&&t instanceof t&&b_.call(t)===gk}function Tk(r){return r!=null&&typeof r=="object"}function Ek(r){return r==null?r===void 0?fk:pk:en&&en in Object(r)?yk(r):Sk(r)}function yk(r){var e=P_.call(r,en),t=r[en],s=!1;try{r[en]=void 0,s=!0}catch(n){}var i=A_.call(r);return s&&(e?r[en]=t:delete r[en]),i}function Sk(r){return A_.call(r)}var wk=20;function Rk(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];for(var t=r.shift(),s=new WeakMap;r.length>0;)t=k_(t,r.shift(),0,s);return t}function qh(r){return Id(r)?r.slice():r}function k_(r,e,t,s){t===void 0&&(t=0);var i;if(!(t>wk)){if(t++,kd(r)||kd(e)||D_(e))i=qh(e);else if(Id(r)){if(i=r.slice(),Id(e))for(var n=0,a=e.length;n<a;n++)i.push(qh(e[n]));else if(Uo(e))for(var o=Object.keys(e),n=0,a=o.length;n<a;n++){var c=o[n];i[c]=qh(e[c])}}else if(Uo(r))if(Uo(e)){if(!bk(r,e))return e;i=Object.assign({},r);for(var o=Object.keys(e),n=0,a=o.length;n<a;n++){var c=o[n],l=e[c];if(kd(l))typeof l=="undefined"?delete i[c]:i[c]=l;else{var u=i[c],h=l;if(O_(r,c,s)||O_(e,c,s))delete i[c];else{if(Uo(u)&&Uo(h)){var p=s.get(u)||[],m=s.get(h)||[];p.push({obj:r,key:c}),m.push({obj:e,key:c}),s.set(u,p),s.set(h,m)}i[c]=k_(i[c],l,t,s)}}}}else i=e;return i}}function O_(r,e,t){for(var s=t.get(r[e])||[],i=0,n=s.length;i<n;i++){var a=s[i];if(a.key===e&&a.obj===r)return!0}return!1}function Id(r){return Array.isArray(r)}function D_(r){return typeof r=="function"}function Uo(r){return!kd(r)&&!Id(r)&&!D_(r)&&typeof r=="object"}function kd(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="undefined"||r instanceof Date||r instanceof RegExp||r===null}function bk(r,e){return!(!I_(r)||!I_(e))}var Ck=function(){function r(){var e=this;this._promise=new Promise(function(t,s){e._resolve=t,e._reject=s})}return Object.defineProperty(r.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),r.prototype.resolve=function(e){this._resolve(e)},r.prototype.reject=function(e){this._reject(e)},r}(),Pk=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},Ak=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},M_=function(){function r(e,t){this._callback=e,this._that=t,this._isCalled=!1,this._deferred=new Ck}return Object.defineProperty(r.prototype,"isCalled",{get:function(){return this._isCalled},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"promise",{get:function(){return this._deferred.promise},enumerable:!1,configurable:!0}),r.prototype.call=function(){for(var e,t=this,s=[],i=0;i<arguments.length;i++)s[i]=arguments[i];if(!this._isCalled){this._isCalled=!0;try{Promise.resolve((e=this._callback).call.apply(e,Ak([this._that],Pk(s),!1))).then(function(n){return t._deferred.resolve(n)},function(n){return t._deferred.reject(n)})}catch(n){this._deferred.reject(n)}}return this._deferred.promise},r}(),Ik="exception",kk=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},Ok=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},Dk=function(){function r(e,t,s,i,n,a,o,c,l){o===void 0&&(o=[]),this.attributes={},this.links=[],this.events=[],this._droppedAttributesCount=0,this._droppedEventsCount=0,this._droppedLinksCount=0,this.status={code:Ih.UNSET},this.endTime=[0,0],this._ended=!1,this._duration=[-1,-1],this.name=s,this._spanContext=i,this.parentSpanId=a,this.kind=n,this.links=o;var u=Date.now();this._performanceStartTime=ua.now(),this._performanceOffset=u-(this._performanceStartTime+v_()),this._startTimeProvided=c!=null,this.startTime=this._getTime(c!=null?c:u),this.resource=e.resource,this.instrumentationLibrary=e.instrumentationLibrary,this._spanLimits=e.getSpanLimits(),this._spanProcessor=e.getActiveSpanProcessor(),this._spanProcessor.onStart(this,t),this._attributeValueLengthLimit=this._spanLimits.attributeValueLengthLimit||0}return r.prototype.spanContext=function(){return this._spanContext},r.prototype.setAttribute=function(e,t){return t==null||this._isSpanEnded()?this:e.length===0?(ue.warn("Invalid attribute key: "+e),this):f_(t)?Object.keys(this.attributes).length>=this._spanLimits.attributeCountLimit&&!Object.prototype.hasOwnProperty.call(this.attributes,e)?(this._droppedAttributesCount++,this):(this.attributes[e]=this._truncateToSize(t),this):(ue.warn("Invalid attribute value set for key: "+e),this)},r.prototype.setAttributes=function(e){var t,s;try{for(var i=kk(Object.entries(e)),n=i.next();!n.done;n=i.next()){var a=Ok(n.value,2),o=a[0],c=a[1];this.setAttribute(o,c)}}catch(l){t={error:l}}finally{try{n&&!n.done&&(s=i.return)&&s.call(i)}finally{if(t)throw t.error}}return this},r.prototype.addEvent=function(e,t,s){if(this._isSpanEnded())return this;if(this._spanLimits.eventCountLimit===0)return ue.warn("No events allowed."),this._droppedEventsCount++,this;this.events.length>=this._spanLimits.eventCountLimit&&(ue.warn("Dropping extra events."),this.events.shift(),this._droppedEventsCount++),E_(t)&&(E_(s)||(s=t),t=void 0);var i=Cd(t);return this.events.push({name:e,attributes:i,time:this._getTime(s),droppedAttributesCount:0}),this},r.prototype.setStatus=function(e){return this._isSpanEnded()?this:(this.status=e,this)},r.prototype.updateName=function(e){return this._isSpanEnded()?this:(this.name=e,this)},r.prototype.end=function(e){if(this._isSpanEnded()){ue.error("You can only call end() on a span once.");return}this._ended=!0,this.endTime=this._getTime(e),this._duration=KI(this.startTime,this.endTime),this._duration[0]<0&&(ue.warn("Inconsistent start and end time, startTime > endTime. Setting span duration to 0ms.",this.startTime,this.endTime),this.endTime=this.startTime.slice(),this._duration=[0,0]),this._spanProcessor.onEnd(this)},r.prototype._getTime=function(e){if(typeof e=="number"&&e<ua.now())return qI(e+this._performanceOffset);if(typeof e=="number")return pa(e);if(e instanceof Date)return pa(e.getTime());if(T_(e))return e;if(this._startTimeProvided)return pa(Date.now());var t=ua.now()-this._performanceStartTime;return y_(this.startTime,pa(t))},r.prototype.isRecording=function(){return this._ended===!1},r.prototype.recordException=function(e,t){var s={};typeof e=="string"?s[Qi.EXCEPTION_MESSAGE]=e:e&&(e.code?s[Qi.EXCEPTION_TYPE]=e.code.toString():e.name&&(s[Qi.EXCEPTION_TYPE]=e.name),e.message&&(s[Qi.EXCEPTION_MESSAGE]=e.message),e.stack&&(s[Qi.EXCEPTION_STACKTRACE]=e.stack)),s[Qi.EXCEPTION_TYPE]||s[Qi.EXCEPTION_MESSAGE]?this.addEvent(Ik,s,t):ue.warn("Failed to record an exception "+e)},Object.defineProperty(r.prototype,"duration",{get:function(){return this._duration},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ended",{get:function(){return this._ended},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"droppedAttributesCount",{get:function(){return this._droppedAttributesCount},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"droppedEventsCount",{get:function(){return this._droppedEventsCount},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"droppedLinksCount",{get:function(){return this._droppedLinksCount},enumerable:!1,configurable:!0}),r.prototype._isSpanEnded=function(){return this._ended&&ue.warn("Can not execute the operation on ended Span {traceId: "+this._spanContext.traceId+", spanId: "+this._spanContext.spanId+"}"),this._ended},r.prototype._truncateToLimitUtil=function(e,t){return e.length<=t?e:e.substr(0,t)},r.prototype._truncateToSize=function(e){var t=this,s=this._attributeValueLengthLimit;return s<=0?(ue.warn("Attribute value limit must be positive, got "+s),e):typeof e=="string"?this._truncateToLimitUtil(e,s):Array.isArray(e)?e.map(function(i){return typeof i=="string"?t._truncateToLimitUtil(i,s):i}):e},r}(),fa;(function(r){r[r.NOT_RECORD=0]="NOT_RECORD",r[r.RECORD=1]="RECORD",r[r.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"})(fa||(fa={}));var Od=function(){function r(){}return r.prototype.shouldSample=function(){return{decision:fa.NOT_RECORD}},r.prototype.toString=function(){return"AlwaysOffSampler"},r}(),ma=function(){function r(){}return r.prototype.shouldSample=function(){return{decision:fa.RECORD_AND_SAMPLED}},r.prototype.toString=function(){return"AlwaysOnSampler"},r}(),Kh=function(){function r(e){var t,s,i,n;this._root=e.root,this._root||(Pd(new Error("ParentBasedSampler must have a root sampler configured")),this._root=new ma),this._remoteParentSampled=(t=e.remoteParentSampled)!==null&&t!==void 0?t:new ma,this._remoteParentNotSampled=(s=e.remoteParentNotSampled)!==null&&s!==void 0?s:new Od,this._localParentSampled=(i=e.localParentSampled)!==null&&i!==void 0?i:new ma,this._localParentNotSampled=(n=e.localParentNotSampled)!==null&&n!==void 0?n:new Od}return r.prototype.shouldSample=function(e,t,s,i,n,a){var o=Lr.getSpanContext(e);return!o||!Sd(o)?this._root.shouldSample(e,t,s,i,n,a):o.isRemote?o.traceFlags&ys.SAMPLED?this._remoteParentSampled.shouldSample(e,t,s,i,n,a):this._remoteParentNotSampled.shouldSample(e,t,s,i,n,a):o.traceFlags&ys.SAMPLED?this._localParentSampled.shouldSample(e,t,s,i,n,a):this._localParentNotSampled.shouldSample(e,t,s,i,n,a)},r.prototype.toString=function(){return"ParentBased{root="+this._root.toString()+", remoteParentSampled="+this._remoteParentSampled.toString()+", remoteParentNotSampled="+this._remoteParentNotSampled.toString()+", localParentSampled="+this._localParentSampled.toString()+", localParentNotSampled="+this._localParentNotSampled.toString()+"}"},r}(),N_=function(){function r(e){e===void 0&&(e=0),this._ratio=e,this._ratio=this._normalize(e),this._upperBound=Math.floor(this._ratio*4294967295)}return r.prototype.shouldSample=function(e,t){return{decision:a_(t)&&this._accumulate(t)<this._upperBound?fa.RECORD_AND_SAMPLED:fa.NOT_RECORD}},r.prototype.toString=function(){return"TraceIdRatioBased{"+this._ratio+"}"},r.prototype._normalize=function(e){return typeof e!="number"||isNaN(e)?0:e>=1?1:e<=0?0:e},r.prototype._accumulate=function(e){for(var t=0,s=0;s<e.length/8;s++){var i=s*8,n=parseInt(e.slice(i,i+8),16);t=(t^n)>>>0}return t},r}(),Mk=tt(),Nk=ts.AlwaysOn,ga=1;function L_(){return{sampler:x_(Mk),forceFlushTimeoutMillis:3e4,generalLimits:{attributeValueLengthLimit:tt().OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT,attributeCountLimit:tt().OTEL_ATTRIBUTE_COUNT_LIMIT},spanLimits:{attributeValueLengthLimit:tt().OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT,attributeCountLimit:tt().OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT,linkCountLimit:tt().OTEL_SPAN_LINK_COUNT_LIMIT,eventCountLimit:tt().OTEL_SPAN_EVENT_COUNT_LIMIT,attributePerEventCountLimit:tt().OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT,attributePerLinkCountLimit:tt().OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT}}}function x_(r){switch(r===void 0&&(r=tt()),r.OTEL_TRACES_SAMPLER){case ts.AlwaysOn:return new ma;case ts.AlwaysOff:return new Od;case ts.ParentBasedAlwaysOn:return new Kh({root:new ma});case ts.ParentBasedAlwaysOff:return new Kh({root:new Od});case ts.TraceIdRatio:return new N_(U_(r));case ts.ParentBasedTraceIdRatio:return new Kh({root:new N_(U_(r))});default:return ue.error('OTEL_TRACES_SAMPLER value "'+r.OTEL_TRACES_SAMPLER+" invalid, defaulting to "+Nk+'".'),new ma}}function U_(r){if(r.OTEL_TRACES_SAMPLER_ARG===void 0||r.OTEL_TRACES_SAMPLER_ARG==="")return ue.error("OTEL_TRACES_SAMPLER_ARG is blank, defaulting to "+ga+"."),ga;var e=Number(r.OTEL_TRACES_SAMPLER_ARG);return isNaN(e)?(ue.error("OTEL_TRACES_SAMPLER_ARG="+r.OTEL_TRACES_SAMPLER_ARG+" was given, but it is invalid, defaulting to "+ga+"."),ga):e<0||e>1?(ue.error("OTEL_TRACES_SAMPLER_ARG="+r.OTEL_TRACES_SAMPLER_ARG+" was given, but it is out of range ([0..1]), defaulting to "+ga+"."),ga):e}function Lk(r){var e={sampler:x_()},t=L_(),s=Object.assign({},t,e,r);return s.generalLimits=Object.assign({},t.generalLimits,r.generalLimits||{}),s.spanLimits=Object.assign({},t.spanLimits,r.spanLimits||{}),s}function xk(r){var e,t,s,i,n,a,o,c,l,u,h,p,m=Object.assign({},r.spanLimits),v=FI();return m.attributeCountLimit=(a=(n=(i=(t=(e=r.spanLimits)===null||e===void 0?void 0:e.attributeCountLimit)!==null&&t!==void 0?t:(s=r.generalLimits)===null||s===void 0?void 0:s.attributeCountLimit)!==null&&i!==void 0?i:v.OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT)!==null&&n!==void 0?n:v.OTEL_ATTRIBUTE_COUNT_LIMIT)!==null&&a!==void 0?a:Bh,m.attributeValueLengthLimit=(p=(h=(u=(c=(o=r.spanLimits)===null||o===void 0?void 0:o.attributeValueLengthLimit)!==null&&c!==void 0?c:(l=r.generalLimits)===null||l===void 0?void 0:l.attributeValueLengthLimit)!==null&&u!==void 0?u:v.OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT)!==null&&h!==void 0?h:v.OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT)!==null&&p!==void 0?p:Uh,Object.assign({},r,{spanLimits:m})}var Uk=function(){function r(e,t){this._exporter=e,this._finishedSpans=[],this._droppedSpansCount=0;var s=tt();this._maxExportBatchSize=typeof(t==null?void 0:t.maxExportBatchSize)=="number"?t.maxExportBatchSize:s.OTEL_BSP_MAX_EXPORT_BATCH_SIZE,this._maxQueueSize=typeof(t==null?void 0:t.maxQueueSize)=="number"?t.maxQueueSize:s.OTEL_BSP_MAX_QUEUE_SIZE,this._scheduledDelayMillis=typeof(t==null?void 0:t.scheduledDelayMillis)=="number"?t.scheduledDelayMillis:s.OTEL_BSP_SCHEDULE_DELAY,this._exportTimeoutMillis=typeof(t==null?void 0:t.exportTimeoutMillis)=="number"?t.exportTimeoutMillis:s.OTEL_BSP_EXPORT_TIMEOUT,this._shutdownOnce=new M_(this._shutdown,this),this._maxExportBatchSize>this._maxQueueSize&&(ue.warn("BatchSpanProcessor: maxExportBatchSize must be smaller or equal to maxQueueSize, setting maxExportBatchSize to match maxQueueSize"),this._maxExportBatchSize=this._maxQueueSize)}return r.prototype.forceFlush=function(){return this._shutdownOnce.isCalled?this._shutdownOnce.promise:this._flushAll()},r.prototype.onStart=function(e,t){},r.prototype.onEnd=function(e){this._shutdownOnce.isCalled||e.spanContext().traceFlags&ys.SAMPLED&&this._addToBuffer(e)},r.prototype.shutdown=function(){return this._shutdownOnce.call()},r.prototype._shutdown=function(){var e=this;return Promise.resolve().then(function(){return e.onShutdown()}).then(function(){return e._flushAll()}).then(function(){return e._exporter.shutdown()})},r.prototype._addToBuffer=function(e){if(this._finishedSpans.length>=this._maxQueueSize){this._droppedSpansCount===0&&ue.debug("maxQueueSize reached, dropping spans"),this._droppedSpansCount++;return}this._droppedSpansCount>0&&(ue.warn("Dropped "+this._droppedSpansCount+" spans because maxQueueSize reached"),this._droppedSpansCount=0),this._finishedSpans.push(e),this._maybeStartTimer()},r.prototype._flushAll=function(){var e=this;return new Promise(function(t,s){for(var i=[],n=Math.ceil(e._finishedSpans.length/e._maxExportBatchSize),a=0,o=n;a<o;a++)i.push(e._flushOneBatch());Promise.all(i).then(function(){t()}).catch(s)})},r.prototype._flushOneBatch=function(){var e=this;return this._clearTimer(),this._finishedSpans.length===0?Promise.resolve():new Promise(function(t,s){var i=setTimeout(function(){s(new Error("Timeout"))},e._exportTimeoutMillis);Xi.with(dI(Xi.active()),function(){var n=e._finishedSpans.splice(0,e._maxExportBatchSize),a=function(){return e._exporter.export(n,function(c){var l;clearTimeout(i),c.code===Zi.SUCCESS?t():s((l=c.error)!==null&&l!==void 0?l:new Error("BatchSpanProcessor: span export failed"))})},o=n.map(function(c){return c.resource}).filter(function(c){return c.asyncAttributesPending});o.length===0?a():Promise.all(o.map(function(c){var l;return(l=c.waitForAsyncAttributes)===null||l===void 0?void 0:l.call(c)})).then(a,function(c){Pd(c),s(c)})})})},r.prototype._maybeStartTimer=function(){var e=this;this._timer===void 0&&(this._timer=setTimeout(function(){e._flushOneBatch().then(function(){e._finishedSpans.length>0&&(e._clearTimer(),e._maybeStartTimer())}).catch(function(t){Pd(t)})},this._scheduledDelayMillis),this._timer,void 0)},r.prototype._clearTimer=function(){this._timer!==void 0&&(clearTimeout(this._timer),this._timer=void 0)},r}(),Bk=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),B_=function(r){Bk(e,r);function e(t,s){var i=r.call(this,t,s)||this;return i.onInit(s),i}return e.prototype.onInit=function(t){var s=this;(t==null?void 0:t.disableAutoFlushOnDocumentHide)!==!0&&typeof document!="undefined"&&(this._visibilityChangeListener=function(){document.visibilityState==="hidden"&&s.forceFlush()},this._pageHideListener=function(){s.forceFlush()},document.addEventListener("visibilitychange",this._visibilityChangeListener),document.addEventListener("pagehide",this._pageHideListener))},e.prototype.onShutdown=function(){typeof document!="undefined"&&(this._visibilityChangeListener&&document.removeEventListener("visibilitychange",this._visibilityChangeListener),this._pageHideListener&&document.removeEventListener("pagehide",this._pageHideListener))},e}(Uk),Fk=8,Vk=16,$k=function(){function r(){this.generateTraceId=F_(Vk),this.generateSpanId=F_(Fk)}return r}(),Dd=Array(32);function F_(r){return function(){for(var t=0;t<r*2;t++)Dd[t]=Math.floor(Math.random()*16)+48,Dd[t]>=58&&(Dd[t]+=39);return String.fromCharCode.apply(null,Dd.slice(0,r*2))}}var Hk=function(){function r(e,t,s){this._tracerProvider=s;var i=Lk(t);this._sampler=i.sampler,this._generalLimits=i.generalLimits,this._spanLimits=i.spanLimits,this._idGenerator=t.idGenerator||new $k,this.resource=s.resource,this.instrumentationLibrary=e}return r.prototype.startSpan=function(e,t,s){var i,n,a;t===void 0&&(t={}),s===void 0&&(s=Xi.active()),t.root&&(s=Lr.deleteSpan(s));var o=Lr.getSpan(s);if(Nh(s)){ue.debug("Instrumentation suppressed, returning Noop Span");var c=Lr.wrapSpanContext(i_);return c}var l=o==null?void 0:o.spanContext(),u=this._idGenerator.generateSpanId(),h,p,m;!l||!Lr.isSpanContextValid(l)?h=this._idGenerator.generateTraceId():(h=l.traceId,p=l.traceState,m=l.spanId);var v=(i=t.kind)!==null&&i!==void 0?i:Ah.INTERNAL,y=((n=t.links)!==null&&n!==void 0?n:[]).map(function(W){return{context:W.context,attributes:Cd(W.attributes)}}),C=Cd(t.attributes),k=this._sampler.shouldSample(s,h,e,v,C,y);p=(a=k.traceState)!==null&&a!==void 0?a:p;var D=k.decision===wd.RECORD_AND_SAMPLED?ys.SAMPLED:ys.NONE,V={traceId:h,spanId:u,traceFlags:D,traceState:p};if(k.decision===wd.NOT_RECORD){ue.debug("Recording is off, propagating context in a non-recording span");var c=Lr.wrapSpanContext(V);return c}var M=new Dk(this,s,e,V,v,m,y,t.startTime),Pe=Cd(Object.assign(C,k.attributes));return M.setAttributes(Pe),M},r.prototype.startActiveSpan=function(e,t,s,i){var n,a,o;if(!(arguments.length<2)){arguments.length===2?o=t:arguments.length===3?(n=t,o=s):(n=t,a=s,o=i);var c=a!=null?a:Xi.active(),l=this.startSpan(e,n,c),u=Lr.setSpan(c,l);return Xi.with(u,o,void 0,l)}},r.prototype.getGeneralLimits=function(){return this._generalLimits},r.prototype.getSpanLimits=function(){return this._spanLimits},r.prototype.getActiveSpanProcessor=function(){return this._tracerProvider.getActiveSpanProcessor()},r}();function jk(){return"unknown_service"}var si=globalThis&&globalThis.__assign||function(){return si=Object.assign||function(r){for(var e,t=1,s=arguments.length;t<s;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=e[i])}return r},si.apply(this,arguments)},Gk=globalThis&&globalThis.__awaiter||function(r,e,t,s){function i(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function o(u){try{l(s.next(u))}catch(h){a(h)}}function c(u){try{l(s.throw(u))}catch(h){a(h)}}function l(u){u.done?n(u.value):i(u.value).then(o,c)}l((s=s.apply(r,e||[])).next())})},qk=globalThis&&globalThis.__generator||function(r,e){var t={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},s,i,n,a;return a={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(u){return c([l,u])}}function c(l){if(s)throw new TypeError("Generator is already executing.");for(;t;)try{if(s=1,i&&(n=l[0]&2?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[l[0]&2,n.value]),l[0]){case 0:case 1:n=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(n=t.trys,!(n=n.length>0&&n[n.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!n||l[1]>n[0]&&l[1]<n[3])){t.label=l[1];break}if(l[0]===6&&t.label<n[1]){t.label=n[1],n=l;break}if(n&&t.label<n[2]){t.label=n[2],t.ops.push(l);break}n[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],i=0}finally{s=n=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},Kk=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},Wh=function(){function r(e,t){var s=this;this._attributes=e,this.asyncAttributesPending=t!=null,this._syncAttributes=e,this._asyncAttributesPromise=t==null?void 0:t.then(function(i){return s._attributes=Object.assign({},s._attributes,i),s.asyncAttributesPending=!1,i},function(i){return ue.debug("a resource's async attributes promise rejected: %s",i),s.asyncAttributesPending=!1,{}})}return r.empty=function(){return r.EMPTY},r.default=function(){var e;return new r((e={},e[xr.SERVICE_NAME]=jk(),e[xr.TELEMETRY_SDK_LANGUAGE]=Vh[xr.TELEMETRY_SDK_LANGUAGE],e[xr.TELEMETRY_SDK_NAME]=Vh[xr.TELEMETRY_SDK_NAME],e[xr.TELEMETRY_SDK_VERSION]=Vh[xr.TELEMETRY_SDK_VERSION],e))},Object.defineProperty(r.prototype,"attributes",{get:function(){return this.asyncAttributesPending&&ue.error("Accessing resource attributes before async attributes settled"),this._attributes},enumerable:!1,configurable:!0}),r.prototype.waitForAsyncAttributes=function(){return Gk(this,void 0,void 0,function(){return qk(this,function(e){switch(e.label){case 0:return this.asyncAttributesPending?[4,this._asyncAttributesPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},r.prototype.merge=function(e){var t=this,s;if(!e)return this;var i=si(si({},this._syncAttributes),(s=e._syncAttributes)!==null&&s!==void 0?s:e.attributes);if(!this._asyncAttributesPromise&&!e._asyncAttributesPromise)return new r(i);var n=Promise.all([this._asyncAttributesPromise,e._asyncAttributesPromise]).then(function(a){var o,c=Kk(a,2),l=c[0],u=c[1];return si(si(si(si({},t._syncAttributes),l),(o=e._syncAttributes)!==null&&o!==void 0?o:e.attributes),u)});return new r(i,n)},r.EMPTY=new r({}),r}(),Md=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},Wk=function(){function r(e){this._spanProcessors=e}return r.prototype.forceFlush=function(){var e,t,s=[];try{for(var i=Md(this._spanProcessors),n=i.next();!n.done;n=i.next()){var a=n.value;s.push(a.forceFlush())}}catch(o){e={error:o}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return new Promise(function(o){Promise.all(s).then(function(){o()}).catch(function(c){Pd(c||new Error("MultiSpanProcessor: forceFlush failed")),o()})})},r.prototype.onStart=function(e,t){var s,i;try{for(var n=Md(this._spanProcessors),a=n.next();!a.done;a=n.next()){var o=a.value;o.onStart(e,t)}}catch(c){s={error:c}}finally{try{a&&!a.done&&(i=n.return)&&i.call(n)}finally{if(s)throw s.error}}},r.prototype.onEnd=function(e){var t,s;try{for(var i=Md(this._spanProcessors),n=i.next();!n.done;n=i.next()){var a=n.value;a.onEnd(e)}}catch(o){t={error:o}}finally{try{n&&!n.done&&(s=i.return)&&s.call(i)}finally{if(t)throw t.error}}},r.prototype.shutdown=function(){var e,t,s=[];try{for(var i=Md(this._spanProcessors),n=i.next();!n.done;n=i.next()){var a=n.value;s.push(a.shutdown())}}catch(o){e={error:o}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return new Promise(function(o,c){Promise.all(s).then(function(){o()},c)})},r}(),Jk=function(){function r(){}return r.prototype.onStart=function(e,t){},r.prototype.onEnd=function(e){},r.prototype.shutdown=function(){return Promise.resolve()},r.prototype.forceFlush=function(){return Promise.resolve()},r}(),tn;(function(r){r[r.resolved=0]="resolved",r[r.timeout=1]="timeout",r[r.error=2]="error",r[r.unresolved=3]="unresolved"})(tn||(tn={}));var zk=function(){function r(e){e===void 0&&(e={});var t;this._registeredSpanProcessors=[],this._tracers=new Map;var s=Rk({},L_(),xk(e));this.resource=(t=s.resource)!==null&&t!==void 0?t:Wh.empty(),this.resource=Wh.default().merge(this.resource),this._config=Object.assign({},s,{resource:this.resource});var i=this._buildExporterFromEnv();if(i!==void 0){var n=new B_(i);this.activeSpanProcessor=n}else this.activeSpanProcessor=new Jk}return r.prototype.getTracer=function(e,t,s){var i=e+"@"+(t||"")+":"+((s==null?void 0:s.schemaUrl)||"");return this._tracers.has(i)||this._tracers.set(i,new Hk({name:e,version:t,schemaUrl:s==null?void 0:s.schemaUrl},this._config,this)),this._tracers.get(i)},r.prototype.addSpanProcessor=function(e){this._registeredSpanProcessors.length===0&&this.activeSpanProcessor.shutdown().catch(function(t){return ue.error("Error while trying to shutdown current span processor",t)}),this._registeredSpanProcessors.push(e),this.activeSpanProcessor=new Wk(this._registeredSpanProcessors)},r.prototype.getActiveSpanProcessor=function(){return this.activeSpanProcessor},r.prototype.register=function(e){e===void 0&&(e={}),Lr.setGlobalTracerProvider(this),e.propagator===void 0&&(e.propagator=this._buildPropagatorFromEnv()),e.contextManager&&Xi.setGlobalContextManager(e.contextManager),e.propagator&&la.setGlobalPropagator(e.propagator)},r.prototype.forceFlush=function(){var e=this._config.forceFlushTimeoutMillis,t=this._registeredSpanProcessors.map(function(s){return new Promise(function(i){var n,a=setTimeout(function(){i(new Error("Span processor did not completed within timeout period of "+e+" ms")),n=tn.timeout},e);s.forceFlush().then(function(){clearTimeout(a),n!==tn.timeout&&(n=tn.resolved,i(n))}).catch(function(o){clearTimeout(a),n=tn.error,i(o)})})});return new Promise(function(s,i){Promise.all(t).then(function(n){var a=n.filter(function(o){return o!==tn.resolved});a.length>0?i(a):s()}).catch(function(n){return i([n])})})},r.prototype.shutdown=function(){return this.activeSpanProcessor.shutdown()},r.prototype._getPropagator=function(e){var t;return(t=this.constructor._registeredPropagators.get(e))===null||t===void 0?void 0:t()},r.prototype._getSpanExporter=function(e){var t;return(t=this.constructor._registeredExporters.get(e))===null||t===void 0?void 0:t()},r.prototype._buildPropagatorFromEnv=function(){var e=this,t=Array.from(new Set(tt().OTEL_PROPAGATORS)),s=t.map(function(n){var a=e._getPropagator(n);return a||ue.warn('Propagator "'+n+'" requested through environment variable is unavailable.'),a}),i=s.reduce(function(n,a){return a&&n.push(a),n},[]);if(i.length!==0)return t.length===1?i[0]:new JI({propagators:i})},r.prototype._buildExporterFromEnv=function(){var e=tt().OTEL_TRACES_EXPORTER;if(!(e==="none"||e==="")){var t=this._getSpanExporter(e);return t||ue.error('Exporter "'+e+'" requested through environment variable is unavailable.'),t}},r._registeredPropagators=new Map([["tracecontext",function(){return new uk}],["baggage",function(){return new _I}]]),r._registeredExporters=new Map,r}(),Yk=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},Xk=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))},V_=function(){function r(){this._enabled=!1,this._currentContext=wr}return r.prototype._bindFunction=function(e,t){e===void 0&&(e=wr);var s=this,i=function(){for(var n=this,a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];return s.with(e,function(){return t.apply(n,a)})};return Object.defineProperty(i,"length",{enumerable:!1,configurable:!0,writable:!1,value:t.length}),i},r.prototype.active=function(){return this._currentContext},r.prototype.bind=function(e,t){return e===void 0&&(e=this.active()),typeof t=="function"?this._bindFunction(e,t):t},r.prototype.disable=function(){return this._currentContext=wr,this._enabled=!1,this},r.prototype.enable=function(){return this._enabled?this:(this._enabled=!0,this._currentContext=wr,this)},r.prototype.with=function(e,t,s){for(var i=[],n=3;n<arguments.length;n++)i[n-3]=arguments[n];var a=this._currentContext;this._currentContext=e||wr;try{return t.call.apply(t,Xk([s],Yk(i),!1))}finally{this._currentContext=a}},r}(),Qk=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),Zk=function(r){Qk(e,r);function e(t){t===void 0&&(t={});var s=r.call(this,t)||this;if(t.contextManager)throw"contextManager should be defined in register method not in constructor";if(t.propagator)throw"propagator should be defined in register method not in constructor";return s}return e.prototype.register=function(t){t===void 0&&(t={}),t.contextManager===void 0&&(t.contextManager=new V_),t.contextManager&&t.contextManager.enable(),r.prototype.register.call(this,t)},e}(zk),eO=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n},$_=1e4,tO=5,rO=1e3,sO=5e3,iO=1.5;function nO(r){r===void 0&&(r={});var e={};return Object.entries(r).forEach(function(t){var s=eO(t,2),i=s[0],n=s[1];typeof n!="undefined"?e[i]=String(n):ue.warn('Header "'+i+'" has wrong value and will be ignored')}),e}function aO(r,e){return r.endsWith("/")||(r=r+"/"),r+e}function oO(r){try{var e=new URL(r);return e.pathname===""&&(e.pathname=e.pathname+"/"),e.toString()}catch(t){return ue.warn("Could not parse export URL: '"+r+"'"),r}}function cO(r){return typeof r=="number"?r<=0?H_(r,$_):r:dO()}function dO(){var r,e=Number((r=tt().OTEL_EXPORTER_OTLP_TRACES_TIMEOUT)!==null&&r!==void 0?r:tt().OTEL_EXPORTER_OTLP_TIMEOUT);return e<=0?H_(e,$_):e}function H_(r,e){return ue.warn("Timeout must be greater than 0",r),e}function lO(r){var e=[429,502,503,504];return e.includes(r)}function uO(r){if(r==null)return-1;var e=Number.parseInt(r,10);if(Number.isInteger(e))return e>0?e*1e3:-1;var t=new Date(r).getTime()-Date.now();return t>=0?t:0}var hO=function(){function r(e){e===void 0&&(e={}),this._sendingPromises=[],this.url=this.getDefaultUrl(e),typeof e.hostname=="string"&&(this.hostname=e.hostname),this.shutdown=this.shutdown.bind(this),this._shutdownOnce=new M_(this._shutdown,this),this._concurrencyLimit=typeof e.concurrencyLimit=="number"?e.concurrencyLimit:1/0,this.timeoutMillis=cO(e.timeoutMillis),this.onInit(e)}return r.prototype.export=function(e,t){if(this._shutdownOnce.isCalled){t({code:Zi.FAILED,error:new Error("Exporter has been shutdown")});return}if(this._sendingPromises.length>=this._concurrencyLimit){t({code:Zi.FAILED,error:new Error("Concurrent export limit reached")});return}this._export(e).then(function(){t({code:Zi.SUCCESS})}).catch(function(s){t({code:Zi.FAILED,error:s})})},r.prototype._export=function(e){var t=this;return new Promise(function(s,i){try{ue.debug("items to be sent",e),t.send(e,s,i)}catch(n){i(n)}})},r.prototype.shutdown=function(){return this._shutdownOnce.call()},r.prototype._shutdown=function(){return ue.debug("shutdown started"),this.onShutdown(),Promise.all(this._sendingPromises).then(function(){})},r}(),pO=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),Bo=function(r){pO(e,r);function e(t,s,i){var n=r.call(this,t)||this;return n.name="OTLPExporterError",n.data=i,n.code=s,n}return e}(Error),Nd=globalThis&&globalThis.__assign||function(){return Nd=Object.assign||function(r){for(var e,t=1,s=arguments.length;t<s;t++){e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=e[i])}return r},Nd.apply(this,arguments)},fO=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n};function mO(r,e,t,s,i){if(navigator.sendBeacon(e,new Blob([r],t)))ue.debug("sendBeacon - can send",r),s();else{var n=new Bo("sendBeacon - cannot send "+r);i(n)}}function gO(r,e,t,s,i,n){var a,o,c=!1,l=setTimeout(function(){if(clearTimeout(a),c=!0,o.readyState===XMLHttpRequest.DONE){var h=new Bo("Request Timeout");n(h)}else o.abort()},s),u=function(h,p){h===void 0&&(h=tO),p===void 0&&(p=rO),o=new XMLHttpRequest,o.open("POST",e);var m={Accept:"application/json","Content-Type":"application/json"};Object.entries(Nd(Nd({},m),t)).forEach(function(v){var y=fO(v,2),C=y[0],k=y[1];o.setRequestHeader(C,k)}),o.send(r),o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.DONE&&c===!1)if(o.status>=200&&o.status<=299)ue.debug("xhr success",r),i(),clearTimeout(l),clearTimeout(a);else if(o.status&&lO(o.status)&&h>0){var v=void 0;p=iO*p,o.getResponseHeader("Retry-After")?v=uO(o.getResponseHeader("Retry-After")):v=Math.round(Math.random()*(sO-p)+p),a=setTimeout(function(){u(h-1,p)},v)}else{var y=new Bo("Failed to export with XHR (status: "+o.status+")",o.status);n(y),clearTimeout(l),clearTimeout(a)}},o.onabort=function(){if(c){var v=new Bo("Request Timeout");n(v)}clearTimeout(l),clearTimeout(a)},o.onerror=function(){if(c){var v=new Bo("Request Timeout");n(v)}clearTimeout(l),clearTimeout(a)}};u()}var _O=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),vO=function(r){_O(e,r);function e(t){t===void 0&&(t={});var s=r.call(this,t)||this;return s._useXHR=!1,s._useXHR=!!t.headers||typeof navigator.sendBeacon!="function",s._useXHR?s._headers=Object.assign({},nO(t.headers),h_(tt().OTEL_EXPORTER_OTLP_HEADERS)):s._headers={},s}return e.prototype.onInit=function(){window.addEventListener("unload",this.shutdown)},e.prototype.onShutdown=function(){window.removeEventListener("unload",this.shutdown)},e.prototype.send=function(t,s,i){var n=this;if(this._shutdownOnce.isCalled){ue.debug("Shutdown already started. Cannot send objects");return}var a=this.convert(t),o=JSON.stringify(a),c=new Promise(function(u,h){n._useXHR?gO(o,n.url,n._headers,n.timeoutMillis,u,h):mO(o,n.url,{type:"application/json"},u,h)}).then(s,i);this._sendingPromises.push(c);var l=function(){var u=n._sendingPromises.indexOf(c);n._sendingPromises.splice(u,1)};c.then(l,l)},e}(hO),TO=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n};function Ld(r){return Object.keys(r).map(function(e){return j_(e,r[e])})}function j_(r,e){return{key:r,value:G_(e)}}function G_(r){var e=typeof r;return e==="string"?{stringValue:r}:e==="number"?Number.isInteger(r)?{intValue:r}:{doubleValue:r}:e==="boolean"?{boolValue:r}:r instanceof Uint8Array?{bytesValue:r}:Array.isArray(r)?{arrayValue:{values:r.map(G_)}}:e==="object"&&r!=null?{kvlistValue:{values:Object.entries(r).map(function(t){var s=TO(t,2),i=s[0],n=s[1];return j_(i,n)})}}:{}}function EO(r,e){var t,s=r.spanContext(),i=r.status,n=e?r.parentSpanId:r.parentSpanId!=null?xo(r.parentSpanId):void 0;return{traceId:e?s.traceId:xo(s.traceId),spanId:e?s.spanId:xo(s.spanId),parentSpanId:n,traceState:(t=s.traceState)===null||t===void 0?void 0:t.serialize(),name:r.name,kind:r.kind==null?0:r.kind+1,startTimeUnixNano:$h(r.startTime),endTimeUnixNano:$h(r.endTime),attributes:Ld(r.attributes),droppedAttributesCount:r.droppedAttributesCount,events:r.events.map(SO),droppedEventsCount:r.droppedEventsCount,status:{code:i.code,message:i.message},links:r.links.map(function(a){return yO(a,e)}),droppedLinksCount:r.droppedLinksCount}}function yO(r,e){var t;return{attributes:r.attributes?Ld(r.attributes):[],spanId:e?r.context.spanId:xo(r.context.spanId),traceId:e?r.context.traceId:xo(r.context.traceId),traceState:(t=r.context.traceState)===null||t===void 0?void 0:t.serialize(),droppedAttributesCount:r.droppedAttributesCount||0}}function SO(r){return{attributes:r.attributes?Ld(r.attributes):[],name:r.name,timeUnixNano:$h(r.time),droppedAttributesCount:r.droppedAttributesCount||0}}var wO=globalThis&&globalThis.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},RO=globalThis&&globalThis.__read||function(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n};function bO(r,e){return{resourceSpans:PO(r,e)}}function CO(r){var e,t,s=new Map;try{for(var i=wO(r),n=i.next();!n.done;n=i.next()){var a=n.value,o=s.get(a.resource);o||(o=new Map,s.set(a.resource,o));var c=a.instrumentationLibrary.name+"@"+(a.instrumentationLibrary.version||"")+":"+(a.instrumentationLibrary.schemaUrl||""),l=o.get(c);l||(l=[],o.set(c,l)),l.push(a)}}catch(u){e={error:u}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return s}function PO(r,e){for(var t=CO(r),s=[],i=t.entries(),n=i.next();!n.done;){for(var a=RO(n.value,2),o=a[0],c=a[1],l=[],u=c.values(),h=u.next();!h.done;){var p=h.value;if(p.length>0){var m=p[0].instrumentationLibrary,v=m.name,y=m.version,C=m.schemaUrl,k=p.map(function(V){return EO(V,e)});l.push({scope:{name:v,version:y},spans:k,schemaUrl:C})}h=u.next()}var D={resource:{attributes:Ld(o.attributes),droppedAttributesCount:0},scopeSpans:l,schemaUrl:void 0};s.push(D),n=i.next()}return s}var AO=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(s[n]=i[n])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),q_="v1/traces",IO="http://localhost:4318/"+q_,kO=function(r){AO(e,r);function e(t){t===void 0&&(t={});var s=r.call(this,t)||this;return s._headers=Object.assign(s._headers,h_(tt().OTEL_EXPORTER_OTLP_TRACES_HEADERS)),s}return e.prototype.convert=function(t){return bO(t,!0)},e.prototype.getDefaultUrl=function(t){return typeof t.url=="string"?t.url:tt().OTEL_EXPORTER_OTLP_TRACES_ENDPOINT.length>0?oO(tt().OTEL_EXPORTER_OTLP_TRACES_ENDPOINT):tt().OTEL_EXPORTER_OTLP_ENDPOINT.length>0?aO(tt().OTEL_EXPORTER_OTLP_ENDPOINT,q_):IO},e}(vO);function OO(r){return r===void 0&&(r={}),typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}var K_="OT_ZONE_CONTEXT",DO=function(){function r(){this._enabled=!1,this._zoneCounter=0}return r.prototype._activeContextFromZone=function(e){return e&&e.get(K_)||wr},r.prototype._bindFunction=function(e,t){var s=this,i=function(){for(var n=this,a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];return s.with(e,function(){return t.apply(n,a)})};return Object.defineProperty(i,"length",{enumerable:!1,configurable:!0,writable:!1,value:t.length}),i},r.prototype._bindListener=function(e,t){var s=t;return s.__ot_listeners!==void 0||(s.__ot_listeners={},typeof s.addEventListener=="function"&&(s.addEventListener=this._patchAddEventListener(s,s.addEventListener,e)),typeof s.removeEventListener=="function"&&(s.removeEventListener=this._patchRemoveEventListener(s,s.removeEventListener))),t},r.prototype._createZoneName=function(){this._zoneCounter++;var e=Math.random();return this._zoneCounter+"-"+e},r.prototype._createZone=function(e,t){var s;return Zone.current.fork({name:e,properties:(s={},s[K_]=t,s)})},r.prototype._getActiveZone=function(){return Zone.current},r.prototype._patchAddEventListener=function(e,t,s){var i=this;return function(n,a,o){e.__ot_listeners===void 0&&(e.__ot_listeners={});var c=e.__ot_listeners[n];c===void 0&&(c=new WeakMap,e.__ot_listeners[n]=c);var l=i.bind(s,a);return c.set(a,l),t.call(this,n,l,o)}},r.prototype._patchRemoveEventListener=function(e,t){return function(s,i){if(e.__ot_listeners===void 0||e.__ot_listeners[s]===void 0)return t.call(this,s,i);var n=e.__ot_listeners[s],a=n.get(i);return n.delete(i),t.call(this,s,a||i)}},r.prototype.active=function(){if(!this._enabled)return wr;var e=this._getActiveZone(),t=this._activeContextFromZone(e);return t||wr},r.prototype.bind=function(e,t){return e===void 0&&(e=this.active()),typeof t=="function"?this._bindFunction(e,t):(OO(t)&&this._bindListener(e,t),t)},r.prototype.disable=function(){return this._enabled=!1,this},r.prototype.enable=function(){return this._enabled=!0,this},r.prototype.with=function(e,t,s){for(var i=[],n=3;n<arguments.length;n++)i[n-3]=arguments[n];var a=this._createZoneName(),o=this._createZone(a,e);return o.run(t,s,i)},r}(),MO=/\s/;function NO(r){for(var e=r.length;e--&&MO.test(r.charAt(e)););return e}var LO=/^\s+/;function xO(r){return r&&r.slice(0,NO(r)+1).replace(LO,"")}var W_=0/0,UO=/^[-+]0x[0-9a-f]+$/i,BO=/^0b[01]+$/i,FO=/^0o[0-7]+$/i,VO=parseInt;function J_(r){if(typeof r=="number")return r;if(MC(r))return W_;if(Qs(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=Qs(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=xO(r);var t=BO.test(r);return t||FO.test(r)?VO(r.slice(2),t?2:8):UO.test(r)?W_:+r}var $O=function(){return Dr.Date.now()};const Jh=$O;var HO="Expected a function",jO=Math.max,GO=Math.min;function qO(r,e,t){var s,i,n,a,o,c,l=0,u=!1,h=!1,p=!0;if(typeof r!="function")throw new TypeError(HO);e=J_(e)||0,Qs(t)&&(u=!!t.leading,h="maxWait"in t,n=h?jO(J_(t.maxWait)||0,e):n,p="trailing"in t?!!t.trailing:p);function m(W){var Se=s,lt=i;return s=i=void 0,l=W,a=r.apply(lt,Se),a}function v(W){return l=W,o=setTimeout(k,e),u?m(W):a}function y(W){var Se=W-c,lt=W-l,or=e-Se;return h?GO(or,n-lt):or}function C(W){var Se=W-c,lt=W-l;return c===void 0||Se>=e||Se<0||h&&lt>=n}function k(){var W=Jh();if(C(W))return D(W);o=setTimeout(k,y(W))}function D(W){return o=void 0,p&&s?m(W):(s=i=void 0,a)}function V(){o!==void 0&&clearTimeout(o),l=0,s=c=i=o=void 0}function M(){return o===void 0?a:D(Jh())}function Pe(){var W=Jh(),Se=C(W);if(s=arguments,i=this,c=W,Se){if(o===void 0)return v(c);if(h)return clearTimeout(o),o=setTimeout(k,e),m(c)}return o===void 0&&(o=setTimeout(k,e)),a}return Pe.cancel=V,Pe.flush=M,Pe}var KO="[object Map]",WO="[object Set]",JO=Object.prototype,zO=JO.hasOwnProperty;function YO(r){if(r==null)return!0;if(Wu(r)&&(dd(r)||typeof r=="string"||typeof r.splice=="function"||Gu(r)||jm(r)||xm(r)))return!r.length;var e=ud(r);if(e==KO||e==WO)return!r.size;if(ld(r))return!Km(r).length;for(var t in r)if(zO.call(r,t))return!1;return!0}function xd(r){const e={};return typeof(r==null?void 0:r.code)=="number"&&(e.code=r.code),typeof(r==null?void 0:r.code)=="string"&&(e.code=r.code.substring(0,100)),typeof(r==null?void 0:r.name)=="string"&&(e.name=r.name.substring(0,500)),typeof(r==null?void 0:r.message)=="string"&&(e.message=r.message.substring(0,500)),typeof(r==null?void 0:r.reason)=="string"&&(e.reason=r.reason.substring(0,500)),typeof(r==null?void 0:r.stack)=="string"&&(e.stack=r.stack.substring(0,500)),e}function Ud(){var t,s,i,n;const r=typeof navigator!="undefined"&&!navigator.isReactNative&&((t=window.location.host)==null?void 0:t.includes("staging"))&&((s=window.location.host)==null?void 0:s.includes("dyte.io")),e=!!((n=(i=_e.modules)==null?void 0:i.devTools)!=null&&n.logs);return r||e}function XO(r){if(x.hasFeature(U.LOG_LEVEL)){let e=x.getValue(U.LOG_LEVEL)||"all";if(e=e.toLowerCase().trim(),e==="off")return!1;if(e!=="all"){const t=["debug","log","info","warn","error"],s=t.indexOf(r),i=t.indexOf(e);if(s<i)return!1}}return!0}function z_(r,e,t={}){return Object.getOwnPropertyNames(r).forEach(s=>{var n;if([null,void 0,NaN].includes(r[s])||e&&(((n=e.match(/\./g))==null?void 0:n.length)||0)>=10)return;const i=e?`${e}.${s}`:s;typeof r[s]=="object"?z_(r[s],i,t):["number","string","boolean"].includes(typeof r[s])&&(t[i]=r[s])}),t}function zh(r,e={},t=""){const s={};try{const i=JSON.stringify(e),n=JSON.parse(i),a=z_(n,t),o=JSON.stringify(a);if(o.length>5e3){const c=`Log named: "${r}" is trying to log an flattened object of size ${o.length} chars that is beyond permitted limit of 5000 chars. Please optimize.`;throw Ud()&&console.error(c,{log:e,flattened:o}),new Error(c)}return JSON.parse(o)}catch(i){const n=xd(i);s[`${t}.error.message`]=n.message||"",s[`${t}.error.stack`]=n.stack||"",s[`${t}.error.reason`]=n.reason||"",s[`${t}.error.source`]="safelyFlattenObjForOpenTelemetry"}return s}const re={isV2AuthToken:!1,meetingId:null,overrides:{},roomNodeOptions:void 0},Fo={baseURL:"http://localhost:5000",createdAt:"2021-08-05T10:49:56.602Z",description:"Develop plugins locally",id:"09259e3b-7be8-46f6-9801-106bf1866e1c",name:"Localhost Dev",organizationId:"4ad15a19-80e2-4105-bf43-48039fd2963e",picture:"https://dyte-uploads.s3.ap-south-1.amazonaws.com/dyte.png",private:!1,published:!0,staggered:!1,tags:["#localhost","#dev"],type:"self_hosted",updatedAt:"2021-08-05T10:50:07.681Z"};function QO(r,e){if(e){re.isV2AuthToken=!1;return}try{const{meetingId:t}=JSON.parse(atob(r.split(".")[1]));if(!t)throw Error(`Received V1 auth token ${r}`);re.isV2AuthToken=!0,re.meetingId=t}catch(t){throw g.error("constants::setIsV2AuthToken",{error:t,debuggingHint:`Unable to decode auth token: ${r}`},!0),new w("Invalid auth token")}}function ZO(r){re.overrides=r}function Bd(r){return re.overrides&&re.overrides[r]?re.overrides[r]:!1}function Y_(r){re.roomNodeOptions=r}function X_(r,e){return!!(re.isV2AuthToken&&(x.hasFeature(U.CONNECTED_MEETINGS)||r===xt.Livestream||r===xt.Chat)||e.includes("HIVE"))}function Yh(r,e){return X_(r,e)?!0:(x.getValue(U.CHAT_SOCKET_SERVER)||Bd(U.CHAT_SOCKET_SERVER)||"socket-service")==="socket-service"}function Q_(r,e){return X_(r,e)?!0:(x.getValue(U.POLL_SOCKET_SERVER)||"socket-service")==="socket-service"}function Xh(r,e){return e.includes("HIVE")?!0:(x.getValue(U.PLUGIN_SOCKET_SERVER)||"socket-service")==="socket-service"}function Z_(r,e){return Yh(r,e)||Q_(r,e)||Xh(r,e)}const ee=class{static get logsEndpoint(){return Ud()?"https://api-silos-staging.dyte.io/otel/logs":"https://api-silos.dyte.io/otel/logs"}static init(e,t){if(navigator.isReactNative)return;const s=new kO({url:"https://otel.dyte.io/v1/traces",headers:{"api-key":""}});let i=Ud()?"staging":"production";const n=new Zk({resource:new Wh({"service.name":Ed,sdk_version:ca,env:i,...zh("OTELResource",he.getDeviceInfo(),"device")}),idGenerator:{generateTraceId:()=>`${e}`.replace(/-/g,""),generateSpanId:()=>Yc().replace(/-/g,"").substring(0,16)}});ee.tracingEnabled=t,ee.tracer=n.getTracer(e),ee.meetingMetadata.peerId=e,ee.meetingMetadata.sdkVersion=ca,ee.meetingMetadata.deviceInfo=he.getDeviceInfo(),ee.meetingMetadata.visitedUrl=!navigator.isReactNative&&typeof window!="undefined"&&window.location.href,n.addSpanProcessor(new B_(s)),"zone"in window?n.register({contextManager:new DO}):n.register({contextManager:new V_}),ee.contextPropagator=la,document.addEventListener("visibilitychange",ee.processCachedLogs),ee.logsProcessorTimer=setInterval(ee.processCachedLogs,ee.logsProcessingInterval),ee.initPerformanceObserver(),t&&(ee.rootSpan=ee.tracer.startSpan(`peer_${e}`,{},wr),ee.rootSpan.end(),ee.initialized=!0)}static initPerformanceObserver(){try{typeof PerformanceObserver!="undefined"&&!Bd("disable_api_peformance_observer")&&(ee.apiPerformanceObserver=new PerformanceObserver(e=>{var t;(t=e.getEntries())==null||t.forEach(s=>{var n;const i=s==null?void 0:s.toJSON();["xmlhttprequest","fetch"].includes(i.initiatorType)&&((n=i.name)!=null&&n.includes("dyte"))&&g.debug(`api_performance_observer::${i.name}`,{performanceObserver:{api:i}})})}),ee.apiPerformanceObserver.observe({type:"resource",buffered:!0}))}catch(e){}}static trace(e){return(t,s,i)=>{const n=i.value;return i.value=function(...o){if(!ee.initialized||navigator.isReactNative||!ee.tracingEnabled||x.hasFeature(U.SKIP_OTEL_TRACES))return n.apply(this,o);const c=ee.getCurrentSpan(),l=Rd.trace.setSpan(wr,c);return x.hasFeature(U.NR_OTEL_WEB)||ee.addLogInCurrentSpan("info",e),ee.tracer.startActiveSpan(e,{},l,u=>{const h=n.apply(this,o);return Promise.resolve(h).then(()=>{u.end()}).catch(()=>{u.end()}),h})},i}}static getCurrentSpan(){if(navigator.isReactNative)return null;let e=Rd.trace.getSpan(Rd.context.active());return e!=null||(e=ee.rootSpan),e}static getCurrentContext(){return Rd.trace.setSpan(wr,ee.getCurrentSpan())}static getCurrentSpanName(){var e;return(e=this.getCurrentSpan())==null?void 0:e.name}static injectContext(e){ee.getCurrentSpan()&&ee.contextPropagator.inject(ee.getCurrentContext(),e)}static addLogInCurrentSpan(e,t,s={},i=!1){var a,o;if(s!=null&&s.error&&Object.assign(s,{error:xd(s.error)}),Ud()&&(YO(s)?console[e]("DyteInternalLogs:: ",e,t):console[e]("DyteInternalLogs:: ",e,t,s)),!!XO(e))try{const c=zh(t,s,"metadata"),l=ee.getCurrentSpan(),u=new Date,h={message:t,level:e,...c,"trace.id":(a=l==null?void 0:l.spanContext())==null?void 0:a.traceId,"span.id":(o=l==null?void 0:l.spanContext())==null?void 0:o.spanId,loggedAt:u.toISOString(),loggedAtTzOffset:u.getTimezoneOffset()};i?ee.sendOtelLogsToNewRelic([h]):ee.logsCache.push(h)}catch(c){ee.addLogInCurrentSpan("error","opentelemetry::addLogInCurrentSpan_failed",{error:xd(c)})}}static sendOtelLogsToNewRelic(e){nd.post(ee.logsEndpoint,{meetingMetadata:zh("sendOtelLogsToNewRelic",ee.meetingMetadata,"meetingMetadata"),serviceName:Ed,logs:e}).catch(t=>{ee.addLogInCurrentSpan("error","opentelemetry::sendOtelLogToNewRelic_failed",{error:xd(t)}),ee.logsCache.push(...e)})}static processCachedLogs(){const e=ee.logsCache.splice(0,25);e!=null&&e.length&&ee.sendOtelLogsToNewRelic(e)}static destruct(){var e;clearInterval(ee.logsProcessorTimer),ee.processCachedLogs(),!navigator.isReactNative&&(document.removeEventListener("visibilitychange",ee.processCachedLogs),(e=ee.apiPerformanceObserver)==null||e.disconnect())}};let _=ee;f(_,"tracer"),f(_,"contextPropagator"),f(_,"apiPerformanceObserver"),f(_,"rootSpan"),f(_,"logsCache",[]),f(_,"logsProcessorTimer"),f(_,"tracingEnabled",!0),f(_,"initialized",!1),f(_,"logsProcessingInterval",7e3),f(_,"logExclusionList",["message","websocket/message","roomMessage","websocket/room-message","websocket/room-legacy-mode","chatMessage","websocket/new-chat-message","websocket/no-active-speaker","websocket/selected-peers","websocket/active-speaker","ping","websocket/new-consumer","websocket/producer-score","websocket/consumer-score","websocket/plugin-event","websocket/plugin-data","websocket/plugin-internal-data"]),f(_,"meetingMetadata",{});class g{static info(e,t,s){_.addLogInCurrentSpan("info",e,t,s)}static error(e,t,s){_.addLogInCurrentSpan("error",e,t,s)}static debug(e,t,s){_.addLogInCurrentSpan("debug",e,t,s)}static log(e,t,s){_.addLogInCurrentSpan("log",e,t,s)}static warn(e,t,s){_.addLogInCurrentSpan("warn",e,t,s)}}const eD={"00":"DyteClient","01":"Controller","02":"RoomNodeClient","03":"HiveNodeClient","04":"SocketService","05":"Chat","06":"Plugin","07":"Polls","08":"Meta","09":"Preset",10:"Recording",11:"Self",12:"Participant",13:"Spotlight",14:"Remote Request",15:"Webinar",16:"LocalMediaHandler"},Fd={"0000":"Internal exception.","0001":"Failed to initialize.","0002":"Failed to join room.","0003":"Failed to leave room.","0100":"Internal exception","0200":"Internal exception.","0300":"Internal exception","0400":"Internal exception","0500":"Internal exception","0501":"Permission denied.","0502":"Invalid message body.","0510":"Invalid channel name.","0600":"Internal exception","0700":"Internal exception","0800":"Internal exception","0900":"Internal exception",1e3:"Internal exception",1100:"Internal exception",1200:"Internal exception",1300:"Internal exception",1400:"Internal exception",1500:"Internal exception",1600:"Internal exception",1601:"Failed to get audio track",1602:"Failed to get video track",1603:"Incorrect device",1604:"Failed to change device",1700:"Internal exception"};Object.keys(Fd).forEach(r=>{Fd[r]=`{${eD[r.slice(0,2)]}} ${Fd[r]}`});class w extends Error{constructor(t,s,i=!1){super(t);f(this,"code");this.code=s,this.name="DyteError",this.message=`[ERR${this.code}]: ${Fd[this.code]}
${this.message}`;try{let n=i;s&&s.endsWith("00")&&(n=!0),n&&g.error("DyteError",{error:{message:this.message,name:this.name,code:s}})}catch(n){}}}function Vd(r,e,t,s){if(typeof t=="function"&&s instanceof e)t.call(null,s,r);else throw s}function ev(r,e,t){if(!r.value){const i=r.get,n=r.set;return i&&(r.get=function(){try{return i.apply(this)}catch(a){Vd(this,e,t,a)}}),n&&(r.set=function(a){try{return n.apply(this,[a])}catch(o){Vd(this,e,t,o)}}),r}const s=r.value;return r.value=function(...i){try{const n=s.apply(this,i);return n&&n instanceof Promise?n.catch(a=>{Vd(this,e,t,a)}):n}catch(n){Vd(this,e,t,n)}},r}function tD(r,e){return(t,s,i)=>{if(i)return ev(i,r,e);for(const n of Reflect.ownKeys(t.prototype).filter(a=>a!=="constructor")){const a=Object.getOwnPropertyDescriptor(t.prototype,n);(a.value instanceof Function||a.get instanceof Function||a.set instanceof Function)&&Object.defineProperty(t.prototype,n,ev(a,r,e))}}}const Bt=r=>tD(Error,r);var rn=(r=>(r.allowed="ALLOWED",r.notAllowed="NOT_ALLOWED",r.canRequest="CAN_REQUEST",r))(rn||{});const rD={view_type:xt.GroupCall,accept_waiting_requests:!1,request_produce:!1,can_allow_participant_audio:!0,can_allow_participant_screensharing:!1,can_allow_participant_video:!0,request_kick_participant:!1,kick_participant:!0,pin_participant:!0,can_record:!1,waiting_room_type:"SKIP",plugins:{can_close:!0,can_start:!0,can_edit_acl:!1,config:{}},polls:{can_create:!0,can_vote:!0,can_view:!0},produce:{video:{allow:!0,quality:sr.video.quality,frame_rate:sr.video.frameRate},audio:!0,screenshare:{allow:!0,quality:sr.screenshare.quality,frame_rate:sr.screenshare.frameRate}},chat:{public:{can_send:!0,text:!0,files:!0},private:{can_send:!1,can_receive:!1,text:!1,files:!1}},reactions:!1,hidden_participant:!1,show_participant_list:!0,can_change_participant_role:!0,can_change_theme:!1,can_present:!1,accept_present_requests:!1,can_edit_display_name:!1,max_screenshare_count:1,is_recorder:!1,can_spotlight:!1},sD=Sr(rD),Vl=class{constructor(e){S(this,oe,void 0);if(!e)throw g.error("DytePermissionsPresetV1::load_preset_permissions_failed"),new w("Could not load preset permissions.");R(this,oe,e)}static fromResponse(e){return new Vl(e)}static default(){return new Vl(sD)}get viewType(){return d(this,oe).viewType}get acceptWaitingRequests(){return d(this,oe).acceptWaitingRequests}get requestProduce(){return d(this,oe).requestProduce}get requestProduceAudio(){return this.requestProduce}get requestProduceScreenshare(){return this.requestProduce}get canAllowParticipantAudio(){return d(this,oe).canAllowParticipantAudio}get canAllowParticipantScreensharing(){return d(this,oe).canAllowParticipantScreensharing}get canAllowParticipantVideo(){return d(this,oe).canAllowParticipantVideo}get canDisableParticipantAudio(){return this.canAllowParticipantAudio}get canDisableParticipantVideo(){return this.canAllowParticipantVideo}get kickParticipant(){return d(this,oe).kickParticipant}get pinParticipant(){return d(this,oe).pinParticipant}get canRecord(){return d(this,oe).canRecord}get waitingRoomType(){return d(this,oe).waitingRoomType}get waitingRoomBehaviour(){return d(this,oe).waitingRoomType==="SKIP"?"SKIP":d(this,oe).waitingRoomType==="SKIP_ON_PRIVILEGED_USER_ENTRY"?"ON_PRIVILEGED_USER_ENTRY":d(this,oe).waitingRoomType==="ON_ACCEPT"?"SKIP_ON_ACCEPT":"SKIP"}get plugins(){return d(this,oe).plugins}get polls(){return{...d(this,oe).polls,canViewResults:d(this,oe).polls.canView}}get produceVideo(){return{...d(this,oe).produce.video,allow:d(this,oe).produce.video.allow?"ALLOWED":"NOT_ALLOWED"}}get canProduceVideo(){const e=d(this,oe).produce.video.allow;return this.requestProduce?"CAN_REQUEST":e?"ALLOWED":"NOT_ALLOWED"}get produceScreenshare(){return{...d(this,oe).produce.screenshare,allow:d(this,oe).produce.screenshare.allow?"ALLOWED":"NOT_ALLOWED"}}get canProduceScreenshare(){const e=d(this,oe).produce.screenshare.allow;return this.requestProduce?"CAN_REQUEST":e?"ALLOWED":"NOT_ALLOWED"}get produceAudio(){return d(this,oe).produce.audio?"ALLOWED":"NOT_ALLOWED"}get canProduceAudio(){const e=d(this,oe).produce.audio;return this.requestProduce?"CAN_REQUEST":e?"ALLOWED":"NOT_ALLOWED"}get chatPublic(){return d(this,oe).chat.public}get chatPrivate(){return d(this,oe).chat.private}get connectedMeetings(){return{canAlterConnectedMeetings:!1,canSwitchConnectedMeetings:!1,canSwitchToParentMeeting:!1}}get reactions(){return d(this,oe).reactions}get hiddenParticipant(){return d(this,oe).hiddenParticipant}get showParticipantList(){return d(this,oe).showParticipantList}get canChangeParticipantRole(){return d(this,oe).canChangeParticipantRole}get canChangeTheme(){return d(this,oe).canChangeTheme}get canPresent(){return d(this,oe).canPresent}get acceptPresentRequests(){return d(this,oe).acceptPresentRequests}get canEditDisplayName(){return d(this,oe).canEditDisplayName}get maxScreenShareCount(){return d(this,oe).maxScreenshareCount}get isRecorder(){return d(this,oe).isRecorder}get canLivestream(){return!1}get canSpotlight(){return d(this,oe).canSpotlight}get isV2(){return!1}};let $d=Vl;oe=new WeakMap;var Qh=(r=>(r.REQUESTED_BY_PARTICIPANT="REQUESTED_BY_PARTICIPANT",r.REQUESTED_BY_MODERATOR="REQUESTED_BY_MODERATOR",r))(Qh||{}),Zh=(r=>(r.PRESENT="REQUEST_TO_PRESENT",r))(Zh||{});class iD extends Jt.EventEmitter{constructor(){super();S(this,Ms,void 0);S(this,Ns,void 0);f(this,"asyncPromiseTimeout");R(this,Ms,new Map),R(this,Ns,new Map),this.asyncPromiseTimeout=8e3}async emitAsync(t,...s){d(this,Ms).set(t,[]);const i=d(this,Ns).get(t).map(()=>new Promise(n=>{d(this,Ms).get(t).push(n)}));super.emit(t,...s),await Promise.race([Promise.all(i),new Promise((n,a)=>setTimeout(()=>a(new Error("emitAsync failed to resolve.")),this.asyncPromiseTimeout))]),d(this,Ms).delete(t)}onAsync(t,s){const i=d(this,Ms),n=async(...a)=>{var c;try{await s(...a)}catch(l){g.error("[onAsync]",{error:l})}const o=(c=i.get(t))==null?void 0:c.shift();o==null||o()};return d(this,Ns).get(t)||d(this,Ns).set(t,[]),d(this,Ns).get(t).push(n),super.on(t,n)}reset(){R(this,Ms,new Map),R(this,Ns,new Map),super.removeAllListeners()}}Ms=new WeakMap,Ns=new WeakMap;const E=new iD;var T=(r=>(r.NEW_PRODUCER="NEW_PRODUCER",r.PRODUCER_TRACK_ENDED="PRODUCER_TRACK_ENDED",r.ROOM_NODE_CONNECTED="ROOM_NODE_CONNECTED",r.ROOM_NODE_DISCONNECTED="ROOM_NODE_DISCONNECTED",r.ROOM_NODE_CONNECTION_ERROR="ROOM_NODE_CONNECTION_ERROR",r.SOCKET_SERVICE_CONNECTED="SOCKET_SERVICE_CONNECTED",r.SOCKET_SERVICE_DISCONNECTED="SOCKET_SERVICE_DISCONNECTED",r.SOCKET_SERVICE_RECONNECTING="SOCKET_SERVICE_RECONNECTING",r.SOCKET_SERVICE_RECONNECTION_ATTEMPT="SOCKET_SERVICE_RECONNECTION_ATTEMPT",r.SOCKET_SERVICE_RECONNECT_FAILURE="SOCKET_SERVICE_RECONNECT_FAILURE",r.SOCKET_SERVICE_RECONNECTED="SOCKET_SERVICE_RECONNECTED",r.SOCKET_SERVICE_FAILED="SOCKET_SERVICE_FAILED",r.ROOM_JOINED="ROOM_JOINED",r.SOCKET_SERVICE_ROOM_JOINED="SOCKET_SERVICE_ROOM_JOINED",r.SELF_ROOM_JOINED="SELF_ROOM_JOINED",r.PRODUCER_SCORE_UPDATE="PRODUCER_SCORE_UPDATE",r.CONSUMER_SCORE_UPDATE="CONSUMER_SCORE_UPDATE",r.PRODUCER_STATUS_UPDATE="PRODUCER_STATUS_UPDATE",r.CONSUMER_STATUS_UPDATE="CONSUMER_STATUS_UPDATE",r.LOW_PRODUCER_SCORE="LOW_PRODUCER_SCORE",r.LOW_CONSUMER_SCORE="LOW_CONSUMER_SCORE",r.MEDIA_PERMISSION_ERROR="MEDIA_PERMISSION_ERROR",r.MEDIA_PERMISSION_UPDATE="MEDIA_PERMISSION_UPDATE",r.WAITLISTED="WAIT_LISTED",r.WAITLIST_ACCEPTED="websocket/waitlist-accepted",r.WAITLIST_REJECTED="websocket/waitlist-rejected",r.WAITLIST_PEER_ADDED="websocket/waitlist-peer-added",r.WAITLIST_PEER_REMOVED="websocket/waitlist-peer-closed",r.MESSAGE="websocket/message",r.ROOM_MESSAGE="websocket/room-message",r.DISABLE_AUDIO="websocket/disable-audio",r.DISABLE_VIDEO="websocket/disable-video",r.PEER_JOINED="websocket/peer-joined",r.PEER_CLOSED="websocket/peer-closed",r.PEER_MUTED="websocket/peer-muted",r.PEER_UNMUTED="websocket/peer-unmuted",r.PEER_PINNED="websocket/pin-peer",r.PEER_UNPINNED="websocker/unpin-peer",r.MUTE_ALL="websocket/mute-all",r.MUTE_ALL_VIDEO="websocket/mute-all-video",r.CONSUMER_CLOSED="websocket/consumer-closed",r.CONSUMER_PAUSED="websocket/consumer-paused",r.CONSUMER_RESUMED="websocket/consumer-resumed",r.PRODUCER_CLOSED="websocket/producer-closed",r.NEW_CONSUMER="websocket/new-consumer",r.CONNECTED_MEETING_STATE="websocket/connectedMeetingState",r.MOVE_TO_CONNECTED_MEETING="websocket/transferMeeting",r.GET_CHAT_MESSAGES="websocket/get-chat-messages",r.NEW_CHAT_MESSAGE="websocket/new-chat-message",r.PIN_CHAT_MESSAGE="websocket/pin-chat-message",r.UNPIN_CHAT_MESSAGE="websocket/unpin-chat-message",r.GET_POLLS="websocket/get-polls",r.UPDATE_POLL="websocket/update-poll",r.SELECTED_PEERS="websocket/selected-peers",r.GET_PAGE="websocket/get-page",r.ACTIVE_SPEAKER="websocket/active-speaker",r.NO_ACTIVE_SPEAKER="websocket/no-active-speaker",r.PRODUCER_SCORE="websocket/producer-score",r.CONSUMER_SCORE="websocket/consumer-score",r.ENABLE_PLUGIN="websocket/enable-plugin",r.DISABLE_PLUGIN="websocket/disable-plugin",r.PLUGIN_EVENT="websocket/plugin-event",r.PLUGIN_DATA="websocket/plugin-data",r.PLUGIN_INTERNAL_DATA="websocket/plugin-internal-data",r.KICKED="websocket/kicked",r.RECORDING_STARTED="websocket/recording-started",r.RECORDING_STOPPED="websocket/recording-stopped",r.ICE_CONNECTED="ICE_CONNECTED",r.ICE_DISCONNECTED="ICE_DISCONNECTED",r.ICE_FAILED="ICE_FAILED",r.ICE_RECONNECTING="ICE_RECONNECTING",r.AUDIO_TRACK_ANALYSIS="AUDIO_TRACK_ANALYSIS",r.AUDIO_TRACK_CLOSED="AUDIO_TRACK_CLOSED",r.AUDIO_TRACK_CHANGED="AUDIO_TRACK_CHANGED",r.AUDIO_TRACK_CREATED="AUDIO_TRACK_CREATED",r.VIDEO_TRACK_ANALYSIS="VIDEO_TRACK_ANALYSIS",r.VIDEO_TRACK_ANALYSIS_ERROR="VIDEO_TRACK_ANALYSIS_ERROR",r.VIDEO_TRACK_CLOSED="VIDEO_TRACK_CLOSED",r.VIDEO_TRACK_CHANGED="VIDEO_TRACK_CHANGED",r.VIDEO_TRACK_CREATED="VIDEO_TRACK_CREATED",r.SCREENSHARE_AUDIO_TRACK_ANALYSIS="SCREENSHARE_AUDIO_TRACK_ANALYSIS",r.SCREENSHARE_AUDIO_TRACK_CLOSED="SCREENSHARE_AUDIO_TRACK_CLOSED",r.SCREENSHARE_AUDIO_TRACK_CREATED="SCREENSHARE_AUDIO_TRACK_CREATED",r.SCREENSHARE_VIDEO_TRACK_ANALYSIS="SCREENSHARE_VIDEO_TRACK_ANALYSIS",r.SCREENSHARE_VIDEO_TRACK_ANALYSIS_ERROR="SCREENSHARE_VIDEO_TRACK_ANALYSIS_ERROR",r.SCREENSHARE_VIDEO_TRACK_CLOSED="SCREENSHARE_VIDEO_TRACK_CLOSED",r.SCREENSHARE_VIDEO_TRACK_CREATED="SCREENSHARE_VIDEO_TRACK_CREATED",r.SCREENSHARE_TRACK_CHANGED="SCREENSHARE_TRACK_CHANGED",r.CANDIDATE_PEER_UPDATE="CANDIDATE_PEER_UPDATE",r.INBOUND_RTP_UPDATE="INBOUND_RTP_UPDATE",r.OUTBOUND_RTP_UPDATE="OUTBOUND_RTP_UPDATE",r.SEND_TRANSPORT_CLOSED="SEND_TRANSPORT_CLOSED",r.RECV_TRANSPORT_CLOSED="RECV_TRANSPORT_CLOSED",r.SEND_TRANSPORT_CREATED="SEND_TRANSPORT_CREATED",r.RECV_TRANSPORT_CREATED="RECV_TRANSPORT_CREATED",r.PRODUCER_TOGGLE="hive/producer-toggle",r.CONSUMER_TOGGLE="hive/consumer-toggle",r.SELECTED_PEERS_DIFF="hive/selected-peers-diff",r.REFRESH_GRID="hive/refresh-grid",r.RESET_PRODUCER_STATE="hive/reset-producer-state",r.HIVE_RECORDING_STARTED="hive/recording-started",r.HIVE_RECORDING_STOPPED="hive/recording-stopped",r.HIVE_TRANSPORT_STATE_CHANGED="hive/transport-state-changed",r.HIVE_ROOM_REJOINING="hive/room-rejoining",r.HIVE_TRANPSORT_RECONNECTING="hive/transport-reconnecting",r.ROOM_STATE="sockethub/room-state",r.PEER_DISPLAY_NAME_CHANGED="hive/display-name-changed",r.ASSERT_SPOTLIGHTER="websocket/assert-spotlighter",r.PEER_REQUESTED_TO_JOIN_STAGE="websocket/request-to-join-stage-peer-added",r.PEER_WITHDRAWN_REQUEST_TO_JOIN_STAGE="websocket/request-to-join-stage-peer-withdrawn",r.PEER_REJECTED_TO_JOIN_STAGE="websocket/peer-rejected-to-join-stage",r.PEER_ADDED_TO_STAGE="websocket/peer-added-to-stage",r.PEER_REMOVED_FROM_STAGE="websocket/peer-removed-from-stage",r.PEER_STARTED_PRESENTING="websocket/peer-started-presenting",r.PEER_STOPPED_PRESENTING="websocket/peer-stopped-presenting",r.REQUEST_TO_JOIN_STAGE_ACCEPTED="websocket/request-to-join-stage-accepted",r.REQUEST_TO_JOIN_STAGE_REJECTED="websocket/request-to-join-stage-rejected",r.STARTED_PRESENTING="websocket/started-presenting",r.STOPPED_PRESENTING="websocket/stopped-presenting",r.REMOVED_FROM_STAGE="websocket/removed-from-stage",r.JOIN_MEDIA_ROOM="JOIN_MEDIA_ROOM",r.LEAVE_MEDIA_ROOM="LEAVE_MEDIA_ROOM",r))(T||{});function ep(r){let e=typeof r;if(e=="object"){if(Array.isArray(r))return"array";if(r===null)return"null"}return e}function nD(r){return r!==null&&typeof r=="object"&&!Array.isArray(r)}let Ss="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Hd=[];for(let r=0;r<Ss.length;r++)Hd[Ss[r].charCodeAt(0)]=r;Hd["-".charCodeAt(0)]=Ss.indexOf("+"),Hd["_".charCodeAt(0)]=Ss.indexOf("/");function aD(r){let e=r.length*3/4;r[r.length-2]=="="?e-=2:r[r.length-1]=="="&&(e-=1);let t=new Uint8Array(e),s=0,i=0,n,a=0;for(let o=0;o<r.length;o++){if(n=Hd[r.charCodeAt(o)],n===void 0)switch(r[o]){case"=":i=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(i){case 0:a=n,i=1;break;case 1:t[s++]=a<<2|(n&48)>>4,a=n,i=2;break;case 2:t[s++]=(a&15)<<4|(n&60)>>2,a=n,i=3;break;case 3:t[s++]=(a&3)<<6|n,i=0;break}}if(i==1)throw Error("invalid base64 string.");return t.subarray(0,s)}function oD(r){let e="",t=0,s,i=0;for(let n=0;n<r.length;n++)switch(s=r[n],t){case 0:e+=Ss[s>>2],i=(s&3)<<4,t=1;break;case 1:e+=Ss[i|s>>4],i=(s&15)<<2,t=2;break;case 2:e+=Ss[i|s>>6],e+=Ss[s&63],t=0;break}return t&&(e+=Ss[i],e+="=",t==1&&(e+="=")),e}var jd;(function(r){r.symbol=Symbol.for("protobuf-ts/unknown"),r.onRead=(t,s,i,n,a)=>{(e(s)?s[r.symbol]:s[r.symbol]=[]).push({no:i,wireType:n,data:a})},r.onWrite=(t,s,i)=>{for(let{no:n,wireType:a,data:o}of r.list(s))i.tag(n,a).raw(o)},r.list=(t,s)=>{if(e(t)){let i=t[r.symbol];return s?i.filter(n=>n.no==s):i}return[]},r.last=(t,s)=>r.list(t,s).slice(-1)[0];const e=t=>t&&Array.isArray(t[r.symbol])})(jd||(jd={}));var rt;(function(r){r[r.Varint=0]="Varint",r[r.Bit64=1]="Bit64",r[r.LengthDelimited=2]="LengthDelimited",r[r.StartGroup=3]="StartGroup",r[r.EndGroup=4]="EndGroup",r[r.Bit32=5]="Bit32"})(rt||(rt={}));function cD(){let r=0,e=0;for(let s=0;s<28;s+=7){let i=this.buf[this.pos++];if(r|=(i&127)<<s,!(i&128))return this.assertBounds(),[r,e]}let t=this.buf[this.pos++];if(r|=(t&15)<<28,e=(t&112)>>4,!(t&128))return this.assertBounds(),[r,e];for(let s=3;s<=31;s+=7){let i=this.buf[this.pos++];if(e|=(i&127)<<s,!(i&128))return this.assertBounds(),[r,e]}throw new Error("invalid varint")}function tp(r,e,t){for(let n=0;n<28;n=n+7){const a=r>>>n,o=!(!(a>>>7)&&e==0),c=(o?a|128:a)&255;if(t.push(c),!o)return}const s=r>>>28&15|(e&7)<<4,i=!!(e>>3);if(t.push((i?s|128:s)&255),!!i){for(let n=3;n<31;n=n+7){const a=e>>>n,o=!!(a>>>7),c=(o?a|128:a)&255;if(t.push(c),!o)return}t.push(e>>>31&1)}}const Gd=(1<<16)*(1<<16);function tv(r){let e=r[0]=="-";e&&(r=r.slice(1));const t=1e6;let s=0,i=0;function n(a,o){const c=Number(r.slice(a,o));i*=t,s=s*t+c,s>=Gd&&(i=i+(s/Gd|0),s=s%Gd)}return n(-24,-18),n(-18,-12),n(-12,-6),n(-6),[e,s,i]}function rp(r,e){if(e<=2097151)return""+(Gd*e+r);let t=r&16777215,s=(r>>>24|e<<8)>>>0&16777215,i=e>>16&65535,n=t+s*6777216+i*6710656,a=s+i*8147497,o=i*2,c=1e7;n>=c&&(a+=Math.floor(n/c),n%=c),a>=c&&(o+=Math.floor(a/c),a%=c);function l(u,h){let p=u?String(u):"";return h?"0000000".slice(p.length)+p:p}return l(o,0)+l(a,o)+l(n,1)}function rv(r,e){if(r>=0){for(;r>127;)e.push(r&127|128),r=r>>>7;e.push(r)}else{for(let t=0;t<9;t++)e.push(r&127|128),r=r>>7;e.push(1)}}function dD(){let r=this.buf[this.pos++],e=r&127;if(!(r&128))return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<7,!(r&128))return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<14,!(r&128))return this.assertBounds(),e;if(r=this.buf[this.pos++],e|=(r&127)<<21,!(r&128))return this.assertBounds(),e;r=this.buf[this.pos++],e|=(r&15)<<28;for(let t=5;r&128&&t<10;t++)r=this.buf[this.pos++];if(r&128)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function lD(){const r=new DataView(new ArrayBuffer(8));return globalThis.BigInt!==void 0&&typeof r.getBigInt64=="function"&&typeof r.getBigUint64=="function"&&typeof r.setBigInt64=="function"&&typeof r.setBigUint64=="function"?{MIN:BigInt("-9223372036854775808"),MAX:BigInt("9223372036854775807"),UMIN:BigInt("0"),UMAX:BigInt("18446744073709551615"),C:BigInt,V:r}:void 0}const xe=lD();function sv(r){if(!r)throw new Error("BigInt unavailable, see https://github.com/timostamm/protobuf-ts/blob/v1.0.8/MANUAL.md#bigint-support")}const iv=/^-?[0-9]+$/,qd=(1<<16)*(1<<16);class nv{constructor(e,t){this.lo=e|0,this.hi=t|0}isZero(){return this.lo==0&&this.hi==0}toNumber(){let e=this.hi*qd+(this.lo>>>0);if(!Number.isSafeInteger(e))throw new Error("cannot convert to safe number");return e}}class jt extends nv{static from(e){if(xe)switch(typeof e){case"string":if(e=="0")return this.ZERO;if(e=="")throw new Error("string is no integer");e=xe.C(e);case"number":if(e===0)return this.ZERO;e=xe.C(e);case"bigint":if(!e)return this.ZERO;if(e<xe.UMIN)throw new Error("signed value for ulong");if(e>xe.UMAX)throw new Error("ulong too large");return xe.V.setBigUint64(0,e,!0),new jt(xe.V.getInt32(0,!0),xe.V.getInt32(4,!0))}else switch(typeof e){case"string":if(e=="0")return this.ZERO;if(e=e.trim(),!iv.test(e))throw new Error("string is no integer");let[t,s,i]=tv(e);if(t)throw new Error("signed value");return new jt(s,i);case"number":if(e==0)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");if(e<0)throw new Error("signed value for ulong");return new jt(e,e/qd)}throw new Error("unknown value "+typeof e)}toString(){return xe?this.toBigInt().toString():rp(this.lo,this.hi)}toBigInt(){return sv(xe),xe.V.setInt32(0,this.lo,!0),xe.V.setInt32(4,this.hi,!0),xe.V.getBigUint64(0,!0)}}jt.ZERO=new jt(0,0);class Ue extends nv{static from(e){if(xe)switch(typeof e){case"string":if(e=="0")return this.ZERO;if(e=="")throw new Error("string is no integer");e=xe.C(e);case"number":if(e===0)return this.ZERO;e=xe.C(e);case"bigint":if(!e)return this.ZERO;if(e<xe.MIN)throw new Error("ulong too small");if(e>xe.MAX)throw new Error("ulong too large");return xe.V.setBigInt64(0,e,!0),new Ue(xe.V.getInt32(0,!0),xe.V.getInt32(4,!0))}else switch(typeof e){case"string":if(e=="0")return this.ZERO;if(e=e.trim(),!iv.test(e))throw new Error("string is no integer");let[t,s,i]=tv(e),n=new Ue(s,i);return t?n.negate():n;case"number":if(e==0)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");return e>0?new Ue(e,e/qd):new Ue(-e,-e/qd).negate()}throw new Error("unknown value "+typeof e)}isNegative(){return(this.hi&2147483648)!==0}negate(){let e=~this.hi,t=this.lo;return t?t=~t+1:e+=1,new Ue(t,e)}toString(){if(xe)return this.toBigInt().toString();if(this.isNegative()){let e=this.negate();return"-"+rp(e.lo,e.hi)}return rp(this.lo,this.hi)}toBigInt(){return sv(xe),xe.V.setInt32(0,this.lo,!0),xe.V.setInt32(4,this.hi,!0),xe.V.getBigInt64(0,!0)}}Ue.ZERO=new Ue(0,0);const av={readUnknownField:!0,readerFactory:r=>new hD(r)};function uD(r){return r?Object.assign(Object.assign({},av),r):av}class hD{constructor(e,t){this.varint64=cD,this.uint32=dD,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t!=null?t:new TextDecoder("utf-8",{fatal:!0})}tag(){let e=this.uint32(),t=e>>>3,s=e&7;if(t<=0||s<0||s>5)throw new Error("illegal tag: field no "+t+" wire type "+s);return[t,s]}skip(e){let t=this.pos;switch(e){case rt.Varint:for(;this.buf[this.pos++]&128;);break;case rt.Bit64:this.pos+=4;case rt.Bit32:this.pos+=4;break;case rt.LengthDelimited:let s=this.uint32();this.pos+=s;break;case rt.StartGroup:let i;for(;(i=this.tag()[1])!==rt.EndGroup;)this.skip(i);break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(t,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return new Ue(...this.varint64())}uint64(){return new jt(...this.varint64())}sint64(){let[e,t]=this.varint64(),s=-(e&1);return e=(e>>>1|(t&1)<<31)^s,t=t>>>1^s,new Ue(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return new jt(this.sfixed32(),this.sfixed32())}sfixed64(){return new Ue(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function we(r,e){if(!r)throw new Error(e)}const pD=34028234663852886e22,fD=-34028234663852886e22,mD=4294967295,gD=2147483647,_D=-2147483648;function Vo(r){if(typeof r!="number")throw new Error("invalid int 32: "+typeof r);if(!Number.isInteger(r)||r>gD||r<_D)throw new Error("invalid int 32: "+r)}function Kd(r){if(typeof r!="number")throw new Error("invalid uint 32: "+typeof r);if(!Number.isInteger(r)||r>mD||r<0)throw new Error("invalid uint 32: "+r)}function sp(r){if(typeof r!="number")throw new Error("invalid float 32: "+typeof r);if(Number.isFinite(r)&&(r>pD||r<fD))throw new Error("invalid float 32: "+r)}const ov={writeUnknownFields:!0,writerFactory:()=>new TD};function vD(r){return r?Object.assign(Object.assign({},ov),r):ov}class TD{constructor(e){this.stack=[],this.textEncoder=e!=null?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let i=0;i<this.chunks.length;i++)e+=this.chunks[i].length;let t=new Uint8Array(e),s=0;for(let i=0;i<this.chunks.length;i++)t.set(this.chunks[i],s),s+=this.chunks[i].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Kd(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Vo(e),rv(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){sp(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Kd(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Vo(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Vo(e),e=(e<<1^e>>31)>>>0,rv(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),i=Ue.from(e);return s.setInt32(0,i.lo,!0),s.setInt32(4,i.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),i=jt.from(e);return s.setInt32(0,i.lo,!0),s.setInt32(4,i.hi,!0),this.raw(t)}int64(e){let t=Ue.from(e);return tp(t.lo,t.hi,this.buf),this}sint64(e){let t=Ue.from(e),s=t.hi>>31,i=t.lo<<1^s,n=(t.hi<<1|t.lo>>>31)^s;return tp(i,n,this.buf),this}uint64(e){let t=jt.from(e);return tp(t.lo,t.hi,this.buf),this}}const cv={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},dv={ignoreUnknownFields:!1};function ED(r){return r?Object.assign(Object.assign({},dv),r):dv}function yD(r){return r?Object.assign(Object.assign({},cv),r):cv}const SD=Symbol.for("protobuf-ts/message-type");function lv(r){let e=!1;const t=[];for(let s=0;s<r.length;s++){let i=r.charAt(s);i=="_"?e=!0:/\d/.test(i)?(t.push(i),e=!0):e?(t.push(i.toUpperCase()),e=!1):s==0?t.push(i.toLowerCase()):t.push(i)}return t.join("")}var A;(function(r){r[r.DOUBLE=1]="DOUBLE",r[r.FLOAT=2]="FLOAT",r[r.INT64=3]="INT64",r[r.UINT64=4]="UINT64",r[r.INT32=5]="INT32",r[r.FIXED64=6]="FIXED64",r[r.FIXED32=7]="FIXED32",r[r.BOOL=8]="BOOL",r[r.STRING=9]="STRING",r[r.BYTES=12]="BYTES",r[r.UINT32=13]="UINT32",r[r.SFIXED32=15]="SFIXED32",r[r.SFIXED64=16]="SFIXED64",r[r.SINT32=17]="SINT32",r[r.SINT64=18]="SINT64"})(A||(A={}));var rs;(function(r){r[r.BIGINT=0]="BIGINT",r[r.STRING=1]="STRING",r[r.NUMBER=2]="NUMBER"})(rs||(rs={}));var Wd;(function(r){r[r.NO=0]="NO",r[r.PACKED=1]="PACKED",r[r.UNPACKED=2]="UNPACKED"})(Wd||(Wd={}));function wD(r){var e,t,s,i;return r.localName=(e=r.localName)!==null&&e!==void 0?e:lv(r.name),r.jsonName=(t=r.jsonName)!==null&&t!==void 0?t:lv(r.name),r.repeat=(s=r.repeat)!==null&&s!==void 0?s:Wd.NO,r.opt=(i=r.opt)!==null&&i!==void 0?i:r.repeat||r.oneof?!1:r.kind=="message",r}function RD(r){if(typeof r!="object"||r===null||!r.hasOwnProperty("oneofKind"))return!1;switch(typeof r.oneofKind){case"string":return r[r.oneofKind]===void 0?!1:Object.keys(r).length==2;case"undefined":return Object.keys(r).length==1;default:return!1}}class bD{constructor(e){var t;this.fields=(t=e.fields)!==null&&t!==void 0?t:[]}prepare(){if(this.data)return;const e=[],t=[],s=[];for(let i of this.fields)if(i.oneof)s.includes(i.oneof)||(s.push(i.oneof),e.push(i.oneof),t.push(i.oneof));else switch(t.push(i.localName),i.kind){case"scalar":case"enum":(!i.opt||i.repeat)&&e.push(i.localName);break;case"message":i.repeat&&e.push(i.localName);break;case"map":e.push(i.localName);break}this.data={req:e,known:t,oneofs:Object.values(s)}}is(e,t,s=!1){if(t<0)return!0;if(e==null||typeof e!="object")return!1;this.prepare();let i=Object.keys(e),n=this.data;if(i.length<n.req.length||n.req.some(a=>!i.includes(a))||!s&&i.some(a=>!n.known.includes(a)))return!1;if(t<1)return!0;for(const a of n.oneofs){const o=e[a];if(!RD(o))return!1;if(o.oneofKind===void 0)continue;const c=this.fields.find(l=>l.localName===o.oneofKind);if(!c||!this.field(o[o.oneofKind],c,s,t))return!1}for(const a of this.fields)if(a.oneof===void 0&&!this.field(e[a.localName],a,s,t))return!1;return!0}field(e,t,s,i){let n=t.repeat;switch(t.kind){case"scalar":return e===void 0?t.opt:n?this.scalars(e,t.T,i,t.L):this.scalar(e,t.T,t.L);case"enum":return e===void 0?t.opt:n?this.scalars(e,A.INT32,i):this.scalar(e,A.INT32);case"message":return e===void 0?!0:n?this.messages(e,t.T(),s,i):this.message(e,t.T(),s,i);case"map":if(typeof e!="object"||e===null)return!1;if(i<2)return!0;if(!this.mapKeys(e,t.K,i))return!1;switch(t.V.kind){case"scalar":return this.scalars(Object.values(e),t.V.T,i,t.V.L);case"enum":return this.scalars(Object.values(e),A.INT32,i);case"message":return this.messages(Object.values(e),t.V.T(),s,i)}break}return!0}message(e,t,s,i){return s?t.isAssignable(e,i):t.is(e,i)}messages(e,t,s,i){if(!Array.isArray(e))return!1;if(i<2)return!0;if(s){for(let n=0;n<e.length&&n<i;n++)if(!t.isAssignable(e[n],i-1))return!1}else for(let n=0;n<e.length&&n<i;n++)if(!t.is(e[n],i-1))return!1;return!0}scalar(e,t,s){let i=typeof e;switch(t){case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:switch(s){case rs.BIGINT:return i=="bigint";case rs.NUMBER:return i=="number"&&!isNaN(e);default:return i=="string"}case A.BOOL:return i=="boolean";case A.STRING:return i=="string";case A.BYTES:return e instanceof Uint8Array;case A.DOUBLE:case A.FLOAT:return i=="number"&&!isNaN(e);default:return i=="number"&&Number.isInteger(e)}}scalars(e,t,s,i){if(!Array.isArray(e))return!1;if(s<2)return!0;if(Array.isArray(e)){for(let n=0;n<e.length&&n<s;n++)if(!this.scalar(e[n],t,i))return!1}return!0}mapKeys(e,t,s){let i=Object.keys(e);switch(t){case A.INT32:case A.FIXED32:case A.SFIXED32:case A.SINT32:case A.UINT32:return this.scalars(i.slice(0,s).map(n=>parseInt(n)),t,s);case A.BOOL:return this.scalars(i.slice(0,s).map(n=>n=="true"?!0:n=="false"?!1:n),t,s);default:return this.scalars(i,t,s,rs.STRING)}}}function Ur(r,e){switch(e){case rs.BIGINT:return r.toBigInt();case rs.NUMBER:return r.toNumber();default:return r.toString()}}class CD{constructor(e){this.info=e}prepare(){var e;if(this.fMap===void 0){this.fMap={};const t=(e=this.info.fields)!==null&&e!==void 0?e:[];for(const s of t)this.fMap[s.name]=s,this.fMap[s.jsonName]=s,this.fMap[s.localName]=s}}assert(e,t,s){if(!e){let i=ep(s);throw(i=="number"||i=="boolean")&&(i=s.toString()),new Error(`Cannot parse JSON ${i} for ${this.info.typeName}#${t}`)}}read(e,t,s){this.prepare();const i=[];for(const[n,a]of Object.entries(e)){const o=this.fMap[n];if(!o){if(!s.ignoreUnknownFields)throw new Error(`Found unknown field while reading ${this.info.typeName} from JSON format. JSON key: ${n}`);continue}const c=o.localName;let l;if(o.oneof){if(i.includes(o.oneof))throw new Error(`Multiple members of the oneof group "${o.oneof}" of ${this.info.typeName} are present in JSON.`);i.push(o.oneof),l=t[o.oneof]={oneofKind:c}}else l=t;if(o.kind=="map"){if(a===null)continue;this.assert(nD(a),o.name,a);const u=l[c];for(const[h,p]of Object.entries(a)){this.assert(p!==null,o.name+" map value",null);let m;switch(o.V.kind){case"message":m=o.V.T().internalJsonRead(p,s);break;case"enum":if(m=this.enum(o.V.T(),p,o.name,s.ignoreUnknownFields),m===!1)continue;break;case"scalar":m=this.scalar(p,o.V.T,o.V.L,o.name);break}this.assert(m!==void 0,o.name+" map value",p);let v=h;o.K==A.BOOL&&(v=v=="true"?!0:v=="false"?!1:v),v=this.scalar(v,o.K,rs.STRING,o.name).toString(),u[v]=m}}else if(o.repeat){if(a===null)continue;this.assert(Array.isArray(a),o.name,a);const u=l[c];for(const h of a){this.assert(h!==null,o.name,null);let p;switch(o.kind){case"message":p=o.T().internalJsonRead(h,s);break;case"enum":if(p=this.enum(o.T(),h,o.name,s.ignoreUnknownFields),p===!1)continue;break;case"scalar":p=this.scalar(h,o.T,o.L,o.name);break}this.assert(p!==void 0,o.name,a),u.push(p)}}else switch(o.kind){case"message":if(a===null&&o.T().typeName!="google.protobuf.Value"){this.assert(o.oneof===void 0,o.name+" (oneof member)",null);continue}l[c]=o.T().internalJsonRead(a,s,l[c]);break;case"enum":let u=this.enum(o.T(),a,o.name,s.ignoreUnknownFields);if(u===!1)continue;l[c]=u;break;case"scalar":l[c]=this.scalar(a,o.T,o.L,o.name);break}}}enum(e,t,s,i){if(e[0]=="google.protobuf.NullValue"&&we(t===null,`Unable to parse field ${this.info.typeName}#${s}, enum ${e[0]} only accepts null.`),t===null)return 0;switch(typeof t){case"number":return we(Number.isInteger(t),`Unable to parse field ${this.info.typeName}#${s}, enum can only be integral number, got ${t}.`),t;case"string":let n=t;e[2]&&t.substring(0,e[2].length)===e[2]&&(n=t.substring(e[2].length));let a=e[1][n];return typeof a=="undefined"&&i?!1:(we(typeof a=="number",`Unable to parse field ${this.info.typeName}#${s}, enum ${e[0]} has no value for "${t}".`),a)}we(!1,`Unable to parse field ${this.info.typeName}#${s}, cannot parse enum value from ${typeof t}".`)}scalar(e,t,s,i){let n;try{switch(t){case A.DOUBLE:case A.FLOAT:if(e===null)return 0;if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""){n="empty string";break}if(typeof e=="string"&&e.trim().length!==e.length){n="extra whitespace";break}if(typeof e!="string"&&typeof e!="number")break;let a=Number(e);if(Number.isNaN(a)){n="not a number";break}if(!Number.isFinite(a)){n="too large or small";break}return t==A.FLOAT&&sp(a),a;case A.INT32:case A.FIXED32:case A.SFIXED32:case A.SINT32:case A.UINT32:if(e===null)return 0;let o;if(typeof e=="number"?o=e:e===""?n="empty string":typeof e=="string"&&(e.trim().length!==e.length?n="extra whitespace":o=Number(e)),o===void 0)break;return t==A.UINT32?Kd(o):Vo(o),o;case A.INT64:case A.SFIXED64:case A.SINT64:if(e===null)return Ur(Ue.ZERO,s);if(typeof e!="number"&&typeof e!="string")break;return Ur(Ue.from(e),s);case A.FIXED64:case A.UINT64:if(e===null)return Ur(jt.ZERO,s);if(typeof e!="number"&&typeof e!="string")break;return Ur(jt.from(e),s);case A.BOOL:if(e===null)return!1;if(typeof e!="boolean")break;return e;case A.STRING:if(e===null)return"";if(typeof e!="string"){n="extra whitespace";break}try{encodeURIComponent(e)}catch(c){c="invalid UTF8";break}return e;case A.BYTES:if(e===null||e==="")return new Uint8Array(0);if(typeof e!="string")break;return aD(e)}}catch(a){n=a.message}this.assert(!1,i+(n?" - "+n:""),e)}}class PD{constructor(e){var t;this.fields=(t=e.fields)!==null&&t!==void 0?t:[]}write(e,t){const s={},i=e;for(const n of this.fields){if(!n.oneof){let l=this.field(n,i[n.localName],t);l!==void 0&&(s[t.useProtoFieldName?n.name:n.jsonName]=l);continue}const a=i[n.oneof];if(a.oneofKind!==n.localName)continue;const o=n.kind=="scalar"||n.kind=="enum"?Object.assign(Object.assign({},t),{emitDefaultValues:!0}):t;let c=this.field(n,a[n.localName],o);we(c!==void 0),s[t.useProtoFieldName?n.name:n.jsonName]=c}return s}field(e,t,s){let i;if(e.kind=="map"){we(typeof t=="object"&&t!==null);const n={};switch(e.V.kind){case"scalar":for(const[c,l]of Object.entries(t)){const u=this.scalar(e.V.T,l,e.name,!1,!0);we(u!==void 0),n[c.toString()]=u}break;case"message":const a=e.V.T();for(const[c,l]of Object.entries(t)){const u=this.message(a,l,e.name,s);we(u!==void 0),n[c.toString()]=u}break;case"enum":const o=e.V.T();for(const[c,l]of Object.entries(t)){we(l===void 0||typeof l=="number");const u=this.enum(o,l,e.name,!1,!0,s.enumAsInteger);we(u!==void 0),n[c.toString()]=u}break}(s.emitDefaultValues||Object.keys(n).length>0)&&(i=n)}else if(e.repeat){we(Array.isArray(t));const n=[];switch(e.kind){case"scalar":for(let c=0;c<t.length;c++){const l=this.scalar(e.T,t[c],e.name,e.opt,!0);we(l!==void 0),n.push(l)}break;case"enum":const a=e.T();for(let c=0;c<t.length;c++){we(t[c]===void 0||typeof t[c]=="number");const l=this.enum(a,t[c],e.name,e.opt,!0,s.enumAsInteger);we(l!==void 0),n.push(l)}break;case"message":const o=e.T();for(let c=0;c<t.length;c++){const l=this.message(o,t[c],e.name,s);we(l!==void 0),n.push(l)}break}(s.emitDefaultValues||n.length>0||s.emitDefaultValues)&&(i=n)}else switch(e.kind){case"scalar":i=this.scalar(e.T,t,e.name,e.opt,s.emitDefaultValues);break;case"enum":i=this.enum(e.T(),t,e.name,e.opt,s.emitDefaultValues,s.enumAsInteger);break;case"message":i=this.message(e.T(),t,e.name,s);break}return i}enum(e,t,s,i,n,a){if(e[0]=="google.protobuf.NullValue")return null;if(t===void 0){we(i);return}if(!(t===0&&!n&&!i))return we(typeof t=="number"),we(Number.isInteger(t)),a||!e[1].hasOwnProperty(t)?t:e[2]?e[2]+e[1][t]:e[1][t]}message(e,t,s,i){return t===void 0?i.emitDefaultValues?null:void 0:e.internalJsonWrite(t,i)}scalar(e,t,s,i,n){if(t===void 0){we(i);return}const a=n||i;switch(e){case A.INT32:case A.SFIXED32:case A.SINT32:return t===0?a?0:void 0:(Vo(t),t);case A.FIXED32:case A.UINT32:return t===0?a?0:void 0:(Kd(t),t);case A.FLOAT:sp(t);case A.DOUBLE:return t===0?a?0:void 0:(we(typeof t=="number"),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t);case A.STRING:return t===""?a?"":void 0:(we(typeof t=="string"),t);case A.BOOL:return t===!1?a?!1:void 0:(we(typeof t=="boolean"),t);case A.UINT64:case A.FIXED64:we(typeof t=="number"||typeof t=="string"||typeof t=="bigint");let o=jt.from(t);return o.isZero()&&!a?void 0:o.toString();case A.INT64:case A.SFIXED64:case A.SINT64:we(typeof t=="number"||typeof t=="string"||typeof t=="bigint");let c=Ue.from(t);return c.isZero()&&!a?void 0:c.toString();case A.BYTES:return we(t instanceof Uint8Array),t.byteLength?oD(t):a?"":void 0}}}function ip(r,e=rs.STRING){switch(r){case A.BOOL:return!1;case A.UINT64:case A.FIXED64:return Ur(jt.ZERO,e);case A.INT64:case A.SFIXED64:case A.SINT64:return Ur(Ue.ZERO,e);case A.DOUBLE:case A.FLOAT:return 0;case A.BYTES:return new Uint8Array(0);case A.STRING:return"";default:return 0}}class AD{constructor(e){this.info=e}prepare(){var e;if(!this.fieldNoToField){const t=(e=this.info.fields)!==null&&e!==void 0?e:[];this.fieldNoToField=new Map(t.map(s=>[s.no,s]))}}read(e,t,s,i){this.prepare();const n=i===void 0?e.len:e.pos+i;for(;e.pos<n;){const[a,o]=e.tag(),c=this.fieldNoToField.get(a);if(!c){let p=s.readUnknownField;if(p=="throw")throw new Error(`Unknown field ${a} (wire type ${o}) for ${this.info.typeName}`);let m=e.skip(o);p!==!1&&(p===!0?jd.onRead:p)(this.info.typeName,t,a,o,m);continue}let l=t,u=c.repeat,h=c.localName;switch(c.oneof&&(l=l[c.oneof],l.oneofKind!==h&&(l=t[c.oneof]={oneofKind:h})),c.kind){case"scalar":case"enum":let p=c.kind=="enum"?A.INT32:c.T,m=c.kind=="scalar"?c.L:void 0;if(u){let C=l[h];if(o==rt.LengthDelimited&&p!=A.STRING&&p!=A.BYTES){let k=e.uint32()+e.pos;for(;e.pos<k;)C.push(this.scalar(e,p,m))}else C.push(this.scalar(e,p,m))}else l[h]=this.scalar(e,p,m);break;case"message":if(u){let C=l[h],k=c.T().internalBinaryRead(e,e.uint32(),s);C.push(k)}else l[h]=c.T().internalBinaryRead(e,e.uint32(),s,l[h]);break;case"map":let[v,y]=this.mapEntry(c,e,s);l[h][v]=y;break}}}mapEntry(e,t,s){let i=t.uint32(),n=t.pos+i,a,o;for(;t.pos<n;){let[c,l]=t.tag();switch(c){case 1:e.K==A.BOOL?a=t.bool().toString():a=this.scalar(t,e.K,rs.STRING);break;case 2:switch(e.V.kind){case"scalar":o=this.scalar(t,e.V.T,e.V.L);break;case"enum":o=t.int32();break;case"message":o=e.V.T().internalBinaryRead(t,t.uint32(),s);break}break;default:throw new Error(`Unknown field ${c} (wire type ${l}) in map entry for ${this.info.typeName}#${e.name}`)}}if(a===void 0){let c=ip(e.K);a=e.K==A.BOOL?c.toString():c}if(o===void 0)switch(e.V.kind){case"scalar":o=ip(e.V.T,e.V.L);break;case"enum":o=0;break;case"message":o=e.V.T().create();break}return[a,o]}scalar(e,t,s){switch(t){case A.INT32:return e.int32();case A.STRING:return e.string();case A.BOOL:return e.bool();case A.DOUBLE:return e.double();case A.FLOAT:return e.float();case A.INT64:return Ur(e.int64(),s);case A.UINT64:return Ur(e.uint64(),s);case A.FIXED64:return Ur(e.fixed64(),s);case A.FIXED32:return e.fixed32();case A.BYTES:return e.bytes();case A.UINT32:return e.uint32();case A.SFIXED32:return e.sfixed32();case A.SFIXED64:return Ur(e.sfixed64(),s);case A.SINT32:return e.sint32();case A.SINT64:return Ur(e.sint64(),s)}}}class ID{constructor(e){this.info=e}prepare(){if(!this.fields){const e=this.info.fields?this.info.fields.concat():[];this.fields=e.sort((t,s)=>t.no-s.no)}}write(e,t,s){this.prepare();for(const n of this.fields){let a,o,c=n.repeat,l=n.localName;if(n.oneof){const u=e[n.oneof];if(u.oneofKind!==l)continue;a=u[l],o=!0}else a=e[l],o=!1;switch(n.kind){case"scalar":case"enum":let u=n.kind=="enum"?A.INT32:n.T;if(c)if(we(Array.isArray(a)),c==Wd.PACKED)this.packed(t,u,n.no,a);else for(const h of a)this.scalar(t,u,n.no,h,!0);else a===void 0?we(n.opt):this.scalar(t,u,n.no,a,o||n.opt);break;case"message":if(c){we(Array.isArray(a));for(const h of a)this.message(t,s,n.T(),n.no,h)}else this.message(t,s,n.T(),n.no,a);break;case"map":we(typeof a=="object"&&a!==null);for(const[h,p]of Object.entries(a))this.mapEntry(t,s,n,h,p);break}}let i=s.writeUnknownFields;i!==!1&&(i===!0?jd.onWrite:i)(this.info.typeName,e,t)}mapEntry(e,t,s,i,n){e.tag(s.no,rt.LengthDelimited),e.fork();let a=i;switch(s.K){case A.INT32:case A.FIXED32:case A.UINT32:case A.SFIXED32:case A.SINT32:a=Number.parseInt(i);break;case A.BOOL:we(i=="true"||i=="false"),a=i=="true";break}switch(this.scalar(e,s.K,1,a,!0),s.V.kind){case"scalar":this.scalar(e,s.V.T,2,n,!0);break;case"enum":this.scalar(e,A.INT32,2,n,!0);break;case"message":this.message(e,t,s.V.T(),2,n);break}e.join()}message(e,t,s,i,n){n!==void 0&&(s.internalBinaryWrite(n,e.tag(i,rt.LengthDelimited).fork(),t),e.join())}scalar(e,t,s,i,n){let[a,o,c]=this.scalarInfo(t,i);(!c||n)&&(e.tag(s,a),e[o](i))}packed(e,t,s,i){if(!i.length)return;we(t!==A.BYTES&&t!==A.STRING),e.tag(s,rt.LengthDelimited),e.fork();let[,n]=this.scalarInfo(t);for(let a=0;a<i.length;a++)e[n](i[a]);e.join()}scalarInfo(e,t){let s=rt.Varint,i,n=t===void 0,a=t===0;switch(e){case A.INT32:i="int32";break;case A.STRING:a=n||!t.length,s=rt.LengthDelimited,i="string";break;case A.BOOL:a=t===!1,i="bool";break;case A.UINT32:i="uint32";break;case A.DOUBLE:s=rt.Bit64,i="double";break;case A.FLOAT:s=rt.Bit32,i="float";break;case A.INT64:a=n||Ue.from(t).isZero(),i="int64";break;case A.UINT64:a=n||jt.from(t).isZero(),i="uint64";break;case A.FIXED64:a=n||jt.from(t).isZero(),s=rt.Bit64,i="fixed64";break;case A.BYTES:a=n||!t.byteLength,s=rt.LengthDelimited,i="bytes";break;case A.FIXED32:s=rt.Bit32,i="fixed32";break;case A.SFIXED32:s=rt.Bit32,i="sfixed32";break;case A.SFIXED64:a=n||Ue.from(t).isZero(),s=rt.Bit64,i="sfixed64";break;case A.SINT32:i="sint32";break;case A.SINT64:a=n||Ue.from(t).isZero(),i="sint64";break}return[s,i,n||a]}}function kD(r){const e={};Object.defineProperty(e,SD,{enumerable:!1,value:r});for(let t of r.fields){let s=t.localName;if(!t.opt)if(t.oneof)e[t.oneof]={oneofKind:void 0};else if(t.repeat)e[s]=[];else switch(t.kind){case"scalar":e[s]=ip(t.T,t.L);break;case"enum":e[s]=0;break;case"map":e[s]={};break}}return e}function np(r,e,t){let s,i=t,n;for(let a of r.fields){let o=a.localName;if(a.oneof){const c=i[a.oneof];if(c==null)continue;if(s=c[o],n=e[a.oneof],n.oneofKind=c.oneofKind,s==null){delete n[o];continue}}else if(s=i[o],n=e,s==null)continue;switch(a.kind){case"scalar":case"enum":a.repeat?n[o]=s.concat():n[o]=s;break;case"message":let c=a.T();if(a.repeat)for(let l=0;l<s.length;l++)n[o][l]=c.create(s[l]);else n[o]===void 0?n[o]=c.create(s):c.mergePartial(n[o],s);break;case"map":switch(a.V.kind){case"scalar":case"enum":Object.assign(n[o],s);break;case"message":let l=a.V.T();for(let u of Object.keys(s))n[o][u]=l.create(s[u]);break}break}}}function OD(r,e,t){if(e===t)return!0;if(!e||!t)return!1;for(let s of r.fields){let i=s.localName,n=s.oneof?e[s.oneof][i]:e[i],a=s.oneof?t[s.oneof][i]:t[i];switch(s.kind){case"enum":case"scalar":let o=s.kind=="enum"?A.INT32:s.T;if(!(s.repeat?hv(o,n,a):uv(o,n,a)))return!1;break;case"map":if(!(s.V.kind=="message"?pv(s.V.T(),Jd(n),Jd(a)):hv(s.V.kind=="enum"?A.INT32:s.V.T,Jd(n),Jd(a))))return!1;break;case"message":let c=s.T();if(!(s.repeat?pv(c,n,a):c.equals(n,a)))return!1;break}}return!0}const Jd=Object.values;function uv(r,e,t){if(e===t)return!0;if(r!==A.BYTES)return!1;let s=e,i=t;if(s.length!==i.length)return!1;for(let n=0;n<s.length;n++)if(s[n]!=i[n])return!1;return!0}function hv(r,e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!uv(r,e[s],t[s]))return!1;return!0}function pv(r,e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!r.equals(e[s],t[s]))return!1;return!0}class b{constructor(e,t,s){this.defaultCheckDepth=16,this.typeName=e,this.fields=t.map(wD),this.options=s!=null?s:{},this.refTypeCheck=new bD(this),this.refJsonReader=new CD(this),this.refJsonWriter=new PD(this),this.refBinReader=new AD(this),this.refBinWriter=new ID(this)}create(e){let t=kD(this);return e!==void 0&&np(this,t,e),t}clone(e){let t=this.create();return np(this,t,e),t}equals(e,t){return OD(this,e,t)}is(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!1)}isAssignable(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!0)}mergePartial(e,t){np(this,e,t)}fromBinary(e,t){let s=uD(t);return this.internalBinaryRead(s.readerFactory(e),e.byteLength,s)}fromJson(e,t){return this.internalJsonRead(e,ED(t))}fromJsonString(e,t){let s=JSON.parse(e);return this.fromJson(s,t)}toJson(e,t){return this.internalJsonWrite(e,yD(t))}toJsonString(e,t){var s;let i=this.toJson(e,t);return JSON.stringify(i,null,(s=t==null?void 0:t.prettySpaces)!==null&&s!==void 0?s:0)}toBinary(e,t){let s=vD(t);return this.internalBinaryWrite(e,s.writerFactory(),s).finish()}internalJsonRead(e,t,s){if(e!==null&&typeof e=="object"&&!Array.isArray(e)){let i=s!=null?s:this.create();return this.refJsonReader.read(e,i,t),i}throw new Error(`Unable to parse message ${this.typeName} from JSON ${ep(e)}.`)}internalJsonWrite(e,t){return this.refJsonWriter.write(e,t)}internalBinaryWrite(e,t,s){return this.refBinWriter.write(e,t,s),t}internalBinaryRead(e,t,s,i){let n=i!=null?i:this.create();return this.refBinReader.read(e,n,s,t),n}}var ii;(function(r){r[r.PUBLISHER=0]="PUBLISHER",r[r.SUBSCRIBER=1]="SUBSCRIBER"})(ii||(ii={}));var Br;(function(r){r[r.AUDIO=0]="AUDIO",r[r.VIDEO=1]="VIDEO"})(Br||(Br={}));class DD extends b{constructor(){super("media.Pair",[{no:1,name:"key",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:9}])}}new DD;class MD extends b{constructor(){super("media.Codec",[])}}new MD;class ND extends b{constructor(){super("media.Fingerprint",[{no:1,name:"algorithm",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:9}])}}new ND;class LD extends b{constructor(){super("media.SessionDescription",[{no:1,name:"target",kind:"enum",T:()=>["media.Target",ii]},{no:2,name:"type",kind:"scalar",T:9},{no:3,name:"sdp",kind:"scalar",T:9}])}}const ws=new LD;class xD extends b{constructor(){super("media.CreateTransportRequest",[{no:1,name:"consuming",kind:"scalar",T:8},{no:2,name:"force_tcp",kind:"scalar",opt:!0,T:8},{no:3,name:"description",kind:"message",T:()=>ws}])}}const UD=new xD;class BD extends b{constructor(){super("media.CreateTransportResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ws}])}}const zd=new BD;class FD extends b{constructor(){super("media.RenegotiateRequest",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ws}])}}const VD=new FD;class $D extends b{constructor(){super("media.RenegotiateResponse",[{no:1,name:"transport_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ws}])}}new $D;class HD extends b{constructor(){super("media.NestedScore",[{no:1,name:"encoding_idx",kind:"scalar",T:5},{no:2,name:"rid",kind:"scalar",T:9},{no:3,name:"score",kind:"scalar",T:5},{no:4,name:"ssrc",kind:"scalar",T:3,L:0}])}}const jD=new HD;class GD extends b{constructor(){super("media.ProducerTrack",[{no:1,name:"track_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9},{no:3,name:"stream_id",kind:"scalar",T:9}])}}const qD=new GD;class KD extends b{constructor(){super("media.ProducerEntry",[{no:1,name:"producing_transport_id",kind:"scalar",T:9},{no:2,name:"producer_id",kind:"scalar",T:9}])}}new KD;class WD extends b{constructor(){super("media.ConsumerEntry",[{no:1,name:"consuming_transport_id",kind:"scalar",T:9},{no:2,name:"consumer_id",kind:"scalar",T:9}])}}new WD;class JD extends b{constructor(){super("media.ProducerState",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"kind",kind:"enum",T:()=>["media.ProducerKind",Br]},{no:3,name:"pause",kind:"scalar",T:8},{no:4,name:"screen_share",kind:"scalar",T:8}])}}const $o=new JD;class zD extends b{constructor(){super("media.ConsumerState",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>$o},{no:3,name:"producer_track",kind:"message",T:()=>qD}])}}const YD=new zD;class XD extends b{constructor(){super("media.ProducerIdToConsumerMap",[{no:1,name:"map",kind:"map",K:9,V:{kind:"message",T:()=>YD}}])}}const fv=new XD;class QD extends b{constructor(){super("media.edge.PeerJoinRequest",[{no:1,name:"display_name",kind:"scalar",opt:!0,T:9},{no:2,name:"prejoined",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:5,name:"preset",kind:"scalar",opt:!0,T:12},{no:6,name:"user_id",kind:"scalar",opt:!0,T:9},{no:7,name:"organization_id",kind:"scalar",opt:!0,T:9}])}}const ZD=new QD;class eM extends b{constructor(){super("media.edge.PeerJoinCompleteRequest",[])}}const tM=new eM;class rM extends b{constructor(){super("media.edge.PeerLeaveRequest",[{no:1,name:"close_room",kind:"scalar",T:8}])}}const sM=new rM;class iM extends b{constructor(){super("media.edge.ConsumeMultipleProducerRequest",[{no:1,name:"producer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8}])}}new iM;class nM extends b{constructor(){super("media.edge.ConsumePeerRequest",[{no:1,name:"producing_peer_id",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",opt:!0,T:8},{no:3,name:"producer_id",kind:"scalar",opt:!0,T:9}])}}const aM=new nM;class oM extends b{constructor(){super("media.edge.ProducerCreateRequest",[{no:1,name:"kind",kind:"scalar",T:9},{no:2,name:"paused",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8},{no:4,name:"description",kind:"message",T:()=>ws},{no:5,name:"msid",kind:"scalar",T:9}])}}const cM=new oM;class dM extends b{constructor(){super("media.edge.SelectedPeersRequest",[])}}new dM;class lM extends b{constructor(){super("media.edge.GlobalPeerPinningRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const uM=new lM;class hM extends b{constructor(){super("media.edge.ProducerToggleRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}const Yd=new hM;class pM extends b{constructor(){super("media.edge.ConsumerToggleRequest",[{no:1,name:"consumer_id",kind:"scalar",T:9},{no:2,name:"pause",kind:"scalar",T:8}])}}const mv=new pM;class fM extends b{constructor(){super("media.edge.ProducerCloseRequest",[{no:1,name:"producer_id",kind:"scalar",T:9},{no:2,name:"description",kind:"message",T:()=>ws}])}}const mM=new fM;class gM extends b{constructor(){super("media.edge.ConsumerCloseRequest",[{no:1,name:"consumer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"description",kind:"message",T:()=>ws}])}}const _M=new gM;class vM extends b{constructor(){super("media.edge.KickPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const TM=new vM;class EM extends b{constructor(){super("media.edge.KickAllPeersRequest",[])}}const yM=new EM;class SM extends b{constructor(){super("media.edge.PeerDisplayNameEditRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}const wM=new SM;class RM extends b{constructor(){super("media.edge.HostMediaControlForPeerRequest",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"audio",kind:"scalar",T:8},{no:3,name:"video",kind:"scalar",T:8},{no:4,name:"scree_share",kind:"scalar",T:8}])}}const bM=new RM;class CM extends b{constructor(){super("media.edge.HostMediaControlForAllPeerRequest",[{no:1,name:"audio",kind:"scalar",T:8},{no:2,name:"video",kind:"scalar",T:8},{no:3,name:"screen_share",kind:"scalar",T:8}])}}const PM=new CM;class AM extends b{constructor(){super("media.edge.GetRoomStateResponse",[{no:1,name:"display_title",kind:"scalar",T:9},{no:2,name:"locked_mode",kind:"scalar",T:8},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"room_name",kind:"scalar",T:9},{no:5,name:"current_peer_id",kind:"scalar",T:9},{no:6,name:"is_recording",kind:"scalar",opt:!0,T:8},{no:7,name:"recorder_participant_id",kind:"scalar",opt:!0,T:9}])}}const IM=new AM;class kM extends b{constructor(){super("media.edge.ErrorResponse",[{no:1,name:"error_message",kind:"scalar",T:9},{no:2,name:"event_id",kind:"scalar",T:5}])}}const OM=new kM;class DM extends b{constructor(){super("media.edge.EmptyResponse",[])}}new DM;class MM extends b{constructor(){super("media.edge.RoomParticipants",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"producer_states",kind:"message",repeat:1,T:()=>$o},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"user_id",kind:"scalar",opt:!0,T:9}])}}const gv=new MM;class NM extends b{constructor(){super("media.edge.SelectedPeersResponse",[{no:1,name:"audio_peers",kind:"scalar",repeat:2,T:9},{no:2,name:"compulsory_peers",kind:"scalar",repeat:2,T:9}])}}const _v=new NM;class LM extends b{constructor(){super("media.edge.SelectedPeersDiffEntry",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"priority",kind:"scalar",T:5}])}}const xM=new LM;class UM extends b{constructor(){super("media.edge.SelectedPeersDiffResponse",[{no:1,name:"entries",kind:"message",repeat:1,T:()=>xM}])}}const BM=new UM;class FM extends b{constructor(){super("media.edge.PeerJoinResponse",[])}}new FM;class VM extends b{constructor(){super("media.edge.PeerJoinCompleteResponse",[{no:1,name:"room_state",kind:"message",T:()=>IM},{no:2,name:"participants",kind:"message",repeat:1,T:()=>gv},{no:3,name:"selected_peers",kind:"message",T:()=>_v},{no:4,name:"max_preferred_streams",kind:"scalar",T:5}])}}const $M=new VM;class HM extends b{constructor(){super("media.edge.PeerLeaveResponse",[{no:1,name:"closed",kind:"scalar",T:8}])}}const jM=new HM;class GM extends b{constructor(){super("media.edge.ConsumeMultipleProducerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>fv},{no:3,name:"transport_details",kind:"message",T:()=>zd}])}}new GM;class qM extends b{constructor(){super("media.edge.ConsumePeerResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"consumer_ids_map",kind:"message",T:()=>fv},{no:3,name:"transport_details",kind:"message",T:()=>zd}])}}const KM=new qM;class WM extends b{constructor(){super("media.edge.ProducerCreateResponse",[{no:1,name:"status",kind:"scalar",T:8},{no:2,name:"producer_id",kind:"scalar",T:9},{no:3,name:"transport_details",kind:"message",T:()=>zd},{no:4,name:"description",kind:"message",T:()=>ws}])}}const JM=new WM;class zM extends b{constructor(){super("media.edge.ProducerScoreResponse",[{no:1,name:"responseid",kind:"scalar",T:9},{no:2,name:"score",kind:"message",T:()=>jD}])}}new zM;class YM extends b{constructor(){super("media.edge.ActiveSpeakerResponse",[{no:1,name:"responsepeer_id",kind:"scalar",T:9},{no:2,name:"volume",kind:"scalar",T:5}])}}new YM;class XM extends b{constructor(){super("media.edge.NoActiveSpeakerResponse",[])}}new XM;class QM extends b{constructor(){super("media.edge.ProducerToggleResponse",[])}}new QM;class ZM extends b{constructor(){super("media.edge.ConsumerToggleResponse",[])}}new ZM;class eN extends b{constructor(){super("media.edge.ProducerClosingResponse",[{no:1,name:"description",kind:"message",T:()=>ws}])}}const tN=new eN;class rN extends b{constructor(){super("media.edge.ConsumerClosingResponse",[])}}new rN;class sN extends b{constructor(){super("media.edge.GlobalPeerPinningResponse",[])}}new sN;class iN extends b{constructor(){super("media.edge.KickPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const nN=new iN;class aN extends b{constructor(){super("media.edge.KickAllPeersResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const oN=new aN;class cN extends b{constructor(){super("media.edge.HostMediaControlForPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const dN=new cN;class lN extends b{constructor(){super("media.edge.HostMediaControlForAllPeerResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const uN=new lN;class hN extends b{constructor(){super("media.edge.PeerDisplayNameEditResponse",[{no:1,name:"status",kind:"scalar",T:9}])}}const pN=new hN;class fN extends b{constructor(){super("media.edge.PeerJoinBroadcastResponse",[{no:1,name:"participant",kind:"message",T:()=>gv}])}}const mN=new fN;class gN extends b{constructor(){super("media.edge.PeerProducerCreateBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>$o}])}}const _N=new gN;class vN extends b{constructor(){super("media.edge.PeerProducerToggleBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>$o}])}}const TN=new vN;class EN extends b{constructor(){super("media.edge.PeerProducerCloseBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"producer_state",kind:"message",T:()=>$o}])}}const yN=new EN;class SN extends b{constructor(){super("media.edge.PeerLeaveBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const wN=new SN;class RN extends b{constructor(){super("media.edge.GlobalPeerPinningBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const bN=new RN;class CN extends b{constructor(){super("media.edge.RecordingStartedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const PN=new CN;class AN extends b{constructor(){super("media.edge.RecordingStoppedBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9}])}}const IN=new AN;class kN extends b{constructor(){super("media.edge.PeerDisplayNameEditBroadcastResponse",[{no:1,name:"participant_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9}])}}const ON=new kN;class DN extends b{constructor(){super("socket.api.BaseSocketHubMessage",[{no:1,name:"event",kind:"scalar",T:5},{no:2,name:"id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9},{no:4,name:"room_id",kind:"scalar",T:9},{no:5,name:"user_id",kind:"scalar",T:9},{no:6,name:"payload",kind:"scalar",T:12}])}}new DN;class MN extends b{constructor(){super("socket.api.ErrorMessage",[{no:1,name:"code",kind:"scalar",opt:!0,T:5},{no:2,name:"message",kind:"scalar",T:9}])}}const NN=new MN;class LN extends b{constructor(){super("socket.PeerPreset",[{no:1,name:"success",kind:"scalar",T:8},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"message",T:()=>s0}])}}new LN;class xN extends b{constructor(){super("socket.PeerPreset.Plugins",[{no:1,name:"can_close",kind:"scalar",T:8},{no:2,name:"can_start",kind:"scalar",T:8}])}}const UN=new xN;class BN extends b{constructor(){super("socket.PeerPreset.Polls",[{no:1,name:"can_create",kind:"scalar",T:8},{no:2,name:"can_vote",kind:"scalar",T:8},{no:3,name:"can_view",kind:"scalar",T:8}])}}const FN=new BN;class VN extends b{constructor(){super("socket.PeerPreset.Video",[{no:1,name:"allow",kind:"scalar",T:8},{no:2,name:"quality",kind:"scalar",T:9},{no:3,name:"frame_rate",kind:"scalar",T:13}])}}const $N=new VN;class HN extends b{constructor(){super("socket.PeerPreset.Screenshare",[{no:1,name:"allow",kind:"scalar",T:8},{no:2,name:"quality",kind:"scalar",T:9},{no:3,name:"frame_rate",kind:"scalar",T:13}])}}const jN=new HN;class GN extends b{constructor(){super("socket.PeerPreset.Produce",[{no:1,name:"video",kind:"message",T:()=>$N},{no:2,name:"audio",kind:"scalar",T:8},{no:3,name:"screenshare",kind:"message",T:()=>jN}])}}const qN=new GN;class KN extends b{constructor(){super("socket.PeerPreset.Public",[{no:1,name:"can_send",kind:"scalar",T:8},{no:2,name:"text",kind:"scalar",T:8},{no:3,name:"files",kind:"scalar",T:8}])}}const WN=new KN;class JN extends b{constructor(){super("socket.PeerPreset.Private",[{no:1,name:"can_send",kind:"scalar",T:8},{no:2,name:"can_receive",kind:"scalar",T:8},{no:3,name:"text",kind:"scalar",T:8},{no:4,name:"files",kind:"scalar",T:8}])}}const zN=new JN;class YN extends b{constructor(){super("socket.PeerPreset.Chat",[{no:1,name:"public",kind:"message",T:()=>WN},{no:2,name:"private",kind:"message",T:()=>zN}])}}const XN=new YN;class QN extends b{constructor(){super("socket.PeerPreset.Permissions",[{no:1,name:"view_type",kind:"scalar",T:9},{no:2,name:"accept_waiting_requests",kind:"scalar",T:8},{no:3,name:"request_produce",kind:"scalar",T:8},{no:4,name:"can_allow_participant_audio",kind:"scalar",T:8},{no:5,name:"can_allow_participant_screensharing",kind:"scalar",T:8},{no:6,name:"can_allow_participant_video",kind:"scalar",T:8},{no:7,name:"request_kick_participant",kind:"scalar",T:8},{no:8,name:"kick_participant",kind:"scalar",T:8},{no:9,name:"pin_participant",kind:"scalar",T:8},{no:10,name:"can_record",kind:"scalar",T:8},{no:11,name:"waiting_room_type",kind:"scalar",T:9},{no:12,name:"plugins",kind:"message",T:()=>UN},{no:13,name:"polls",kind:"message",T:()=>FN},{no:14,name:"produce",kind:"message",T:()=>qN},{no:15,name:"chat",kind:"message",T:()=>XN},{no:16,name:"reactions",kind:"scalar",T:8},{no:17,name:"hidden_participant",kind:"scalar",T:8},{no:18,name:"show_participant_list",kind:"scalar",T:8},{no:19,name:"can_change_participant_role",kind:"scalar",T:8},{no:20,name:"can_change_theme",kind:"scalar",T:8},{no:21,name:"can_present",kind:"scalar",T:8},{no:22,name:"is_recorder",kind:"scalar",opt:!0,T:8}])}}const ZN=new QN;class e0 extends b{constructor(){super("socket.PeerPreset.Preset",[{no:1,name:"permissions",kind:"message",T:()=>ZN},{no:3,name:"version",kind:"scalar",T:9},{no:4,name:"preset_name",kind:"scalar",T:9}])}}const t0=new e0;class r0 extends b{constructor(){super("socket.PeerPreset.Data",[{no:1,name:"preset",kind:"message",T:()=>t0}])}}const s0=new r0;class i0 extends b{constructor(){super("socket.chat.ChatMessage",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"user_id",kind:"scalar",T:9},{no:4,name:"display_name",kind:"scalar",T:9},{no:5,name:"pinned",kind:"scalar",T:8},{no:6,name:"is_edited",kind:"scalar",T:8},{no:7,name:"payload_type",kind:"scalar",T:5},{no:8,name:"payload",kind:"scalar",T:9},{no:10,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:11,name:"created_at",kind:"scalar",T:4,L:2},{no:12,name:"created_at_ms",kind:"scalar",opt:!0,T:4,L:2},{no:13,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:14,name:"channel_index",kind:"scalar",opt:!0,T:9}])}}const sn=new i0;class n0 extends b{constructor(){super("socket.chat.GetPaginatedChatMessageRoomRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const a0=new n0;class o0 extends b{constructor(){super("socket.chat.GetPaginatedChatMessageRoomResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>sn},{no:2,name:"next",kind:"scalar",T:8}])}}const c0=new o0;class d0 extends b{constructor(){super("socket.chat.GetChatMessagesResponse",[{no:1,name:"messages",kind:"message",repeat:1,T:()=>sn}])}}const vv=new d0;class l0 extends b{constructor(){super("socket.chat.SendChatMessageToRoomRequest",[{no:1,name:"payload_type",kind:"scalar",T:5},{no:2,name:"payload",kind:"scalar",T:9}])}}const u0=new l0;class h0 extends b{constructor(){super("socket.chat.SendChatMessageToRoomResponse",[{no:1,name:"message",kind:"message",T:()=>sn}])}}const ap=new h0;class p0 extends b{constructor(){super("socket.chat.SendChatMessageToPeersRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const f0=new p0;class m0 extends b{constructor(){super("socket.chat.SendChatMessageToPeersResponse",[{no:1,name:"message",kind:"message",T:()=>sn}])}}const op=new m0;class g0 extends b{constructor(){super("socket.chat.SendChatMessageToChannelRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",T:5},{no:3,name:"payload",kind:"scalar",T:9}])}}const _0=new g0;class v0 extends b{constructor(){super("socket.chat.SendChatMessageToChannelResponse",[{no:1,name:"message",kind:"message",T:()=>sn}])}}new v0;class T0 extends b{constructor(){super("socket.chat.EditChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"payload_type",kind:"scalar",opt:!0,T:5},{no:3,name:"payload",kind:"scalar",opt:!0,T:9},{no:4,name:"pinned",kind:"scalar",opt:!0,T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const E0=new T0;class y0 extends b{constructor(){super("socket.chat.EditChatMessageResponse",[{no:1,name:"message",kind:"message",T:()=>sn}])}}const Xd=new y0;class S0 extends b{constructor(){super("socket.chat.DeleteChatMessageRequest",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const w0=new S0;class R0 extends b{constructor(){super("socket.chat.DeleteChatMessageResponse",[{no:1,name:"chat_id",kind:"scalar",T:9},{no:2,name:"channel_id",kind:"scalar",opt:!0,T:9}])}}const Qd=new R0;class b0 extends b{constructor(){super("socket.chat.SearchChatMessagesRequest",[{no:1,name:"time_stamp",kind:"scalar",T:4,L:2},{no:2,name:"size",kind:"scalar",T:5},{no:3,name:"from",kind:"scalar",T:5},{no:4,name:"reversed",kind:"scalar",T:8},{no:5,name:"channel_id",kind:"scalar",opt:!0,T:9},{no:6,name:"search_term",kind:"scalar",T:9}])}}const C0=new b0;class P0 extends b{constructor(){super("socket.chat.MarkChannelIndexAsReadRequest",[{no:1,name:"channel_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"channel_index",kind:"scalar",T:9}])}}const A0=new P0;class I0 extends b{constructor(){super("socket.chat.MarkChannelIndexAsReadResponse",[{no:1,name:"channel_index",kind:"scalar",T:9}])}}const k0=new I0;class O0 extends b{constructor(){super("socket.chat.CreateChatChannelRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8}])}}const D0=new O0;class M0 extends b{constructor(){super("socket.chat.UpdateChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"target_user_ids",kind:"scalar",repeat:2,T:9},{no:4,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:5,name:"visibility",kind:"scalar",opt:!0,T:9},{no:6,name:"is_direct_message",kind:"scalar",opt:!0,T:8}])}}const N0=new M0;class L0 extends b{constructor(){super("socket.chat.CreateChatChannelResponse",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}new L0;class x0 extends b{constructor(){super("socket.chat.GetChatChannelRequest",[{no:1,name:"chat_channel_id",kind:"scalar",T:9}])}}const U0=new x0;class B0 extends b{constructor(){super("socket.chat.LatestMessageAndUnreadCount",[{no:1,name:"message",kind:"message",T:()=>sn},{no:2,name:"unread_count",kind:"scalar",T:4,L:2}])}}const F0=new B0;class V0 extends b{constructor(){super("socket.chat.ChatChannel",[{no:1,name:"chat_channel_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",T:9},{no:3,name:"display_picture_url",kind:"scalar",opt:!0,T:9},{no:4,name:"visibility",kind:"scalar",T:9},{no:5,name:"is_direct_message",kind:"scalar",T:8},{no:6,name:"latest_message_and_unread_count",kind:"message",T:()=>F0},{no:7,name:"target_user_ids",kind:"scalar",repeat:2,T:9}])}}const $0=new V0;class H0 extends b{constructor(){super("socket.chat.GetChatChannelResponse",[{no:1,name:"chat_channels",kind:"message",repeat:1,T:()=>$0}])}}const Rs=new H0;class j0 extends b{constructor(){super("socket.chat.ChannelMember",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const G0=new j0;class q0 extends b{constructor(){super("socket.chat.GetChatChannelMembersResponse",[{no:1,name:"channel_members",kind:"message",repeat:1,T:()=>G0}])}}const K0=new q0;var nn;(function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.ON_STAGE=1]="ON_STAGE",r[r.APPROVED_STAGE=2]="APPROVED_STAGE",r[r.REQUESTED_STAGE=3]="REQUESTED_STAGE",r[r.OFF_STAGE=4]="OFF_STAGE"})(nn||(nn={}));var Zd;(function(r){r[r.HIVE=0]="HIVE",r[r.CHAT=1]="CHAT",r[r.PING=2]="PING"})(Zd||(Zd={}));class W0 extends b{constructor(){super("socket.room.Peer",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"display_name",kind:"scalar",T:9},{no:4,name:"stage_type",kind:"enum",opt:!0,T:()=>["socket.room.StageType",nn,"STAGE_TYPE_"]},{no:5,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:6,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:7,name:"display_picture_url",kind:"scalar",opt:!0,T:9}])}}const el=new W0;class J0 extends b{constructor(){super("socket.room.PeerInfoResponse",[{no:1,name:"peer",kind:"message",T:()=>el}])}}const tl=new J0;class z0 extends b{constructor(){super("socket.room.RoomPeersInfoResponse",[{no:1,name:"peers",kind:"message",repeat:1,T:()=>el}])}}new z0;class Y0 extends b{constructor(){super("socket.room.RoomPeerCountResponse",[{no:1,name:"count",kind:"scalar",T:4,L:2}])}}const Tv=new Y0;class X0 extends b{constructor(){super("socket.room.Room",[{no:1,name:"room_id",kind:"scalar",T:9},{no:2,name:"title",kind:"scalar",T:9},{no:4,name:"created_at",kind:"scalar",T:4,L:2}])}}const Ev=new X0;class Q0 extends b{constructor(){super("socket.room.RoomInfoResponse",[{no:1,name:"room",kind:"message",T:()=>Ev}])}}const yv=new Q0;class Z0 extends b{constructor(){super("socket.room.GetPeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9}])}}new Z0;class eL extends b{constructor(){super("socket.room.UpdatePeerInfoRequest",[{no:1,name:"peer_id",kind:"scalar",T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9}])}}new eL;class tL extends b{constructor(){super("socket.room.JoinRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>el},{no:3,name:"room_uuid",kind:"scalar",T:9},{no:4,name:"organization_id",kind:"scalar",opt:!0,T:9},{no:5,name:"use_hive",kind:"scalar",opt:!0,T:8},{no:6,name:"preset",kind:"scalar",opt:!0,T:12},{no:7,name:"capabilities",kind:"enum",repeat:1,T:()=>["socket.room.Capabilities",Zd,"CAPABILITIES_"]}])}}const rL=new tL;class sL extends b{constructor(){super("socket.room.LeaveRoomRequest",[{no:1,name:"peer",kind:"message",T:()=>el}])}}const iL=new sL;class nL extends b{constructor(){super("socket.room.UpdateRoomInfoRequest",[{no:1,name:"room",kind:"message",T:()=>Ev}])}}new nL;class aL extends b{constructor(){super("socket.room.GetConnectedRoomsDumpRequest",[])}}new aL;class oL extends b{constructor(){super("socket.room.ServiceError",[{no:1,name:"message",kind:"scalar",opt:!0,T:9},{no:2,name:"code",kind:"scalar",opt:!0,T:9}])}}const cp=new oL;class cL extends b{constructor(){super("socket.room.ConnectedMeetingPeer",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"display_name",kind:"scalar",opt:!0,T:9},{no:3,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:4,name:"preset_id",kind:"scalar",opt:!0,T:9},{no:5,name:"display_picture_url",kind:"scalar",opt:!0,T:9}])}}const dL=new cL;class lL extends b{constructor(){super("socket.room.ConnectedMeetingDump",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>dL}])}}const Sv=new lL;class uL extends b{constructor(){super("socket.room.GetConnectedRoomsDumpResponse",[{no:1,name:"parent_meeting",kind:"message",T:()=>Sv},{no:2,name:"meetings",kind:"message",repeat:1,T:()=>Sv}])}}const hL=new uL;class pL extends b{constructor(){super("socket.room.CreateRoomRequestPayload",[{no:1,name:"title",kind:"scalar",opt:!0,T:9}])}}const fL=new pL;class mL extends b{constructor(){super("socket.room.CreateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>fL}])}}const gL=new mL;class _L extends b{constructor(){super("socket.room.CreateRoomResponsePayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>cp}])}}const vL=new _L;class TL extends b{constructor(){super("socket.room.CreateConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>vL}])}}const wv=new TL;class EL extends b{constructor(){super("socket.room.UpdateRoomRequestPayload",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"title",kind:"scalar",opt:!0,T:9}])}}const yL=new EL;class SL extends b{constructor(){super("socket.room.UpdateConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>yL}])}}new SL;class wL extends b{constructor(){super("socket.room.DisableRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9}])}}const RL=new wL;class bL extends b{constructor(){super("socket.room.DisableConnectedRoomsRequest",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>RL}])}}const CL=new bL;class PL extends b{constructor(){super("socket.room.DisableConnectedRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>kL}])}}const AL=new PL;class IL extends b{constructor(){super("socket.room.DisableConnectedRoomPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9},{no:2,name:"status",kind:"scalar",opt:!0,T:9},{no:3,name:"title",kind:"scalar",opt:!0,T:9},{no:4,name:"error",kind:"message",T:()=>cp}])}}const kL=new IL;class OL extends b{constructor(){super("socket.room.MovePeerPayload",[{no:1,name:"id",kind:"scalar",opt:!0,T:9}])}}const DL=new OL;class ML extends b{constructor(){super("socket.room.MovePeersBetweenRoomsRequest",[{no:1,name:"source_meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"destination_meeting_id",kind:"scalar",opt:!0,T:9},{no:3,name:"participants",kind:"message",repeat:1,T:()=>DL}])}}const NL=new ML;class LL extends b{constructor(){super("socket.room.MovedPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"custom_participant_id",kind:"scalar",opt:!0,T:9},{no:3,name:"error",kind:"message",T:()=>cp}])}}const Rv=new LL;class xL extends b{constructor(){super("socket.room.MovePeersBetweenRoomsResponse",[{no:1,name:"payloads",kind:"message",repeat:1,T:()=>Rv}])}}new xL;class UL extends b{constructor(){super("socket.room.TransferPeer",[{no:1,name:"meeting_id",kind:"scalar",opt:!0,T:9},{no:2,name:"auth_token",kind:"scalar",opt:!0,T:9}])}}const BL=new UL;class FL extends b{constructor(){super("socket.room.GetAllAddedParticipantsResponse",[{no:1,name:"participants",kind:"message",repeat:1,T:()=>HL}])}}const VL=new FL;class $L extends b{constructor(){super("socket.room.AddedParticipant",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",opt:!0,T:9},{no:3,name:"picture",kind:"scalar",opt:!0,T:9},{no:4,name:"custom_participant_id",kind:"scalar",T:9}])}}const HL=new $L;class jL extends b{constructor(){super("socket.room.RemoveParticipantsRequest",[{no:1,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const GL=new jL;class qL extends b{constructor(){super("socket.room.BroadcastMessage",[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"timestamp",kind:"scalar",T:4,L:2},{no:4,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const bv=new qL;class KL extends b{constructor(){super("socket.plugin.AddPluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const WL=new KL;class JL extends b{constructor(){super("socket.plugin.RemovePluginRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"staggered",kind:"scalar",T:8}])}}const zL=new JL;class YL extends b{constructor(){super("socket.plugin.EnablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const XL=new YL;class QL extends b{constructor(){super("socket.plugin.DisablePluginForRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9}])}}const ZL=new QL;class e1 extends b{constructor(){super("socket.plugin.EnablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const t1=new e1;class r1 extends b{constructor(){super("socket.plugin.DisablePluginForPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9}])}}const s1=new r1;class i1 extends b{constructor(){super("socket.plugin.PluginEventToRoomRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const n1=new i1;class a1 extends b{constructor(){super("socket.plugin.PluginEventToPeersRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"peer_ids",kind:"scalar",repeat:2,T:9},{no:3,name:"plugin_data",kind:"scalar",T:12}])}}const o1=new a1;class c1 extends b{constructor(){super("socket.plugin.StoreKeys",[{no:1,name:"store_key",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",opt:!0,T:12}])}}const dp=new c1;class d1 extends b{constructor(){super("socket.plugin.PluginStoreInsertKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"insert_keys",kind:"message",repeat:1,T:()=>dp}])}}const Cv=new d1;class l1 extends b{constructor(){super("socket.plugin.PluginStoreGetKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"get_keys",kind:"message",repeat:1,T:()=>dp}])}}const u1=new l1;class h1 extends b{constructor(){super("socket.plugin.PluginStoreDeleteKeysRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"delete_keys",kind:"message",repeat:1,T:()=>dp}])}}const p1=new h1;class f1 extends b{constructor(){super("socket.plugin.PluginStoreDeleteRequest",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9}])}}const m1=new f1;class g1 extends b{constructor(){super("socket.plugin.EnablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"enabled_by",kind:"scalar",T:9}])}}const lp=new g1;class _1 extends b{constructor(){super("socket.plugin.EnablePluginsResponse",[{no:1,name:"plugins",kind:"message",repeat:1,T:()=>lp}])}}const v1=new _1;class T1 extends b{constructor(){super("socket.plugin.DisablePluginResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"disabled_by",kind:"scalar",T:9}])}}const Pv=new T1;class E1 extends b{constructor(){super("socket.plugin.PluginStoreItem",[{no:1,name:"timestamp",kind:"scalar",T:9},{no:2,name:"peer_id",kind:"scalar",T:9},{no:3,name:"store_key",kind:"scalar",T:9},{no:4,name:"payload",kind:"scalar",T:12}])}}const y1=new E1;class S1 extends b{constructor(){super("socket.plugin.PluginStoreResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"store_name",kind:"scalar",T:9},{no:3,name:"store_items",kind:"message",repeat:1,T:()=>y1}])}}const Av=new S1;class w1 extends b{constructor(){super("socket.plugin.PluginEventResponse",[{no:1,name:"plugin_id",kind:"scalar",T:9},{no:2,name:"plugin_data",kind:"scalar",T:12}])}}const Iv=new w1;class R1 extends b{constructor(){super("socket.livestreaming.LiveStreamingEvent",[{no:1,name:"livestream_id",kind:"scalar",T:9},{no:2,name:"err_message",kind:"scalar",T:9},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"meeting_id",kind:"scalar",T:9},{no:5,name:"playback_url",kind:"scalar",T:9},{no:6,name:"org_id",kind:"scalar",T:9},{no:7,name:"room_name",kind:"scalar",T:9},{no:8,name:"room_uuid",kind:"scalar",T:9},{no:9,name:"status",kind:"scalar",T:9}])}}const kv=new R1;class b1 extends b{constructor(){super("socket.livestreaming.GetStagePeersResponse",[{no:1,name:"stage_peers",kind:"scalar",repeat:2,T:9}])}}const Ov=new b1;class C1 extends b{constructor(){super("socket.livestreaming.StageRequest",[{no:1,name:"display_name",kind:"scalar",T:9},{no:2,name:"user_id",kind:"scalar",T:9},{no:3,name:"peer_id",kind:"scalar",T:9}])}}const P1=new C1;class A1 extends b{constructor(){super("socket.livestreaming.GetStageRequestsResponse",[{no:1,name:"stage_requests",kind:"message",repeat:1,T:()=>P1}])}}const up=new A1;class I1 extends b{constructor(){super("socket.livestreaming.GrantStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const k1=new I1;class O1 extends b{constructor(){super("socket.livestreaming.DenyStageAccessRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const D1=new O1;class M1 extends b{constructor(){super("socket.livestreaming.LeaveStageRequest",[{no:1,name:"user_ids",kind:"scalar",repeat:2,T:9}])}}const Dv=new M1;class N1 extends b{constructor(){super("socket.polls.Poll",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"created_by",kind:"scalar",T:9},{no:3,name:"created_by_user_id",kind:"scalar",T:9},{no:4,name:"question",kind:"scalar",T:9},{no:5,name:"options",kind:"message",repeat:1,T:()=>x1},{no:6,name:"hide_votes",kind:"scalar",T:8},{no:7,name:"anonymous",kind:"scalar",T:8},{no:8,name:"votes",kind:"scalar",repeat:2,T:9}])}}const Mv=new N1;class L1 extends b{constructor(){super("socket.polls.PollOption",[{no:1,name:"text",kind:"scalar",T:9},{no:2,name:"count",kind:"scalar",opt:!0,T:4,L:2},{no:3,name:"votes",kind:"message",repeat:1,T:()=>B1}])}}const x1=new L1;class U1 extends b{constructor(){super("socket.polls.PollVote",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9}])}}const B1=new U1;class F1 extends b{constructor(){super("socket.polls.NewPollRequest",[{no:1,name:"question",kind:"scalar",T:9},{no:2,name:"options",kind:"scalar",repeat:2,T:9},{no:3,name:"anonymous",kind:"scalar",T:8},{no:4,name:"hide_votes",kind:"scalar",T:8},{no:5,name:"created_by",kind:"scalar",opt:!0,T:9},{no:6,name:"created_by_user_id",kind:"scalar",opt:!0,T:9}])}}const V1=new F1;class $1 extends b{constructor(){super("socket.polls.VotePollRequest",[{no:1,name:"poll_id",kind:"scalar",T:9},{no:2,name:"index",kind:"scalar",T:4,L:2}])}}const H1=new $1;class j1 extends b{constructor(){super("socket.polls.UpdatePollResponse",[{no:1,name:"poll",kind:"message",T:()=>Mv}])}}const hp=new j1;class G1 extends b{constructor(){super("socket.polls.GetPollsResponse",[{no:1,name:"polls",kind:"message",repeat:1,T:()=>Mv}])}}const q1=new G1;var pp;(function(r){r[r.ACTION=0]="ACTION",r[r.RESPONSE=1]="RESPONSE",r[r.EVENT=2]="EVENT"})(pp||(pp={}));var fp;(function(r){r[r.SERVICE_NOT_FOUND=0]="SERVICE_NOT_FOUND",r[r.PARAMETER_VALIDATION_ERROR=1]="PARAMETER_VALIDATION_ERROR",r[r.TIMEOUT_ERROR=2]="TIMEOUT_ERROR",r[r.APPLICATION_ERROR=3]="APPLICATION_ERROR"})(fp||(fp={}));class K1 extends b{constructor(){super("bridge.BridgeMessage",[{no:1,name:"type",kind:"enum",T:()=>["bridge.BridgeMessageType",pp]},{no:2,name:"action",kind:"message",oneof:"data",T:()=>J1},{no:3,name:"response",kind:"message",oneof:"data",T:()=>Y1},{no:4,name:"event",kind:"message",oneof:"data",T:()=>ex}])}}new K1;class W1 extends b{constructor(){super("bridge.BridgeAction",[{no:1,name:"action",kind:"scalar",T:9},{no:2,name:"params",kind:"scalar",T:9}])}}const J1=new W1;class z1 extends b{constructor(){super("bridge.BridgeResponse",[{no:1,name:"success",kind:"scalar",T:8},{no:2,name:"response",kind:"scalar",T:9},{no:3,name:"error",kind:"message",T:()=>Q1}])}}const Y1=new z1;class X1 extends b{constructor(){super("bridge.BridgeError",[{no:1,name:"type",kind:"enum",T:()=>["bridge.ErrorType",fp]},{no:2,name:"message",kind:"scalar",T:9}])}}const Q1=new X1;class Z1 extends b{constructor(){super("bridge.BridgeEvent",[{no:1,name:"event",kind:"scalar",T:9},{no:2,name:"params",kind:"scalar",T:9}])}}const ex=new Z1;class tx extends b{constructor(){super("google.protobuf.Timestamp",[{no:1,name:"seconds",kind:"scalar",T:3,L:0},{no:2,name:"nanos",kind:"scalar",T:5}])}now(){const e=this.create(),t=Date.now();return e.seconds=Ue.from(Math.floor(t/1e3)).toBigInt(),e.nanos=t%1e3*1e6,e}toDate(e){return new Date(Ue.from(e.seconds).toNumber()*1e3+Math.ceil(e.nanos/1e6))}fromDate(e){const t=this.create(),s=e.getTime();return t.seconds=Ue.from(Math.floor(s/1e3)).toBigInt(),t.nanos=s%1e3*1e6,t}internalJsonWrite(e,t){let s=Ue.from(e.seconds).toNumber()*1e3;if(s<Date.parse("0001-01-01T00:00:00Z")||s>Date.parse("9999-12-31T23:59:59Z"))throw new Error("Unable to encode Timestamp to JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");if(e.nanos<0)throw new Error("Unable to encode invalid Timestamp to JSON. Nanos must not be negative.");let i="Z";if(e.nanos>0){let n=(e.nanos+1e9).toString().substring(1);n.substring(3)==="000000"?i="."+n.substring(0,3)+"Z":n.substring(6)==="000"?i="."+n.substring(0,6)+"Z":i="."+n+"Z"}return new Date(s).toISOString().replace(".000Z",i)}internalJsonRead(e,t,s){if(typeof e!="string")throw new Error("Unable to parse Timestamp from JSON "+ep(e)+".");let i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("Unable to parse Timestamp from JSON. Invalid format.");let n=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(n))throw new Error("Unable to parse Timestamp from JSON. Invalid value.");if(n<Date.parse("0001-01-01T00:00:00Z")||n>Date.parse("9999-12-31T23:59:59Z"))throw new globalThis.Error("Unable to parse Timestamp from JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");return s||(s=this.create()),s.seconds=Ue.from(n/1e3).toBigInt(),s.nanos=0,i[7]&&(s.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),s}}new tx;var an={},rl={},rx=zs&&zs.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(rl,"__esModule",{value:!0}),rl.Logger=void 0;const _a=rx(Tr),va="awaitqueue";let sx=class{constructor(e){e?(this._debug=(0,_a.default)(`${va}:${e}`),this._warn=(0,_a.default)(`${va}:WARN:${e}`),this._error=(0,_a.default)(`${va}:ERROR:${e}`)):(this._debug=(0,_a.default)(va),this._warn=(0,_a.default)(`${va}:WARN`),this._error=(0,_a.default)(`${va}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};rl.Logger=sx,Object.defineProperty(an,"__esModule",{value:!0});var sl=an.AwaitQueue=an.AwaitQueueRemovedTaskError=an.AwaitQueueStoppedError=void 0;const ix=rl,ni=new ix.Logger;class il extends Error{constructor(e){super(e!=null?e:"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,il)}}an.AwaitQueueStoppedError=il;class nl extends Error{constructor(e){super(e!=null?e:"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,nl)}}an.AwaitQueueRemovedTaskError=nl;class nx{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(e,t){if(t=t!=null?t:e.name,ni.debug(`push() [name:${t}]`),typeof e!="function")throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch(s){}return new Promise((s,i)=>{const n={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),ni.debug(`resolving task [name:${n.name}]`),s(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),ni.debug(`rejecting task [name:${n.name}]: %s`,String(a)),i(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){ni.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())ni.debug(`stop() | stopping task [name:${e.name}]`),e.reject(new il);this.stopping=!1}remove(e){ni.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];if(!t){ni.debug(`stop() | no task with given idx [taskIdx:${e}]`);return}t.reject(new nl)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map(s=>({idx:t++,task:s.task,name:s.name,enqueuedTime:s.executedAt?s.executedAt-s.enqueuedAt:e-s.enqueuedAt,executionTime:s.executedAt?e-s.executedAt:0}))}async execute(e){if(ni.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=await e.task();e.resolve(t)}catch(t){e.reject(t)}}}sl=an.AwaitQueue=nx;const ax=3,ox=30,cx=8e3;class dx{constructor(e){f(this,"ipInfo");f(this,"axios");f(this,"requests");f(this,"roomName");f(this,"roomUUID");f(this,"peerId");f(this,"authToken");f(this,"organizationId");const{timeout:t=cx,retry:s=ax,retryDelay:i=ox,baseURL:n="https://api.cluster.dyte.in",authToken:a}=e||{};this.requests=nd.create({baseURL:n,responseType:"json",timeout:t,retry:s,retryDelay:i}),this.axios=nd,this.setAuthToken(a,{bearer:!0}),this.requests.interceptors.request.use(o=>(_.injectContext(this.requests.defaults.headers.common),o),async o=>{g.error("xhr::axios",{debuggingHint:"otelRequestInterceptor failed.",error:o})}),this.requests.interceptors.response.use(o=>{try{o.config.url!==_.logsEndpoint&&g.debug("xhr::axios",{networkCall:{status:o.status,statusText:o.statusText,baseURL:o.config.baseURL,url:o.config.url,method:o.config.method}})}catch(c){console.error("xhr::dyte",{error:"responseInterceptorFailed",err:c,response:o})}return o},async o=>{var c;try{if(!o)return Promise.reject(new Error("Unknown error occurred"));o&&o.config&&((c=o.config)==null?void 0:c.url)!==_.logsEndpoint&&g.error("xhr::axios",{error:o,networkCall:{status:o.status,statusText:o.statusText,baseURL:o.config.baseURL,url:o.config.url,retries:o.config.retry,method:o.config.method,isOnline:navigator.onLine?"online":"offline"}});const{config:l,message:u}=o;return l&&u&&l.retry!==void 0&&l.retry>0&&(u.includes("timeout")||u.includes("Network Error"))?(l.retry-=1,l.baseURL==="https://api.cluster.dyte.in"?l.baseURL="https://network2.dyte.io":l.baseURL==="https://network2.dyte.io"&&(l.baseURL="https://api.cluster.dyte.in"),this.requests(l)):Promise.reject(o)}catch(l){return console.error("xhr::dyte",{error:"responseInterceptorFailed",err:l,responseError:o}),Promise.reject(l)}})}setAuthToken(e,t){const{bearer:s}=t||{};this.authToken=e,this.requests.defaults.headers.common.Authorization=s?`Bearer ${e}`:e}setHeader(e,t){this.requests.defaults.headers.common[e]=t}setRoomName(e){this.roomName=e}setRoomUUID(e){this.roomUUID=e}setPeerId(e){this.peerId=e}setOrganizationId(e){this.organizationId=e}}var lx=Object.defineProperty,ux=Object.getOwnPropertyDescriptor,Nv=(r,e,t,s)=>{for(var i=s>1?void 0:s?ux(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&lx(e,t,i),i};class al extends dx{constructor(e){super(e),this.setHeader("x-dyte-web-core-version",ca)}async getIPDetails({peerId:e}){var t;try{const i=(await this.requests.get("https://media-location.dyte.io")).data;if(((t=i.loc)==null?void 0:t.length)>5)return i;throw Error("Insufficient data")}catch(s){g.error("getIPDetails::failed")}try{const s=await gu.getIPDetails({peerId:e});return g.info("gotIPDetails",{networkCall:{ip:s.ip,timezone:s.timezone}}),s}catch(s){g.warn("ApiClient.getRoomNodeLinkAndTitleV1 Failed to get ip details",{error:{name:s.name,message:s.message}});return}}async getICEServers(){const{success:e,iceServers:t}=(await this.requests.get("/iceservers")).data;if(e)return t}async getPlugins(e){var n,a,o,c,l,u,h;let{plugins:t}=(await this.requests.get("/v2/plugins/user")).data.data;const s=((a=(n=x.getValue(U.V1_PLUGINS))==null?void 0:n.toString())==null?void 0:a.split(","))||[],i=t.reduce((p,m)=>(p[s.includes(m.id)?"v1":"v2"].push(m),p),{v1:[],v2:[]});return e?t=i.v2:t=i.v1,(l=(c=(o=_e.modules)==null?void 0:o.devTools)==null?void 0:c.plugins)!=null&&l.length&&((h=(u=_e.modules)==null?void 0:u.devTools)==null||h.plugins.forEach(p=>{var v,y,C;const m={...Fo,tags:[...Fo.tags]};m.baseURL=`http://localhost:${p.port}`,m.name=p.name,m.picture=(v=p.picture)!=null?v:Fo.picture,m.description=(y=p.description)!=null?y:Fo.description,m.staggered=(C=p.staggered)!=null?C:Fo.staggered,m.createdAt=new Date().toISOString(),m.updatedAt=new Date().toISOString(),m.id=p.id,m.organizationId=this.organizationId,t.push(m)})),t}async getPluginDetails(e){const{plugin:t}=(await this.requests.get(`/v2/plugins/view/${e}`)).data.data;return t}async getPluginConfig(e){return(await this.axios.get(`${e}/dyte-config.json`)).data}async authorizePlugin(e){const t={peerId:this.peerId};re.isV2AuthToken||(t.roomName=this.roomName);const{token:s}=(await this.requests.post(`/v2/plugins/authorize/${e}`,t)).data.data;return s}async getPresignedUrls(e,t){const s={roomUUID:this.roomUUID,filename:e};x.hasFeature(U.FEAT_CHAT_SDK)&&(s.viewType=t);const{getLocation:i,putLocation:n}=(await this.requests.post("/v1/meetings/genPreSignedUploadUrl",s)).data.data;return{getLocation:i,putLocation:n}}async uploadFile(e,t){if(navigator.isReactNative&&"uri"in e)try{await fetch(t,{method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:{uri:e.uri,name:e.name}})}catch(s){g.error(`sendFileMessage::${s}`)}else await this.axios.put(t,e,{headers:{"Content-Type":e.type}})}}Nv([_.trace("APIClient.getIPDetails")],al.prototype,"getIPDetails",1),Nv([_.trace("APIClient.getICEServers")],al.prototype,"getICEServers",1);var hx=Object.defineProperty,px=Object.getOwnPropertyDescriptor,Ta=(r,e,t,s)=>{for(var i=s>1?void 0:s?px(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&hx(e,t,i),i};class on extends al{async startLivestreaming(){var t,s;return(s=(t=(await this.requests.post(`/v2/meetings/${re.meetingId}/livestreams`)).data)==null?void 0:t.data)==null?void 0:s.playback_url}async stopLivestreaming(){return this.requests.post(`/v2/meetings/${re.meetingId}/active-livestream/stop`)}async getActiveLivestream(){const{playbackUrl:e,status:t}=Sr((await this.requests.get(`/v2/meetings/${re.meetingId}/active-livestream`)).data.data);return{status:t,playbackUrl:e}}async getUserDetails(){const e=(await this.requests.get("v2/internals/participant-details")).data.data;return Sr(e)}getUserPreset(){throw new Error("getUserPreset does not exist for v2")}async startRecording(e){return(await this.requests.post("/v2/recordings",{...Zg(e),meeting_id:re.meetingId})).data.id}stopRecording(e){return this.requests.put(`v2/recordings/${e}`,{action:"stop"})}async getActiveRecording(){const{status:e,id:t}=(await this.requests.get(`v2/recordings/active-recording/${re.meetingId}`)).data.data;return{status:e,id:t}}async getRoomNodeData({peerId:e}){const t=await this.getIPDetails({peerId:e});this.ipInfo=t;const{roomNodeLink:s,title:i,useHiveMedia:n}=Sr((await this.requests.post("v2/internals/rooms",{ip_information:t})).data.data);return{roomNodeUrl:s,meetingTitle:i,useHiveMedia:n!=null?n:!1}}}Ta([_.trace("APIClient.getUserDetails")],on.prototype,"getUserDetails",1),Ta([_.trace("APIClient.getUserPreset")],on.prototype,"getUserPreset",1),Ta([_.trace("APIClient.startRecording")],on.prototype,"startRecording",1),Ta([_.trace("APIClient.stopRecording")],on.prototype,"stopRecording",1),Ta([_.trace("APIClient.getActiveRecording")],on.prototype,"getActiveRecording",1),Ta([_.trace("APIClient.getRoomNodeData")],on.prototype,"getRoomNodeData",1);var fx=Object.defineProperty,mx=Object.getOwnPropertyDescriptor,Ea=(r,e,t,s)=>{for(var i=s>1?void 0:s?mx(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&fx(e,t,i),i};class cn extends al{startLivestreaming(){throw new Error("Method not implemented.")}stopLivestreaming(){throw new Error("Method not implemented.")}getActiveLivestream(){throw new Error("Method not implemented.")}async getUserDetails(){const{user:e}=(await this.requests.get("/auth/basicUserDetails")).data;return e}async getUserPreset(e){const{preset:t}=(await this.requests.post("/v1/userpreset",{roomName:e,authToken:this.authToken,clientType:"CLIENT_APP",version:"0.5.0"})).data.data;return Sr(t)}async startRecording(e){const t=await this.requests.post(`/v1/organizations/${this.organizationId}/rooms/${this.roomName}/recording`,e);if(t.status!==201)throw new Error("Recording failed to start");return t.data.data.recording.id}async stopRecording(e){if((await this.requests.put(`/v1/organizations/${this.organizationId}/rooms/${this.roomName}/recordings/${e}`,{recordingAction:"stop"})).status!==201)throw new Error("Recording failed to stop")}async getActiveRecording(){return this.organizationId?(await this.requests.get(`/v1/organizations/${this.organizationId}/rooms/${this.roomName}/active-recording?limit=50`)).data.data.recording:{}}async getRoomNodeData({roomName:e,peerId:t}){const s=`
				query Session($roomName: String!, $password: String, $ipInformation: String) {
						session(roomName: $roomName, password: $password) {
							title,
							roomNodeLink(ipInformation: $ipInformation),
							useHiveMedia,
							roomName,
							password
						}
					}
				`,i=await this.getIPDetails({peerId:t});this.ipInfo=i;const{roomNodeLink:n,title:a,useHiveMedia:o}=(await this.requests.post("/graphql",{query:s,variables:{roomName:e,ipInformation:JSON.stringify(i)}})).data.data.session;return{roomNodeUrl:n,meetingTitle:a,useHiveMedia:o!=null?o:!1}}}Ea([_.trace("APIClientV1.getUserDetails")],cn.prototype,"getUserDetails",1),Ea([_.trace("APIClientV1.getUserPreset")],cn.prototype,"getUserPreset",1),Ea([_.trace("APIClientV1.startRecording")],cn.prototype,"startRecording",1),Ea([_.trace("APIClientV1.stopRecording")],cn.prototype,"stopRecording",1),Ea([_.trace("APIClientV1.getActiveRecording")],cn.prototype,"getActiveRecording",1),Ea([_.trace("APIClientV1.getRoomNodeData")],cn.prototype,"getRoomNodeData",1);let mp;function gx(r){return mp=re.isV2AuthToken?new on(r):new cn(r),mp}function wt(){return mp}const _x=0,vx=1,Tx=2,Ex=3,yx=4,Sx={getPeerInfo:0,updatePeerInfo:1,getRoomPeersInfo:2,joinRoom:3,leaveRoom:4,getRoomInfo:5,updateRoomInfo:6,closeRoom:7,startedLivestream:8,stoppedLivestream:9,erroredLivestream:10,getStagePeers:11,getStageRequests:12,requestStageAccess:13,cancelStageRequest:14,grantStageAccess:15,denyStageAccess:16,roomPeerCount:17,joinStage:18,leaveStage:19,getConnectedRoomsDump:20,createConnectedRooms:21,deleteConnectedRooms:22,movePeers:23,transferPeer:24,movedPeer:25,connectedRoomsUpdated:26,connectedRoomsDeleted:27,getAllAddedParticipants:28,broadcastMessage:29,kick:30,kickAll:31},wx={getMessages:0,sendMessageToRoom:1,sendMessageToPeers:2,editMessage:3,deleteMessage:4,getPaginatedMessages:5,sendMessageToChannel:6,searchChannelMessages:7,getAllChatChannels:8,markChannelIndexAsRead:9},Rx={getPlugins:0,addPlugin:1,enablePluginForRoom:2,disablePluginForPeers:3,enablePluginForPeers:4,disablePluginForRoom:5,removePlugin:6,customPluginEventToRoom:7,customPluginEventToPeers:8,storeInsertKeys:9,storeGetKeys:10,storeDeleteKeys:11,storeDelete:12},bx={createPoll:0,getPolls:1,votePoll:2,updatePoll:3},Cx={unknown:0,createWebRTCTransport:1,produce:2,consume:3,toggleProducer:4,toggleConsumer:5,closeProducer:6,closeConsumer:7,joinRoom:16,leaveRoom:17,selectedPeer:18,globalPinPeer:19,selfJoinComplete:20,peerJoinedBroadcast:25,peerLeaveBroadcast:26,peerProducerCreateBroadcast:27,peerProducerToggleBroadcast:28,peerProducerCloseBroadcast:29,globalPeerPinBroadcast:30,recordingStartedBroadcast:31,recordingStoppedBroadcast:32,peerDisplayNameEditBroadcast:33,selectedPeerDiff:40,renegotiateSessionDescription:50,errorResponse:60,kickPeer:90,kickAll:91,changeDisplayName:92,hostControlPeer:93,hostControlAllPeers:94},Px={createChatChannel:0,getChatChannel:1,deprecatedGetAllChatChannels:2,getChannelMembers:3,updateChatChannel:4};function Ho(r,e){return Object.keys(e).reduce((t,s)=>(t[s]=(r<<16)+e[s],t),{})}function Ax(r){return Object.keys(r).reduce((e,t)=>(e[t]=16777216|r[t],e),{})}const Y=Ho(_x,Sx),ft=Ho(vx,wx),q=Ho(Tx,Rx),bs=Ho(Ex,bx),dn=Ho(yx,Px),ve=Ax(Cx);class Lv{constructor(){f(this,"meetingTitle");f(this,"roomName");f(this,"roomUUID");f(this,"isDisconnected");f(this,"roomJoined");S(this,$l,void 0);f(this,"peerId");f(this,"authToken");f(this,"maxPreferredStreams")}get sfuHandler(){return d(this,$l)}reconnect(){throw new w("Method not implemented.")}async joinRoom(e,t,s,i,n={}){throw new w("Method not implemented.")}async leaveRoom(){throw new w("Method not implemented.")}async handleSocketCallbacks(e){throw new w("Method not implemented.")}async handleSockets(e,t){throw new w("Method not implemented.")}async shareMic(e){throw new w("Method not implemented.")}async shareWebcam(e){throw new w("Method not implemented.")}async shareScreen(e){throw new w("Method not implemented.")}async unmuteSelf(){throw new w("Method not implemented.")}async muteSelf(){throw new w("Method not implemented.")}async pauseWebcam(){throw new w("Method not implemented.")}async disableScreenShare(){throw new w("Method not implemented.")}async acceptWaitingRequest(e){throw new w("Method not implemented.")}async rejectWaitingRequest(e){throw new w("Method not implemented.")}async muteAll(e){throw new w("Method not implemented.")}async muteAllVideo(){throw new w("Method not implemented.")}async disableAudio(e){throw new w("Method not implemented.")}async disableVideo(e){throw new w("Method not implemented.")}async kickAll(){throw new w("Method not implemented.")}async kick(e){throw new w("Method not implemented.")}async pinPeer(e){throw new w("Method not implemented.")}async getChatMessages(){throw new w("Method not implemented.")}async requestRemoteControl(e){throw new w("Method not implemented.")}async acceptRemoteControl(e){throw new w("Method not implemented.")}async terminateRemoteControl(e,t){throw new w("Method not implemented.")}async sendEventRemoteControl(e,t,s){throw new w("Method not implemented.")}async getPolls(){throw new w("Method not implemented.")}async newPoll(e){throw new w("Method not implemented.")}async votePoll(e){throw new w("Method not implemented.")}async getPage(e){throw new w("Method not implemented.")}getConsumers(){throw new w("Method not implemented.")}async sendMessage(e){throw new w("Method not implemented.")}async getRoomState(){throw new w("Method not implemented.")}async addRoomPlugin(e){throw new w("Method not implemented.")}async removeRoomPlugin(e){throw new w("Method not implemented.")}async unpinChatMessage(e){throw new w("Method not implemented.")}async pinChatMessage(e){throw new w("Method not implemented.")}async sendChatMessage(e){throw new w("Method not implemented.")}async broadcastMessage(e,t){throw new w("Method not implemented.")}async acceptAllRequestToJoinStage(e){throw new w("Method not implemented.")}async stopPresenting(){throw new w("Method not implemented.")}async startPresenting(){throw new w("Method not implemented.")}async requestToJoinStage(e){throw new w("Method not implemented.")}async rejectRequestToJoinStage(e){throw new w("Method not implemented.")}async withdrawRequestToJoinStage(){throw new w("Method not implemented.")}async removePeerFromStage(e,t){throw new w("Method not implemented.")}stopAllProducers(){throw new w("Method not implemented.")}}$l=new WeakMap;class Ix extends Jt.EventEmitter{}const Rn=class{constructor(e){S(this,Ar,void 0);R(this,Ar,e)}static getLogger(e){return new Rn(e)}static format(e,...t){const s=e.split("%");let i=e;s.length&&([i]=s),t.reverse();for(let n=1;n<s.length&&t.length;n+=1){const a=t.pop();let o=s[n];switch(o.at(0)){case"s":o=o.replace("s",a);break;case"d":o=o.replace("d",a.toString());break;case"o":o=o.replace("o",JSON.stringify(a));break}i=`${i}${o}`}return t.length&&t.reverse().forEach(n=>{i=`${i} ${JSON.stringify(n)}`}),i}info(e,...t){let s=Rn.format(e,...t);d(this,Ar)&&(s=`${d(this,Ar)}::${s}`),g.info(s)}debug(e,...t){let s=Rn.format(e,...t);d(this,Ar)&&(s=`${d(this,Ar)}::${s}`),g.info(s)}warn(e,...t){let s=Rn.format(e,...t);d(this,Ar)&&(s=`${d(this,Ar)}::${s}`),g.info(s)}error(e,...t){let s=Rn.format(e,...t);d(this,Ar)&&(s=`${d(this,Ar)}::${s}`),g.error(s)}};let ur=Rn;Ar=new WeakMap;const xv=ur.getLogger("EnhancedEventEmitter");class ln extends Jt.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const s=this.listenerCount(e);try{return this.emit(e,...t)}catch(i){return xv.error("safeEmit() | event listener threw an error [event:%s]:%o",e,i),Boolean(s)}}async safeEmitAsPromise(e,...t){const s={}.EVENT_PROMISE_TIMEOUT?parseInt({}.EVENT_PROMISE_TIMEOUT,10):1e4;return this.safeEmitAsPromiseWithTimeout(e,s,...t)}async safeEmitAsPromiseWithTimeout(e,t,...s){return new Promise((i,n)=>{setTimeout(n,t,"event request timeout");try{this.emit(e,...s,i,n)}catch(a){xv.error("safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,a),n(a)}})}}class ol extends ln{constructor(){super();f(this,"_mapMidTransceiver",new Map);this._mapMidTransceiver=new Map}get midTransceiverMap(){return this._mapMidTransceiver}}const pe=ur.getLogger("Chrome74");class gp extends ol{constructor(){super();f(this,"_direction");f(this,"_pc");f(this,"_sendWebStream",new MediaStream);f(this,"_sendScreenShareStream",new MediaStream);f(this,"_transportReady",!1)}static createFactory(){return()=>new gp}get name(){return"Chrome74"}get pc(){return this._pc}close(){if(pe.debug("close()"),this._pc)try{this._pc.close()}catch(t){pe.error("pc.close()",t)}}init({direction:t,iceServers:s,iceTransportPolicy:i,additionalSettings:n,proprietaryConstraints:a,onTrackHandler:o}){this._direction=t,this._pc=new RTCPeerConnection({iceServers:s||[],iceTransportPolicy:i||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...n},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const t=this._pc.createDataChannel("dyte"),s=await this._pc.createOffer();return pe.info("connect offer",s),await this._pc.setLocalDescription(s),{offerSdp:s,callback:async n=>{pe.debug("connect() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),t.close()}}}async updateIceServers(t){pe.debug("updateIceServers()");const s=this._pc.getConfiguration();s.iceServers=t,this._pc.setConfiguration(s)}async restartIce(){pe.debug("restartIce()");const t=await this.pc.createOffer({iceRestart:!0});return pe.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),{offerSdp:t,callback:async i=>{pe.info("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}}}async getTransportStats(){return this._pc.getStats()}async send({track:t,encodings:s,codecOption:i,screenShare:n}){var h;this._assertSendDirection(),pe.debug("send() [kind:%s, track.id:%s]",t.kind,t.id),pe.debug("creating new transceiver");const a=this._pc.addTransceiver(t,{direction:"sendonly",streams:[n?this._sendScreenShareStream:this._sendWebStream],sendEncodings:s}),o=RTCRtpSender.getCapabilities(t.kind);pe.info("senders available params:",o);const c=[];if(i){const p=o.codecs.find(m=>m.mimeType.includes(i.name));if(i.parameters){pe.info("codecOption.parameters:",i.parameters);const m=((h=p.sdpFmtpLine)==null?void 0:h.split(";"))||[];m.push(...i.parameters);const v=[...new Set(m).values()];p.sdpFmtpLine=v.join(";")}c.push(p)}pe.info("selected codecs:",c),a.setCodecPreferences(c);const l=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");return await this._pc.setLocalDescription(l),i&&i.name==="opus"&&(l.sdp=l.sdp.replace("minptime=10;useinbandfec=1","minptime=10;useinbandfec=1;usedtx=1"),l.sdp+=`a=rtcp-fb:111 nack\r
`),{offerSdp:l,callback:async p=>(pe.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p),this.midTransceiverMap.set(a.mid,a),a.mid)}}async stopSending(t){this._assertSendDirection(),pe.debug("stopSending() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.sender.replaceTrack(null),this._pc.removeTrack(s.sender),s.direction="inactive";const i=await this._pc.createOffer();return pe.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{pe.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async replaceTrack(t,s){this._assertSendDirection(),s?pe.debug("replaceTrack() [localId:%s, track.id:%s]",t,s.id):pe.debug("replaceTrack() [localId:%s, no track]",t);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(s)}async setMaxSpatialLayer(t,s){this._assertSendDirection(),pe.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{o<=s?a.active=!0:a.active=!1}),await i.sender.setParameters(n)}async setRtpEncodingParameters(t,s){this._assertSendDirection(),pe.debug("setRtpEncodingParameters() [localId:%s, params:%o]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...s}}),await i.sender.setParameters(n)}getSenderStats(t){this._assertSendDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.sender.getStats()}async stopReceiving(t){throw this._assertRecvDirection(),pe.debug("stopReceiving() [localId:%s]",t),Error("method not implemented")}async pauseReceiving(t){throw this._assertRecvDirection(),pe.debug("pauseReceiving() [localId:%s]",t),Error("method not implemented")}async resumeReceiving(t){throw this._assertRecvDirection(),pe.debug("resumeReceiving() [localId:%s]",t),Error("method not implemented")}async getReceiverStats(t){this._assertRecvDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const t=await this._pc.createOffer();return await this._pc.setLocalDescription(t),t}async _setAnswer(t){pe.debug("_setAnswer() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}_addEventListeners(){this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:pe.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",t=>{t.candidate&&this.emit("@icecandidate",{candidate:t.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),pe.debug("negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":pe.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":pe.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:pe.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",t=>{pe.info("icecandidateerror",t)}),this._pc.addEventListener("datachannel",t=>{pe.info("data channel created: ",t.channel.label);const{channel:s}=t;s.onopen=()=>{pe.info("data channel open: ",t.channel.label),this.safeEmit("dc_open",t.channel.label)},s.onclose=()=>{pe.warn("data channel closed: ",t.channel.label)},s.onerror=i=>{pe.error("data channel error: ",t.channel.label,i)},s.onmessage=i=>{pe.info("data channel message: ",t.channel.label,i),this.safeEmit("datachannel",t.channel,String.fromCharCode(...new Uint8Array(i.data)))}})}}const ne=ur.getLogger("Firefox60");class _p extends ol{constructor(){super();f(this,"_direction");f(this,"_pc");f(this,"_sendWebStream",new MediaStream);f(this,"_sendScreenShareStream",new MediaStream);f(this,"_transportReady",!1)}static createFactory(){return()=>new _p}get name(){return"Firefox60"}get pc(){return this._pc}close(){if(ne.debug("close()"),this._pc)try{this._pc.close()}catch(t){ne.error("pc.close()",t)}}init({direction:t,iceServers:s,iceTransportPolicy:i,additionalSettings:n,proprietaryConstraints:a,onTrackHandler:o}){ne.debug("init()"),this._direction=t,this._pc=new RTCPeerConnection({iceServers:s||[],iceTransportPolicy:i||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...n},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const t=this._pc.createDataChannel("dyte"),s=await this._pc.createOffer();return ne.info("connect offer",s),await this._pc.setLocalDescription(s),{offerSdp:s,callback:async n=>{ne.debug("connect() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),t.close()}}}async updateIceServers(t){throw ne.debug("updateIceServers()"),new Error("not supported")}async restartIce(){ne.debug("restartIce()");const t=await this.pc.createOffer({iceRestart:!0});return ne.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),{offerSdp:t,callback:async i=>{ne.info("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}}}async getTransportStats(){return this._pc.getStats()}async send({track:t,encodings:s,screenShare:i}){this._assertSendDirection(),ne.debug("send() [kind:%s, track.id:%s]",t.kind,t.id),ne.debug("creating new transceiver");const n=this._pc.addTransceiver(t,{direction:"sendonly",streams:[i?this._sendScreenShareStream:this._sendWebStream]});if(s){s.reverse();const c=n.sender.getParameters();c.encodings=s,await n.sender.setParameters(c)}const a=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");return await this._pc.setLocalDescription(a),a.sdp=a.sdp.replace("minptime=10;useinbandfec=1","minptime=10;useinbandfec=1;usedtx=1;maxaveragebitrate=16000"),{offerSdp:a,callback:async c=>(ne.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c),this.midTransceiverMap.set(n.mid,n),n.mid)}}async stopSending(t){this._assertSendDirection(),ne.debug("stopSending() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated transceiver not found");s.sender.replaceTrack(null),this._pc.removeTrack(s.sender),s.direction="inactive";const i=await this._pc.createOffer();return ne.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ne.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async replaceTrack(t,s){this._assertSendDirection(),s?ne.debug("replaceTrack() [localId:%s, track.id:%s]",t,s.id):ne.debug("replaceTrack() [localId:%s, no track]",t);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(s)}async setMaxSpatialLayer(t,s){this._assertSendDirection(),ne.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters(),a=n.encodings.length-1-s;n.encodings.forEach((o,c)=>{c>=a?o.active=!0:o.active=!1}),await i.sender.setParameters(n)}async setRtpEncodingParameters(t,s){this._assertSendDirection(),ne.debug("setRtpEncodingParameters() [localId:%s, params:%o]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...s}}),await i.sender.setParameters(n)}getSenderStats(t){this._assertSendDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.sender.getStats()}async stopReceiving(t){this._assertRecvDirection(),ne.debug("stopReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive",ne.info("active transcievers: %o",this._pc.getTransceivers());const i=await this._pc.createOffer();return ne.debug("stopRecieving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ne.debug("stopRecieving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async pauseReceiving(t){this._assertRecvDirection(),ne.debug("pauseReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive";const i=await this._pc.createOffer();return ne.debug("pauseReceiving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ne.debug("pauseReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async resumeReceiving(t){this._assertRecvDirection(),ne.debug("resumeReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="recvonly";const i=await this._generateOffer();return ne.debug("resumeReceiving() | calling pc.setLocalDescription() [offer:%o]",i),{offerSdp:i,callback:async a=>{ne.debug("resumeReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async getReceiverStats(t){this._assertRecvDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const t=await this._pc.createOffer();return await this._pc.setLocalDescription(t),t}async _setAnswer(t){ne.debug("_setAnswer() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}_addEventListeners(){this._pc.addEventListener("datachannel",t=>{ne.info("data channel created: ",t.channel.label);const{channel:s}=t;s.onopen=()=>{ne.info("data channel open: ",t.channel.label),this.safeEmit("dc_open",t.channel.label)},s.onclose=()=>{ne.warn("data channel closed: ",t.channel.label)},s.onerror=i=>{ne.error("data channel error: ",t.channel.label,i)},s.onmessage=async i=>{ne.debug("data channel message: ",t.channel.label,i);const n=await i.data.arrayBuffer();this.safeEmit("datachannel",t.channel,String.fromCharCode(...new Uint8Array(n)))}}),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:ne.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",t=>{t.candidate&&this.emit("@icecandidate",{candidate:t.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),ne.debug("negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":ne.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":ne.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:ne.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",t=>{ne.info("chrome74::icecandidateerror",t)})}}const Q=ur.getLogger("Safari12");class vp extends ol{constructor(){super();f(this,"_direction");f(this,"_pc");f(this,"_sendWebStream",new MediaStream);f(this,"_sendScreenShareStream",new MediaStream);f(this,"_transportReady",!1)}static createFactory(){return()=>new vp}get name(){return"Chrome74"}get pc(){return this._pc}close(){if(Q.debug("close()"),this._pc)try{this._pc.close()}catch(t){Q.error("pc.close()",t)}}init({direction:t,iceServers:s,iceTransportPolicy:i,additionalSettings:n,proprietaryConstraints:a,onTrackHandler:o}){Q.debug("init()"),this._direction=t,this._pc=new RTCPeerConnection({iceServers:s||[],iceTransportPolicy:i||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...n},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const t=this._pc.createDataChannel("dyte"),s=await this._pc.createOffer();return Q.info("connect offer",s),await this._pc.setLocalDescription(s),{offerSdp:s,callback:async n=>{Q.debug("connect() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),t.close()}}}async updateIceServers(t){Q.debug("updateIceServers()");const s=this._pc.getConfiguration();s.iceServers=t,this._pc.setConfiguration(s)}async restartIce(){Q.debug("restartIce()");const t=await this.pc.createOffer({iceRestart:!0});return Q.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),{offerSdp:t,callback:async i=>{Q.info("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}}}async getTransportStats(){return this._pc.getStats()}async send({track:t,encodings:s,codecOption:i,screenShare:n}){var h;this._assertSendDirection(),Q.debug("send() [kind:%s, track.id:%s]",t.kind,t.id),Q.debug("creating new transceiver");const a=this._pc.addTransceiver(t,{direction:"sendonly",streams:[n?this._sendScreenShareStream:this._sendWebStream],sendEncodings:s}),o=RTCRtpSender.getCapabilities(t.kind);Q.info("senders available params:",o);const c=[];if(i){const p=o.codecs.find(m=>m.mimeType.includes(i.name));if(i.parameters){Q.info("codecOption.parameters:",i.parameters);const m=((h=p.sdpFmtpLine)==null?void 0:h.split(";"))||[];m.push(...i.parameters);const v=[...new Set(m).values()];p.sdpFmtpLine=v.join(";")}c.push(p)}Q.info("selected codecs:",c),a.setCodecPreferences(c);const l=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");return await this._pc.setLocalDescription(l),l.sdp=l.sdp.replace("minptime=10;useinbandfec=1","minptime=10;useinbandfec=1;usedtx=1;maxaveragebitrate=16000"),{offerSdp:l,callback:async p=>(Q.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setRemoteDescription(p),this.midTransceiverMap.set(a.mid,a),a.mid)}}async stopSending(t){this._assertSendDirection(),Q.debug("stopSending() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.sender.replaceTrack(null),this._pc.removeTrack(s.sender),s.direction="inactive";const i=await this._pc.createOffer();return Q.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{Q.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async replaceTrack(t,s){this._assertSendDirection(),s?Q.debug("replaceTrack() [localId:%s, track.id:%s]",t,s.id):Q.debug("replaceTrack() [localId:%s, no track]",t);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(s)}async setMaxSpatialLayer(t,s){this._assertSendDirection(),Q.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{o<=s?a.active=!0:a.active=!1}),await i.sender.setParameters(n)}async setRtpEncodingParameters(t,s){this._assertSendDirection(),Q.debug("setRtpEncodingParameters() [localId:%s, params:%o]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...s}}),await i.sender.setParameters(n)}getSenderStats(t){this._assertSendDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.sender.getStats()}async receive(t){this._assertRecvDirection(),Q.debug("recieve() | calling pc.setLocalDescription() [answer:%o]",t);const s=this._pc.getTransceivers().at(-1);return Q.info("Transceiver is now receiving",s,this._pc.getTransceivers()),this.midTransceiverMap.set(s.mid,s),{track:s.receiver.track,localId:s.mid}}async stopReceiving(t){this._assertRecvDirection(),Q.debug("stopReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive",Q.info("active transcievers: %o",this._pc.getTransceivers());const i=await this._pc.createOffer();return Q.debug("stopRecieving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{Q.debug("stopRecieving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async pauseReceiving(t){this._assertRecvDirection(),Q.debug("pauseReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive";const i=await this._pc.createOffer();return Q.debug("pauseReceiving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{Q.debug("pauseReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async resumeReceiving(t){this._assertRecvDirection(),Q.debug("resumeReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="recvonly";const i=await this._generateOffer();return Q.debug("resumeReceiving() | calling pc.setLocalDescription() [offer:%o]",i),{offerSdp:i,callback:async a=>{Q.debug("resumeReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async getReceiverStats(t){this._assertRecvDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const t=await this._pc.createOffer();return await this._pc.setLocalDescription(t),t}async _setAnswer(t){Q.debug("_setAnswer() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}_addEventListeners(){this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:Q.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",t=>{t.candidate&&this.emit("@icecandidate",{candidate:t.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),Q.debug("negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":Q.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":Q.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:Q.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",t=>{Q.info("chrome74::icecandidateerror",t)}),this._pc.ondatachannel=t=>{Q.info("data channel created: ",t.channel.label);const{channel:s}=t;s.onopen=()=>{Q.info("data channel open: ",t.channel.label),this.safeEmit("dc_open",t.channel.label)},s.onclose=()=>{Q.warn("data channel closed: ",t.channel.label)},s.onerror=i=>{Q.error("data channel error: ",t.channel.label,i)},s.onmessage=async i=>{Q.debug("data channel message: ",t.channel.label,i);const n=String.fromCharCode(...new Uint8Array(i.data));this.safeEmit("datachannel",t.channel,n)}}}}class ya extends w{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,ya):this.stack=new Error(e).stack}}class Yt extends w{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Yt):this.stack=new Error(e).stack}}const ss=ur.getLogger("Producer");class kx extends ln{constructor({id:t,localId:s,track:i,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,handler:c,appData:l}){super();f(this,"_id");f(this,"_localId");f(this,"_closed",!1);f(this,"_handler");f(this,"_track");f(this,"_kind");f(this,"_paused");f(this,"_maxSpatialLayer");f(this,"_stopTracks");f(this,"_disableTrackOnPause");f(this,"_zeroRtpOnPause");f(this,"_appData");f(this,"observer");this._id=t,this._localId=s,this._track=i,this._kind=i.kind,this._paused=a?!i.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=n,this._disableTrackOnPause=a,this._zeroRtpOnPause=o,this._appData=l||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handler=c,this.observer=new ln,this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get track(){return this._track}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(t){throw new Error("cannot override appData object")}close(t){if(!this._closed){if(ss.debug("close() with reason:",t),this._closed=!0,this._destroyTrack(),t===Tp){this.observer.emit("close");return}this._handler.stopSending(this.localId).then(({offerSdp:s,callback:i})=>{this.safeEmit("close",s,i,t)}).finally(()=>{this.observer.emit("close")})}}async getStats(){if(this._closed)throw new Yt("closed");return this._handler.getSenderStats(this.localId)}pause(){ss.debug(`producer(${this.id}):pause()`),this._closed&&ss.error("pause() | Producer closed"),this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&this._handler.replaceTrack(this.localId,null),this.observer.emit("pause")}resume(){if(ss.debug(`producer(${this.id}):resume()`),this._closed){ss.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&this._handler.replaceTrack(this.localId,this._track),this.observer.emit("resume")}async replaceTrack({track:t}){if(ss.debug("replaceTrack() [track:%o]",t),this._closed){if(t&&this._stopTracks)try{t.stop()}catch(s){ss.error(s)}throw new Yt("closed")}else if(t&&t.readyState==="ended")throw new Yt("track ended");if(t===this._track){ss.debug("replaceTrack() | same track, ignored");return}(!this._zeroRtpOnPause||!this._paused)&&await this._handler.replaceTrack(this.localId,t),this._destroyTrack(),this._track=t,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()}async setMaxSpatialLayer(t){if(this._closed)throw new Yt("closed");if(this._kind!=="video")throw new ya("not a video Producer");if(typeof t!="number")throw new TypeError("invalid spatialLayer");await this._handler.setMaxSpatialLayer(this.localId,t),this._maxSpatialLayer=t}async setRtpEncodingParameters(t){if(this._closed)throw new Yt("closed");if(typeof t!="object")throw new TypeError("invalid params");await this._handler.setRtpEncodingParameters(this.localId,t)}_onTrackEnded(){ss.debug('track "ended" event'),this.observer.emit("trackended"),this.safeEmit("trackended",this.track.id)}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch(t){ss.error(t)}}}const un=ur.getLogger("Consumer");class Ox extends ln{constructor({id:t,localId:s,producerId:i,producingPeerId:n,handler:a,track:o,appData:c,paused:l,reuseTrack:u}){super();S(this,mc);S(this,Hl);S(this,jl);f(this,"observer");S(this,cc,void 0);S(this,dc,void 0);S(this,lc,void 0);S(this,us,void 0);S(this,uc,void 0);S(this,hc,void 0);S(this,qr,void 0);S(this,bn,void 0);S(this,pc,void 0);S(this,fc,void 0);R(this,cc,t),R(this,dc,s),R(this,hc,a),R(this,fc,c),R(this,pc,n),R(this,us,!1),R(this,lc,i),R(this,qr,o),R(this,bn,l!=null?l:!1),R(this,uc,u),this.observer=new ln,be(this,Hl,WE).call(this)}get id(){return d(this,cc)}get peerId(){return d(this,pc)}get localId(){return d(this,dc)}get producerId(){return d(this,lc)}get closed(){return d(this,us)}get kind(){return d(this,qr).kind}get track(){return d(this,qr)}get paused(){return d(this,bn)}get remotelyPaused(){return this.paused}get appData(){return d(this,fc)}close(t){d(this,us)||(un.debug("close() with reason:",t),R(this,us,!0),d(this,uc)||be(this,jl,JE).call(this),this.emit("close",t),this.observer.safeEmit("close",t))}async getStats(){if(d(this,us))throw new Yt("closed");return d(this,hc).getReceiverStats(this.localId)}pause(){if(un.debug(`consumer(${this.id}):pause()`),d(this,us)){un.error("pause() | Consumer closed");return}R(this,bn,!0),d(this,qr).enabled=!1,this.observer.safeEmit("pause")}resume(){if(un.debug(`consumer(${this.id}):resume()`),d(this,us)){un.error("resume() | Consumer closed");return}R(this,bn,!1),d(this,qr).enabled=!0,this.observer.safeEmit("resume")}}cc=new WeakMap,dc=new WeakMap,lc=new WeakMap,us=new WeakMap,uc=new WeakMap,hc=new WeakMap,qr=new WeakMap,bn=new WeakMap,pc=new WeakMap,fc=new WeakMap,mc=new WeakSet,uf=function(){un.debug('track "ended" event'),this.safeEmit("trackended"),this.observer.safeEmit("trackended")},Hl=new WeakSet,WE=function(){d(this,qr).addEventListener("ended",be(this,mc,uf))},jl=new WeakSet,JE=function(){try{d(this,qr).removeEventListener("ended",be(this,mc,uf)),d(this,qr).stop()}catch(t){un.error(t.toString())}};const Uv=r=>new Promise(e=>setTimeout(e,r));async function hn(r,e){return new Promise(async(t,s)=>{const{strategy:i,maxRetryCount:n,delayTime:a}={strategy:"linear",maxRetryCount:3,delayTime:10,...e};let o=0,c,l=!1;const u=h=>{l=!0,s(h)};for(;o<n;){try{const h=await r(o,u);return t(h)}catch(h){if(c=h,l)break;if(o<n)i==="linear"?await Uv(a*(o+1)):i==="exponential"&&await Uv(a*(o+Math.max(0,o-1)));else break}o+=1}return s(c)})}function Dx(r,e){return typeof r=="undefined"?e:Object.getOwnPropertyDescriptor(window,"structuredClone")?structuredClone(r):JSON.parse(JSON.stringify(r))}const Tp="transport closed",mt=ur.getLogger("Transport");let Mx=(iE=class extends ln{constructor({id:t,direction:s,handlerFactory:i,iceServers:n,iceTransportPolicy:a,proprietaryConstraints:o,additionalSettings:c,appData:l}){super();S(this,Ua);S(this,Gl);S(this,ql);f(this,"awaitQueue");f(this,"observer");S(this,gc,void 0);S(this,xa,void 0);S(this,mr,!1);S(this,gi,void 0);S(this,of,void 0);S(this,Et,void 0);S(this,Ls,"new");S(this,_i,void 0);S(this,vi,void 0);S(this,Ti,void 0);S(this,Ei,!1);S(this,Cn,null);S(this,_c,void 0);S(this,xs,void 0);S(this,Pn,void 0);S(this,yi,void 0);S(this,vc,void 0);S(this,Us,new Map);mt.debug("constructor() [id: %s, direction: %s]",t,s),R(this,gc,t),R(this,gi,s);const u=Dx(c,{});delete u.iceServers,delete u.iceTransportPolicy,delete u.bundlePolicy,delete u.rtcpMuxPolicy,delete u.sdpSemantics,R(this,_i,new Map),R(this,vi,new Map),R(this,Ti,new Map),R(this,xs,new Map),R(this,yi,new Map),R(this,Pn,new Map),this.awaitQueue=new sl,this.observer=new ln,R(this,Et,i()),d(this,Et).init({onTrackHandler:this._ontrack.bind(this),direction:s,iceServers:n,iceTransportPolicy:a,additionalSettings:c,proprietaryConstraints:o}),R(this,vc,l||{}),R(this,_c,new Promise(h=>{this.observer.once("connected",()=>{h(!0)}),this.observer.once("disconnect",()=>{h(!1)}),this.observer.once("close",()=>{h(!1)})})),d(this,Et).on("@connectionstatechange",h=>{h!==d(this,Ls)&&(mt.debug("connection state changed to %s",h),R(this,Ls,h),h==="connected"&&(R(this,Ei,!0),this.observer.emit("connected")),h==="disconnected"&&(R(this,Ei,!1),this.observer.emit("disconnect")),(h==="failed"||h==="closed")&&(R(this,Ei,!1),this.observer.emit("close")),d(this,mr)||this.safeEmit("connectionstatechange",h))}),d(this,Et).on("@icecandidate",({candidate:h})=>{d(this,mr)||this.safeEmit("icecandidate",h)}),d(this,Et).on("dc_open",h=>{R(this,Cn,!1),setTimeout(()=>{h==="events"&&!d(this,Cn)&&this.safeEmit("dc_error",h)},5e3)}),d(this,Et).on("datachannel",(h,p)=>{var v,y;h.label==="events"&&R(this,Cn,!0),d(this,Ti).has(h.label)||d(this,Ti).set(h.label,h);const m=JSON.parse(p);if(d(this,Us).has(m.id)||d(this,Us).set(m.id,[]),(v=d(this,Us).get(m.id))==null||v.push(m),((y=d(this,Us).get(m.id))==null?void 0:y.length)===m.count){const C=d(this,Us).get(m.id),k=C==null?void 0:C.reduce((D,V)=>D+V.chunk,"");d(this,Us).delete(m.id);try{const D=JSON.parse(k);this.safeEmit(`datachannel:${h.label}`,h,D)}catch(D){mt.error("error parsing message",D)}}})}get id(){return d(this,gc)}get serverId(){return d(this,xa)}get connected(){return d(this,Ei)}get isConnected(){return d(this,_c)}get datachannels(){return d(this,Ti)}get eventsDCReady(){return d(this,Cn)}get closed(){return d(this,mr)}get direction(){return d(this,gi)}get handler(){return d(this,Et)}get connectionState(){return d(this,Ls)}get appData(){return d(this,vc)}setServerId(t){R(this,xa,t)}getDatachannel(t){return d(this,Ti).get(t)}close(){d(this,mr)||(mt.debug("close()"),R(this,Ei,!1),R(this,mr,!0),d(this,Et).close(),[...d(this,_i).values()].forEach(t=>{t.close(Tp)}),d(this,_i).clear(),[...d(this,vi).values()].forEach(t=>{t.close(Tp)}),d(this,vi).clear(),d(this,yi).clear(),d(this,xs).clear(),this.emit("close"),this.observer.emit("close"))}async getStats(){if(d(this,mr))throw new Yt("closed");return d(this,Et).getTransportStats()}async connect(){try{const{offerSdp:t,callback:s}=await d(this,Et).connect(),{answer:i}=await this.safeEmitAsPromise("connect",{offer:t});if(await s(i),!await this.isConnected)throw new Error("ice connection failed")}catch(t){throw mt.error("transport failed to connect:",t),t}}async restartIce(){if(mt.debug("restartIce()"),d(this,mr))throw new Yt("closed");return d(this,Et).restartIce()}async updateIceServers({iceServers:t}={}){if(mt.debug("updateIceServers()"),d(this,mr))throw new Yt("closed");return d(this,Et).updateIceServers(t)}async produce({track:t,encodings:s,codecOptions:i,stopTracks:n=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,appData:c={}}={}){if(mt.debug(`produce() [track:${t.id}]`),t){if(d(this,gi)!=="send")throw new ya("not a sending Transport");if(t.readyState==="ended")throw new Yt("track ended");if(this.listenerCount("connect")===0&&d(this,Ls)==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing track");if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const{producerId:l,localId:u}=await this.awaitQueue.push(async()=>{const{offerSdp:p,callback:m}=await d(this,Et).send({track:t,encodings:s,codecOption:i,screenShare:c==null?void 0:c.screenShare}),{answer:v,producerId:y}=await this.safeEmitAsPromise("produce",{offer:p,kind:t.kind,paused:a?!t.enabled:!1,appData:c}),C=await m(v);return{producerId:y,localId:C}},"produce"),h=new kx({id:l,localId:u,track:t,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:c,handler:this.handler});return d(this,_i).set(l,h),h.observer.on("close",()=>{d(this,_i).delete(h.id)}),this.emit("newproducer",h),this.observer.emit("newproducer",h),h}async consumePeer(t,s={}){if(mt.debug("consumePeer() producingPeerId:",t),d(this,mr))throw new Yt("closed");if(d(this,gi)!=="recv")throw new ya("not a receiving Transport");if(typeof t!="string")throw new TypeError("missing producingPeerId");if(this.listenerCount("connect")===0&&d(this,Ls)==="new")throw new TypeError('no "connect" listener set into this transport');if(s&&typeof s!="object")throw new TypeError("if given, appData must be an object");if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));const i=[],{consumersMap:n}=await this.safeEmitAsPromise("consumePeer",{producingPeerId:t});return n.forEach((a,o)=>{const{consumerId:c,trackId:l,screenShare:u,paused:h,streamId:p,kind:m}=a;i.push(hn(async v=>(v>0&&mt.warn("retrying consumer creation task:",c),be(this,Ua,hu).call(this,{consumerId:c,trackId:l,streamId:p,kind:m,producerId:o,producingPeerId:t,paused:h,screenShare:u,appData:s}))))}),Promise.allSettled(i)}async consume({producerId:t,producingPeerId:s,appData:i={}}){if(mt.debug("consume()"),d(this,mr))throw new Yt("closed");if(d(this,gi)!=="recv")throw new ya("not a receiving Transport");if(typeof t!="string")throw new TypeError("missing producerId");if(this.listenerCount("connect")===0&&d(this,Ls)==="new")throw new TypeError('no "connect" listener set into this transport');if(i&&typeof i!="object")throw new TypeError("if given, appData must be an object");if(!await this.isConnected)return Promise.reject(new Error("Transport not connected"));try{const{consumerId:n,screenShare:a,trackId:o,paused:c,streamId:l,kind:u}=await this.safeEmitAsPromise("consume",{producerId:t,producingPeerId:s});return await hn(async h=>(h>0&&mt.warn("retrying consumer creation task:",n),be(this,Ua,hu).call(this,{consumerId:n,screenShare:a,trackId:o,streamId:l,kind:u,paused:c,producerId:t,producingPeerId:s,appData:i})))}catch(n){throw mt.error("consume failed:",n),n}}async setRemoteOffer(t){await be(this,Gl,zE).call(this,t);const s=await d(this,Et).pc.createAnswer(),i=ie(s.sdp);return i.media=i.media.map(n=>{if(n.type==="audio"){const a={...n};return a.rtcpFb||(a.rtcpFb=[]),a.rtcpFb.some(c=>c.type==="nack")||a.rtcpFb.push({payload:parseInt(a.payloads,10),type:"nack"}),a}return n}),s.sdp=Nr(i),await be(this,ql,YE).call(this,s),s}async retryFailedConsumerCreationTasks(t){return Promise.allSettled(t.map(async s=>hn(async i=>(i>0&&mt.warn("retrying failed consumer creation task",s),be(this,Ua,hu).call(this,{...s})))))}_ontrack(t){const{track:s,transceiver:i,streams:n}=t;mt.info("track event received",{trackId:s.id,tId:i.receiver.track.id}),s.addEventListener("ended",()=>{mt.info("track ended",s.id),d(this,yi).delete(s.id)}),d(this,yi).set(s.id,[s,i]);const a=`${n[0].id}:${s.kind}`,o=d(this,xs).get(a);o?(o(s,i),d(this,xs).delete(a)):(mt.warn(`track event handler not found ${a}`),d(this,Pn).set(a,t))}},gc=new WeakMap,xa=new WeakMap,mr=new WeakMap,gi=new WeakMap,of=new WeakMap,Et=new WeakMap,Ls=new WeakMap,_i=new WeakMap,vi=new WeakMap,Ti=new WeakMap,Ei=new WeakMap,Cn=new WeakMap,_c=new WeakMap,xs=new WeakMap,Pn=new WeakMap,yi=new WeakMap,vc=new WeakMap,Us=new WeakMap,Ua=new WeakSet,hu=async function({consumerId:t,producerId:s,producingPeerId:i,streamId:n,trackId:a,paused:o,screenShare:c,appData:l,kind:u}){const h=`${n}:${u}`,p={consumerId:t,producerId:s,producingPeerId:i,streamId:n,trackId:a,appData:l,kind:u,paused:o,screenShare:c,name:"consumer creation task error",message:"consumer creation failed"};return new Promise((v,y)=>{const C=setTimeout(()=>{d(this,xs).delete(h),p.isTimedout=!0,y(p)},5e3),k=(M,Pe)=>{try{if(M.readyState==="ended")clearTimeout(C),y(p);else{this.handler.midTransceiverMap.set(Pe.mid,Pe);const W=new Ox({id:t,localId:Pe.mid,track:M,paused:o,producerId:s,producingPeerId:i,handler:d(this,Et),reuseTrack:!0,appData:{...l,screenShare:c}});d(this,vi).set(t,W),W.once("close",()=>{d(this,vi).delete(W.id),this.handler.midTransceiverMap.delete(Pe.mid)}),mt.info("consumer created for ",{producerId:s,trackId:a,producingPeerId:i}),this.observer.emit("newconsumer",W),clearTimeout(C),v(W)}}catch(W){mt.warn("error while creating consumer:",W),clearTimeout(C),y(p)}},D=d(this,yi).get(t);if((D==null?void 0:D.length)===2){k(D[0],D[1]);return}const V=d(this,Pn).get(h);V?(d(this,Pn).delete(h),k(V.track,V.transceiver)):d(this,xs).set(h,k)})},Gl=new WeakSet,zE=async function(t){await d(this,Et).pc.setRemoteDescription(t)},ql=new WeakSet,YE=async function(t){mt.debug(`${this.direction}() {transportId: ${d(this,xa)}} | calling pc.setLocalDescription() [offer:%o]`,t),await d(this,Et).pc.setLocalDescription(t)},iE);const ae=ur.getLogger("Firefox110");class Ep extends ol{constructor(){super();f(this,"_direction");f(this,"_pc");f(this,"_sendWebStream",new MediaStream);f(this,"_sendScreenShareStream",new MediaStream);f(this,"_transportReady",!1)}static createFactory(){return()=>new Ep}get name(){return"Firefox110"}get pc(){return this._pc}close(){if(ae.debug("close()"),this._pc)try{this._pc.close()}catch(t){ae.error("pc.close()",t)}}init({direction:t,iceServers:s,iceTransportPolicy:i,additionalSettings:n,proprietaryConstraints:a,onTrackHandler:o}){ae.debug("init()"),this._direction=t,this._pc=new RTCPeerConnection({iceServers:s||[],iceTransportPolicy:i||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...n},a),o&&this._pc.addEventListener("track",c=>{o(c)}),this._addEventListeners()}async connect(){const t=this._pc.createDataChannel("dyte"),s=await this._pc.createOffer();return ae.info("connect offer",s),await this._pc.setLocalDescription(s),{offerSdp:s,callback:async n=>{ae.debug("connect() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),t.close()}}}async updateIceServers(t){throw ae.debug("updateIceServers()"),new Error("not supported")}async restartIce(){ae.debug("restartIce()");const t=await this.pc.createOffer({iceRestart:!0});return ae.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),{offerSdp:t,callback:async i=>{ae.info("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}}}async getTransportStats(){return this._pc.getStats()}async send({track:t,encodings:s,screenShare:i}){this._assertSendDirection(),ae.debug("send() [kind:%s, track.id:%s]",t.kind,t.id),ae.debug("creating new transceiver");const n=this._pc.addTransceiver(t,{direction:"sendonly",streams:[i?this._sendScreenShareStream:this._sendWebStream],sendEncodings:s}),a=await this._pc.createOffer();if(!this._transportReady)throw new Error("webrtc transport not connected");return await this._pc.setLocalDescription(a),a.sdp=a.sdp.replace("minptime=10;useinbandfec=1","minptime=10;useinbandfec=1;usedtx=1"),{offerSdp:a,callback:async c=>(ae.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c),this.midTransceiverMap.set(n.mid,n),n.mid)}}async stopSending(t){this._assertSendDirection(),ae.debug("stopSending() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated transceiver not found");s.sender.replaceTrack(null),this._pc.removeTrack(s.sender),s.direction="inactive";const i=await this._pc.createOffer();return ae.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ae.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async replaceTrack(t,s){this._assertSendDirection(),s?ae.debug("replaceTrack() [localId:%s, track.id:%s]",t,s.id):ae.debug("replaceTrack() [localId:%s, no track]",t);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(s)}async setMaxSpatialLayer(t,s){this._assertSendDirection(),ae.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters(),a=n.encodings.length-1-s;n.encodings.forEach((o,c)=>{c>=a?o.active=!0:o.active=!1}),await i.sender.setParameters(n)}async setRtpEncodingParameters(t,s){this._assertSendDirection(),ae.debug("setRtpEncodingParameters() [localId:%s, params:%o]",t,s);const i=this.midTransceiverMap.get(t);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...s}}),await i.sender.setParameters(n)}getSenderStats(t){this._assertSendDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.sender.getStats()}async stopReceiving(t){this._assertRecvDirection(),ae.debug("stopReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive",ae.info("active transcievers: %o",this._pc.getTransceivers());const i=await this._pc.createOffer();return ae.debug("stopRecieving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ae.debug("stopRecieving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this.midTransceiverMap.delete(t)}}}async pauseReceiving(t){this._assertRecvDirection(),ae.debug("pauseReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="inactive";const i=await this._pc.createOffer();return ae.debug("pauseReceiving() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i),{offerSdp:i,callback:async a=>{ae.debug("pauseReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async resumeReceiving(t){this._assertRecvDirection(),ae.debug("resumeReceiving() [localId:%s]",t);const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");s.direction="recvonly";const i=await this._generateOffer();return ae.debug("resumeReceiving() | calling pc.setLocalDescription() [offer:%o]",i),{offerSdp:i,callback:async a=>{ae.debug("resumeReceiving() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}}}async getReceiverStats(t){this._assertRecvDirection();const s=this.midTransceiverMap.get(t);if(!s)throw new Error("associated RTCRtpTransceiver not found");return s.receiver.getStats()}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}async _generateOffer(){const t=await this._pc.createOffer();return await this._pc.setLocalDescription(t),t}async _setAnswer(t){ae.debug("_setAnswer() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}_addEventListeners(){this._pc.addEventListener("datachannel",t=>{ae.info("data channel created: ",t.channel.label);const{channel:s}=t;s.onopen=()=>{ae.info("data channel open: ",t.channel.label),this.safeEmit("dc_open",t.channel.label)},s.onclose=()=>{ae.warn("data channel closed: ",t.channel.label)},s.onerror=i=>{ae.error("data channel error: ",t.channel.label,i)},s.onmessage=async i=>{ae.debug("data channel message: ",t.channel.label,i);const n=await i.data.arrayBuffer();this.safeEmit("datachannel",t.channel,String.fromCharCode(...new Uint8Array(n)))}}),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected"),this._transportReady=!0;break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break;default:ae.warn("unknown state");break}}),this._pc.addEventListener("icecandidate",t=>{t.candidate&&this.emit("@icecandidate",{candidate:t.candidate})}),this._pc.addEventListener("negotiationneeded",()=>{this.emit("@negotiationneeded",{}),ae.debug("negotiationneeded")}),this._pc.addEventListener("icegatheringstatechange",()=>{switch(this._pc.iceGatheringState){case"gathering":ae.debug("icegatheringstatechange | gathering"),this.emit("@icegatheringstatechange","gathering");break;case"complete":ae.debug("icegatheringstatechange | complete"),this.emit("@icegatheringstatechange","complete");break;default:ae.warn("unknown state");break}}),this._pc.addEventListener("icecandidateerror",t=>{ae.info("chrome74::icecandidateerror",t)})}}const is=ur.getLogger("Device");function Nx(){if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(typeof RTCPeerConnection=="undefined"){is.warn("this._detectDevice() | unsupported ReactNative without RTCPeerConnection");return}return is.debug("this._detectDevice() | ReactNative handler chosen"),"ReactNative"}if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const r=navigator.userAgent,e=nh.getParser(r),t=e.getEngine();if(is.debug("current browser info",e.getBrowser()),e.satisfies({chrome:">=74",chromium:">=74","microsoft edge":">=88"}))return"Chrome74";if(e.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(e.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(e.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(e.satisfies({firefox:">=110"}))return"Firefox110";if(e.satisfies({firefox:">=60"}))return"Firefox60";if(e.satisfies({ios:{OS:">=14.3",firefox:">=30.0"}})||e.satisfies({safari:">=12.0"})&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(e.satisfies({safari:">=11"}))return"Safari11";if(e.satisfies({"microsoft edge":">=11"})&&e.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(t.name&&t.name.toLowerCase()==="blink"){const s=r.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(s){const i=Number(s[1]);return i>=74?"Chrome74":i>=70?"Chrome70":i>=67?"Chrome67":"Chrome55"}return"Chrome74"}is.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",e.getBrowserName(),e.getBrowserVersion());return}is.warn("this._detectDevice() | unknown device")}class Lx{constructor({handlerName:e,handlerFactory:t}={}){f(this,"_handlerFactory");f(this,"_handlerName");f(this,"_observer");if(is.debug("constructor()"),e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)is.debug("constructor() | handler given: %s",e);else if(e=Nx(),e)is.debug("constructor() | detected handler: %s",e);else throw new Error("device not supported");switch(e){case"Chrome74":this._handlerFactory=gp.createFactory();break;case"Safari12":this._handlerFactory=vp.createFactory();break;case"Firefox60":this._handlerFactory=_p.createFactory();break;case"Firefox110":this._handlerFactory=Ep.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}const s=this._handlerFactory();this._handlerName=s.name,s.close(),this._observer=new Jt}get handlerName(){return this._handlerName}createSendTransport({iceServers:e,iceTransportPolicy:t,additionalSettings:s,proprietaryConstraints:i,appData:n}){return is.debug("createSendTransport()"),this._createTransport({direction:"send",iceServers:e,iceTransportPolicy:t,additionalSettings:s,proprietaryConstraints:i,appData:n})}createRecvTransport({iceServers:e,iceTransportPolicy:t,additionalSettings:s,proprietaryConstraints:i,appData:n}){return is.debug("createRecvTransport()"),this._createTransport({direction:"recv",iceServers:e,iceTransportPolicy:t,additionalSettings:s,proprietaryConstraints:i,appData:n})}_createTransport({direction:e,iceServers:t,iceTransportPolicy:s,additionalSettings:i,proprietaryConstraints:n,appData:a}){const o=Yc(),c=new Mx({id:o,direction:e,iceServers:t,iceTransportPolicy:s,additionalSettings:i,proprietaryConstraints:n,appData:a,handlerFactory:this._handlerFactory});return this._observer.emit("newtransport",c),c}}class xx{constructor(e){S(this,qt,void 0);R(this,qt,e)}async joinRoom(e,t){const s={roomUuid:e,displayName:t,prejoined:!1};return(await d(this,qt).sendMessagePromise(ve.joinRoom,ZD.toBinary(s))).payload}async connectTransport(e){const t=(await d(this,qt).sendMessagePromise(ve.createWebRTCTransport,UD.toBinary(e))).payload,{transportId:s,description:i}=zd.fromBinary(t),n={sdp:i==null?void 0:i.sdp,type:i.type};return{transportId:s,answer:n}}async produce(e){var n,a;const t=(await d(this,qt).sendMessagePromise(ve.produce,cM.toBinary(e))).payload,s=JM.fromBinary(t);return{answer:{sdp:(n=s==null?void 0:s.description)==null?void 0:n.sdp,type:(a=s==null?void 0:s.description)==null?void 0:a.type},producerId:s.producerId}}async consume(e){const t=(await d(this,qt).sendMessagePromise(ve.consume,aM.toBinary(e))).payload,{consumerIdsMap:{map:s}}=KM.fromBinary(t);return s}async closeProducer(e){const t=(await d(this,qt).sendMessagePromise(ve.closeProducer,mM.toBinary(e))).payload,{description:s}=tN.fromBinary(t);return s}async closeConsumer(e){return(await d(this,qt).sendMessagePromise(ve.closeConsumer,_M.toBinary(e))).payload}async hostControlForPeer(e,t){const s={audio:t==="audio",screeShare:!1,video:t==="video",participantId:e},i=(await d(this,qt).sendMessagePromise(ve.hostControlPeer,bM.toBinary(s))).payload;if(!i)return!1;const{status:n}=dN.fromBinary(i);return n==="success"}async hostControlForAll(e){const t={audio:e==="audio",screenShare:!1,video:e==="video"},s=(await d(this,qt).sendMessagePromise(ve.hostControlAllPeers,PM.toBinary(t))).payload;if(!s)return!1;const{status:i}=uN.fromBinary(s);return i==="success"}async kickAll(){const e={},t=(await d(this,qt).sendMessagePromise(ve.kickAll,yM.toBinary(e))).payload;if(!t)return!1;const{status:s}=oN.fromBinary(t);return s==="success"}async kickPeer(e){const t=(await d(this,qt).sendMessagePromise(ve.kickPeer,TM.toBinary(e))).payload;if(!t)return!1;const{status:s}=nN.fromBinary(t);return s==="success"}async changeDisplayName(e){const t=(await d(this,qt).sendMessagePromise(ve.changeDisplayName,wM.toBinary(e))).payload;if(!t)return!1;const{status:s}=pN.fromBinary(t);return s==="success"}async notifySelfJoinComplete(){const e={},t=(await d(this,qt).sendMessagePromise(ve.selfJoinComplete,tM.toBinary(e))).payload;return $M.fromBinary(t)}}qt=new WeakMap;class Ux extends Ix{constructor(t){super();f(this,"_device");f(this,"_sendTransport");f(this,"_recvTransport");f(this,"_consumers");f(this,"_producers");f(this,"_producerIdToConsumerIdMap");f(this,"_logger");f(this,"_socket");f(this,"_socketHandler");f(this,"_totalTransportReconnectionCount");f(this,"_transportReconnectFailureCount");f(this,"_consumerCreationFailureCount");f(this,"_producerNotReadyFailureCount");f(this,"_consumerNotBoundFailureCount");f(this,"transportConnectionStatus");this._device=new Lx,this._logger=ur.getLogger("HiveSFUHandler"),this._socket=t,this._socketHandler=new xx(t),this.reset()}get socket(){return this._socket}get producers(){return this._producers}get consumers(){return this._consumers}get producerIdToConsumerIdMap(){return this._producerIdToConsumerIdMap}get hiveSocketHandler(){return this._socketHandler}get sendTransport(){return this._sendTransport}get recvTransport(){return this._recvTransport}reset(){this._producers=new Map,this._consumers=new Map,this._producerIdToConsumerIdMap=new Map,this.transportConnectionStatus=new Map,this._transportReconnectFailureCount=0,this._consumerCreationFailureCount=0,this._totalTransportReconnectionCount=0,this._producerNotReadyFailureCount=0,this._consumerNotBoundFailureCount=0}async setupTransports(t,s){const n=await wt().getICEServers(),a=t.map(o=>{const c=this.transportConnectionStatus.get(o);if(c&&!s)return c;switch(o){case"send":{const l=this.createSendTransport({iceServers:n});return this.transportConnectionStatus.set(o,l),l}case"recv":{const l=this.createRecvTransport({iceServers:n});return this.transportConnectionStatus.set(o,l),l}default:return this._logger.warn(`what are you thinking when passing this ${o}?`),Promise.reject(Error("TYPE_OF_TRANSPORT_UNKNOWN"))}});return Promise.all(a).finally(()=>{t.forEach(o=>{this.transportConnectionStatus.delete(o)})})}async stopAllTransports(){var t,s,i,n;this._logger.info("closing all the transports"),(t=this._sendTransport)==null||t.close(),(s=this._sendTransport)==null||s.removeAllListeners(),(i=this._recvTransport)==null||i.close(),(n=this._recvTransport)==null||n.removeAllListeners(),this._sendTransport=void 0,this._recvTransport=void 0}async createSendTransport(t){if(this._sendTransport&&this._sendTransport.connected)return;this._logger.info("sendTransport::initializing_transport");const s=this._device.createSendTransport(t);this._logger.info("sendTransport::initialized_transport"),this.handleTransport(s,!1),this._logger.info("sendTransport::connecting_transport");try{await hn(async i=>{i>0&&this._logger.debug("retrying transport connect, count:",i);try{await s.connect()}catch(n){throw this._logger.error("fail to connect send transport:",s.id,"[Error]:",n),n}},{delayTime:100}),this._logger.info("sendTransport::connected_transport"),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._producerNotReadyFailureCount=0,this._sendTransport=s,L.onSafeInitialization(()=>{L.configureSendTransport(s)}),Object.assign(window,{sendTransport:s})}catch(i){this._logger.error("failed to connect send transport after retry:",s.id,"[Error]:",i),s.close(),s.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure()}}async createRecvTransport(t){if(this._recvTransport&&this._recvTransport.connected)return;this._logger.info("recvTransport::initializing_transport");const s=this._device.createRecvTransport({...t,additionalSettings:{rtcAudioJitterBufferMaxPackets:25,rtcAudioJitterBufferFastAccelerate:!0,rtcAudioJitterBufferMinDelayMs:20}});L.onSafeInitialization(()=>{L.configureRecvTransport(s)}),this._logger.info("recvTransport::initialized_transport"),this.handleTransport(s,!0),this._logger.info("recvTransport::connecting_transport");try{await hn(async i=>{i>0&&this._logger.debug("retrying transport connect, count:",i);try{await s.connect()}catch(n){throw this._logger.error("fail to connect recv transport:",s.id,"[Error]:",n),n}},{delayTime:100}),this._logger.info("recvTransport::connected_transport"),this._transportReconnectFailureCount=Math.max(0,this._transportReconnectFailureCount-1),this._consumerCreationFailureCount=0,this._consumerNotBoundFailureCount=0,this._recvTransport=s,this.producerIdToConsumerIdMap.clear()}catch(i){this._logger.error("failed to connect recv transport after retry:",s.id,"[Error]:",i),s.close(),s.removeAllListeners(),this._transportReconnectFailureCount+=1,this.handleFailure()}}handleTransport(t,s){if(t.on("connect",async({offer:i},n,a)=>{try{const o={consuming:s,description:{sdp:i.sdp,type:i.type,target:s?ii.SUBSCRIBER:ii.PUBLISHER}},{transportId:c,answer:l}=await this._socketHandler.connectTransport(o);t.setServerId(c),n({answer:l})}catch(o){this._logger.error(`${s?"consumer":"producer"} transport connection error:`,o),a(o)}}),t.on("connectionstatechange",async i=>{switch(this._logger.info(`${s?"consumer":"producer"} transport connectionState:`,i),i){case"failed":case"disconnected":if(t.closed)return;this._logger.info(`${s?"consumer":"producer"} transport disconnected or failed, reconnecting...`,"transport id:",t.id,"serverid:",t.serverId),x.hasFeature(U.ENABLE_HIVE_TRANSPORT_RECONNECTION_ON_ICE_FAILED)?(E.emit(T.HIVE_TRANSPORT_STATE_CHANGED,{state:"reconnecting",transportDirection:s?"recv":"send"}),this.emit("reconnect_transport",t)):E.emit(T.HIVE_TRANSPORT_STATE_CHANGED,{state:i,transportDirection:s?"recv":"send"});break;case"new":case"closed":break;default:E.emit(T.HIVE_TRANSPORT_STATE_CHANGED,{state:i,transportDirection:s?"recv":"send"});break}}),t.on("icecandidate",async i=>{this._logger.debug("sending icecandidate:",i.toJSON())}),t.on("datachannel:events",async(i,n)=>{this._logger.debug("got data channel message on event:",n);try{switch(n.type){case"offer":{this.negotiateOverDC(n.payload,i,t);break}case"handshake":{i.send(JSON.stringify({type:"handshake",payload:{message:"pong"}}));break}case"consumer_toggle":{this.handleConsumerToggle(n.payload);break}case"error":{this.handleErrorOverDC(n.payload);break}default:this._logger.warn("unknown event received from hive node, event:",n.type);break}}catch(a){this._logger.error("Unable to handle the incoming datachannel message on",i.label)}}),t.on("dc_error",()=>{t.direction==="recv"&&(this._logger.warn("events datachannel did not open in 5s"),this.handleFailure())}),t.on("negotiate",async({description:i},n,a)=>{try{const o={sdp:i==null?void 0:i.sdp,type:i==null?void 0:i.type},c=await this.negotiate(t,o);n({answer:c})}catch(o){this._logger.error("negotiate error:",o),a(o)}}),!s){t.on("produce",async({offer:i,kind:n,paused:a,appData:o},c,l)=>{var m;const h=ie(i.sdp).media.filter(v=>n==="video"?v.type==="video":v.type==="audio").at(-1).msid,p={description:{sdp:i.sdp,type:i.type,target:ii.PUBLISHER},paused:a,kind:n,msid:h,screenShare:(m=o.screenShare)!=null?m:!1};try{const{answer:v,producerId:y}=await this._socketHandler.produce(p);c({answer:v,producerId:y})}catch(v){this._logger.error("create producer error:",v),l(v)}});return}t.on("datachannel:negotiation",async(i,n)=>{try{this._logger.info("datachannel message recieved:",i.label,n);const a={sdp:n,type:"offer"},o=await t.setRemoteOffer(a);this._logger.info("datachannel answer:",o),i.send(o.sdp)}catch(a){this._logger.error("datachannel:negotiation::Error:",a)}}),t.on("consumePeer",async({producingPeerId:i},n,a)=>{this._logger.info("consumePeer:",i);const o={producingPeerId:i};try{const c=await this._socketHandler.consume(o);this._logger.debug(`consumePeer response for ${i}:`,{consumerStateMap:c});const l=new Map;Object.entries(c).forEach(([u,h])=>{var p,m,v;l.set(u,{consumerId:h.consumerId,trackId:(p=h.producerTrack)==null?void 0:p.trackId,streamId:h.producerTrack.streamId,kind:h.producerState.kind===Br.VIDEO?"video":"audio",screenShare:(m=h.producerState)==null?void 0:m.screenShare,paused:(v=h.producerState)==null?void 0:v.pause})}),n({consumersMap:l})}catch(c){this._logger.error("consumePeer error:",c),a(c)}}),t.on("consume",async({producerId:i,producingPeerId:n},a,o)=>{var l,u,h,p;const c={producingPeerId:n,producerId:i};try{const v=(await this._socketHandler.consume(c))[i];this._logger.info("consumer create response:",{consumerState:v,paused:(l=v.producerState)==null?void 0:l.pause}),a({consumerId:v.consumerId,screenShare:(u=v.producerState)==null?void 0:u.screenShare,trackId:(h=v.producerTrack)==null?void 0:h.trackId,streamId:v.producerTrack.streamId,kind:v.producerState.kind===Br.VIDEO?"video":"audio",paused:(p=v.producerState)==null?void 0:p.pause})}catch(m){this._logger.error("error during consuming on server:",m),o(m)}})}async createProducer(t,s,i){if(this._sendTransport===void 0||this._sendTransport.closed)return;const n=await this._sendTransport.produce(s);n.on("close",async(a,o,c)=>{this._logger.info("producer id:",n.id,"closed with reason:",c);const l={producerId:n.id,description:{sdp:a.sdp,type:a.type,target:ii.PUBLISHER}};try{const u=await this._socketHandler.closeProducer(l);this._logger.info("response",u);const h={sdp:u==null?void 0:u.sdp,type:u==null?void 0:u.type};o(h)}catch(u){this._logger.error("producer close error:",u)}this._producers.delete(t),i(),t===B.SCREENSHARE_VIDEO&&this._switchWebcamLayers(3)}),n.on("trackended",()=>{g.info("producer::trackended",{producer:{id:n==null?void 0:n.id,kind:t,status:"UNKNOWN",appData:n==null?void 0:n.appData}}),[B.MIC,B.WEBCAM].includes(t)||i()}),this._producers.set(t,n),this._producers.has(B.SCREENSHARE_VIDEO)&&this._switchWebcamLayers(0)}async _switchWebcamLayers(t){const s=this._producers.get(B.WEBCAM);if(s)try{this._logger.debug("switching layer of webcam producer to:",t),await s.setMaxSpatialLayer(t)}catch(i){this._logger.error("failed to switch spatial layer",i)}}_initConsumer(t){t&&(t.observer.on("close",async s=>{this._logger.debug("consumer closed",s),this._consumers.delete(t.id),E.emit(T.CONSUMER_CLOSED,{id:t.id})}),this._consumers.set(t.id,t),this.producerIdToConsumerIdMap.set(t.producerId,t.id),E.emit(T.NEW_CONSUMER,{id:t.id}))}async consumePeer(t){if(this._recvTransport===void 0||this._recvTransport.closed||!this._recvTransport.connected)throw Error("Receiving transport not connected");await hn(async s=>{s>0&&this._logger.debug("retrying consumePeer call, retryCount:",s);try{const i=await this._recvTransport.consumePeer(t),n=[];i.forEach(a=>{a.status==="rejected"?n.push(a.reason):this._initConsumer(a.value)}),this._recvTransport.retryFailedConsumerCreationTasks(n).then(a=>{a.forEach(o=>{o.status==="rejected"?(this._logger.error("consumer creation task is failing",o.reason),this._consumerCreationFailureCount+=1,setTimeout(this.handleFailure.bind(this),0)):this._initConsumer(o.value)})})}catch(i){throw this._logger.error("got error in consumePeer",i),i}}).catch(s=>{this._logger.error("consumePeer failed after retries",s),this._consumerCreationFailureCount+=1,this.handleFailure()})}async createConsumer(t){if(this._recvTransport===void 0||this._recvTransport.closed||!this._recvTransport.connected)return;const{producerId:s,producingPeerId:i,appData:n}=t;if(this.getProducer(s)){this._logger.warn("why are you creating a consumer for local producer?");return}await hn(async o=>{o>0&&this._logger.debug("retrying createConsumer call, retryCount:",o);const c=await this._recvTransport.consume({producerId:s,producingPeerId:i,appData:n});this._initConsumer(c)}).catch(o=>{this._logger.error("createConsumer failed after retries",o),this._consumerCreationFailureCount+=1,this.handleFailure()}),Object.assign(window,{consumers:this._consumers})}async pauseProducer(t){const s=this._producers.get(t);if(!s){this._logger.warn("producer type:",t,"not found");return}s.pause(),this._logger.info(t,"producer id:",s.id,"paused")}async resumeProducer(t){const s=this._producers.get(t);if(!s){this._logger.warn("producer type:",t,"not found");return}s.resume(),this._logger.info(t,"producer id:",s.id,"resumed")}async replaceTrack(t,s){const i=this._producers.get(t);if(!i){this._logger.warn("producer type:",t,"not found");return}await i.replaceTrack({track:s}),this._logger.info("track replaced with id:",s.id,"on producer:",t)}async removeProducer(t,s){const i=this._producers.get(t);if(!i){this._logger.warn("producer type:",t,"not found");return}s&&i.track.stop(),i.close()}async pauseConsumer(t){if(!this._consumers.get(t)){this._logger.warn("consumer id:",t,"not found");return}this.toggleConsumerOverDC(t,!0)}async pauseConsumerOverSocket(t){try{const s={consumerId:t.id,pause:!0};await this.socket.sendMessagePromise(ve.toggleConsumer,mv.toBinary(s)),t.pause(),E.emit(T.CONSUMER_PAUSED,{id:t.id}),this._logger.info("consumer:",t.id,"paused")}catch(s){this._logger.error("error on pausing consumer",s)}}async toggleConsumerOverDC(t,s){const i={type:"consumer_toggle",payload:{consumerId:t,mute:s}},n=this._recvTransport.getDatachannel("events");if(!n){this._logger.warn("events datachannel not found");return}n.send(JSON.stringify(i))}async resumeConsumer(t){const s=this._consumers.get(t);if(!s){this._logger.warn("consumer id:",t,"not found");return}if(!s.paused){this._logger.warn("consumer is not paused so not resuming",t);return}try{const i={consumerId:t,pause:!1};await this.socket.sendMessagePromise(ve.toggleConsumer,mv.toBinary(i)),s.resume(),E.emit(T.CONSUMER_RESUMED,{id:s.id}),this._logger.info("consumer:",t,"resumed")}catch(i){this._logger.error("error on resuming consumer",i)}}async closeConsumer(t,s){return this.closeConsumers([t],s)}async closeConsumers(t,s=!1){this._logger.info("Closing consumers:",t,"with force:",s);let i=!0;const n=t.filter(c=>this._consumers.get(c)?!0:(this._logger.warn("consumer id:",c,"not found"),!1)),a={consumerIds:n},o=async()=>{var c;return(c=this._recvTransport)==null?void 0:c.awaitQueue.push(async()=>{await this._socketHandler.closeConsumer(a)},"close_consumer").catch(l=>{this._logger.warn("error on closing consumer:",l),i=s})};s?o():await o(),i&&n.forEach(c=>{const l=this.consumers.get(c);this.producerIdToConsumerIdMap.delete(l.producerId),l.close(s?"force closed":void 0)})}async cleanupConsumers(t){const s=[];this._consumers.forEach(i=>{t?i.peerId===t&&s.push(i.id):s.push(i.id)}),this.closeConsumers(s,!0)}async stopAllProducers(){this._logger.info("stopping all available producers"),this._producers.forEach((t,s)=>{this._logger.debug("closing producer type",s),t.close()})}getProducer(t){return[...this.producers.values()].filter(s=>s.id===t).at(0)}async negotiate(t,s){this._logger.info("setting remote offer :",s,"on transport",t.serverId);const i=await t.setRemoteOffer(s),n={transportId:t.serverId,description:{sdp:i.sdp,type:i.type,target:ii.SUBSCRIBER}};return this._logger.info("sending renegotiate request",n),await this.socket.sendMessagePromise(ve.renegotiateSessionDescription,VD.toBinary(n)),this._logger.info("renegotiation done",t.serverId),i}async negotiateOverDC(t,s,i){const n={sdp:t.sdp,type:"offer"};let a;try{const o=await i.setRemoteOffer(n);a={type:"answer",payload:{type:o.type,sdp:o.sdp}}}catch(o){this._logger.error("datachannel:events::Error:",o),a={type:"error",payload:{error:o.message}}}this._logger.debug("datachannel answer:",a),s.send(JSON.stringify(a))}handleConsumerToggle(t){const{mute:s,trackId:i}=t;this._logger.info("consumer toggled for",i,"muted:",s);const n=this.consumers.get(i);if(!n){this._logger.warn("consumer with id",i," not found");return}n.paused!==s&&(this._logger.debug("consumer state is not same",{consumerPaused:n.paused,mute:s}),s?(n.pause(),E.emit(T.CONSUMER_PAUSED,{id:n.id})):(n.resume(),E.emit(T.CONSUMER_RESUMED,{id:n.id})))}async handleErrorOverDC(t){this._logger.error("got error over dc:",t);const{type:s,error:i,id:n}=t;if(s==="consumer"){if(i==="bind-fail"){if(this._consumerNotBoundFailureCount>=2){this.handleFailure();return}this._consumerNotBoundFailureCount+=1;const a=this.consumers.get(n);if(!a)return;try{await this.closeConsumer(a.id),await this.createConsumer({producerId:a.producerId,producingPeerId:a.peerId,appData:a.appData})}catch(o){this._logger.error("failed to recreate consumer on downtrack bound failure, consumerID:",a.id,"producerId:",a.producerId,"error:",o)}}}else if(s==="producer"&&i==="ready-fail"){if(this._producerNotReadyFailureCount>=2){this.handleFailure();return}this._producerNotReadyFailureCount+=1;const[a]=[...this.producers.entries()].find(o=>o[1].id===n);if(!a)return;await this.removeProducer(a).catch(o=>{this._logger.error("failed to remove ready-fail producer:",n,"error:",o)})}}async handleFailure(){var t;if(this._transportReconnectFailureCount>0||((t=this._recvTransport)==null?void 0:t.eventsDCReady)===!1||this._totalTransportReconnectionCount>3){this._logger.warn("transport failure detected"),x.hasFeature(U.ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY)&&(this._logger.debug("rejoining room"),this.emit("rejoin"));return}(this._consumerCreationFailureCount>0||this._consumerNotBoundFailureCount>=2)&&(this._logger.warn("consumer creation failure detected or consumer not bound failure increased"),x.hasFeature(U.ENABLE_HIVE_EXPERIMENTAL_FAIL_RECOVERY)&&(this._logger.debug("reconnecting recv transport"),this._totalTransportReconnectionCount+=1,this.emit("reconnect_transport",this._recvTransport))),this._producerNotReadyFailureCount>=2&&(this._logger.warn("producer receiver not getting added needs to reconnect send transport"),this._totalTransportReconnectionCount+=1,this.emit("reconnect_transport",this._sendTransport))}}var Bx=Object.defineProperty,Fx=Object.getOwnPropertyDescriptor,fe=(r,e,t,s)=>{for(var i=s>1?void 0:s?Fx(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&Bx(e,t,i),i};const Bv=(nE=class extends Lv{constructor(e){super();S(this,at,void 0);S(this,ye,void 0);S(this,An,void 0);S(this,Bs,void 0);f(this,"legacyMode");f(this,"roomNodeUrl");f(this,"peerDisplayName");f(this,"activatedProducingPeerIds");f(this,"logger");f(this,"_totalRejoinCount");f(this,"_transportQueue");const{roomName:t,peerId:s,authToken:i,legacyMode:n,socketClient:a,meetingTitle:o}=e;this.roomName=t,this.peerId=s,this.authToken=i,this.legacyMode=n,this.roomJoined=!1,this.meetingTitle=o,R(this,Bs,!1),R(this,at,a),R(this,ye,new Ux(a)),this.maxPreferredStreams=6,this.activatedProducingPeerIds=new Set,this.logger=ur.getLogger("HiveNodeClient()"),this._totalRejoinCount=0,this._transportQueue=new sl,L.legacySwitch(n),this.handleSocketEvents(),this.handleSFUEvents(),R(this,An,()=>{this.logger.info("noop reconnection handler")})}static async init(e){const{legacyMode:t=!0,roomName:s,peerId:i,authToken:n,meetingTitle:a,socket:o}=e,c=new Bv({legacyMode:t,authToken:n,socketClient:o,peerId:i,roomName:s,meetingTitle:a});return o.onStateEvent("disconnected",l=>{var u;c.isDisconnected=!0,(u=d(c,ye))==null||u.cleanupConsumers(),E.emit(T.ROOM_NODE_DISCONNECTED,l),c.roomJoined=!1,c.activatedProducingPeerIds=new Set,g.info("HiveNodeClient::HIVE_NODE_DISCONNECTED")}),o.onStateEvent("reconnected",async()=>{var l,u;g.info("HiveNodeClient::HIVE_NODE_RECONNECTED"),await((l=d(c,ye))==null?void 0:l.cleanupConsumers()),d(u=c,An).call(u)}),o.onStateEvent("connected",async l=>{E.emit(T.ROOM_NODE_CONNECTED,{...l,wasDisconnected:c.isDisconnected}),c.isDisconnected=!1,g.info("HiveNodeClient::HIVE_NODE_CONNECTED")}),c}get sfuHandler(){return d(this,ye)}set onSocketReconnection(e){R(this,An,e)}async reset(){this.activatedProducingPeerIds.clear(),this._transportQueue.stop(),await this.sfuHandler.stopAllTransports(),this.sfuHandler.reset(),this._transportQueue=new sl}async reconnectTransport(e){if(this.logger.info("Room joining state",d(this,Bs)),!(!e||d(this,Bs))){if(e.close(),e.removeAllListeners(),e.direction==="send"){await this.sfuHandler.setupTransports(["send"]),this.logger.info("send transport reconected!"),E.emit(T.RESET_PRODUCER_STATE);return}this.sfuHandler.cleanupConsumers(),await this.sfuHandler.setupTransports(["recv"]),this.logger.info("recv transport reconnected!"),this.activatedProducingPeerIds=new Set,E.emit(T.REFRESH_GRID,!0)}}async setupTransports(e=!1){await d(this,ye).setupTransports(["recv","send"],e)}async joinRoom(e,t,s,i,n={}){return R(this,Bs,!0),this.reset(),this._transportQueue.push(()=>this._joinRoom(e,s,n),"joinRoom")}async _joinRoom(e,t,s={}){this.peerDisplayName=e;try{return await this.sfuHandler.hiveSocketHandler.joinRoom(t,e),await this.setupTransports(!0),x.hasFeature(U.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"&&setTimeout(async()=>{var l;const a=await wt().getUserDetails(),o=re.isV2AuthToken?a.participant:a,c={userId:(l=o.id)!=null?l:o.participant.id,peerId:this.peerId,displayName:e,roomUUID:this.roomUUID,roomViewType:"groupCall",roomName:this.roomName,deviceInfo:{...he.getDeviceInfo(),userAgent:navigator.userAgent,memory:navigator.deviceMemory,cpus:navigator.hardwareConcurrency},sdkName:Ed,sdkVersion:ca,metaData:{},permissions:{}};L.roomJoined(c),s!=null&&s.audio?L.audioOn():L.audioOff(),s!=null&&s.video?L.videoOn():L.videoOff()}),{roomJoined:await this.completeJoinRoom()}}catch(i){return this.logger.error("error on sending join room request",i),{roomJoined:!1}}}async completeJoinRoom(){try{const{maxPreferredStreams:e,participants:t,roomState:s,selectedPeers:i}=await this.sfuHandler.hiveSocketHandler.notifySelfJoinComplete();this.logger.debug("peerJoinCompleteResponse",{participants:t,roomState:s,selectedPeers:i}),this.roomUUID=s.roomUuid,this.maxPreferredStreams=e;const n=t.map(l=>{const u=l.producerStates,h={id:l.peerId,isHost:!1,displayName:l.displayName,flags:{},userId:l.userId,audioMuted:!0,videoEnabled:!1,audioTrack:null,videoTrack:null,producers:[]};return u.forEach(p=>{p.kind===Br.AUDIO?h.audioMuted=p.pause:h.videoEnabled=!p.pause,h.producers.push({producerId:p.producerId,kind:p.kind===Br.AUDIO?"audio":"video",pause:p.pause,screenShare:p.screenShare})}),h}),{audioPeers:a,compulsoryPeers:o}=i!=null?i:{},c=n.filter(l=>l.id!==this.peerId);return R(this,Bs,!1),this.roomJoined=!0,g.info("HiveNodeClient::joinRoom::pre_emitasync_room_joined"),await E.emitAsync(T.ROOM_JOINED,{peers:c}),s.isRecording&&E.emit(T.HIVE_RECORDING_STARTED,s.recorderParticipantId),g.info("HiveNodeClient::joinRoom::post_emitasync_room_joined"),E.emit(T.SELF_ROOM_JOINED),E.emit(T.SELECTED_PEERS,{peerIds:a!=null?a:[],compulsoryPeers:o}),E.emit(T.REFRESH_GRID,!0),!0}catch(e){return this.logger.error("error on completing join room:",e),!1}}async leaveRoom(){await d(this,ye).stopAllTransports();const e={closeRoom:!1};d(this,at).sendMessagePromise(ve.leaveRoom,sM.toBinary(e)).then(t=>{var i;((i=jM.fromBinary(t.payload))==null?void 0:i.closed)||this.logger.warn("weird state on peer closed and should not happen")}).catch(t=>{this.logger.error("error on sending leave room request",t)}),L.callEnded(),_.destruct()}getConsumers(){return d(this,ye).consumers}async activatePeers(e){const t=e.map(({peerId:s,producers:i,force:n})=>{if(i.length===0)return Promise.resolve();if(n)return this.consumePeer(s,n);const a=[];return i.every(c=>{const l=this.sfuHandler.producerIdToConsumerIdMap.get(c.producerId);if(!l)return!1;const u=this.sfuHandler.consumers.get(l);return u&&!c.pause&&u.paused&&a.push(l),!0})?a.length>0?this.resumeConsumers(a):Promise.resolve():this.consumePeer(s)});await Promise.all(t)}async deactivatePeers(e){if(this.logger.info("deactivating producers",e),e.producers.some(s=>s.screenShare&&s.kind==="video")){this.logger.debug("peer is screensharing can't deactivate");return}e.producers.forEach(({producerId:s,kind:i})=>{if(i==="audio"){this.logger.debug("we don't want to deactive audio consumers");return}const n=this.sfuHandler.producerIdToConsumerIdMap.get(s);if(!n){this.logger.warn("consumer not found in deactivate producers:",s);return}this.sfuHandler.closeConsumer(n)}),this.activatedProducingPeerIds.delete(e.peerId)}async createConsumer({producerId:e,producingPeerId:t,screenShare:s}){return this.sfuHandler.createConsumer({producerId:e,producingPeerId:t,appData:{screenShare:s}})}async pauseConsumers(e){e.forEach(t=>{this.sfuHandler.pauseConsumer(t)})}async resumeConsumers(e){e.forEach(t=>{this.sfuHandler.resumeConsumer(t)})}async closeConsumers(e){const t=[...this.getConsumers().values()].filter(s=>e.includes(s.peerId)).map(s=>s.id);return e.forEach(s=>{this.activatedProducingPeerIds.delete(s)}),this.sfuHandler.closeConsumers(t)}async consumePeer(e,t){if(this.logger.info("current activated Peer ids",[...this.activatedProducingPeerIds.values()],"forced?:",t),!this.activatedProducingPeerIds.has(e)||t)try{await d(this,ye).consumePeer(e),this.activatedProducingPeerIds.add(e)}catch(s){this.logger.error("consumePeer failed in HiveNodeClient.ts",s)}else this.logger.info("not creating consumer for this peerId",e)}async shareWebcam(e){if(e===void 0)return;if(d(this,ye).producers.has(B.WEBCAM)){const i=d(this,ye).producers.get(B.WEBCAM);if(!i.closed&&!navigator.isReactNative){await i.replaceTrack({track:e}),await this.resumeWebcam();return}await d(this,ye).removeProducer(i.id)}const t={track:e,codecOptions:{name:"VP8"},appData:{screenShare:!1},stopTracks:!1};if(x.hasFeature(U.ENABLE_HIVE_SIMULCAST)){let i=e.getConstraints().width;i in Qg||(i=320),t.encodings=Qg[i]}const s=()=>{this.disableWebcam()};await d(this,ye).createProducer(B.WEBCAM,t,s)}async shareScreen(e){const{video:t,audio:s}=e;if(t===void 0)return;const i={track:t,codecOptions:{name:"VP8"},appData:{screenShare:!0,supportsRemoteControl:he.isElectron()},stopTracks:!1};let n=()=>{this.disableScreenShare()};if(L.screenShareRequested(),await d(this,ye).createProducer(B.SCREENSHARE_VIDEO,i,n),s){const a={track:s,codecOptions:{name:"opus"},appData:{screenShare:!0,supportsRemoteControl:he.isElectron()},stopTracks:!1};n=()=>{},await d(this,ye).createProducer(B.SCREENSHARE_AUDIO,a,n)}}async shareMic(e){try{if(e===void 0)throw new Yt("track undefined");if(d(this,ye).producers.has(B.MIC)){const i=d(this,ye).producers.get(B.MIC);if(!i.closed&&!navigator.isReactNative){await i.replaceTrack({track:e}),await this.resumeMic();return}await d(this,ye).removeProducer(B.MIC,!1)}const t={track:e,encodings:[{priority:"high"}],codecOptions:{name:"opus"},stopTracks:!1},s=()=>{this.disableMic()};await d(this,ye).createProducer(B.MIC,t,s)}catch(t){throw new w(t)}}pauseMic(){const e=d(this,ye).producers.get(B.MIC);if(!e){g.error("pauseMic::could_not_find_mic_producer");return}if(e.paused){g.info("pauseMic::mic_producer_already_paused");return}e.pause();const t={producerId:e.id,pause:!0};d(this,at).sendMessage(ve.toggleProducer,Yd.toBinary(t))}async pauseWebcam(){const e=d(this,ye).producers.get(B.WEBCAM);if(!e){g.error("pauseWebcam::could_not_find_webcam_producer");return}e.pause();const t={producerId:e.id,pause:!0};d(this,at).sendMessage(ve.toggleProducer,Yd.toBinary(t))}async resumeMic(){const e=d(this,ye).producers.get(B.MIC);if(!e){g.error("resumeMic::could_not_find_mic_producer");return}if(!e.pause){g.info("resumeMic::mic_producer_already_resumed");return}e.resume();const t={producerId:e.id,pause:!1};d(this,at).sendMessage(ve.toggleProducer,Yd.toBinary(t))}async resumeWebcam(){const e=d(this,ye).producers.get(B.WEBCAM);if(!e){g.error("resumeWebcam::could_not_find_webcam_producer");return}e.resume();const t={producerId:e.id,pause:!1};d(this,at).sendMessage(ve.toggleProducer,Yd.toBinary(t))}async disableWebcam(){await d(this,ye).removeProducer(B.WEBCAM)}async disableMic(){await d(this,ye).removeProducer(B.MIC)}async disableScreenShare(){g.info("screen_sharing_stopped"),await d(this,ye).removeProducer(B.SCREENSHARE_VIDEO),await d(this,ye).removeProducer(B.SCREENSHARE_AUDIO)}async muteSelf(){this.pauseMic()}async unmuteSelf(){await this.resumeMic()}async resetVideoProducers(e,t){e&&(await d(this,ye).removeProducer(B.WEBCAM,!1),this.shareWebcam(e)),t&&(await d(this,ye).removeProducer(B.SCREENSHARE_VIDEO,!1),this.shareScreen({video:t}))}async getPolls(){return{payload:{polls:{}}}}async changeDisplayName(e,t){const s={displayName:e,participantId:t!=null?t:this.peerId};if(!await this.sfuHandler.hiveSocketHandler.changeDisplayName(s))throw new Error("failed to change display name!")}async kick(e){const t={participantId:e};if(!await this.sfuHandler.hiveSocketHandler.kickPeer(t))throw new Error("failed to kickout the participant!")}async kickAll(){if(!await this.sfuHandler.hiveSocketHandler.kickAll())throw new Error("failed to kickout all participant!")}async muteAll(e){if(!await this.sfuHandler.hiveSocketHandler.hostControlForAll("audio"))throw new Error("failed to mute all participant")}async muteAllVideo(){if(!await this.sfuHandler.hiveSocketHandler.hostControlForAll("video"))throw new Error("failed to mute all video participant")}async mutePeer(e){if(!await this.sfuHandler.hiveSocketHandler.hostControlForPeer(e,"audio"))throw new Error("failed to mute given participant")}async mutePeerVideo(e){if(!await this.sfuHandler.hiveSocketHandler.hostControlForPeer(e,"video"))throw new Error("failed to mute video of given participant")}async pinPeer(e){const t={participantId:e!=null?e:""};try{await d(this,at).sendMessagePromise(ve.globalPinPeer,uM.toBinary(t))}catch(s){this.logger.error(`Error in pinning peer: ${s}`)}}async handleSocketEvents(){d(this,at).on(ve.peerJoinedBroadcast,({id:e,payload:t})=>{if(this.roomJoined){this.logger.debug("got peer joined with id",e);try{const{participant:{peerId:s,displayName:i,producerStates:n,userId:a}}=mN.fromBinary(t);if(s===this.peerId)return;this.logger.info("peer-joined",{peerId:s,displayName:i,producerStates:n});const o={id:s,isHost:!1,displayName:i,flags:{},userId:a,audioMuted:!0,videoEnabled:!1,audioTrack:null,videoTrack:null,producers:[]};n.forEach(c=>{c.kind===Br.AUDIO?o.audioMuted=c.pause:o.videoEnabled=!c.pause,o.producers.push({producerId:c.producerId,kind:c.kind===Br.AUDIO?"audio":"video",pause:c.pause,screenShare:c.screenShare})}),E.emit(T.PEER_JOINED,o),E.emit(T.REFRESH_GRID)}catch(s){this.logger.error("error in peer-joined-broadcast",s)}}}),d(this,at).on(ve.peerProducerCreateBroadcast,({payload:e})=>{if(this.roomJoined)try{const{participantId:t,producerState:s}=_N.fromBinary(e);if(t===this.peerId)return;this.logger.info("producer created broadcast:",t,"producer state",s),E.emit(T.NEW_PRODUCER,{peerId:t,producer:{producerId:s.producerId,kind:s.kind===Br.AUDIO?"audio":"video",pause:s.pause,screenShare:s.screenShare}})}catch(t){this.logger.error("error in peer-producer-create-broadcast",t)}}),d(this,at).on(ve.peerProducerToggleBroadcast,({payload:e})=>{if(this.roomJoined)try{const{participantId:t,producerState:{kind:s,pause:i,producerId:n}}=TN.fromBinary(e),a=s===Br.AUDIO?"audio":"video";if(this.logger.info("producer toggle broadcast:",t,"producerId",n,"kind",a,"paused",i),t===this.peerId&&i){E.emit(a==="audio"?T.MUTE_ALL:T.MUTE_ALL_VIDEO);return}E.emit(T.PRODUCER_TOGGLE,{peerId:t,producerId:n,paused:i,kind:a}),[...this.getConsumers().values()].filter(c=>c.producerId===n).forEach(c=>{c.paused!==i&&(this.logger.debug("consumer state mismatched for",c.id,". updating consumer pause state",c.paused,"to",i),i?(c.pause(),E.emit(T.CONSUMER_PAUSED,{id:c.id})):(c.resume(),E.emit(T.CONSUMER_RESUMED,{id:c.id})))})}catch(t){this.logger.error("error in producer toggle broadcast handler",t)}}),d(this,at).on(ve.selectedPeer,({payload:e})=>{if(this.roomJoined)try{const{audioPeers:t,compulsoryPeers:s}=_v.fromBinary(e);this.logger.info("selected peers:",t,s),E.emit(T.SELECTED_PEERS,{peerIds:s.concat(t)})}catch(t){this.logger.error("error in selected-peer",t)}}),d(this,at).on(ve.selectedPeerDiff,({payload:e})=>{if(this.roomJoined)try{const{entries:t}=BM.fromBinary(e);this.logger.debug("selected peers diff:",t);const s=t.map(i=>({peerId:i.peerId,priority:i.priority}));E.emit(T.SELECTED_PEERS_DIFF,{entries:s})}catch(t){this.logger.error("error in selected-peer-diff",t)}}),d(this,at).on(ve.peerLeaveBroadcast,({payload:e})=>{if(this.roomJoined)try{const{participantId:t}=wN.fromBinary(e);if(t===this.peerId){this.logger.warn("peer got kicked out of the room"),E.emit(T.KICKED);return}this.logger.info("peer left broadcast:",t),this.sfuHandler.cleanupConsumers(t),E.emit(T.PEER_CLOSED,{id:t})}catch(t){this.logger.error("error in peer left broadcast",t)}}),d(this,at).on(ve.peerProducerCloseBroadcast,({payload:e})=>{if(this.roomJoined)try{const{participantId:t,producerState:{producerId:s}}=yN.fromBinary(e);if(t===this.peerId)return;this.logger.info("producer closed broadcast:",t),E.emit(T.PRODUCER_CLOSED,{peerId:t,producerId:s});const i=this.sfuHandler.producerIdToConsumerIdMap.get(s);if(!i){this.logger.warn("no consumer found for producer",s);return}this.logger.info("closing consumer",i,"producer id ",s),this.sfuHandler.closeConsumer(i).then(()=>{this.logger.info("closed consumer",i),this.sfuHandler.producerIdToConsumerIdMap.delete(s),E.emit(T.CONSUMER_CLOSED,{id:i})}).catch(n=>{this.logger.error("error closing consumer",n)})}catch(t){this.logger.error("error on producer close broadcast",t)}}),d(this,at).on(ve.globalPeerPinBroadcast,({payload:e})=>{if(this.roomJoined)try{let t;if(e){const s=bN.fromBinary(e);this.logger.info("pinning peerId: ",s),t=s.participantId}E.emit(T.PEER_PINNED,{peerId:t})}catch(t){this.logger.error("error on global peer pin broadcast",t)}}),d(this,at).on(ve.recordingStartedBroadcast,({payload:e})=>{if(this.roomJoined)try{let t;if(e){const s=PN.fromBinary(e);this.logger.info("recording started. peerId: ",s),t=s.participantId}E.emit(T.HIVE_RECORDING_STARTED,t)}catch(t){this.logger.error("error on recording started broadcast",t)}}),d(this,at).on(ve.recordingStoppedBroadcast,({payload:e})=>{if(this.roomJoined)try{let t;if(e){const s=IN.fromBinary(e);this.logger.info("recording stopped. peerId: ",s),t=s.participantId}E.emit(T.HIVE_RECORDING_STOPPED,t)}catch(t){this.logger.error("error on recording started broadcast",t)}}),d(this,at).on(ve.peerDisplayNameEditBroadcast,({payload:e})=>{if(this.roomJoined)try{const t=ON.fromBinary(e);this.logger.debug("peer display name changed to:",t.displayName),E.emit(T.PEER_DISPLAY_NAME_CHANGED,t.participantId)}catch(t){this.logger.error("failed to handle peerDisplayNameEditBroadcast:",t)}})}handleSFUEvents(){d(this,ye).on("reconnect_transport",async e=>{try{E.emit(T.HIVE_TRANPSORT_RECONNECTING),await this._transportQueue.push(this.reconnectTransport.bind(this,e),"reconnect_transport"),this.logger.info("transport reconnected [id:%s]",e.id)}catch(t){this.logger.error("error on reconnection transports",t)}}),d(this,ye).on("rejoin",()=>{if(this._totalRejoinCount>1){this.logger.warn("cannot rejoin more already rejoined 3 times");return}if(d(this,Bs)){this.logger.warn("room joining in progress, cannot start rejoining");return}this._totalRejoinCount+=1,this.logger.warn("rejoining the room because transports are failing",{rejoinCount:this._totalRejoinCount}),E.emit(T.HIVE_ROOM_REJOINING),d(this,An).call(this)})}},at=new WeakMap,ye=new WeakMap,An=new WeakMap,Bs=new WeakMap,nE);let Z=Bv;fe([_.trace("HiveNodeClient.reset")],Z.prototype,"reset",1),fe([_.trace("HiveNodeClient.reconnect")],Z.prototype,"reconnectTransport",1),fe([_.trace("HiveNodeClient.setupTransport")],Z.prototype,"setupTransports",1),fe([_.trace("HiveNodeClient.joinRoom")],Z.prototype,"joinRoom",1),fe([_.trace("HiveNodeClient.completeJoinRoom")],Z.prototype,"completeJoinRoom",1),fe([_.trace("HiveNodeClient.leaveRoom")],Z.prototype,"leaveRoom",1),fe([_.trace("HiveNodeClient.activatePeers")],Z.prototype,"activatePeers",1),fe([_.trace("HiveNodeClient.deactivatePeers")],Z.prototype,"deactivatePeers",1),fe([_.trace("HiveNodeClient.createConsumer")],Z.prototype,"createConsumer",1),fe([_.trace("HiveNodeClient.pauseConsumers")],Z.prototype,"pauseConsumers",1),fe([_.trace("HiveNodeClient.resumeConsumers")],Z.prototype,"resumeConsumers",1),fe([_.trace("HiveNodeClient.closeConsumers")],Z.prototype,"closeConsumers",1),fe([_.trace("HiveNodeClient.consumePeer")],Z.prototype,"consumePeer",1),fe([_.trace("HiveNodeClient.shareWebcam")],Z.prototype,"shareWebcam",1),fe([_.trace("HiveNodeClient.shareScreen")],Z.prototype,"shareScreen",1),fe([_.trace("HiveNodeClient.shareMic")],Z.prototype,"shareMic",1),fe([_.trace("HiveNodeClient.pauseMic")],Z.prototype,"pauseMic",1),fe([_.trace("HiveNodeClient.pauseWebcam")],Z.prototype,"pauseWebcam",1),fe([_.trace("HiveNodeClient.resumeMic")],Z.prototype,"resumeMic",1),fe([_.trace("HiveNodeClient.resumeWebcam")],Z.prototype,"resumeWebcam",1),fe([_.trace("HiveNodeClient.disableWebcam")],Z.prototype,"disableWebcam",1),fe([_.trace("HiveClient.disableMic")],Z.prototype,"disableMic",1),fe([_.trace("HiveClient.disableScreenShare")],Z.prototype,"disableScreenShare",1),fe([_.trace("HiveNodeClient.muteSelf")],Z.prototype,"muteSelf",1),fe([_.trace("HiveNodeClient.unmuteSelf")],Z.prototype,"unmuteSelf",1),fe([_.trace("HiveNodeClient.resetVideoProducers")],Z.prototype,"resetVideoProducers",1),fe([_.trace("HiveNodeClient.getPolls")],Z.prototype,"getPolls",1),fe([_.trace("HiveNodeClient.changeDisplayName")],Z.prototype,"changeDisplayName",1),fe([_.trace("HiveNodeClient.kickPeer")],Z.prototype,"kick",1),fe([_.trace("HiveNodeClient.kickAllPeers")],Z.prototype,"kickAll",1),fe([_.trace("HiveNodeClient.muteAll")],Z.prototype,"muteAll",1),fe([_.trace("HiveNodeClient.muteAllVideo")],Z.prototype,"muteAllVideo",1),fe([_.trace("HiveNodeClient.mute")],Z.prototype,"mutePeer",1),fe([_.trace("HiveNodeClient.muteVideo")],Z.prototype,"mutePeerVideo",1),fe([_.trace("HiveNodeClient.pinPeer")],Z.prototype,"pinPeer",1),fe([_.trace("HiveNodeClient.init")],Z,"init",1);const ns=Object.create(null);ns.open="0",ns.close="1",ns.ping="2",ns.pong="3",ns.message="4",ns.upgrade="5",ns.noop="6";const cl=Object.create(null);Object.keys(ns).forEach(r=>{cl[ns[r]]=r});const Vx={type:"error",data:"parser error"},$x=typeof Blob=="function"||typeof Blob!="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Hx=typeof ArrayBuffer=="function",jx=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,Fv=({type:r,data:e},t,s)=>$x&&e instanceof Blob?t?s(e):Vv(e,s):Hx&&(e instanceof ArrayBuffer||jx(e))?t?s(e):Vv(new Blob([e]),s):s(ns[r]+(e||"")),Vv=(r,e)=>{const t=new FileReader;return t.onload=function(){const s=t.result.split(",")[1];e("b"+(s||""))},t.readAsDataURL(r)},$v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",jo=typeof Uint8Array=="undefined"?[]:new Uint8Array(256);for(let r=0;r<$v.length;r++)jo[$v.charCodeAt(r)]=r;const Gx=r=>{let e=r.length*.75,t=r.length,s,i=0,n,a,o,c;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);const l=new ArrayBuffer(e),u=new Uint8Array(l);for(s=0;s<t;s+=4)n=jo[r.charCodeAt(s)],a=jo[r.charCodeAt(s+1)],o=jo[r.charCodeAt(s+2)],c=jo[r.charCodeAt(s+3)],u[i++]=n<<2|a>>4,u[i++]=(a&15)<<4|o>>2,u[i++]=(o&3)<<6|c&63;return l},qx=typeof ArrayBuffer=="function",Hv=(r,e)=>{if(typeof r!="string")return{type:"message",data:jv(r,e)};const t=r.charAt(0);return t==="b"?{type:"message",data:Kx(r.substring(1),e)}:cl[t]?r.length>1?{type:cl[t],data:r.substring(1)}:{type:cl[t]}:Vx},Kx=(r,e)=>{if(qx){const t=Gx(r);return jv(t,e)}else return{base64:!0,data:r}},jv=(r,e)=>{switch(e){case"blob":return r instanceof ArrayBuffer?new Blob([r]):r;case"arraybuffer":default:return r}},Gv=String.fromCharCode(30),Wx=(r,e)=>{const t=r.length,s=new Array(t);let i=0;r.forEach((n,a)=>{Fv(n,!1,o=>{s[a]=o,++i===t&&e(s.join(Gv))})})},Jx=(r,e)=>{const t=r.split(Gv),s=[];for(let i=0;i<t.length;i++){const n=Hv(t[i],e);if(s.push(n),n.type==="error")break}return s},qv=4;function gt(r){if(r)return zx(r)}function zx(r){for(var e in gt.prototype)r[e]=gt.prototype[e];return r}gt.prototype.on=gt.prototype.addEventListener=function(r,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(e),this},gt.prototype.once=function(r,e){function t(){this.off(r,t),e.apply(this,arguments)}return t.fn=e,this.on(r,t),this},gt.prototype.off=gt.prototype.removeListener=gt.prototype.removeAllListeners=gt.prototype.removeEventListener=function(r,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+r];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var s,i=0;i<t.length;i++)if(s=t[i],s===e||s.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+r],this},gt.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+r],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(t){t=t.slice(0);for(var s=0,i=t.length;s<i;++s)t[s].apply(this,e)}return this},gt.prototype.emitReserved=gt.prototype.emit,gt.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]},gt.prototype.hasListeners=function(r){return!!this.listeners(r).length};const Rr=(()=>typeof self!="undefined"?self:typeof window!="undefined"?window:Function("return this")())();function Kv(r,...e){return e.reduce((t,s)=>(r.hasOwnProperty(s)&&(t[s]=r[s]),t),{})}const Yx=Rr.setTimeout,Xx=Rr.clearTimeout;function dl(r,e){e.useNativeTimers?(r.setTimeoutFn=Yx.bind(Rr),r.clearTimeoutFn=Xx.bind(Rr)):(r.setTimeoutFn=Rr.setTimeout.bind(Rr),r.clearTimeoutFn=Rr.clearTimeout.bind(Rr))}const Qx=1.33;function Zx(r){return typeof r=="string"?eU(r):Math.ceil((r.byteLength||r.size)*Qx)}function eU(r){let e=0,t=0;for(let s=0,i=r.length;s<i;s++)e=r.charCodeAt(s),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(s++,t+=4);return t}class tU extends Error{constructor(e,t,s){super(e),this.description=t,this.context=s,this.type="TransportError"}}class Wv extends gt{constructor(e){super(),this.writable=!1,dl(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,s){return super.emitReserved("error",new tU(e,t,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Hv(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}}const Jv="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),yp=64,rU={};let zv=0,ll=0,Yv;function Xv(r){let e="";do e=Jv[r%yp]+e,r=Math.floor(r/yp);while(r>0);return e}function Qv(){const r=Xv(+new Date);return r!==Yv?(zv=0,Yv=r):r+"."+Xv(zv++)}for(;ll<yp;ll++)rU[Jv[ll]]=ll;function Zv(r){let e="";for(let t in r)r.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(r[t]));return e}function sU(r){let e={},t=r.split("&");for(let s=0,i=t.length;s<i;s++){let n=t[s].split("=");e[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return e}let eT=!1;try{eT=typeof XMLHttpRequest!="undefined"&&"withCredentials"in new XMLHttpRequest}catch(r){}const iU=eT;function tT(r){const e=r.xdomain;try{if(typeof XMLHttpRequest!="undefined"&&(!e||iU))return new XMLHttpRequest}catch(t){}if(!e)try{return new Rr[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(t){}}function nU(){}const aU=function(){return new tT({xdomain:!1}).responseType!=null}();class oU extends Wv{constructor(e){if(super(e),this.polling=!1,typeof location!="undefined"){const s=location.protocol==="https:";let i=location.port;i||(i=s?"443":"80"),this.xd=typeof location!="undefined"&&e.hostname!==location.hostname||i!==e.port,this.xs=e.secure!==s}const t=e&&e.forceBase64;this.supportsBinary=aU&&!t}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let s=0;this.polling&&(s++,this.once("pollComplete",function(){--s||t()})),this.writable||(s++,this.once("drain",function(){--s||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Jx(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Wx(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let s="";this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Qv()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.opts.port&&(t==="https"&&Number(this.opts.port)!==443||t==="http"&&Number(this.opts.port)!==80)&&(s=":"+this.opts.port);const i=Zv(e),n=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(n?"["+this.opts.hostname+"]":this.opts.hostname)+s+this.opts.path+(i.length?"?"+i:"")}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new as(this.uri(),e)}doWrite(e,t){const s=this.request({method:"POST",data:e});s.on("success",t),s.on("error",(i,n)=>{this.onError("xhr post error",i,n)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,s)=>{this.onError("xhr poll error",t,s)}),this.pollXhr=e}}class as extends gt{constructor(e,t){super(),dl(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=t.async!==!1,this.data=t.data!==void 0?t.data:null,this.create()}create(){const e=Kv(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new tT(e);try{t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let s in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(s)&&t.setRequestHeader(s,this.opts.extraHeaders[s])}}catch(s){}if(this.method==="POST")try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(s){}try{t.setRequestHeader("Accept","*/*")}catch(s){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),t.onreadystatechange=()=>{t.readyState===4&&(t.status===200||t.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof t.status=="number"?t.status:0)},0))},t.send(this.data)}catch(s){this.setTimeoutFn(()=>{this.onError(s)},0);return}typeof document!="undefined"&&(this.index=as.requestsCount++,as.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if(!(typeof this.xhr=="undefined"||this.xhr===null)){if(this.xhr.onreadystatechange=nU,e)try{this.xhr.abort()}catch(t){}typeof document!="undefined"&&delete as.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}if(as.requestsCount=0,as.requests={},typeof document!="undefined"){if(typeof attachEvent=="function")attachEvent("onunload",rT);else if(typeof addEventListener=="function"){const r="onpagehide"in Rr?"pagehide":"unload";addEventListener(r,rT,!1)}}function rT(){for(let r in as.requests)as.requests.hasOwnProperty(r)&&as.requests[r].abort()}const sT=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0))(),ul=Rr.WebSocket||Rr.MozWebSocket,iT=!0,cU="arraybuffer",nT=typeof navigator!="undefined"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class dU extends Wv{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,s=nT?{}:Kv(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=iT&&!nT?t?new ul(e,t):new ul(e):new ul(e,t,s)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType||cU,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],i=t===e.length-1;Fv(s,this.supportsBinary,n=>{const a={};try{iT&&this.ws.send(n)}catch(o){}i&&sT(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws!="undefined"&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let s="";this.opts.port&&(t==="wss"&&Number(this.opts.port)!==443||t==="ws"&&Number(this.opts.port)!==80)&&(s=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=Qv()),this.supportsBinary||(e.b64=1);const i=Zv(e),n=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(n?"["+this.opts.hostname+"]":this.opts.hostname)+s+this.opts.path+(i.length?"?"+i:"")}check(){return!!ul}}const lU={websocket:dU,polling:oU},uU=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,hU=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Sp(r){const e=r,t=r.indexOf("["),s=r.indexOf("]");t!=-1&&s!=-1&&(r=r.substring(0,t)+r.substring(t,s).replace(/:/g,";")+r.substring(s,r.length));let i=uU.exec(r||""),n={},a=14;for(;a--;)n[hU[a]]=i[a]||"";return t!=-1&&s!=-1&&(n.source=e,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=pU(n,n.path),n.queryKey=fU(n,n.query),n}function pU(r,e){const t=/\/{2,9}/g,s=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function fU(r,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,i,n){i&&(t[i]=n)}),t}let aT=class ho extends gt{constructor(e,t={}){super(),this.writeBuffer=[],e&&typeof e=="object"&&(t=e,e=null),e?(e=Sp(e),t.hostname=e.host,t.secure=e.protocol==="https"||e.protocol==="wss",t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=Sp(t.host).host),dl(this,t),this.secure=t.secure!=null?t.secure:typeof location!="undefined"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location!="undefined"?location.hostname:"localhost"),this.port=t.port||(typeof location!="undefined"&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=sU(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=qv,t.transport=e,this.id&&(t.sid=this.id);const s=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new lU[e](s)}open(){let e;if(this.opts.rememberUpgrade&&ho.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)e="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else e=this.transports[0];this.readyState="opening";try{e=this.createTransport(e)}catch(t){this.transports.shift(),this.open();return}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",t=>this.onClose("transport close",t))}probe(e){let t=this.createTransport(e),s=!1;ho.priorWebsocketSuccess=!1;const i=()=>{s||(t.send([{type:"ping",data:"probe"}]),t.once("packet",h=>{if(!s)if(h.type==="pong"&&h.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;ho.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const p=new Error("probe error");p.transport=t.name,this.emitReserved("upgradeError",p)}}))};function n(){s||(s=!0,u(),t.close(),t=null)}const a=h=>{const p=new Error("probe error: "+h);p.transport=t.name,n(),this.emitReserved("upgradeError",p)};function o(){a("transport closed")}function c(){a("socket closed")}function l(h){t&&h.name!==t.name&&n()}const u=()=>{t.removeListener("open",i),t.removeListener("error",a),t.removeListener("close",o),this.off("close",c),this.off("upgrading",l)};t.once("open",i),t.once("error",a),t.once("close",o),this.once("close",c),this.once("upgrading",l),t.open()}onOpen(){if(this.readyState="open",ho.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(t+=Zx(i)),s>0&&t>this.maxPayload)return this.writeBuffer.slice(0,s);t+=2}return this.writeBuffer}write(e,t,s){return this.sendPacket("message",e,t,s),this}send(e,t,s){return this.sendPacket("message",e,t,s),this}sendPacket(e,t,s,i){if(typeof t=="function"&&(i=t,t=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const n={type:e,data:t,options:s};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},s=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}onError(e){ho.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let s=0;const i=e.length;for(;s<i;s++)~this.transports.indexOf(e[s])&&t.push(e[s]);return t}};aT.protocol=qv;function mU(r,e="",t){let s=r;t=t||typeof location!="undefined"&&location,r==null&&(r=t.protocol+"//"+t.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=t.protocol+r:r=t.host+r),/^(https?|wss?):\/\//.test(r)||(typeof t!="undefined"?r=t.protocol+"//"+r:r="https://"+r),s=Sp(r)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const n=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+n+":"+s.port+e,s.href=s.protocol+"://"+n+(t&&t.port===s.port?"":":"+s.port),s}const gU=typeof ArrayBuffer=="function",_U=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,oT=Object.prototype.toString,vU=typeof Blob=="function"||typeof Blob!="undefined"&&oT.call(Blob)==="[object BlobConstructor]",TU=typeof File=="function"||typeof File!="undefined"&&oT.call(File)==="[object FileConstructor]";function wp(r){return gU&&(r instanceof ArrayBuffer||_U(r))||vU&&r instanceof Blob||TU&&r instanceof File}function hl(r,e){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let t=0,s=r.length;t<s;t++)if(hl(r[t]))return!0;return!1}if(wp(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return hl(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&hl(r[t]))return!0;return!1}function EU(r){const e=[],t=r.data,s=r;return s.data=Rp(t,e),s.attachments=e.length,{packet:s,buffers:e}}function Rp(r,e){if(!r)return r;if(wp(r)){const t={_placeholder:!0,num:e.length};return e.push(r),t}else if(Array.isArray(r)){const t=new Array(r.length);for(let s=0;s<r.length;s++)t[s]=Rp(r[s],e);return t}else if(typeof r=="object"&&!(r instanceof Date)){const t={};for(const s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=Rp(r[s],e));return t}return r}function yU(r,e){return r.data=bp(r.data,e),delete r.attachments,r}function bp(r,e){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<e.length)return e[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let t=0;t<r.length;t++)r[t]=bp(r[t],e);else if(typeof r=="object")for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(r[t]=bp(r[t],e));return r}const SU=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],wU=5;var ge;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(ge||(ge={}));class RU{constructor(e){this.replacer=e}encode(e){return(e.type===ge.EVENT||e.type===ge.ACK)&&hl(e)?this.encodeAsBinary({type:e.type===ge.EVENT?ge.BINARY_EVENT:ge.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===ge.BINARY_EVENT||e.type===ge.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=EU(e),s=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(s),i}}function cT(r){return Object.prototype.toString.call(r)==="[object Object]"}class Cp extends gt{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const s=t.type===ge.BINARY_EVENT;s||t.type===ge.BINARY_ACK?(t.type=s?ge.EVENT:ge.ACK,this.reconstructor=new bU(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(wp(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const s={type:Number(e.charAt(0))};if(ge[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===ge.BINARY_EVENT||s.type===ge.BINARY_ACK){const n=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const a=e.substring(n,t);if(a!=Number(a)||e.charAt(t)!=="-")throw new Error("Illegal attachments");s.attachments=Number(a)}if(e.charAt(t+1)==="/"){const n=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););s.nsp=e.substring(n,t)}else s.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const n=t+1;for(;++t;){const a=e.charAt(t);if(a==null||Number(a)!=a){--t;break}if(t===e.length)break}s.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){const n=this.tryParse(e.substr(t));if(Cp.isPayloadValid(s.type,n))s.data=n;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case ge.CONNECT:return cT(t);case ge.DISCONNECT:return t===void 0;case ge.CONNECT_ERROR:return typeof t=="string"||cT(t);case ge.EVENT:case ge.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&SU.indexOf(t[0])===-1);case ge.ACK:case ge.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class bU{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=yU(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const CU=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Cp,Encoder:RU,get PacketType(){return ge},protocol:wU},Symbol.toStringTag,{value:"Module"}));function Fr(r,e,t){return r.on(e,t),function(){r.off(e,t)}}const PU=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class dT extends gt{constructor(e,t,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Fr(e,"open",this.onopen.bind(this)),Fr(e,"packet",this.onpacket.bind(this)),Fr(e,"error",this.onerror.bind(this)),Fr(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(PU.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const s={type:ge.EVENT,data:t};if(s.options={},s.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const a=this.ids++,o=t.pop();this._registerAckCallback(a,o),s.id=a}const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!i||!this.connected)||(this.connected?(this.notifyOutgoingListeners(s),this.packet(s)):this.sendBuffer.push(s)),this.flags={},this}_registerAckCallback(e,t){var s;const i=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const n=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},i);this.acks[e]=(...a)=>{this.io.clearTimeoutFn(n),t.apply(this,[null,...a])}}emitWithAck(e,...t){const s=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((i,n)=>{t.push((a,o)=>s?a?n(a):i(o):i(a)),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...n)=>s!==this._queue[0]?void 0:(i!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...n)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:ge.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case ge.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case ge.EVENT:case ge.BINARY_EVENT:this.onevent(e);break;case ge.ACK:case ge.BINARY_ACK:this.onack(e);break;case ge.DISCONNECT:this.ondisconnect();break;case ge.CONNECT_ERROR:this.destroy();const s=new Error(e.data.message);s.data=e.data.data,this.emitReserved("connect_error",s);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const s of t)s.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let s=!1;return function(...i){s||(s=!0,t.packet({type:ge.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:ge.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const s of t)s.apply(this,e.data)}}}function Sa(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}Sa.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*r);r=Math.floor(e*10)&1?r+t:r-t}return Math.min(r,this.max)|0},Sa.prototype.reset=function(){this.attempts=0},Sa.prototype.setMin=function(r){this.ms=r},Sa.prototype.setMax=function(r){this.max=r},Sa.prototype.setJitter=function(r){this.jitter=r};class Pp extends gt{constructor(e,t){var s;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,dl(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((s=t.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new Sa({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||CU;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new aT(this.uri,this.opts);const t=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=Fr(t,"open",function(){s.onopen(),e&&e()}),n=Fr(t,"error",a=>{s.cleanup(),s._readyState="closed",this.emitReserved("error",a),e?e(a):s.maybeReconnectOnOpen()});if(this._timeout!==!1){const a=this._timeout;a===0&&i();const o=this.setTimeoutFn(()=>{i(),t.close(),t.emit("error",new Error("timeout"))},a);this.opts.autoUnref&&o.unref(),this.subs.push(function(){clearTimeout(o)})}return this.subs.push(i),this.subs.push(n),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Fr(e,"ping",this.onping.bind(this)),Fr(e,"data",this.ondata.bind(this)),Fr(e,"error",this.onerror.bind(this)),Fr(e,"close",this.onclose.bind(this)),Fr(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){sT(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let s=this.nsps[e];return s?this._autoConnect&&!s.active&&s.connect():(s=new dT(this,e,t),this.nsps[e]=s),s}_destroy(e){const t=Object.keys(this.nsps);for(const s of t)if(this.nsps[s].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let s=0;s<t.length;s++)this.engine.write(t[s],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&s.unref(),this.subs.push(function(){clearTimeout(s)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Go={};function pl(r,e){typeof r=="object"&&(e=r,r=void 0),e=e||{};const t=mU(r,e.path||"/socket.io"),s=t.source,i=t.id,n=t.path,a=Go[i]&&n in Go[i].nsps,o=e.forceNew||e["force new connection"]||e.multiplex===!1||a;let c;return o?c=new Pp(s,e):(Go[i]||(Go[i]=new Pp(s,e)),c=Go[i]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(pl,{Manager:Pp,Socket:dT,io:pl,connect:pl});var os=(r=>(r.SOCKET_CONNECTED="SOCKET_CONNECTED",r.SOCKET_DISCONNECTED="SOCKET_DISCONNECTED",r.SOCKET_CONNECTION_ERROR="SOCKET_CONNECTION_ERROR",r.SOCKET_MESSAGE="SOCKET_MESSAGE",r))(os||{}),qo=(r=>(r[r.NOT_STARTED=0]="NOT_STARTED",r[r.CONNECTED=1]="CONNECTED",r[r.DISCONNECTED=2]="DISCONNECTED",r[r.ERRORED=3]="ERRORED",r))(qo||{}),AU=Object.defineProperty,IU=Object.getOwnPropertyDescriptor,fl=(r,e,t,s)=>{for(var i=s>1?void 0:s?IU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&AU(e,t,i),i};const kU="event://server-simple-message",OU="event://send-message";class Ko extends Jt{constructor(t){super();f(this,"socket");f(this,"socketState");f(this,"callbackHandler",null);this.socketState=qo.NOT_STARTED,t.callbackHandler&&(this.callbackHandler=t.callbackHandler)}connect(t){this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect()),this.socket=pl(t,{closeOnBeforeunload:!1}),this.setupSocket()}disconnect(){this.socket.disconnect()}reconnect(){this.socket.connect()}setupSocket(){this.socket.on("disconnect",t=>{this.socketState=qo.DISCONNECTED,g.warn("SocketClient::socket_disconnected",{error:{reason:t}}),this.emit(os.SOCKET_DISCONNECTED,{reason:t})}),this.socket.on("connect_error",t=>{this.socketState=qo.ERRORED,x.hasFeature(U.SOCKET_POLLING)&&(this.socket.io.opts.transports=["polling","websocket"]),g.error("SocketClient::socket_connection_errored",{error:t}),this.emit(os.SOCKET_CONNECTION_ERROR,{err:t})}),this.socket.on("connect",()=>{this.socketState=qo.CONNECTED,g.info("SocketClient::socket_connected"),this.emit(os.SOCKET_CONNECTED)}),this.socket.on(kU,async(t,s)=>{const i=JSON.parse(t);if((!_.logExclusionList.includes(i==null?void 0:i.type)||x.hasFeature(U.BYPASS_LOG_EXCLUSION_LIST))&&g.info(`SocketClient::SIMPLE_SERVER_MESSAGE_EVENT::${i==null?void 0:i.type}`),s){let n="OK";this.callbackHandler&&(n=await this.callbackHandler(i)),s(n)}else this.emit(os.SOCKET_MESSAGE,i);Object.values(T).find(n=>n===i.type)&&E.emit(i.type,i.payload)})}async sendMessage(t){return(!_.logExclusionList.includes(t==null?void 0:t.type)||x.hasFeature(U.BYPASS_LOG_EXCLUSION_LIST))&&g.info(`SocketClient::sendMessage::${t==null?void 0:t.type}`),Object.assign(t,{metadata:t.metadata||{}}),_.injectContext(t.metadata),new Promise(s=>{this.socket.emit(OU,JSON.stringify(t),i=>{if(!i){s(void 0);return}const n=JSON.parse(i);s(n)})})}}fl([_.trace("SocketClient.connect")],Ko.prototype,"connect",1),fl([_.trace("SocketClient.disconnect")],Ko.prototype,"disconnect",1),fl([_.trace("SocketClient.reconnect")],Ko.prototype,"reconnect",1),fl([_.trace("SocketClient.setupSocket")],Ko.prototype,"setupSocket",1);const Jl=class{constructor(e=1e3){S(this,Kl);S(this,Wl);f(this,"sendTransport");f(this,"recvTransport");f(this,"collectStpStats");f(this,"collectRtpStats");f(this,"pingInterval");this.pingInterval=e}initSendTransport(e){this.sendTransport=e,E.emit(T.SEND_TRANSPORT_CREATED)}initRecvTransport(e){this.recvTransport=e,E.emit(T.RECV_TRANSPORT_CREATED)}collectSendTransportStats(){return!this.sendTransport||this.collectStpStats?!1:(this.collectStpStats=setInterval(be(this,Kl,XE).bind(this),this.pingInterval),!0)}collectRecvTransportStats(){return!this.recvTransport||this.collectRtpStats?!1:(this.collectRtpStats=setInterval(be(this,Wl,QE).bind(this),this.pingInterval),!0)}stopStatsCollection(e){return e==="send"?(clearInterval(this.collectStpStats),this.collectStpStats=void 0,!0):e==="receive"?(clearInterval(this.collectRtpStats),this.collectRtpStats=void 0,!0):!1}cleanup(e){this.stopStatsCollection(e),e==="send"?(this.sendTransport=void 0,this.collectStpStats=void 0,E.emit(T.SEND_TRANSPORT_CLOSED)):(this.recvTransport=void 0,this.collectRtpStats=void 0,E.emit(T.RECV_TRANSPORT_CLOSED))}};let ml=Jl;Kl=new WeakSet,XE=function(){this.sendTransport||this.stopStatsCollection("send"),this.sendTransport.getStats().then(e=>{var t;return be(t=Jl,Tc,hf).call(t,e,"send")})},Wl=new WeakSet,QE=function(){this.recvTransport||this.stopStatsCollection("receive"),this.recvTransport.getStats().then(e=>{var t;return be(t=Jl,Tc,hf).call(t,e,"receive")})},Tc=new WeakSet,hf=function(e,t){e.forEach(s=>{s.type==="candidate-pair"&&E.emit(T.CANDIDATE_PEER_UPDATE,{...s,transport:t}),s.type==="inbound-rtp"&&E.emit(T.INBOUND_RTP_UPDATE,{...s,transport:t}),s.type==="outbound-rtp"&&E.emit(T.OUTBOUND_RTP_UPDATE,{...s,transport:t})})},S(ml,Tc);const ai=new ml;var DU=Object.defineProperty,MU=Object.getOwnPropertyDescriptor,ir=(r,e,t,s)=>{for(var i=s>1?void 0:s?MU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&DU(e,t,i),i};class Xt extends Jt{constructor(t,s){super();f(this,"device");f(this,"sendTransport");f(this,"recvTransport");f(this,"sendTransportIceStateDisconnectTime");f(this,"recvTransportIceStateDisconnectTime");f(this,"producerCreationStatus");f(this,"consumers");f(this,"producers");f(this,"socketClient");f(this,"iceRestartInProgress");this.producers=new Map,this.consumers=new Map,this.producerCreationStatus=new Map,this.iceRestartInProgress={sendTransport:!1,recvTransport:!1},s!==void 0?this.device=s:this.device=new Hg,this.socketClient=t}async setupTransports(){const s=await wt().getICEServers();await this.loadRouter(),await Promise.all([this.createRecvTransport(s),this.createSendTransport(s)])}async loadRouter(){(this.recvTransport||this.sendTransport)&&await this.stopAllTransports()}getRTPCapabilities(){return this.device.rtpCapabilities}async createRecvTransport(t){if(!this.socketClient)return;const s={forceTcp:!1,producing:!1,consuming:!0},i=(await this.socketClient.sendMessage({type:"createWebRtcTransport",payload:s})).payload;if(g.info("recvTransport::initializing_transport"),this.recvTransport=this.device.createRecvTransport({...i,iceServers:t,proprietaryConstraints:Xg}),ai.initRecvTransport(this.recvTransport),g.info("recvTransport::initialized_transport"),L.onSafeInitialization(()=>{L.configureRecvTransport(this.recvTransport)}),this.recvTransport.on("connect",async({dtlsParameters:n},a,o)=>{var l,u,h,p;const c=await this.socketClient.sendMessage({type:"connectWebRtcTransport",payload:{transportId:this.recvTransport.id,dtlsParameters:n}});(l=c.payload)!=null&&l.error?(g.error("recvTransport::transport_status",{error:(h=c.payload)==null?void 0:h.error,transport:{id:(p=this==null?void 0:this.recvTransport)==null?void 0:p.id,status:"failed",type:"recv"}}),o(new Error("failed"))):(a(),g.info("recvTransport::transport_status",{transport:{id:(u=this==null?void 0:this.recvTransport)==null?void 0:u.id,status:"connected",type:"recv"}}))}),x.hasFeature(U.ENABLE_ICE_STATE_LOGGING)){g.info("enabling_ice_state_logging_for_recv_transport");let n;this.recvTransport.on("connectionstatechange",async a=>{var o,c,l,u,h,p,m,v;switch(g.info("recvTransport::connection_state_change",{transport:{id:(o=this==null?void 0:this.recvTransport)==null?void 0:o.id,status:a,type:"recv"}}),a){case"failed":if(E.emit(T.ICE_FAILED,{transport:"recv"}),g.warn("recvTransport::ice_state_failed"),x.hasFeature(U.ICE_RESTART_ON_FAILED_STATE))try{await this.restartIceTillSuccess(this.recvTransport)}catch(y){g.error("recvTransport::ice_restart_failed",{error:y,transport:{id:(c=this==null?void 0:this.recvTransport)==null?void 0:c.id,status:"failed",type:"recv"}})}break;case"disconnected":E.emit(T.ICE_DISCONNECTED,{transport:"recv"}),g.warn("recvTransport::ice_state_disconnected"),this.recvTransportIceStateDisconnectTime&&g.warn("recvTransport::ice_state_disconnected_again",{transport:{id:(l=this==null?void 0:this.recvTransport)==null?void 0:l.id,status:"disconnected",type:"recv",lastDisconnectedTime:(u=this.recvTransportIceStateDisconnectTime)==null?void 0:u.toISOString(),lastDisconnectedTimeOffset:(h=this.recvTransportIceStateDisconnectTime)==null?void 0:h.getTimezoneOffset(),durationPassed:new Date().getTime()-this.recvTransportIceStateDisconnectTime.getTime()}}),this.recvTransportIceStateDisconnectTime=new Date;try{n=x.getValue(U.ICE_RESTART_ON_DISCONNECTED_STATE),typeof n!="number"&&(n=void 0)}catch(y){n=void 0}n&&setTimeout(async()=>{var y,C,k,D,V;if(this.recvTransportIceStateDisconnectTime!==void 0){E.emit(T.ICE_RECONNECTING,{transport:"recv"}),g.info("recvTransport::attempting_ice_restart",{transport:{id:(y=this==null?void 0:this.recvTransport)==null?void 0:y.id,type:"recv",status:"reconnecting",lastDisconnectedTime:(C=this.recvTransportIceStateDisconnectTime)==null?void 0:C.toISOString(),lastDisconnectedTimeOffset:(k=this.recvTransportIceStateDisconnectTime)==null?void 0:k.getTimezoneOffset()},iceRestart:{isSendTransport:(D=this==null?void 0:this.iceRestartInProgress)==null?void 0:D.sendTransport,isRecvTransport:(V=this==null?void 0:this.iceRestartInProgress)==null?void 0:V.recvTransport}});try{await this.restartIceTillSuccess(this.recvTransport)}catch(M){g.info("SFUHandler.disconnected.restartIceFailed",{error:M,iceRestart:{status:"failed",isRecvTransport:!0}})}}},n);break;case"connected":E.emit(T.ICE_CONNECTED,{transport:"recv"}),g.info("recvTransport::ice_state_connected",{transport:{id:(p=this==null?void 0:this.recvTransport)==null?void 0:p.id,type:"recv",status:"connected",lastDisconnectedTime:(m=this.recvTransportIceStateDisconnectTime)==null?void 0:m.toISOString(),lastDisconnectedTimeOffset:(v=this.recvTransportIceStateDisconnectTime)==null?void 0:v.getTimezoneOffset(),durationPassed:this.recvTransportIceStateDisconnectTime?new Date().getTime()-this.recvTransportIceStateDisconnectTime.getTime():null}}),this.recvTransportIceStateDisconnectTime=void 0;break}})}this.recvTransport.observer.on("close",()=>{this.recvTransport=void 0,ai.cleanup("receive"),g.warn("recvTransport_closed")})}async createSendTransport(t){const s={forceTcp:!1,producing:!0,consuming:!1},i=(await this.socketClient.sendMessage({type:"createWebRtcTransport",payload:s})).payload;if(g.info("sendTransport::initializing_transport"),this.sendTransport=this.device.createSendTransport({...i,iceServers:t,proprietaryConstraints:Xg}),ai.initSendTransport(this.sendTransport),g.info("sendTransport::initialized_transport"),L.onSafeInitialization(()=>{L.configureSendTransport(this.sendTransport)}),this.sendTransport.on("connect",async({dtlsParameters:n},a,o)=>{var l,u,h,p;(u=(await this.socketClient.sendMessage({type:"connectWebRtcTransport",payload:{transportId:(l=this.sendTransport)==null?void 0:l.id,dtlsParameters:n}})).payload)!=null&&u.error?(g.error("sendTransport::transport_status",{transport:{id:(p=this==null?void 0:this.sendTransport)==null?void 0:p.id,status:"failed",type:"send"}}),o(new Error("failed"))):(g.info("sendTransport::transport_status",{transport:{id:(h=this==null?void 0:this.sendTransport)==null?void 0:h.id,status:"connected",type:"send"}}),a())}),this.sendTransport.on("produce",async({kind:n,rtpParameters:a,appData:o},c,l)=>{var h,p,m,v,y,C;const u=await this.socketClient.sendMessage({type:"produce",payload:{transportId:(h=this.sendTransport)==null?void 0:h.id,kind:n,rtpParameters:a,appData:o}});(p=u.payload)!=null&&p.error?(g.info("sendTransport::producer_status::failed",{producer:{kind:n,appData:o,status:"failed",id:(y=u==null?void 0:u.payload)==null?void 0:y.id}}),l((C=u.payload)==null?void 0:C.error)):(g.info("sendTransport::producer_status::producing",{producer:{kind:n,appData:o,status:"producing",id:(m=u==null?void 0:u.payload)==null?void 0:m.id}}),c({id:(v=u.payload)==null?void 0:v.id}))}),x.hasFeature(U.ENABLE_ICE_STATE_LOGGING)){g.info("Enabling ice state logging for send transport");let n;this.sendTransport.on("connectionstatechange",async a=>{var o,c,l,u;switch(g.info("sendTransport::connection_state_change",{transport:{id:(o=this==null?void 0:this.sendTransport)==null?void 0:o.id,status:a,type:"send"}}),a){case"failed":if(E.emit(T.ICE_FAILED,{transport:"send"}),g.warn("sendTransport::ice_state_failed"),x.hasFeature(U.ICE_RESTART_ON_FAILED_STATE))try{await this.restartIceTillSuccess(this.sendTransport)}catch(h){g.error("sendTransport::ice_restart_failed",{error:h})}break;case"disconnected":E.emit(T.ICE_DISCONNECTED,{transport:"send"}),g.warn("sendTransport::ice_state_disconnected"),this.sendTransportIceStateDisconnectTime&&g.warn("sendTransport::ice_state_disconnected_again",{transport:{id:(c=this==null?void 0:this.sendTransport)==null?void 0:c.id,status:"disconnected",lastDisconnectedTime:this.sendTransportIceStateDisconnectTime.toLocaleTimeString(),durationPassed:new Date().getTime()-this.sendTransportIceStateDisconnectTime.getTime(),type:"send"}}),this.sendTransportIceStateDisconnectTime=new Date;try{n=x.getValue(U.ICE_RESTART_ON_DISCONNECTED_STATE),typeof n!="number"&&(n=void 0)}catch(h){n=void 0}n&&setTimeout(async()=>{var h,p,m,v;if(this.sendTransportIceStateDisconnectTime!==void 0){E.emit(T.ICE_RECONNECTING,{transport:"send"}),g.info("sendTransport::attempting_ice_restart",{transport:{id:(h=this==null?void 0:this.sendTransport)==null?void 0:h.id,status:"reconnecting",type:"send",lastDisconnectedTime:(p=this.sendTransportIceStateDisconnectTime)==null?void 0:p.toISOString(),lastDisconnectedTimeOffset:(m=this.sendTransportIceStateDisconnectTime)==null?void 0:m.getTimezoneOffset()},iceRestart:{status:"connecting"}});try{await this.restartIceTillSuccess(this.sendTransport)}catch(y){g.info("SFUHandler.disconnected.restartIceFailed",{error:y,transport:{id:(v=this==null?void 0:this.sendTransport)==null?void 0:v.id,type:"send",status:"failed"}})}}},n);break;case"connected":E.emit(T.ICE_CONNECTED,{transport:"send"}),g.info("sendTransport::ice_state_connected",{transport:{id:(l=this==null?void 0:this.sendTransport)==null?void 0:l.id,type:"send",status:"connected",lastDisconnectedTime:(u=this.sendTransportIceStateDisconnectTime)==null?void 0:u.toLocaleTimeString(),durationPassed:this.sendTransportIceStateDisconnectTime?new Date().getTime()-this.sendTransportIceStateDisconnectTime.getTime():null}}),this.sendTransportIceStateDisconnectTime=void 0;break}})}this.sendTransport.observer.on("close",()=>{this.sendTransport=void 0,ai.cleanup("send"),g.warn("sendTransport_closed")})}async restartIce(t){const{direction:s}=t;if(!(s==="recv"?this.iceRestartInProgress.recvTransport:this.iceRestartInProgress.sendTransport)){s==="recv"?this.iceRestartInProgress.recvTransport=!0:this.iceRestartInProgress.sendTransport=!0;try{const n=(await this.socketClient.sendMessage({type:"restartIce",payload:{transportId:t.id}})).payload;await t.restartIce(n)}catch(n){g.error("SFUHandler.restartIce.Failed",{error:n,iceRestart:{status:"failed"},transport:{id:t==null?void 0:t.id,status:"failed",type:s}})}s==="recv"?this.iceRestartInProgress.recvTransport=!1:this.iceRestartInProgress.sendTransport=!1}}async createConsumer(t){if(this.recvTransport===void 0||this.recvTransport.closed)return;const{peerId:s,producerId:i,id:n,kind:a,rtpParameters:o,appData:c,remotelyPaused:l}=t;g.info("createConsumer::initializing_consumer",{consumer:{id:n,peerId:s,kind:a,appData:c,remotelyPaused:l,producerId:i}});const u=await this.recvTransport.consume({id:n,producerId:i,kind:a,rtpParameters:o,appData:{...c,peerId:s}});g.info("createConsumer::initialized_consumer",{consumer:{id:u.id,peerId:s,kind:a,appData:c,remotelyPaused:l,producerId:i}});const h=u;h.peerId=s,h.remotelyPaused=l,h.score=10,this.consumers.set(u.id,h)}async closeConsumer(t){const{id:s}=t,i=this.consumers.get(s);i&&(g.info("SFUHandler::close_consumer",{consumer:i}),i.close(),this.consumers.delete(s))}async cleanupConsumers(){var t;(t=this.consumers)==null||t.forEach(s=>{E.emit(T.CONSUMER_CLOSED,{id:s.id}),this.closeConsumer({id:s.id})})}async pauseConsumer(t){const{id:s}=t,i=this.consumers.get(s);i&&i.pause()}async resumeConsumer(t){const{id:s}=t,i=this.consumers.get(s);i&&i.resume()}async createProducer(t,s,i){if(this.sendTransport===void 0||this.sendTransport.closed)return;if(g.info("createProducer::initializing_producer",{producer:{id:"TO_BE_CREATED",kind:t,status:"initializing",appData:s==null?void 0:s.appData}}),this.producerCreationStatus.get(t)&&this.producerCreationStatus.get(t)==="INITIALIZING"){g.info("createProducer::producer getting initializing",{producer:{id:"GETTING_CREATED",status:"initializing",kind:t,appData:s==null?void 0:s.appData}});return}this.producerCreationStatus.set(t,"INITIALIZING");const n=await Promise.race([this.sendTransport.produce(s),new Promise(o=>setTimeout(()=>o(void 0),6e3))]);if(!n)throw g.error("createProducer::transport_initialization_timed_out",{producer:{id:"FAILED_TO_CREATE",kind:t,status:"failed",appData:s==null?void 0:s.appData}}),this.producerCreationStatus.set(t,"NOT_INITIALIZED"),new w(`Producer Creation timed out! ${t}`);this.producerCreationStatus.set(t,"INITIALIZED"),g.info("createProducer::initialized_producer",{producer:{id:n==null?void 0:n.id,kind:t,status:"UNKNOWN",appData:s==null?void 0:s.appData}}),n.on("transportclose",()=>{g.info("producer::transportclose",{producer:{id:n==null?void 0:n.id,kind:t,status:"UNKNOWN",appData:s==null?void 0:s.appData}}),this.producerCreationStatus.set(t,"NOT_INITIALIZED"),this.producers.delete(t)}),n.on("trackended",()=>{E.emit(T.PRODUCER_TRACK_ENDED,{kind:t}),g.info("producer::trackended",{producer:{id:n==null?void 0:n.id,kind:t,status:"UNKNOWN",appData:s==null?void 0:s.appData}}),[B.MIC,B.WEBCAM].includes(t)||i()});const a=n;a.score=10,this.producers.set(t,a),await this.reconfigureWebcamLayers(),await this.reconfigureSafariScreenshareLayers()}async removeProducer(t,s=!0){const i=this.producers.get(t);!i||i.closed||(g.info("SFUHandler::remove_producer",{producer:{id:i==null?void 0:i.id,kind:t,status:"UNKNOWN",appData:i==null?void 0:i.appData},debuggingHint:`stopTrack was ${s}`}),s&&i.track.stop(),i.close(),await this.socketClient.sendMessage({type:"closeProducer",payload:{producerId:i.id}}),this.producerCreationStatus.set(t,"NOT_INITIALIZED"),this.producers.delete(t),await this.reconfigureWebcamLayers())}stopAllProducers(){Array.from(this.producers.keys()).forEach(t=>{this.removeProducer(t)})}async stopAllTransports(){if(this.sendTransport){try{this.sendTransport.close()}catch(t){g.error("stopAllTransports",{error:t})}this.sendTransport=void 0}if(this.recvTransport){try{this.recvTransport.close()}catch(t){g.error("SFUHandler::stopAllTransports::error",t)}this.recvTransport=void 0}}async reconfigureWebcamLayers(){if(!x.hasFeature(U.DISABLE_WEBCAM_LAYERS_ON_SCREENSHARE))return;const t=this.producers.get(B.WEBCAM);t&&await t.setMaxSpatialLayer(this.producers.get(B.SCREENSHARE_VIDEO)?0:1)}async reconfigureSafariScreenshareLayers(){if(!x.hasFeature(U.SCREENSHARE_SIMULCAST)||!he.isSafari())return;const t=this.producers.get(B.SCREENSHARE_VIDEO);if(!t)return;const s=t.rtpSender.getParameters();s.encodings=WP,t.rtpSender.setParameters(s)}async restartIceTillSuccess(t,s=3){let i=!1,n=0;for(;!i&&n<s;)try{g.info("SFUHandler.restartIceTillSuccess.AttemptRestart",{iceRestart:{currentAttempt:n,isSendTransport:t.direction==="send",isRecvTransport:t.direction==="recv"}}),await this.restartIce(t),i=!0}catch(a){n+=1}if(!i)throw new w("Failed to restart Ice")}}ir([_.trace("SFUHandler.setupTransports")],Xt.prototype,"setupTransports",1),ir([_.trace("SFUHandler.loadRouter")],Xt.prototype,"loadRouter",1),ir([_.trace("SFUHandler.createRecvTransport")],Xt.prototype,"createRecvTransport",1),ir([_.trace("SFUHandler.createSendTransport")],Xt.prototype,"createSendTransport",1),ir([_.trace("SFUHandler.restartIce")],Xt.prototype,"restartIce",1),ir([_.trace("SFUHandler.createConsumer")],Xt.prototype,"createConsumer",1),ir([_.trace("SFUHandler.closeConsumer")],Xt.prototype,"closeConsumer",1),ir([_.trace("SFUHandler.cleanupConsumers")],Xt.prototype,"cleanupConsumers",1),ir([_.trace("SFUHandler.pauseConsumer")],Xt.prototype,"pauseConsumer",1),ir([_.trace("SFUHandler.resumeConsumer")],Xt.prototype,"resumeConsumer",1),ir([_.trace("SFUHandler.createProducer")],Xt.prototype,"createProducer",1),ir([_.trace("SFUHandler.removeProducer")],Xt.prototype,"removeProducer",1),ir([_.trace("SFUHandler.stopAllProducers")],Xt.prototype,"stopAllProducers",1),ir([_.trace("SFUHandler.stopAllTransports")],Xt.prototype,"stopAllTransports",1);class Ke extends Jt.EventEmitter{emit(e,...t){return super.emit("*",e,...t),super.emit(e,...t)}on(e,t){return super.on(e,t)}addListener(e,t){return super.addListener(e,t)}off(e,t){return super.off(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeListener(e,t){return super.removeListener(e,t)}removeAllListeners(e){return super.removeAllListeners(e)}listeners(e){return super.listeners(e)}listenerCount(e){return super.listenerCount(e)}}var NU=Object.defineProperty,LU=Object.getOwnPropertyDescriptor,xU=(r,e,t,s)=>{for(var i=s>1?void 0:s?LU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&NU(e,t,i),i},Cs=(r=>(r.REQUEST="REQUEST",r.ACCEPT="ACCEPT",r.REJECT="REJECT",r.END="END",r.EVENT="EVENT",r))(Cs||{}),wa=(r=>(r.PENDING="PENDING",r.ACCEPTED="ACCEPTED",r.REJECTED="REJECTED",r.ENDED="ENDED",r))(wa||{}),Wo=(r=>(r.KEYBOARD="KEYBOARD",r.MOUSE="MOUSE",r))(Wo||{}),gl=(r=>(r.LEFT_CLICK="click",r.RIGHT_CLICK="contextmenu",r.MOVE="mousemove",r))(gl||{}),Ps=(r=>(r.REQUEST_RECEIVED="REQUEST_RECEIVED",r.REQUEST_SENT="REQUEST_SENT",r.INCOMING_REQUEST_ACCEPTED="INCOMING_REQUEST_ACCEPTED",r.OUTGOING_REQUEST_ACCEPTED="OUTGOING_REQUEST_ACCEPTED",r.INCOMING_REQUEST_ENDED="INCOMING_REQUEST_ENDED",r.OUTGOING_REQUEST_ENDED="OUTGOING_REQUEST_ENDED",r))(Ps||{});let Jo=class extends Ke{constructor(e){super();f(this,"id");f(this,"remotePeerId");f(this,"hostPeerId");f(this,"state");const{remotePeerId:t,requestId:s,hostPeerId:i,state:n}=e;this.id=s,this.remotePeerId=t,this.hostPeerId=i,this.state=n}};Jo=xU([Bt(r=>{throw new w(r.message,"1400")})],Jo);var UU=Object.defineProperty,BU=Object.getOwnPropertyDescriptor,nr=(r,e,t,s)=>{for(var i=s>1?void 0:s?BU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&UU(e,t,i),i};const Ap=(aE=class extends Lv{constructor(e){super();S(this,de,void 0);f(this,"isV2AuthToken");S(this,Si,void 0);f(this,"legacyMode");f(this,"roomNodeUrl");f(this,"peerDisplayName");const{roomName:t,roomNodeUrl:s,peerId:i,authToken:n,legacyMode:a,socketClient:o,meetingTitle:c}=e;this.roomName=t,this.roomNodeUrl=s,this.peerId=i,this.authToken=n,this.legacyMode=a,R(this,de,o),this.roomJoined=!1,this.meetingTitle=c,this.isV2AuthToken=re.isV2AuthToken,R(this,Si,new Xt(o,e.device)),L.legacySwitch(a);let l=0;const u=async({err:h})=>{var C;this.isDisconnected=!0,(C=this.sfuHandler)==null||C.cleanupConsumers(),E.emit(T.ROOM_NODE_CONNECTION_ERROR,h),this.roomJoined=!1,g.error("RoomNodeClient::ROOM_NODE_CONNECTION_ERROR",h);const p=re.isV2AuthToken?re.meetingId:t,m=wt(),{roomNodeUrl:v}=await m.getRoomNodeData({roomName:p,peerId:i}),y=`${v}?roomURL=${t}&peerId=${i}&authToken=${n}&version=0.5.0`;l+=1,!(l>3)&&(g.log("RoomNodeClient::SocketReconnection",{socket:{retryAttempt:l}}),d(this,de).connect(y),Y_({...re.roomNodeOptions,roomNodeUrl:v}),this.roomNodeUrl=v)};o.removeListener(os.SOCKET_CONNECTION_ERROR,u.bind(this)),o.on(os.SOCKET_CONNECTION_ERROR,u.bind(this))}static async init(e){const{legacyMode:t=!0,roomName:s,peerId:i,authToken:n,meetingTitle:a,device:o}=e;let c;const l=`${e.roomNodeUrl}?roomURL=${s}&peerId=${i}&authToken=${n}&version=0.5.0`,u=new Ko({callbackHandler:async h=>{await c.handleSocketCallbacks(h)}});return u.on(os.SOCKET_MESSAGE,async(h,p)=>{await c.handleSockets(h,p)}),u.connect(l),c=new Ap({legacyMode:t,authToken:n,peerId:i,roomName:s,roomNodeUrl:l,socketClient:u,meetingTitle:a,device:o}),u.on(os.SOCKET_DISCONNECTED,h=>{var p,m;c.isDisconnected=!0,(p=c.sfuHandler)==null||p.cleanupConsumers(),(m=c.sfuHandler)==null||m.stopAllTransports(),E.emit(T.ROOM_NODE_DISCONNECTED,h),c.roomJoined=!1,g.info("RoomNodeClient::ROOM_NODE_DISCONNECTED")}),u.on(os.SOCKET_CONNECTED,async h=>{E.emit(T.ROOM_NODE_CONNECTED,{...h,wasDisconnected:c.isDisconnected}),c.isDisconnected=!1,g.info("RoomNodeClient::ROOM_NODE_CONNECTED")}),c}get sfuHandler(){return d(this,Si)}reconnect(){d(this,de).reconnect()}async setupTransports(){await this.sfuHandler.setupTransports()}async handleSocketCallbacks(e){switch(e.type){case T.NEW_CONSUMER:return this.sfuHandler.createConsumer(e.payload);default:return null}}async handleSockets(e,t){if(e){switch((!_.logExclusionList.includes(e==null?void 0:e.type)||x.hasFeature(U.BYPASS_LOG_EXCLUSION_LIST))&&g.info(`RoomNodeClient::handleSockets::${e==null?void 0:e.type}`),e.type){case T.CONSUMER_CLOSED:this.sfuHandler.closeConsumer(e.payload);break;case T.CONSUMER_PAUSED:this.sfuHandler.pauseConsumer(e.payload);break;case T.CONSUMER_RESUMED:this.sfuHandler.resumeConsumer(e.payload);break;case T.CONSUMER_SCORE:this.handleConsumerScore(e.payload);break;case T.PRODUCER_SCORE:this.handleProducerScore(e.payload);break;case T.PRODUCER_CLOSED:this.handleProducerClosed(e.payload);break}typeof t=="function"&&t()}}async joinRoom(e,t,s,i,n={}){var c,l,u;this.peerDisplayName=e,this.roomUUID=s;const a=await d(this,de).sendMessage({type:"joinRoom",payload:{device:he.getDeviceInfo(),displayName:e,rtpCapabilities:this.sfuHandler.getRTPCapabilities(),isLegacy:this.legacyMode,audioMuted:t}});if((c=a.payload)!=null&&c.waitlisted)return E.emit(T.WAITLISTED),{roomJoined:!1};this.roomJoined=!0,(u=(l=a.payload)==null?void 0:l.waitlistedPeers)==null||u.forEach(h=>{E.emit(T.WAITLIST_PEER_ADDED,h)}),this.legacyMode=a.payload.legacyMode||this.legacyMode,i&&i!==""&&await this.changeRoomDisplayTitle(i),this.maxPreferredStreams=a.payload.maxPreferredStreams;const o=wt();g.info("RoomNodeClient::joinRoom::pre emitasync room_joined");try{await E.emitAsync(T.ROOM_JOINED,a.payload)}catch(h){g.error("RoomNodeClient::joinRoom::emitAsync",{error:h})}return g.info("RoomNodeClient::joinRoom::post emitasync room_joined"),E.emit(T.SELF_ROOM_JOINED),x.hasFeature(U.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"&&setTimeout(async()=>{const h=await o.getUserDetails(),p={userId:re.isV2AuthToken?h.participant.id:h.id,peerId:this.peerId,displayName:e,roomUUID:this.roomUUID,roomViewType:"groupCall",roomName:this.roomName,deviceInfo:{...he.getDeviceInfo(),userAgent:navigator.userAgent,memory:navigator.deviceMemory,cpus:navigator.hardwareConcurrency},sdkName:Ed,sdkVersion:ca,metaData:{},permissions:{}};L.roomJoined(p),n!=null&&n.audio?L.audioOn():L.audioOff(),n!=null&&n.video?L.videoOn():L.videoOff()}),{roomJoined:!0}}async leaveRoom(){this.sfuHandler.stopAllProducers(),await this.sfuHandler.stopAllTransports(),d(this,de).disconnect(),L.callEnded(),_.destruct()}handleProducerClosed({id:e}){this.sfuHandler.producers.forEach((t,s)=>{t.id===e&&this.sfuHandler.removeProducer(s)})}getConsumers(){return this.sfuHandler.consumers}static getComputedScore(e){var s,i;let t=0;try{Array.isArray(e)?e.length===1?t=e[0].score:t=e.map(({score:a})=>a!=null?a:10).filter(a=>a>0).reduce((a,o)=>a+o,0)/e.length:t=(s=e==null?void 0:e.score)!=null?s:10}catch(n){t=(i=e==null?void 0:e.score)!=null?i:10}return t}handleConsumerScore({id:e,score:t}){var i;const s=d(this,Si).consumers.get(e);s&&(s.score=t&&t.producerScore!==void 0&&t.producerScore>=0?t.producerScore:(i=t==null?void 0:t.score)!=null?i:10,E.emit(T.CONSUMER_SCORE_UPDATE,{id:s.id,kind:s.kind,peerId:s.peerId,score:s.score}))}handleProducerScore({id:e,score:t}){const s=[...d(this,Si).producers.values()].find(n=>n.id===e);if(!s){g.error(`RoomNodeClient::producer_not_found. ProducerId: ${e}`);return}if(!s)return;const i=Ap.getComputedScore(t);i!==void 0&&i!==s.score&&(s.score=i,E.emit(T.PRODUCER_SCORE_UPDATE,{id:s.id,kind:s.kind,appData:s.appData,score:s.score}))}async shareWebcam(e){if(e===void 0)return;if(this.sfuHandler.producers.has(B.WEBCAM)){const l=this.sfuHandler.producers.get(B.WEBCAM);if(!l.closed&&!navigator.isReactNative){await l.replaceTrack({track:e}),await this.resumeWebcam();return}await this.sfuHandler.removeProducer(B.WEBCAM,!1)}let t=qP;const s=this.sfuHandler.getRTPCapabilities().codecs.find(l=>l.mimeType.toLowerCase()==="video/vp9")||void 0,i=this.sfuHandler.getRTPCapabilities().codecs.find(l=>l.mimeType.toLowerCase()==="video/vp8")||void 0,n=x.getValue(U.OVERRIDE_WEBCAM_SIMULCAST);if(s&&!this.legacyMode)t=JP;else if(n!==void 0)try{t=JSON.parse(n)}catch(l){g.error("Failed to parse flagsmith simulcast")}const a=()=>this.legacyMode?i:s,o={track:e,encodings:x.hasFeature(U.DISABLE_WEBCAM_SIMULCAST)?void 0:t,codecOptions:{videoGoogleStartBitrate:1e3},codec:a(),appData:{screenShare:!1},stopTracks:!1},c=()=>{this.disableWebcam()};await this.sfuHandler.createProducer(B.WEBCAM,o,c)}async shareScreen(e){var c,l;const{video:t,audio:s}=e;if(t===void 0)return;let i;x.hasFeature(U.SCREENSHARE_SIMULCAST)&&(i=KP);const n={track:t,appData:{screenShare:!0,supportsRemoteControl:he.isElectron()},encodings:i,stopTracks:!1};let a=()=>{this.disableScreenShare()};L.screenShareRequested(),await this.sfuHandler.createProducer(B.SCREENSHARE_VIDEO,n,a);const o={opusDtx:!1,opusStereo:!1,opusFec:!0,forceGoogConference:!1};if(x.hasFeature(U.SCREENSHARE_FORCE_GOOG_CONFERENCE)&&(o.forceGoogConference=!0),s){const u={track:s,codecOptions:o,appData:{screenShare:!0,supportsRemoteControl:he.isElectron()},stopTracks:!1};a=()=>{},await this.sfuHandler.createProducer(B.SCREENSHARE_AUDIO,u,a)}L.screenShareStart((l=(c=this.sfuHandler.producers.get(B.SCREENSHARE_VIDEO))==null?void 0:c.rtpParameters.encodings[0])==null?void 0:l.ssrc)}async shareMic(e){try{if(e===void 0)throw new w("track undefined");if(this.sfuHandler.producers.has(B.MIC)){const i=this.sfuHandler.producers.get(B.MIC);if(!i.closed&&!navigator.isReactNative){await i.replaceTrack({track:e}),await this.resumeMic();return}await this.sfuHandler.removeProducer(B.MIC,!1)}const t={track:e,codecOptions:{opusDtx:!1,opusStereo:!1,opusFec:!0,opusMaxAverageBitrate:16e3},stopTracks:!1},s=()=>{this.disableMic()};await this.sfuHandler.createProducer(B.MIC,t,s)}catch(t){throw new w(t)}}pauseMic(){const e=this.sfuHandler.producers.get(B.MIC);if(!e){g.error("pauseMic::could_not_find_mic_producer");return}e.pause(),d(this,de).sendMessage({type:"pauseProducer",payload:{producerId:e.id}})}async pauseWebcam(){const e=this.sfuHandler.producers.get(B.WEBCAM);if(!e){g.error("pauseWebcam::could_not_find_webcam_producer");return}e.pause(),await d(this,de).sendMessage({type:"pauseProducer",payload:{producerId:e.id}})}async resumeMic(){const e=this.sfuHandler.producers.get(B.MIC);if(!e){g.error("resumeMic::could_not_find_mic_producer");return}e.resume(),await d(this,de).sendMessage({type:"resumeProducer",payload:{producerId:e.id}})}async resumeWebcam(){const e=this.sfuHandler.producers.get(B.WEBCAM);if(!e){g.error("resumeWebcam::could_not_find_webcam_producer");return}e.resume(),await d(this,de).sendMessage({type:"resumeProducer",payload:{producerId:e.id}})}async disableWebcam(){await this.sfuHandler.removeProducer(B.WEBCAM)}async disableMic(){await this.sfuHandler.removeProducer(B.MIC)}async disableScreenShare(){var e,t;g.info("screen_sharing_stopped"),L.screenShareStop((t=(e=this.sfuHandler.producers.get(B.SCREENSHARE_VIDEO))==null?void 0:e.rtpParameters.encodings[0])==null?void 0:t.ssrc),await this.sfuHandler.removeProducer(B.SCREENSHARE_VIDEO),await this.sfuHandler.removeProducer(B.SCREENSHARE_AUDIO)}async resetVideoProducers(e,t){e&&(await this.sfuHandler.removeProducer(B.WEBCAM,!1),this.shareWebcam(e)),t&&(await this.sfuHandler.removeProducer(B.SCREENSHARE_VIDEO,!1),this.shareScreen({video:t}))}async getRoomState(){return d(this,de).sendMessage({type:"getRoomState"})}async changeRoomDisplayTitle(e){await d(this,de).sendMessage({type:"changeDisplayTitle",payload:{displayTitle:e}})}async sendMessage(e){return d(this,de).sendMessage(e)}async broadcastMessage(e,t){const s={payload:t,type:e};return d(this,de).sendMessage({type:"roomMessage",payload:s})}async sendChatMessage(e){await d(this,de).sendMessage({type:"chatMessage",payload:e})}async getChatMessages(){return d(this,de).sendMessage({type:"getChatMessages"})}async pinChatMessage(e){return d(this,de).sendMessage({type:"pinChatMessage",payload:e})}async unpinChatMessage(e){return d(this,de).sendMessage({type:"unpinChatMessage",payload:e})}async getPolls(){return d(this,de).sendMessage({type:"getPolls"})}async newPoll(e){await d(this,de).sendMessage({type:"newPoll",payload:e})}async votePoll(e){await d(this,de).sendMessage({type:"votePoll",payload:e})}async acceptWaitingRequest(e){await d(this,de).sendMessage({type:"acceptWaitingRequest",payload:{id:e}})}async rejectWaitingRequest(e){await d(this,de).sendMessage({type:"rejectWaitingRequest",payload:{id:e}})}async muteAll(e){await d(this,de).sendMessage({type:"muteAllNew",payload:{allowUnMute:e}})}async muteAllVideo(){await d(this,de).sendMessage({type:"muteAllVideo"})}async pinPeer(e){return d(this,de).sendMessage({type:"pinPeer",payload:{id:e}})}async unpinPeer(e){return d(this,de).sendMessage({type:"unpinPeer",payload:{id:e}})}async disableAudio(e){await d(this,de).sendMessage({type:"disableAudioPeerNew",payload:{id:e}})}async disableVideo(e){await d(this,de).sendMessage({type:"disableVideoPeer",payload:{id:e}})}async kickAll(){await d(this,de).sendMessage({type:"kickAll"})}async kick(e){await d(this,de).sendMessage({type:"kick",payload:{id:e}})}async getPage(e){return d(this,de).sendMessage({type:"getPage",payload:{pageNum:e}})}async muteSelf(){this.pauseMic(),await d(this,de).sendMessage({type:"muteSelf"})}async unmuteSelf(){await this.resumeMic(),await d(this,de).sendMessage({type:"unmuteSelf"})}async addRoomPlugin(e){return d(this,de).sendMessage({type:"addPlugin",payload:e})}async removeRoomPlugin(e){return d(this,de).sendMessage({type:"removePlugin",payload:e})}async remoteControlMessage(e){return d(this,de).sendMessage({type:"message",payload:e})}async requestRemoteControl(e){return this.remoteControlMessage({peerId:e.hostPeerId,remoteRequestId:e.id,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId,remoteRequestType:Cs.REQUEST})}async acceptRemoteControl(e){return this.remoteControlMessage({peerId:e.remotePeerId,remoteRequestId:e.id,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId,remoteRequestType:Cs.ACCEPT})}async terminateRemoteControl(e,t){return this.remoteControlMessage({peerId:e,remoteRequestId:t.id,hostPeerId:t.hostPeerId,remotePeerId:t.remotePeerId,remoteRequestType:Cs.END})}async sendEventRemoteControl(e,t,s){return this.remoteControlMessage({peerId:e,remoteRequestId:t,remoteEvent:s,hostPeerId:this.peerId,remotePeerId:e,remoteRequestType:Cs.EVENT})}async assertSpotlight(e,t){return d(this,de).sendMessage({type:e,payload:{...t,roomMessageType:"spotlight"}})}async assertSpotlightToRoom(e){return this.assertSpotlight("roomMessage",e)}async assertSpotlightToPeer(e){return this.assertSpotlight("message",e)}async requestToJoinStage(e){await this.sendMessage({type:"requestToJoinStage",payload:e})}async withdrawRequestToJoinStage(){await this.sendMessage({type:"withdrawRequestToJoinStage"})}async acceptAllRequestToJoinStage(e){await this.sendMessage({type:"acceptAllRequestToJoinStage",payload:e.map(t=>({...t,type:Qh.REQUESTED_BY_MODERATOR}))})}async removePeerFromStage(e,t){await this.sendMessage({type:"removePeerFromStage",payload:{id:e,type:t}})}stopAllProducers(){d(this,Si).stopAllProducers()}async startPresenting(){await this.sendMessage({type:"startPresenting"})}async stopPresenting(){this.stopAllProducers(),await this.sendMessage({type:"stopPresenting"})}async rejectRequestToJoinStage(e){await this.sendMessage({type:"rejectRequestToJoinStage",payload:{id:e}})}},de=new WeakMap,Si=new WeakMap,aE);let Ee=Ap;nr([_.trace("RoomNodeClient.reconnect")],Ee.prototype,"reconnect",1),nr([_.trace("RoomNodeClient.joinRoom")],Ee.prototype,"joinRoom",1),nr([_.trace("RoomNodeClient.leaveRoom")],Ee.prototype,"leaveRoom",1),nr([_.trace("RoomNodeClient.shareWebcam")],Ee.prototype,"shareWebcam",1),nr([_.trace("RoomNodeClient.shareScreen")],Ee.prototype,"shareScreen",1),nr([_.trace("RoomNodeClient.shareMic")],Ee.prototype,"shareMic",1),nr([_.trace("RoomNodeClient.pauseMic")],Ee.prototype,"pauseMic",1),nr([_.trace("RoomNodeClient.pauseWebcam")],Ee.prototype,"pauseWebcam",1),nr([_.trace("RoomNodeClient.resumeMic")],Ee.prototype,"resumeMic",1),nr([_.trace("RoomNodeClient.resumeWebcam")],Ee.prototype,"resumeWebcam",1),nr([_.trace("RoomNodeClient.disableWebcam")],Ee.prototype,"disableWebcam",1),nr([_.trace("RoomNodeClient.disableMic")],Ee.prototype,"disableMic",1),nr([_.trace("RoomNodeClient.disableScreenShare")],Ee.prototype,"disableScreenShare",1),nr([_.trace("RoomNodeClient.resetVideoProducers")],Ee.prototype,"resetVideoProducers",1);let cs;async function FU(r){if(cs)throw new Error("Room Node Client already setup");cs=await Z.init(r)}async function lT(r){if(cs!=null&&cs.roomJoined)throw new Error("Room Node Client already setup");cs&&(cs=void 0),cs=await Ee.init(r)}async function VU(){cs=void 0}function st(){return cs}function pn(r){var e,t,s,i,n,a,o,c,l,u,h,p,m;return r?{media:{audio:{enabled:r.audioEnabled,trackId:(e=r.audioTrack)==null?void 0:e.id,permission:"mediaPermissions"in r?(t=r.mediaPermissions)==null?void 0:t.audio:null},video:{enabled:r.videoEnabled,trackId:(s=r.videoTrack)==null?void 0:s.id,permission:"mediaPermissions"in r?(i=r.mediaPermissions)==null?void 0:i.video:null},screenshare:{enabled:r.screenShareEnabled,permission:"mediaPermissions"in r?(n=r.mediaPermissions)==null?void 0:n.screenshare:null,audio:{enabled:(o=(a=r.screenShareTracks)==null?void 0:a.audio)==null?void 0:o.enabled,trackId:(l=(c=r.screenShareTracks)==null?void 0:c.audio)==null?void 0:l.id},video:{enabled:(h=(u=r.screenShareTracks)==null?void 0:u.video)==null?void 0:h.enabled,trackId:(m=(p=r.screenShareTracks)==null?void 0:p.video)==null?void 0:m.id}}}}:{}}const As={setItem:(r,e)=>{try{localStorage.setItem(r,e)}catch(t){g.error("LocalStorage::setItem::crashed",{error:t,localStorage:{key:r,value:e}})}},getItem:r=>{try{return localStorage.getItem(r)}catch(e){g.error("LocalStorage::getItem::crashed",{error:e,localStorage:{key:r}})}return null}},$U=(r=0)=>new Promise(e=>setTimeout(e,r)),HU=(r,e,t)=>{const s=typeof t=="number"?t:250,i=r.createMediaStreamSource(e),n=r.createAnalyser();n.fftSize=2048,i.connect(n);const a=new Uint8Array(n.fftSize);let o=!1;setTimeout(()=>{o=!0},s);function c(){return o?Promise.resolve(!0):(n.getByteTimeDomainData(a),a.some(l=>l!==128&&l!==0)?Promise.resolve(!1):$U().then(c))}return c().then(l=>(i.disconnect(),l),l=>{throw i.disconnect(),l})},jU=typeof AudioContext!="undefined"?AudioContext:null;class Ip{constructor(e){f(this,"_AudioContext");f(this,"audioContext");f(this,"_audioContextRefContainers");const t={AudioContext:jU,...e};Object.defineProperties(this,{_AudioContext:{value:t.AudioContext},audioContext:{value:null,writable:!0},_audioContextRefContainers:{value:new Set},AudioContextProvider:{enumerable:!0,value:Ip}})}getOrCreate(e){if(!this._audioContextRefContainers.has(e)&&(this._audioContextRefContainers.add(e),this._AudioContext&&!this.audioContext))try{this.audioContext=new this._AudioContext}catch(t){}return this.audioContext}release(e){this._audioContextRefContainers.has(e)&&(this._audioContextRefContainers.delete(e),!this._audioContextRefContainers.size&&this.audioContext&&(this.audioContext.close(),this.audioContext=null))}}const uT=new Ip,GU=3,qU=250;function KU(r){const e={},t=uT.getOrCreate(e);let s=GU;function i(){return s-=1,HU(t,r.srcObject,qU).then(n=>n?s>0?i():!0:!1).catch(()=>!0)}return i().finally(()=>{uT.release(e)})}async function zo(r){const e=new Audio,t=new MediaStream;t.addTrack(r),e.srcObject=t;let s=!1;try{const i=e.play();i&&await i,s=await KU(e),s&&g.info("checkIfAudioTrackIsSilent::silence_detected")}catch(i){g.error("checkIfAudioTrackIsSilent::failed_to_detect_silence",{error:i})}finally{e.pause(),e.remove()}return s}async function WU(r,e){if(!(r!=null&&r.length))return e;const t=new AudioContext,s=await Promise.all(r==null?void 0:r.map(a=>a(t))),i=t.createMediaStreamSource(new MediaStream([e])),n=t.createMediaStreamDestination();try{let a=i;for(let o=0;o<s.length;o+=1)a.connect(s[o]),a=s[o];a.connect(n)}catch(a){return g.error("getTransformedAudioTrack::middleware_execution_failed",{error:a}),e}return n.stream.getAudioTracks()[0]}var JU=Object.defineProperty,zU=Object.getOwnPropertyDescriptor,YU=(r,e,t,s)=>{for(var i=s>1?void 0:s?zU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&JU(e,t,i),i};let kp=class extends Ke{constructor(e,t){super();f(this,"constructorName",this.constructor.name);f(this,"userSelectedDevice");f(this,"mediaInterface");f(this,"_mediaTrack");f(this,"transformedMediaTrack");f(this,"middlewares",[]);f(this,"currentDevice");this.mediaInterface=e,t&&this.setMediaTrack(t),this.userSelectedDevice=void 0,this.onTrackEnded=this.onTrackEnded.bind(this),this.onTrackMuted=this.onTrackMuted.bind(this)}disableTrack(){var e,t;this.removeMediaTrackListeners(),(e=this._mediaTrack)==null||e.stop(),this._mediaTrack=void 0,(t=this.transformedMediaTrack)==null||t.stop(),this.transformedMediaTrack=void 0}get mediaTrack(){return this._mediaTrack}async setMediaTrack(e){const t=s=>{g.error(`${this.constructorName}.setMediaTrack.error`,{error:s})};try{this.disableTrack()}catch(s){t(s)}this._mediaTrack=e,await this.setTransformedTrack();try{this.addMediaTrackListeners(),await this.setCurrentDevice()}catch(s){t(s)}}get trackEnabled(){return!!this.mediaTrack&&this.mediaTrack.readyState==="live"&&this.mediaTrack.enabled}muteTrack(){if(!this.mediaTrack){g.warn("BaseMediaHandler.muteTrack Tried muting with no track present");return}this.transformedMediaTrack&&(this.transformedMediaTrack.enabled=!1),this.mediaTrack.enabled=!1}async unmuteTrack(){try{this.mediaTrack?this.mediaTrack.enabled=!0:await this.enableTrack(!1)}catch(e){throw g.error(`${this.constructorName}.unmuteTrack.error`,{error:e}),this.disableTrack(),new w("Failed to unmute track")}}async setCurrentDevice(){var e;if(!this.mediaTrack){this.currentDevice=void 0;return}((e=this.currentDevice)==null?void 0:e.deviceId)!==this.mediaTrack.getSettings().deviceId&&(this.currentDevice=await this.mediaInterface.getDevice(this.mediaTrack.getSettings().deviceId))}async addMiddleware(e){if(he.isSafari())return{success:!1,message:"Middlewares are not yet supported in Safari."};if(this.middlewares.includes(e))return{success:!1,message:"This middleware has been applied, already. Skipping."};try{return this.trackEnabled&&await this.setTransformedTrack(),this.middlewares.push(e),{success:!0,message:"Successfully added the middleware."}}catch(t){return g.error("While adding middleware",{error:t}),{success:!1,message:t==null?void 0:t.message}}}async removeMiddleware(e){const t=this.middlewares.indexOf(e,0);if(t>-1)try{return await this.setTransformedTrack(),this.middlewares.splice(t,1),{success:!0,message:"Successfully removed the middleware."}}catch(s){return g.error("While removing middleware",{error:s}),{success:!1,message:s==null?void 0:s.message}}return{success:!1,message:"No such middleware was found. Skipping."}}addMediaTrackListeners(){var e,t,s;this.mediaTrack&&(g.info(`${this.constructorName}.addMediaTrackListeners for deviceId ${(t=(e=this.mediaTrack)==null?void 0:e.getSettings())==null?void 0:t.deviceId} of type ${(s=this.mediaTrack)==null?void 0:s.kind}`),this.mediaTrack.addEventListener("ended",this.onTrackEnded),this.mediaTrack.addEventListener("mute",this.onTrackMuted))}removeMediaTrackListeners(){var e,t,s;this.mediaTrack&&(g.info(`${this.constructorName}.removeMediaTrackListeners for deviceId ${(t=(e=this.mediaTrack)==null?void 0:e.getSettings())==null?void 0:t.deviceId} of type ${(s=this.mediaTrack)==null?void 0:s.kind}`),g.info(`${this.constructorName}.removeMediaTrackListeners`),this.mediaTrack.removeEventListener("ended",this.onTrackEnded),this.mediaTrack.removeEventListener("mute",this.onTrackMuted))}};kp=YU([Bt(r=>{throw new w(r.message,"1600")})],kp);const hT=kp;var XU=Object.defineProperty,QU=Object.getOwnPropertyDescriptor,Op=(r,e,t,s)=>{for(var i=s>1?void 0:s?QU(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&XU(e,t,i),i};const Dp="[Dyte]nonSilentDeviceLabels";class _l extends hT{async setDevice(e){if(!e)throw g.warn("AudioMediaHandler.setDevice No device received"),new w("No device received!","1603");if(e.kind!=="audioinput")throw g.warn("AudioMediaHandler.setDevice Received non audio device"),new w("Non audio device received while setting device!","1603");try{const t=this.trackEnabled;this.userSelectedDevice=e.deviceId,await this.setMediaTrack(await this.mediaInterface.getAudioTrack(!t,e.deviceId))}catch(t){throw g.error("AudioMediaHandler.setDevice.error",{error:t}),this.disableTrack(),new w(t.message,"1604")}}async enableTrack(e){if(this.trackEnabled){g.warn("AudioMediaHandler.enableTrack Track already enabled!");return}const t=await this.mediaInterface.getAudioTrack(e,this.userSelectedDevice);await this.setMediaTrack(t),await this.conditionallyChangeTrack()}async setTransformedTrack(){var e;if(!((e=this.middlewares)!=null&&e.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await WU(this.middlewares,this.mediaTrack),this.emit("trackChanged")}catch(t){g.error("AudioMediaHandler.setTransformedTrack",{error:t}),this.transformedMediaTrack=this.mediaTrack}}async onTrackEnded(){g.info("AudioMediaHandler.TrackEnded"),this.emit("trackEnded");const e=this.mediaTrack.enabled;this.disableTrack(),await this.enableTrack(!e),await this.setTransformedTrack(),this.emit("trackChanged")}onTrackMuted(){g.info("AudioMediaHandler.TrackMuted"),this.emit("trackMuted")}async conditionallyChangeTrack(){var i;if(!this.mediaTrack)return;const e=JSON.parse(As.getItem(Dp));if(e!=null&&e.devices.some(n=>n.label===this.mediaTrack.label))return;if(!await zo(this.mediaTrack)){const n=(i=e==null?void 0:e.devices.concat({label:this.mediaTrack.label}))!=null?i:[{label:this.mediaTrack.label}];As.setItem(Dp,JSON.stringify({devices:n}));return}g.info("AudioMediaHandler.conditionallyChangeTrack.DetectedSilentTrack");const t=this.mediaTrack.getSettings().deviceId;(await this.mediaInterface.getAudioInputDevices()).filter(n=>n.deviceId!==t).some(async n=>{if(await this.setDevice(n),!await zo(this.mediaTrack)){const a=e.devices.concat({label:this.mediaTrack.label});return As.setItem(Dp,JSON.stringify({devices:a})),g.info("AudioMediaHandler.conditionallyChangeTrack.SuccesfullyChangedTrack"),!0}return g.info("AudioMediaHandler.conditionallyChangeTrack.AnotherSilentTrackFound"),!1})}}Op([_.trace("AudioMediaHandler.setTransformedTrack")],_l.prototype,"setTransformedTrack",1),Op([_.trace("AudioMediaHandler.onTrackEnded")],_l.prototype,"onTrackEnded",1),Op([_.trace("AudioMediaHandler.conditionallyChangeTrack")],_l.prototype,"conditionallyChangeTrack",1);class fn extends Error{constructor(t,s,i){super(s);f(this,"constraints");f(this,"name");this.name=t,this.constraints=i}}function vl(r,e,t){if(he.isChromiumBased()){if(e==="NotAllowedError")return t.indexOf("by system")>0?"SYSTEM_DENIED":r==="screenshare"?"CANCELED":"DENIED";if(e==="NotReadableError")return"COULD_NOT_START"}else if(he.isSafari()){if(e==="NotAllowedError")return"DENIED"}else if(he.isFirefox()){if(e==="NotFoundError"||e==="NotReadableError")return"SYSTEM_DENIED";if(e==="NotAllowedError")return"DENIED";if(e==="AbortError")return"COULD_NOT_START"}return"COULD_NOT_START"}function Mp(r){return r===2 .toString()?Ys.DENIED:r===4 .toString()?Ys.SYS_DENIED:r===1 .toString()?Ys.ACCEPTED:Ys.FAILED}class ZU{constructor(){f(this,"permissions");this.permissions={audio:"NOT_REQUESTED",video:"NOT_REQUESTED",screenshare:"NOT_REQUESTED"}}async getAudioInputDevices(){return(await this.getAvailableDevices()).filter(t=>t.kind==="audioinput")}async getVideoInputDevices(){return(await this.getAvailableDevices()).filter(t=>t.kind==="videoinput")}async getAudioOutputDevices(){return(await this.getAvailableDevices()).filter(t=>t.kind==="audiooutput")}}var eB=Object.defineProperty,tB=Object.getOwnPropertyDescriptor,rB=(r,e,t,s)=>{for(var i=s>1?void 0:s?tB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&eB(e,t,i),i};let Np=(oE=class extends ZU{constructor(e){super();S(this,Fs,void 0);R(this,Fs,new e_(e))}handlePermissionErrors(e,t){const s=vl(e,t.name,t.message);this.permissions[e]=s,E.emit(T.MEDIA_PERMISSION_ERROR,{message:s,constraints:t.constraints,kind:e})}async getAudioAndVideoTrack(){const e={audio:d(this,Fs).getAudioConstraints().audio,video:d(this,Fs).getVideoConstraints().video};try{const t=await navigator.mediaDevices.getUserMedia(e),s=t.getAudioTracks()[0],i=t.getVideoTracks()[0];return this.permissions.audio="ACCEPTED",this.permissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),{audioTrack:s,videoTrack:i}}catch(t){if(t.name==="NotAllowedError"){const s=await this.getAudioTrack(!1),i=await this.getVideoTrack();return{audioTrack:s,videoTrack:i}}throw g.error("WebMediaInterface.getAudioAndVideoTrack",{error:t}),new w("Couldnt fetch audio and video track")}}async getAudioTrack(e,t){const s=d(this,Fs).getAudioConstraints(t);try{const i=(await navigator.mediaDevices.getUserMedia(s)).getAudioTracks()[0];return i.enabled=!e,this.permissions.audio="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),i}catch(i){throw this.handlePermissionErrors("audio",new fn(i.name,i.message,s)),new w(i.message,"1601")}}async getScreenShareTracks(){const e=d(this,Fs).getScreenShareConstraints();try{const t=await navigator.mediaDevices.getDisplayMedia(e);return this.permissions.screenshare="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.screenshare,kind:"screenshare"}),{audioTrack:t.getAudioTracks()[0],videoTrack:t.getVideoTracks()[0]}}catch(t){throw this.handlePermissionErrors("screenshare",new fn(t.name,t.message,e)),g.error("WebMediaInterface.getScreenShareTracks Error while fetching screenshare tracks",{error:t}),new w("Couldnt fetch screen share tracks")}}async getVideoTrack(e){const t=d(this,Fs).getVideoConstraints(e);try{const s=(await navigator.mediaDevices.getUserMedia(t)).getVideoTracks()[0];return this.permissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"audio"}),s}catch(s){throw this.handlePermissionErrors("video",new fn(s.name,s.message,t)),g.error("WebMediaInterface.getVideoTrack Error while fetching video track",{error:s}),new w("Couldnt fetch video track")}}async getAvailableDevices(){try{return navigator.mediaDevices.enumerateDevices()}catch(e){throw g.error("enumerate_devices_failed",{error:e}),new w("Failed to get available devices")}}async getAvailableDevicesByKind(e){try{return(await navigator.mediaDevices.enumerateDevices()).filter(({kind:t})=>e===t)}catch(t){throw g.error("enumerate_devices_failed",{error:t}),new w("Failed to get available devices by kind")}}async getDevice(e){try{return(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.deviceId===e)[0]}catch(t){throw g.error("enumerate_devices_failed",{error:t}),new w("Failed to get device")}}},Fs=new WeakMap,oE);Np=rB([Bt(r=>{throw new w(r.message,"1600")})],Np);const pT=Np;class sB{constructor(e){S(this,Ba,void 0);f(this,"currentDevice");R(this,Ba,e)}async setupSpeaker(e){var s,i;if(!(d(this,Ba)instanceof pT))return;let t=e;if(e||([t]=await d(this,Ba).getAvailableDevicesByKind("audiooutput")),!t)throw new w("No speaker found");((s=this.currentDevice)==null?void 0:s.deviceId)!==t.deviceId&&((i=this.currentDevice)!=null||(this.currentDevice=t),document.querySelectorAll("audio").forEach(async n=>{if(typeof n.sinkId!="undefined"&&this.currentDevice.deviceId&&n.sinkId!==this.currentDevice.deviceId)try{await n.setSinkId(this.currentDevice.deviceId)}catch(a){}}))}}Ba=new WeakMap;class iB extends Ke{constructor(t){super();f(this,"mediaInterface");f(this,"audioMediaTrack");f(this,"videoMediaTrack");this.mediaInterface=t}get trackEnabled(){return!!this.videoMediaTrack}async enableScreenShare(){var i,n;const{audioTrack:t,videoTrack:s}=await this.mediaInterface.getScreenShareTracks();this.audioMediaTrack=t,this.videoMediaTrack=s,this.addMediaTrackListeners(),((n=(i=this.mediaInterface)==null?void 0:i.permissions)==null?void 0:n.screenshare)!=="ACCEPTED"&&this.mediaInterface.permissions&&(this.mediaInterface.permissions.screenshare="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.mediaInterface.permissions.screenshare,kind:"screenshare"}))}disableScreenShare(){var t,s;this.removeMediaTrackListeners(),(t=this.audioMediaTrack)==null||t.stop(),(s=this.videoMediaTrack)==null||s.stop(),this.videoMediaTrack=void 0,this.audioMediaTrack=void 0}addMediaTrackListeners(){var t;(t=this.videoMediaTrack)==null||t.addEventListener("ended",this.onTrackEnded.bind(this))}removeMediaTrackListeners(){var t;(t=this.videoMediaTrack)==null||t.removeEventListener("ended",this.onTrackEnded)}onTrackEnded(){this.emit("trackEnded")}}const nB=r=>(e,t)=>(r.set(e,t),t),fT=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,mT=536870912,gT=mT*2,aB=(r,e)=>t=>{const s=e.get(t);let i=s===void 0?t.size:s<gT?s+1:0;if(!t.has(i))return r(t,i);if(t.size<mT){for(;t.has(i);)i=Math.floor(Math.random()*gT);return r(t,i)}if(t.size>fT)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;t.has(i);)i=Math.floor(Math.random()*fT);return r(t,i)},_T=new WeakMap,oB=nB(_T),Tl=aB(oB,_T),cB=r=>r.method!==void 0&&r.method==="call",dB=r=>r.error===null&&typeof r.id=="number",vT=((r,e)=>{let t=null;return()=>{if(t!==null)return t;const s=new Blob([e],{type:"application/javascript; charset=utf-8"}),i=URL.createObjectURL(s);return t=r(i),setTimeout(()=>URL.revokeObjectURL(i)),t}})(r=>{const e=new Map([[0,()=>{}]]),t=new Map([[0,()=>{}]]),s=new Map,i=new Worker(r);return i.addEventListener("message",({data:l})=>{if(cB(l)){const{params:{timerId:u,timerType:h}}=l;if(h==="interval"){const p=e.get(u);if(typeof p=="number"){const m=s.get(p);if(m===void 0||m.timerId!==u||m.timerType!==h)throw new Error("The timer is in an undefined state.")}else if(typeof p!="undefined")p();else throw new Error("The timer is in an undefined state.")}else if(h==="timeout"){const p=t.get(u);if(typeof p=="number"){const m=s.get(p);if(m===void 0||m.timerId!==u||m.timerType!==h)throw new Error("The timer is in an undefined state.")}else if(typeof p!="undefined")p(),t.delete(u);else throw new Error("The timer is in an undefined state.")}}else if(dB(l)){const{id:u}=l,h=s.get(u);if(h===void 0)throw new Error("The timer is in an undefined state.");const{timerId:p,timerType:m}=h;s.delete(u),m==="interval"?e.delete(p):t.delete(p)}else{const{error:{message:u}}=l;throw new Error(u)}}),{clearInterval:l=>{const u=Tl(s);s.set(u,{timerId:l,timerType:"interval"}),e.set(l,u),i.postMessage({id:u,method:"clear",params:{timerId:l,timerType:"interval"}})},clearTimeout:l=>{const u=Tl(s);s.set(u,{timerId:l,timerType:"timeout"}),t.set(l,u),i.postMessage({id:u,method:"clear",params:{timerId:l,timerType:"timeout"}})},setInterval:(l,u)=>{const h=Tl(e);return e.set(h,()=>{l(),typeof e.get(h)=="function"&&i.postMessage({id:null,method:"set",params:{delay:u,now:performance.now(),timerId:h,timerType:"interval"}})}),i.postMessage({id:null,method:"set",params:{delay:u,now:performance.now(),timerId:h,timerType:"interval"}}),h},setTimeout:(l,u)=>{const h=Tl(t);return t.set(h,l),i.postMessage({id:null,method:"set",params:{delay:u,now:performance.now(),timerId:h,timerType:"timeout"}}),h}}},`(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(i=>{let{data:s}=i;try{if("clear"===s.method){const{id:r,params:{timerId:o,timerType:i}}=s;if("interval"===i)(t=>{const r=e.get(t);if(void 0===r)throw new Error('There is no interval scheduled with the given id "'.concat(t,'".'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==i)throw new Error('The given type "'.concat(i,'" is not supported'));(e=>{const r=t.get(e);if(void 0===r)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==s.method)throw new Error('The given method "'.concat(s.method,'" is not supported'));{const{params:{delay:i,now:n,timerId:a,timerType:d}}=s;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(i,a,n);else{if("timeout"!==d)throw new Error('The given type "'.concat(d,'" is not supported'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(i,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:s.id,result:null})}}))})();`),TT=r=>vT().clearInterval(r),ET=(r,e)=>vT().setInterval(r,e);class lB{constructor(){S(this,In,void 0)}terminateMiddlewareWebWorker(){if(d(this,In))try{TT(d(this,In)),R(this,In,void 0)}catch(e){g.debug("WorkerTimers::terminateMiddlewareWebWorker::failed")}}async getTransformedVideoTrack(e,t){if(!(e!=null&&e.length))return t;const s=await Promise.all(e==null?void 0:e.map(u=>u())),i=new MediaStream;i.addTrack(t);const n=document.createElement("canvas"),a=n.getContext("2d"),o=document.createElement("video");o.srcObject=i,o.autoplay=!0,this.terminateMiddlewareWebWorker();const c=async()=>{if(t.enabled===!1||t.readyState==="ended"){this.terminateMiddlewareWebWorker(),o.remove(),n.remove();return}try{a.drawImage(o,0,0);for(let u=0;u<s.length;u+=1)await s[u](n,a)}catch(u){g.error("getTransformedVideoTrack::middleware_execution_failed",{error:u})}};try{o.play()}catch(u){}return o.addEventListener("play",()=>{n.width=o.width||t.getSettings().width,n.height=o.width||t.getSettings().height,R(this,In,ET(c,50))},!1),n.captureStream().getVideoTracks()[0]}}In=new WeakMap;var uB=Object.defineProperty,hB=Object.getOwnPropertyDescriptor,yT=(r,e,t,s)=>{for(var i=s>1?void 0:s?hB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&uB(e,t,i),i};class Lp extends hT{constructor(t,s){super(t,s);S(this,Fa,void 0);R(this,Fa,new lB)}async setDevice(t){if(!t)throw g.warn("VideoMediaHandler.setDevice No device received"),new w("No device received!");if(t.kind!=="videoinput")throw g.warn("VideoMediaHandler.setDevice Received non video device",{devices:[t]}),new w("Non video device received while setting video device!");if(this.userSelectedDevice=t.deviceId,!(this.mediaTrack&&this.mediaTrack.enabled)){g.warn("VideoMediaHandler.setDevice Tried switching device with video disabled",{devices:[t]}),this.currentDevice=t;return}try{await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}catch(s){throw g.error("VideoMediaHandler.setDevice.error",{error:s}),this.disableTrack(),new w("Failed to change device")}}async enableTrack(){if(this.trackEnabled){g.warn("VideoMediaHandler.enableTrack Track already enabled!");return}await this.setMediaTrack(await this.mediaInterface.getVideoTrack(this.userSelectedDevice))}async setTransformedTrack(){var t;if(!((t=this.middlewares)!=null&&t.length)){this.transformedMediaTrack=this.mediaTrack;return}try{this.transformedMediaTrack=await d(this,Fa).getTransformedVideoTrack(this.middlewares,this.mediaTrack),this.emit("trackChanged")}catch(s){g.error("VideoMediaHandler.setTransformedTrack",{error:s}),this.transformedMediaTrack=this.mediaTrack}}terminateMiddlewareWebWorker(){d(this,Fa).terminateMiddlewareWebWorker()}async onTrackEnded(){g.info("VideoMediaHandler.TrackEnded"),this.disableTrack(),this.emit("trackEnded")}onTrackMuted(){g.info("VideoMediaHandler.TrackMuted"),this.emit("trackMuted")}}Fa=new WeakMap,yT([_.trace("VideoMediaHandler.setTransformedTrack")],Lp.prototype,"setTransformedTrack",1),yT([_.trace("VideoMediaHandler.onTrackEnded")],Lp.prototype,"onTrackEnded",1);var pB=Object.defineProperty,fB=Object.getOwnPropertyDescriptor,ds=(r,e,t,s)=>{for(var i=s>1?void 0:s?fB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&pB(e,t,i),i};class Vr extends Ke{constructor(t){super();S(this,Ft,void 0);S(this,Ot,void 0);S(this,Dt,void 0);S(this,wi,void 0);S(this,Kr,void 0);R(this,Ft,new pT(t)),R(this,Ot,new _l(d(this,Ft))),R(this,Dt,new Lp(d(this,Ft))),R(this,Kr,new iB(d(this,Ft))),R(this,wi,new sB(d(this,Ft))),d(this,Ot).on("trackMuted",this.onAudioTrackMuted.bind(this)),d(this,Ot).on("trackChanged",this.onAudioTrackChanged.bind(this)),d(this,Dt).on("trackChanged",this.onVideoTrackChanged.bind(this)),d(this,Dt).on("trackEnded",this.onVideoTrackEnded.bind(this)),d(this,Kr).on("trackEnded",this.onScreenShareEnded.bind(this))}async repopulateAvailableDevices(){return!0}async setupStreams({audio:t,video:s}){let i,n;if(t&&s)try{const a=await d(this,Ft).getAudioAndVideoTrack();i=a.audioTrack,n=a.videoTrack}catch(a){g.error("LocalMediaHandler::init::Failed to get audio video tracks",{error:a})}if(!i&&t)try{i=await d(this,Ft).getAudioTrack(!1)}catch(a){g.error("LocalMediaHandler::init::Failed to get audio track",{error:a})}if(!n&&s)try{n=await d(this,Ft).getVideoTrack()}catch(a){g.error("LocalMediaHandler::init::Failed to get video track",{error:a})}await d(this,Ot).setMediaTrack(i),await d(this,Ot).conditionallyChangeTrack(),await d(this,Dt).setMediaTrack(n);try{await d(this,wi).setupSpeaker()}catch(a){}}getCurrentDevices(){return{audio:d(this,Ot).currentDevice,video:d(this,Dt).currentDevice,speaker:d(this,wi).currentDevice}}get permissions(){return d(this,Ft).permissions}getAllDevices(){return d(this,Ft).getAvailableDevices()}getDeviceById(t,s){return d(this,Ft).getDevice(t)}onAudioTrackMuted(){this.emit("AUDIO_TRACK_SILENT")}onAudioTrackChanged(){this.emit("AUDIO_TRACK_CHANGE")}get rawAudioTrack(){return d(this,Ot).mediaTrack}get audioTrack(){return d(this,Ot).transformedMediaTrack}get audioEnabled(){return d(this,Ot).trackEnabled}async enableAudio(){await d(this,Ot).unmuteTrack()}disableAudio(){d(this,Ot).muteTrack()}getAudioDevices(){return d(this,Ft).getAudioInputDevices()}async setAudioDevice(t){await d(this,Ot).setDevice(t),this.emit("AUDIO_TRACK_CHANGE")}setupSpeaker(){return d(this,wi).setupSpeaker()}setSpeakerDevice(t){return d(this,wi).setupSpeaker(t)}onVideoTrackChanged(){this.emit("VIDEO_TRACK_CHANGE")}onVideoTrackEnded(){this.emit("VIDEO_TRACK_CHANGE")}get rawVideoTrack(){return d(this,Dt).mediaTrack}get videoTrack(){return d(this,Dt).transformedMediaTrack}get videoEnabled(){return d(this,Dt).trackEnabled}async enableVideo(){await d(this,Dt).unmuteTrack()}disableVideo(){d(this,Dt).disableTrack()}getVideoDevices(){return d(this,Ft).getVideoInputDevices()}async setVideoDevice(t){await d(this,Dt).setDevice(t),this.emit("VIDEO_TRACK_CHANGE")}onScreenShareEnded(){this.emit("SCREENSHARE_ENDED")}get screenShareTracks(){return{audio:d(this,Kr).audioMediaTrack,video:d(this,Kr).videoMediaTrack}}get screenShareEnabled(){return d(this,Kr).trackEnabled}async enableScreenShare(){await d(this,Kr).enableScreenShare()}async disableScreenShare(){d(this,Kr).disableScreenShare()}getSpeakerDevices(){return d(this,Ft).getAudioOutputDevices()}addAudioMiddleware(t){return d(this,Ot).addMiddleware(t)}removeAudioMiddleware(t){return d(this,Ot).removeMiddleware(t)}addVideoMiddleware(t){return d(this,Dt).addMiddleware(t)}removeVideoMiddleware(t){return d(this,Dt).removeMiddleware(t)}destruct(){d(this,Ot).disableTrack(),d(this,Dt).disableTrack(),d(this,Dt).terminateMiddlewareWebWorker(),d(this,Kr).disableScreenShare()}removeAllTracks(){this.destruct()}async removeDocumentEventListeners(){}}Ft=new WeakMap,Ot=new WeakMap,Dt=new WeakMap,wi=new WeakMap,Kr=new WeakMap,ds([_.trace("MediaHandler.setupStreams")],Vr.prototype,"setupStreams",1),ds([_.trace("MediaHandler.enableAudio")],Vr.prototype,"enableAudio",1),ds([_.trace("MediaHandler.disableAudio")],Vr.prototype,"disableAudio",1),ds([_.trace("MediaHandler.setAudioDevice")],Vr.prototype,"setAudioDevice",1),ds([_.trace("MediaHandler.enableVideo")],Vr.prototype,"enableVideo",1),ds([_.trace("MediaHandler.disableVideo")],Vr.prototype,"disableVideo",1),ds([_.trace("MediaHandler.setVideoDevice")],Vr.prototype,"setVideoDevice",1),ds([_.trace("MediaHandler.enableScreenShare")],Vr.prototype,"enableScreenShare",1),ds([_.trace("MediaHandler.disableScreenShare")],Vr.prototype,"disableScreenShare",1),ds([_.trace("MediaHandler.destruct")],Vr.prototype,"destruct",1);class mB extends Error{constructor(t,s){super(t);f(this,"code");this.code=s}}var gB=Object.defineProperty,_B=Object.getOwnPropertyDescriptor,Is=(r,e,t,s)=>{for(var i=s>1?void 0:s?_B(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&gB(e,t,i),i};const xp={port:void 0},vB=["virtual","emulator","krisp","solstice conference","teams","manycam","blackHole"];function mn(r){const e=r.label.toLowerCase();return he._bowser.getOSName()==="macOS"&&e.includes("iphone")?(g.log("isVirtualDevice::ignore_macos_continuity"),!0):vB.some(t=>e.includes(t))}const oi=(cE=class{constructor(r){S(this,Ri,void 0);S(this,Va,void 0);R(this,Ri,r),R(this,Va,new AbortController)}static async init(){let r=[];return oi.isDeviceListAvailable()?(r=await oi.enumerateDevices(),g.info("initial_full_device_list",{devices:JSON.stringify(r)})):g.error("UnsupportedMediaAPI::navigator.mediaDevices.enumerateDevices",{debuggingHint:"Try checking meetingMetadata.visitedUrl. It should be running on localhost/127.0.0.1 or HTTPS, if not, there would be issues."}),new oi(r)}async destruct(){var r;(r=d(this,Va))==null||r.abort()}static isDeviceListAvailable(){return!!(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)}static enumerateDevices(){try{return navigator.mediaDevices.enumerateDevices()}catch(r){return g.error("enumerate_devices_failed",{error:r}),Promise.resolve([])}}static getAudioConstraints(r){const e={},{disableAP:t=!1,disableAEC:s=!1,disableNS:i=!1,disableAGC:n=!1,disableHPF:a=!1}=r.audioOptions||{};if(he.isFirefox()||he.isWebKitBased())e.audio={deviceId:r.audioDeviceId,autoGainControl:!n&&!t,echoCancellation:!s&&!t,noiseSuppression:!i&&!t};else{if(typeof e.audio=="boolean")return e;e.audio={},e.audio.optional=[r.audioDeviceId?{sourceId:r.audioDeviceId}:{sourceId:"default"},{echoCancellation:!s&&!t},{googEchoCancellation:!s&&!t},{googAutoGainControl:!n&&!t},{googNoiseSuppression:!i&&!t},{googHighpassFilter:!a&&!t},{googNoiseSuppression2:!i&&!t},{googEchoCancellation2:!s&&!t},{googAutoGainControl2:!n&&!t}]}return e}static getVideoConstraints(r){const e={},{videoDeviceId:t,videoTrackConstraints:s,facingMode:i="user",frameRate:n={ideal:24,max:30}}=r;return e.video=s||Yg.vga,typeof e.video=="boolean"||(t&&(e.video.deviceId={exact:t}),e.video.facingMode=i,e.video.frameRate=n),e}static async getUserMediaWithTimeout(r={},e=0){try{if(g.info("getUserMediaWithTimeout::requesting_user_media",{timeout:e,constraints:JSON.stringify(r)}),!e){const s=await navigator.mediaDevices.getUserMedia(r);return g.info("getUserMediaWithTimeout::received_user_media",{timeout:e,constraints:JSON.stringify(r)}),s}const t=await Promise.race([navigator.mediaDevices.getUserMedia(r),new Promise((s,i)=>{setTimeout(()=>i(new mB("Get user media timed out","ERR_GUM_TIMEOUT")),e)})]);return g.info("getUserMediaWithTimeout::received_user_media",{timeout:e,constraints:JSON.stringify(r)}),t}catch(t){throw g.error("getUserMediaWithTimeout::failed_to_access_local_media",{error:t,constraints:JSON.stringify(r)}),g.error("Failed to get access to local media.",{error:t,constraints:JSON.stringify(r)}),new fn(t.name,t.message,r)}}static async getAudioTrack(r){return(await oi.getUserMediaWithTimeout(r)).getAudioTracks()[0]}static async getVideoTrack(r){return(await oi.getUserMediaWithTimeout(r)).getVideoTracks()[0]}static async getScreenShareTracks(r){var n,a;let e=x.hasFeature(U.EXTENSION_HACK),t=null;if(e)try{xp.port=window.chrome.runtime.connect("nkeimhogjdpnpccoofpliimaahmaaome",{name:"chooseDesktopMedia"})}catch(o){_.addLogInCurrentSpan("error","Extension connect error"),e=!1}e&&(t=await new Promise(o=>{const c=setTimeout(()=>o(void 0),12e3);xp.port.onMessage.addListener(async l=>{if(l.value.streamId){const{streamId:u}=l.value;clearTimeout(c),o(u)}}),xp.port.postMessage({method:"chooseDesktopMedia",sources:["screen"]})}));let s;return t?(_.addLogInCurrentSpan("error","Acquiring extension screenshare track"),s=await navigator.mediaDevices.getUserMedia({audio:!1,video:{mandatory:{maxWidth:1920,maxHeight:1080,chromeMediaSource:"desktop",chromeMediaSourceId:t},optional:[{maxFrameRate:parseInt((n=x.getValue(U.VAL_MAX_FRAMERATE_EXT))!=null?n:"12",10)},{minFrameRate:parseInt((a=x.getValue(U.VAL_MIN_FRAMERATE_EXT))!=null?a:"8",10)}]}}),_.addLogInCurrentSpan("error","Acquired extension screenshare track")):s=await navigator.mediaDevices.getDisplayMedia(r),{video:s.getVideoTracks()[0],audio:s.getAudioTracks()[0]}}static async getAudioAndVideoTrack(r){const e=await oi.getUserMediaWithTimeout(r),t=e.getAudioTracks()[0],s=e.getVideoTracks()[0];return{audioTrack:t,videoTrack:s}}onDeviceChange(r){he.supportsDeviceChangeEvent()&&navigator.mediaDevices.addEventListener("devicechange",qO(async e=>{const t=this.availableDevices,s=new Set(t.map(o=>o.deviceId));await this.repopulateAvailableDevices();const i=this.availableDevices,n=new Set(i.map(o=>o.deviceId)),a={added:i.filter(o=>!s.has(o.deviceId)),removed:t.filter(o=>!n.has(o.deviceId))};this.repopulateAvailableDevices().then(()=>r(e,a))},100),{signal:d(this,Va).signal})}async repopulateAvailableDevices(){const r=await oi.enumerateDevices();R(this,Ri,r),L.devices("AUDIO",this.getAudioDevices()),L.devices("VIDEO",this.getVideoDevices()),L.devices("SPEAKER",this.getSpeakerDevices()),g.info("repopulated_full_device_list",{devices:JSON.stringify(r)})}get availableDevices(){return d(this,Ri)}getAvailableDevicesByKind(r){return d(this,Ri).filter(e=>e.kind===r)}getDeviceById(r,e){return d(this,Ri).find(t=>t.deviceId===r&&t.kind===e)}getAudioDevices(){return this.getAvailableDevicesByKind("audioinput").sort((r,e)=>{const t=mn(r)?0:1;return(mn(e)?0:1)-t})}getVideoDevices(){return this.getAvailableDevicesByKind("videoinput").sort((r,e)=>{const t=mn(r)?0:1;return(mn(e)?0:1)-t})}getSpeakerDevices(){return this.getAvailableDevicesByKind("audiooutput").sort((r,e)=>{const t=mn(r)?0:1;return(mn(e)?0:1)-t})}},Ri=new WeakMap,Va=new WeakMap,cE);let We=oi;Is([_.trace("LocalMediaUtils.onDeviceChange")],We.prototype,"onDeviceChange",1),Is([_.trace("LocalMediaUtils.repopulateAvailableDevices")],We.prototype,"repopulateAvailableDevices",1),Is([_.trace("LocalMediaUtils.isDeviceListAvailable")],We,"isDeviceListAvailable",1),Is([_.trace("LocalMediaUtils.enumerateDevices")],We,"enumerateDevices",1),Is([_.trace("LocalMediaUtils.getUserMediaWithTimeout")],We,"getUserMediaWithTimeout",1),Is([_.trace("LocalMediaUtils.getAudioTrack")],We,"getAudioTrack",1),Is([_.trace("LocalMediaUtils.getVideoTrack")],We,"getVideoTrack",1),Is([_.trace("LocalMediaUtils.getScreenShareTracks")],We,"getScreenShareTracks",1),Is([_.trace("LocalMediaUtils.getAudioAndVideoTrack")],We,"getAudioAndVideoTrack",1);var TB=Object.defineProperty,EB=Object.getOwnPropertyDescriptor,Ra=(r,e,t,s)=>{for(var i=s>1?void 0:s?EB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&TB(e,t,i),i};class gn{constructor(e){S(this,ot,void 0);f(this,"audioMiddlewares",[]);f(this,"videoMiddlewares",[]);S(this,kn,void 0);R(this,ot,e)}terminateMiddlewareWebWorker(){if(d(this,kn))try{TT(d(this,kn)),R(this,kn,void 0)}catch(e){g.debug("WorkerTimers::terminateMiddlewareWebWorker::failed")}}async getTransformedVideoTrack(e){var l,u;if(!((l=this.videoMiddlewares)!=null&&l.length))return e;const t=await Promise.all((u=this.videoMiddlewares)==null?void 0:u.map(h=>h())),s=new MediaStream;s.addTrack(e);const i=document.createElement("canvas"),n=i.getContext("2d"),a=document.createElement("video");a.srcObject=s,a.autoplay=!0,this.terminateMiddlewareWebWorker();const o=async()=>{if(!d(this,ot).videoEnabled||e.readyState==="ended"){this.terminateMiddlewareWebWorker(),a.remove(),i.remove();return}try{n.drawImage(a,0,0);for(let h=0;h<t.length;h+=1)await t[h](i,n)}catch(h){g.error("getTransformedVideoTrack::middleware_execution_failed",{error:h})}};try{a.play()}catch(h){}return a.addEventListener("play",()=>{i.width=a.width||e.getSettings().width,i.height=a.width||e.getSettings().height,R(this,kn,ET(o,50))},!1),i.captureStream().getVideoTracks()[0]}async addVideoMiddleware(e){return he.isSafari()?{success:!1,message:"Video middlewares are not yet supported in Safari."}:this.videoMiddlewares.includes(e)?{success:!0,message:"This video middleware has been applied, already. Skipping."}:(this.videoMiddlewares.push(e),d(this,ot).videoEnabled?(d(this,ot).setVideoTrack(await this.getTransformedVideoTrack(d(this,ot).rawVideoTrack)),d(this,ot).emit("VIDEO_TRACK_CHANGE"),{success:!0,message:"Successfully applied the video middleware."}):{success:!0,message:"Successfully added the video middleware. It will be applied automatically once webcam is turned on."})}async removeVideoMiddleware(e){const t=this.videoMiddlewares.indexOf(e,0);return t>-1?(this.videoMiddlewares.splice(t,1),d(this,ot).videoEnabled&&(d(this,ot).setVideoTrack(await this.getTransformedVideoTrack(d(this,ot).rawVideoTrack)),d(this,ot).emit("VIDEO_TRACK_CHANGE")),{success:!0,message:"Successfully removed the video middleware."}):{success:!0,message:"No such video middleware was found. Skipping."}}async getTransformedAudioTrack(e){var a,o;if(!((a=this.audioMiddlewares)!=null&&a.length))return e;const t=new AudioContext,s=await Promise.all((o=this.audioMiddlewares)==null?void 0:o.map(c=>c(t))),i=t.createMediaStreamSource(new MediaStream([e])),n=t.createMediaStreamDestination();try{let c=i;for(let l=0;l<s.length;l+=1)c.connect(s[l]),c=s[l];c.connect(n)}catch(c){return g.error("getTransformedAudioTrack::middleware_execution_failed",{error:c}),e}return n.stream.getAudioTracks()[0]}async addAudioMiddleware(e){return he.isSafari()?{success:!1,message:"Audio middlewares are not yet supported in Safari."}:this.audioMiddlewares.includes(e)?{success:!0,message:"This audio middleware has been applied, already. Skipping."}:(this.audioMiddlewares.push(e),d(this,ot).audioEnabled?(d(this,ot).setAudioTrack(await this.getTransformedAudioTrack(d(this,ot).rawAudioTrack)),d(this,ot).emit("AUDIO_TRACK_CHANGE"),{success:!0,message:"Successfully applied the audio middleware."}):{success:!0,message:"Successfully added the audio middleware. It will be applied automatically once mic is turned on."})}async removeAudioMiddleware(e){const t=this.audioMiddlewares.indexOf(e,0);return t>-1?(this.audioMiddlewares.splice(t,1),d(this,ot).audioEnabled&&(d(this,ot).setAudioTrack(await this.getTransformedAudioTrack(d(this,ot).rawAudioTrack)),d(this,ot).emit("AUDIO_TRACK_CHANGE")),{success:!0,message:"Successfully removed the audio middleware."}):{success:!0,message:"No such audio middleware was found. Skipping."}}}ot=new WeakMap,kn=new WeakMap,Ra([_.trace("MediaMiddlewareUtils.getTransformedVideoTrack")],gn.prototype,"getTransformedVideoTrack",1),Ra([_.trace("MediaMiddlewareUtils.addVideoMiddleware")],gn.prototype,"addVideoMiddleware",1),Ra([_.trace("MediaMiddlewareUtils.removeVideoMiddleware")],gn.prototype,"removeVideoMiddleware",1),Ra([_.trace("MediaMiddlewareUtils.getTransformedAudioTrack")],gn.prototype,"getTransformedAudioTrack",1),Ra([_.trace("MediaMiddlewareUtils.addAudioMiddleware")],gn.prototype,"addAudioMiddleware",1),Ra([_.trace("MediaMiddlewareUtils.removeAudioMiddleware")],gn.prototype,"removeAudioMiddleware",1);const $a=class{constructor(){f(this,"mediaPermissionEvent");this.mediaPermissionEvent=!0}static getInstance(){return $a.instance||($a.instance=new $a),$a.instance}get shouldEmitMediaPermissionEvent(){return this.mediaPermissionEvent}setEmitMediaPermissionEvent(e){this.mediaPermissionEvent=e}};let El=$a;f(El,"instance");const yl=El.getInstance(),yB={lowVolumeThreshold:-40,clipThreshold:1,silentThreshold:1/1987,delay:500,media:"audio"},cf=class{constructor(e){S(this,zl);S(this,yc);f(this,"analyser");f(this,"silentThreshold");f(this,"lowVolumeThreshold");f(this,"clipThreshold");f(this,"delay");f(this,"audioContext");f(this,"audioSource");f(this,"metadata",{});f(this,"analysing");f(this,"track");S(this,Ec,void 0);S(this,On,void 0);const{lowVolumeThreshold:t,silentThreshold:s,clipThreshold:i,delay:n,media:a}={...yB,...e};this.lowVolumeThreshold=t,this.silentThreshold=s,this.clipThreshold=i,this.delay=n,this.analysing=!1,R(this,On,a)}setTrack(e){if(!e)return;this.track=e.clone();const t=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new t,this.analyser=this.audioContext.createAnalyser(),d(this,On)==="screenshare"){E.emit(T.SCREENSHARE_AUDIO_TRACK_CREATED);return}E.emit(T.AUDIO_TRACK_CREATED)}getTrackMetadata(){if(!this.track)return null;switch(this.metadata.label=this.track.label,this.metadata.channelCountMode=this.analyser.channelCountMode,this.metadata.channelCount=this.analyser.channelCount,this.metadata.channelInterpretation=this.analyser.channelInterpretation,this.metadata.outputs=this.analyser.numberOfOutputs,this.analyser.numberOfOutputs){case 1:this.metadata.channelType="MONO";break;case 2:this.metadata.channelType="STEREO";break;case 4:this.metadata.channelType="QUAD";break}return this.metadata}async startTrackAnalysis(){if(!this.track||this.analysing)return!1;try{return await this.audioContext.resume(),await be(this,zl,ZE).call(this),this.analysing=!0,!0}catch(e){return g.error(e),!1}}stopTrackAnalysis(){this.analysing&&(this.analysing=!1,clearTimeout(d(this,Ec)))}cleanup(){var e,t,s,i,n;if(this.stopTrackAnalysis(),(e=this.analyser)==null||e.disconnect(),(t=this.audioSource)==null||t.disconnect(this.analyser),(s=this.audioSource)==null||s.disconnect(),(i=this.audioContext)==null||i.close(),this.audioContext=void 0,this.analyser=void 0,this.audioSource=void 0,(n=this.track)==null||n.stop(),this.track=void 0,d(this,On)==="screenshare"){E.emit(T.SCREENSHARE_AUDIO_TRACK_CLOSED);return}E.emit(T.AUDIO_TRACK_CLOSED)}static dbFS(e){const t=20*(Math.log(e)/Math.log(10));return Math.round(t*10)/10}};let Sl=cf;Ec=new WeakMap,On=new WeakMap,zl=new WeakSet,ZE=async function(){try{const e=new MediaStream;e.addTrack(this.track),this.audioSource=this.audioContext.createMediaStreamSource(e),this.audioSource.connect(this.analyser),await new Promise(t=>{window.requestAnimationFrame(()=>{be(this,yc,pf).call(this),t(!0)})})}catch(e){g.error(e)}},yc=new WeakSet,pf=function(){const e=new Float32Array(this.analyser.fftSize);this.analyser.getFloatTimeDomainData(e);let t=0;for(const a of e)t+=a*a;const s=Math.sqrt(t/e.length),i=cf.dbFS(s),n={volume:s,lowVolume:i<this.lowVolumeThreshold,silence:s<this.silentThreshold,clip:s>this.clipThreshold,timestamp:new Date().getTime()};d(this,On)==="screenshare"?E.emit(T.SCREENSHARE_AUDIO_TRACK_ANALYSIS,n):E.emit(T.AUDIO_TRACK_ANALYSIS,n),R(this,Ec,setTimeout(()=>{window.requestAnimationFrame(be(this,yc,pf).bind(this))},this.delay))};const ls=new Sl,_n=new Sl({media:"screenshare"});var SB=Object.defineProperty,wB=Object.getOwnPropertyDescriptor,Be=(r,e,t,s)=>{for(var i=s>1?void 0:s?wB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&SB(e,t,i),i};const ST=(dE=class extends Jt.EventEmitter{constructor(e,t){super();S(this,Re,void 0);S(this,bi,void 0);f(this,"mediaMiddlewareUtils");f(this,"audioTrack");f(this,"rawAudioTrack");f(this,"videoTrack");f(this,"rawVideoTrack");f(this,"screenShareTracks");f(this,"audioEnabled");f(this,"videoEnabled");f(this,"screenShareEnabled");f(this,"currentDevices");f(this,"permissions");f(this,"audioUpdateInProgress");f(this,"videoUpdateInProgress");f(this,"audioRestartInProgress");f(this,"videoRestartInProgress");f(this,"screenShareUpdateInProgress");R(this,Re,e),R(this,bi,new e_(t)),this.audioEnabled=!0,this.videoEnabled=!0,this.audioUpdateInProgress=!1,this.videoUpdateInProgress=!1,this.audioRestartInProgress=!1,this.videoRestartInProgress=!1,this.screenShareUpdateInProgress=!1,this.screenShareEnabled=!1,this.permissions={audio:"NOT_REQUESTED",video:"NOT_REQUESTED",screenshare:"NOT_REQUESTED"},this.screenShareTracks={audio:void 0,video:void 0},this.currentDevices={audio:void 0,video:void 0,speaker:void 0},d(this,Re).onDeviceChange((s,i)=>this.onDeviceChange(i,!1)),this.conditionallyRestartAudio=this.conditionallyRestartAudio.bind(this),this.conditionallyRestartVideo=this.conditionallyRestartVideo.bind(this),this.onVisibilityChange=this.onVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChange),this.on("AUDIO_TRACK_CHANGE",()=>{this.notifyIfTrackSilent()}),E.on(T.PRODUCER_TRACK_ENDED,({kind:s})=>{s==="mic"&&this.conditionallyRestartAudio(),s==="webcam"&&this.conditionallyRestartVideo()})}handlePermissionErrors(e,t){const s=vl(e,t.name,t.message);this.permissions[e]=s,E.emit(T.MEDIA_PERMISSION_ERROR,{message:s,constraints:t.constraints,kind:e})}async repopulateAvailableDevices(){return d(this,Re).repopulateAvailableDevices()}onVisibilityChange(e){document.visibilityState==="visible"&&(he.isMobile()&&this.conditionallyRestartAudio(),this.conditionallyRestartVideo()),L.tabChanged(document.visibilityState==="visible"),document.visibilityState!=="visible"?L.browserBackgrounded():L.browserForegrounded()}async conditionallyRestartAudio(e){var s,i;if(this.audioRestartInProgress||(this.audioRestartInProgress=!0,!((s=this.currentDevices)!=null&&s.audio)||!this.audioEnabled))return;await Promise.race([new Promise(n=>{var a;return(a=this.rawAudioTrack)==null?void 0:a.addEventListener("unmute",o=>{n(o)})}),new Promise(n=>setTimeout(n,50))]),g.info("performingCheck::shouldReacquireAudioTrack",{actions:{trackRobustness:{eventType:e==null?void 0:e.type}}});const t=await this.shouldReacquireTrack("audio");g.info("performedCheck::shouldReacquireAudioTrack",{actions:{trackRobustness:{reacquireTrack:t}}}),t&&(g.info("reacquiring_audio_track"),this.removeMediaStreamTrackListeners(this.rawAudioTrack),he.isChromiumBased()&&await d(this,Re).repopulateAvailableDevices(),await this.setupAudioStream((i=this.currentDevices.audio)==null?void 0:i.deviceId),this.addMediaStreamTrackListeners(this.rawAudioTrack),this.emit("AUDIO_TRACK_CHANGE")),this.audioRestartInProgress=!1}async conditionallyRestartVideo(e){var s;if(this.videoRestartInProgress||(this.videoRestartInProgress=!0,!((s=this.currentDevices)!=null&&s.video)||!this.videoEnabled))return;g.info("performingCheck::shouldReacquireVideoTrack",{actions:{trackRobustness:{eventType:e==null?void 0:e.type}}}),await Promise.race([new Promise(i=>{var n;return(n=this.rawVideoTrack)==null?void 0:n.addEventListener("unmute",i)}),new Promise(i=>setTimeout(i,50))]);const t=await this.shouldReacquireTrack("video");g.info("performedCheck::shouldReacquireVideoTrack",{actions:{trackRobustness:{reacquireTrack:t}}}),t&&(g.info("reacquiring_video_track"),this.removeMediaStreamTrackListeners(this.rawVideoTrack),await d(this,Re).repopulateAvailableDevices(),await this.setupVideoStream(this.currentDevices.video.deviceId),this.addMediaStreamTrackListeners(this.rawVideoTrack),this.emit("VIDEO_TRACK_CHANGE")),this.videoRestartInProgress=!1}async shouldReacquireTrack(e){if(e==="audio"){if(this.audioUpdateInProgress||!this.audioEnabled)return!1;if(!this.rawAudioTrack||!this.audioTrack)return!0;const n=this.rawAudioTrack.muted||this.audioTrack.muted,o=(this.rawAudioTrack.readyState==="ended"||this.audioTrack.readyState==="ended")&&this.audioEnabled,c=await zo(this.rawAudioTrack);return document.visibilityState==="visible"&&(c||o||n)}if(this.videoUpdateInProgress||!this.videoEnabled)return!1;if(!this.rawVideoTrack||!this.videoTrack)return!0;const t=this.rawVideoTrack.muted||this.videoTrack.muted,i=(this.rawVideoTrack.readyState==="ended"||this.videoTrack.readyState==="ended")&&this.videoEnabled;return document.visibilityState==="visible"&&(i||t)}onAudioUnmute(e){g.info("audio_track_unmuted",{actions:{trackRobustness:{eventType:e==null?void 0:e.type}}})}onVideoUnmute(e){g.info("video_track_unmuted",{actions:{trackRobustness:{eventType:e==null?void 0:e.type}}})}removeMediaStreamTrackListeners(e){if(g.info(`Removing ${e.kind} listerners`),!e)return;const t=e.kind==="audio"?this.conditionallyRestartAudio:this.conditionallyRestartVideo;return e.removeEventListener("ended",t),e.removeEventListener("mute",t),e.removeEventListener("unmute",e.kind==="audio"?this.onAudioUnmute:this.onVideoUnmute),e}addMediaStreamTrackListeners(e){if(!e)return null;g.info(`adding_${e.kind}_stream_listerners`);const t=e.kind==="audio",s=t?this.conditionallyRestartAudio:this.conditionallyRestartVideo;return e.addEventListener("ended",async()=>{await s();const i=t?this.audioEnabled:this.videoEnabled,n=t?this.audioTrack:this.videoTrack,a=t?"FORCE_MUTE_AUDIO":"FORCE_MUTE_VIDEO";i&&!(n&&n.readyState==="live"&&n.enabled)&&(g.info(`LocalMediaHandler::trackEnded::Failed to restart ${e.kind} track`),this.emit(a))}),e.addEventListener("mute",s),e.addEventListener("unmute",t?this.onAudioUnmute:this.onVideoUnmute),e}async notifyIfTrackSilent(){var e,t,s,i,n,a;this.audioEnabled&&this.audioTrack&&this.audioTrack.readyState!=="ended"&&this.audioTrack.enabled&&await zo(this.audioTrack)===!0&&(g.info("LocalMediaHandler:notifyIfTrackSilent:TrackSilent",{media:{audio:{enabled:this.audioEnabled,deviceId:(t=(e=this.audioTrack)==null?void 0:e.getSettings())==null?void 0:t.deviceId,permission:(s=this.permissions)==null?void 0:s.audio,deviceName:(n=(i=this.currentDevices)==null?void 0:i.audio)==null?void 0:n.label,trackId:(a=this.audioTrack)==null?void 0:a.id}}}),this.emit("AUDIO_TRACK_SILENT"))}async setupAudioStream(e,t=!0){var s,i,n;if(!this.audioUpdateInProgress)try{this.audioUpdateInProgress=!0;const a=d(this,Re).getAudioDevices();if(!a.length)return;let o=e;(!o||!a.find(l=>l.deviceId===o))&&(o=await this.getPreferredDeviceId("AUDIO"),g.debug("setupAudioStream::AUDIO::getPreferredDeviceId",{preferredDevice:{preferredDeviceId:o,kind:"audio"}}));const c=We.getAudioConstraints({audioDeviceId:o});t&&((s=this.rawAudioTrack)==null||s.stop(),(i=this.audioTrack)==null||i.stop()),this.rawAudioTrack=await We.getAudioTrack(c),o=this.rawAudioTrack.getSettings().deviceId,((n=this.currentDevices.audio)==null?void 0:n.deviceId)!==o&&(this.currentDevices.audio=d(this,Re).getDeviceById(o,"audioinput"),this.emit("DEVICE_CHANGE",{device:this.currentDevices.audio})),this.rawAudioTrack.enabled=this.audioEnabled,this.setAudioTrack(await this.mediaMiddlewareUtils.getTransformedAudioTrack(this.rawAudioTrack)),this.addMediaStreamTrackListeners(this.rawAudioTrack),await d(this,Re).repopulateAvailableDevices(),this.permissions.audio="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),L.mediaPermission("AUDIO",Ys.ACCEPTED),L.selectedDevice("AUDIO",this.currentDevices.audio),o&&As.setItem("lastUsedAudioDeviceId",o)}catch(a){this.handlePermissionErrors("audio",a)}finally{this.audioUpdateInProgress=!1}}async getPreferredDeviceId(e){var s,i;let t;if(e==="AUDIO"){const n=d(this,Re).getAudioDevices(),a=As.getItem("lastUsedAudioDeviceId");g.debug("getPreferredDeviceId::lastUsedAudioDeviceId",{preferredDevice:{lastUsedPreferredDeviceId:a,kind:"audio"}});let o;a&&(o=n.find(c=>c.deviceId===a)),o?t=a:x.hasFeature(U.REMOVE_OPERATIONAL_MIC)||(t=(await this.getOperationalMicDeviceId()).deviceId),t||(t=(s=n[0])==null?void 0:s.deviceId)}if(e==="VIDEO"){const n=As.getItem("lastUsedVideoDeviceId");g.debug("getPreferredDeviceId::lastUsedVideoDeviceId",{preferredDevice:{kind:"video",lastUsedPreferredDeviceId:n}});const a=d(this,Re).getVideoDevices();let o;n&&(o=a.find(c=>c.deviceId===n)),o?t=n:t=(await this.getOperationalWebcamDeviceId()).deviceId,t||(t=(i=a[0])==null?void 0:i.deviceId)}return t}async setupVideoStream(e,t=!0){var s,i;if(!this.videoUpdateInProgress)try{this.videoUpdateInProgress=!0;const n=d(this,Re).getVideoDevices();if(!n.length)return;let a=e;if((!a||!n.find(o=>o.deviceId===a))&&(a=await this.getPreferredDeviceId("VIDEO"),g.debug("setupVideoStream::VIDEO::getPreferredDeviceId",{preferredDevice:{preferredDeviceId:a,kind:"video"}})),t&&((s=this.videoTrack)==null||s.stop()),this.videoEnabled){const o=d(this,bi).getVideoConstraints(a);this.rawVideoTrack=await We.getVideoTrack(o),a=this.rawVideoTrack.getSettings().deviceId,this.setVideoTrack(await this.mediaMiddlewareUtils.getTransformedVideoTrack(this.rawVideoTrack)),this.addMediaStreamTrackListeners(this.rawVideoTrack)}await d(this,Re).repopulateAvailableDevices(),((i=this.currentDevices.video)==null?void 0:i.deviceId)!==a&&(this.currentDevices.video=d(this,Re).getDeviceById(a,"videoinput"),this.emit("DEVICE_CHANGE",{device:this.currentDevices.video})),this.permissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),L.mediaPermission("VIDEO",Ys.ACCEPTED),L.selectedDevice("VIDEO",this.currentDevices.video),a&&As.setItem("lastUsedVideoDeviceId",a)}catch(n){this.handlePermissionErrors("video",n)}finally{this.videoUpdateInProgress=!1}}async setupScreenShareStreams(){if(this.screenShareUpdateInProgress)return;const e=d(this,bi).getScreenShareConstraints();x.hasFeature(U.SCREENSHARE_MAX_DIMENSIONS)&&(e.video.width.max=window.screen.width,e.video.height.max=window.screen.height);try{this.screenShareUpdateInProgress=!0;const t=await We.getScreenShareTracks(e);this.setScreenShareTracks(t)}catch(t){throw this.handlePermissionErrors("screenshare",new fn(t.name,t.message,e)),new w(t.message)}finally{this.screenShareUpdateInProgress=!1}}async setupSpeaker(e){var i;const t=d(this,Re).getSpeakerDevices();if(!t.length)return;const s=e!=null?e:t[0].deviceId;((i=this.currentDevices.speaker)==null?void 0:i.deviceId)!==s&&(this.currentDevices.speaker=d(this,Re).getDeviceById(s,"audiooutput"),L.selectedDevice("SPEAKER",this.currentDevices.speaker),this.emit("DEVICE_CHANGE",{device:this.currentDevices.speaker})),document.querySelectorAll("audio").forEach(async n=>{if(typeof n.sinkId!="undefined"&&this.currentDevices.speaker.deviceId&&n.sinkId!==this.currentDevices.speaker.deviceId)try{await n.setSinkId(this.currentDevices.speaker.deviceId)}catch(a){}})}async getOperationalWebcamDeviceId(){const e=d(this,Re).getVideoDevices();if(!e.length)return{isOperational:!1,deviceId:null};yl.setEmitMediaPermissionEvent(!1);const t=[],s=await e.reduce(async(i,n)=>{const a=await i;if(a!==null)return a;const o=d(this,bi).getVideoConstraints(n.deviceId);try{return(await We.getVideoTrack(o)).stop(),n.deviceId}catch(c){g.error("getOperationalWebcamDeviceId::could_not_acquire_video_device",{error:c,constraints:o}),t.push({exception:c,constraints:o})}return a},Promise.resolve(null));if(yl.setEmitMediaPermissionEvent(!0),!s&&t.length>0&&t.length===e.length){const{exception:i,constraints:n}=t[0];throw new fn(i.name,i.message,n)}return s?{isOperational:!0,deviceId:s}:{isOperational:!1,deviceId:e[0].deviceId}}async getOperationalMicDeviceId(){const e=d(this,Re).getAudioDevices();if(!e.length)return{isOperational:!1,deviceId:null};const t=[];yl.setEmitMediaPermissionEvent(!1);const s=await e.reduce(async(i,n)=>{const a=await i;if(a!==null)return a;const o=We.getAudioConstraints({audioDeviceId:n.deviceId});try{const c=await We.getAudioTrack(o),l=await zo(c);if(c==null||c.stop(),!l)return n}catch(c){g.error("getOperationalMicDeviceId::could_not_acquire_audio_device",{error:c,constraints:o}),t.push({exception:c,constraints:o})}return a},Promise.resolve(null));if(yl.setEmitMediaPermissionEvent(!0),!s&&t.length>0&&t.length===e.length){const{exception:i,constraints:n}=t[0];throw new fn(i.name,i.message,n)}return s?{isOperational:!0,deviceId:s.deviceId}:{isOperational:!1,deviceId:e[0].deviceId}}async setupStreams({audio:e,video:t}){var i;const s={};this.currentDevices||(this.currentDevices={audio:void 0,video:void 0,speaker:void 0});try{if(e&&!this.audioUpdateInProgress&&d(this,Re).getAudioDevices().length!==0){const c=await this.getPreferredDeviceId("AUDIO");g.info("setupStreams::AUDIO::getPreferredDeviceId",{preferredDevice:{preferredDeviceId:c,kind:"audio"}});const l=We.getAudioConstraints({audioDeviceId:c});s.audio=l.audio}if(t&&!this.videoUpdateInProgress&&d(this,Re).getVideoDevices().length!==0){const c=await this.getPreferredDeviceId("VIDEO");g.info("setupStreams::VIDEO::getPreferredDeviceId",{preferredDevice:{preferredDeviceId:c,kind:"video"}});const l=d(this,bi).getVideoConstraints(c);s.video=l.video}if(((i=Object.keys(s))==null?void 0:i.length)===0){this.audioEnabled=e!=null?e:this.audioEnabled,this.videoEnabled=t!=null?t:this.videoEnabled,this.audioUpdateInProgress=!1,this.videoUpdateInProgress=!1;return}const{audioTrack:n,videoTrack:a}=await We.getAudioAndVideoTrack(s);e&&n&&(this.audioTrack=n,this.rawAudioTrack=n,this.permissions.audio="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}),this.currentDevices.audio=d(this,Re).getDeviceById(n.getSettings().deviceId,"audioinput"),As.setItem("lastUsedAudioDeviceId",n.getSettings().deviceId)),t&&a&&(this.videoTrack=a,this.rawVideoTrack=a,this.permissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}),this.currentDevices.video=d(this,Re).getDeviceById(a.getSettings().deviceId,"videoinput"),As.setItem("lastUsedVideoDeviceId",a.getSettings().deviceId)),await d(this,Re).repopulateAvailableDevices()}catch(n){n.name==="NotAllowedError"&&(e&&await this.setupAudioStream(),t&&await this.setupVideoStream())}this.audioEnabled=!!this.audioTrack,this.videoEnabled=!!this.videoTrack,this.screenShareEnabled=!1,this.audioUpdateInProgress=!1,this.videoUpdateInProgress=!1,await this.setupSpeaker()}stopAudioTrack(){var e,t;this.audioUpdateInProgress||(this.audioUpdateInProgress=!0,(e=this.audioTrack)==null||e.stop(),(t=this.rawAudioTrack)==null||t.stop(),this.audioEnabled=!1,this.audioUpdateInProgress=!1)}stopVideoTrack(){var e,t;this.videoUpdateInProgress||(this.videoUpdateInProgress=!0,(e=this.videoTrack)==null||e.stop(),(t=this.rawVideoTrack)==null||t.stop(),this.videoEnabled=!1,this.videoUpdateInProgress=!1)}stopScreenShareTracks(e={}){var i,n,a,o;if(this.screenShareUpdateInProgress)return;this.screenShareUpdateInProgress=!0;const{audio:t=!0,video:s=!0}=e;t&&((n=(i=this.screenShareTracks)==null?void 0:i.audio)==null||n.stop()),s&&((o=(a=this.screenShareTracks)==null?void 0:a.video)==null||o.stop()),this.screenShareEnabled=!1,this.screenShareUpdateInProgress=!1}removeAudioTrack(){this.stopAudioTrack(),this.audioTrack=void 0,this.rawAudioTrack=void 0,x.hasFeature(U.TROUBLESHOOTING)&&ls.cleanup()}removeVideoTrack(){this.stopVideoTrack(),this.videoTrack=void 0,this.rawVideoTrack=void 0}removeScreenShareTracks(e){var t;(t=this.screenShareTracks.video)==null||t.removeEventListener("ended",this.onScreenShareEnded),this.stopScreenShareTracks(e),this.screenShareTracks={audio:void 0,video:void 0}}removeAllTracks(){this.removeAudioTrack(),this.removeVideoTrack(),this.removeScreenShareTracks({audio:!!this.screenShareTracks.audio,video:!!this.screenShareTracks.video})}setAudioTrack(e){e!==this.audioTrack&&(e===void 0&&this.stopAudioTrack(),this.audioTrack=e,this.audioTrack&&(this.audioTrack.enabled=this.audioEnabled))}setVideoTrack(e){e!==this.videoTrack&&(e===void 0&&this.stopVideoTrack(),this.videoTrack=e)}setScreenShareTracks(e){var i;const{audio:t,video:s}=e;(!t||!s)&&this.stopScreenShareTracks({audio:!!t,video:!!s}),this.screenShareTracks=e,(i=this.screenShareTracks.video)==null||i.addEventListener("ended",this.onScreenShareEnded.bind(this))}onScreenShareEnded(){this.emit("SCREENSHARE_ENDED")}disableAudio(){this.audioEnabled=!1,this.audioTrack&&(this.audioTrack.enabled=this.audioEnabled),this.rawAudioTrack&&(this.rawAudioTrack.enabled=this.audioEnabled)}async enableAudio(){var e;if(this.permissions.audio==="DENIED"){this.audioEnabled=!1;return}try{if((!this.audioTrack||this.audioTrack.readyState==="ended")&&await this.setupAudioStream((e=this.currentDevices.audio)==null?void 0:e.deviceId),!this.audioTrack||!this.rawAudioTrack){this.audioEnabled=!1,g.error("LocalMediaHandler::enableAudio:Setting up audio stream failed while enabling audio",{debuggingHint:"Refer to SelfController::mediaPermissionError log."});return}this.audioEnabled=!0}catch(t){this.audioEnabled=!1,this.audioTrack=void 0,this.rawAudioTrack=void 0,g.error("LocalMediaHandler::enableAudio",{error:t},!0)}this.audioTrack&&(this.audioTrack.enabled=!0),this.rawAudioTrack&&(this.rawAudioTrack.enabled=!0),!(this.permissions.audio==="ACCEPTED"||!this.audioEnabled)&&(this.permissions.audio="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.audio,kind:"audio"}))}async toggleAudio(){var e;if(this.permissions.audio==="DENIED"){this.audioEnabled=!1;return}try{if((!this.audioTrack||this.audioTrack.readyState==="ended")&&await this.setupAudioStream((e=this.currentDevices.audio)==null?void 0:e.deviceId),!this.audioTrack||!this.rawAudioTrack){this.audioEnabled=!1;return}this.audioEnabled=!this.audioEnabled}catch(t){this.audioEnabled=!1,g.error("LocalMediaHandler::toggleAudio",{error:t},!0)}this.audioTrack&&(this.audioTrack.enabled=this.audioEnabled),this.rawAudioTrack&&(this.rawAudioTrack.enabled=this.audioEnabled)}async toggleVideo(){var e;if(this.permissions.video==="DENIED"){this.videoEnabled=!1;return}if(this.videoEnabled){this.removeVideoTrack();return}this.videoEnabled=!0;try{await this.setupVideoStream((e=this.currentDevices.video)==null?void 0:e.deviceId)}catch(t){this.videoEnabled=!1}this.videoTrack&&(this.videoTrack.enabled=this.videoEnabled),this.rawVideoTrack&&(this.rawVideoTrack.enabled=this.videoEnabled),!(this.permissions.video==="ACCEPTED"||!this.videoEnabled)&&(this.permissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.video,kind:"video"}))}async toggleScreenShare(){if(this.screenShareEnabled){this.removeScreenShareTracks({audio:!!this.screenShareTracks.audio,video:!!this.screenShareTracks.video});return}try{if(await this.setupScreenShareStreams(),this.screenShareEnabled=!0,this.permissions.screenshare==="ACCEPTED")return;this.permissions.screenshare="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:this.permissions.screenshare,kind:"screenshare"})}catch(e){this.screenShareEnabled=!1}}getAllDevices(){return d(this,Re).availableDevices}getDeviceById(e,t){return d(this,Re).getDeviceById(e,t)}getAudioDevices(){return d(this,Re).getAudioDevices()}getVideoDevices(){return d(this,Re).getVideoDevices()}getSpeakerDevices(){return d(this,Re).getSpeakerDevices()}async onDeviceChange(e,t){var s,i;(s=e==null?void 0:e.added)==null||s.forEach(async n=>{n&&(t||!mn(n))&&(n.kind==="audioinput"?(await this.setupAudioStream(n.deviceId),this.emit("AUDIO_TRACK_CHANGE")):n.kind==="videoinput"&&this.videoEnabled?(await this.setupVideoStream(n.deviceId),this.emit("VIDEO_TRACK_CHANGE")):n.kind==="audiooutput"&&await this.setupSpeaker(n.deviceId))}),(i=e==null?void 0:e.removed)==null||i.forEach(async n=>{var a,o,c;n&&((n.kind==="audioinput"&&!this.audioEnabled||n.kind==="videoinput"&&!this.videoEnabled||x.hasFeature(U.DEVICE_REMOVE_EXP)||!he.isChromiumBased())&&(n.kind==="audioinput"&&n.deviceId===((a=this.currentDevices.audio)==null?void 0:a.deviceId)?(await this.setupAudioStream(),this.emit("AUDIO_TRACK_CHANGE")):n.kind==="videoinput"&&n.deviceId===((o=this.currentDevices.video)==null?void 0:o.deviceId)&&(await this.setupVideoStream(),this.emit("VIDEO_TRACK_CHANGE"))),n.kind==="audiooutput"&&n.deviceId===((c=this.currentDevices.speaker)==null?void 0:c.deviceId)&&await this.setupSpeaker())}),this.emit("DEVICE_LIST_UPDATED",e)}static async init(e){const t=await We.init(),s=new ST(t,e),i=new gn(s);return s.mediaMiddlewareUtils=i,s}emit(e,...t){return super.emit(e,...t)}on(e,t){return super.on(e,t)}async removeDocumentEventListeners(){document.removeEventListener("visibilitychange",this.onVisibilityChange)}addAudioMiddleware(e){return this.mediaMiddlewareUtils.addAudioMiddleware(e)}removeAudioMiddleware(e){return this.mediaMiddlewareUtils.removeAudioMiddleware(e)}addVideoMiddleware(e){return this.mediaMiddlewareUtils.addVideoMiddleware(e)}removeVideoMiddleware(e){return this.mediaMiddlewareUtils.removeVideoMiddleware(e)}async enableVideo(){await this.toggleVideo()}async disableVideo(){await this.toggleVideo()}async enableScreenShare(){await this.toggleScreenShare()}async disableScreenShare(){await this.toggleScreenShare()}getCurrentDevices(){return this.currentDevices}destruct(){this.mediaMiddlewareUtils.terminateMiddlewareWebWorker(),d(this,Re).destruct(),this.removeAllTracks(),this.removeAllListeners()}},Re=new WeakMap,bi=new WeakMap,dE);let Ne=ST;Be([_.trace("OldMediaHandler.shouldReacquireTrack")],Ne.prototype,"shouldReacquireTrack",1),Be([_.trace("OldMediaHandler.removeMediaStreamTrackListeners")],Ne.prototype,"removeMediaStreamTrackListeners",1),Be([_.trace("OldMediaHandler.addMediaStreamTrackListeners")],Ne.prototype,"addMediaStreamTrackListeners",1),Be([_.trace("OldMediaHandler.setupAudioStream")],Ne.prototype,"setupAudioStream",1),Be([_.trace("OldMediaHandler.getPreferredDeviceId")],Ne.prototype,"getPreferredDeviceId",1),Be([_.trace("OldMediaHandler.setupVideoStream")],Ne.prototype,"setupVideoStream",1),Be([_.trace("OldMediaHandler.setupScreenShareStreams")],Ne.prototype,"setupScreenShareStreams",1),Be([_.trace("OldMediaHandler.setupSpeaker")],Ne.prototype,"setupSpeaker",1),Be([_.trace("OldMediaHandler.getOperationalWebcamDeviceId")],Ne.prototype,"getOperationalWebcamDeviceId",1),Be([_.trace("OldMediaHandler.getOperationalMicDeviceId")],Ne.prototype,"getOperationalMicDeviceId",1),Be([_.trace("OldMediaHandler.setupStreams")],Ne.prototype,"setupStreams",1),Be([_.trace("OldMediaHandler.stopAudioTrack")],Ne.prototype,"stopAudioTrack",1),Be([_.trace("OldMediaHandler.stopVideoTrack")],Ne.prototype,"stopVideoTrack",1),Be([_.trace("OldMediaHandler.stopScreenShareTracks")],Ne.prototype,"stopScreenShareTracks",1),Be([_.trace("OldMediaHandler.removeAudioTrack")],Ne.prototype,"removeAudioTrack",1),Be([_.trace("OldMediaHandler.removeVideoTrack")],Ne.prototype,"removeVideoTrack",1),Be([_.trace("OldMediaHandler.removeScreenShareTracks")],Ne.prototype,"removeScreenShareTracks",1),Be([_.trace("OldMediaHandler.removeAllTracks")],Ne.prototype,"removeAllTracks",1),Be([_.trace("OldMediaHandler.setAudioTrack")],Ne.prototype,"setAudioTrack",1),Be([_.trace("OldMediaHandler.setVideoTrack")],Ne.prototype,"setVideoTrack",1),Be([_.trace("OldMediaHandler.setScreenShareTracks")],Ne.prototype,"setScreenShareTracks",1),Be([_.trace("OldMediaHandler::disableAudio")],Ne.prototype,"disableAudio",1),Be([_.trace("OldMediaHandler::enableAudio")],Ne.prototype,"enableAudio",1),Be([_.trace("OldMediaHandler.toggleAudio")],Ne.prototype,"toggleAudio",1),Be([_.trace("OldMediaHandler.toggleVideo")],Ne.prototype,"toggleVideo",1),Be([_.trace("OldMediaHandler.toggleScreenShare")],Ne.prototype,"toggleScreenShare",1);class RB extends Ke{constructor(){super(...arguments);f(this,"localMediaHandler")}async init(t={}){var s,i;if(he.init(),!this.localMediaHandler)try{let n=!0;const a=t.constraints||sr;if(_e.defaults.mediaHandler)n=!1,this.localMediaHandler=_e.defaults.mediaHandler.localMediaHandler;else if(navigator.RNLocalMediaHandlerImpl){const{RNLocalMediaHandlerImpl:o}=navigator;this.localMediaHandler=await o.init()}else x.hasFeature(U.NEW_LOCAL_MEDIA_HANDLER)?this.localMediaHandler=new Vr(a):this.localMediaHandler=await Ne.init(a);n&&await this.localMediaHandler.setupStreams({video:(s=t==null?void 0:t.video)!=null?s:!0,audio:(i=t==null?void 0:t.audio)!=null?i:!0})}catch(n){g.error("DyteSelf::init::Failed To Setup Streams",{error:{name:n.name,message:n.message}})}}get audioTrack(){return this.localMediaHandler.audioTrack}get rawAudioTrack(){return this.localMediaHandler.rawAudioTrack}async addAudioMiddleware(t){return this.localMediaHandler.addAudioMiddleware(t)}async removeAudioMiddleware(t){return this.localMediaHandler.removeAudioMiddleware(t)}get videoTrack(){return this.localMediaHandler.videoTrack}get rawVideoTrack(){return this.localMediaHandler.rawVideoTrack}async addVideoMiddleware(t){return this.localMediaHandler.addVideoMiddleware(t)}async removeVideoMiddleware(t){return this.localMediaHandler.removeVideoMiddleware(t)}get screenShareTracks(){return this.localMediaHandler.screenShareTracks}get audioEnabled(){return this.localMediaHandler.audioEnabled}get videoEnabled(){return this.localMediaHandler.videoEnabled}get screenShareEnabled(){return this.localMediaHandler.screenShareEnabled}async enableAudio(){await this.localMediaHandler.enableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async enableVideo(){await this.localMediaHandler.enableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}async disableAudio(){this.localMediaHandler.disableAudio(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}async disableVideo(){await this.localMediaHandler.disableVideo(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}getCurrentDevices(){return this.localMediaHandler.getCurrentDevices()}async getAudioDevices(){return await this.localMediaHandler.getAudioDevices()}async getVideoDevices(){return await this.localMediaHandler.getVideoDevices()}async getSpeakerDevices(){return await this.localMediaHandler.getSpeakerDevices()}getDeviceById(t,s){let i;return s==="audio"?i="audioinput":s==="video"?i="videoinput":s==="speaker"&&(i="audiooutput"),this.localMediaHandler.getDeviceById(t,i)}async setDevice(t){const s={added:[t],removed:[]};if("onDeviceChange"in this.localMediaHandler){await this.localMediaHandler.onDeviceChange(s,!0);return}switch(t.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(t)}catch(i){}finally{this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(t);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(t)}catch(i){}finally{this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}this.emit("deviceUpdate",{device:t})}}const bB={nonBlackPixelLumaThreshold:20,identicalFrameSsimThreshold:.985,media:"video"},Ha=class{constructor(e){S(this,wc);S(this,Yl);S(this,Xl);f(this,"metadata",{});f(this,"video");f(this,"canvas");f(this,"nonBlackPixelLumaThreshold");f(this,"identicalFrameSsimThreshold");f(this,"previousFrame",new Uint8ClampedArray);S(this,Sc,void 0);f(this,"track");f(this,"analysing");S(this,Ci,void 0);S(this,Dn,void 0);f(this,"preview");const{nonBlackPixelLumaThreshold:t,identicalFrameSsimThreshold:s,media:i}={...bB,...e};this.nonBlackPixelLumaThreshold=t,this.identicalFrameSsimThreshold=s,this.analysing=!1,R(this,Ci,i),this.preview=!1}setTrack(e){var i,n,a;(i=this.track)==null||i.stop(),this.track=e;const{height:t,width:s}=(a=(n=this.track)==null?void 0:n.getConstraints())!=null?a:{};if(this.metadata.resolution=[s,t],d(this,Ci)==="screenshare"){E.emit(T.SCREENSHARE_VIDEO_TRACK_CREATED);return}E.emit(T.VIDEO_TRACK_CREATED)}getTrackMetadata(){return this.track?(this.metadata.label=this.track.label,this.metadata):null}async startTrackAnalysis(){var e;return!this.track||this.analysing?!1:(!this.video&&!((e=this.video)!=null&&e.src)&&(R(this,Dn,new MediaStream),d(this,Dn).addTrack(this.track),this.video=document.createElement("video"),this.canvas=document.createElement("canvas"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),[this.video.width,this.video.height]=this.metadata.resolution,this.video.srcObject=d(this,Dn)),window.requestAnimationFrame(be(this,wc,ff).bind(this)),this.analysing=!0,!0)}stopTrackAnalysis(){this.analysing&&(this.analysing=!1,clearTimeout(d(this,Sc)))}cleanup(){var e;if(this.stopTrackAnalysis(),(e=this.track)==null||e.stop(),this.track=void 0,R(this,Dn,void 0),this.video&&(this.video.srcObject=void 0,this.video=void 0),this.canvas=void 0,this.previousFrame=new Uint8ClampedArray,d(this,Ci)==="screenshare"){E.emit(T.SCREENSHARE_VIDEO_TRACK_CLOSED);return}E.emit(T.VIDEO_TRACK_CLOSED)}};let vn=Ha;Sc=new WeakMap,Ci=new WeakMap,Dn=new WeakMap,wc=new WeakSet,ff=function(){var e;try{const t=be(this,Yl,ey).call(this),s=be(this,Xl,ty).call(this,t.data,t.data.length),i=be(e=Ha,Ql,ry).call(e,this.previousFrame,t.data);this.previousFrame=t.data;const n={isBlackFrame:s,videoScore:i,isFrozenFrame:i>this.identicalFrameSsimThreshold,timestamp:new Date().getTime()};d(this,Ci)==="screenshare"?E.emit(T.SCREENSHARE_VIDEO_TRACK_ANALYSIS,n):E.emit(T.VIDEO_TRACK_ANALYSIS,n),R(this,Sc,setTimeout(()=>{this.track&&window.requestAnimationFrame(be(this,wc,ff).bind(this))},3e3))}catch(t){d(this,Ci)==="screenshare"?E.emit(T.SCREENSHARE_VIDEO_TRACK_ANALYSIS_ERROR):E.emit(T.VIDEO_TRACK_ANALYSIS_ERROR)}},Yl=new WeakSet,ey=function(){var t,s;this.canvas.width=(t=this.video)==null?void 0:t.width,this.canvas.height=(s=this.video)==null?void 0:s.height;const e=this.canvas.getContext("2d",{willReadFrequently:!0});return e.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),e.getImageData(0,0,this.canvas.width,this.canvas.height)},Xl=new WeakSet,ty=function(e,t){const s=this.nonBlackPixelLumaThreshold;let i=0;for(let n=4;n<t;n+=4)if(i+=.21*e[n]+.72*e[n+1]+.07*e[n+2],i>s*(n/4))return!1;return!0},Ql=new WeakSet,ry=function(e,t){var Pe,W,Se;if(e.length!==t.length)return 0;const s=.01,i=.03,n=255,a=s*n*(s*n),o=i*n*(i*n),c=o/2,l=be(Pe=Ha,Rc,mf).call(Pe,e),u=l.mean,h=l.variance,p=Math.sqrt(h),m=be(W=Ha,Rc,mf).call(W,t),v=m.mean,y=m.variance,C=Math.sqrt(y),k=be(Se=Ha,Zl,sy).call(Se,e,t,u,v),D=(2*u*v+a)/(u*u+v*v+a),V=(k+c)/(p*C+c),M=(2*p*C+o)/(h+y+o);return D*M*V},Rc=new WeakSet,mf=function(e){let t=0,s;for(s=0;s<e.length;s++)t+=e[s];const i=t/(e.length-1);let n=0;for(s=1;s<e.length;s++)n=e[s-1]-i,t+=e[s]+n*n;return{mean:i,variance:t/e.length}},Zl=new WeakSet,sy=function(e,t,s,i){let n=0;for(let a=0;a<e.length;a+=1)n+=(e[a]-s)*(t[a]-i);return n/e.length},S(vn,Ql),S(vn,Rc),S(vn,Zl);const hr=new vn,ci=new vn({media:"screenshare"});var CB=Object.defineProperty,PB=Object.getOwnPropertyDescriptor,It=(r,e,t,s)=>{for(var i=s>1?void 0:s?PB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&CB(e,t,i),i},_t=(r=>(r.OFF_STAGE="OFF_STAGE",r.REQUESTED_TO_JOIN_STAGE="REQUESTED_TO_JOIN_STAGE",r.ACCEPTED_TO_JOIN_STAGE="ACCEPTED_TO_JOIN_STAGE",r.ON_STAGE="ON_STAGE",r))(_t||{});let it=(lE=class extends RB{constructor(e,t,s,i,n){var a;super();S(this,me);f(this,"id");f(this,"name");f(this,"picture");f(this,"clientSpecificId");f(this,"waitlistStatus");S(this,Mn,void 0);S(this,Vs,void 0);S(this,hs,void 0);S(this,ja,void 0);f(this,"role");f(this,"userId");f(this,"organizationId");f(this,"supportsRemoteControl",!1);f(this,"device");S(this,bc,"OFF_STAGE");f(this,"stageStatus");f(this,"presetName");f(this,"roomState","init");this.id=e,this.userId=t.id,this.name=t.name,this.picture=t.picture,this.clientSpecificId=(a=t.customParticipantId)!=null?a:t.clientSpecificId,this.waitlistStatus="none",R(this,hs,s),R(this,Vs,i),R(this,ja,!1),this.organizationId=t.organizationId,this.supportsRemoteControl=he.isElectron(),this.device=he.getDeviceInfo(),this.presetName=n,R(this,Mn,re.isV2AuthToken?i.viewType:s.viewType),i.viewType!==xt.Chat&&this.updatePermission()}static async __init__(e,t,s,i,n){var l,u,h,p;let a=(u=(l=_e.defaults)==null?void 0:l.audio)!=null?u:!0,o=(p=(h=_e.defaults)==null?void 0:h.video)!=null?p:!0;s.canProduceAudio!=="ALLOWED"&&(a=!1),s.canProduceVideo!=="ALLOWED"&&(o=!1);const c=new it(e,t,s,i,n);return i.viewType===xt.Chat||(await c.init({audio:a,video:o}),c.setupEvents()),c}async updatePermission(){var o,c;if(he.getName()==="firefox")return;const e="microphone",t="camera",s=await((o=navigator==null?void 0:navigator.permissions)==null?void 0:o.query({name:e})),i=await((c=navigator==null?void 0:navigator.permissions)==null?void 0:c.query({name:t})),n=(l,u)=>{this.mediaPermissions[l]=u;const h={message:this.mediaPermissions[l],kind:l};u==="DENIED"?E.emit(T.MEDIA_PERMISSION_ERROR,h):E.emit(T.MEDIA_PERMISSION_UPDATE,h)},a=(l,u)=>{switch(u){case"granted":n(l,"ACCEPTED");break;case"denied":n(l,"DENIED");break}this.localMediaHandler.repopulateAvailableDevices()};s&&(s.onchange=()=>a("audio",s.state)),i&&(i.onchange=()=>a("video",i.state))}setupEvents(){E.on(T.ROOM_NODE_CONNECTED,async({wasDisconnected:e})=>{e&&await this.resetSelf()}),E.on(T.RESET_PRODUCER_STATE,async()=>{if(this.roomJoined&&d(this,me,Te)instanceof Z){if(this.localMediaHandler.videoEnabled&&await d(this,me,Te).shareWebcam(this.localMediaHandler.videoTrack),this.localMediaHandler.audioEnabled)try{await d(this,me,Te).shareMic(this.localMediaHandler.audioTrack)}catch(e){this.localMediaHandler.disableAudio()}this.localMediaHandler.screenShareEnabled&&await d(this,me,Te).shareScreen({video:this.localMediaHandler.screenShareTracks.video,audio:this.localMediaHandler.screenShareTracks.audio})}}),this.localMediaHandler.on("AUDIO_TRACK_CHANGE",async()=>{if(E.emit(T.AUDIO_TRACK_CHANGED),g.info("DyteSelf::setupEvents::AUDIO_TRACK_CHANGE",{...pn(this)}),this.roomJoined&&this.audioEnabled)try{await d(this,me,Te).shareMic(this.audioTrack)}catch(e){g.error("DyteSelf::setupEvents::Error while sharing mic",{error:e}),this.localMediaHandler.disableAudio()}this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}),this.localMediaHandler.on("VIDEO_TRACK_CHANGE",async()=>{if(E.emit(T.VIDEO_TRACK_CHANGED),g.info("DyteSelf::setupEvents::VIDEO_TRACK_CHANGE",{...pn(this)}),this.videoEnabled&&this.roomJoined)try{await d(this,me,Te).shareWebcam(this.videoTrack)}catch(e){g.error("DyteSelf::setupEvents::failed shareWebcam",{error:e}),this.videoEnabled&&await this.localMediaHandler.disableVideo()}this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}),this.localMediaHandler.on("DEVICE_CHANGE",async({device:e})=>{this.emit("deviceUpdate",{device:e})}),this.localMediaHandler.on("DEVICE_LIST_UPDATED",e=>{this.emit("deviceListUpdate",e)}),this.localMediaHandler.on("SCREENSHARE_TRACK_CHANGE",async()=>{if(E.emit(T.SCREENSHARE_TRACK_CHANGED),!this.roomJoined){g.error("DyteSelf.SCREENSHARE_TRACK_CHANGE.LocalMediaInitialized_WithoutRoomNode");return}if(this.screenShareEnabled)try{await d(this,me,Te).shareScreen(this.screenShareTracks)}catch(e){g.error("DyteSelf::setupEvents::Error while sharing screen",{error:e}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}g.info("DyteSelf::setupEvents::SCREENSHARE_TRACK_CHANGE",{...pn(this)}),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}),this.localMediaHandler.on("SCREENSHARE_ENDED",async()=>{await this.disableScreenShare(),g.info("DyteSelf::setupEvents::SCREENSHARE_ENDED",{...pn(this)})}),this.localMediaHandler.on("AUDIO_TRACK_SILENT",()=>{this.emit("audioTrackSilent"),L.mediaTrackMuted("AUDIO")}),this.localMediaHandler.on("FORCE_MUTE_AUDIO",()=>{this.disableAudio()}),this.localMediaHandler.on("FORCE_MUTE_VIDEO",async()=>{this.roomJoined&&await d(this,me,Te).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),L.videoOff()})}get mediaPermissions(){return this.localMediaHandler.permissions}get permissions(){return d(this,hs)}get suggestedTheme(){return d(this,Vs)}get config(){return d(this,Vs)}get roomJoined(){var e;return((e=d(this,me,Te))==null?void 0:e.roomJoined)===!0}setName(e){if(!e)throw new w("Name cannot be empty.");this.name=e}async setupTracks(e={}){var t,s;return e.forceReset&&(d(this,me,Te).stopAllProducers(),this.localMediaHandler.removeAllTracks()),this.localMediaHandler.setupStreams({video:(t=e.video)!=null?t:!0,audio:(s=e.audio)!=null?s:!0})}async resetSelf(){var e,t,s,i,n,a,o,c,l,u;if(L.callEnded(),(s=(t=(e=d(this,me,Te))==null?void 0:e.sfuHandler)==null?void 0:t.cleanupConsumers)==null||s.call(t),await((a=(n=(i=d(this,me,Te))==null?void 0:i.sfuHandler)==null?void 0:n.setupTransports)==null?void 0:a.call(n)),await((o=d(this,me,Te))==null?void 0:o.joinRoom(this.name,!this.localMediaHandler.audioEnabled,d(this,me,Te).roomUUID,d(this,me,Te).meetingTitle,{audio:this.localMediaHandler.audioEnabled,video:this.localMediaHandler.videoEnabled,screen:this.localMediaHandler.screenShareEnabled})),this.localMediaHandler.videoEnabled&&await((c=d(this,me,Te))==null?void 0:c.shareWebcam(this.localMediaHandler.videoTrack)),this.localMediaHandler.audioEnabled)try{await((l=d(this,me,Te))==null?void 0:l.shareMic(this.localMediaHandler.audioTrack))}catch(h){this.localMediaHandler.disableAudio()}this.localMediaHandler.screenShareEnabled&&await((u=d(this,me,Te))==null?void 0:u.shareScreen({video:this.localMediaHandler.screenShareTracks.video,audio:this.localMediaHandler.screenShareTracks.audio}))}async destructMediaHandler(){return this.localMediaHandler.destruct()}async removeDocumentEventListeners(){return this.localMediaHandler.removeDocumentEventListeners()}async enableAudio(){if(this.permissions.canProduceAudio===rn.notAllowed||d(this,Vs).viewType==="WEBINAR"&&d(this,hs).canProduceAudio===rn.canRequest&&(this.webinarStageStatus==="OFF_STAGE"||this.webinarStageStatus==="REQUESTED_TO_JOIN_STAGE")||this.audioEnabled)return;if(await this.localMediaHandler.enableAudio(),this.roomJoined){if(this.audioTrack)try{await d(this,me,Te).shareMic(this.audioTrack)}catch(t){g.error("DyteSelf::enableAudio::Error while sharing mic",{error:t}),this.localMediaHandler.disableAudio()}if(!this.audioEnabled)return;d(this,me,Te).unmuteSelf()}if(this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}),L.audioOn(),x.hasFeature(U.TROUBLESHOOTING))try{ls.setTrack(this.rawAudioTrack)}catch(t){g.error("Troubleshooter::micTest::Error while setting track",{error:t})}}async enableVideo(){var t;if(d(this,hs).canProduceVideo===rn.notAllowed||d(this,Vs).viewType==="WEBINAR"&&d(this,hs).canProduceVideo===rn.canRequest&&(this.webinarStageStatus==="OFF_STAGE"||this.webinarStageStatus==="REQUESTED_TO_JOIN_STAGE")||this.videoEnabled)return;if(await this.localMediaHandler.enableVideo(),this.roomJoined)try{await d(this,me,Te).shareWebcam(this.videoTrack)}catch(s){g.error("DyteSelf::enableVideo::Error while sharing video",{error:s}),this.videoEnabled&&await this.localMediaHandler.disableVideo()}if(this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),g.info("DyteSelf.enableVideo",{...pn(this)}),L.videoOn(),x.hasFeature(U.TROUBLESHOOTING))try{hr.setTrack((t=this.videoTrack)==null?void 0:t.clone())}catch(s){g.error("Troubleshooter::camTest::Error while setting track",{error:s})}}async enableScreenShare(){var t;if(!this.roomJoined)throw new w("Can`t enable screenshare without joining room");if(d(this,hs).canProduceScreenshare===rn.notAllowed||d(this,Vs).viewType==="WEBINAR"&&d(this,hs).canProduceScreenshare===rn.canRequest&&(this.webinarStageStatus==="OFF_STAGE"||this.webinarStageStatus==="REQUESTED_TO_JOIN_STAGE")||this.screenShareEnabled)return;if(await this.localMediaHandler.enableScreenShare(),this.screenShareTracks.audio||this.screenShareTracks.video)try{await d(this,me,Te).shareScreen(this.screenShareTracks)}catch(s){g.error("DyteSelf::enableScreenShare::Error while sharing screen",{error:s}),this.screenShareEnabled&&await this.localMediaHandler.disableScreenShare()}this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks});const e=x.hasFeature(U.TROUBLESHOOTING);if(e&&this.screenShareTracks.audio)try{_n.setTrack(this.screenShareTracks.audio)}catch(s){g.error("Troubleshooter::screenshareMicTest::Error while setting track",{error:s})}if(e&&this.screenShareTracks.video)try{ci.setTrack((t=this.screenShareTracks.video)==null?void 0:t.clone())}catch(s){g.error("Troubleshooter::screenshareCamTest::Error while setting track",{error:s})}}async disableAudio(){this.audioEnabled&&(this.localMediaHandler.disableAudio(),this.roomJoined&&d(this,me,Te).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}),L.audioOff())}async disableVideo(){if(!this.videoEnabled||(await this.localMediaHandler.disableVideo(),this.roomJoined&&await d(this,me,Te).pauseWebcam(),this.mediaPermissions.video!=="ACCEPTED"))return;this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}),L.videoOff(),x.hasFeature(U.TROUBLESHOOTING)&&!hr.preview&&hr.cleanup()}async disableScreenShare(){if(!this.screenShareEnabled)return;await this.localMediaHandler.disableScreenShare(),this.roomJoined&&await d(this,me,Te).disableScreenShare(),this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks}),x.hasFeature(U.TROUBLESHOOTING)&&(ci.cleanup(),_n.cleanup())}getAllDevices(){return this.localMediaHandler.getAllDevices()}setIsPinned(e,t=!0){R(this,ja,e);const s=e?"pinned":"unpinned";t&&this.emit(s,this)}get isPinned(){return d(this,ja)}get webinarStageStatus(){return d(this,bc)}async pin(){if(!this.roomJoined)throw new w("Can`t pin participants without joining room");return d(this,me,Te).pinPeer(this.id)}async unpin(){if(!this.roomJoined)throw new w("Can`t unpin participants without joining room");return d(this,me,Te).pinPeer(null)}async setDevice(e){const t={added:[e],removed:[]};if("onDeviceChange"in this.localMediaHandler){await this.localMediaHandler.onDeviceChange(t,!0);return}switch(e.kind){case"audioinput":try{await this.localMediaHandler.setAudioDevice(e)}catch(s){this.roomJoined&&await d(this,me,Te).muteSelf(),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack})}break;case"audiooutput":await this.localMediaHandler.setSpeakerDevice(e);break;case"videoinput":try{await this.localMediaHandler.setVideoDevice(e)}catch(s){this.roomJoined&&await d(this,me,Te).pauseWebcam(),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack})}break}this.emit("deviceUpdate",{device:e})}cleanUpTracks(){var e,t,s,i;(e=this.audioTrack)==null||e.stop(),(t=this.rawAudioTrack)==null||t.stop(),(s=this.videoTrack)==null||s.stop(),(i=this.rawVideoTrack)==null||i.stop()}async requestToJoinStage(){if(!this.roomJoined)throw new w("Can`t request to join stage without joining room");if(d(this,Mn)!==xt.Webinar)throw new w("Not allowed to go on stage on non webinar meeting");if(!this.permissions.requestProduce)throw g.error("DyteSelf::requestGoToStage::permission_denied"),new w("User does not have permission to go on stage");await d(this,me,Te).requestToJoinStage(Zh.PRESENT),this.setWebinarStageStatus("REQUESTED_TO_JOIN_STAGE")}async withdrawRequestToJoinStage(){if(!this.roomJoined)throw new w("Can`t request to join stage without joining room");if(d(this,Mn)!==xt.Webinar)throw new w("Not allowed to go on stage on non webinar meeting");this.webinarStageStatus==="REQUESTED_TO_JOIN_STAGE"&&(await d(this,me,Te).withdrawRequestToJoinStage(),this.setWebinarStageStatus("OFF_STAGE"))}async leaveStage(){if(!this.roomJoined)throw new w("Can`t leave stage without joining room");if(d(this,Mn)!==xt.Webinar)throw new w("Not allowed to leave stage on non webinar meeting");await this.disableScreenShare(),await this.disableVideo(),await this.disableAudio(),this.localMediaHandler.destruct(),await d(this,me,Te).stopPresenting(),this.setWebinarStageStatus("OFF_STAGE")}async joinStage(){if(!this.roomJoined)throw new w("Can`t join stage without joining room");if(!this.permissions.canPresent&&this.webinarStageStatus!=="ACCEPTED_TO_JOIN_STAGE")throw g.error("DyteSelf::joinStage::permission_denied"),new w("User does not have permission to join stage");await d(this,me,Te).startPresenting()}setWebinarStageStatus(e){switch(R(this,bc,e),e){case"REQUESTED_TO_JOIN_STAGE":this.emit("peerRequestToJoinStage");break;case"OFF_STAGE":this.emit("stageLeft");break}}async disablePreview(){return this}},Mn=new WeakMap,Vs=new WeakMap,hs=new WeakMap,ja=new WeakMap,bc=new WeakMap,me=new WeakSet,Te=function(){return st()},lE);It([_.trace("DyteSelf.setupEvents")],it.prototype,"setupEvents",1),It([_.trace("DyteSelf.setupTracks")],it.prototype,"setupTracks",1),It([_.trace("DyteSelf.resetSelf")],it.prototype,"resetSelf",1),It([_.trace("DyteSelf.destructMediaHandler")],it.prototype,"destructMediaHandler",1),It([_.trace("DyteSelf.removeDocumentEventListeners")],it.prototype,"removeDocumentEventListeners",1),It([_.trace("DyteSelf.enableAudio")],it.prototype,"enableAudio",1),It([_.trace("DyteSelf.enableVideo")],it.prototype,"enableVideo",1),It([_.trace("DyteSelf.enableScreenShare")],it.prototype,"enableScreenShare",1),It([_.trace("DyteSelf.disableAudio")],it.prototype,"disableAudio",1),It([_.trace("DyteSelf.disableVideo")],it.prototype,"disableVideo",1),It([_.trace("DyteSelf.disableScreenShare")],it.prototype,"disableScreenShare",1),It([_.trace("DyteSelf.setDevice")],it.prototype,"setDevice",1),It([_.trace("DyteSelf.requestToJoinStage")],it.prototype,"requestToJoinStage",1),It([_.trace("DyteSelf.withdrawRequestToJoinStage")],it.prototype,"withdrawRequestToJoinStage",1),It([_.trace("DyteSelf.leaveStage")],it.prototype,"leaveStage",1),It([_.trace("DyteSelf.joinStage")],it.prototype,"joinStage",1),It([_.trace("DyteSelf.deprecated.disablePreview")],it.prototype,"disablePreview",1),it=It([Bt(r=>{throw new w(r.message,"1100")})],it);function AB(r){if(!re.isV2AuthToken)return!1;const e=r;return[e.canProduceAudio,e.canProduceScreenshare,e.canProduceVideo].includes(At.Allowed)}function wT(r){return!(r.viewType==="LIVESTREAM"||r.viewType==="CHAT")}var IB=Object.defineProperty,kB=Object.getOwnPropertyDescriptor,Yo=(r,e,t,s)=>{for(var i=s>1?void 0:s?kB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&IB(e,t,i),i};const RT=(uE=class{constructor(r,e,t){S(this,ct);f(this,"self");f(this,"authToken");f(this,"peerId");S(this,Ga,void 0);f(this,"roomNodeSetupInProgress",!1);S(this,Wr,void 0);var s,i,n,a;R(this,Ga,r),R(this,Wr,t),this.authToken=(i=(s=st())==null?void 0:s.authToken)!=null?i:r.authToken,this.peerId=(a=(n=st())==null?void 0:n.peerId)!=null?a:r.peerId,this.self=e,e.config.viewType!==xt.Chat&&this.setupEvents()}get roomJoined(){var r;return((r=d(this,ct,Pt))==null?void 0:r.roomJoined)===!0}static async init(r,e,t,s,i,n){var u,h;const a=wt(),{isV2AuthToken:o}=re,c=await it.__init__((h=(u=st())==null?void 0:u.peerId)!=null?h:r.peerId,re.isV2AuthToken?t.participant:t,s,i,n),l=o?t.participant.organizationId:t.organizationId;if(_.meetingMetadata.organizationId=l,x.hasFeature(U.INTERNAL_CALL_STATS)&&navigator.product!=="ReactNative"){x.getValue(U.CALLSTATS_INGESTION_LAYER);let p="dev";_e.apiBase.indexOf("cluster.dyte")>-1?p="production":_e.apiBase.indexOf("staging.dyte")>-1&&(p="staging"),setTimeout(async()=>{var m,v;L.initialize({peerId:(v=(m=st())==null?void 0:m.peerId)!=null?v:r.peerId,engineName:he.getDeviceInfo().engineName,env:p,iceServers:await a.getICEServers(),apiBase:_e.apiBase,flags:x.getAllFlags(),logger:g})})}return new RT(r,c,e)}async shareMediaTracks(){if(this.self.audioTrack)try{await d(this,ct,Pt).shareMic(this.self.audioTrack)}catch(r){this.self.disableAudio()}if(this.self.videoTrack)try{await d(this,ct,Pt).shareWebcam(this.self.videoTrack)}catch(r){this.self.disableVideo()}}async kickHandler(r){let e="kicked";(r==null?void 0:r.kickType)==="kickAll"&&(e="ended"),this.leaveRoom(e)}setupEvents(){E.on(T.DISABLE_AUDIO,async()=>{this.self.audioEnabled&&(await this.self.disableAudio(),L.audioOff())}),E.on(T.DISABLE_VIDEO,async()=>{this.self.videoEnabled&&(await this.self.disableVideo(),L.videoOff())}),E.on(T.MUTE_ALL,async()=>{this.self.audioEnabled&&(await this.self.disableAudio(),L.audioOff())}),E.on(T.MUTE_ALL_VIDEO,async()=>{this.self.videoEnabled&&(await this.self.disableVideo(),L.videoOff())}),E.on(T.WAITLISTED,()=>{this.self.waitlistStatus="waiting",this.self.roomState="waitlisted",this.self.emit("waitlisted")}),E.on(T.WAITLIST_ACCEPTED,async()=>{if(this.self.waitlistStatus==="accepted"){g.warn("SelfController.WAITLIST_ACCEPTED.UserAlreadyAccepted");return}this.self.waitlistStatus="accepted",this.joinRoom()}),E.on(T.WAITLIST_REJECTED,async()=>{if(this.self.waitlistStatus==="rejected"){g.warn("SelfController.WAITLIST_REJECTED.UserAlreadyRejected");return}this.self.waitlistStatus="rejected",this.leaveRoom("rejected")}),E.on(T.KICKED,this.kickHandler),d(this,Wr).on(Y.kick,()=>{this.kickHandler({kickType:"kick"})}),d(this,Wr).on(Y.kickAll,()=>{this.kickHandler({kickType:"kickAll"})}),E.on(T.SELF_ROOM_JOINED,()=>{this.self.config.viewType==="WEBINAR"&&this.self.permissions.canPresent&&this.self.joinStage(),this.self.roomState="joined",this.self.emit("roomJoined")}),E.on(T.SOCKET_SERVICE_ROOM_JOINED,()=>{this.self.emit("socketServiceRoomJoined")}),E.on(T.MEDIA_PERMISSION_UPDATE,async r=>{if(r.message==="ACCEPTED"){const e=this.self.getCurrentDevices(),t=await this.self.getAudioDevices(),s=await this.self.getVideoDevices(),i=await this.self.getSpeakerDevices();switch(r==null?void 0:r.kind){case"audio":!e.audio&&t.length>0&&this.self.setDevice(t[0]),!e.speaker&&i.length>0&&this.self.setDevice(i[0]);break;case"video":!e.video&&s.length>0&&this.self.setDevice(s[0]);break}}this.self.emit("mediaPermissionUpdate",r)}),E.on(T.MEDIA_PERMISSION_ERROR,async r=>{const{kind:e,message:t}=r;e==="audio"?(L.mediaPermission("AUDIO",Mp(t)),this.self.disableAudio()):e==="video"?(L.mediaPermission("VIDEO",Mp(t)),this.self.disableVideo()):e==="screenshare"&&(L.mediaPermission("VIDEO",Mp(t)),this.self.disableScreenShare()),g.error("SelfController::mediaPermissionError",{error:{message:r.message},constraints:r.constraints,mediaPermissionsErrors:{kind:e,message:t}}),this.self.emit("mediaPermissionError",r),this.self.emit("mediaPermissionUpdate",{message:t,kind:e})}),E.on(T.REQUEST_TO_JOIN_STAGE_ACCEPTED,()=>{this.self.setWebinarStageStatus(_t.ACCEPTED_TO_JOIN_STAGE),this.self.emit("joinStageRequestAccepted")}),E.on(T.REQUEST_TO_JOIN_STAGE_REJECTED,()=>{this.self.setWebinarStageStatus(_t.OFF_STAGE),this.self.emit("joinStageRequestRejected")}),E.on(T.REMOVED_FROM_STAGE,async()=>{this.self.setWebinarStageStatus(_t.OFF_STAGE),await this.self.disableScreenShare(),await this.self.disableVideo(),await this.self.disableAudio(),this.self.destructMediaHandler(),this.self.emit("removedFromStage")}),E.on(T.STARTED_PRESENTING,()=>{this.self.setWebinarStageStatus(_t.ON_STAGE),this.self.emit("stageJoined")}),E.on(T.STOPPED_PRESENTING,()=>{this.self.setWebinarStageStatus(_t.OFF_STAGE),this.self.emit("stageLeft")}),E.on(T.PRODUCER_SCORE_UPDATE,({score:r,kind:e,appData:t})=>{var i;const s=e==="video"&&((i=t==null?void 0:t.screenShare)!=null?i:!1);this.self.emit("mediaScoreUpdate",{kind:e,isScreenshare:s,score:r})}),E.on(T.PRODUCER_STATUS_UPDATE,({status:r})=>{this.self.emit("mediaChannelUpdate",{status:r})}),E.onAsync(T.JOIN_MEDIA_ROOM,this.setupRoomNode.bind(this)),E.onAsync(T.LEAVE_MEDIA_ROOM,this.leaveMediaRoom.bind(this))}async setupRoomNode(){var e;if(this.roomNodeSetupInProgress){g.warn("SelfController.roomNodeSetupInProgress");return}if((e=d(this,ct,Pt))!=null&&e.roomJoined){g.warn("SelfController.roomNodeAlreadySetup");return}this.roomNodeSetupInProgress=!0;const r=re.roomNodeOptions;await lT({...r,roomName:r.roomName,peerId:r.peerId}),E.once(T.ROOM_NODE_CONNECTED,async()=>{var s,i;let t="";if(d(this,ct,Pt)instanceof Ee){await d(this,ct,Pt).setupTransports();const n=await d(this,ct,Pt).getRoomState();({roomUUID:t}=(i=(s=n==null?void 0:n.payload)==null?void 0:s.roomState)!=null?i:{}),wt().setRoomUUID(t)}await this.joinMediaRoom(t),this.roomNodeSetupInProgress=!1})}async joinRoom(){var r,e;try{const t=wt();let s="";if(d(this,ct,Pt)instanceof Ee){const i=await d(this,ct,Pt).getRoomState();({roomUUID:s}=(e=(r=i==null?void 0:i.payload)==null?void 0:r.roomState)!=null?e:{}),t.setRoomUUID(s)}else t.setRoomUUID(re.meetingId);Z_(this.self.config.viewType,d(this,Ga).capabilities)&&(await d(this,Wr).joinRoom(this.self.name,this.self.id,this.self.userId,s),d(this,Wr).socket.flush(),d(this,Wr).onReconnect=async()=>{await d(this,Wr).joinRoom(this.self.name,this.self.id,this.self.userId,s),d(this,Wr).socket.flush()}),wT(this.self.config)&&await this.joinMediaRoom(s)}catch(t){throw g.error("Error in joinRoom",{error:t}),t}}async leaveRoom(r="left"){var t;const{roomJoined:e}=this;await this.leaveMediaRoom();try{(t=d(this,Ga))==null||t.disconnect()}catch(s){g.error("SelfController::leaveRoom::socketDisconnect")}this.self.roomState=r,VU(),!(this.self.config.viewType!=="LIVESTREAM"&&!e)&&this.self.emit("roomLeft",{state:r})}async joinMediaRoom(r){var t,s,i,n;if((t=d(this,ct,Pt))!=null&&t.isDisconnected&&d(this,ct,Pt)instanceof Ee){(s=d(this,ct,Pt))==null||s.reconnect();return}const{roomJoined:e}=(n=await((i=d(this,ct,Pt))==null?void 0:i.joinRoom(this.self.name,!this.self.audioEnabled,r,void 0,{audio:this.self.audioEnabled,video:this.self.videoEnabled,screen:this.self.screenShareEnabled})))!=null?n:{};d(this,ct,Pt)instanceof Z&&(d(this,ct,Pt).onSocketReconnection=this.joinMediaRoom.bind(this,r)),e&&await this.shareMediaTracks()}async leaveMediaRoom(){await this.cleanupSelf(),d(this,ct,Pt)&&this.roomJoined&&(await d(this,ct,Pt).leaveRoom(),d(this,ct,Pt).roomJoined=!1)}async cleanupSelf(){await this.self.disableAudio(),await this.self.disableVideo(),await this.self.disableScreenShare(),this.self.cleanUpTracks(),this.self.destructMediaHandler(),this.self.removeDocumentEventListeners()}},Ga=new WeakMap,Wr=new WeakMap,ct=new WeakSet,Pt=function(){return st()},uE);let ba=RT;Yo([_.trace("SelfController.setupEvents")],ba.prototype,"setupEvents",1),Yo([_.trace("SelfController.joinRoom")],ba.prototype,"joinRoom",1),Yo([_.trace("SelfController.leaveRoom")],ba.prototype,"leaveRoom",1),Yo([_.trace("SelfController.joinMediaRoom")],ba.prototype,"joinMediaRoom",1),Yo([_.trace("SelfController.leaveMediaRoom")],ba.prototype,"leaveMediaRoom",1);var OB=Object.defineProperty,DB=Object.getOwnPropertyDescriptor,di=(r,e,t,s)=>{for(var i=s>1?void 0:s?DB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&OB(e,t,i),i};let br=(hE=class extends Ke{constructor(e,t){super();S(this,Ir);f(this,"id");f(this,"userId");f(this,"name");f(this,"picture");f(this,"isHost");f(this,"clientSpecificId");f(this,"flags");f(this,"device");f(this,"videoTrack");f(this,"audioTrack");f(this,"screenShareTracks");f(this,"videoEnabled");f(this,"audioEnabled");f(this,"screenShareEnabled");f(this,"producers");S(this,qa,void 0);f(this,"supportsRemoteControl",!1);f(this,"webinarStageStatus",_t.OFF_STAGE);f(this,"presetName");S(this,Nn,void 0);const{id:s,userId:i,displayName:n,device:a,picture:o,isHost:c,flags:l,clientSpecificId:u,customParticipantId:h,audioMuted:p,audioTrack:m,videoEnabled:v=!1,videoTrack:y,producers:C,metadata:k}=e;this.id=s,this.userId=i,this.name=n,this.device=a,this.picture=o,this.isHost=c,this.flags=l,this.clientSpecificId=h!=null?h:u,this.audioEnabled=!p,this.audioTrack=m,this.videoEnabled=v,this.videoTrack=y,this.screenShareTracks={audio:void 0,video:void 0},this.producers=C!=null?C:[],this.presetName=k==null?void 0:k.preset_name,R(this,qa,!1),R(this,Nn,t)}get roomJoined(){var e;return((e=d(this,Ir,_s))==null?void 0:e.roomJoined)===!0}setVideoEnabled(e,t=!0){this.videoEnabled=e,t&&(g.info("DyteParticipant::setVideoEnabled::videoUpdate",{...pn(this)}),this.emit("videoUpdate",{videoEnabled:this.videoEnabled,videoTrack:this.videoTrack}))}setAudioEnabled(e,t=!0){this.audioEnabled=e,t&&(g.info("DyteParticipant::setAudioEnabled::audioUpdate",{...pn(this)}),this.emit("audioUpdate",{audioEnabled:this.audioEnabled,audioTrack:this.audioTrack}))}setScreenShareEnabled(e,t=!0){this.screenShareEnabled=e,t&&this.emit("screenShareUpdate",{screenShareEnabled:this.screenShareEnabled,screenShareTracks:this.screenShareTracks})}async pin(){if(!this.roomJoined)throw new w("Can`t pin participant without joining room");return d(this,Ir,_s).pinPeer(this.id)}async unpin(){if(!this.roomJoined)throw new w("Can`t unpin participant without joining room");return d(this,Ir,_s).pinPeer(null)}setIsPinned(e,t=!0){R(this,qa,e);const s=e?"pinned":"unpinned";t&&this.emit(s,this)}async disableAudio(){const e=this.id;if(g.info("DyteParticipant::disable_audio",{dyteParticipant:{id:e}}),!this.roomJoined)throw new w("Can`t disable participant audio without joining room");if(d(this,Nn).permissions.canDisableParticipantAudio)return d(this,Ir,_s).disableAudio(e);throw g.error("DyteParticipant::unauthorized_disable_audio",{dyteParticipant:{id:e}}),new w("Unauthorized: User does not have permission to disable participant audio.")}async kick(){const e=this.id;if(g.info("DyteParticipant::kick",{dyteParticipant:{id:e}}),!this.roomJoined)throw new w("Can`t kick participant without joining room");if(d(this,Nn).permissions.kickParticipant)return d(this,Ir,_s).kick(e);throw g.error("DyteParticipant::unauthorized_kick",{dyteParticipant:{id:e}}),new w("Unauthorized: User does not have permission to kick participants.")}async disableVideo(){const e=this.id;if(g.info("DyteParticipant::disable_video",{dyteParticipant:{id:e}}),!this.roomJoined)throw new w("Can`t disable participant video without joining room");if(d(this,Nn).permissions.canDisableParticipantVideo)return d(this,Ir,_s).disableVideo(e);throw g.error("DyteParticipant::unauthorized_disable_video",{dyteParticipant:{id:e}}),new w("Unauthorized: User does not have permission to disable participant video.")}async acceptJoinStageRequest(){if(!this.roomJoined)throw new w("Can`t acceptJoinStageRequest for participant without joining room");d(this,Ir,_s).acceptAllRequestToJoinStage([{id:this.id,requestToJoinType:Zh.PRESENT}])}async rejectRequestToJoinStage(){if(!this.roomJoined)throw new w("Can`t rejectRequestToJoinStage for participant without joining room");d(this,Ir,_s).rejectRequestToJoinStage(this.id)}async removeFromStage(){if(!this.roomJoined)throw new w("Can`t removeFromStage participant without joining room");d(this,Ir,_s).removePeerFromStage(this.id,Qh.REQUESTED_BY_MODERATOR)}setWebinarStageStatus(e){this.webinarStageStatus=e;let t;e===_t.OFF_STAGE&&(t="peerStoppedPresenting"),e===_t.ON_STAGE&&(t="peerStartedPresenting"),e===_t.ACCEPTED_TO_JOIN_STAGE&&(t="peerAcceptedToJoinStage"),e===_t.REQUESTED_TO_JOIN_STAGE&&(t="peerRequestToJoinStage"),t&&this.emit(t,this)}get isPinned(){return d(this,qa)}},qa=new WeakMap,Ir=new WeakSet,_s=function(){return st()},Nn=new WeakMap,hE);di([_.trace("DyteParticipant.disableAudio")],br.prototype,"disableAudio",1),di([_.trace("DyteParticipant.kick")],br.prototype,"kick",1),di([_.trace("DyteParticipant.disableVideo")],br.prototype,"disableVideo",1),di([_.trace("DyteParticipant.acceptJoinStageRequest")],br.prototype,"acceptJoinStageRequest",1),di([_.trace("DyteParticipant.rejectRequestToJoinStage")],br.prototype,"rejectRequestToJoinStage",1),di([_.trace("DyteParticipant.removeFromStage")],br.prototype,"removeFromStage",1),di([_.trace("DyteParticipant.setWebinarStageStatus")],br.prototype,"setWebinarStageStatus",1),br=di([Bt(r=>{throw new w(r.message,"1200")})],br);class Up extends Map{constructor(t){const{onAddEvent:s="added",onDeleteEvent:i="deleted",onClearEvent:n="cleared"}=t!=null?t:{};super();S(this,dt,void 0);S(this,Ln,void 0);f(this,"onAddEvent");f(this,"onDeleteEvent");f(this,"onClearEvent");R(this,dt,new Ke),this.onAddEvent=s,this.onDeleteEvent=i,this.onClearEvent=n,R(this,Ln,new Map)}emit(t,...s){return d(this,dt).emit(t,...s)}on(t,s){return d(this,dt).on(t,s)}addListener(t,s){return d(this,dt).addListener(t,s)}off(t,s){return d(this,dt).off(t,s)}once(t,s){return d(this,dt).once(t,s)}prependListener(t,s){return d(this,dt).prependListener(t,s)}prependOnceListener(t,s){return d(this,dt).prependOnceListener(t,s)}removeListener(t,s){return d(this,dt).removeListener(t,s)}removeAllListeners(t){return d(this,dt).removeAllListeners(t)}listeners(t){return d(this,dt).listeners(t)}listenerCount(t){return d(this,dt).listenerCount(t)}getMaxListeners(){return d(this,dt).getMaxListeners()}setMaxListeners(t){return d(this,dt).setMaxListeners(t)}eventNames(){return d(this,dt).eventNames()}add(t,s=!0){return this.set(t.id,t,s)}set(t,s,i=!0){const n=super.set(t,s),a=(o,...c)=>{this.emit(o,s,...c)};return d(this,Ln).set(t,a),s.on("*",a),i&&d(this,dt).emit(this.onAddEvent,s),n}delete(t,s=!0,i=!1){const n=this.get(t);if(!n)return!1;n.removeListener("*",d(this,Ln).get(t));const a=super.delete(t);return i&&n.removeAllListeners(),s&&d(this,dt).emit(this.onDeleteEvent,n),a}clear(t=!0,s=!1){this.forEach(n=>{n.removeListener("*",d(this,Ln).get(n.id)),s&&n.removeAllListeners()});const i=super.clear();return t&&d(this,dt).emit(this.onClearEvent),i}toArray(){return Array.from(this.values())}}dt=new WeakMap,Ln=new WeakMap;class wl extends Up{constructor(e){const{onAddEvent:t="participantJoined",onDeleteEvent:s="participantLeft",onClearEvent:i="participantsCleared"}=e!=null?e:{};super({onAddEvent:t,onDeleteEvent:s,onClearEvent:i})}add(e,t=!0){return super.add(e,t)}clear(e=!0,t=!1){return super.clear(e,t)}delete(e,t=!0,s=!1){return super.delete(e,t,s)}}class MB{constructor(){f(this,"_orderedArray");f(this,"_map");this._map=new Map,this._orderedArray=[]}add(e,t){if(!this._map.has(e))return this._map.set(e,{peerId:e,priority:t}),this._orderedArray.splice(Math.max(t-1,0),0,e),this.index(e);const s=this.index(e);this.delete(e);const i=this.add(e,t);return s!==i?(g.info("DyteSelectedPeer::add()::new_position_for_active_speaker",{selectedPeer:{oldIndex:s,newIndex:i}}),i):-1}delete(e){if(this._map.has(e)){const t=this.index(e);this._map.delete(e),this._orderedArray.splice(t,1)}}index(e){return this._map.has(e)?this._orderedArray.indexOf(e):-1}[Symbol.iterator](){return this._orderedArray[Symbol.iterator]()}}class NB{constructor(){f(this,"_activeSpeakerPeers");f(this,"_compulsoryPeers");this._activeSpeakerPeers=new MB,this._compulsoryPeers=new Set}add(e,t){return t<0?(this._compulsoryPeers.add(e),0):this.compulsoryPeers.includes(e)&&(t>0||t===246267631)&&(g.info("DyteSelectedPeer::removing_compulsory_peer",{selectedPeer:{peerId:e}}),this._removeFromCompulsoryPeer(e),t===246267631)?-1:this._activeSpeakerPeers.add(e,t)}delete(e){g.info("DyteSelectedPeer::deleting_peer_from_selectedPeer",{selectedPeer:{peerId:e}}),this._removeFromCompulsoryPeer(e),this._activeSpeakerPeers.delete(e)}index(e){return this._activeSpeakerPeers.index(e)}get peers(){return[...new Set(this.compulsoryPeers.concat(this.activeSpeakerPeers))]}get compulsoryPeers(){return[...this._compulsoryPeers.values()]}get peerPriorities(){return[...this._activeSpeakerPeers].map((e,t)=>t)}get activeSpeakerPeers(){return[...this._activeSpeakerPeers]}_removeFromCompulsoryPeer(e){this._compulsoryPeers.delete(e)}}class LB extends Ke{constructor(){super();S(this,Pi,void 0);R(this,Pi,new Map)}__set(t,s){return d(this,Pi).set(t,s)}__clear(){return d(this,Pi).clear()}get(t){return d(this,Pi).get(t)}toArray(){return Array.from(d(this,Pi).values())}}Pi=new WeakMap;var xB=Object.defineProperty,UB=Object.getOwnPropertyDescriptor,$r=(r,e,t,s)=>{for(var i=s>1?void 0:s?UB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&xB(e,t,i),i};let pr=(pE=class extends Ke{constructor(e,t){super();S(this,yt);f(this,"waitlisted");f(this,"joined");f(this,"active");f(this,"pinned");f(this,"all");S(this,Ai,void 0);S(this,xn,void 0);f(this,"viewMode");f(this,"currentPage");f(this,"lastActiveSpeaker");f(this,"selectedPeers");R(this,Ai,e),R(this,xn,t),this.waitlisted=new wl,this.joined=new wl,this.active=new wl,this.pinned=new wl,this.all=new LB,this.selectedPeers=new NB,this.viewMode="ACTIVE_GRID",this.currentPage=0}get roomJoined(){var e;return((e=d(this,yt,Nt))==null?void 0:e.roomJoined)===!0}get count(){return this.joined.size}get maxActiveParticipantsCount(){var t,s,i;if(d(this,yt,Nt)instanceof Ee)return d(this,yt,Nt).maxPreferredStreams;const e=d(this,Ai).suggestedTheme;return(i=(s=(t=e==null?void 0:e.grid)==null?void 0:t.multi)==null?void 0:s.maxVideoCount)!=null?i:6}get pageCount(){return this.viewMode==="PAGINATED"?Math.ceil(this.joined.size/this.maxActiveParticipantsCount):0}async acceptWaitingRoomRequest(e){if(!this.roomJoined)throw new w("Can`t accept waiting room request without joining room");return d(this,yt,Nt).acceptWaitingRequest(e)}async rejectWaitingRoomRequest(e){if(!this.roomJoined)throw new w("Can`t reject waiting room request without joining room");await d(this,yt,Nt).rejectWaitingRequest(e),this.waitlisted.delete(e)}async setViewMode(e){if(g.info("DyteParticipants::set_view_mode",{pageNavigation:{viewMode:e,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),!["ACTIVE_GRID","PAGINATED"].includes(e))throw g.error("DyteParticipants::setViewMode::invalid_view_mode",{pageNavigation:{viewMode:e,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),new w(`Invalid view mode: ${e}. Try ACTIVE_GRID or PAGINATED.`);if(this.viewMode===e){g.info("DyteParticipants::setViewMode::view_mode_same_as_previous",{pageNavigation:{viewMode:e,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}});return}if(this.viewMode=e,e==="PAGINATED"){this.currentPage=1;let t=[];d(this,yt,Nt)instanceof Ee?{peerIds:t}=(await d(this,yt,Nt).getPage(this.currentPage)).payload:t=this.getPeerIdsForCurrentPage(),E.emit(T.GET_PAGE,{peerIds:t})}else e==="ACTIVE_GRID"&&(this.currentPage=0,d(this,yt,Nt)instanceof Ee?d(this,yt,Nt).getPage(this.currentPage):E.emit(T.REFRESH_GRID));this.emit("viewModeChanged",{viewMode:e,currentPage:this.currentPage,pageCount:this.pageCount})}getPeerIdsForCurrentPage(){g.info("DyteParticipants::getPeerIdsForCurrentPage()",{pageNavigation:{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}});const{compulsoryPeers:e}=this.selectedPeers,t=[...this.pinned.keys()].filter(a=>!e.includes(a)),s=[...this.joined.keys()],i=Math.max((this.currentPage-1)*(this.maxActiveParticipantsCount-e.length-t.length)),n=this.currentPage*(this.maxActiveParticipantsCount-e.length-t.length);return e.concat(t,s.slice(i,n))}async setPage(e){if(g.info("DyteParticipants::set_page",{pageNavigation:{settingPage:e,viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),this.viewMode!=="PAGINATED")return;if(!Number.isInteger(e))throw g.error("DyteParticipants::invalid_page_number",{pageNavigation:{settingPage:e,viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),new w(`Invalid page: ${e}. Page must be an integer.`);if(e<1||e>this.pageCount)throw g.error("DyteParticipants::invalid_page_number",{pageNavigation:{settingPage:e,viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount,maxActiveParticipantsCount:this.maxActiveParticipantsCount}}),new w(`Invalid page: ${e}. Page must be greater than 0 and less than or equal to ${this.pageCount}.`);this.currentPage=e;let t=[];d(this,yt,Nt)instanceof Ee?{peerIds:t}=(await d(this,yt,Nt).getPage(e)).payload:t=this.getPeerIdsForCurrentPage(),E.emit(T.GET_PAGE,{peerIds:t}),this.emit("pageChanged",{viewMode:this.viewMode,currentPage:this.currentPage,pageCount:this.pageCount})}async disableAllAudio(e){if(g.info("DyteParticipants::disable_all_audio",{actions:{disableAllAudio:{allowUnmute:e}}}),!this.roomJoined)throw new w("Can`t disable all audio without joining room");if(d(this,Ai).permissions.canAllowParticipantAudio)return d(this,yt,Nt).muteAll(e);throw g.error("DyteParticipants::unauthorized_disable_all_audio",{actions:{disableAllAudio:{allowUnmute:e}}}),new w("Unauthorized: User does not have permission to disable peer audio.")}async disableAllVideo(){if(g.info("DyteParticipants::disable_all_video"),!this.roomJoined)throw new w("Can`t disable all video without joining room");if(d(this,Ai).permissions.canAllowParticipantVideo)return d(this,yt,Nt).muteAllVideo();throw g.error("DyteParticipants::unauthorized_disable_all_video"),new w("Unauthorized: User does not have permission to disable peer video.")}async disableAudio(e){this.joined.get(e).disableAudio()}async disableVideo(e){this.joined.get(e).disableVideo()}async kick(e){await this.joined.get(e).kick(),await d(this,xn).kick(e)}async kickAll(){if(g.info("DyteParticipants::kick_all"),!this.roomJoined)throw new w("Can`t kick all without joining room");if(!d(this,Ai).permissions.kickParticipant)throw g.error("DyteParticipants::unauthorized_kick_all"),new w("Unauthorized: User does not have permission to kick peers.");await d(this,yt,Nt).kickAll(),await d(this,xn).kickAll()}async broadcastMessage(e,t){if(g.info("DyteParticipants::broadcastMessage"),!this.roomJoined)throw new w("Can`t broadcast message without joining room");if(!(e!=null&&e.trim()))throw new w("`type` must be a non-empty string.");d(this,yt,Nt)instanceof Ee?d(this,yt,Nt).broadcastMessage(e,t):d(this,xn).broadcastMessage(e,t)}async acceptAllRequestToJoinStageRequests(e){if(!this.roomJoined)throw new w("Can`t acceptAllRequestToJoinStageRequests without joining room");d(this,yt,Nt).acceptAllRequestToJoinStage(e)}},yt=new WeakSet,Nt=function(){return st()},Ai=new WeakMap,xn=new WeakMap,pE);$r([_.trace("DyteParticipants.setViewMode")],pr.prototype,"setViewMode",1),$r([_.trace("DyteParticipants.setPage")],pr.prototype,"setPage",1),$r([_.trace("DyteParticipants.disableAllAudio")],pr.prototype,"disableAllAudio",1),$r([_.trace("DyteParticipants.disableAllVideo")],pr.prototype,"disableAllVideo",1),$r([_.trace("DyteParticipants.disablePeerAudio")],pr.prototype,"disableAudio",1),$r([_.trace("DyteParticipants.disablePeerVideo")],pr.prototype,"disableVideo",1),$r([_.trace("DyteParticipants.kickPeer")],pr.prototype,"kick",1),$r([_.trace("DyteParticipants.kickAll")],pr.prototype,"kickAll",1),$r([_.trace("DyteParticipants.broadcastMessage")],pr.prototype,"broadcastMessage",1),$r([_.trace("DyteParticipants.acceptAllRequestToJoinStageRequests")],pr.prototype,"acceptAllRequestToJoinStageRequests",1),pr=$r([Bt(r=>{throw new w(r.message,"1200")})],pr);var BB=Object.defineProperty,FB=Object.getOwnPropertyDescriptor,li=(r,e,t,s)=>{for(var i=s>1?void 0:s?FB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&BB(e,t,i),i};class ks{constructor(e,t,s){S(this,je);f(this,"participants");S(this,Rt,void 0);S(this,Un,void 0);S(this,ps,new Set);S(this,Cc,void 0);S(this,Bn,void 0);f(this,"syncMembers",async()=>{const e=await d(this,Bn).getAllAddedParticipants();this.participants.all.__clear(),e.forEach(t=>this.participants.all.__set(t.userId,t)),this.participants.all.emit("participantsUpdate")});f(this,"chatRoomJoinHandler",async e=>{e.peer&&e.peer.userId!==d(this,Rt).userId&&await this.syncMembers()});R(this,Bn,t),this.participants=new pr(e,d(this,Bn)),R(this,Un,new Map),R(this,Rt,e),R(this,Cc,Yh(e.config.viewType,s)?"socket-service":"room-node"),d(this,Cc)==="socket-service"&&e.config.viewType==="CHAT"?this.setupChatEvents():this.setupEvents()}get roomJoined(){var e;return((e=d(this,je,Qe))==null?void 0:e.roomJoined)===!0}updatePageParticipants(e){const t=new Set(e),s=new Map(this.participants.active);if(this.participants.active.forEach((i,n)=>{this.participants.active.delete(n,!t.has(n))}),t.forEach(i=>{if(!this.participants.joined.get(i)){g.warn("updatePageParticipants::participant_not_in_joined_list",{dyteParticipant:{id:i}});return}this.participants.active.add(this.participants.joined.get(i),!s.get(i))}),d(this,je,Qe)instanceof Z){R(this,ps,new Set(this.participants.active.keys())),Array.from(s.keys()).forEach(n=>{if(t.has(n))return;const a=this.participants.joined.get(n);if(!a)return;const o={producers:a.producers,peerId:a.id};d(this,je,Qe).deactivatePeers(o)});const i=[];this.participants.active.forEach(n=>{const a={peerId:n.id,producers:n.producers};i.push(a)}),d(this,je,Qe).activatePeers(i)}}updatePinnedParticipants(){this.participants.pinned.forEach(e=>{e.setIsPinned(!1),this.participants.pinned.delete(e.id)})}refreshGridParticipants(e=!1){const t=[...this.participants.joined.keys()],s=this.participants.selectedPeers.peers,i=[...this.participants.pinned.keys()];if(this.participants.viewMode!=="ACTIVE_GRID"){g.warn("ParticipantController::refreshGridParticipants::not_refreshing_grid_in_not_active_grid_mode");return}const n=this.participants.maxActiveParticipantsCount-1,a=new Set(s.concat(i).filter(l=>l!==d(this,Rt).id));let o=[...a];const c=n-a.size;if(c>=0){const l=t.filter(u=>!a.has(u)&&u!==d(this,Rt).id).slice(0,c);o=[...a].concat(l)}else o=o.slice(0,n);this.updateActiveParticipantsHiveNode(o,e)}updateActiveParticipantsHiveNode(e,t=!1){if(!this.roomJoined){g.warn("Skipped::ParticipantController::updateActiveParticipants",{roomJoined:this.roomJoined});return}const s=Array.from(this.participants.active.keys()),i=new Map(this.participants.active),n={};e.forEach(u=>{n[u]=!0});const a=[];s.forEach((u,h)=>{(!n[u]||!this.participants.joined.get(u))&&a.push(h)}),e.forEach(u=>{i.get(u)||(s.length<e.length?s.push(u):s[a.shift()]=u)}),s.forEach((u,h)=>{n[u]||s.splice(h,1)}),Array.from(this.participants.active.keys()).forEach(u=>{this.participants.active.delete(u,!n[u])}),s.forEach(u=>{if(!this.participants.joined.get(u)){g.warn("updateActiveParticipants::participant_not_in_joined_list",{dyteParticipant:{id:u}});return}this.participants.active.add(this.participants.joined.get(u),!i.get(u))}),this.updateWebinarStatusForJoinedParticipants(e),this.participants.active.emit("participantsUpdate"),g.info("ParticipantController::updateActiveParticipants::updating_current_selected_peers",{debuggingHint:t?"Forcefully updating currentActiveGridParticipants set":null}),t&&R(this,ps,new Set);const o=new Set(e),c=[],l=[];if(d(this,ps).forEach(u=>{o.has(u)||c.push(u)}),o.forEach(u=>{d(this,ps).has(u)||l.push(u)}),R(this,ps,o),l.length===0&&c.length===0){g.info("ParticipantController::updateActiveParticipants::current_selected_peers_is_same");return}if(d(this,je,Qe)instanceof Z){const u=[];c.forEach(h=>{const p=this.participants.joined.get(h);if(!p)return;const m={producers:p.producers,peerId:p.id};u.push(d(this,je,Qe).deactivatePeers(m))}),Promise.all(u).then(()=>{const h=[];l.forEach(p=>{const m=this.participants.active.get(p);if(!m){g.warn("peer is not in active map which is going to activate, should not happen",{dyteParticipant:{id:p}});return}const v={peerId:m.id,producers:m.producers};h.push(v)}),d(this,je,Qe).activatePeers(h)}).catch(h=>{g.info("Error on deactivating peers",h)})}}updateActiveParticipants(e){if(!this.roomJoined){g.warn("Skipped::ParticipantController::updateActiveParticipants",{roomJoined:this.roomJoined});return}const t=Array.from(this.participants.active.keys()),s=new Map(this.participants.active),i={};e.forEach(a=>{i[a]=!0});const n=[];t.forEach((a,o)=>{(!i[a]||!this.participants.joined.get(a))&&n.push(o)}),e.forEach(a=>{s.get(a)||(t.length<e.length?t.push(a):t[n.shift()]=a)}),t.forEach((a,o)=>{i[a]||t.splice(o,1)}),Array.from(this.participants.active.keys()).forEach(a=>{this.participants.active.delete(a,!i[a])}),t.forEach(a=>{if(!this.participants.joined.get(a)){g.warn("updateActiveParticipants::participant_not_in_joined_list",{dyteParticipant:{id:a}});return}this.participants.active.add(this.participants.joined.get(a),!s.get(a))}),this.updateWebinarStatusForJoinedParticipants(e),this.participants.active.emit("participantsUpdate")}updateActiveParticipantsWithPriorities(e,t=!1){if(!this.roomJoined){g.warn("Skipped::ParticipantController::updateActiveParticipantsWithPriorities",{roomJoined:this.roomJoined});return}e.forEach(s=>{this.participants.joined.get(s.peerId)&&this.participants.selectedPeers.add(s.peerId,s.priority)}),t&&this.refreshGridParticipants()}setupChatEvents(){E.onAsync(T.SOCKET_SERVICE_ROOM_JOINED,this.syncMembers),d(this,Bn).on(Y.joinRoom,this.chatRoomJoinHandler)}setupEvents(){E.on(T.PEER_JOINED,async e=>{var s,i,n;const t=new br(e,d(this,Rt));d(this,Rt).id!==t.id&&!((s=e.flags)!=null&&s.recorder)&&!((i=t.flags)!=null&&i.hidden_participant)&&!((n=t.flags)!=null&&n.hiddenParticipant)&&(this.participants.joined.add(t),this.participants.waitlisted.delete(t.id),this.participants.currentPage===this.participants.pageCount&&d(this,je,Qe)instanceof Ee&&E.emit(T.GET_PAGE,(await d(this,je,Qe).getPage(this.participants.currentPage)).payload))}),E.on(T.WAITLIST_PEER_ADDED,({id:e,name:t})=>{this.participants.waitlisted.add(new br({id:e,displayName:t,audioMuted:!0,videoEnabled:!1,audioTrack:void 0,videoTrack:void 0,userId:void 0,flags:{},isHost:!1},d(this,Rt)))}),E.on(T.WAITLIST_PEER_REMOVED,({id:e})=>{this.participants.waitlisted.delete(e)}),E.on(T.ROOM_JOINED,e=>{d(this,je,Qe)instanceof Z&&this.participants.joined.clear(),e.peers.forEach(t=>{var i,n,a;if((i=t.flags)!=null&&i.recorder||(n=t.flags)!=null&&n.hidden_participant||(a=t.flags)!=null&&a.hiddenParticipant)return;const s=new br(t,d(this,Rt));s.id===e.pinnedPeerId&&(s.setIsPinned(!0,!1),this.participants.pinned.add(s)),this.participants.joined.add(s)}),e.requestToJoinPeersList&&e.requestToJoinPeersList.forEach(({id:t})=>{var s;(s=this.participants.joined.get(t))==null||s.setWebinarStageStatus(_t.REQUESTED_TO_JOIN_STAGE)}),d(this,je,Qe)instanceof Ee&&d(this,je,Qe).getPage(this.participants.currentPage)}),E.on(T.PEER_CLOSED,async({id:e})=>{if(this.participants.joined.delete(e,!0,!0),this.participants.pinned.delete(e,!0,!0),d(this,je,Qe)instanceof Z&&(this.participants.selectedPeers.delete(e),this.participants.active.get(e)&&this.participants.currentPage===0)){this.refreshGridParticipants();return}const{currentPage:t}=this.participants,s=d(this,Rt).config.maxVideoStreams,n=(he.isMobile()?s.mobile:s.desktop)*(t-1),a=this.participants.active.get(e);if(n===0)this.participants.setViewMode("ACTIVE_GRID");else if(this.participants.joined.size<=n)t===2?this.participants.setViewMode("ACTIVE_GRID"):this.participants.setPage(t-1);else if(a){let o=[];d(this,je,Qe)instanceof Ee?{peerIds:o}=(await d(this,je,Qe).getPage(t)).payload:o=this.participants.getPeerIdsForCurrentPage(),E.emit(T.GET_PAGE,{peerIds:o})}}),E.on(T.ROOM_NODE_DISCONNECTED,()=>{Array.from(this.participants.joined.keys()).forEach(e=>{this.participants.joined.delete(e)}),Array.from(this.participants.active.keys()).forEach(e=>{this.participants.active.delete(e)}),Array.from(this.participants.pinned.keys()).forEach(e=>{this.participants.pinned.delete(e)}),this.participants.currentPage=0,this.participants.viewMode="ACTIVE_GRID",this.participants.emit("viewModeChanged",{viewMode:"ACTIVE_GRID",currentPage:this.participants.currentPage,pageCount:this.participants.pageCount}),R(this,ps,new Set)}),E.on(T.PEER_MUTED,({peerId:e})=>{const t=this.participants.joined.get(e);t&&t.setAudioEnabled(!1)}),E.on(T.PEER_UNMUTED,({peerId:e})=>{const t=this.participants.joined.get(e);t&&t.setAudioEnabled(!0)}),E.on(T.CONSUMER_PAUSED,({id:e})=>{this.processConsumerPaused(e)}),E.on(T.CONSUMER_RESUMED,({id:e})=>{this.processConsumerResumed(e)}),E.on(T.NEW_CONSUMER,({id:e})=>{this.processNewConsumer(e)}),E.on(T.CONSUMER_CLOSED,({id:e})=>{this.processConsumerClosed(e)}),E.on(T.GET_PAGE,({peerIds:e})=>{this.participants.viewMode==="PAGINATED"&&this.updatePageParticipants(e)}),E.on(T.SELECTED_PEERS,({peerIds:e,compulsoryPeers:t})=>{if(this.participants.viewMode!=="ACTIVE_GRID")return;if(d(this,je,Qe)instanceof Ee){this.updateActiveParticipants(e);return}const s=e.map((n,a)=>({peerId:n,priority:a+1})),i=t==null?void 0:t.map((n,a)=>({peerId:n,priority:-(a+1)}));s.push(...i!=null?i:[]),s.length>0&&this.updateActiveParticipantsWithPriorities(s)}),E.on(T.SELECTED_PEERS_DIFF,({entries:e})=>{this.participants.viewMode==="ACTIVE_GRID"&&this.updateActiveParticipantsWithPriorities(e,!0)}),E.on(T.REFRESH_GRID,(e=!1)=>{this.participants.viewMode==="ACTIVE_GRID"&&this.refreshGridParticipants(e)}),E.on(T.NEW_PRODUCER,({peerId:e,producer:t})=>{const s=this.participants.joined.get(e);if(!s){g.warn("ParticipantController::NEW_PRODUCER::participant not found",{producer:{id:t==null?void 0:t.producerId,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}},dyteParticipant:{id:e}});return}s.producers.push(t),g.info("ParticipantController::NEW_PRODUCER::producer_added_to_participant",{producer:{id:t==null?void 0:t.producerId,peerId:e,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}}}),(t==null?void 0:t.kind)==="audio"||t!=null&&t.screenShare||d(this,ps).has(e)?d(this,je,Qe).createConsumer({producingPeerId:e,producerId:t.producerId,screenShare:t.screenShare}):g.info("ParticipantController::NEW_PRODUCER::not_consuming_producer",{producer:{id:t==null?void 0:t.producerId,peerId:e,kind:t==null?void 0:t.kind,status:"UNKNOWN",appData:{screenShare:t==null?void 0:t.screenShare}}})}),E.on(T.PRODUCER_CLOSED,({peerId:e,producerId:t})=>{const s=this.participants.joined.get(e);if(!s){g.warn("ParticipantController::NEW_PRODUCER::participant not found",{dyteParticipant:{id:e}});return}s.producers=s.producers.filter(i=>i.producerId!==t)}),E.on(T.PRODUCER_TOGGLE,({peerId:e,producerId:t,paused:s,kind:i})=>{const n=this.participants.joined.get(e);if(n&&i==="audio"){n.setAudioEnabled(!s);const a=n.producers.find(o=>o.producerId===t);a&&(a.pause=s)}}),E.on(T.ACTIVE_SPEAKER,({peerId:e,volume:t})=>{this.participants.lastActiveSpeaker=e,this.participants.emit("activeSpeaker",{peerId:e,volume:t})}),E.on(T.ROOM_MESSAGE,async({payload:e,type:t,timestamp:s})=>{this.participants.emit("broadcastedMessage",{type:t,payload:e,timestamp:s})}),E.on(T.LOW_CONSUMER_SCORE,({peerId:e,score:t,kind:s})=>{const i=this.participants.joined.get(e);i&&(i.emit("poorConnection",{score:t,kind:s}),this.participants.emit("poorConnection",{participantId:e,score:t,kind:s}))}),E.on(T.CONSUMER_SCORE_UPDATE,({score:e,kind:t,appData:s,peerId:i})=>{var o;const n=t==="video"&&((o=s==null?void 0:s.screenShare)!=null?o:!1),a=this.participants.joined.get(i);a&&(a.emit("mediaScoreUpdate",{kind:t,isScreenshare:n,score:e,participantId:i}),this.participants.emit("mediaScoreUpdate",{kind:t,isScreenshare:n,score:e,participantId:i}))}),E.on(T.PEER_PINNED,({peerId:e})=>{if(!e){d(this,Rt).isPinned&&d(this,Rt).setIsPinned(!1),this.participants.pinned.size!==0&&this.updatePinnedParticipants();return}if(e===d(this,Rt).id){this.participants.pinned.size!==0&&this.updatePinnedParticipants(),d(this,Rt).setIsPinned(!0);return}const t=this.participants.joined.get(e);d(this,Rt).isPinned&&d(this,Rt).setIsPinned(!1),this.updatePinnedParticipants(),t.setIsPinned(!0),this.participants.pinned.add(t),d(this,je,Qe)instanceof Z&&d(this,je,Qe).activatePeers([{peerId:t.id,producers:t.producers}]).catch(s=>{g.error("unable to create consumers",{error:s})})}),E.on(T.PEER_REQUESTED_TO_JOIN_STAGE,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.REQUESTED_TO_JOIN_STAGE)}),E.on(T.PEER_WITHDRAWN_REQUEST_TO_JOIN_STAGE,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.OFF_STAGE)}),E.on(T.PEER_REJECTED_TO_JOIN_STAGE,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.OFF_STAGE)}),E.on(T.PEER_ADDED_TO_STAGE,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.ACCEPTED_TO_JOIN_STAGE)}),E.on(T.PEER_REMOVED_FROM_STAGE,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.OFF_STAGE),this.participants.pinned.delete(e)}),E.on(T.PEER_STARTED_PRESENTING,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.ON_STAGE)}),E.on(T.PEER_STOPPED_PRESENTING,({id:e})=>{const t=this.participants.joined.get(e);t==null||t.setWebinarStageStatus(_t.OFF_STAGE),this.participants.pinned.delete(e)})}processMedia(e){var u;const t=d(this,je,Qe).getConsumers(),{peerId:s,kind:i,appData:n,remotelyPaused:a,track:o,producerId:c}=(u=t.get(e))!=null?u:{};if(!s)return g.warn("processMedia::Peer ID is undefined",{consumer:{id:e,kind:i,peerId:s,appData:{supportsRemoteControl:n==null?void 0:n.supportsRemoteControl,screenShare:n==null?void 0:n.screenShare},remotelyPaused:a,producerId:c}}),{};const l=n;return g.info("ParticipantController::processMedia",{consumer:{id:e,peerId:s,kind:i,appData:l,remotelyPaused:a,producerId:c}}),d(this,Un).set(e,{type:i,peerId:s,appData:l,remotelyPaused:a,producerId:c}),{peerId:s,kind:i,appData:l,remotelyPaused:a,track:o,producerId:c}}processConsumerClosed(e){const{peerId:t,type:s,appData:i,remotelyPaused:n,producerId:a}=d(this,Un).get(e)||{},o=this.participants.joined.get(t);if(g.info("ParticipantController::processConsumerClosed",{consumer:{id:e,peerId:t,appData:i,kind:s,remotelyPaused:n,producerId:a}}),d(this,Un).delete(e),!!o){if(i&&i.screenShare){o.setScreenShareEnabled(!1),L.consumerSharedMediaState(e,{screen:!1}),o.screenShareTracks={audio:void 0,video:void 0};return}s==="audio"?(o.setAudioEnabled(!1),L.consumerSharedMediaState(e,{audio:!1}),o.audioTrack=void 0):s==="video"&&(o.setVideoEnabled(!1),L.consumerSharedMediaState(e,{video:!1}),o.videoTrack=void 0)}}processConsumerResumed(e){const{peerId:t,kind:s,appData:i,track:n,remotelyPaused:a,producerId:o}=this.processMedia(e);if(!t)return;g.info("ParticipantController::processConsumerResumed",{consumer:{id:e,peerId:t,kind:s,appData:i,remotelyPaused:a,producerId:o}});const c=this.participants.joined.get(t);if(c){if(i.screenShare){if(s==="video"?c.screenShareTracks.video=n:s==="audio"&&(c.screenShareTracks.audio=n),c.screenShareEnabled)return;c.setScreenShareEnabled(!0),L.consumerSharedMediaState(e,{screen:!0});return}s==="video"?(c.videoTrack=n,c.setVideoEnabled(!0),L.consumerSharedMediaState(e,{video:!0})):s==="audio"&&(c.audioTrack=n,c.setAudioEnabled(c.audioEnabled),L.consumerSharedMediaState(e,{audio:c.audioEnabled}))}}processConsumerPaused(e){g.info(`ParticipantController::processConsumerPaused called for consumerId: ${e}`);const{peerId:t,kind:s,track:i,appData:n,remotelyPaused:a,producerId:o}=this.processMedia(e);if(!t)return;g.info("ParticipantController::processConsumerPaused",{consumer:{id:e,peerId:t,kind:s,appData:n,remotelyPaused:a,producerId:o}});const c=this.participants.joined.get(t);c&&(s==="video"?(c.videoTrack=i,c.setVideoEnabled(!1),L.consumerSharedMediaState(e,{video:!1})):s==="audio"&&(c.audioTrack=i,c.setAudioEnabled(c.audioEnabled),L.consumerSharedMediaState(e,{audio:c.audioEnabled})))}processNewConsumer(e){const{peerId:t,kind:s,remotelyPaused:i,track:n,appData:a,producerId:o}=this.processMedia(e);if(!t)return;g.info("ParticipantController::processNewConsumer",{consumer:{id:e,peerId:t,kind:s,remotelyPaused:i,appData:a,producerId:o}});const c=this.participants.joined.get(t);if(c){if(a.screenShare){s==="video"?c.screenShareTracks.video=n:s==="audio"&&(c.screenShareTracks.audio=n),(!i||d(this,Rt).permissions.isRecorder||x.hasFeature(U.SCREEENSHARE_ERR_HACK))&&c.setScreenShareEnabled(!0),a.supportsRemoteControl&&(c.supportsRemoteControl=!0);return}s==="video"?(c.videoTrack=n,i||c.setVideoEnabled(!0),L.consumerSharedMediaState(e,{video:!i})):s==="audio"&&d(this,je,Qe)instanceof Z&&(c.audioTrack=n,i||c.setAudioEnabled(!0),L.consumerSharedMediaState(e,{audio:!i}))}}updateWebinarStatusForJoinedParticipants(e){e.forEach(t=>{const s=this.participants.joined.get(t);s&&(s.webinarStageStatus=_t.ON_STAGE)})}}Rt=new WeakMap,Un=new WeakMap,ps=new WeakMap,Cc=new WeakMap,Bn=new WeakMap,je=new WeakSet,Qe=function(){return st()},li([_.trace("ParticipantController.updatePageParticipants")],ks.prototype,"updatePageParticipants",1),li([_.trace("ParticipantController.setupChatEvents")],ks.prototype,"setupChatEvents",1),li([_.trace("ParticipantController.setupEvents")],ks.prototype,"setupEvents",1),li([_.trace("ParticipantController.processMedia")],ks.prototype,"processMedia",1),li([_.trace("ParticipantController.processConsumerClosed")],ks.prototype,"processConsumerClosed",1),li([_.trace("ParticipantController.processConsumerResumed")],ks.prototype,"processConsumerResumed",1),li([_.trace("ParticipantController.processConsumerPaused")],ks.prototype,"processConsumerPaused",1),li([_.trace("ParticipantController.processNewConsumer")],ks.prototype,"processNewConsumer",1);var VB=Object.defineProperty,$B=Object.getOwnPropertyDescriptor,HB=(r,e,t,s)=>{for(var i=s>1?void 0:s?$B(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&VB(e,t,i),i};let Bp=(fE=class extends Ke{constructor(e,t,s,i){super();S(this,Pc);S(this,eu,void 0);S(this,Ac,void 0);f(this,"viewType");f(this,"meetingStartedTimestamp");f(this,"meetingTitle");R(this,eu,e),this.viewType=t,R(this,Ac,s),this.meetingTitle=i}get joined(){var e;return(e=d(this,Pc,gf))==null?void 0:e.roomJoined}get roomName(){var e;return(e=d(this,Pc,gf))==null?void 0:e.roomName}get socketConnected(){return d(this,Ac).isConnected}},Pc=new WeakSet,gf=function(){return st()},eu=new WeakMap,Ac=new WeakMap,fE);Bp=HB([Bt(r=>{throw new w(r.message,"0800")})],Bp);var jB=Object.defineProperty,GB=Object.getOwnPropertyDescriptor,qB=(r,e,t,s)=>{for(var i=s>1?void 0:s?GB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&jB(e,t,i),i};class bT{constructor(e,t,s){f(this,"meta");this.meta=new Bp(e,re.isV2AuthToken?e.config.viewType:e.permissions.viewType,t,s),e.config.viewType!==xt.Chat&&this.setupEvents()}get roomName(){return this.meta.roomName}setupEvents(){E.on(T.ROOM_JOINED,e=>{e.startedAt&&(this.meta.meetingStartedTimestamp=new Date(e.startedAt),this.meta.emit("meetingStartTimeUpdate",{meetingStartedTimestamp:this.meta.meetingStartedTimestamp}))}),E.on(T.ROOM_STATE,({createdAt:e})=>{const t=this.meta.meetingStartedTimestamp;if(e&&!t){const s=new Date(e*1e3);this.meta.meetingStartedTimestamp=s,this.meta.emit("meetingStartTimeUpdate",{meetingStartedTimestamp:this.meta.meetingStartedTimestamp})}}),E.on(T.ROOM_NODE_CONNECTED,()=>{this.meta.emit("connected")}),E.on(T.ROOM_NODE_DISCONNECTED,()=>{this.meta.emit("disconnected")}),E.on(T.ICE_CONNECTED,({transport:e})=>{this.meta.emit("iceConnected",{transport:e})}),E.on(T.ICE_DISCONNECTED,({transport:e})=>{this.meta.emit("iceDisconnected",{transport:e})}),E.on(T.ICE_RECONNECTING,({transport:e})=>{this.meta.emit("iceReconnecting",{transport:e})}),E.on(T.ICE_FAILED,({transport:e})=>{this.meta.emit("iceFailed",{transport:e})}),E.on(T.PRODUCER_SCORE_UPDATE,({score:e})=>{e<5&&this.meta.emit("poorConnection",{score:e})}),E.on(T.SOCKET_SERVICE_CONNECTED,()=>{this.meta.emit("socketConnected")}),E.on(T.SOCKET_SERVICE_DISCONNECTED,()=>{this.meta.emit("socketDisconnected")}),E.on(T.SOCKET_SERVICE_RECONNECTING,()=>{this.meta.emit("socketReconnecting")}),E.on(T.SOCKET_SERVICE_RECONNECTION_ATTEMPT,({attempt:e})=>{this.meta.emit("socketReconnectAttempt",{attempt:e})}),E.on(T.SOCKET_SERVICE_RECONNECT_FAILURE,({attempt:e})=>{this.meta.emit("socketReconnectFailure",{attempt:e})}),E.on(T.SOCKET_SERVICE_RECONNECTED,()=>{this.meta.emit("socketReconnected")}),E.on(T.SOCKET_SERVICE_FAILED,()=>{this.meta.emit("socketFailure")}),E.on(T.ROOM_NODE_CONNECTION_ERROR,e=>{const{message:t}=e;t.match(/room '([a-z0-9-]+)' not found/i)&&this.meta.emit("connectionError",{reason:"ROOM_NOT_FOUND"})})}}qB([_.trace("MetaController.setupEvents")],bT.prototype,"setupEvents",1);var KB=Object.defineProperty,WB=Object.getOwnPropertyDescriptor,Fp=(r,e,t,s)=>{for(var i=s>1?void 0:s?WB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&KB(e,t,i),i};const vt={getPeer:14,getPeers:15,chatMessage:16,getRoomName:17,getDisplayTitle:18,getPluginInitiator:19,customPluginEventToParent:20,peerJoined:22,peerLeft:23,sendData:24};let Xo=(mE=class extends Ke{constructor({baseURL:e,createdAt:t,description:s,id:i,name:n,organizationId:a,picture:o,private:c,published:l,staggered:u,tags:h,type:p,updatedAt:m},v,y,C,k,D){super();S(this,Wt);S(this,Kt,void 0);S(this,Ii,void 0);f(this,"baseURL");f(this,"createdAt");f(this,"description");f(this,"id");f(this,"name");S(this,Qt,void 0);S(this,Ka,void 0);S(this,Wa,void 0);f(this,"organizationId");f(this,"picture");f(this,"private");f(this,"published");f(this,"staggered");f(this,"tags");f(this,"type");f(this,"updatedAt");f(this,"config");S(this,Ja,void 0);f(this,"active");f(this,"iframes");f(this,"enabledBy");this.baseURL=e,this.createdAt=new Date(t),this.description=s,this.id=i,this.name=n,R(this,Qt,C),this.organizationId=a,this.picture=o,this.private=c,this.published=l,this.staggered=u,this.tags=h,this.type=p,this.updatedAt=new Date(m),this.active=!1,this.iframes=new Map,R(this,Kt,v),R(this,Ii,y),R(this,Ka,k),R(this,Wa,D),this.enabledBy=""}get roomJoined(){var e;return((e=d(this,Wt,dr))==null?void 0:e.roomJoined)===!0}sendIframeEvent(e){this.iframes.size&&this.iframes.forEach(t=>{const{iframe:s}=t;s&&(navigator.isReactNative?s.postMessage(JSON.stringify(e)):s.contentWindow.postMessage(e,"*"))})}async handleIframeMessage(e){var n,a,o,c;let t;if(d(this,Ii)==="socket-service"){const l=e,{payload:u,uuid:h,type:p}=l;switch(p){case q.customPluginEventToRoom:{d(this,Kt).customPluginEventToRoom(this.id,u,h);break}case q.customPluginEventToPeers:{d(this,Kt).customPluginEventToPeers(this.id,u.peerIds,u,h);break}case q.enablePluginForRoom:{d(this,Kt).enablePluginForRoom(this.id,h);break}case q.enablePluginForPeers:{d(this,Kt).enablePluginForPeers(this.id,u.peerIds,h);break}case q.disablePluginForRoom:{d(this,Kt).disablePluginForRoom(this.id,h);break}case q.disablePluginForPeers:{d(this,Kt).disablePluginForPeers(this.id,u.peerIds,h);break}case q.storeInsertKeys:{d(this,Kt).storeInsertKeys(this.id,u.store,u.insertKeys,h);break}case q.storeGetKeys:{d(this,Kt).storeGetKeys(this.id,u.store,u.getKeys,h);break}case q.storeDeleteKeys:{d(this,Kt).storeDeleteKeys(this.id,u.store,u.deleteKeys,h);break}case q.storeDelete:{d(this,Kt).storeDelete(this.id,u.store,h);break}case vt.chatMessage:{const{messagePayload:m,peerIds:v}=u;if(!d(this,Wa)){this.sendIframeEvent({type:vt.chatMessage,uuid:l.uuid,payload:{error:"Chat is disabled for this room."}});return}try{await d(this,Wa).sendMessage(m,v),this.sendIframeEvent({type:vt.chatMessage,uuid:l.uuid,payload:{success:!0}})}catch(y){this.sendIframeEvent({type:vt.chatMessage,uuid:l.uuid,payload:{error:y}})}break}case vt.getPeer:{let m;const{peerId:v}=u,y={...d(this,Qt),isRecorder:(n=d(this,Qt).permissions)==null?void 0:n.isRecorder,isHidden:d(this,Qt).permissions.hiddenParticipant};v?(m=d(this,Ka).joined.get(u.peerId),d(this,Qt).id===v&&(m=y)):m=y,this.sendIframeEvent({type:vt.getPeer,payload:{peer:m&&vh(m)},uuid:l.uuid});break}case vt.getPeers:{const m=d(this,Ka).joined.toArray().map(v=>vh(v));this.sendIframeEvent({type:vt.getPeers,payload:{peers:m},uuid:l.uuid});break}case vt.getPluginInitiator:{this.sendIframeEvent({type:vt.getPluginInitiator,payload:{enabledBy:this.enabledBy},uuid:l.uuid});break}case vt.getDisplayTitle:{this.sendIframeEvent({type:vt.getDisplayTitle,payload:{displayTitle:d(this,Wt,dr).meetingTitle},uuid:l.uuid});break}case vt.getRoomName:{this.sendIframeEvent({type:vt.getRoomName,payload:{roomName:d(this,Wt,dr).roomName},uuid:l.uuid});break}case vt.customPluginEventToParent:{this.emit(l.payload.eventName,l.payload.data);break}}return}const s=(l,u)=>{if(d(this,Qt).userId===l)return d(this,Qt).id;let h;return u.forEach(p=>{p.userId===l&&(h=p.id)}),h},i=e;switch(i.type){case"pluginEvent":case"storePluginData":case"getPluginData":case"enablePluginForAll":case"enablePluginForUser":case"disablePluginForUser":case"chatMessage":{t=await d(this,Wt,dr).sendMessage(i),this.sendIframeEvent(t);break}case"getJoinedPeers":{t=await d(this,Wt,dr).getRoomState(),this.sendIframeEvent({type:"websocket/get-joined-peers",payload:{...i.payload,peers:t.payload.roomState.peers}});break}case"getPeerInfo":{t=await d(this,Wt,dr).sendMessage({type:i.type,payload:{...i.payload,peerId:(o=(a=i.payload)==null?void 0:a.peerId)!=null?o:d(this,Qt).id}}),this.sendIframeEvent(t);break}case"getRoomState":{t=await d(this,Wt,dr).getRoomState();const{plugins:l,peers:u}=t.payload.roomState,{enabledBy:h}=l.find(m=>m.id===this.id),p=s(h,u);this.sendIframeEvent({type:"websocket/get-room-state",payload:{...i.payload,roomName:t.payload.roomState.roomName,pluginInitiatorPeerId:p,pluginInitiatorUserId:h,peers:t.payload.roomState.peers,displayTitle:t.payload.roomState.displayTitle,roomUUID:t.payload.roomState.roomUUID,currentPeer:d(this,Qt).id,isRecorder:(c=d(this,Qt).permissions)==null?void 0:c.isRecorder}});break}case"getPluginInitiatorId":{t=await d(this,Wt,dr).getRoomState();const{plugins:l,peers:u}=t.payload.roomState,{enabledBy:h}=l.find(m=>m.id===this.id),p=s(h,u);this.sendIframeEvent({type:"websocket/get-plugin-initiator-peer-id",payload:{...i.payload,pluginInitiatorPeerId:p}});break}case"getPluginInitiatorUserId":{t=await d(this,Wt,dr).getRoomState();const{plugins:l}=t.payload.roomState,{enabledBy:u}=l.find(h=>h.id===this.id);this.sendIframeEvent({type:"websocket/get-plugin-initiator-user-id",payload:{...i.payload,pluginInitiatorUserId:u}});break}case"pluginEventToParent":{this.emit(i.payload.eventName,i.payload.data);break}case"toggleViewMode":{this.emit("toggleViewMode",i.payload.data);break}}}sendData(e){if(d(this,Ii)==="socket-service"){this.sendIframeEvent({type:vt.sendData,uuid:"",payload:e});return}this.sendIframeEvent({type:T.PLUGIN_INTERNAL_DATA,payload:{pluginId:this.id,data:e}})}removePluginView(e="default"){var i;const{iframe:t,listener:s}=(i=this.iframes.get(e))!=null?i:{};(t||s)&&(navigator.isReactNative?t.props.onMessage=void 0:window.removeEventListener("message",s),this.iframes.delete(e))}addPluginView(e,t="default"){var a;if(!d(this,Ja))throw g.error("DytePlugin::addPluginView::no_auth_token_set_for_plugin"),new w("No auth token set for plugin.");if(!e)throw g.error("DytePlugin::addPluginView::iframe_was_not_provided"),new w("Iframe was not provided.");this.removePluginView(t);const s=e,i=new URL(this.baseURL),n={auth:d(this,Ja),parent:navigator.isReactNative?this.baseURL:window.location.origin,backend:_e.apiBase,pluginId:this.id,roomName:(a=d(this,Wt,dr).roomName)!=null?a:"",displayTitle:d(this,Wt,dr).meetingTitle};if(Object.keys(n).forEach(o=>{i.searchParams.set(o,n[o])}),s.src=i.href,s.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",s.title=t,navigator.isReactNative)s.props.onMessage=o=>{this.handleIframeMessage(JSON.parse(o.nativeEvent.data))},this.iframes.set(t,{iframe:s});else{const o=async c=>{c.source===e.contentWindow&&await this.handleIframeMessage(c.data)};window.addEventListener("message",o),this.iframes.set(t,{iframe:s,listener:o})}}setActive(e){var t,s;if(this.active=e,e){this.emit("stateUpdate",{active:this.active,pluginId:this.id,bind:this.addPluginView.bind(this),views:(t=this.config)==null?void 0:t.views});return}this.active=!1,this.emit("stateUpdate",{active:this.active,pluginId:this.id,views:(s=this.config)==null?void 0:s.views})}async activateForSelf(){const e=wt(),t=await e.authorizePlugin(this.id);R(this,Ja,t);try{const s=await e.getPluginConfig(this.baseURL);this.config=s}catch(s){g.error("DytePlugin::activateForSelf",{error:s})}this.setActive(!0),this.emit("enabled")}deactivateForSelf(){[...this.iframes.keys()].forEach(e=>{this.removePluginView(e)}),this.iframes.clear(),this.setActive(!1),this.emit("closed")}async enable(){return this.activateForSelf()}disable(){return this.deactivateForSelf()}async activate(){var e,t;(t=(e=d(this,Qt).permissions)==null?void 0:e.plugins)!=null&&t.canStart&&(d(this,Ii)==="socket-service"?d(this,Kt).addPlugin(this.id,this.staggered):await d(this,Wt,dr).addRoomPlugin(this),g.info("plugin::activated",{plugin:{id:this.id,enabledBy:this.enabledBy,name:this.name}}))}async deactivate(){var e,t;(t=(e=d(this,Qt).permissions)==null?void 0:e.plugins)!=null&&t.canClose&&(d(this,Ii)==="socket-service"?d(this,Kt).removePlugin(this.id):await d(this,Wt,dr).removeRoomPlugin(this),g.info("plugin::deactivated",{plugin:{id:this.id,name:this.name}}))}},Kt=new WeakMap,Ii=new WeakMap,Qt=new WeakMap,Ka=new WeakMap,Wa=new WeakMap,Ja=new WeakMap,Wt=new WeakSet,dr=function(){return st()},mE);Fp([_.trace("PluginController.activatePlugin")],Xo.prototype,"activate",1),Fp([_.trace("PluginController.deactivatePlugin")],Xo.prototype,"deactivate",1),Xo=Fp([Bt(r=>{throw new w(r.message,"0600")})],Xo);class CT extends Up{constructor(){super({onAddEvent:"pluginAdded",onDeleteEvent:"pluginDeleted"})}add(e,t=!0){return super.add(e,t)}delete(e,t=!0,s=!1){return super.delete(e,t,s)}}var JB=Object.defineProperty,zB=Object.getOwnPropertyDescriptor,YB=(r,e,t,s)=>{for(var i=s>1?void 0:s?zB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&JB(e,t,i),i};let Vp=class{constructor(){f(this,"all");f(this,"active");this.all=new CT,this.active=new CT}};Vp=YB([Bt(r=>{throw new w(r.message,"0600")})],Vp);var XB=Object.defineProperty,QB=Object.getOwnPropertyDescriptor,$p=(r,e,t,s)=>{for(var i=s>1?void 0:s?QB(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&XB(e,t,i),i};const Hp=(gE=class{constructor(r){S(this,ki,void 0);R(this,ki,r)}async createChannel(r,e,t,s="public",i=!1){const n={displayName:r,targetUserIds:e,displayPictureUrl:t,visibility:s,isDirectMessage:i};i&&(n.visibility="private");const a=await d(this,ki).sendMessagePromise(dn.createChatChannel,D0.toBinary(n)),o=Rs.fromBinary(a.payload).chatChannels;return Hp.formatChannel(o[0])}async updateChannel(r,e){const t=await d(this,ki).sendMessagePromise(dn.updateChatChannel,N0.toBinary({chatChannelId:r,targetUserIds:e.memberIds,displayName:e.displayName,displayPictureUrl:e.displayPictureUrl,visibility:e.visibility})),s=Rs.fromBinary(t.payload).chatChannels;return Hp.formatChannel(s[0])}static formatChannel(r){var s;const{latestMessageAndUnreadCount:e}=r,t={...r,id:r.chatChannelId,memberIds:r.targetUserIds,unreadCount:(s=e==null?void 0:e.unreadCount)!=null?s:0};return e!=null&&e.message&&(t.latestMessage=Gr.formatSocketServiceMessage(e.message)),delete t.chatChannelId,delete t.targetUserIds,delete t.latestMessageAndUnreadCount,t}async getChannelMembers(r){try{const e=await d(this,ki).sendMessagePromise(dn.getChannelMembers,U0.toBinary({chatChannelId:r}));return K0.fromBinary(e.payload).channelMembers.map(({id:t,...s})=>({...s,userId:t}))}catch(e){return[]}}on(r,e){let t,s;switch(r){case dn.createChatChannel:{t=Rs.fromBinary.bind(Rs),s=Rs.create();break}case dn.updateChatChannel:{t=Rs.fromBinary.bind(Rs),s=Rs.create();break}}if(!t){g.warn(`ChatChannelSocketHandler::Event ${r} is not recognized`);return}d(this,ki).on(r,({payload:i})=>{let n=s;try{n=t(i)}catch(a){g.error("ChatChannelSocketHandler::on::binary_decode_error",{error:a})}return e(n)})}},ki=new WeakMap,gE);let Tn=Hp;$p([_.trace("ChatChannelHandler.createChannel")],Tn.prototype,"createChannel",1),$p([_.trace("ChatChannelHandler.updateChannel")],Tn.prototype,"updateChannel",1),$p([_.trace("ChatChannelHandler.getChannelMembers")],Tn.prototype,"getChannelMembers",1);var ZB=Object.defineProperty,eF=Object.getOwnPropertyDescriptor,Hr=(r,e,t,s)=>{for(var i=s>1?void 0:s?eF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&ZB(e,t,i),i},fr=(r=>(r[r.TEXT=0]="TEXT",r[r.IMAGE=1]="IMAGE",r[r.FILE=2]="FILE",r))(fr||{});class Cr{constructor(e){S(this,Zt,void 0);R(this,Zt,e)}getChatMessages(){return d(this,Zt).sendMessagePromise(ft.getMessages)}async getChatMessagesPaginated(e,t,s,i=0,n=""){const a={timeStamp:e,size:t,from:i,reversed:s,channelId:n},o=await d(this,Zt).sendMessagePromise(ft.getPaginatedMessages,a0.toBinary(a));return o.payload?c0.fromBinary(o.payload):{messages:[],next:!1}}sendMessageToRoom(e,t){const s={payloadType:t,payload:e};d(this,Zt).sendMessage(ft.sendMessageToRoom,u0.toBinary(s))}sendMessageToPeers(e,t,s){const i={payloadType:t,peerIds:s,payload:e};d(this,Zt).sendMessage(ft.sendMessageToPeers,f0.toBinary(i))}sendMessageToChannel(e,t,s){const i={payloadType:t,channelId:s,payload:e};d(this,Zt).sendMessage(ft.sendMessageToChannel,_0.toBinary(i))}sendMessage(e,t,s,i){if(i&&this.sendMessageToChannel(e,t,i),s&&s.length>0){this.sendMessageToPeers(e,t,s);return}this.sendMessageToRoom(e,t)}async editMessage(e,t,s,i){const n={chatId:e,payloadType:s,payload:t};i&&(n.channelId=i);const a=await d(this,Zt).sendMessagePromise(ft.editMessage,E0.toBinary(n));return Xd.fromBinary(a.payload).message}async deleteMessage(e,t){const s={chatId:e};t&&(s.channelId=t);const i=await d(this,Zt).sendMessagePromise(ft.deleteMessage,w0.toBinary(s)),n=Qd.fromBinary(i.payload);return{id:n.chatId,...n.channelId?{channelId:n.channelId}:{}}}async searchMessages(e,t){var i,n,a;const s={searchTerm:e,timeStamp:(i=t.timestamp)!=null?i:Date.now(),size:(n=t.size)!=null?n:75,from:0,reversed:(a=t.reversed)!=null?a:!0};t.channelId&&(s.channelId=t.channelId);try{const o=await d(this,Zt).sendMessagePromise(ft.searchChannelMessages,C0.toBinary(s));return vv.fromBinary(o.payload).messages}catch(o){return[]}}async getAllChannels(){try{const e=await d(this,Zt).sendMessagePromise(ft.getAllChatChannels);return Rs.fromBinary(e.payload).chatChannels.map(Tn.formatChannel)}catch(e){return[]}}async markLastReadMessage(e,t){const s=await d(this,Zt).sendMessagePromise(ft.markChannelIndexAsRead,A0.toBinary({channelId:e,userId:t.userId,channelIndex:t.channelIndex}));return k0.fromBinary(s.payload).channelIndex}on(e,t){let s,i;switch(e){case ft.sendMessageToRoom:{s=ap.fromBinary.bind(ap),i=ap.create();break}case ft.sendMessageToPeers:{s=op.fromBinary.bind(op),i=op.create();break}case ft.editMessage:{s=Xd.fromBinary.bind(Xd),i=Xd.create();break}case ft.deleteMessage:{s=Qd.fromBinary.bind(Qd),i=Qd.create();break}}if(!s){g.warn(`ChatSocketHandler::Event ${e} is not recognized`);return}d(this,Zt).on(e,({payload:n})=>{let a=i;try{a=s(n)}catch(o){g.error("chatSocketHandler::on::binary_decode_error",{error:o})}return t(a)})}}Zt=new WeakMap,Hr([_.trace("SocketService.getChatMessages")],Cr.prototype,"getChatMessages",1),Hr([_.trace("SocketService.getChatMessagesPaginated")],Cr.prototype,"getChatMessagesPaginated",1),Hr([_.trace("SocketService.sendMessageToRoom")],Cr.prototype,"sendMessageToRoom",1),Hr([_.trace("SocketService.sendMessageToPeers")],Cr.prototype,"sendMessageToPeers",1),Hr([_.trace("SocketService.sendMessageToChannel")],Cr.prototype,"sendMessageToChannel",1),Hr([_.trace("SocketService.sendMessage")],Cr.prototype,"sendMessage",1),Hr([_.trace("SocketService.editMessage")],Cr.prototype,"editMessage",1),Hr([_.trace("SocketService.deleteMessage")],Cr.prototype,"deleteMessage",1),Hr([_.trace("SocketService.searchMessages")],Cr.prototype,"searchMessages",1),Hr([_.trace("SocketService.getAllChannels")],Cr.prototype,"getAllChannels",1),Hr([_.trace("SocketService.markLastReadMessage")],Cr.prototype,"markLastReadMessage",1);function tF(r,e){return`<blockquote>${e.replace(/<blockquote>[.\s\S]*<\/blockquote>\n\n/m,"")}</blockquote>

${r}`}var rF=Object.defineProperty,sF=Object.getOwnPropertyDescriptor,Gt=(r,e,t,s)=>{for(var i=s>1?void 0:s?sF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&rF(e,t,i),i};const Ca=["text","image","file","poll"];let kt=(_E=class extends Ke{constructor(e,t,s,i,n){super();S(this,$s);f(this,"messages");f(this,"channels",[]);S(this,le,void 0);S(this,Fn,void 0);S(this,Vt,void 0);S(this,Vn,void 0);S(this,$t,void 0);R(this,Vt,e),R(this,Vn,t),R(this,$t,s),R(this,le,i),R(this,Fn,n),this.messages=[]}get roomJoined(){var e;return((e=d(this,$s,zn))==null?void 0:e.roomJoined)===!0}async sendMessageInternal(e,t,s,i={}){switch(e.type){case"text":{const n=i.replyTo&&i.replyTo.type==="text"?tF(e.message,i.replyTo.message):e.message;await this.sendTextMessageInternal(n,t,s);break}case"image":await this.sendImageMessageInternal(e.image,t,s);break;case"file":await this.sendFileMessageInternal(e.file,t,s);break;default:g.error("sendMessage::message_type_not_supported",{dyteChat:{messageType:e.type}});break}}async sendTextMessageInternal(e,t,s){var n,a,o,c,l,u;if(!((a=(n=d(this,le).permissions)==null?void 0:n.chatPublic)!=null&&a.canSend)||!((c=(o=d(this,le).permissions)==null?void 0:o.chatPublic)!=null&&c.text))throw g.error("sendTextMessage::public_chat_permission_denied"),new w("Could not send message to public chat.","0501");if(t&&t.length>0&&(!((l=d(this,le).permissions)!=null&&l.chatPrivate.canSend)||!((u=d(this,le).permissions)!=null&&u.chatPrivate.text)))throw g.error("sendTextMessage::private_chat_permission_denied"),new w("Could not send message to private chat.","0501");if(!e)throw g.error("sendTextMessage::message_can_not_be_empty"),new w("Message can not be empty.","0502");if(s){if(d(this,$t)!=="socket-service")throw new Error("Socket service required for channel support");d(this,Vt).sendMessageToChannel(e,fr.TEXT,s);return}if(d(this,$t)==="socket-service"){let h=[];t&&t.length>0&&(t.push(d(this,le).id),h=d(this,Fn).joined.toArray().filter(p=>t.includes(p.id)).map(p=>p.userId),h.push(d(this,le).userId)),d(this,Vt).sendMessage(e,fr.TEXT,t);return}if(t!==void 0&&t.length>0){g.error("sendTextMessage::private_chat_unsupported");return}const i={userId:d(this,le).userId,displayName:d(this,le).name,message:e,type:Ca.indexOf("text"),time:+new Date};if(!this.roomJoined)throw g.error("DyteChat.sendTextMessage.RoomNodeClientSocketUsed_WithoutRoomJoin"),new w("Can`t sendTextMessage without joining room");await d(this,$s,zn).sendChatMessage(i)}async sendImageMessageInternal(e,t,s){var n,a,o,c,l,u;if(t&&t.length>0){if(!((n=d(this,le).permissions)!=null&&n.chatPrivate.canSend)||!((a=d(this,le).permissions)!=null&&a.chatPrivate.files)){g.error("sendImageMessage::private_chat_permission_denied");return}}else if(!((c=(o=d(this,le).permissions)==null?void 0:o.chatPublic)!=null&&c.canSend)||!((u=(l=d(this,le).permissions)==null?void 0:l.chatPublic)!=null&&u.files)){g.error("sendImageMessage::permission_denied");return}if(!e){g.error("sendImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(e.type)){g.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:e.type}});return}try{const h=wt(),{getLocation:p,putLocation:m}=await h.getPresignedUrls(e.name,d(this,le).config.viewType);if(await h.uploadFile(e,m),s){if(d(this,$t)!=="socket-service")throw new Error("Socket service required for channel support");d(this,Vt).sendMessageToChannel(p,fr.IMAGE,s);return}if(d(this,$t)==="socket-service"){let y=[];t&&t.length>0&&(t.push(d(this,le).id),y=d(this,Fn).joined.toArray().filter(C=>t.includes(C.id)).map(C=>C.userId),y.push(d(this,le).userId)),d(this,Vt).sendMessage(p,fr.IMAGE,t);return}if(t!==void 0&&t.length>0){g.error("sendImageMessage::private_chat_unsupported");return}const v={userId:d(this,le).userId,displayName:d(this,le).name,type:Ca.indexOf("image"),link:p,time:+new Date};if(!this.roomJoined)throw g.error("DyteChat.sendImageMessage.RoomNodeClientSocketUsed_WithoutRoomJoin"),new w("Can`t sendImageMessage without joining room");await d(this,$s,zn).sendChatMessage(v)}catch(h){throw new w("Error sending image message.")}}async sendFileMessageInternal(e,t,s){var i,n,a,o,c,l;if(t&&t.length>0){if(!((i=d(this,le).permissions)!=null&&i.chatPrivate.canSend)||!((n=d(this,le).permissions)!=null&&n.chatPrivate.files)){g.error("sendFileMessage::private_chat_permission_denied");return}}else if(!((o=(a=d(this,le).permissions)==null?void 0:a.chatPublic)!=null&&o.canSend)||!((l=(c=d(this,le).permissions)==null?void 0:c.chatPublic)!=null&&l.files)){g.error("sendFileMessage::permission_denied");return}if(!e){g.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const u=wt(),{getLocation:h,putLocation:p}=await u.getPresignedUrls(e.name,d(this,le).config.viewType);if(await u.uploadFile(e,p),s){if(d(this,$t)!=="socket-service")throw new Error("Socket service required for channel support");d(this,Vt).sendMessageToChannel(JSON.stringify({link:h,name:e.name,size:"size"in e?e.size:0}),fr.FILE,s);return}if(d(this,$t)==="socket-service"){let v=[];t&&t.length>0&&(t.push(d(this,le).id),v=d(this,Fn).joined.toArray().filter(C=>t.includes(C.id)).map(C=>C.userId),v.push(d(this,le).userId));const y=JSON.stringify({link:h,name:e.name,size:"size"in e?e.size:0});d(this,Vt).sendMessage(y,fr.FILE,t);return}if(t!==void 0&&t.length>0){g.error("sendFileMessage::private_chat_unsupported");return}const m={userId:d(this,le).userId,displayName:d(this,le).name,type:Ca.indexOf("file"),link:h,name:e.name,size:"size"in e?e.size:0,time:+new Date};if(!this.roomJoined)throw g.error("DyteChat.sendFileMessage.RoomNodeClientSocketUsed_WithoutRoomJoin"),new w("Can`t sendFileMessage without joining room");await d(this,$s,zn).sendChatMessage(m)}catch(u){throw new w("Error sending file message.")}}async sendTextMessage(e,t){return this.sendTextMessageInternal(e,t)}async sendImageMessage(e,t){return this.sendImageMessageInternal(e,t)}async sendFileMessage(e,t){return this.sendFileMessageInternal(e,t)}async sendMessage(e,t){return this.sendMessageInternal(e,t)}async editTextMessage(e,t,s){var i,n,a,o;if(d(this,$t)!=="socket-service"){g.warn("editTextMessage::Coming soon!");return}if(!((n=(i=d(this,le).permissions)==null?void 0:i.chatPublic)!=null&&n.canSend)||!((o=(a=d(this,le).permissions)==null?void 0:a.chatPublic)!=null&&o.text)){g.error("editTextMessage::permission_denied");return}if(!t){g.error("editTextMessage::message_can_not_be_empty");return}d(this,Vt).editMessage(e,t,fr.TEXT,s)}async editImageMessage(e,t,s){var n,a,o,c;if(d(this,$t)!=="socket-service"){g.warn("editImageMessage::Coming soon!");return}if(!((a=(n=d(this,le).permissions)==null?void 0:n.chatPublic)!=null&&a.canSend)||!((c=(o=d(this,le).permissions)==null?void 0:o.chatPublic)!=null&&c.files)){g.error("editImageMessage::permission_denied");return}if(!t){g.error("editImageMessage::required_argument_image_can_not_be_empty");return}if(!["image/gif","image/jpeg","image/png"].includes(t.type)){g.error("sendImageMessage::image_type_not_supported",{dyteChat:{imageType:t.type}});return}try{const l=wt(),{getLocation:u,putLocation:h}=await l.getPresignedUrls(t.name,d(this,le).config.viewType);await l.uploadFile(t,h),d(this,Vt).editMessage(e,u,fr.IMAGE,s)}catch(l){throw new w("Error editing image message.")}}async editFileMessage(e,t,s){var i,n,a,o;if(d(this,$t)!=="socket-service"){g.warn("editFileMessage::Coming soon!");return}if(!((n=(i=d(this,le).permissions)==null?void 0:i.chatPublic)!=null&&n.canSend)||!((o=(a=d(this,le).permissions)==null?void 0:a.chatPublic)!=null&&o.files)){g.error("sendFileMessage::permission_denied");return}if(!t){g.error("sendFileMessage::required_argument_file_can_not_be_empty");return}try{const c=wt(),{getLocation:l,putLocation:u}=await c.getPresignedUrls(t.name,d(this,le).config.viewType);await c.uploadFile(t,u),d(this,Vt).editMessage(e,JSON.stringify({link:l,name:t.name,size:"size"in t?t.size:0}),fr.FILE,s)}catch(c){throw new w("Error editing file message.")}}async editMessage(e,t,s){if(d(this,$t)!=="socket-service"){g.warn("editMessage::Coming soon!");return}switch(t.type){case"text":{this.editTextMessage(e,t.message,s);break}case"image":{this.editImageMessage(e,t.image,s);break}case"file":{this.editFileMessage(e,t.file,s);break}default:{g.error("editMessage::message_type_not_supported",{dyteChat:{messageType:t.type}});break}}}async deleteMessage(e,t){if(d(this,$t)!=="socket-service"){g.warn("editMessage::Coming soon!");return}d(this,Vt).deleteMessage(e,t)}getMessagesByUser(e){return this.messages.filter(t=>t.userId===e)}getMessagesByType(e){return this.messages.filter(t=>t.type===e)}async pin(e){if(d(this,$t)!=="socket-service"){if(!this.roomJoined)throw new w("Can`t pin message without joining room");await d(this,$s,zn).pinChatMessage({id:e})}}async unpin(e){if(d(this,$t)!=="socket-service"){if(!this.roomJoined)throw new w("Can`t unpin message without joining room");await d(this,$s,zn).unpinChatMessage({id:e})}}async getMessages(e,t,s,i=0,n=void 0){const a=await d(this,Vt).getChatMessagesPaginated(e,t,s,i,n);return{messages:a.messages.map(o=>Gr.formatSocketServiceMessage(o)),next:a.next}}async createChannel(e,t,s={}){if(!e||e.trim().length===0)throw new w("channel name cannot be empty.","0510");t.push(d(this,le).userId);const i=[...new Set(t)];return await d(this,Vn).createChannel(e.trim(),i,s.displayPictureUrl,s.visibility,s.isDirectMessage)}updateChannel(e,t){var n,a,o,c;const s=this.channels.find(l=>l.id===e),i={memberIds:(n=t.memberIds)!=null?n:s.memberIds,displayName:(a=t.displayName)!=null?a:s.displayName,displayPictureUrl:(o=t.displayPictureUrl)!=null?o:s.displayPictureUrl,visibility:(c=t.visibility)!=null?c:s.visibility};return d(this,Vn).updateChannel(e,i)}async sendMessageToChannel(e,t,s={}){return this.sendMessageInternal(e,null,t,s)}async getChannelMembers(e){return d(this,Vn).getChannelMembers(e)}async searchMessages(e,t={}){return(await d(this,Vt).searchMessages(e,t)).map(Gr.formatSocketServiceMessage)}async markLastReadMessage(e,t){await d(this,Vt).markLastReadMessage(e,t);const s=this.channels.find(i=>i.id===e);if(s){const i={...s,unreadCount:0};this.channels=this.channels.map(n=>n.id===e?i:n),this.emit("channelMessageUpdate",i)}}get pinned(){return this.messages.filter(e=>e.pinned)}},le=new WeakMap,Fn=new WeakMap,Vt=new WeakMap,Vn=new WeakMap,$t=new WeakMap,$s=new WeakSet,zn=function(){return st()},_E);Gt([_.trace("DyteChat.sendTextMessage")],kt.prototype,"sendTextMessage",1),Gt([_.trace("DyteChat.sendImageMessage")],kt.prototype,"sendImageMessage",1),Gt([_.trace("DyteChat.sendFileMessage")],kt.prototype,"sendFileMessage",1),Gt([_.trace("DyteChat.sendMessage")],kt.prototype,"sendMessage",1),Gt([_.trace("DyteChat.editTextMessage")],kt.prototype,"editTextMessage",1),Gt([_.trace("DyteChat.editImageMessage")],kt.prototype,"editImageMessage",1),Gt([_.trace("DyteChat.editFileMessage")],kt.prototype,"editFileMessage",1),Gt([_.trace("DyteChat.editMessage")],kt.prototype,"editMessage",1),Gt([_.trace("DyteChat.deleteMessage")],kt.prototype,"deleteMessage",1),Gt([_.trace("DyteChat.createChannel")],kt.prototype,"createChannel",1),Gt([_.trace("DyteChat.updateChannel")],kt.prototype,"updateChannel",1),Gt([_.trace("DyteChat.sendMessageToChannel")],kt.prototype,"sendMessageToChannel",1),Gt([_.trace("DyteChat.getChannelMembers")],kt.prototype,"getChannelMembers",1),Gt([_.trace("DyteChat.searchMessages")],kt.prototype,"searchMessages",1),Gt([_.trace("DyteChat.markLastReadMessage")],kt.prototype,"markLastReadMessage",1),kt=Gt([Bt(r=>{throw new w(r.message,"0500")})],kt);var iF=Object.defineProperty,nF=Object.getOwnPropertyDescriptor,aF=(r,e,t,s)=>{for(var i=s>1?void 0:s?nF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&iF(e,t,i),i};const jr=(vE=class{constructor(r,e,t,s,i){S(this,Ic);f(this,"chat");f(this,"chatSocketHandler");f(this,"chatChannelSocketHandler");f(this,"self");S(this,za,void 0);this.chatSocketHandler=r,this.chatChannelSocketHandler=e,R(this,za,t),this.chat=new kt(r,e,t,s,i),this.self=s,this.setupEvents()}get roomJoined(){var r;return((r=d(this,Ic,_f))==null?void 0:r.roomJoined)===!0}static async init(r,e,t,s,i){const n=Yh(t.config.viewType,i)?"socket-service":"room-node";return g.info(`Using socket server :: ${n} for chat`),new jr(r,e,n,t,s)}static formatMessage(r){return{...r,time:new Date(r.time),type:Ca[r.type]}}static formatSocketServiceMessage(r){const e=r.createdAt*1e3,t={displayName:r.displayName,id:r.chatId,time:e,timeMs:r.createdAtMs,type:r.payloadType,isEdited:r.isEdited,userId:r.userId,targetUserIds:r.targetUserIds,channelId:r.channelId,channelIndex:r.channelIndex,message:"",link:"",name:"",size:0};switch(t.type){case fr.TEXT:{t.message=r.payload;break}case fr.IMAGE:{t.link=r.payload;break}case fr.FILE:{const{link:s,name:i,size:n}=JSON.parse(r.payload);t.link=s,t.name=i,t.size=n;break}}return jr.formatMessage(t)}async getChatMessages(){if(this.self.config.viewType==="LIVESTREAM"||this.self.config.viewType==="CHAT"||x.hasFeature(U.FEAT_PAGINATED_CHAT))return;if(d(this,za)==="socket-service"){const e=await this.chatSocketHandler.getChatMessages();if(!(e!=null&&e.payload))return;const t=vv.fromBinary(e.payload).messages;this.chat.messages=t.map(s=>jr.formatSocketServiceMessage(s));return}if(!this.roomJoined){g.error("ChatController.getChatMessages.RoomNodeClientSocketUsed_WithoutRoomJoin");return}const{messages:r}=(await d(this,Ic,_f).getChatMessages()).payload;this.chat.messages=r.filter(e=>Ca[e.type]!=="poll").map(jr.formatMessage)}async getAllChannels(){this.self.config.viewType==="CHAT"&&(this.chat.channels=await this.chatSocketHandler.getAllChannels())}setupEvents(){d(this,za)==="socket-service"?E.onAsync(T.SOCKET_SERVICE_ROOM_JOINED,async()=>{this.getChatMessages(),await this.getAllChannels()}):E.onAsync(T.ROOM_JOINED,async()=>{await this.getChatMessages()}),this.chatSocketHandler.on(ft.sendMessageToRoom,r=>{const e=jr.formatSocketServiceMessage(r.message);if(!e.channelId)this.chat.messages=[...this.chat.messages,e];else{const t=this.chat.channels.find(s=>s.id===e.channelId);t&&(t.latestMessage=e,t.unreadCount+=1,this.chat.emit("channelMessageUpdate",t))}this.chat.emit("chatUpdate",{action:"add",message:e,messages:this.chat.messages})}),this.chatSocketHandler.on(ft.sendMessageToPeers,r=>{const e=jr.formatSocketServiceMessage(r.message);this.chat.messages=[...this.chat.messages,e],this.chat.emit("chatUpdate",{action:"add",message:e,messages:this.chat.messages})}),this.chatSocketHandler.on(ft.editMessage,r=>{const e=jr.formatSocketServiceMessage(r.message);if(e.channelId){this.chat.emit("chatUpdate",{action:"edit",message:e,messages:this.chat.messages});return}const t=this.chat.messages.findIndex(s=>s.id===e.id);t!==-1&&(this.chat.messages[t]=e,this.chat.emit("chatUpdate",{action:"edit",message:e,messages:this.chat.messages}))}),this.chatSocketHandler.on(ft.deleteMessage,r=>{if(r.channelId){this.chat.emit("chatUpdate",{action:"delete",message:{id:r.chatId,channelId:r.channelId},messages:this.chat.messages});return}const e=this.chat.messages.findIndex(s=>s.id===r.chatId);if(e===-1)return;const[t]=this.chat.messages.splice(e,1);this.chat.emit("chatUpdate",{action:"delete",message:t,messages:this.chat.messages})}),this.chatChannelSocketHandler.on(dn.createChatChannel,r=>{const[e]=r.chatChannels,t=Tn.formatChannel(e);this.chat.channels.push(t),this.chat.emit("channelCreate",t)}),this.chatChannelSocketHandler.on(dn.updateChatChannel,r=>{const[e]=r.chatChannels,t=Tn.formatChannel(e);this.chat.channels=this.chat.channels.map(s=>s.id===t.id?t:s),this.chat.emit("channelUpdate",t)}),E.on(T.NEW_CHAT_MESSAGE,r=>{if(Ca[r==null?void 0:r.type]==="poll")return;const e=jr.formatMessage(r);this.chat.messages=[...this.chat.messages,e],this.chat.emit("chatUpdate",{action:"add",message:e,messages:this.chat.messages})}),E.on(T.PIN_CHAT_MESSAGE,async r=>{const e=jr.formatMessage(r),t=this.chat.messages.findIndex(s=>s.id===e.id);this.chat.messages[t]=e,this.chat.emit("pinMessage",{message:e,messages:this.chat.messages})}),E.on(T.UNPIN_CHAT_MESSAGE,async r=>{const e=jr.formatMessage(r),t=this.chat.messages.findIndex(s=>s.id===e.id);this.chat.messages[t]=e,this.chat.emit("unpinMessage",{message:e,messages:this.chat.messages})})}},Ic=new WeakSet,_f=function(){return st()},za=new WeakMap,vE);let Gr=jr;aF([_.trace("ChatController.setupEvents")],Gr.prototype,"setupEvents",1);var oF=Object.defineProperty,cF=Object.getOwnPropertyDescriptor,Rl=(r,e,t,s)=>{for(var i=s>1?void 0:s?cF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&oF(e,t,i),i};const PT=(TE=class{constructor(r,e,t,s){S(this,kc);f(this,"plugins");S(this,kr,void 0);S(this,Ya,void 0);S(this,Xa,void 0);R(this,kr,r),R(this,Xa,e),R(this,Ya,t),this.plugins=s,this.setupEvents()}get roomJoined(){var r;return((r=d(this,kc,vf))==null?void 0:r.roomJoined)===!0}static async init(r,e,t,s,i,n,a){const o=Xh(i.config.viewType,a)?"socket-service":"room-node";g.info(`Using socket server ${o} for plugin`);const c=new Vp;return r.forEach(l=>{const u=new Xo(l,e,o,i,n,s);c.all.add(u)}),i.config.isV2===!1&&i.config.setDisabledPlugins(c.all.toArray().map(l=>l.id)),new PT(e,t,o,c)}async getRoomPlugins(){if(d(this,Ya)==="socket-service"){const{plugins:e}=await d(this,kr).getActivePlugins();await Promise.all(e.map(t=>this.enablePlugin({id:t.pluginId,enabledBy:t.enabledBy})));return}if(!this.roomJoined){g.error("PluginController.getRoomPlugins.RoomNodeClientSocketUsed_WithoutRoomJoin");return}const{payload:r}=await d(this,kc,vf).getRoomState();await Promise.all(r.roomState.plugins.map(e=>this.enablePlugin(e)))}async enablePlugin({id:r,enabledBy:e}){const t=this.plugins.all.get(r);t&&(await t.activateForSelf(),t.enabledBy=e)}async disablePlugin({id:r}){const e=this.plugins.all.get(r);e&&e.deactivateForSelf()}sendIframeEventOld(r,e){const{id:t}=e,s=this.plugins.all.get(t);s&&s.sendIframeEvent({type:r,payload:e})}sendIframeEvent(r,e,t,s){const i=this.plugins.all.get(e);e&&i.sendIframeEvent({type:r,uuid:t,payload:s})}broadcastIframeEventOld(r,e){this.plugins.active.forEach(t=>{this.sendIframeEventOld(r,{...e,id:t.id})})}broadcastIframeEvent(r,e){this.plugins.active.forEach(t=>{this.sendIframeEvent(r,t.id,"",e)})}setupEvents(){if(this.plugins.all.on("stateUpdate",({active:r,id:e})=>{if(r){this.plugins.active.add(this.plugins.all.get(e));return}this.plugins.active.delete(e)}),E.onAsync(T.ROOM_JOINED,async()=>{await this.getRoomPlugins(),g.debug("[ROOM_JOINED] resolved request to fetch plugins.")}),d(this,Ya)==="socket-service"){d(this,kr).on(q.addPlugin,async r=>{var t;const e=r.pluginId;(t=this.plugins.all.get(e))!=null&&t.active||await this.enablePlugin({id:e,enabledBy:r.enabledBy})}),d(this,kr).on(q.removePlugin,async r=>{var t;const e=r.pluginId;(t=this.plugins.all.get(e))!=null&&t.active&&await this.disablePlugin({id:e})}),[q.enablePluginForPeers,q.enablePluginForRoom].forEach(r=>{d(this,kr).on(r,async(e,t)=>{this.sendIframeEvent(r,e.pluginId,t,{enabledBy:e.enabledBy})})}),[q.disablePluginForPeers,q.disablePluginForRoom].forEach(r=>{d(this,kr).on(r,async(e,t)=>{this.sendIframeEvent(r,e.pluginId,t,{disabledBy:e.disabledBy})})}),[q.customPluginEventToPeers,q.customPluginEventToRoom].forEach(r=>{d(this,kr).on(r,async(e,t)=>{this.sendIframeEvent(r,e.pluginId,t,{data:JSON.parse(new TextDecoder().decode(e.pluginData))})})}),[q.storeInsertKeys,q.storeGetKeys,q.storeDeleteKeys].forEach(r=>{d(this,kr).on(r,async(e,t)=>{var i;const s=(i=e.storeItems)==null?void 0:i.map(n=>{var a;return{timestamp:n.timestamp,peerId:n.peerId,payload:JSON.parse((a=n.payload)!=null&&a.length?new TextDecoder().decode(n.payload):"{}"),key:n.storeKey}});this.sendIframeEvent(r,e.pluginId,t,{storeName:e.storeName,storeItems:s})})}),d(this,kr).on(q.storeDelete,async(r,e)=>{this.sendIframeEvent(q.storeDelete,r.pluginId,e,{storeName:r.storeName})}),d(this,Xa).on(ft.sendMessageToPeers,r=>{const e=Gr==null?void 0:Gr.formatSocketServiceMessage(r.message);this.broadcastIframeEvent(vt.chatMessage,{message:e})}),d(this,Xa).on(ft.sendMessageToRoom,r=>{const e=Gr==null?void 0:Gr.formatSocketServiceMessage(r.message);this.broadcastIframeEvent(vt.chatMessage,{message:e})}),E.on(T.PEER_JOINED,r=>{this.broadcastIframeEvent(vt.peerJoined,r)}),E.on(T.PEER_CLOSED,r=>{this.broadcastIframeEvent(vt.peerLeft,r)});return}E.on(T.ENABLE_PLUGIN,async({id:r,enabledBy:e})=>{await this.enablePlugin({id:r,enabledBy:e})}),E.on(T.DISABLE_PLUGIN,async({id:r})=>{await this.disablePlugin({id:r})}),[T.PLUGIN_DATA,T.PLUGIN_EVENT].forEach(r=>{E.on(r,e=>{this.sendIframeEventOld(r,e)})}),[T.PEER_JOINED,T.PEER_CLOSED,T.NEW_CHAT_MESSAGE].forEach(r=>{E.on(r,e=>{this.broadcastIframeEventOld(r,e)})})}},kr=new WeakMap,Ya=new WeakMap,Xa=new WeakMap,kc=new WeakSet,vf=function(){return st()},TE);let Qo=PT;Rl([_.trace("PluginController.getRoomPlugins")],Qo.prototype,"getRoomPlugins",1),Rl([_.trace("PluginController.enableForSelf")],Qo.prototype,"enablePlugin",1),Rl([_.trace("PluginController.disableForSelf")],Qo.prototype,"disablePlugin",1),Rl([_.trace("PluginController.setupEvents")],Qo.prototype,"setupEvents",1);function dF(){he.isElectron()&&window.dyteElectronGetDisplayMediaSource&&(navigator.mediaDevices.getDisplayMedia=async()=>{const r=await window.dyteElectronGetDisplayMediaSource({types:["window","screen"]});let e=[];if(r&&(Array.isArray(r)?e=r:e=[r]),!(e!=null&&e.length))throw new Error("Couldn't find any media source for screen share.");let t=e.find(n=>{var a;return(a=n.id)==null?void 0:a.includes("screen")});t=t!=null?t:e[0];const s={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t.id}}};return await navigator.mediaDevices.getUserMedia(s)})}var lF=Object.defineProperty,uF=Object.getOwnPropertyDescriptor,hF=(r,e,t,s)=>{for(var i=s>1?void 0:s?uF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&lF(e,t,i),i};let jp=(EE=class extends Ke{constructor(e,t,s){super();S(this,Qa);f(this,"items");S(this,Hs,void 0);S(this,Za,void 0);S(this,eo,void 0);R(this,Hs,e),R(this,Za,t),R(this,eo,s),this.items=[]}get roomJoined(){var e;return((e=d(this,Qa,pu))==null?void 0:e.roomJoined)===!0}async create(e,t,s=!1,i=!1){if(d(this,Hs).config.viewType!=="LIVESTREAM"&&!this.roomJoined)throw new w("Can't create polls without joining room");if(!d(this,Hs).permissions.polls.canCreate){g.error("DytePolls::create::permission_denied");return}if(!e||!t){g.error("DytePolls::question_and_options_can_not_be_empty",{dytePolls:{hasQuestion:!!e,optionsLength:t==null?void 0:t.length}});return}if(t.length<2){g.error("DytePolls::there_must_be_at_least_two_options",{dytePolls:{hasQuestion:!!e,optionsLength:t.length}});return}if(d(this,eo)==="socket-service"){await d(this,Za).createPoll(e,t,s,i);return}const n={question:e,options:t,anonymous:s,hideVotes:i,createdBy:d(this,Hs).name,createdByUserId:d(this,Hs).userId};await d(this,Qa,pu).newPoll(n)}async vote(e,t){if(!d(this,Hs).permissions.polls.canVote){g.error("DytePolls::vote::permission_denied");return}if(d(this,eo)==="socket-service"){await d(this,Za).votePoll(e,t);return}const s={pollId:e,index:t};await d(this,Qa,pu).votePoll(s)}},Qa=new WeakSet,pu=function(){return st()},Hs=new WeakMap,Za=new WeakMap,eo=new WeakMap,EE);jp=hF([Bt(r=>{throw new w(r.message,"0700")})],jp);var pF=Object.defineProperty,fF=Object.getOwnPropertyDescriptor,mF=(r,e,t,s)=>{for(var i=s>1?void 0:s?fF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&pF(e,t,i),i};const Pa=(yE=class{constructor(r,e,t){S(this,Dc);f(this,"polls");S(this,Oc,void 0);S(this,Oi,void 0);S(this,to,void 0);this.polls=new jp(r,e,t),R(this,Oc,r),R(this,Oi,e),R(this,to,t),this.setupEvents()}static async init(r,e,t){const s=Q_(r.config.viewType,t)?"socket-service":"room-node";return g.info(`Using socket server ${s} for polls`),new Pa(r,e,s)}canViewPolls(){return d(this,Oc).permissions.polls.canView}setupEvents(){if(d(this,to)==="socket-service"){if(!this.canViewPolls())return;E.on(T.SOCKET_SERVICE_ROOM_JOINED,()=>{this.getPolls()}),d(this,Oi).on(bs.createPoll,r=>{r.poll&&this.updatePoll(Pa.formatSocketServicePoll(r.poll))}),d(this,Oi).on(bs.updatePoll,r=>{r.poll&&this.updatePoll(Pa.formatSocketServicePoll(r.poll))}),d(this,Oi).on(bs.votePoll,r=>{r.poll&&this.updatePoll(Pa.formatSocketServicePoll(r.poll))})}else E.onAsync(T.ROOM_JOINED,async()=>{this.canViewPolls()&&this.getPolls()});E.on(T.UPDATE_POLL,async({poll:r})=>{this.updatePoll(r)})}updatePoll(r){if(!this.canViewPolls())return;const e=this.polls.items.findIndex(t=>t.id===r.id);if(e>-1){const t=JSON.stringify(this.polls.items[e]);this.polls.items[e]=r,t!==JSON.stringify(r)&&this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!1});return}this.polls.items=[...this.polls.items,r],this.polls.emit("pollsUpdate",{polls:this.polls.items,newPoll:!0})}async getPolls(){if(d(this,to)==="socket-service"){const r=await d(this,Oi).getPolls();if(!(r!=null&&r.payload))return;const{polls:e}=q1.fromBinary(r.payload);this.polls.items=e.map(t=>Pa.formatSocketServicePoll(t));return}if(d(this,Dc,Tf)instanceof Ee){const{polls:r}=(await d(this,Dc,Tf).getPolls()).payload;this.polls.items=Object.values(r)}}static formatSocketServicePoll(r){const e=r.options.map(t=>({count:t.count,text:t.text,votes:t.votes.map(s=>({id:s.userId,name:s.name}))}));return{anonymous:r.anonymous,createdBy:r.createdBy,createdByUserId:r.createdByUserId,hideVotes:r.hideVotes,id:r.pollId,options:e,question:r.question,voted:r.votes}}},Oc=new WeakMap,Oi=new WeakMap,to=new WeakMap,Dc=new WeakSet,Tf=function(){return st()},yE);let AT=Pa;mF([_.trace("PollController.setupEvents")],AT.prototype,"setupEvents",1);class IT extends Up{constructor(){super({onAddEvent:"remoteRequestAdd",onDeleteEvent:"remoteRequestRemove"})}add(e,t=!0){return super.add(e,t)}delete(e,t=!0,s=!1){return super.delete(e,t,s)}}const tu=class extends Ke{constructor(t,s){super();S(this,Di);f(this,"incomingRequests");f(this,"outgoingRequests");f(this,"active");S(this,$n,void 0);S(this,Mc,void 0);R(this,Mc,s),R(this,$n,t),this.incomingRequests=new IT,this.outgoingRequests=new IT,this.active=null,this.mouseEvent=this.mouseEvent.bind(this),this.keyboardEvent=this.keyboardEvent.bind(this)}async requestControl(t){var o;if(!d(this,Mc).joined.get(t))throw new w("Invalid peer.");const i=(o=this.outgoingRequests)==null?void 0:o.toArray().find(c=>c.hostPeerId===t);if(i)return i.id;const n=Yc(),a=new Jo({requestId:n,hostPeerId:t,remotePeerId:d(this,$n).id,state:wa.PENDING});return this.outgoingRequests.add(a),await d(this,Di,po).requestRemoteControl(a),this.emit("remoteUpdate",{payload:{request:{id:a.id,hostPeerId:a.hostPeerId,remotePeerId:a.remotePeerId}},type:Ps.REQUEST_SENT}),n}async acceptControl(t){var i;if(((i=this.active)==null?void 0:i.id)===t)return;const s=this.incomingRequests.get(t);if(!s)throw new w("No request found.");s.state=wa.ACCEPTED,this.endControl(),this.active=s,d(this,Di,po).acceptRemoteControl(s),this.emit("remoteUpdate",{payload:{request:{id:this.active.id,hostPeerId:this.active.hostPeerId,remotePeerId:this.active.remotePeerId}},type:Ps.INCOMING_REQUEST_ACCEPTED})}async endControl(){if(!this.active)return;const t={...this.active};d(this,Di,po).terminateRemoteControl(this.active.hostPeerId===d(this,$n).id?this.active.remotePeerId:this.active.hostPeerId,this.active),this.active=null,this.emit("remoteUpdate",{payload:{request:{id:t.id,hostPeerId:t.hostPeerId,remotePeerId:t.remotePeerId}},type:t.hostPeerId===d(this,$n).id?Ps.INCOMING_REQUEST_ENDED:Ps.OUTGOING_REQUEST_ENDED})}async keyboardEvent(t){if(!this.active)return;const s=tu.getFormattedKeyboardEvent(t);if(s){const i={eventType:Wo.KEYBOARD,keyboardEvent:s};d(this,Di,po).sendEventRemoteControl(this.active.hostPeerId,this.active.id,i)}}async mouseEvent(t,s){if(!this.active)return;const i=tu.getFormattedRemoteMouseEvent(t,s);if(i){const n={eventType:Wo.MOUSE,mouseEvent:i};d(this,Di,po).sendEventRemoteControl(this.active.hostPeerId,this.active.id,n)}}static getFormattedRemoteMouseEvent(t,s){const i=s.getBoundingClientRect();return{type:t.type,position:{x:Math.floor(t.x-i.left),y:Math.floor(t.y-i.top)},boundingRect:{width:i.width,height:i.height}}}static getFormattedKeyboardEvent(t){return t.type==="keydown"?{type:t.type,key:t.key}:null}};let Gp=tu;Di=new WeakSet,po=function(){return st()},$n=new WeakMap,Mc=new WeakMap;const su=class{constructor(e,t){f(this,"remote");f(this,"hostPeetId");f(this,"remotePeetId");f(this,"remoteRequestTokens");f(this,"activeRemoteToken");S(this,Nc,void 0);S(this,ru,void 0);R(this,Nc,e),R(this,ru,t),this.hostPeetId=e.id,this.remote=new Gp(e,t),this.setupEvents()}setupEvents(){E.on(T.MESSAGE,e=>{var t;if(e.remoteRequestType===Cs.REQUEST&&(this.remote.incomingRequests.add(new Jo({requestId:e.remoteRequestId,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId,state:wa.PENDING})),this.remote.emit("remoteUpdate",{payload:{request:{id:e.remoteRequestId,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId}},type:Ps.REQUEST_RECEIVED})),e.remoteRequestType===Cs.ACCEPT){const s=this.remote.outgoingRequests.get(e.remoteRequestId);if(!s)throw new w("There is no pending remote control request to accept.");this.remote.endControl(),s.state=wa.ACCEPTED,this.remote.active=new Jo({requestId:e.remoteRequestId,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId,state:wa.ACCEPTED}),this.remote.emit("remoteUpdate",{payload:{request:{id:e.remoteRequestId,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId}},type:Ps.OUTGOING_REQUEST_ACCEPTED})}e.remoteRequestType===Cs.END&&(((t=this.remote.active)==null?void 0:t.id)===e.remoteRequestId&&(this.remote.active=null),this.remote.emit("remoteUpdate",{payload:{request:{id:e.remoteRequestId,hostPeerId:e.hostPeerId,remotePeerId:e.remotePeerId}},type:e.hostPeerId===d(this,Nc).id?Ps.INCOMING_REQUEST_ENDED:Ps.OUTGOING_REQUEST_ENDED})),e.remoteRequestType===Cs.EVENT&&this.remote.active&&this.remote.active.id===e.remoteRequestId&&window.DyteRobot&&(e.remoteEvent.eventType===Wo.MOUSE?su.executeMouseEvent(e.remoteEvent.mouseEvent):e.remoteEvent.eventType===Wo.KEYBOARD&&su.executeKeyboardEvent(e.remoteEvent.keyboardEvent))}),E.on(T.PEER_CLOSED,({id:e})=>{var t,s,i,n,a,o,c,l;[(s=(t=this.remote)==null?void 0:t.active)==null?void 0:s.hostPeerId,(n=(i=this.remote)==null?void 0:i.active)==null?void 0:n.remotePeerId].includes(e)&&this.remote.endControl(),(o=(a=this.remote)==null?void 0:a.incomingRequests)==null||o.toArray().forEach(u=>{[u.hostPeerId,u.remotePeerId].includes(e)&&this.remote.incomingRequests.delete(u.id)}),(l=(c=this.remote)==null?void 0:c.outgoingRequests)==null||l.toArray().forEach(u=>{[u.hostPeerId,u.remotePeerId].includes(e)&&this.remote.outgoingRequests.delete(u.id)})})}static executeMouseEvent(e){const t=window.screen.width*e.position.x/e.boundingRect.width,s=window.screen.height*e.position.y/e.boundingRect.height,i={width:window.screen.width,height:window.screen.height};switch(e.type){case gl.LEFT_CLICK:window.DyteRobot.mouse.leftClick(t,s,i);break;case gl.RIGHT_CLICK:window.DyteRobot.mouse.rightClick(t,s,i);break;case gl.MOVE:window.DyteRobot.mouse.moveTo(t,s,i);break}}static executeKeyboardEvent(e){switch(e.type){case"keydown":window.DyteRobot.keyboard.press(e.key);break}}};let qp=su;Nc=new WeakMap,ru=new WeakMap;var gF=Object.defineProperty,_F=(r,e,t)=>e in r?gF(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,vF=(r,e,t)=>(_F(r,typeof e!="symbol"?e+"":e,t),t),Kp=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)},I=(r,e,t)=>(Kp(r,e,"read from private field"),t?t.call(r):e.get(r)),ze=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},Je=(r,e,t,s)=>(Kp(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t),Ye=(r,e,t)=>(Kp(r,e,"access private method"),t),ui,En,yn,Xe,Aa,Ve,nt,hi,Tt,Os,Pr,Ia,Ds,Wp,kT,Zo,bl,Jp,OT,zp,DT,ka,ec,tc,Cl,Pl,Yp,Oa,rc,sc,Al,Xp={exports:{}},Da=typeof Reflect=="object"?Reflect:null,MT=Da&&typeof Da.apply=="function"?Da.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},Il;Da&&typeof Da.ownKeys=="function"?Il=Da.ownKeys:Object.getOwnPropertySymbols?Il=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Il=function(e){return Object.getOwnPropertyNames(e)};function TF(r){console&&console.warn&&console.warn(r)}var NT=Number.isNaN||function(e){return e!==e};function Oe(){Oe.init.call(this)}Xp.exports=Oe,Xp.exports.once=wF,Oe.EventEmitter=Oe,Oe.prototype._events=void 0,Oe.prototype._eventsCount=0,Oe.prototype._maxListeners=void 0;var LT=10;function kl(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(Oe,"defaultMaxListeners",{enumerable:!0,get:function(){return LT},set:function(r){if(typeof r!="number"||r<0||NT(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");LT=r}}),Oe.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Oe.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||NT(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function xT(r){return r._maxListeners===void 0?Oe.defaultMaxListeners:r._maxListeners}Oe.prototype.getMaxListeners=function(){return xT(this)},Oe.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=n[e];if(c===void 0)return!1;if(typeof c=="function")MT(c,this,t);else for(var l=c.length,u=$T(c,l),s=0;s<l;++s)MT(u[s],this,t);return!0};function UT(r,e,t,s){var i,n,a;if(kl(t),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),n=r._events),a=n[e]),a===void 0)a=n[e]=t,++r._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),i=xT(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=a.length,TF(o)}return r}Oe.prototype.addListener=function(e,t){return UT(this,e,t,!1)},Oe.prototype.on=Oe.prototype.addListener,Oe.prototype.prependListener=function(e,t){return UT(this,e,t,!0)};function EF(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function BT(r,e,t){var s={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=EF.bind(s);return i.listener=t,s.wrapFn=i,i}Oe.prototype.once=function(e,t){return kl(t),this.on(e,BT(this,e,t)),this},Oe.prototype.prependOnceListener=function(e,t){return kl(t),this.prependListener(e,BT(this,e,t)),this},Oe.prototype.removeListener=function(e,t){var s,i,n,a,o;if(kl(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,n=a;break}if(n<0)return this;n===0?s.shift():yF(s,n),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this},Oe.prototype.off=Oe.prototype.removeListener,Oe.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var n=Object.keys(s),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function FT(r,e,t){var s=r._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?SF(i):$T(i,i.length)}Oe.prototype.listeners=function(e){return FT(this,e,!0)},Oe.prototype.rawListeners=function(e){return FT(this,e,!1)},Oe.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):VT.call(r,e)},Oe.prototype.listenerCount=VT;function VT(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}Oe.prototype.eventNames=function(){return this._eventsCount>0?Il(this._events):[]};function $T(r,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=r[s];return t}function yF(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function SF(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function wF(r,e){return new Promise(function(t,s){function i(a){r.removeListener(e,n),s(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}HT(r,e,n,{once:!0}),e!=="error"&&RF(r,i,{once:!0})})}function RF(r,e,t){typeof r.on=="function"&&HT(r,"error",e,t)}function HT(r,e,t,s){if(typeof r.on=="function")s.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(n){s.once&&r.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var bF=Xp.exports;class CF extends b{constructor(){super("message.v1.SocketMessage",[{no:1,name:"event",kind:"scalar",T:13},{no:2,name:"id",kind:"scalar",opt:!0,T:9},{no:3,name:"payload",kind:"scalar",opt:!0,T:12},{no:4,name:"metadata",kind:"scalar",opt:!0,T:12}])}}const jT=new CF;class GT{static encode(e){return jT.toBinary(e)}static decode(e){return jT.fromBinary(new Uint8Array(e))}}function PF(r,e){return Math.floor(Math.random()*(e-r+1)+r)}class AF{constructor(e={}){vF(this,"opts"),ze(this,ui,void 0),this.opts={initialTimeout:e.initialTimeout||1e3,maxTimeout:e.maxTimeout||1e4,factor:e.factor||2},Je(this,ui,0)}async wait(){Je(this,ui,I(this,ui)+1);const e=PF(0,Math.min(this.opts.maxTimeout,this.opts.initialTimeout*2**I(this,ui)));await new Promise(t=>{setTimeout(t,e)})}getAttempts(){return I(this,ui)}reset(){Je(this,ui,0)}}ui=new WeakMap;const pi={debug:0,info:1,warn:2,error:3};class IF{constructor(e){ze(this,En,void 0),ze(this,yn,void 0),Je(this,En,console),Je(this,yn,e)}debug(...e){pi[I(this,yn)]>pi.debug||I(this,En).debug("[Sockrates]:",...e)}info(...e){pi[I(this,yn)]>pi.info||I(this,En).info("[Sockrates]:",...e)}warn(...e){pi[I(this,yn)]>pi.warn||I(this,En).warn("[Sockrates]:",...e)}error(...e){pi[I(this,yn)]>pi.error||I(this,En).error("[Sockrates]:",...e)}}En=new WeakMap,yn=new WeakMap;var qT=(r=>(r[r.CONNECTING=0]="CONNECTING",r[r.OPEN=1]="OPEN",r[r.CLOSING=2]="CLOSING",r[r.CLOSED=3]="CLOSED",r))(qT||{});const kF="2",OF="3";class DF{constructor(e,t){ze(this,Wp),ze(this,Zo),ze(this,Jp),ze(this,zp),ze(this,ka),ze(this,tc),ze(this,Pl),ze(this,Oa),ze(this,sc),ze(this,Xe,void 0),ze(this,Aa,void 0),ze(this,Ve,void 0),ze(this,nt,void 0),ze(this,hi,void 0),ze(this,Tt,void 0),ze(this,Os,void 0),ze(this,Pr,void 0),ze(this,Ia,void 0),ze(this,Ds,void 0);var s,i,n,a,o,c,l,u,h,p,m,v,y,C,k,D,V,M,Pe;Je(this,Aa,e),Je(this,hi,[]),Je(this,Tt,new bF),Je(this,Os,!0),Je(this,Pr,!1),Je(this,Ve,t!=null?t:{}),(i=(s=I(this,Ve)).autoReconnect)!=null||(s.autoReconnect=!0),(a=(n=I(this,Ve)).retryConnectionInterval)!=null||(n.retryConnectionInterval=1e3),(c=(o=I(this,Ve)).pingTimeout)!=null||(o.pingTimeout=3e4),(u=(l=I(this,Ve)).connectionTimeout)!=null||(l.connectionTimeout=5e3),(p=(h=I(this,Ve)).debug)!=null||(h.debug=!0),(v=(m=I(this,Ve)).maxReconnectionAttempts)!=null||(m.maxReconnectionAttempts=10),(C=(y=I(this,Ve)).disconnectOnPingTimeout)!=null||(y.disconnectOnPingTimeout=!0),(D=(k=I(this,Ve)).queueOnDisconnect)!=null||(k.queueOnDisconnect=!1),(M=(V=I(this,Ve)).flushOnReconnect)!=null||(V.flushOnReconnect=!1),Je(this,nt,(Pe=I(this,Ve).logger)!=null?Pe:new IF(I(this,Ve).debug?"debug":"info")),Je(this,Ds,new AF)}get readyState(){var e;return(e=I(this,Xe))==null?void 0:e.readyState}get url(){return I(this,Aa)}get config(){return I(this,Ve)}get sendQueue(){return I(this,hi)}flush(){if(!I(this,Ve).queueOnDisconnect)return!1;const e=[];return I(this,hi).forEach(t=>{this.send(t.event,t.id,t.payload,t.metadata)||e.push(t)}),Je(this,hi,e),I(this,hi)}async connect(e=!1){if(!e&&[0,1].includes(this.readyState)){I(this,nt).debug("Websocket was already connecting or connected.");return}if(I(this,Os)!==!1)return new Promise((t,s)=>{Ye(this,Oa,rc).call(this),Ye(this,sc,Al).call(this);try{Je(this,Xe,new WebSocket(Ye(this,Wp,kT).call(this,I(this,Aa)))),I(this,Xe).binaryType="arraybuffer",I(this,nt).debug("Connecting to",I(this,Aa));const i=setTimeout(()=>{I(this,nt).debug("Connection timeout. Closing socket"),Je(this,Os,!0),Ye(this,sc,Al).call(this),I(this,Xe).close(3001,"Connection Timeout"),I(this,Ve).autoReconnect&&!I(this,Pr)&&(I(this,Tt).emit("reconnecting"),Ye(this,ka,ec).call(this)),s(new Error("Connection timed out!"))},I(this,Ve).connectionTimeout);I(this,Xe).onopen=()=>{I(this,nt).debug(`Ready State: ${qT[I(this,Xe).readyState]}`),i&&clearTimeout(i),Ye(this,Pl,Yp).call(this),I(this,Tt).emit("connected"),I(this,Ve).flushOnReconnect&&this.flush(),t()},I(this,Xe).onclose=n=>{try{i&&clearTimeout(i);const{code:a,reason:o}=n;if(s(o),I(this,nt).debug("Socket closed. Close event:",n),I(this,nt).debug("Connection closed code:",a),I(this,nt).debug("Connection closed reason:",o),I(this,Os)&&a!==1e3&&I(this,Ve).autoReconnect&&!I(this,Pr)){I(this,Tt).emit("reconnecting"),Ye(this,ka,ec).call(this);return}I(this,Pr)||I(this,Tt).emit("disconnected",{code:a,reason:o})}catch(a){Ye(this,Zo,bl).call(this,a)}},I(this,Xe).onerror=n=>{Ye(this,Zo,bl).call(this,n)},I(this,Xe).onmessage=n=>Ye(this,Jp,OT).call(this,n)}catch(i){Ye(this,Zo,bl).call(this,i,s)}})}send(e,t,s,i){const n={event:e,id:t,payload:s,metadata:i};if(I(this,Ve).queueOnDisconnect&&(!I(this,Xe)||I(this,Xe).readyState!==1))return I(this,nt).debug("Queuing message since socket is not connected!",n),I(this,hi).push(n),!1;const a=GT.encode(n);return Ye(this,tc,Cl).call(this,a)}emit(e,t,s,i){return this.send(e,t,s,i)}sendRaw(e){return Ye(this,tc,Cl).call(this,e)}receive(e,t){return I(this,Tt).on(e.toString(),t)}on(e,t){if(typeof e=="string"&&(e==="connected"||e==="disconnected"||e==="errored"||e==="reconnected"||e==="reconnecting"||e==="reconnectAttempt"||e==="reconnectFailure"||e==="failed")){I(this,Tt).on(e,t);return}this.receive(e,t)}removeAllListeners(){I(this,Tt).removeAllListeners()}removeReceiver(e,t){this.removeListener(e,t)}removeListener(e,t){I(this,Tt).removeListener(e.toString(),t)}removeReceivers(e){this.removeListeners(e)}removeListeners(e){I(this,Tt).listeners(e.toString()).map(t=>this.removeListener(e,t))}disconnect(){Je(this,Os,!1),Ye(this,Oa,rc).call(this),this.removeAllListeners(),I(this,Xe).close(1e3,"Sockrates disconnect method called.")}}Xe=new WeakMap,Aa=new WeakMap,Ve=new WeakMap,nt=new WeakMap,hi=new WeakMap,Tt=new WeakMap,Os=new WeakMap,Pr=new WeakMap,Ia=new WeakMap,Ds=new WeakMap,Wp=new WeakSet,kT=function(r){if(r.startsWith("ws://")||r.startsWith("wss://"))return r;if(r.startsWith("https://"))return`wss://${r.substring(8)}`;if(r.startsWith("http://"))return`ws://${r.substring(7)}`;throw new Error("Invalid URL. URL must start with http(s):// or ws(s)://.")},Zo=new WeakSet,bl=function(r,e){I(this,nt).error("Error:",r),I(this,Tt).emit("errored",{error:r}),e==null||e(r)},Jp=new WeakSet,OT=function(r){if(r.data===kF){I(this,nt).debug("Received ping from server"),Ye(this,Pl,Yp).call(this),Ye(this,tc,Cl).call(this,OF);return}I(this,nt).debug("Received data:",r.data);const e=GT.decode(r.data),{id:t,payload:s}=e;I(this,Tt).emit(e.event.toString(),{id:t,payload:s})},zp=new WeakSet,DT=function(){return I(this,Xe).readyState===1},ka=new WeakSet,ec=async function(r=!0){if(r&&I(this,Pr)){I(this,nt).debug("Reconnect called when already in a reconnect loop. Ignoring.");return}if(I(this,Pr)||I(this,Ds).reset(),I(this,Ve).maxReconnectionAttempts!==null&&I(this,Ds).getAttempts()>=I(this,Ve).maxReconnectionAttempts){I(this,Tt).emit("failed"),Je(this,Pr,!1);return}Je(this,Pr,!0),Ye(this,sc,Al).call(this),Ye(this,Oa,rc).call(this);try{if(await I(this,Ds).wait(),I(this,Os)===!1)return;if(I(this,nt).debug(`Reconnection attempt ${I(this,Ds).getAttempts()}`),I(this,Tt).emit("reconnectAttempt",{attempt:I(this,Ds).getAttempts()}),await this.connect(),!Ye(this,zp,DT).call(this))throw Error("Reconnect Failed");Je(this,Pr,!1),I(this,Tt).emit("reconnected")}catch(e){I(this,nt).debug("Failed to reconnect."),I(this,Tt).emit("reconnectFailure",{attempt:I(this,Ds).getAttempts()}),Ye(this,ka,ec).call(this,!1)}},tc=new WeakSet,Cl=function(r){try{return I(this,Xe).send(r),!0}catch(e){return I(this,nt).error(e.message),!1}},Pl=new WeakSet,Yp=function(){this.config.disconnectOnPingTimeout&&(I(this,nt).debug("Resetting ping timeout"),Ye(this,Oa,rc).call(this),Je(this,Ia,setTimeout(()=>{var r;I(this,nt).debug("Disconnecting the socket due to ping timeout"),Je(this,Os,!0);const e=3002,t="Ping timeout";(r=I(this,Xe))==null||r.close(e,t),I(this,Tt).emit("disconnected",{code:e,reason:t}),I(this,Ve).autoReconnect&&!I(this,Pr)&&(I(this,nt).debug("Triggering reconnection due to ping timeout"),I(this,Tt).emit("reconnecting"),Ye(this,ka,ec).call(this))},I(this,Ve).pingTimeout)))},Oa=new WeakSet,rc=function(){I(this,Ia)&&(clearTimeout(I(this,Ia)),Je(this,Ia,void 0))},sc=new WeakSet,Al=function(){I(this,Xe)&&(I(this,Xe).onopen=void 0,I(this,Xe).onerror=void 0,I(this,Xe).onmessage=void 0,I(this,Xe).onclose=void 0)};var MF=Object.defineProperty,NF=Object.getOwnPropertyDescriptor,ic=(r,e,t,s)=>{for(var i=s>1?void 0:s?NF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&MF(e,t,i),i};const KT=65535,WT=(SE=class{constructor({peerId:r,roomName:e,authToken:t,url:s,capabilities:i}){S(this,xc);S(this,ro,void 0);S(this,Mt,void 0);S(this,Lc,void 0);f(this,"roomName");f(this,"peerId");f(this,"authToken");f(this,"capabilities");var u;if(!r||!e||!t)throw new w("peerId, roomName, or authToken can not be empty");const{apiBase:n}=_e;let a=WT.getSocketEdgeDomain(n);typeof Bd("socket_server_base")=="string"&&(a=Bd("socket_server_base"));const o=`wss://${a}`;this.roomName=e,this.peerId=r,this.authToken=t,this.capabilities=i;const c=new URL(`${s!=null?s:o}/ws`),l={roomID:e,peerID:r,authToken:t,useMediaV2:i.includes("HIVE"),ping:i.includes("PING"),capabilities:i.map(h=>Zd[h]).join(" ")};Object.entries(l).forEach(([h,p])=>{c.searchParams.append(h,p.toString())}),R(this,ro,c.href),R(this,Lc,r),R(this,Mt,new DF(d(this,ro),{autoReconnect:!0,disconnectOnPingTimeout:(u=i.includes("PING"))!=null?u:!1,queueOnDisconnect:!0,flushOnReconnect:!1,logger:g}))}static getSocketEdgeDomain(r){let e="";return r.includes("api.cluster.dyte")||r.includes("api.dyte")?e="edge":r.includes("api.staging.dyte")?e="staging":r.includes("api.preprod.dyte")?e="preprod":r.includes("api.devel.dyte")&&(e="devel"),`socket-${e}.dyte.io`}get url(){return d(this,ro)}async connect(){const r=()=>{g.info("SocketService::connect::Connected to socket-edge"),E.emit(T.SOCKET_SERVICE_CONNECTED)};this.onStateEvent("connected",r);const e=({reason:o,code:c})=>{g.info("SocketService::connect::Disconnected from socket-edge",{error:{code:c,reason:o}}),E.emit(T.SOCKET_SERVICE_DISCONNECTED),!(c<4e3||c>4002)&&(c===4e3?g.error("SocketService::connect::Bad Request",{error:{code:c,reason:o}}):c===4001?g.error("SocketService::connect::Unauthorized",{error:{code:c,reason:o}}):c===4002?g.error("SocketService::connect::Internal Error",{error:{code:c,reason:o}}):g.error("SocketService::connect::Unknown Error",{error:{code:c,reason:o}}))};this.onStateEvent("disconnected",e);const t=()=>{g.info("SocketService::connect::Reconnecting to socket-edge"),E.emit(T.SOCKET_SERVICE_RECONNECTING)};this.onStateEvent("reconnecting",t);const s=({attempt:o})=>{g.info("SocketService::connect::Attempting reconnect to socket-edge"),E.emit(T.SOCKET_SERVICE_RECONNECTION_ATTEMPT,{attempt:o})};this.onStateEvent("reconnectAttempt",s);const i=({attempt:o})=>{g.info("SocketService::connect::Reconnect attempt failed"),E.emit(T.SOCKET_SERVICE_RECONNECT_FAILURE,{attempt:o})};this.onStateEvent("reconnectFailure",i);const n=()=>{g.info("SocketService::connect::Reconnected to socket-edge"),E.emit(T.SOCKET_SERVICE_RECONNECTED)};this.onStateEvent("reconnected",n);const a=()=>{g.info("SocketService::connect::Socket-edge reconnects failed"),E.emit(T.SOCKET_SERVICE_FAILED)};this.onStateEvent("failed",a),await d(this,Mt).connect()}disconnect(){return d(this,Mt).disconnect()}get isConnected(){try{return d(this,Mt).readyState===1}catch(r){return!1}}sendMessage(r,e,t){const s={};return _.injectContext(s),d(this,Mt).send(r,t!=null?t:be(this,xc,Ef).call(this),e,new TextEncoder().encode(JSON.stringify(s)))}sendMessagePromise(r,e,t){const s=parseInt({}.SOCKET_SERVICE_MESSAGE_REQUEST_TIMEOUT,10)||2e4;return this.sendMessagePromiseWithTimeout({event:r,timeout:s,protobuf:e,messageId:t})}sendMessagePromiseWithTimeout({event:r,timeout:e,protobuf:t,messageId:s}){return new Promise((i,n)=>{const a=(h,p)=>{d(this,Mt).removeListener(r,h),d(this,Mt).removeListener(KT,p),d(this,Mt).removeListener(ve.errorResponse,p)},o=s!=null?s:be(this,xc,Ef).call(this),c={};_.injectContext(c);const l=({id:h,payload:p})=>{if(o===h){let m;try{const v=OM.fromBinary(p);m=new Error(v.errorMessage)}catch(v){m=new Error("failed to parse error message",{cause:v})}try{const v=NN.fromBinary(p);m=new Error(v.message)}catch(v){m=new Error("failed to parse error message",{cause:v})}n(m),a(u,l)}},u=({id:h,payload:p})=>{o===h&&(i({id:h,payload:p}),a(u,l))};d(this,Mt).on(r,u),d(this,Mt).on(KT,l),d(this,Mt).on(ve.errorResponse,l),setTimeout(()=>{a(u,l),n(new Error("request timeout for callback"))},e),d(this,Mt).send(r,o,t,new TextEncoder().encode(JSON.stringify(c)))})}on(r,e){d(this,Mt).on(r,e)}onStateEvent(r,e){d(this,Mt).on(r,e)}flush(){return d(this,Mt).flush()}},ro=new WeakMap,Mt=new WeakMap,Lc=new WeakMap,xc=new WeakSet,Ef=function(){return`${d(this,Lc)}-${(Math.random()+1).toString(36).substring(7)}`},SE);let Ma=WT;ic([_.trace("SocketService.connect")],Ma.prototype,"connect",1),ic([_.trace("SocketService.disconnect")],Ma.prototype,"disconnect",1),ic([_.trace("SocketService.sendMessage")],Ma.prototype,"sendMessage",1),ic([_.trace("SocketService.sendMessagePromise")],Ma.prototype,"sendMessagePromise",1),ic([_.trace("SocketService.sendMessagePromiseWithTimeout")],Ma.prototype,"sendMessagePromiseWithTimeout",1);class LF{constructor(e){S(this,bt,void 0);R(this,bt,e)}addPlugin(e,t){d(this,bt).sendMessage(q.addPlugin,WL.toBinary({pluginId:e,staggered:t}))}removePlugin(e){d(this,bt).sendMessage(q.removePlugin,zL.toBinary({pluginId:e,staggered:!1}))}async getActivePlugins(){const{payload:e}=await d(this,bt).sendMessagePromise(q.getPlugins);return e?v1.fromBinary(e):{plugins:[]}}customPluginEventToRoom(e,t,s){const i={pluginId:e,pluginData:new TextEncoder().encode(JSON.stringify(t))};d(this,bt).sendMessage(q.customPluginEventToRoom,n1.toBinary(i),s)}customPluginEventToPeers(e,t,s,i){const n={pluginId:e,peerIds:t,pluginData:new TextEncoder().encode(JSON.stringify(s))};d(this,bt).sendMessage(q.customPluginEventToPeers,o1.toBinary(n),i)}enablePluginForRoom(e,t){d(this,bt).sendMessage(q.enablePluginForRoom,XL.toBinary({pluginId:e}),t)}enablePluginForPeers(e,t,s){d(this,bt).sendMessage(q.enablePluginForPeers,t1.toBinary({pluginId:e,peerIds:t}),s)}disablePluginForRoom(e,t){d(this,bt).sendMessage(q.disablePluginForRoom,ZL.toBinary({pluginId:e}),t)}disablePluginForPeers(e,t,s){d(this,bt).sendMessage(q.disablePluginForPeers,s1.toBinary({pluginId:e,peerIds:t}),s)}storeInsertKeys(e,t,s,i){const n={pluginId:e,storeName:t,insertKeys:s.map(a=>({storeKey:a.key,payload:new TextEncoder().encode(JSON.stringify(a.payload))}))};d(this,bt).sendMessage(q.storeInsertKeys,Cv.toBinary(n),i)}storeGetKeys(e,t,s,i){const n={pluginId:e,storeName:t,getKeys:s.map(a=>({storeKey:a.key}))};d(this,bt).sendMessage(q.storeGetKeys,u1.toBinary(n),i)}storeDeleteKeys(e,t,s,i){const n={pluginId:e,storeName:t,deleteKeys:s.map(a=>({storeKey:a.key}))};d(this,bt).sendMessage(q.storeDeleteKeys,p1.toBinary(n),i)}storeDelete(e,t,s){d(this,bt).sendMessage(q.storeDelete,m1.toBinary({pluginId:e,storeName:t}),s)}getPluginDataOld(e,t){g.info("getPluginDataOld",{plugin:{id:e,storeName:t}})}storePluginDataOld(e,t,s){const i={pluginId:e,storeName:t,insertKeys:[{storeKey:s.key,payload:new TextEncoder().encode(JSON.stringify(s))}]};d(this,bt).sendMessage(q.storeInsertKeys,Cv.toBinary(i))}on(e,t){let s;switch(e){case q.addPlugin:case q.enablePluginForPeers:case q.enablePluginForRoom:{s=lp.fromBinary.bind(lp);break}case q.removePlugin:case q.disablePluginForPeers:case q.disablePluginForRoom:{s=Pv.fromBinary.bind(Pv);break}case q.customPluginEventToPeers:case q.customPluginEventToRoom:{s=Iv.fromBinary.bind(Iv);break}case q.storeInsertKeys:case q.storeGetKeys:case q.storeDeleteKeys:case q.storeDelete:{s=Av.fromBinary.bind(Av);break}}d(this,bt).on(e,({payload:i,id:n})=>{const a=s(i);return t(a,n)})}}bt=new WeakMap;var xF=Object.defineProperty,UF=Object.getOwnPropertyDescriptor,Ol=(r,e,t,s)=>{for(var i=s>1?void 0:s?UF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&xF(e,t,i),i};let Na=(wE=class extends Ke{constructor(e){super();S(this,Hn,void 0);f(this,"recordingState","IDLE");f(this,"recordingId");f(this,"recordingPeerId");R(this,Hn,e)}setRecordingState(e){const t=this.recordingState;this.recordingState=e,t!==e&&this.emitCurrentRecordingState()}emitCurrentRecordingState(){this.emit("recordingUpdate",this.recordingState)}async start(){if(!d(this,Hn).permissions.canRecord)throw g.error("DyteRecording::start::permission_denied"),new w("User does not have permission to start recording");if(this.recordingState==="STARTING"||this.recordingState==="RECORDING"||this.recordingState==="STOPPING")throw g.error("DyteRecording::start::recording_in_progress",{recording:{state:this.recordingState}}),new w(`Cant start recording, recordingState irregular: ${this.recordingState}`);this.setRecordingState("STARTING");try{const e=wt(),{recording:t={}}=_e.defaults,s=await e.startRecording(t);this.recordingId=s}catch(e){throw g.error("DyteRecording::stop::recording_failed_to_start",{error:e}),this.setRecordingState("IDLE"),new w("Error while starting recording")}}async stop(){if(!d(this,Hn).permissions.canRecord)throw g.error("DyteRecording::stop::permission_denied"),new w("User does not have permission to stop recording");if((this.recordingState!=="RECORDING"||!this.recordingId)&&(g.error("DyteRecording::stop::recording_not_in_progress",{recording:{state:this.recordingState,id:this.recordingId}}),await this.getRecordingId()),this.recordingState!=="RECORDING"||!this.recordingId)throw g.error("DyteRecording::stop::recording_not_in_progress",{recording:{state:this.recordingState,id:this.recordingId}}),new w(`Cant stop recording, recordingState irregular: ${this.recordingState}`);this.setRecordingState("STOPPING");try{await wt().stopRecording(this.recordingId),this.setRecordingState("IDLE")}catch(e){throw g.error("DyteRecording::stop::recording_failed_to_stop",{error:e}),this.setRecordingState("RECORDING"),new w("Error while stopping recording")}}async getRecordingId(){if(!d(this,Hn).permissions.canRecord)throw g.error("DyteRecording::getRecordingId::permission_denied"),new w("User does not have permission to stop recording");try{const e=wt(),{status:t,id:s}=await e.getActiveRecording();t==="RECORDING"&&(this.recordingState="RECORDING",this.recordingId=s)}catch(e){throw g.error("DyteRecording::getRecordingId::unable_to_get_recording_id",{error:e}),new w("Unable to get recording")}}},Hn=new WeakMap,wE);Ol([_.trace("DyteRecording.start")],Na.prototype,"start",1),Ol([_.trace("DyteRecording.stop")],Na.prototype,"stop",1),Ol([_.trace("DyteRecording.getRecordingId")],Na.prototype,"getRecordingId",1),Na=Ol([Bt(r=>{throw new w(r.message,"1000")})],Na);var BF=Object.defineProperty,FF=Object.getOwnPropertyDescriptor,VF=(r,e,t,s)=>{for(var i=s>1?void 0:s?FF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&BF(e,t,i),i};class JT{constructor(e){f(this,"recording");this.recording=new Na(e),this.setupEvents()}setupEvents(){E.on(T.HIVE_RECORDING_STARTED,e=>{this.recording.recordingPeerId=e,this.recording.setRecordingState("RECORDING")}),E.on(T.HIVE_RECORDING_STOPPED,()=>{this.recording.recordingPeerId=void 0,this.recording.setRecordingState("IDLE")}),E.on(T.LEAVE_MEDIA_ROOM,()=>{this.recording.setRecordingState("IDLE")}),E.on(T.PEER_JOINED,async e=>{var t;(t=e.flags)!=null&&t.recorder&&(this.recording.recordingPeerId=e.id,this.recording.setRecordingState("RECORDING"))}),E.on(T.PEER_CLOSED,e=>{e.id===this.recording.recordingPeerId&&(this.recording.recordingPeerId=void 0,this.recording.setRecordingState("IDLE"))}),E.onAsync(T.ROOM_JOINED,async e=>{var s,i;g.debug("[ROOM_JOINED] resolved request to fetch recordings.");const t=(s=e.peers)==null?void 0:s.filter(n=>{var a;return!!((a=n.flags)!=null&&a.recorder)});t.length?(this.recording.recordingPeerId=t&&((i=t[0])==null?void 0:i.id),this.recording.setRecordingState("RECORDING")):(this.recording.recordingPeerId=void 0,this.recording.setRecordingState("IDLE"))}),E.on(T.RECORDING_STARTED,()=>{this.recording.setRecordingState("RECORDING")}),E.on(T.RECORDING_STOPPED,()=>{this.recording.recordingId=void 0,this.recording.recordingPeerId=void 0,this.recording.setRecordingState("IDLE")})}}VF([_.trace("RecordingController.setupEvents")],JT.prototype,"setupEvents",1);var $F=Object.defineProperty,HF=Object.getOwnPropertyDescriptor,jF=(r,e,t,s)=>{for(var i=s>1?void 0:s?HF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&$F(e,t,i),i},zT=(r=>(r[r.User=0]="User",r[r.Spotlight=1]="Spotlight",r))(zT||{});let Dl=(RE=class extends Ke{constructor(e){super();S(this,so);f(this,"selfActiveTab");f(this,"spotlighted");S(this,jn,void 0);this.spotlighted=e.permissions.canSpotlight,R(this,jn,e)}get roomJoined(){var e;return((e=d(this,so,fu))==null?void 0:e.roomJoined)===!0}static init(e){return new Dl(e)}setSpotlighted(e){if(!d(this,jn).permissions.canSpotlight)throw g.error("DyteSpotlight::setSpotlighted::permission_denied"),new w("User does not have permission to toggle spotlight");this.spotlighted=e,this.emit("spotlightUpdate",this.spotlighted),this.spotlighted&&this.assertSpotlightToRoom()}setSelfActiveTab(e,t){var s;g.info("DyteSpotlight::setActiveTab",{spotlight:{currentTab:{id:e.id,type:e.type}}}),this.selfActiveTab=e,t===0&&this.emit("selfTabUpdate",e),(s=d(this,jn).permissions)!=null&&s.canSpotlight&&this.spotlighted&&t===0&&this.assertSpotlightToRoom()}assertSpotlightToRoom(){d(this,so,fu)instanceof Ee&&this.selfActiveTab&&d(this,so,fu).assertSpotlightToRoom({spotlightedUserId:d(this,jn).userId,currentTab:this.selfActiveTab,peerId:void 0})}},so=new WeakSet,fu=function(){return st()},jn=new WeakMap,RE);Dl=jF([Bt(r=>{throw new w(r.message,"1300")})],Dl);var GF=Object.defineProperty,qF=Object.getOwnPropertyDescriptor,KF=(r,e,t,s)=>{for(var i=s>1?void 0:s?qF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&GF(e,t,i),i};class YT{constructor(e){S(this,Gn);f(this,"spotlight");S(this,Mi,void 0);this.spotlight=Dl.init(e),R(this,Mi,e),this.setupEvents()}conditionallySetActiveTab(e){var t;e!=null&&e.currentTab&&((t=this.spotlight.selfActiveTab)==null?void 0:t.id)!==e.currentTab.id&&(this.spotlight.setSelfActiveTab(e.currentTab,zT.Spotlight),this.spotlight.emit("activeTabUpdate",e.currentTab))}async setupEvents(){d(this,Mi).permissions.canSpotlight&&(g.info("DyteSpotlightController::Asserting Spotlight"),d(this,Gn,qc)instanceof Ee&&this.spotlight.selfActiveTab&&d(this,Gn,qc).assertSpotlightToRoom({spotlightedUserId:d(this,Mi).userId,currentTab:this.spotlight.selfActiveTab,peerId:void 0})),E.on(T.PEER_JOINED,async e=>{d(this,Mi).permissions.canSpotlight&&d(this,Gn,qc)instanceof Ee&&this.spotlight.selfActiveTab&&d(this,Gn,qc).assertSpotlightToPeer({spotlightedUserId:d(this,Mi).userId,currentTab:this.spotlight.selfActiveTab,peerId:e.id})}),E.on(T.ROOM_MESSAGE,e=>{var t,s;e.roomMessageType==="spotlight"&&(g.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:e.spotlightedUserId},currentTab:{id:(t=e.currentTab)==null?void 0:t.id,type:(s=e.currentTab)==null?void 0:s.type}}}),this.conditionallySetActiveTab(e))}),E.on(T.MESSAGE,e=>{var t,s;e.roomMessageType==="spotlight"&&(g.info("Spotlight Assertion Received",{spotlight:{spotlighter:{id:e.spotlightedUserId},currentTab:{id:(t=e.currentTab)==null?void 0:t.id,type:(s=e.currentTab)==null?void 0:s.type}}}),this.conditionallySetActiveTab(e))})}}Mi=new WeakMap,Gn=new WeakSet,qc=function(){return st()},KF([_.trace("SpotlightController.setupEvents")],YT.prototype,"setupEvents",1);function WF(r){let e=0,t,s;if(!r)return e;for(t=0;t<r.length;t+=1)s=r.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)%100+1}class JF{static hasFeature(e){var t;return(t=x.hasFeature(e))!=null?t:!1}static getFeatureValue(e){return x.getValue(e)}static getAllFeatures(){return x.getAllFlags()}}class Qp{constructor(e,t,s){f(this,"logger");f(this,"features");f(this,"browserSpecs");f(this,"callStats");this.logger=e,this.features=t,this.browserSpecs=he,this.callStats=s}static init(e){return new Qp(g,JF,e)}}class Zp{constructor(e){f(this,"internals");this.internals=e}static async init(){const e=Qp.init(L);return new Zp(e)}}var zF=Object.defineProperty,YF=Object.getOwnPropertyDescriptor,XT=(r,e,t,s)=>{for(var i=s>1?void 0:s?YF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&zF(e,t,i),i};class ef extends Ke{constructor(t){super();S(this,io,void 0);f(this,"state","IDLE");f(this,"playbackUrl");f(this,"viewerCount");R(this,io,t),this.viewerCount=0}setLivestreamState(t){const s=this.state;this.state=t,s!==t&&this.emitCurrentLivestreamState()}emitCurrentLivestreamState(){this.emit("livestreamUpdate",this.state)}async start(){if(!d(this,io).permissions.canLivestream)throw g.error("DyteLivestream::start::permission_denied"),new w("User does not have permission to start livestreaming");this.setLivestreamState("STARTING");try{const s=await wt().startLivestreaming();this.playbackUrl=s}catch(t){throw g.error("DyteRecording::stop::livestream_failed_to_start",{error:t}),this.setLivestreamState("IDLE"),new w("Error while starting livestream")}}async stop(){if(!d(this,io).permissions.canLivestream)throw g.error("DyteLivestream::stop::permission_denied"),new w("User does not have permission to stop livestreaming");if(this.state!=="LIVESTREAMING")throw g.error("DyteLivestream::stop::inconsistent_state"),new w("Livestream not started yet");try{this.setLivestreamState("STOPPING"),await wt().stopLivestreaming()}catch(t){throw g.error("DyteLivestream::stop::livestream_failed_to_stop",{error:t}),this.setLivestreamState("STOPPING"),new w("Error while stopping livestream")}}}io=new WeakMap,XT([_.trace("livestream.start")],ef.prototype,"start",1),XT([_.trace("livestream.stop")],ef.prototype,"stop",1);var XF=Object.defineProperty,QF=Object.getOwnPropertyDescriptor,ZF=(r,e,t,s)=>{for(var i=s>1?void 0:s?QF(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&XF(e,t,i),i};class QT{constructor(e,t){f(this,"livestream");S(this,Ni,void 0);S(this,Li,void 0);this.livestream=new ef(e),R(this,Li,t),this.setupEvents()}async fetchInitialLivestreamingState(){const e=wt(),{status:t,playbackUrl:s}=await e.getActiveLivestream();this.livestream.playbackUrl=s,t==="LIVE"&&this.livestream.setLivestreamState("LIVESTREAMING")}setupEvents(){d(this,Li).on(Y.startedLivestream,e=>{this.livestream.playbackUrl=e.playbackUrl,this.livestream.setLivestreamState("LIVESTREAMING")}),d(this,Li).on(Y.stoppedLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0}),d(this,Li).on(Y.erroredLivestream,()=>{this.livestream.setLivestreamState("IDLE"),this.livestream.playbackUrl=void 0}),d(this,Li).on(Y.roomPeerCount,e=>{this.livestream.viewerCount=e.count,this.livestream.emit("viewerCountUpdate",e.count)}),E.on(T.PEER_JOINED,async e=>{var t;((t=e.flags)==null?void 0:t.hiddenParticipant)===!0&&e.recorderType==="LIVESTREAMER"&&(R(this,Ni,e.id),this.livestream.setLivestreamState("LIVESTREAMING"))}),E.on(T.PEER_CLOSED,e=>{e.id===d(this,Ni)&&(R(this,Ni,void 0),this.livestream.setLivestreamState("IDLE"))}),E.onAsync(T.ROOM_JOINED,async e=>{var s,i;g.debug("[ROOM_JOINED] resolved request to fetch livestream.");const t=(s=e.peers)==null?void 0:s.filter(n=>{var a;return!!((a=n.flags)!=null&&a.hiddenParticipant)});t.length?(R(this,Ni,t&&((i=t[0])==null?void 0:i.id)),this.livestream.setLivestreamState("LIVESTREAMING")):(R(this,Ni,void 0),this.livestream.setLivestreamState("IDLE"))}),E.onAsync(T.LEAVE_MEDIA_ROOM,async()=>{if(!this.livestream.playbackUrl){g.info("Fetching livestreaming state on leave stage");try{await this.fetchInitialLivestreamingState()}catch(e){}}}),E.onAsync(T.SOCKET_SERVICE_ROOM_JOINED,async()=>{try{await this.fetchInitialLivestreamingState()}catch(e){}})}}Ni=new WeakMap,Li=new WeakMap,ZF([_.trace("LivestreamController.setupEvents")],QT.prototype,"setupEvents",1);const Ae=Sr(sh().permissions),iu=class{constructor(e){S(this,te,void 0);if(!e)throw g.error("DytePermissionsPreset::load_preset_permissions_failed"),new w("Could not load preset permissions.");R(this,te,e)}static fromResponse(e){return new iu(e)}static default(){return new iu(Ae)}get acceptWaitingRequests(){var e,t;return(t=(e=d(this,te))==null?void 0:e.acceptWaitingRequests)!=null?t:Ae.acceptWaitingRequests}get requestProduceVideo(){var e,t,s;return((s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.video)==null?void 0:s.canProduce)===At.CanRequest}get requestProduceAudio(){var e,t,s;return((s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.audio)==null?void 0:s.canProduce)===At.CanRequest}get requestProduceScreenshare(){var e,t,s;return((s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.screenshare)==null?void 0:s.canProduce)===At.CanRequest}get canAllowParticipantAudio(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canAcceptProductionRequests)!=null?t:Ae.canAcceptProductionRequests}get canAllowParticipantScreensharing(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canAcceptProductionRequests)!=null?t:Ae.canAcceptProductionRequests}get canAllowParticipantVideo(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canAcceptProductionRequests)!=null?t:Ae.canAcceptProductionRequests}get canDisableParticipantAudio(){var e,t;return(t=(e=d(this,te))==null?void 0:e.disableParticipantAudio)!=null?t:Ae.disableParticipantAudio}get canDisableParticipantVideo(){var e,t;return(t=(e=d(this,te))==null?void 0:e.disableParticipantVideo)!=null?t:Ae.disableParticipantVideo}get kickParticipant(){var e,t;return(t=(e=d(this,te))==null?void 0:e.kickParticipant)!=null?t:Ae.kickParticipant}get pinParticipant(){var e,t;return(t=(e=d(this,te))==null?void 0:e.pinParticipant)!=null?t:Ae.pinParticipant}get canRecord(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canRecord)!=null?t:Ae.canRecord}get waitingRoomType(){var e,t;return(t=(e=d(this,te))==null?void 0:e.waitingRoomType)!=null?t:Ae.waitingRoomType}get waitingRoomBehaviour(){var e,t;return(t=(e=d(this,te))==null?void 0:e.waitingRoomType)!=null?t:Ae.waitingRoomType}get plugins(){var e,t;return(t=(e=d(this,te))==null?void 0:e.plugins)!=null?t:Ae.plugins}get polls(){var e,t;return(t=(e=d(this,te))==null?void 0:e.polls)!=null?t:Ae.polls}get produceVideo(){var e,t,s,i;return(i=(s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.video)==null?void 0:s.canProduce)!=null?i:Ae.media.video.canProduce}get requestProduce(){return d(this,te).media.audio.canProduce===At.CanRequest||d(this,te).media.video.canProduce===At.CanRequest||d(this,te).media.screenshare.canProduce===At.CanRequest}get canProduceVideo(){var e,t,s,i;return(i=(s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.video)==null?void 0:s.canProduce)!=null?i:Ae.media.video.canProduce}get produceScreenshare(){var e,t,s,i;return(i=(s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.screenshare)==null?void 0:s.canProduce)!=null?i:Ae.media.screenshare.canProduce}get canProduceScreenshare(){var e,t,s,i;return(i=(s=(t=(e=d(this,te))==null?void 0:e.media)==null?void 0:t.screenshare)==null?void 0:s.canProduce)!=null?i:Ae.media.screenshare.canProduce}get produceAudio(){var e;return(e=d(this,te).media.audio.canProduce)!=null?e:Ae.media.audio.canProduce}get canProduceAudio(){var e;return(e=d(this,te).media.audio.canProduce)!=null?e:Ae.media.audio.canProduce}get chatPublic(){var e,t,s;return(s=(t=(e=d(this,te))==null?void 0:e.chat)==null?void 0:t.public)!=null?s:Ae.chat.public}get chatPrivate(){var e,t,s;return(s=(t=(e=d(this,te))==null?void 0:e.chat)==null?void 0:t.private)!=null?s:Ae.chat.private}get connectedMeetings(){var e,t;return(t=(e=d(this,te))==null?void 0:e.connectedMeetings)!=null?t:Ae==null?void 0:Ae.connectedMeetings}get hiddenParticipant(){var e,t;return(t=(e=d(this,te))==null?void 0:e.hiddenParticipant)!=null?t:Ae.hiddenParticipant}get showParticipantList(){var e;return(e=d(this,te).showParticipantList)!=null?e:Ae.showParticipantList}get canChangeParticipantRole(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canChangeParticipantPermissions)!=null?t:Ae.canChangeParticipantPermissions}get canChangeParticipantPermissions(){var e,t;return(t=(e=d(this,te))==null?void 0:e.canChangeParticipantPermissions)!=null?t:Ae.canChangeParticipantPermissions}get canChangeTheme(){return!1}get canPresent(){return d(this,te).media.audio.canProduce===At.Allowed||d(this,te).media.video.canProduce===At.Allowed||d(this,te).media.screenshare.canProduce===At.Allowed}get acceptPresentRequests(){return d(this,te).canAcceptProductionRequests}get canEditDisplayName(){var e;return(e=d(this,te).canEditDisplayName)!=null?e:!1}get maxScreenShareCount(){return 1}get isRecorder(){return d(this,te).isRecorder}get canSpotlight(){return d(this,te).canSpotlight}get canLivestream(){return d(this,te).canLivestream}get isV2(){return!0}};let Ml=iu;te=new WeakMap;const eV=Sr(sh()),nu=class{constructor(e){S(this,Jr,void 0);S(this,qn,void 0);S(this,no,void 0);if(!e)throw new w("Could not load preset.");R(this,Jr,e.config),R(this,qn,e.ui||Sr(sh().ui)),R(this,no,e.permissions.plugins.config)}static fromResponse(e){return new nu(e)}static default(){return new nu(eV)}get setupScreen(){return{isEnabled:!0}}get waitingRoom(){return{isEnabled:!0}}get controlBar(){return{isEnabled:!0,elements:{chat:!0,fullscreen:!0,invite:!1,layout:!1,participants:!0,plugins:!0,polls:!0,reactions:!1,screenshare:!0}}}get header(){return{isEnabled:!0,elements:{logo:d(this,qn).designTokens.logo,timer:!0,title:!0,participantCount:!0,changeLayout:!1}}}get pipMode(){return!0}get viewType(){return d(this,Jr).viewType}get maxVideoStreams(){return d(this,Jr).maxVideoStreams}get maxScreenShareCount(){return d(this,Jr).maxScreenshareCount}get plugins(){return[]}get disabledPlugins(){return Object.keys(d(this,no)).filter(e=>d(this,no)[e].disabled)}get designTokens(){return d(this,qn).designTokens}get configDiff(){return d(this,qn).configDiff}get mediaConstraints(){var e,t,s,i,n,a,o,c,l,u,h,p,m,v,y,C;return{video:{quality:(i=(s=(t=(e=d(this,Jr))==null?void 0:e.media)==null?void 0:t.video)==null?void 0:s.quality)!=null?i:sr.video.quality,frameRate:(c=(o=(a=(n=d(this,Jr))==null?void 0:n.media)==null?void 0:a.video)==null?void 0:o.frameRate)!=null?c:sr.video.frameRate},screenshare:{quality:(p=(h=(u=(l=d(this,Jr))==null?void 0:l.media)==null?void 0:u.screenshare)==null?void 0:h.quality)!=null?p:sr.screenshare.quality,frameRate:(C=(y=(v=(m=d(this,Jr))==null?void 0:m.media)==null?void 0:v.screenshare)==null?void 0:y.frameRate)!=null?C:sr.screenshare.frameRate}}}get isV2(){return!0}};let Nl=nu;Jr=new WeakMap,qn=new WeakMap,no=new WeakMap;const tV=Sr({setup_screen:{is_enabled:!1},alone_here:{is_enabled:!1},waiting_room:{is_enabled:!1,enable_preview:!0},control_bar:{is_enabled:!0,elements:{plugins:!0,screenshare:!0,invite:!1,participants:!0,chat:!0,reactions:!1,polls:!0,fullscreen:!0,layout:!0}},header:{is_enabled:!0,elements:{logo:"",timer:!0,title:!0,participant_count:!0,change_layout:!0}},pip_mode:!0,auto_tune:!0,grid:{multi:{max_video_count:9,video_fit:"cover"},single:{max_video_count:6,video_fit:"cover"},default_view:"MULTI"},colors:{primary:"#2160FD",secondary:"#1A1A1A",text:"#EEEEEE",background:"#1A1A1A",text_primary:"#EEEEEE",video_background:"#1A1A1A"},controls:{pip_toggle:!1},plugins:[]}),au=class{constructor(e){S(this,Ht,void 0);S(this,ao,void 0);S(this,oo,void 0);S(this,Uc,void 0);S(this,Bc,[]);if(!e)throw new w("Could not load preset theme.");R(this,Ht,e),R(this,ao,1),R(this,oo,xt.GroupCall)}static fromResponse(e){return new au(e)}static default(){return new au(tV)}configFromPermissions(e){var t,s,i,n,a,o,c,l,u,h,p,m;R(this,ao,e.maxScreenshareCount||1),R(this,oo,e.viewType),R(this,Uc,{video:{quality:(i=(s=(t=e==null?void 0:e.produce)==null?void 0:t.video)==null?void 0:s.quality)!=null?i:sr.video.quality,frameRate:(o=(a=(n=e==null?void 0:e.produce)==null?void 0:n.video)==null?void 0:a.frameRate)!=null?o:sr.video.frameRate},screenshare:{quality:(u=(l=(c=e==null?void 0:e.produce)==null?void 0:c.screenshare)==null?void 0:l.quality)!=null?u:sr.screenshare.quality,frameRate:(m=(p=(h=e==null?void 0:e.produce)==null?void 0:h.screenshare)==null?void 0:p.frameRate)!=null?m:sr.screenshare.frameRate}})}setDisabledPlugins(e){const t=d(this,Ht).plugins;t&&t.length>0&&R(this,Bc,e.filter(s=>!t.includes(s)))}get setupScreen(){return d(this,Ht).setupScreen}get aloneHere(){return d(this,Ht).aloneHere}get waitingRoom(){return d(this,Ht).waitingRoom}get controlBar(){return d(this,Ht).controlBar}get header(){return d(this,Ht).header}get pipMode(){var e;return((e=d(this,Ht).controls)==null?void 0:e.pipToggle)||d(this,Ht).pipMode}get viewType(){return d(this,oo)}get autoTune(){return d(this,Ht).autoTune}get grid(){return d(this,Ht).grid}get maxVideoStreams(){return{mobile:this.grid.multi.maxVideoCount>6?6:this.grid.multi.maxVideoCount,desktop:this.grid.multi.maxVideoCount}}get maxScreenShareCount(){return d(this,ao)}get colors(){return d(this,Ht).colors}get controls(){return d(this,Ht).controls}get plugins(){return d(this,Ht).plugins}get disabledPlugins(){return d(this,Bc)}get mediaConstraints(){return d(this,Uc)}get isV2(){return!1}};let Ll=au;Ht=new WeakMap,ao=new WeakMap,oo=new WeakMap,Uc=new WeakMap,Bc=new WeakMap;class rV{constructor(e){S(this,Fc,void 0);R(this,Fc,e)}on(e,t){let s;e===Y.roomPeerCount?s=Tv.fromBinary.bind(Tv):s=kv.fromBinary.bind(kv),d(this,Fc).on(e,({payload:i})=>{const n=s(i);return t(n)})}}Fc=new WeakMap;class sV{constructor(e){S(this,gr,void 0);R(this,gr,e)}async getStageRequests(){const{payload:e}=await d(this,gr).sendMessagePromise(Y.getStageRequests);return e?up.fromBinary(e):{stageRequests:[]}}requestAccess(){d(this,gr).sendMessage(Y.requestStageAccess)}cancelRequestAccess(){d(this,gr).sendMessage(Y.cancelStageRequest)}async grantAccess(e){const t={userIds:e};await d(this,gr).sendMessagePromise(Y.grantStageAccess,k1.toBinary(t))}async denyAccess(e){const t={userIds:e};await d(this,gr).sendMessagePromise(Y.denyStageAccess,D1.toBinary(t))}joinStage(){return d(this,gr).sendMessage(Y.joinStage)}leaveStage(e){const t={userIds:[e]};return d(this,gr).sendMessage(Y.leaveStage,Dv.toBinary(t))}kick(e){const t={userIds:e};return d(this,gr).sendMessagePromise(Y.leaveStage,Dv.toBinary(t))}on(e,t){let s;switch(e){case Y.grantStageAccess:case Y.denyStageAccess:{s=void 0;break}case Y.getStagePeers:{s=Ov.fromBinary.bind(Ov);break}case Y.getStageRequests:case Y.requestStageAccess:case Y.cancelStageRequest:{s=up.fromBinary.bind(up);break}}d(this,gr).on(e,({payload:i,id:n})=>{if(!i||!s)return t(void 0,n);const a=s(i);return t(a,n)})}}gr=new WeakMap;var iV=Object.defineProperty,nV=Object.getOwnPropertyDescriptor,Sn=(r,e,t,s)=>{for(var i=s>1?void 0:s?nV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&iV(e,t,i),i};class fi extends Ke{constructor(t,s,i){super();S(this,Or,void 0);S(this,zr,void 0);S(this,fs,void 0);f(this,"status");R(this,Or,i),R(this,fs,s),R(this,zr,t)}async getAccessRequests(){if(!d(this,zr))throw new w("You do not have permissions for getStageRequests");const{stageRequests:t}=await d(this,Or).getStageRequests();return{stageRequests:t}}requestAccess(){if(this.status!=="OFF_STAGE")throw new w(`Unable to request access you are currently ${this.status}`);if(d(this,zr)){this.setStatus("ACCEPTED_TO_JOIN_STAGE");return}d(this,Or).requestAccess(),this.setStatus("REQUESTED_TO_JOIN_STAGE")}cancelRequestAccess(){d(this,Or).cancelRequestAccess(),this.setStatus("OFF_STAGE")}grantAccess(t){if(!d(this,zr))throw new w("You do not have permissions for grantAccess");return d(this,Or).grantAccess(t)}denyAccess(t){if(!d(this,zr))throw new w("You do not have permissions for denyAccess");return d(this,Or).denyAccess(t)}async join(){if(!d(this,zr)&&this.status!=="ACCEPTED_TO_JOIN_STAGE")throw new w(`Unable to join stage you are currently ${this.status}`);if(d(this,zr)&&this.status==="ON_STAGE")throw new w("You are already on stage.");d(this,Or).joinStage(),await E.emitAsync(T.JOIN_MEDIA_ROOM),this.setStatus("ON_STAGE")}async leave(){var t;if(!(this.status==="ON_STAGE"||this.status==="ACCEPTED_TO_JOIN_STAGE"))throw new w(`Unable to leave stage you are currently ${this.status}`);d(this,fs).setIsPinned(!1),this.setStatus("OFF_STAGE"),(t=st())!=null&&t.roomJoined&&await E.emitAsync(T.LEAVE_MEDIA_ROOM);try{await d(this,fs).disableScreenShare(),await d(this,fs).disableVideo(),await d(this,fs).disableAudio(),d(this,fs).destructMediaHandler()}catch(s){g.error("DyteStage.leaveStage.DisableMediaError",{error:s})}d(this,Or).leaveStage(d(this,fs).userId)}async kick(t){if(!d(this,zr))throw new w("You do not have permissions for kick");return d(this,Or).kick(t)}setStatus(t){this.status!==t&&(this.status=t,this.emit("stageStatusUpdate",t))}}Or=new WeakMap,zr=new WeakMap,fs=new WeakMap,Sn([_.trace("DyteStage.getStageRequests")],fi.prototype,"getAccessRequests",1),Sn([_.trace("DyteStage.requestAccess")],fi.prototype,"requestAccess",1),Sn([_.trace("DyteStage.cancelRequestAccess")],fi.prototype,"cancelRequestAccess",1),Sn([_.trace("DyteStage.grantAccess")],fi.prototype,"grantAccess",1),Sn([_.trace("DyteStage.denyAccess")],fi.prototype,"denyAccess",1),Sn([_.trace("DyteStage.joinStage")],fi.prototype,"join",1),Sn([_.trace("DyteStage.leaveStage")],fi.prototype,"leave",1);var aV=Object.defineProperty,oV=Object.getOwnPropertyDescriptor,cV=(r,e,t,s)=>{for(var i=s>1?void 0:s?oV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&aV(e,t,i),i};class ZT{constructor(e,t,s){f(this,"stage");S(this,Kn,void 0);S(this,co,void 0);S(this,xi,void 0);S(this,Vc,0);this.stage=new fi(t,s,e),R(this,xi,e),R(this,Kn,t),R(this,co,s),this.setupEvents()}setupEvents(){d(this,xi).on(Y.grantStageAccess,()=>{d(this,Kn)||(this.stage.emit("stageRequestApproved"),this.setStageStatus("ACCEPTED_TO_JOIN_STAGE"))}),d(this,xi).on(Y.denyStageAccess,()=>{d(this,Kn)||(this.stage.emit("stageRequestRejected"),this.setStageStatus("OFF_STAGE"))}),d(this,xi).on(Y.getStagePeers,e=>{this.stage.status==="ON_STAGE"&&!e.stagePeers.includes(d(this,co).userId)&&E.emitAsync(T.LEAVE_MEDIA_ROOM)}),d(this,xi).on(Y.getStageRequests,e=>{var s;if(!d(this,Kn))return;const t=(s=e==null?void 0:e.stageRequests)!=null?s:[];d(this,Vc)<t.length&&t.length>0&&this.stage.emit("newStageRequest",{count:t.length}),R(this,Vc,t.length),this.stage.emit("stageAccessRequestUpdate",t)}),E.onAsync(T.SOCKET_SERVICE_ROOM_JOINED,async e=>{var t;switch((t=e.peer)==null?void 0:t.stageType){case nn.OFF_STAGE:{this.setStageStatus("OFF_STAGE");break}case nn.ON_STAGE:{d(this,co).config.viewType==="LIVESTREAM"&&(await E.emitAsync(T.JOIN_MEDIA_ROOM),this.setStageStatus("ON_STAGE"));break}case nn.APPROVED_STAGE:{this.stage.emit("stageRequestApproved"),this.setStageStatus("ACCEPTED_TO_JOIN_STAGE");break}case nn.REQUESTED_STAGE:{this.setStageStatus("REQUESTED_TO_JOIN_STAGE");break}default:this.setStageStatus("OFF_STAGE")}})}setStageStatus(e){this.stage.status!==e&&(this.stage.status=e,this.stage.emit("stageStatusUpdate",e))}}Kn=new WeakMap,co=new WeakMap,xi=new WeakMap,Vc=new WeakMap,cV([_.trace("DyteStage.setupEvents")],ZT.prototype,"setupEvents",1);var dV=Object.defineProperty,lV=Object.getOwnPropertyDescriptor,tf=(r,e,t,s)=>{for(var i=s>1?void 0:s?lV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&dV(e,t,i),i};class xl{constructor(e){S(this,Ui,void 0);R(this,Ui,e)}getPolls(){return d(this,Ui).sendMessagePromise(bs.getPolls)}createPoll(e,t,s=!1,i=!1){const n={anonymous:s,hideVotes:i,question:e,options:t};return d(this,Ui).sendMessage(bs.createPoll,V1.toBinary(n))}votePoll(e,t){const s={index:t,pollId:e};return d(this,Ui).sendMessage(bs.votePoll,H1.toBinary(s))}on(e,t){let s,i;switch(e){case bs.updatePoll:case bs.createPoll:case bs.votePoll:{s=hp.fromBinary.bind(hp),i=hp.create();break}}d(this,Ui).on(e,({payload:n})=>{let a=i;try{a=s(n)}catch(o){g.error("pollSocketHandler::on::binary_decode_error",{error:o})}return t(a)})}}Ui=new WeakMap,tf([_.trace("PollSocketHandler.getPolls")],xl.prototype,"getPolls",1),tf([_.trace("PollSocketHandler.createPoll")],xl.prototype,"createPoll",1),tf([_.trace("PollSocketHandler.votePoll")],xl.prototype,"votePoll",1);class uV{constructor(){f(this,"battery");f(this,"init",async()=>{try{"getBattery"in navigator&&(this.battery=await navigator.getBattery(),this.battery.addEventListener("chargingchange",this.updateChargeInfo),this.battery.addEventListener("levelchange",this.updateLevelInfo),this.updateLevelInfo(),this.updateChargeInfo())}catch(e){g.error("Error getting battery",e)}});f(this,"updateChargeInfo",()=>{var e;g.log(`Battery charging? ${(e=this.battery)!=null&&e.charging?"Yes":"No"}`)});f(this,"updateLevelInfo",()=>{if(!this.battery){g.log("Battery level: Not known");return}g.log(`Battery level: ${this.battery.level*100}%`)});f(this,"cleanup",()=>{var e,t;"getBattery"in navigator&&((e=this.battery)==null||e.removeEventListener("chargingchange",this.updateChargeInfo),(t=this.battery)==null||t.removeEventListener("levelchange",this.updateLevelInfo))})}}const eE=new uV;class hV extends Ke{constructor(t){super();S(this,$c);S(this,js,void 0);S(this,Gs,void 0);R(this,js,t),R(this,Gs,!1)}get mediaPermission(){return d(this,js).mediaPermissions.audio}async getTrackMetadata(t=!1){if(!ls.track){if(!t)return null;const s=await be(this,$c,yf).call(this);ls.setTrack(s)}return ls.getTrackMetadata()}async startTrackAnalysis(t=!1){if(d(this,Gs))return!0;R(this,Gs,!0);let s=await ls.startTrackAnalysis();if(!s&&t){const i=await be(this,$c,yf).call(this);ls.setTrack(i),s=await ls.startTrackAnalysis()}return s||R(this,Gs,!1),s}stopTrackAnalysis(){return d(this,Gs)&&(R(this,Gs,!1),ls.stopTrackAnalysis()),!0}}js=new WeakMap,Gs=new WeakMap,$c=new WeakSet,yf=async function(){var t;try{const s=d(this,js).getCurrentDevices(),i=(t=s==null?void 0:s.audio)==null?void 0:t.deviceId;let n={audio:!0};i&&(n=We.getAudioConstraints({audioDeviceId:i}));const a=await We.getAudioTrack(n);return d(this,js).mediaPermissions.audio="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:d(this,js).mediaPermissions.audio,kind:"audio"}),a}catch(s){const i=vl("audio",s.name,s.message);throw d(this,js).mediaPermissions.audio=i,E.emit(T.MEDIA_PERMISSION_ERROR,{message:i,constraints:s.constraints,kind:"audio"}),new w("Failed to fetch audio track","1700")}};class pV extends Ke{constructor(){super();S(this,Bi,void 0);R(this,Bi,!1)}async getNetworkMetadata(){return new Promise(t=>{L.onSafeInitialization(()=>{L.onPreCallTestResults(s=>{t(s.connectionInfo)}),L.startPreCallTest()})})}startNetworkAnalysis(){return R(this,Bi,ai.collectSendTransportStats()&&ai.collectRecvTransportStats()),d(this,Bi)}stopNetworkAnalysis(){return R(this,Bi,!(ai.stopStatsCollection("send")&&ai.stopStatsCollection("receive"))),d(this,Bi)}}Bi=new WeakMap;class fV extends Ke{constructor(t){super();S(this,Wn,void 0);S(this,ar,void 0);R(this,Wn,t),R(this,ar,{audio:!1,video:!1})}get mediaPermission(){return d(this,Wn).mediaPermissions.screenshare}getAudioTrackMetaData(){var t;return(t=d(this,Wn).screenShareTracks)!=null&&t.audio?_n.getTrackMetadata():null}getVideoTrackMetaData(){var t;return(t=d(this,Wn).screenShareTracks)!=null&&t.video?ci.getTrackMetadata():null}async startAudioTrackAnalysis(){if(d(this,ar).audio)return!0;const t=await _n.startTrackAnalysis();return d(this,ar).audio=t,d(this,ar).audio}async startVideoTrackAnalysis(){if(d(this,ar).video)return!0;const t=await ci.startTrackAnalysis();return d(this,ar).video=t,d(this,ar).video}stopAudioTrackAnalysis(){return d(this,ar)&&(d(this,ar).audio=!1,_n.stopTrackAnalysis()),!0}stopVideoTrackAnalysis(){return d(this,ar)&&(d(this,ar).video=!1,ci.stopTrackAnalysis()),!0}}Wn=new WeakMap,ar=new WeakMap;class mV extends Ke{constructor(t){super();S(this,ou);S(this,ms,void 0);S(this,gs,void 0);S(this,qs,void 0);f(this,"preview");R(this,ms,t),R(this,gs,!1),R(this,qs,!1)}get mediaPermission(){return d(this,ms).mediaPermissions.video}getTrackMetadata(){return d(this,ms).videoTrack?null:hr.getTrackMetadata()}async startTrackAnalysis({preview:t}={preview:!1}){return d(this,gs)?!0:await hr.startTrackAnalysis()?((t||this.preview)&&R(this,qs,!0),R(this,gs,!0),!0):!1}stopTrackAnalysis(){d(this,gs)&&(hr.stopTrackAnalysis(),R(this,gs,!1),d(this,qs)&&R(this,qs,!1))}async startPreview(){let{track:t}=hr;return t||(t=await be(this,ou,iy).call(this)),this.preview||(hr.setTrack(t),this.preview=!0,hr.preview=!0),t}stopPreview(){d(this,gs)&&d(this,qs)&&this.stopTrackAnalysis(),this.preview=!1,hr.preview=!1,hr.cleanup()}cleanup(){d(this,gs)&&d(this,qs)&&this.stopTrackAnalysis(),this.preview=!1,hr.preview=!1}}ms=new WeakMap,gs=new WeakMap,qs=new WeakMap,ou=new WeakSet,iy=async function(){var t;try{const s=d(this,ms).getCurrentDevices(),i=(t=s==null?void 0:s.video)==null?void 0:t.deviceId;let n={video:{width:{ideal:1280},height:{ideal:720}}};i&&(n=We.getVideoConstraints({videoDeviceId:i}));const a=await We.getVideoTrack(n);return d(this,ms).mediaPermissions.video="ACCEPTED",E.emit(T.MEDIA_PERMISSION_UPDATE,{message:d(this,ms).mediaPermissions.video,kind:"video"}),a}catch(s){const i=vl("video",s.name,s.message);throw d(this,ms).mediaPermissions.video=i,E.emit(T.MEDIA_PERMISSION_ERROR,{message:i,constraints:s.constraints,kind:"video"}),new w("Failed to fetch video track","1700")}};class gV{constructor(e){f(this,"audio");f(this,"video");f(this,"screenshare");f(this,"network");this.audio=new hV(e),this.video=new mV(e),this.screenshare=new fV(e),this.network=new pV}}const rf=r=>{const{type:e,id:t,transport:s,timestamp:i,currentRoundTripTime:n,bytesSent:a,bytesReceived:o,kind:c,jitter:l,packetsLost:u,totalPacketSendDelay:h}=r;switch(e){case"candidate-pair":return{type:e,id:t,transport:s,timestamp:i,rtt:n,bytesSent:a,bytesReceived:o};case"inbound-rtp":return{type:e,id:t,transport:s,timestamp:i,kind:c,jitter:l,packetsLost:u,bytesReceived:o};default:return{type:e,id:t,transport:s,timestamp:i,kind:c,packetSendDelay:h,bytesSent:a}}};class _V{constructor(e){f(this,"troubleshooter");f(this,"self");this.troubleshooter=new gV(e),this.self=e,this.setupEvents()}setupEvents(){E.on(T.AUDIO_TRACK_CHANGED,()=>{var e;this.self.audioTrack&&((e=this.self.audioTrack)!=null&&e.enabled)&&ls.setTrack(this.self.audioTrack)}),E.on(T.VIDEO_TRACK_CHANGED,()=>{var e;this.self.videoTrack&&hr.setTrack((e=this.self.videoTrack)==null?void 0:e.clone())}),E.on(T.SCREENSHARE_TRACK_CHANGED,()=>{var e,t,s,i,n;(e=this.self.screenShareTracks)!=null&&e.audio&&this.self.screenShareTracks.audio.enabled?_n.setTrack((t=this.self.screenShareTracks)==null?void 0:t.audio):_n.cleanup(),(s=this.self.screenShareTracks)!=null&&s.video?ci.setTrack((n=(i=this.self.screenShareTracks)==null?void 0:i.video)==null?void 0:n.clone()):ci.cleanup()}),E.on(T.AUDIO_TRACK_ANALYSIS,e=>{this.troubleshooter.audio.emit("audioTrackStats",e)}),E.on(T.AUDIO_TRACK_CLOSED,()=>{this.troubleshooter.audio.emit("audioTrackUpdate",{status:"ended"})}),E.on(T.AUDIO_TRACK_CREATED,()=>{this.troubleshooter.audio.emit("audioTrackUpdate",{status:"live"})}),E.on(T.SCREENSHARE_AUDIO_TRACK_ANALYSIS,e=>{this.troubleshooter.screenshare.emit("audioTrackStats",e)}),E.on(T.SCREENSHARE_AUDIO_TRACK_CLOSED,()=>{this.troubleshooter.screenshare.emit("audioTrackUpdate",{status:"ended"})}),E.on(T.SCREENSHARE_AUDIO_TRACK_CREATED,()=>{this.troubleshooter.screenshare.emit("audioTrackUpdate",{status:"live"})}),E.on(T.SCREENSHARE_VIDEO_TRACK_ANALYSIS,e=>{this.troubleshooter.screenshare.emit("videoTrackStats",e)}),E.on(T.SCREENSHARE_VIDEO_TRACK_ANALYSIS_ERROR,()=>{this.troubleshooter.screenshare.stopVideoTrackAnalysis(),ci.cleanup()}),E.on(T.SCREENSHARE_VIDEO_TRACK_CLOSED,()=>{this.troubleshooter.screenshare.emit("videoTrackUpdate",{status:"ended"})}),E.on(T.SCREENSHARE_VIDEO_TRACK_CREATED,()=>{this.troubleshooter.screenshare.emit("videoTrackUpdate",{status:"live"})}),E.on(T.VIDEO_TRACK_ANALYSIS,e=>{this.troubleshooter.video.emit("videoTrackStats",e)}),E.on(T.VIDEO_TRACK_ANALYSIS_ERROR,()=>{this.troubleshooter.video.stopTrackAnalysis(),this.troubleshooter.video.startTrackAnalysis(),this.troubleshooter.video.stopPreview()}),E.on(T.VIDEO_TRACK_CLOSED,()=>{this.troubleshooter.video.cleanup(),this.troubleshooter.video.emit("videoTrackUpdate",{status:"ended"})}),E.on(T.VIDEO_TRACK_CREATED,()=>{this.troubleshooter.video.emit("videoTrackUpdate",{status:"live"})}),E.on(T.CANDIDATE_PEER_UPDATE,e=>{this.troubleshooter.network.emit("connectionDelayStats",rf(e))}),E.on(T.INBOUND_RTP_UPDATE,e=>{this.troubleshooter.audio.emit("audioConsumptionStats",rf(e))}),E.on(T.OUTBOUND_RTP_UPDATE,e=>{this.troubleshooter.audio.emit("audioProductionStats",rf(e))}),E.on(T.SEND_TRANSPORT_CLOSED,()=>{this.troubleshooter.audio.emit("connectionUpdate",{transport:"send",status:"ended"})}),E.on(T.RECV_TRANSPORT_CLOSED,()=>{this.troubleshooter.audio.emit("connectionUpdate",{transport:"receive",status:"ended"})}),E.on(T.SEND_TRANSPORT_CREATED,()=>{this.troubleshooter.audio.emit("connectionUpdate",{transport:"send",status:"live"})}),E.on(T.RECV_TRANSPORT_CREATED,()=>{this.troubleshooter.audio.emit("connectionUpdate",{transport:"receive",status:"live"})})}}const Fi=class{static handleConnectedRoomsDumpRaw({payload:e}){var n;const t=hL.fromBinary(e),s=t.meetings.map(a=>{var o;return{id:a.id,title:a.title,participants:(o=a.participants)!=null?o:[]}});return{parentMeeting:{id:t.parentMeeting.id,title:t.parentMeeting.title,participants:(n=t.parentMeeting.participants)!=null?n:[]},meetings:s}}static handleTransferPeerRaw({payload:e}){const t=BL.fromBinary(e);return{authToken:t.authToken,meetingId:t.meetingId}}static handleMovedPeerRaw({payload:e}){const t=Rv.fromBinary(e);return{meetingId:t.meetingId,customParticipantId:t.customParticipantId}}static handleConnectedRoomsUpdatedRaw({payload:e}){return wv.fromBinary(e).payloads.map(s=>({id:s.id,title:s.title}))}static handleConnectedRoomsDeletedRaw({payload:e}){return AL.fromBinary(e).payloads}static async getConnectedRoomsDump(){const e=await Fi.socketService.sendMessagePromise(Y.getConnectedRoomsDump);return Fi.handleConnectedRoomsDumpRaw(e)}static async createConnectedRooms(e){const{payload:t}=await Fi.socketService.sendMessagePromise(Y.createConnectedRooms,gL.toBinary({payloads:e}));return wv.fromBinary(t).payloads.map(i=>({id:i.id,title:i.title}))}static async updateConnectedRooms(e){}static async disableConnectedRooms(e){const t=e.map(i=>({id:i})),s=await Fi.socketService.sendMessagePromise(Y.deleteConnectedRooms,CL.toBinary({payloads:t}));return Fi.handleConnectedRoomsDeletedRaw(s)}static async movePeersBetweenRooms(e){try{const t=await Fi.socketService.sendMessagePromise(Y.movePeers,NL.toBinary({sourceMeetingId:e.sourceMeetingId,destinationMeetingId:e.destinationMeetingId,participants:e.participants}));return new TextDecoder().decode(t.payload).includes("error")?{success:!1,error:"failed to move participants"}:{success:!0}}catch(t){return{success:!1,error:t}}}};let He=Fi;f(He,"socketService"),f(He,"currentMeetingId");const vV={codecs:[{kind:"audio",mimeType:"audio/opus",clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc",parameter:""}],parameters:{},preferredPayloadType:100},{kind:"video",mimeType:"video/VP8",clockRate:9e4,rtcpFeedback:[{type:"nack",parameter:""},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb",parameter:""},{type:"transport-cc",parameter:""}],parameters:{"x-google-start-bitrate":1e3},preferredPayloadType:101},{kind:"video",mimeType:"video/rtx",preferredPayloadType:102,clockRate:9e4,parameters:{apt:101},rtcpFeedback:[]},{kind:"video",mimeType:"video/VP9",clockRate:9e4,rtcpFeedback:[{type:"nack",parameter:""},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb",parameter:""},{type:"transport-cc",parameter:""}],parameters:{"profile-id":0,"x-google-start-bitrate":1e3},preferredPayloadType:103},{kind:"video",mimeType:"video/rtx",preferredPayloadType:104,clockRate:9e4,parameters:{apt:103},rtcpFeedback:[]},{kind:"video",mimeType:"video/H264",clockRate:9e4,parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f","x-google-start-bitrate":1e3},rtcpFeedback:[{type:"nack",parameter:""},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb",parameter:""},{type:"transport-cc",parameter:""}],preferredPayloadType:105},{kind:"video",mimeType:"video/rtx",preferredPayloadType:106,clockRate:9e4,parameters:{apt:105},rtcpFeedback:[]}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://tools.ietf.org/html/draft-ietf-avtext-framemarking-07",preferredId:6,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:framemarking",preferredId:7,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",preferredId:13,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time",preferredId:13,preferredEncrypt:!1,direction:"sendrecv"}]};let sf;class nf{constructor(e){f(this,"socket");this.socket=e,this.handleSocketEvents()}static create(e){return sf||(sf=new nf(e)),sf}set onReconnect(e){this.socket.onStateEvent("reconnected",e)}async joinRoom(e,t,s,i){const n={capabilities:[],peer:{displayName:e,peerId:t,userId:s},roomUuid:i},a=tl.fromBinary((await this.socket.sendMessagePromise(Y.joinRoom,rL.toBinary(n))).payload);await E.emitAsync(T.SOCKET_SERVICE_ROOM_JOINED,a);try{const{room:o}=await this.getRoomState();E.emit(T.ROOM_STATE,o)}catch(o){g.error("RoomSocketHandler.joinRoom.failedToGetRoomState",{error:o})}}async getAllAddedParticipants(){try{return VL.fromBinary((await this.socket.sendMessagePromise(Y.getAllAddedParticipants)).payload).participants.map(({id:t,...s})=>({...s,userId:t}))}catch(e){return[]}}async getRoomState(){let e=yv.create();try{const t=await this.socket.sendMessagePromise(Y.getRoomInfo);e=yv.fromBinary(t.payload)}catch(t){g.error("getRoomState::binary_decode_error",{error:t})}return e}async broadcastMessage(e,t){const s={type:e,payload:new TextEncoder().encode(JSON.stringify(t)),timestamp:Date.now(),peerIds:[]};return this.socket.sendMessagePromise(Y.broadcastMessage,bv.toBinary(s))}leaveRoom(){this.socket.sendMessage(Y.leaveRoom,iL.toBinary({}))}async kick(e){const t={peerIds:[e]};this.socket.sendMessage(Y.kick,GL.toBinary(t))}async kickAll(){this.socket.sendMessage(Y.kickAll)}handleSocketEvents(){this.socket.on(Y.broadcastMessage,({payload:e})=>{try{const t=bv.fromBinary(e);E.emit(T.ROOM_MESSAGE,{payload:JSON.parse(new TextDecoder().decode(t.payload)),type:t.type,timestamp:t.timestamp})}catch(t){g.error("failed to decode broadcast message:",t)}})}on(e,t){let s,i;switch(e){case Y.joinRoom:case Y.leaveRoom:case Y.kick:case Y.kickAll:{s=tl.fromBinary.bind(tl),i=tl.create();break}}this.socket.on(e,({payload:n})=>{let a=i;try{a=s(n)}catch(o){g.error("roomSocketHandler::on::binary_decode_error",{error:o})}return t(a)})}}var TV=Object.defineProperty,EV=Object.getOwnPropertyDescriptor,nc=(r,e,t,s)=>{for(var i=s>1?void 0:s?EV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&TV(e,t,i),i};const Ul=class{constructor(r,e,t,s,i,n,a,o,c,l,u,h,p,m){f(this,"apiBase");f(this,"chatController");f(this,"metaController");f(this,"participantController");f(this,"pluginController");f(this,"pollController");f(this,"remoteController");f(this,"selfController");f(this,"recordingController");f(this,"spotlightController");f(this,"livestreamController");f(this,"internalsController");f(this,"stageController");f(this,"troubleshooterController");this.apiBase=r,this.metaController=e,this.selfController=t,this.pluginController=s,this.participantController=i,this.chatController=n,this.pollController=a,this.remoteController=o,this.recordingController=c,this.spotlightController=l,this.livestreamController=h,this.internalsController=u,this.stageController=p,this.troubleshooterController=m}static async init(r,e){var PE,AE,IE,kE,OE,DE,ME,NE,LE,xE,UE,BE,FE;const{apiBase:t="https://api.cluster.dyte.in",authToken:s}=r,i={chat:!0,participant:!0,plugin:!0,poll:!0,self:!0,meta:!0,permissions:!0,theme:!0,spotlight:!0,tracing:!0,devTools:{logs:!1},internals:!0,stage:!0,...r==null?void 0:r.modules};E.reset();const n=gx({authToken:s,baseURL:t});n.setHeader("dyte-tracing-id",e),n.setPeerId(e),n.setRoomName(r.roomName);const{roomName:a}=r,o=re.isV2AuthToken?re.meetingId:a,c=new Hg,l=c.load({routerRtpCapabilities:vV}),u=n.getRoomNodeData({roomName:o,peerId:e}),h=re.isV2AuthToken?void 0:n.getUserPreset(a),p=await n.getUserDetails(),m=re.isV2AuthToken?p.participant.organizationId:p.organizationId;_.meetingMetadata.userId=re.isV2AuthToken?p.participant.id:p.id,XP({...r,modules:i,apiBase:t,organizationId:m}),_.meetingMetadata.organizationId=m;const v=WF(o);await x.identify(`${Th.PEER}_${e}`,JSON.parse(JSON.stringify({entity:Th.PEER,clientId:m,isAnonUser:!m,sdkVersion:ca,meetingHash:v,roomName:o,...he.getDeviceInfo()}))),dF(),g.info("flagsmith::allFlags",{flags:JSON.stringify(x.getAllFlags())},!0),eE.init();let y=re.isV2AuthToken?Ml.default():$d.default(),C=re.isV2AuthToken?Nl.default():Ll.default(),k=re.isV2AuthToken?p.preset.name:void 0;if(i.permissions||i.theme){const Js=await h;Js&&(k=Js.presetName),i.permissions&&(y=re.isV2AuthToken?Ml.fromResponse(p.preset.permissions):$d.fromResponse(Js.permissions)),i.theme&&(C=re.isV2AuthToken?Nl.fromResponse(p.preset):Ll.fromResponse(Js.theme),re.isV2AuthToken||C.configFromPermissions(Js.permissions))}const{roomNodeUrl:D,meetingTitle:V,useHiveMedia:M}=await u;await l;const Pe=wT(C),W=x.hasFeature(U.CUSTOM_PING_PONG),Se=[];M&&Se.push("HIVE"),W&&Se.push("PING");const lt=Xh(C.viewType,Se),or=n.getPlugins(lt),Ge=C.viewType!==xt.Chat;Y_({...r,roomName:o,peerId:e,meetingTitle:V,roomNodeUrl:D,device:c});const Ie=await Ul.createSocketServiceAndRoomNodeClient({...r,roomName:o,peerId:e,meetingTitle:V,roomNodeUrl:D,capabilities:Se,shouldInitializeRoomNode:Pe,viewType:C.viewType,device:c}),ut=st();let Ks,_r,du,lu,De,se,F,qe,cr,uo,Ws,Vi,uu;const Gc=new Cr(Ie),AV=new Tn(Ie),IV=new xl(Ie),kV=new LF(Ie),OV=new rV(Ie),DV=new sV(Ie);He.socketService=Ie;const CE=nf.create(Ie);(PE=i.self)==null||PE?([De]=await Promise.all([ba.init(Ie,CE,p,y,C,k),ut instanceof Ee?ut.setupTransports():null]),n.setOrganizationId(De.self.organizationId)):ut instanceof Ee&&await ut.setupTransports();const MV=x.hasFeature(U.TROUBLESHOOTING);if(De&&MV&&(uu=new _V(De.self)),(AE=i.participant)==null||AE){if(!De)throw new w("The participant module cannot be initialized without the `self` module");_r=new ks(De.self,CE,Se)}if((IE=i.chat)==null||IE){if(!De)throw new w("The chat module cannot be initialized without the `self` module");Ks=await Gr.init(Gc,AV,De.self,_r.participants,Se)}if(Ge&&((kE=i.plugin)==null||kE)){if(!De)throw new w("The plugin module cannot be initialized without the `self` module");if(!_r)throw new w("The plugin module cannot be initialized without the `participant` module");const Js=await or;du=await Qo.init(Js,kV,Gc,Ks==null?void 0:Ks.chat,De.self,_r.participants,Se)}if(Ge&&((OE=i.poll)==null||OE)){if(!De)throw new w("The poll cannot be initialized without the `self` module");lu=await AT.init(De.self,IV,Se)}if((DE=i.meta)==null||DE){if(!De)throw new w("The meta module cannot be initialized without the `self` module");se=new bT(De.self,Ie,V)}if((ME=i.remoteControl)==null||ME){if(!De)throw new w("The remote controller cannot be initialized without the `self` module");F=new qp(De.self,_r.participants)}if(Ge&&((NE=i.recording)==null||NE)){if(!De)throw new w("The recording controller cannot be initialized without the `self` module");qe=new JT(De.self)}if(Ge&&((LE=i.spotlight)==null||LE)){if(!De)throw new w("The spotlight controller cannot be initialized without the `self` module");cr=new YT(De.self)}if(((xE=i.internals)==null||xE)&&(Ws=await Zp.init()),C.viewType===xt.Livestream&&((UE=i.livestream)==null||UE)){if(!De)throw new w("The livestream controller cannot be initialized without the `self` module");x.hasFeature(U.LIVESTREAM)&&(uo=new QT(De.self,OV))}if(Ge&&((BE=i.stage)==null||BE)){if(!De)throw new w("The stage client cannot be initialized without the `self` module");Vi=new ZT(DV,AB(y),De.self)}if(Z_(C.viewType,Se)||((FE=r.overrides)==null?void 0:FE.chat_socket_server)==="socket-service")try{await Ie.connect()}catch(Js){g.error("[Socket Service] Failed to connect to socket server:",{error:Js})}return new Ul(t,se,De,du,_r,Ks,lu,F,qe,cr,Ws,uo,Vi,uu)}static async createSocketServiceAndRoomNodeClient(r){const e=Ul.createSocketService(r);return r.shouldInitializeRoomNode?r.capabilities.includes("HIVE")?(await FU({...r,roomName:r.roomName,peerId:r.peerId,socket:e}),e):(await lT({...r,roomName:r.roomName,peerId:r.peerId}),e):e}static createSocketService(r){const{peerId:e,roomName:t,authToken:s,capabilities:i}=r;return new Ma({peerId:e,roomName:t,authToken:s,capabilities:i})}async joinRoom(){return this.selfController.joinRoom()}async leaveRoom(r="left"){return eE.cleanup(),this.selfController.leaveRoom(r)}};let La=Ul;nc([_.trace("Controller.joinRoom")],La.prototype,"joinRoom",1),nc([_.trace("Controller.leaveRoom")],La.prototype,"leaveRoom",1),nc([_.trace("Controller.init")],La,"init",1),nc([_.trace("Controller.createSocketServiceAndRoomNodeClient")],La,"createSocketServiceAndRoomNodeClient",1),nc([_.trace("Controller.createSocketService")],La,"createSocketService",1);class yV extends Ke{constructor(t){super();S(this,Hc,void 0);f(this,"meetings",[]);f(this,"parentMeeting",null);R(this,Hc,t.self)}get supportsConnectedMeetings(){return d(this,Hc).id!==""&&re.isV2AuthToken&&x.hasFeature(U.CONNECTED_MEETINGS)}get isActive(){return this.meetings.length!==0}get currentMeetingId(){return He.currentMeetingId}validateConnectedMeetingsAction(){if(!this.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
						Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`)}async getConnectedMeetings(){return this.validateConnectedMeetingsAction(),await He.getConnectedRoomsDump()}async createMeetings(t){return this.validateConnectedMeetingsAction(),(await He.createConnectedRooms(t)).map(i=>({id:i.id,title:i.title}))}async updateMeetings(t){this.validateConnectedMeetingsAction(),await He.updateConnectedRooms(t.map(s=>({meetingId:s.id,title:s.title})))}async deleteMeetings(t){this.validateConnectedMeetingsAction();const s=this.meetings.map(n=>t.includes(n.id)&&n.participants.length!==0?this.moveParticipants(n.id,this.parentMeeting.id,n.participants.map(a=>a.id)):Promise.resolve());return await Promise.all(s),await He.disableConnectedRooms(t)}async moveParticipants(t,s,i){this.validateConnectedMeetingsAction();const n=new Map;[...this.parentMeeting.participants,...this.meetings.flatMap(o=>o.participants)].forEach(o=>n.set(o.id,o));const a=await He.movePeersBetweenRooms({sourceMeetingId:t,destinationMeetingId:s,participants:i.map(o=>({id:o}))});return a.success&&(s===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.concat(i.map(o=>n.get(o)))),t===this.parentMeeting.id&&(this.parentMeeting.participants=this.parentMeeting.participants.filter(o=>!i.includes(o.id))),this.meetings=this.meetings.map(o=>{if(s===o.id){const c=o.participants.concat(i.map(l=>n.get(l)));return{...o,participants:c}}if(t===o.id){const c=o.participants.filter(l=>!i.includes(l.id));return{...o,participants:c}}return o})),a}}Hc=new WeakMap;var SV=Object.defineProperty,wV=Object.getOwnPropertyDescriptor,af=(r,e,t,s)=>{for(var i=s>1?void 0:s?wV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&SV(e,t,i),i};const mi=(df=class{constructor(r,e){f(this,"connectedMeetings");S(this,Jn,void 0);S(this,lo,void 0);R(this,Jn,e),this.connectedMeetings=new yV(r),this.setCurrentMeeting(r)}static init(r,e){return mi.instance||(mi.instance=new mi(r,e)),mi.instance.connectedMeetings.supportsConnectedMeetings&&(mi.instance.setupEvents(),r.self.once("roomJoined",()=>mi.instance.getConnectedMeetings())),mi.instance}setCurrentMeeting(r){R(this,lo,r),He.currentMeetingId=r.meta.roomName}getConnectedMeetings(){this.connectedMeetings.getConnectedMeetings()}setupEvents(){He.socketService&&(He.socketService.on(Y.getConnectedRoomsDump,this.handleConnectedRoomsDump.bind(this)),He.socketService.on(Y.transferPeer,this.handleTransferPeer.bind(this)),He.socketService.on(Y.movedPeer,this.handleMovedPeer.bind(this)),He.socketService.on(Y.connectedRoomsUpdated,this.handleConnectedRoomsUpdated.bind(this)),He.socketService.on(Y.connectedRoomsDeleted,this.handleConnectedRoomsDeleted.bind(this)))}handleTransferPeer(r){const e=He.handleTransferPeerRaw(r);return this.switchMeeting(e)}async switchMeeting({authToken:r,meetingId:e}){if(!this.connectedMeetings.supportsConnectedMeetings)throw new Error(`You are not allowed to perform this action.
								Please connect with Dyte team to move you to V2 APIs & to enable connected meetings.`);this.connectedMeetings.emit("changingMeeting",e);const t=d(this,lo).self.videoEnabled;await d(this,lo).leaveRoom("connected-meeting"),He.socketService=void 0;const s=await rE.init({authToken:r,apiBase:d(this,Jn).apiBase,defaults:{...d(this,Jn).defaults,video:t,audio:!1},modules:d(this,Jn).modules});return this.connectedMeetings.emit("meetingChanged",s),this.setCurrentMeeting(s),s}handleConnectedRoomsDump(r){const e=He.handleConnectedRoomsDumpRaw(r);this.connectedMeetings.meetings=e.meetings.map(t=>({id:t.id,title:t.title,participants:t.participants||[]})),this.connectedMeetings.parentMeeting={id:e.parentMeeting.id,title:e.parentMeeting.title,participants:e.parentMeeting.participants},this.emitStateUpdate()}handleMovedPeer(r){return He.handleMovedPeerRaw(r)}handleConnectedRoomsUpdated(r){const e=He.handleConnectedRoomsUpdatedRaw(r),t=new Map;this.connectedMeetings.meetings.forEach(s=>{t.set(s.id,s)}),e.forEach(s=>{t.has(s.id)?t.get(s.id).title=s.title:t.set(s.id,{...s,participants:[]})}),this.connectedMeetings.meetings=Array.from(t.values()),this.emitStateUpdate()}handleConnectedRoomsDeleted(r){const t=He.handleConnectedRoomsDeletedRaw(r).map(s=>s.id);this.connectedMeetings.meetings=this.connectedMeetings.meetings.filter(s=>!t.includes(s.id))}emitStateUpdate(){this.connectedMeetings.emit("stateUpdate",{meetings:this.connectedMeetings.meetings,parentMeeting:this.connectedMeetings.parentMeeting})}},Jn=new WeakMap,lo=new WeakMap,f(df,"instance"),df);let Bl=mi;af([_.trace("ConnectedMeetingsController.getConnectedMeetings")],Bl.prototype,"getConnectedMeetings",1),af([_.trace("ConnectedMeetingsController.setupEvents")],Bl.prototype,"setupEvents",1),af([_.trace("ConnectedMeetingsController.switchMeeting")],Bl.prototype,"switchMeeting",1);const ac={},tE={executeWithLock({methodName:r,lockName:e,timeout:t}){return(s,i,n)=>{const a=n.value;return n.value=function(...c){if(ac[e]){const h=new Error(`Unsupported concurrent calls on Dyte method: ${r}.`);throw h.name="UnsupportedConcurrentMethodExecution",g.error("DyteLocker::UnsupportedConcurrentMethodExecution",{error:{stack:h.stack},dyteLocker:{methodName:r,lockName:e}}),h}ac[e]=!0;const l=setTimeout(()=>delete ac[e],t),u=a.apply(this,c);return Promise.resolve(u).then(()=>{delete ac[e],clearTimeout(l)}).catch(()=>{delete ac[e],clearTimeout(l)}),u},n}}};function RV(r){return(e,t,s)=>{const i=s.value,n=r?pd(i,r):pd(i);return s.value=(...a)=>{if(n.cache&&n.cache.has(r(...a))){console.warn(`[Dyte] method "${t}" is called twice. This may result in inconsistent behaviors`);try{g.warn("Memoize::double_invoke",{memoize:{doubleInvoked:{property:t}}})}catch(o){}}return n.apply(this,a)},s}}var bV=Object.defineProperty,CV=Object.getOwnPropertyDescriptor,Fl=(r,e,t,s)=>{for(var i=s>1?void 0:s?CV(e,t):e,n=r.length-1,a;n>=0;n--)(a=r[n])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&bV(e,t,i),i};const PV=r=>{var e,t,s,i,n;return`${(e=r.roomName)!=null?e:""}-${r.authToken}-${(t=r.apiBase)!=null?t:""}-${JSON.stringify((s=r.defaults)!=null?s:{})}-${JSON.stringify((i=r.modules)!=null?i:{})}-${JSON.stringify((n=r.overrides)!=null?n:{})}`};let wn=(bE=class{constructor(e){S(this,cu);S(this,Ct,void 0);S(this,jc,void 0);R(this,Ct,e)}static async init(e){var n,a,o,c,l,u,h,p;ZO((n=e.overrides)!=null?n:{}),he.init();const t=Yc();try{(o=(a=e.modules)==null?void 0:a.tracing)==null||o||(window.__zone_symbol__DISABLE_WRAPPING_UNCAUGHT_PROMISE_REJECTION=!0,window.Zone===void 0&&require("zone.js"))}catch(m){}_.init(t,(l=(c=e.modules)==null?void 0:c.tracing)!=null?l:!0),g.info("DyteClient::init::options",{dyteClientInitOptions:{...e,authToken:`${(u=e.authToken)==null?void 0:u.slice(0,10)}...${(h=e.authToken)==null?void 0:h.slice(-10)}`}}),!navigator.isReactNative&&typeof window!="undefined"&&(window.addEventListener("error",m=>{var v;!((v=m.filename)!=null&&v.includes("localhost"))&&m.lineno!==0&&g.error("window::error",{error:m.error},!0)}),window.addEventListener("unhandledrejection",m=>{var v,y,C,k,D,V,M,Pe;g.error("window::unhandledrejection",{error:m==null?void 0:m.reason,networkCall:{url:(y=(v=m==null?void 0:m.reason)==null?void 0:v.config)==null?void 0:y.url,baseURL:(k=(C=m==null?void 0:m.reason)==null?void 0:C.config)==null?void 0:k.baseURL,method:(V=(D=m==null?void 0:m.reason)==null?void 0:D.config)==null?void 0:V.method,status:(M=m==null?void 0:m.reason)==null?void 0:M.status,statusText:(Pe=m==null?void 0:m.reason)==null?void 0:Pe.statusText}},!0)})),QO(e.authToken,e.roomName),_.meetingMetadata.roomName=re.isV2AuthToken?re.meetingId:e.roomName;const s=await La.init(e,t),i=new wn(s);return be(p=i,cu,ny).call(p,e),i}async joinRoom(){return d(this,Ct).joinRoom()}async leaveRoom(e){return d(this,Ct).leaveRoom(e)}get participants(){var e;return(e=d(this,Ct).participantController)==null?void 0:e.participants}get self(){var e;return(e=d(this,Ct).selfController)==null?void 0:e.self}get meta(){var e;return(e=d(this,Ct).metaController)==null?void 0:e.meta}get plugins(){var e;return(e=d(this,Ct).pluginController)==null?void 0:e.plugins}get chat(){var e;return(e=d(this,Ct).chatController)==null?void 0:e.chat}get polls(){var e;return(e=d(this,Ct).pollController)==null?void 0:e.polls}get remote(){var e;return(e=d(this,Ct).remoteController)==null?void 0:e.remote}get connectedMeetings(){var e;return(e=d(this,jc))==null?void 0:e.connectedMeetings}get recording(){var e;return(e=d(this,Ct).recordingController)==null?void 0:e.recording}get spotlight(){var e;return(e=d(this,Ct).spotlightController)==null?void 0:e.spotlight}get livestream(){var e;return(e=d(this,Ct).livestreamController)==null?void 0:e.livestream}get stage(){var e;return(e=d(this,Ct).stageController)==null?void 0:e.stage}get troubleshoot(){var e;return(e=d(this,Ct).troubleshooterController)==null?void 0:e.troubleshooter}get __internals__(){var e;return(e=d(this,Ct).internalsController)==null?void 0:e.internals}},Ct=new WeakMap,jc=new WeakMap,cu=new WeakSet,ny=function(e){R(this,jc,Bl.init(this,e))},bE);Fl([Bt(r=>{throw new w(r.message,"0002")}),tE.executeWithLock({methodName:"meeting.joinRoom",lockName:"DyteClient.joinRoom",timeout:3e3})],wn.prototype,"joinRoom",1),Fl([Bt(r=>{throw new w(r.message,"0003")})],wn.prototype,"leaveRoom",1),Fl([Bt(r=>{throw new w(r.message,"0001")}),tE.executeWithLock({methodName:"DyteClient.init",lockName:"DyteClient.init",timeout:3e3}),RV(PV)],wn,"init",1),wn=Fl([Bt(r=>{throw new w(r.message,"0000")})],wn);const rE=wn;return rE}();